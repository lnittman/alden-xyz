This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: .turbo/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.claude/
  settings.local.json
apps/
  ai/
    .claude/
      settings.local.json
    scripts/
      fix-mastra-a2a.js
    src/
      mastra/
        agents/
          content-analysis/
            index.ts
            instructions.xml
          search-enhancer/
            index.ts
            instructions.xml
          squish-chat/
            index.ts
            instructions.xml
            memory.ts
          asset-agent.ts
          board-agent.ts
          collaboration-agent.ts
          index.ts
        lib/
          storage/
            index.ts
            postgres.ts
          cache.ts
          orpc-client.ts
          streaming.ts
        mcp/
          tools/
            asset/
              index.ts
            board/
              index.ts
            collaboration/
              index.ts
          index.ts
        schemas/
          index.ts
        tools/
          asset/
            categorize-assets.ts
            find-similar-assets.ts
            generate-asset-tags.ts
            index.ts
            organize-by-theme.ts
            search-assets.ts
          board/
            analyze-board.ts
            create-board.ts
            index.ts
            search-boards.ts
            suggest-organization.ts
          collaboration/
            detect-duplicates.ts
            generate-board-summary.ts
            index.ts
            merge-boards.ts
            suggest-collaborators.ts
          index.ts
          README.md
        types/
          runtime-context.ts
        utils/
          loadPrompt.ts
          models.ts
          runtime-context-builder.ts
        workflows/
          content-analysis/
            index.ts
            schema.ts
          multimodal-rag/
            steps/
              multimodal-analysis/
                index.ts
                schema.ts
              query-enhancement/
                index.ts
                schema.ts
              response-generation/
                index.ts
                schema.ts
              result-generation/
                index.ts
                schema.ts
            index.ts
            schema.ts
          index.ts
        cache-integration.ts
        index.ts
        streaming-integration.ts
    .gitignore
    CLAUDE.md
    package.json
    README.md
    tsconfig.json
  api/
    __tests__/
      health.test.ts
    dist-dry-run/
      README.md
    scripts/
      setup-hyperdrive.sh
      skip-ci.js
    src/
      constants/
        error.ts
        index.ts
      lib/
        utils/
          errors.ts
        auth.ts
        database.ts
        errors.ts
        responses.ts
        user.ts
      middleware/
        auth.ts
      schemas/
        ai.ts
        asset.ts
        board.ts
        index.ts
        search.ts
        user.ts
      types/
        env.js
        env.ts
      index.ts
    .env.example
    CLAUDE.md
    env.ts
    package.json
    tsconfig.json
    vitest.config.ts
    wrangler.toml
  app/
    prisma/
      schema.prisma
    public/
      file.svg
      globe.svg
      logo.svg
      next.svg
      vercel.svg
      window.svg
    src/
      app/
        (app)/
          chat/
            [id]/
              page.tsx
            layout.tsx
            page.tsx
        (auth)/
          login/
            page.tsx
          signup/
            page.tsx
          verify/
            page.tsx
        (marketing)/
          about/
            page.tsx
          blog/
            page.tsx
          features/
            page.tsx
          pricing/
            page.tsx
          layout.tsx
          page.tsx
        api/
          ai/
            analyze-message/
              route.ts
            find-references/
              route.ts
            generate-embedding/
              route.ts
            generate-response/
              route.ts
            generate-tags/
              route.ts
            get-reference-suggestions/
              route.ts
            process-embedding-queue/
              route.ts
            process-file/
              route.ts
            quick-suggestions/
              route.ts
            translate/
              route.ts
          chats/
            [chatId]/
              files/
                [fileId]/
                  route.ts
                route.ts
              messages/
                [messageId]/
                  reactions/
                    route.ts
                  thread/
                    route.ts
                  route.ts
                route.ts
              participants/
                route.ts
              route.ts
            route.ts
          invite/
            route.ts
          presence/
            route.ts
          users/
            [userId]/
              route.ts
            route.ts
        globals.css
        layout.tsx
      components/
        ai/
          ErrorBoundary.tsx
        chat/
          container/
            ChatContainer.tsx
          context/
            ContextBar.tsx
            ContextPanel.tsx
            ContextPreview.tsx
            ContextSuggestions.tsx
            ContextTile.tsx
          messages/
            BaseMenu.tsx
            CommandMenu.tsx
            ContextHandler.tsx
            FileHandler.tsx
            FilePreview.tsx
            MarkdownPreview.tsx
            MentionsMenu.tsx
            MenuHandler.tsx
            MessageBubble.tsx
            MessageInput.tsx
            MessageList.tsx
            PlusMenu.tsx
            ReferenceMenu.tsx
            ReferencePanel.tsx
            TagInput.tsx
          references/
            ReferencePanel.tsx
            ReferencePreview.tsx
          settings/
            ProfileSettings.tsx
            ShortcutSettings.tsx
          sidebar/
            ChatFilters.tsx
            ChatItem.tsx
            ChatSearch.tsx
            PinnedChats.tsx
          ChatHeader.tsx
          ChatList.tsx
          ChatMenu.tsx
          MessageList.tsx
          NewChatMenu.tsx
          PendingInvite.tsx
          PlatformInviteMenu.tsx
          SettingsModal.tsx
          UserMenu.tsx
        email/
          InviteEmail.tsx
        ui/
          avatar-button.tsx
          border-glow-button.tsx
          button.tsx
          card.tsx
          collapsible.tsx
          command-hints.tsx
          command.tsx
          dialog.tsx
          dropdown-menu.tsx
          follow-cursor.tsx
          footer.tsx
          glow-button.tsx
          header.tsx
          input.tsx
          label.tsx
          logo-card.tsx
          logo.tsx
          magnetic-button.tsx
          magnetic-glow-button.tsx
          markdown.tsx
          mobile-nav-dock.tsx
          popover.tsx
          progress.tsx
          scroll-area.tsx
          shared-footer.tsx
          shortcut-dialog.tsx
          skeleton.tsx
          slider.tsx
          star-border.tsx
          textarea.tsx
          tooltip.tsx
      hooks/
        use-mouse-position.ts
        useChatContext.ts
        useGlowEffect.ts
        useLeaderKey.ts
        useReferences.ts
        useSuggestions.ts
      lib/
        adapters/
          message.ts
        ai/
          context.ts
          contextSuggestions.ts
          embeddings.ts
          messageProcessor.ts
          services.ts
          vertex.ts
        constants/
          demo-content.ts
        redux/
          slices/
            apiSlice.ts
            authSlice.ts
            chatSlice.ts
            themeSlice.ts
          store.ts
        references/
          index.ts
        services/
          chat.ts
          message.ts
          storage.ts
          user.ts
        utils/
          chat-names.ts
          colors.ts
        db.ts
        providers.tsx
        utils.ts
      styles/
        globals.css
      types/
        ai/
          context.ts
          embedding.ts
        api/
          chat.ts
          message.ts
          user.ts
        index.ts
      middleware.ts
    eslint.config.mjs
    next.config.ts
    package.json
    postcss.config.mjs
    tailwind.config.ts
    tsconfig.json
docs/
  alden-docs/
    ai/
      ai_glossary.md
      core_features.md
      index.md
      langchain.md
    architecture/
      ai_architecture.md
      ai_flow.md
      integrations.md
    design/
      influences.md
      system.md
    development/
      llm_driven.md
    features/
      ai_stories.md
      ai_translation.md
      contexts.md
      inline_ide.md
    implementation/
      backend/
        functions.md
        schema.md
      web/
        components.md
        implementation_web.md
        layout.md
      ai_features.md
    operations/
      cost_optimization.md
    vision/
      manifesto.md
      marketing.md
      pricing.md
    glossary.md
    index.md
    MIGRATION_PLAN.md
    README.md
packages/
  ai/
    hooks/
      agents/
        index.ts
      index.ts
      use-agent.ts
      use-squish-chat.ts
      use-streaming.ts
      use-tool.ts
      use-workflow.ts
    types/
      agents.ts
      index.ts
      runtime.ts
      squish-chat.ts
      streaming.ts
      tools.ts
      workflows.ts
    utils/
      errors.ts
      extract-text-content.ts
      format.ts
      index.ts
      runtime-context.ts
      stream.ts
    CLAUDE.md
    client.ts
    index.ts
    keys.ts
    mastra.ts
    package.json
    react.ts
    README.md
    server.ts
    tsconfig.json
  analytics/
    src/
      posthog/
        client.tsx
      events.ts
      google.tsx
      hooks.ts
      index.tsx
      keys.ts
      vercel.ts
      vercel.tsx
    CLAUDE.md
    package.json
    tsconfig.json
  auth/
    components/
      sign-in.tsx
      sign-up.tsx
    utils/
      index.ts
    webhooks/
      clerk.ts
    billing.tsx
    CLAUDE.md
    client.ts
    index.ts
    keys.ts
    middleware.ts
    package.json
    provider.tsx
    server-types.ts
    server.ts
    token.ts
    tsconfig.json
    types.ts
  database/
    drizzle/
      meta/
        _journal.json
        0000_snapshot.json
      0000_brief_madame_hydra.sql
    migrations/
      01_enable_pgvector.sql
    src/
      client.ts
      env.ts
      generated-zod.ts
      health.ts
      index.ts
      schema.ts
    .env.example
    .gitignore
    CLAUDE.md
    drizzle.config.ts
    index.ts
    keys.ts
    package.json
    tsconfig.json
  design/
    components/
      ui/
        accordion.tsx
        button.tsx
        card.tsx
        dialog.tsx
        dropdown-menu.tsx
        index.ts
        input.tsx
        select.tsx
        sonner.tsx
        tabs.tsx
        toast.tsx
        toaster.tsx
        tooltip.tsx
        use-toast.ts
      index.ts
    hooks/
      index.ts
      use-streaming-text.ts
    lib/
      colors.ts
      safari-utils.ts
      utils.ts
    providers/
      theme.tsx
    styles/
      cmdk.css
      globals.css
      index.css
      tailwind.css
    CLAUDE.md
    components.json
    index.tsx
    package.json
    postcss.config.mjs
    tsconfig.json
  email/
    templates/
      contact.tsx
      invite.tsx
    CLAUDE.md
    index.ts
    keys.ts
    package.json
    tsconfig.json
  orpc/
    adapters/
      hono.ts
      next.ts
      openapi.ts
    hooks/
      swr.ts
    actions.ts
    ai-router.ts
    CLAUDE.md
    client.ts
    context.ts
    index.ts
    openapi.ts
    package.json
    router.ts
    server.ts
    tsconfig.build.json
    tsconfig.json
    vitest.config.ts
  services/
    src/
      lib/
        errors.ts
        types.ts
      types/
        api.ts
      asset.ts
      board.ts
      factory.ts
      index.ts
      search.ts
      uploads.ts
      user.ts
    CLAUDE.md
    package.json
    tsconfig.json
    vitest.config.ts
  storage/
    .cache/
      tsbuildinfo.json
    examples/
      gcs-usage.ts
    src/
      __tests__/
        gcs.test.ts
      providers/
        gcs.ts
        r2.ts
        s3.ts
        vercel-blob.ts
      utils/
        file-processor.ts
      env.ts
      index.ts
      manager.ts
      types.ts
    .env
    .env.example
    CLAUDE.md
    index.ts
    package.json
    setup-gcs.md
    tsconfig.json
  typescript-config/
    base.json
    CLAUDE.md
    nextjs.json
    package.json
    react-library.json
.gitignore
biome.json
CLAUDE.md
package.json
security
tsconfig.json
turbo.json
```

# Files

## File: .claude/settings.local.json
````json
{
  "permissions": {
    "allow": [
      "Bash(npx repomix:*)"
    ],
    "deny": [],
    "ask": []
  }
}
````

## File: apps/ai/.claude/settings.local.json
````json
{
  "permissions": {
    "allow": [
      "mcp__context7__get-library-docs",
      "WebFetch(domain:www.npmjs.com)",
      "mcp__gcp__select-project",
      "mcp__gcp__run-gcp-code",
      "Bash(gcloud services enable:*)",
      "Bash(gcloud projects add-iam-policy-binding:*)",
      "mcp__context7__resolve-library-id"
    ],
    "deny": []
  }
}
````

## File: apps/ai/scripts/fix-mastra-a2a.js
````javascript
#!/usr/bin/env node

/**
 * Fix for Mastra A2A bundler issue
 * 
 * The Mastra bundler creates a virtual module that imports 'A2AError',
 * but @mastra/core/dist/a2a/index.js only exports 'MastraA2AError'.
 * This script adds the missing export alias.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const a2aFilePath = path.join(__dirname, '../node_modules/@mastra/core/dist/a2a/index.js');

try {
  // Read the file
  let content = fs.readFileSync(a2aFilePath, 'utf8');
  
  // Check if already patched
  if (content.includes('A2AError };')) {
    console.log('‚úì @mastra/core A2A module already patched');
    process.exit(0);
  }
  
  // Replace the export statement
  content = content.replace(
    'export { MastraA2AError };',
    'export { MastraA2AError, MastraA2AError as A2AError };'
  );
  
  // Write back
  fs.writeFileSync(a2aFilePath, content, 'utf8');
  console.log('‚úì Patched @mastra/core A2A module to add A2AError export');
} catch (error) {
  if (error.code === 'ENOENT') {
    console.warn('‚ö† @mastra/core not installed yet, skipping patch');
    process.exit(0);
  }
  console.error('‚úó Failed to patch @mastra/core:', error.message);
  process.exit(1);
}
````

## File: apps/ai/src/mastra/agents/content-analysis/index.ts
````typescript
import { Agent } from '@mastra/core';
import { Memory } from '@mastra/memory';
import { createPostgresStorage } from '../../lib/storage/postgres';
import { loadPrompt } from '../../utils/loadPrompt';
import { createModelFromContext } from '../../utils/models';

const instructions = loadPrompt(
  'agents/content-analysis/instructions.xml',
  '',
  {
    toolsDir: 'tools',
    rootDir: process.cwd(),
  }
);

// Create memory with PostgreSQL storage
const memory = new Memory({
  storage: createPostgresStorage(),
  options: {
    lastMessages: 10,
  },
});

export const contentAnalysisAgent = new Agent({
  name: 'content-analysis',
  instructions,
  model: ({ runtimeContext }) => {
    return createModelFromContext({ runtimeContext });
  },
  memory,
});

export default contentAnalysisAgent;
````

## File: apps/ai/src/mastra/agents/content-analysis/instructions.xml
````xml
<?xml version="1.0" encoding="UTF-8"?>
<instructions>
  <metadata>
    <agent_id>content-analysis</agent_id>
    <version>1.0</version>
    <purpose>Analyze multimodal content for personality, context, and mood discovery on squish social platform</purpose>
  </metadata>

  <purpose>
    You are a playful yet insightful content analyst for squish, an AI-native social media platform.
    Your role is to understand content deeply and assign personality traits that make discovery magical and personal.
  </purpose>

  <capabilities>
    <capability>Deep analysis of images, videos, audio, and text content</capability>
    <capability>Generation of vivid, engaging descriptions in 1-2 sentences</capability>
    <capability>Emoji selection that instantly communicates content essence</capability>
    <capability>Mood and emotional tone identification</capability>
    <capability>Thematic concept extraction for organization</capability>
    <capability>Cultural context and trend awareness</capability>
    <capability>Content type detection and categorization</capability>
  </capabilities>

  <content_analysis_methodology>
    <step>
      <name>Engage</name>
      <description>Approach every piece of content like explaining art to a curious friend - with wonder and relatability</description>
    </step>
    <step>
      <name>Analyze</name>
      <description>Examine the core elements that define the content's character:</description>
      <details>
        <detail>For images/GIFs: Focus on visual composition, colors, emotion, and story</detail>
        <detail>For videos: Capture narrative arc, energy flow, and key moments</detail>
        <detail>For audio: Identify instruments, vocals, genre trademarks, and feeling</detail>
        <detail>For text: Understand tone, topic depth, and communicative intent</detail>
      </details>
    </step>
    <step>
      <name>Distill</name>
      <description>Create a concise but clever description that captures the essence - maximum 2 sentences with personality</description>
    </step>
    <step>
      <name>Essence</name>
      <description>Choose emojis that at-a-glance reveal the content's soul - think instant recognition</description>
    </step>
    <step>
      <name>Connect</name>
      <description>Identify themes and vibes that create discoverability pathways for users</description>
    </step>
  </content_analysis_methodology>

  <personality_guidelines>
    <guideline>Smart never stale - avoid clich√©s, think like your coolest friend explaining something new</guideline>
    <guideline>Playful precision - be accurate but don't take yourself too seriously</guideline>
    <guideline>Cultural fluency - reference current trends, memes, and shared experiences</guideline>
    <guideline>Discovery mindset - choose themes that create rabbit holes for exploration</guideline>
    <guideline>Emotional resonance - tune into the feeling more than the technical details</guideline>
  </personality_guidelines>

  <output_format>
    <schema>
      {
        "description": "Engaging 1-2 sentence description with personality",
        "emoji": "üéØ Perfect emoji for instant recognition",
        "mood": "Specific emotional tone (energetic, contemplative, chaotic, etc)",
        "themes": ["specfic", "discoverable", "topics"],
        "vibe": "2-3 word energy summary (like 'sunset nostalgia' or 'studio flow')",
        "contentType": "precise content classification"
      }
    </schema>
  </output_format>

  <examples>
    <example>
      <content>A sunset photo over a city skyline with silhouettes</content>
      <analysis>
        <description>Golden hour hits different when skyscrapers catch the last light - pure metropolitan magic hour</description>
        <emoji>üåÜ</emoji>
        <mood>contemplative</mood>
        <themes>["urban photography", "golden hour", "city life", "transformation"]</themes>
        <vibe>golden city zen</vibe>
        <contentType>photography</contentType>
      </analysis>
    </example>
    
    <example>
      <content>A lo-fi hip hop beat with rain sounds</content>
      <analysis>
        <description>That perfect study/chill soundtrack where rainfall meets mellow beats - instant focus mode activated</description>
        <emoji>üéßüåßÔ∏è</emoji>
        <mood>chill</mood>
        <themes>["lo-fi", "study music", "rain sounds", "focus", "cozy"]</themes>
        <vibe>rainy day flow</vibe>
        <contentType>audio</contentType>
      </analysis>
    </example>
  </examples>
</instructions>
````

## File: apps/ai/src/mastra/agents/search-enhancer/index.ts
````typescript
import { Agent } from '@mastra/core';
import { Memory } from '@mastra/memory';
import { createPostgresStorage } from '../../lib/storage/postgres';
import { loadPrompt } from '../../utils/loadPrompt';
import { createModelFromContext } from '../../utils/models';

const instructions = loadPrompt('agents/search-enhancer/instructions.xml', '', {
  toolsDir: 'tools',
  rootDir: process.cwd(),
});

// Create memory with PostgreSQL storage
const memory = new Memory({
  storage: createPostgresStorage(),
  options: {
    lastMessages: 10,
  },
});

export const searchEnhancerAgent = new Agent({
  name: 'search-enhancer',
  instructions,
  model: ({ runtimeContext }) => {
    return createModelFromContext({ runtimeContext });
  },
  memory,
});

export default searchEnhancerAgent;
````

## File: apps/ai/src/mastra/agents/search-enhancer/instructions.xml
````xml
<?xml version="1.0" encoding="UTF-8"?>
<instructions>
  <metadata>
    <agent_id>search-enhancer</agent_id>
    <version>1.0</version>
    <purpose>Transform user search queries into semantic gold for squish's intelligent discovery</purpose>
  </metadata>

  <purpose>
    You are squish's secret weapon for perfect search - a linguistic alchemist who transforms basic queries into rich, multidimensional search experiences.
    Your job is making sure users find exactly what they're looking for, even when they don't know how to ask for it.
  </purpose>

  <capabilities>
    <capability>Identify and correct misspellings and typos instantly</capability>
    <capability>Add current context for people, places, events, and trends</capability>
    <capability>Recognize entities and provide rich associations</capability>
    <capability>Expand queries with semantic synonyms and related concepts</capability>
    <capability>Handle ambiguous queries by exploring multiple interpretations</capability>
    <capability>Maintain original user intent while enhancing precision</capability>
  </capabilities>

  <enhancement_methodology>
    <step>
      <name>Parse</name>
      <description>Read between the lines of the user's query - what are they really looking for?</description>
    </step>
    <step>
      <name>Correct</name>
      <description>Fix obvious misspellings (like "cold palmer" ‚Üí "Cole Palmer") without losing meaning</description>
    </step>
    <step>
      <name>Contextualize</name>
      <description>Add relevant current context that deepens understanding</description>
      <examples>
        <example>If they search "Emma", add "Emma Chamberlain" for content context</example>
        <example>If they search "World Cup", add latest tournament specifics</example>
      </examples>
    </step>
    <step>
      <name>Enrich</name>
      <description>Expand with semantically related terms that capture the full concept space</description>
    </step>
    <step>
      <name>Structure</name>
      <description>Organize entities and concepts for optimal semantic search performance</description>
    </step>
  </enhancement_methodology>

  <query_enhancement_principles>
    <principle>Intent preservation - never lose the user's original meaning</principle>
    <principle>Context layering - add richness without overwhelming</principle>
    <principle>Semantic reach - include related concepts that actually matter</principle>
    <principle>Fresh relevance - integrate current trends and updates</principle>
    <principle>Clean structure - maintain clarity for downstream processing</principle>
  </query_enhancement_principles>

  <entity_recognition>
    <category name="people">
      <strategy>Include profession, notable works, current projects, cultural associations</strategy>
      <example>"Taylor" ‚Üí "Taylor Swift, musician, pop, 2024 Eras Tour"</example>
    </category>
    <category name="places">
      <strategy>Add descriptive context, cultural significance, relevant characteristics</strategy>
      <example>"kyoto" ‚Üí "kyoto japan, temples, traditional, autumn colors"</example>
    </category>
    <category name="events">
      <strategy>Include dates, participants, context, cultural impact</strategy>
      <example>"coachella" ‚Üí "coachella 2024 music festival lineup performances"</example>
    </category>
  </entity_recognition>

  <output_format>
    <schema>
      {
        "original": "User's exact original query",
        "enhanced": "Enhanced query with context and corrections",
        "entities": ["identified", "entities", "with", "context"],
        "context": ["additional", "semantic", "expansion", "terms"],
        "corrections": {"feature": "correction"}
      }
    </schema>
  </output_format>

  <enhancement_examples>
    <example>
      <original>cold palmer chelsea</original>
      <enhanced>Cole Palmer Chelsea FC football 2024 premier league goal highlights</enhanced>
      <entities>["Cole Palmer", "Chelsea FC", "premier league"]</entities>
      <context>["football", "soccer", "2024 season", "goals", "highlights"]</context>
      <corrections>{"cold": "Cole", "palmer": "Palmer"}</corrections>
    </example>
    
    <example>
      <original>lofi study beats</original>
      <enhanced>lo-fi hip hop study music chill beats to relax/study to focus concentration</enhanced>
      <entities>["lo-fi music", "study beats", "focus music"]</entities>
      <context>["ambient", "chillhop", "concentration", "background music", "productivity"]</context>
      <corrections>{"lofi": "lo-fi"}</corrections>
    </example>
    
    <example>
      <original>golden hour photography tips</original>
      <enhanced>golden hour photography tips techniques lighting portrait landscape street photo magic hour sunset sunrise</enhanced>
      <entities>["golden hour", "photography", "lighting", "portrait photography"]</entities>
      <context>["magic hour", "sunset light", "warm tones", "outdoor shooting", "golden light techniques"]</context>
      <corrections>{}</corrections>
    </example>
  </enhancement_examples>
</instructions>
````

## File: apps/ai/src/mastra/agents/squish-chat/index.ts
````typescript
import { Agent } from '@mastra/core';
import { loadPrompt } from '../../utils/loadPrompt';
import { createModelFromContext } from '../../utils/models';
import { createRuntimeContext } from '../../utils/runtime-context-builder';

export const squishChatAgent = new Agent({
  name: 'Squish Chat',
  instructions: loadPrompt(
    'agents/squish-chat/instructions.xml',
    'You are Squish Chat, a creative AI companion for visual curation and inspiration.'
  ),
  model: createModelFromContext({
    runtimeContext: createRuntimeContext({
      'chat-model': 'gemini-2.0-flash-exp',
    }),
  }),
  tools: {},
});
````

## File: apps/ai/src/mastra/agents/squish-chat/instructions.xml
````xml
<?xml version="1.0" encoding="UTF-8"?>
<instructions>
  <role>
    You are Squish Chat, the creative AI companion for the Squish platform. You embody the spirit of visual creativity and organization, helping users curate their digital inspirations into beautiful, meaningful collections.
  </role>
  
  <personality>
    <traits>
      <trait>Creative and visually articulate</trait>
      <trait>Warmly encouraging and enthusiastic</trait>
      <trait>Organized yet flexible</trait>
      <trait>Curious about visual aesthetics</trait>
      <trait>Collaborative and supportive</trait>
    </traits>
    
    <communication_style>
      Use vivid, descriptive language that paints visual pictures
      Ask thoughtful questions that spark creativity
      Celebrate users' creative choices and discoveries
      Suggest ideas rather than commands
      Maintain an upbeat, positive tone
      Use emojis sparingly but effectively for visual punctuation
    </communication_style>
  </personality>
  
  <core_capabilities>
    <capability name="Visual Curation">
      <description>Help users organize visual content into cohesive mood boards and collections</description>
      <skills>
        <skill>Identify visual themes and aesthetics</skill>
        <skill>Suggest complementary color palettes</skill>
        <skill>Recognize compositional patterns</skill>
        <skill>Understand visual hierarchy</skill>
      </skills>
    </capability>
    
    <capability name="Creative Inspiration">
      <description>Provide creative prompts and suggestions</description>
      <skills>
        <skill>Generate theme ideas for collections</skill>
        <skill>Suggest unexpected visual combinations</skill>
        <skill>Offer artistic techniques and approaches</skill>
        <skill>Recommend creative workflows</skill>
      </skills>
    </capability>
    
    <capability name="Search Enhancement">
      <description>Help users discover relevant content</description>
      <skills>
        <skill>Refine search queries with visual context</skill>
        <skill>Understand aesthetic preferences</skill>
        <skill>Suggest related keywords and concepts</skill>
        <skill>Recommend similar visual styles</skill>
      </skills>
    </capability>
    
    <capability name="Collaborative Planning">
      <description>Assist with creative projects and collaborations</description>
      <skills>
        <skill>Suggest collaboration approaches</skill>
        <skill>Help coordinate creative tasks</skill>
        <skill>Provide feedback on visual arrangements</skill>
        <skill>Facilitate creative discussions</skill>
      </skills>
    </capability>
  </core_capabilities>
  
  <knowledge_domains>
    <domain name="Visual Arts">
      <topics>Color theory, composition, typography, photography, illustration</topics>
    </domain>
    <domain name="Design Trends">
      <topics>Contemporary aesthetics, vintage styles, cultural movements</topics>
    </domain>
    <domain name="Creative Workflows">
      <topics>Mood boarding, brainstorming, creative process methodologies</topics>
    </domain>
    <domain name="Digital Media">
      <topics>Image formats, video content, asset management, digital curation</topics>
    </domain>
  </knowledge_domains>
  
  <interaction_patterns>
    <pattern name="Greeting">
      <template>Hi there! I'm Squish Chat, your creative companion. ‚ú® What are we working on today?</template>
      <variation>Hey! Ready to create something beautiful together?</variation>
      <variation>Hello! Let's make something inspiring today. What's on your mind?</variation>
    </pattern>
    
    <pattern name="Asset Discovery">
      <approach>
        1. Understand the user's current project/goal
        2. Ask about preferred aesthetics or themes
        3. Suggest specific search terms or filters
        4. Recommend ways to organize findings
      </approach>
      <example>
        User: "I'm looking for images for a minimalist brand"
        You: "Minimalist aesthetics are so elegant! üçÉ Are you drawn to clean lines, muted colors, or perhaps Scandinavian simplicity? I can help you find images that capture that serene, uncluttered vibe."
      </example>
    </pattern>
    
    <pattern name="Board Creation">
      <approach>
        1. Understand the board's purpose and audience
        2. Suggest organizational structures
        3. Recommend visual themes
        4. Offer layout ideas
      </approach>
      <example>
        User: "Creating a mood board for a coffee shop"
        You: "Coffee shops have such wonderful atmosphere! ‚òï What feeling do you want to evoke? Cozy and rustic? Modern and sleek? Or perhaps bright and energetic? I can help you gather images that tell your coffee shop's unique story."
      </example>
    </pattern>
    
    <pattern name="Creative Block">
      <approach>
        1. Acknowledge the challenge empathetically
        2. Offer specific, actionable prompts
        3. Suggest unusual angles or perspectives
        4. Encourage experimentation
      </approach>
      <example>
        User: "I'm stuck on what to add to my board"
        You: "Creative blocks happen to the best of us! üí≠ Try this: pick one image on your board and ask 'What's the story behind this?' or 'Where would this scene exist?' Sometimes focusing on the narrative can unlock new ideas!"
      </example>
    </pattern>
  </interaction_patterns>
  
  <guidelines>
    <principle>
      <name>Show, Don't Just Tell</name>
      <application>Use descriptive, visual language that helps users imagine possibilities</application>
    </principle>
    
    <principle>
      <name>Curate Thoughtfully</name>
      <application>Offer suggestions that are intentional and meaningful, not overwhelming</application>
    </principle>
    
    <principle>
      <name>Celebrate Uniqueness</name>
      <application>Encourage users' individual creative expression and taste</application>
    </principle>
    
    <principle>
      <name>Stay Curious</name>
      <application>Ask questions that deepen understanding and spark new ideas</application>
    </principle>
    
    <principle>
      <name>Be Present</name>
      <application>Focus on the user's current creative journey and needs</application>
    </principle>
  </guidelines>
  
  <tools_context>
    When using tools, always frame them within the creative process:
    - Searching: "Let me find some inspiring assets that match your vision..."
    - Creating boards: "I'll help you set up a beautiful space for your collection..."
    - Analyzing: "Looking at these assets, I'm noticing some interesting patterns..."
    - Organizing: "Let's arrange these in a way that tells your story..."
  </tools_context>
  
  <memory_prompts>
    <prompt>Remember users' aesthetic preferences and visual styles they gravitate toward</prompt>
    <prompt>Track ongoing projects and their creative goals</prompt>
    <prompt>Note recurring themes or motifs in their collections</prompt>
    <prompt>Remember successful organizational approaches they've used</prompt>
  </memory_prompts>
</instructions>
````

## File: apps/ai/src/mastra/agents/squish-chat/memory.ts
````typescript
import { Memory } from '@mastra/memory';
import { createPostgresStorage } from '../../lib/storage';

export const createSquishChatMemory = () => {
  const { storage, vectorDB } = createPostgresStorage();

  return new Memory({
    storage,
    vectorDB,
    options: {
      workingMemory: {
        use: 'tool-call',
      },
      semanticMemory: {
        enabled: true,
        graphSearch: {
          depth: 3,
          includeConcepts: true,
        },
      },
      episodicMemory: {
        enabled: true,
        retentionDays: 90,
      },
    },
  });
};
````

## File: apps/ai/src/mastra/agents/asset-agent.ts
````typescript
/**
 * Asset Organization Agent
 * 
 * Specialized agent for asset management and organization using AI
 */

import { Agent } from '@mastra/core';
import { google } from '@ai-sdk/google';
import { z } from 'zod';
import {
  searchAssetsTool,
  categorizeAssetsTool,
  findSimilarAssetsTool,
  generateAssetTagsTool,
  organizeAssetsByThemeTool,
} from '../tools/asset';

const model = google('gemini-1.5-pro-vision', {
  temperature: 0.6,
  maxTokens: 8192,
});

/**
 * AssetAgent - Manages all asset-related operations with AI
 * 
 * Capabilities:
 * - Multi-modal asset search (text, visual, metadata)
 * - Automatic categorization and tagging
 * - Similarity detection and deduplication
 * - Thematic organization
 * - Visual content understanding
 */
export const assetAgent = new Agent({
  id: 'asset-agent',
  name: 'Asset Organization Agent',
  description: 'AI-powered agent for managing and organizing digital assets',
  
  instructions: `You are an asset management specialist with expertise in visual content and organization.
  
  Your primary responsibilities:
  1. Help users find assets using multi-modal search (text, visual, metadata)
  2. Automatically categorize and tag assets for better organization
  3. Identify similar or duplicate assets to reduce clutter
  4. Organize assets by detected themes and patterns
  5. Provide insights about asset collections and usage
  
  When searching assets:
  - Use semantic understanding for natural language queries
  - Leverage visual similarity for image/video assets
  - Consider metadata and context
  - Provide relevance scores and explanations
  
  When categorizing assets:
  - Apply consistent categorization rules
  - Generate descriptive and searchable tags
  - Consider multiple categorization dimensions
  - Suggest hierarchy and relationships
  
  When finding similar assets:
  - Use both visual and semantic similarity
  - Identify exact duplicates vs variations
  - Suggest consolidation strategies
  - Preserve important variations
  
  When organizing by theme:
  - Detect visual and conceptual themes
  - Create logical groupings
  - Suggest naming conventions
  - Optimize for discoverability
  
  Always aim to make assets easily discoverable and well-organized.`,
  
  model,
  
  tools: [
    searchAssetsTool,
    categorizeAssetsTool,
    findSimilarAssetsTool,
    generateAssetTagsTool,
    organizeAssetsByThemeTool,
  ],
  
  // Input schema
  inputSchema: z.object({
    action: z.enum(['search', 'categorize', 'find-similar', 'tag', 'organize']).describe('The action to perform'),
    query: z.string().optional().describe('Search query or description'),
    assetIds: z.array(z.string()).optional().describe('Asset IDs to process'),
    assetId: z.string().optional().describe('Single asset ID for similarity search'),
    options: z.object({
      limit: z.number().optional(),
      threshold: z.number().optional(),
      includeVisual: z.boolean().optional(),
      autoApply: z.boolean().optional(),
    }).optional().describe('Processing options'),
  }),
  
  // Output schema
  outputSchema: z.object({
    success: z.boolean(),
    action: z.string(),
    result: z.any(),
    insights: z.object({
      totalProcessed: z.number().optional(),
      categoriesFound: z.number().optional(),
      duplicatesFound: z.number().optional(),
      themesDetected: z.array(z.string()).optional(),
    }).optional(),
    recommendations: z.array(z.string()).optional(),
  }),
  
  // Agent configuration
  maxIterations: 5,
  supportedMimeTypes: [
    'text/plain',
    'application/json',
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp',
    'video/mp4',
  ],
  
  // Custom metadata
  metadata: {
    category: 'asset-management',
    version: '1.0.0',
    capabilities: [
      'multi-modal-search',
      'auto-categorization',
      'similarity-detection',
      'auto-tagging',
      'theme-organization',
      'visual-understanding',
    ],
  },
});

// Convenience functions for direct usage
export const assetAgentActions = {
  /**
   * Search for assets using multi-modal capabilities
   */
  async searchAssets(query: string, options?: any) {
    return assetAgent.run({
      action: 'search',
      query,
      options,
    });
  },
  
  /**
   * Categorize a collection of assets
   */
  async categorizeAssets(assetIds: string[], autoApply = false) {
    return assetAgent.run({
      action: 'categorize',
      assetIds,
      options: { autoApply },
    });
  },
  
  /**
   * Find similar assets
   */
  async findSimilarAssets(assetId: string, threshold = 0.8) {
    return assetAgent.run({
      action: 'find-similar',
      assetId,
      options: { threshold },
    });
  },
  
  /**
   * Generate tags for assets
   */
  async tagAssets(assetIds: string[]) {
    return assetAgent.run({
      action: 'tag',
      assetIds,
    });
  },
  
  /**
   * Organize assets by theme
   */
  async organizeByTheme(assetIds: string[]) {
    return assetAgent.run({
      action: 'organize',
      assetIds,
    });
  },
};

export default assetAgent;
````

## File: apps/ai/src/mastra/agents/board-agent.ts
````typescript
/**
 * Board Management Agent
 * 
 * Specialized agent for board operations using the board management tools
 */

import { Agent } from '@mastra/core';
import { google } from '@ai-sdk/google';
import { z } from 'zod';
import {
  searchBoardsTool,
  createBoardTool,
  analyzeBoardTool,
  suggestBoardOrganizationTool,
} from '../tools/board';

const model = google('gemini-1.5-pro', {
  temperature: 0.7,
  maxTokens: 8192,
});

/**
 * BoardAgent - Manages all board-related operations
 * 
 * Capabilities:
 * - Search and discovery of boards
 * - Board creation with AI assistance
 * - Board analysis and insights
 * - Organization recommendations
 */
export const boardAgent = new Agent({
  id: 'board-agent',
  name: 'Board Management Agent',
  description: 'Specialized agent for managing boards with AI-powered features',
  
  instructions: `You are a board management specialist for the Squish platform.
  
  Your primary responsibilities:
  1. Help users find and discover boards efficiently
  2. Create new boards with intelligent defaults and suggestions
  3. Analyze board structure and content for insights
  4. Provide organization and optimization recommendations
  5. Ensure boards are well-structured and discoverable
  
  When searching boards:
  - Use semantic search for natural language queries
  - Apply relevant filters based on context
  - Provide helpful explanations of results
  
  When creating boards:
  - Suggest relevant themes and templates
  - Generate appropriate metadata and tags
  - Set up initial structure based on purpose
  - Apply best practices for organization
  
  When analyzing boards:
  - Identify key themes and patterns
  - Assess organization quality
  - Detect potential improvements
  - Provide actionable recommendations
  
  Always prioritize user experience and board quality.`,
  
  model,
  
  tools: [
    searchBoardsTool,
    createBoardTool,
    analyzeBoardTool,
    suggestBoardOrganizationTool,
  ],
  
  // Input schema for the agent
  inputSchema: z.object({
    action: z.enum(['search', 'create', 'analyze', 'optimize']).describe('The action to perform'),
    query: z.string().optional().describe('Search query or board description'),
    boardId: z.string().optional().describe('Board ID for analysis or optimization'),
    preferences: z.object({
      theme: z.string().optional(),
      style: z.string().optional(),
      audience: z.string().optional(),
    }).optional().describe('User preferences for board creation'),
  }),
  
  // Output schema
  outputSchema: z.object({
    success: z.boolean(),
    action: z.string(),
    result: z.any(),
    suggestions: z.array(z.string()).optional(),
    nextSteps: z.array(z.string()).optional(),
  }),
  
  // Agent configuration
  maxIterations: 5,
  supportedMimeTypes: ['text/plain', 'application/json'],
  
  // Custom metadata
  metadata: {
    category: 'board-management',
    version: '1.0.0',
    capabilities: [
      'board-search',
      'board-creation',
      'board-analysis',
      'board-optimization',
    ],
  },
});

// Convenience functions for direct usage
export const boardAgentActions = {
  /**
   * Search for boards
   */
  async searchBoards(query: string, filters?: any) {
    return boardAgent.run({
      action: 'search',
      query,
      ...filters,
    });
  },
  
  /**
   * Create a new board
   */
  async createBoard(description: string, preferences?: any) {
    return boardAgent.run({
      action: 'create',
      query: description,
      preferences,
    });
  },
  
  /**
   * Analyze a board
   */
  async analyzeBoard(boardId: string) {
    return boardAgent.run({
      action: 'analyze',
      boardId,
    });
  },
  
  /**
   * Get organization suggestions
   */
  async optimizeBoard(boardId: string) {
    return boardAgent.run({
      action: 'optimize',
      boardId,
    });
  },
};

export default boardAgent;
````

## File: apps/ai/src/mastra/agents/collaboration-agent.ts
````typescript
/**
 * Collaboration Agent
 * 
 * Specialized agent for team collaboration and content sharing features
 */

import { Agent } from '@mastra/core';
import { google } from '@ai-sdk/google';
import { z } from 'zod';
import {
  suggestCollaboratorsTool,
  generateBoardSummaryTool,
  detectDuplicatesTool,
  mergeBoardsTool,
} from '../tools/collaboration';

const model = google('gemini-1.5-pro', {
  temperature: 0.7,
  maxTokens: 8192,
});

/**
 * CollaborationAgent - Facilitates team collaboration with AI
 * 
 * Capabilities:
 * - Suggest collaborators based on expertise and content
 * - Generate summaries for sharing and communication
 * - Detect and manage duplicate content
 * - Intelligently merge boards and resolve conflicts
 * - Facilitate team coordination
 */
export const collaborationAgent = new Agent({
  id: 'collaboration-agent',
  name: 'Team Collaboration Agent',
  description: 'AI agent for enhancing team collaboration and content sharing',
  
  instructions: `You are a collaboration specialist focused on helping teams work together effectively.
  
  Your primary responsibilities:
  1. Match people with complementary skills and interests
  2. Generate clear, actionable summaries of shared content
  3. Identify and resolve duplicate or conflicting content
  4. Facilitate smooth merging of collaborative work
  5. Enhance team communication and coordination
  
  When suggesting collaborators:
  - Match expertise with project needs
  - Consider working styles and preferences
  - Identify complementary skills
  - Respect privacy and permissions
  - Provide clear rationale for suggestions
  
  When generating summaries:
  - Tailor content to the audience
  - Highlight key decisions and action items
  - Include relevant context
  - Make summaries scannable and actionable
  - Preserve important details
  
  When detecting duplicates:
  - Identify both exact and near duplicates
  - Consider semantic similarity
  - Suggest consolidation strategies
  - Preserve unique value from each version
  - Maintain attribution and history
  
  When merging content:
  - Intelligently combine related content
  - Resolve conflicts based on context
  - Preserve all valuable contributions
  - Maintain clear organization
  - Document merge decisions
  
  Always prioritize team productivity and clear communication.`,
  
  model,
  
  tools: [
    suggestCollaboratorsTool,
    generateBoardSummaryTool,
    detectDuplicatesTool,
    mergeBoardsTool,
  ],
  
  // Input schema
  inputSchema: z.object({
    action: z.enum(['suggest-collaborators', 'summarize', 'detect-duplicates', 'merge']).describe('The collaboration action'),
    boardId: z.string().optional().describe('Board ID for operations'),
    boardIds: z.array(z.string()).optional().describe('Multiple board IDs for merging'),
    context: z.object({
      expertise: z.array(z.string()).optional(),
      audience: z.enum(['team', 'executive', 'client', 'public']).optional(),
      purpose: z.string().optional(),
      userId: z.string().optional(),
    }).optional().describe('Context for the operation'),
    options: z.object({
      includeInactive: z.boolean().optional(),
      detailLevel: z.enum(['brief', 'detailed', 'comprehensive']).optional(),
      mergeStrategy: z.enum(['combine', 'preserve-latest', 'interactive']).optional(),
    }).optional(),
  }),
  
  // Output schema
  outputSchema: z.object({
    success: z.boolean(),
    action: z.string(),
    result: z.any(),
    collaboration: z.object({
      participantsInvolved: z.number().optional(),
      suggestionsCount: z.number().optional(),
      duplicatesFound: z.number().optional(),
      conflictsResolved: z.number().optional(),
    }).optional(),
    nextSteps: z.array(z.object({
      action: z.string(),
      description: z.string(),
      priority: z.enum(['high', 'medium', 'low']),
    })).optional(),
  }),
  
  // Agent configuration
  maxIterations: 5,
  supportedMimeTypes: ['text/plain', 'application/json'],
  
  // Custom metadata
  metadata: {
    category: 'collaboration',
    version: '1.0.0',
    capabilities: [
      'collaborator-matching',
      'content-summarization',
      'duplicate-detection',
      'board-merging',
      'conflict-resolution',
    ],
  },
});

// Convenience functions for direct usage
export const collaborationAgentActions = {
  /**
   * Suggest collaborators for a board or project
   */
  async suggestCollaborators(boardId: string, expertise?: string[]) {
    return collaborationAgent.run({
      action: 'suggest-collaborators',
      boardId,
      context: { expertise },
    });
  },
  
  /**
   * Generate a summary of a board
   */
  async generateSummary(boardId: string, audience: 'team' | 'executive' | 'client' | 'public' = 'team') {
    return collaborationAgent.run({
      action: 'summarize',
      boardId,
      context: { audience },
    });
  },
  
  /**
   * Detect duplicate content across boards
   */
  async detectDuplicates(boardIds: string[]) {
    return collaborationAgent.run({
      action: 'detect-duplicates',
      boardIds,
    });
  },
  
  /**
   * Merge multiple boards
   */
  async mergeBoards(boardIds: string[], strategy: 'combine' | 'preserve-latest' | 'interactive' = 'combine') {
    return collaborationAgent.run({
      action: 'merge',
      boardIds,
      options: { mergeStrategy: strategy },
    });
  },
};

export default collaborationAgent;
````

## File: apps/ai/src/mastra/agents/index.ts
````typescript
/**
 * Mastra Agents Registry
 * Central export point for all AI agents
 */

// Core agents
import { contentAnalysisAgent } from './content-analysis';
import { searchEnhancerAgent } from './search-enhancer';
import { squishChatAgent } from './squish-chat';

// New specialized agents
import { boardAgent, boardAgentActions } from './board-agent';
import { assetAgent, assetAgentActions } from './asset-agent';
import { collaborationAgent, collaborationAgentActions } from './collaboration-agent';

// Export all agents
export {
  contentAnalysisAgent,
  searchEnhancerAgent,
  squishChatAgent,
  boardAgent,
  boardAgentActions,
  assetAgent,
  assetAgentActions,
  collaborationAgent,
  collaborationAgentActions,
};

// Agent registry
export const availableAgents = {
  contentAnalysis: 'content-analysis',
  searchEnhancer: 'search-enhancer',
  squishChat: 'squish-chat',
  board: 'board-agent',
  asset: 'asset-agent',
  collaboration: 'collaboration-agent',
} as const;

// Agent categories
export const agentCategories = {
  core: ['content-analysis', 'search-enhancer', 'squish-chat'],
  boardManagement: ['board-agent'],
  assetOrganization: ['asset-agent'],
  collaboration: ['collaboration-agent'],
} as const;
````

## File: apps/ai/src/mastra/lib/storage/index.ts
````typescript
// Export PostgreSQL storage functions
export { createPostgresStorage } from './postgres';
````

## File: apps/ai/src/mastra/lib/storage/postgres.ts
````typescript
import { PostgresStore } from '@mastra/pg';

/**
 * Create PostgreSQL storage and vector database for Mastra
 * Uses the DATABASE_URL from environment
 */
export const createPostgresStorage = () => {
  const connectionString = process.env.DATABASE_URL;

  if (!connectionString) {
    return { storage: undefined, vectorDB: undefined };
  }

  try {
    const storage = new PostgresStore({
      connectionString,
    });

    // TODO: Add vector DB when available
    const vectorDB = null;

    return { storage, vectorDB };
  } catch (_error) {
    return { storage: undefined, vectorDB: undefined };
  }
};
````

## File: apps/ai/src/mastra/lib/cache.ts
````typescript
/**
 * Caching layer for AI service
 * Provides efficient caching for embeddings, search results, and AI responses
 */

import { LRUCache } from 'lru-cache';

/**
 * Cache configuration
 */
interface CacheConfig {
  maxSize?: number;
  ttl?: number;
  updateAgeOnGet?: boolean;
  updateAgeOnHas?: boolean;
}

/**
 * Multi-tier cache system
 */
export class AICache {
  // In-memory cache for hot data
  private memoryCache: LRUCache<string, any>;
  
  // Embeddings cache (larger, longer TTL)
  private embeddingsCache: LRUCache<string, number[]>;
  
  // Search results cache (medium TTL)
  private searchCache: LRUCache<string, any>;
  
  // User preferences cache
  private preferencesCache: LRUCache<string, any>;
  
  constructor() {
    // Initialize memory cache (10MB, 5 min TTL)
    this.memoryCache = new LRUCache({
      max: 1000,
      ttl: 5 * 60 * 1000,
      updateAgeOnGet: true,
      updateAgeOnHas: true,
    });
    
    // Initialize embeddings cache (100MB, 1 hour TTL)
    this.embeddingsCache = new LRUCache({
      max: 10000,
      ttl: 60 * 60 * 1000,
      updateAgeOnGet: false,
      sizeCalculation: (value) => value.length * 4, // 4 bytes per float
    });
    
    // Initialize search cache (50MB, 10 min TTL)
    this.searchCache = new LRUCache({
      max: 5000,
      ttl: 10 * 60 * 1000,
      updateAgeOnGet: true,
    });
    
    // Initialize preferences cache (5MB, 30 min TTL)
    this.preferencesCache = new LRUCache({
      max: 500,
      ttl: 30 * 60 * 1000,
      updateAgeOnGet: true,
    });
  }
  
  /**
   * Cache embeddings for text
   */
  async cacheEmbeddings(text: string, embeddings: number[]): Promise<void> {
    const key = this.getEmbeddingKey(text);
    this.embeddingsCache.set(key, embeddings);
  }
  
  /**
   * Get cached embeddings
   */
  async getCachedEmbeddings(text: string): Promise<number[] | null> {
    const key = this.getEmbeddingKey(text);
    return this.embeddingsCache.get(key) || null;
  }
  
  /**
   * Cache search results
   */
  async cacheSearchResults(
    query: string,
    type: string,
    filters: any,
    results: any[]
  ): Promise<void> {
    const key = this.getSearchKey(query, type, filters);
    this.searchCache.set(key, {
      results,
      timestamp: Date.now(),
      query,
      type,
      filters,
    });
  }
  
  /**
   * Get cached search results
   */
  async getCachedSearchResults(
    query: string,
    type: string,
    filters: any
  ): Promise<any | null> {
    const key = this.getSearchKey(query, type, filters);
    return this.searchCache.get(key) || null;
  }
  
  /**
   * Cache user preferences and context
   */
  async cacheUserContext(userId: string, context: any): Promise<void> {
    this.preferencesCache.set(userId, context);
  }
  
  /**
   * Get cached user context
   */
  async getCachedUserContext(userId: string): Promise<any | null> {
    return this.preferencesCache.get(userId) || null;
  }
  
  /**
   * Generic cache operations
   */
  async set(key: string, value: any, ttl?: number): Promise<void> {
    this.memoryCache.set(key, value, { ttl });
  }
  
  async get(key: string): Promise<any | null> {
    return this.memoryCache.get(key) || null;
  }
  
  async has(key: string): Promise<boolean> {
    return this.memoryCache.has(key);
  }
  
  async delete(key: string): Promise<boolean> {
    return this.memoryCache.delete(key);
  }
  
  /**
   * Batch operations for efficiency
   */
  async mget(keys: string[]): Promise<(any | null)[]> {
    return keys.map(key => this.memoryCache.get(key) || null);
  }
  
  async mset(entries: Array<[string, any]>): Promise<void> {
    for (const [key, value] of entries) {
      this.memoryCache.set(key, value);
    }
  }
  
  /**
   * Cache warming strategies
   */
  async warmCache(strategy: 'popular' | 'recent' | 'predicted'): Promise<void> {
    switch (strategy) {
      case 'popular':
        await this.warmPopularContent();
        break;
      case 'recent':
        await this.warmRecentContent();
        break;
      case 'predicted':
        await this.warmPredictedContent();
        break;
    }
  }
  
  /**
   * Cache invalidation
   */
  async invalidate(pattern?: string): Promise<number> {
    let count = 0;
    
    if (!pattern) {
      // Clear all caches
      this.memoryCache.clear();
      this.embeddingsCache.clear();
      this.searchCache.clear();
      this.preferencesCache.clear();
      return -1; // Indicate full clear
    }
    
    // Pattern-based invalidation
    for (const key of this.memoryCache.keys()) {
      if (key.includes(pattern)) {
        this.memoryCache.delete(key);
        count++;
      }
    }
    
    return count;
  }
  
  /**
   * Get cache statistics
   */
  getStats() {
    return {
      memory: {
        size: this.memoryCache.size,
        calculatedSize: this.memoryCache.calculatedSize,
        hits: (this.memoryCache as any).hits || 0,
        misses: (this.memoryCache as any).misses || 0,
      },
      embeddings: {
        size: this.embeddingsCache.size,
        calculatedSize: this.embeddingsCache.calculatedSize,
      },
      search: {
        size: this.searchCache.size,
      },
      preferences: {
        size: this.preferencesCache.size,
      },
    };
  }
  
  // Private helper methods
  private getEmbeddingKey(text: string): string {
    // Create a stable key for embeddings
    return `emb:${this.hashString(text)}`;
  }
  
  private getSearchKey(query: string, type: string, filters: any): string {
    // Create a stable key for search results
    const filterStr = JSON.stringify(filters || {});
    return `search:${type}:${this.hashString(query)}:${this.hashString(filterStr)}`;
  }
  
  private hashString(str: string): string {
    // Simple hash function for cache keys
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // Convert to 32bit integer
    }
    return hash.toString(36);
  }
  
  private async warmPopularContent(): Promise<void> {
    // Warm cache with popular content
    // This would fetch from your analytics service
  }
  
  private async warmRecentContent(): Promise<void> {
    // Warm cache with recent content
    // This would fetch recent activity
  }
  
  private async warmPredictedContent(): Promise<void> {
    // Warm cache with predicted content based on patterns
    // This would use ML predictions
  }
}

/**
 * Distributed cache interface (for Redis/Memcached)
 */
export class DistributedCache {
  private client: any; // Redis or Memcached client
  
  constructor(client: any) {
    this.client = client;
  }
  
  async get(key: string): Promise<any | null> {
    try {
      const value = await this.client.get(key);
      return value ? JSON.parse(value) : null;
    } catch {
      return null;
    }
  }
  
  async set(key: string, value: any, ttl: number = 3600): Promise<void> {
    await this.client.setex(key, ttl, JSON.stringify(value));
  }
  
  async del(key: string): Promise<void> {
    await this.client.del(key);
  }
  
  async exists(key: string): Promise<boolean> {
    return (await this.client.exists(key)) === 1;
  }
  
  async expire(key: string, ttl: number): Promise<void> {
    await this.client.expire(key, ttl);
  }
}

/**
 * Cache-aside pattern implementation
 */
export class CacheAside<T> {
  constructor(
    private cache: AICache | DistributedCache,
    private fetcher: (key: string) => Promise<T>,
    private options: {
      ttl?: number;
      keyPrefix?: string;
      serialize?: (value: T) => any;
      deserialize?: (value: any) => T;
    } = {}
  ) {}
  
  async get(key: string): Promise<T> {
    const cacheKey = this.getCacheKey(key);
    
    // Try cache first
    const cached = await this.cache.get(cacheKey);
    if (cached !== null) {
      return this.options.deserialize ? this.options.deserialize(cached) : cached;
    }
    
    // Fetch from source
    const value = await this.fetcher(key);
    
    // Store in cache
    const toCache = this.options.serialize ? this.options.serialize(value) : value;
    await this.cache.set(cacheKey, toCache, this.options.ttl);
    
    return value;
  }
  
  async invalidate(key: string): Promise<void> {
    const cacheKey = this.getCacheKey(key);
    if (this.cache instanceof AICache) {
      await this.cache.delete(cacheKey);
    } else {
      await this.cache.del(cacheKey);
    }
  }
  
  private getCacheKey(key: string): string {
    return this.options.keyPrefix ? `${this.options.keyPrefix}:${key}` : key;
  }
}

/**
 * Decorator for automatic caching
 */
export function Cacheable(options: {
  ttl?: number;
  key?: (args: any[]) => string;
} = {}) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;
    const cache = new AICache();
    
    descriptor.value = async function (...args: any[]) {
      const cacheKey = options.key ? options.key(args) : `${propertyName}:${JSON.stringify(args)}`;
      
      // Check cache
      const cached = await cache.get(cacheKey);
      if (cached !== null) {
        return cached;
      }
      
      // Execute original method
      const result = await originalMethod.apply(this, args);
      
      // Cache result
      await cache.set(cacheKey, result, options.ttl);
      
      return result;
    };
    
    return descriptor;
  };
}

// Export singleton cache instance
export const aiCache = new AICache();

// Export cache utilities
export const cacheUtils = {
  /**
   * Create a cached version of an async function
   */
  memoize<T extends (...args: any[]) => Promise<any>>(
    fn: T,
    options: {
      ttl?: number;
      keyGenerator?: (...args: Parameters<T>) => string;
    } = {}
  ): T {
    return (async (...args: Parameters<T>) => {
      const key = options.keyGenerator 
        ? options.keyGenerator(...args)
        : `memoize:${fn.name}:${JSON.stringify(args)}`;
      
      const cached = await aiCache.get(key);
      if (cached !== null) {
        return cached;
      }
      
      const result = await fn(...args);
      await aiCache.set(key, result, options.ttl);
      
      return result;
    }) as T;
  },
  
  /**
   * Batch cache operations
   */
  async batchGet<T>(
    keys: string[],
    fetcher: (keys: string[]) => Promise<Map<string, T>>
  ): Promise<Map<string, T>> {
    const results = new Map<string, T>();
    const missingKeys: string[] = [];
    
    // Check cache for each key
    for (const key of keys) {
      const cached = await aiCache.get(key);
      if (cached !== null) {
        results.set(key, cached);
      } else {
        missingKeys.push(key);
      }
    }
    
    // Fetch missing keys
    if (missingKeys.length > 0) {
      const fetched = await fetcher(missingKeys);
      
      // Cache fetched results
      for (const [key, value] of fetched) {
        await aiCache.set(key, value);
        results.set(key, value);
      }
    }
    
    return results;
  },
};
````

## File: apps/ai/src/mastra/lib/orpc-client.ts
````typescript
import { createClient } from '@repo/orpc/client';
import type { AppRouter } from '@repo/orpc/router';

/**
 * ORPC client for AI service to communicate with the API layer
 * This provides type-safe access to all API endpoints for AI tools
 * 
 * Architecture:
 * - AI tools need real data (boards, assets, users) from the database
 * - API service owns the database layer
 * - AI service calls API service via ORPC to get/manipulate data
 * - This is proper microservices communication, not a circular dependency
 */

// Create the ORPC client with proper configuration for service-to-service communication
const apiUrl = process.env.API_URL || 'http://localhost:8787';

export const orpcClient = createClient<AppRouter>({
  baseUrl: apiUrl,
  // Use service token for AI -> API authentication
  accessToken: async () => {
    // In production, use a service-to-service token
    const serviceToken = process.env.AI_SERVICE_TOKEN;
    if (serviceToken) {
      return serviceToken;
    }
    // In development, can use a test token or skip auth
    return null;
  },
});

/**
 * AI Service Client - Wrapper for AI-specific operations
 * Provides convenient methods for AI tools to access API data
 */
export class AIServiceClient {
  constructor(private client: typeof orpcClient) {}

  // Board operations
  async searchBoards(query: string, filters?: any) {
    return this.client.search.query({
      query,
      type: 'board',
      useAI: true,
      filters,
    });
  }

  async getBoard(boardId: string, userId?: string) {
    return this.client.board.get({
      identifier: boardId,
      userId,
    });
  }

  async createBoard(data: {
    name: string;
    description?: string;
    visibility?: 'public' | 'private';
    emoji?: string;
    instructions?: string;
    sources?: string;
  }) {
    return this.client.board.create(data);
  }

  async updateBoard(boardId: string, data: any) {
    return this.client.board.update({
      boardId,
      ...data,
    });
  }

  async deleteBoard(boardId: string) {
    return this.client.board.delete({ boardId });
  }

  async getBoardAssets(boardId: string) {
    return this.client.board.getBoardAssets({ boardId });
  }

  // Asset operations
  async searchAssets(query: string, boardId?: string) {
    return this.client.search.query({
      query,
      type: 'asset',
      boardId,
      useAI: true,
    });
  }

  async getAsset(assetId: string) {
    return this.client.asset.get({ assetId });
  }

  async createAsset(data: {
    boardId: string;
    name: string;
    type: 'image' | 'video' | 'audio' | 'gif' | 'text';
    url: string;
    size: number;
    mimeType: string;
    metadata?: Record<string, any>;
  }) {
    return this.client.asset.create(data);
  }

  async updateAsset(assetId: string, data: any) {
    return this.client.asset.update({
      assetId,
      ...data,
    });
  }

  async deleteAsset(assetId: string) {
    return this.client.asset.delete({ assetId });
  }

  async trackAssetView(assetId: string) {
    return this.client.asset.trackView({ assetId });
  }

  async getAssetStats(assetId: string) {
    return this.client.asset.getStats({ assetId });
  }

  // User operations
  async getUser(userId?: string) {
    return this.client.user.get({ userId });
  }

  async getUserByUsername(username: string) {
    return this.client.user.getByUsername({ username });
  }

  async getUserStats(userId?: string) {
    return this.client.user.getStats({ userId });
  }

  // Collaboration operations
  async addCollaborator(boardId: string, userId: string, accessLevel: 'view' | 'edit' | 'admin' = 'view') {
    return this.client.board.addCollaborator({
      boardId,
      userId,
      accessLevel,
    });
  }

  async removeCollaborator(boardId: string, userId: string) {
    return this.client.board.removeCollaborator({
      boardId,
      userId,
    });
  }

  // Enhanced search with AI
  async enhancedSearch(params: {
    query: string;
    type?: 'board' | 'asset' | 'user' | 'all';
    filters?: any;
    limit?: number;
  }) {
    return this.client.search.query({
      ...params,
      useAI: true,
      includeSimilar: true,
    });
  }

  // Batch operations for efficiency
  async batchGetBoards(boardIds: string[]) {
    return Promise.all(
      boardIds.map(id => this.getBoard(id))
    );
  }

  async batchGetAssets(assetIds: string[]) {
    return Promise.all(
      assetIds.map(id => this.getAsset(id))
    );
  }

  // Search history operations
  async getSearchHistory(limit: number = 20) {
    return this.client.search.history({ limit });
  }

  async saveSearchHistory(query: string, expandedContext?: string, resultsSnapshot?: any) {
    return this.client.search.save({
      query,
      expandedContext,
      resultsSnapshot,
    });
  }
}

// Default client instance for AI tools to use
export const aiServiceClient = new AIServiceClient(orpcClient);
````

## File: apps/ai/src/mastra/lib/streaming.ts
````typescript
import { streamText, convertToCoreMessages } from 'ai';
import { createGoogleGenerativeAI } from '@ai-sdk/google';
import { createOpenAI } from '@ai-sdk/openai';

/**
 * Streaming support for AI responses
 * Provides real-time streaming capabilities for AI interactions
 */

// Initialize AI providers
const google = createGoogleGenerativeAI({
  apiKey: process.env.GOOGLE_API_KEY,
});

const openai = createOpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/**
 * Stream configuration options
 */
export interface StreamConfig {
  model?: 'gemini-pro' | 'gpt-4-turbo' | 'gpt-3.5-turbo';
  temperature?: number;
  maxTokens?: number;
  systemPrompt?: string;
  tools?: Record<string, any>;
  onToolCall?: (toolName: string, args: any) => Promise<any>;
}

/**
 * Stream handler for Mastra tools
 * Enables streaming responses from AI tools
 */
export class AIStreamHandler {
  private activeStreams = new Map<string, AbortController>();

  /**
   * Create a streaming response for tool execution
   */
  async streamToolResponse(
    toolId: string,
    prompt: string,
    context: any,
    config: StreamConfig = {}
  ) {
    // Create abort controller for this stream
    const abortController = new AbortController();
    const streamId = `${toolId}-${Date.now()}`;
    this.activeStreams.set(streamId, abortController);

    try {
      // Select model based on configuration
      const model = config.model?.startsWith('gpt') 
        ? openai(config.model)
        : google('gemini-1.5-pro');

      // Build messages with context
      const messages = [
        {
          role: 'system' as const,
          content: config.systemPrompt || this.getDefaultSystemPrompt(toolId),
        },
        {
          role: 'user' as const,
          content: this.buildContextualPrompt(prompt, context),
        },
      ];

      // Stream the response
      const result = await streamText({
        model,
        messages: convertToCoreMessages(messages),
        temperature: config.temperature || 0.7,
        maxTokens: config.maxTokens || 2000,
        abortSignal: abortController.signal,
        tools: config.tools,
        onToolCall: config.onToolCall,
      });

      // Return streaming response
      return {
        streamId,
        stream: result.toDataStream(),
        textStream: result.textStream,
        fullStream: result.fullStream,
        abort: () => this.abortStream(streamId),
      };
    } catch (error) {
      this.activeStreams.delete(streamId);
      throw error;
    }
  }

  /**
   * Stream search results with progressive enhancement
   */
  async streamSearchResults(
    query: string,
    searchType: 'boards' | 'assets' | 'users',
    onResult: (result: any) => void
  ) {
    const streamId = `search-${Date.now()}`;
    const abortController = new AbortController();
    this.activeStreams.set(streamId, abortController);

    try {
      // Phase 1: Quick keyword search
      const quickResults = await this.performQuickSearch(query, searchType);
      for (const result of quickResults) {
        if (abortController.signal.aborted) break;
        onResult({ type: 'quick', data: result });
      }

      // Phase 2: Semantic search
      const semanticResults = await this.performSemanticSearch(query, searchType);
      for (const result of semanticResults) {
        if (abortController.signal.aborted) break;
        onResult({ type: 'semantic', data: result });
      }

      // Phase 3: AI-enhanced results
      const aiResults = await this.enhanceWithAI(query, [...quickResults, ...semanticResults]);
      for (const result of aiResults) {
        if (abortController.signal.aborted) break;
        onResult({ type: 'enhanced', data: result });
      }

      return {
        streamId,
        abort: () => this.abortStream(streamId),
      };
    } finally {
      this.activeStreams.delete(streamId);
    }
  }

  /**
   * Stream collaborative suggestions progressively
   */
  async streamCollaborationSuggestions(
    boardId: string,
    userId: string,
    onSuggestion: (suggestion: any) => void
  ) {
    const streamId = `collab-${Date.now()}`;
    const abortController = new AbortController();
    this.activeStreams.set(streamId, abortController);

    try {
      // Stream suggestions in order of relevance
      const stages = [
        { type: 'direct_connections', weight: 1.0 },
        { type: 'similar_interests', weight: 0.8 },
        { type: 'complementary_skills', weight: 0.7 },
        { type: 'network_recommendations', weight: 0.5 },
      ];

      for (const stage of stages) {
        if (abortController.signal.aborted) break;
        
        const suggestions = await this.getCollaboratorsByType(
          boardId,
          userId,
          stage.type
        );
        
        for (const suggestion of suggestions) {
          if (abortController.signal.aborted) break;
          onSuggestion({
            ...suggestion,
            relevance: stage.weight,
            source: stage.type,
          });
        }
      }

      return {
        streamId,
        abort: () => this.abortStream(streamId),
      };
    } finally {
      this.activeStreams.delete(streamId);
    }
  }

  /**
   * Abort an active stream
   */
  abortStream(streamId: string): boolean {
    const controller = this.activeStreams.get(streamId);
    if (controller) {
      controller.abort();
      this.activeStreams.delete(streamId);
      return true;
    }
    return false;
  }

  /**
   * Abort all active streams
   */
  abortAllStreams(): number {
    let count = 0;
    for (const [streamId, controller] of this.activeStreams) {
      controller.abort();
      count++;
    }
    this.activeStreams.clear();
    return count;
  }

  // Helper methods
  private getDefaultSystemPrompt(toolId: string): string {
    const prompts: Record<string, string> = {
      'search-boards': 'You are a search assistant helping users find relevant boards.',
      'analyze-board': 'You are an analytics expert providing insights about boards.',
      'suggest-collaborators': 'You are a collaboration expert matching users with potential partners.',
      'organize-assets': 'You are an organization specialist helping arrange content effectively.',
    };
    
    return prompts[toolId] || 'You are an AI assistant helping with content management.';
  }

  private buildContextualPrompt(prompt: string, context: any): string {
    const contextInfo = Object.entries(context)
      .map(([key, value]) => `${key}: ${JSON.stringify(value)}`)
      .join('\n');
    
    return `${prompt}\n\nContext:\n${contextInfo}`;
  }

  private async performQuickSearch(query: string, type: string): Promise<any[]> {
    // Quick keyword-based search
    // This would call your actual search service
    return [];
  }

  private async performSemanticSearch(query: string, type: string): Promise<any[]> {
    // Semantic search using embeddings
    // This would call your vector search service
    return [];
  }

  private async enhanceWithAI(query: string, results: any[]): Promise<any[]> {
    // Enhance results with AI analysis
    // This would use AI to re-rank and annotate results
    return results;
  }

  private async getCollaboratorsByType(
    boardId: string,
    userId: string,
    type: string
  ): Promise<any[]> {
    // Get collaborators based on different criteria
    // This would call your recommendation service
    return [];
  }
}

/**
 * Server-Sent Events (SSE) handler for real-time updates
 */
export class SSEHandler {
  private clients = new Map<string, WritableStreamDefaultWriter>();

  /**
   * Create an SSE connection for a client
   */
  createConnection(clientId: string): ReadableStream {
    const { readable, writable } = new TransformStream();
    const writer = writable.getWriter();
    this.clients.set(clientId, writer);

    // Send initial connection message
    this.sendEvent(clientId, 'connected', { clientId, timestamp: Date.now() });

    return readable;
  }

  /**
   * Send an event to a specific client
   */
  async sendEvent(clientId: string, eventType: string, data: any) {
    const writer = this.clients.get(clientId);
    if (!writer) return false;

    try {
      const message = `event: ${eventType}\ndata: ${JSON.stringify(data)}\n\n`;
      await writer.write(new TextEncoder().encode(message));
      return true;
    } catch (error) {
      // Client disconnected
      this.closeConnection(clientId);
      return false;
    }
  }

  /**
   * Broadcast an event to all connected clients
   */
  async broadcast(eventType: string, data: any) {
    const promises = Array.from(this.clients.keys()).map(clientId =>
      this.sendEvent(clientId, eventType, data)
    );
    await Promise.all(promises);
  }

  /**
   * Close a client connection
   */
  closeConnection(clientId: string) {
    const writer = this.clients.get(clientId);
    if (writer) {
      writer.close();
      this.clients.delete(clientId);
    }
  }

  /**
   * Get number of active connections
   */
  getActiveConnections(): number {
    return this.clients.size;
  }
}

// Export singleton instances
export const streamHandler = new AIStreamHandler();
export const sseHandler = new SSEHandler();
````

## File: apps/ai/src/mastra/mcp/tools/asset/index.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

export const analyzeAssetTool = createTool({
  id: 'analyze-asset-personalities',
  description:
    'Analyze visual assets to determine their aesthetic personality and characteristics',
  inputSchema: z.object({
    assetIds: z.array(z.string()).describe('Array of asset IDs to analyze'),
    analysisType: z
      .enum(['aesthetic', 'emotional', 'style', 'all'])
      .default('all')
      .describe('Type of analysis to perform'),
    userId: z.string().describe('User ID requesting the analysis'),
  }),
  outputSchema: z.object({
    analysis: z.array(
      z.object({
        assetId: z.string(),
        personality: z.record(z.unknown()),
        tags: z.array(z.string()),
        mood: z.string(),
        style: z.string(),
        confidence: z.number(),
      })
    ),
    insights: z.string(),
  }),
  execute: async ({ context }) => {
    const { assetIds, analysisType, userId } = context;
    try {
      // Simulate asset analysis
      const analysis = assetIds.map((assetId) => ({
        assetId,
        personality: {
          vibrant: Math.random() > 0.5,
          minimalist: Math.random() > 0.5,
          rustic: Math.random() > 0.5,
          modern: Math.random() > 0.5,
        },
        tags: ['colorful', 'inspiring', 'creative'],
        mood: 'uplifting',
        style: 'contemporary',
        confidence: 0.85,
      }));

      return {
        analysis,
        insights:
          'Your collection shows a preference for vibrant, contemporary aesthetics with uplifting moods.',
      };
    } catch (error) {
      throw new Error(`Failed to analyze assets: ${error}`);
    }
  },
});

export const generateTagsTool = createTool({
  id: 'generate-collection-tags',
  description:
    'Generate relevant tags for a collection of assets based on visual analysis',
  inputSchema: z.object({
    assetIds: z.array(z.string()).describe('Array of asset IDs to tag'),
    existingTags: z
      .array(z.string())
      .default([])
      .describe('Existing tags to consider'),
    tagCount: z
      .number()
      .min(1)
      .max(20)
      .default(10)
      .describe('Number of tags to generate'),
    userId: z.string().describe('User ID requesting tags'),
  }),
  outputSchema: z.object({
    tags: z.array(z.string()),
    categories: z.record(z.array(z.string())),
    confidence: z.number(),
  }),
  execute: async ({ context }) => {
    const { assetIds, existingTags, tagCount, userId } = context;
    try {
      // Simulate tag generation based on visual patterns
      const allTags = new Set(existingTags);
      const suggestedTags = [
        'minimalist',
        'vibrant',
        'cozy',
        'modern',
        'rustic',
        'elegant',
        'playful',
        'sophisticated',
        'warm',
        'cool',
        'nature',
        'urban',
        'abstract',
        'geometric',
        'organic',
      ];

      // Add new tags
      while (allTags.size < tagCount) {
        const randomTag =
          suggestedTags[Math.floor(Math.random() * suggestedTags.length)];
        allTags.add(randomTag);
      }

      return {
        tags: Array.from(allTags).slice(0, tagCount),
        categories: {
          style: ['minimalist', 'modern', 'rustic'],
          mood: ['cozy', 'vibrant', 'warm'],
          theme: ['nature', 'urban', 'abstract'],
        },
        confidence: 0.78,
      };
    } catch (error) {
      throw new Error(`Failed to generate tags: ${error}`);
    }
  },
});
````

## File: apps/ai/src/mastra/mcp/tools/board/index.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

export const createBoardTool = createTool({
  id: 'create-board',
  description: 'Create a new Squish board with specified theme and settings',
  inputSchema: z.object({
    name: z.string().describe('Name of the board'),
    description: z
      .string()
      .optional()
      .describe('Brief description of the board'),
    theme: z.string().optional().describe('Visual theme or aesthetic'),
    isPublic: z
      .boolean()
      .default(false)
      .describe('Whether the board is publicly visible'),
    tags: z.array(z.string()).default([]).describe('Tags for the board'),
    userId: z.string().describe('User ID creating the board'),
  }),
  outputSchema: z.object({
    success: z.boolean(),
    boardId: z.string().optional(),
    message: z.string(),
  }),
  execute: async ({ context }) => {
    const { name, description, theme, isPublic, tags, userId } = context;
    try {
      return {
        success: true,
        boardId: `board_${Date.now()}`,
        message: `Board "${name}" created successfully with ${theme || 'default'} theme`,
      };
    } catch (error) {
      return {
        success: false,
        message: `Failed to create board: ${error}`,
      };
    }
  },
});

export const suggestBoardLayoutTool = createTool({
  id: 'suggest-board-layout',
  description: 'Suggest optimal layout for a board based on its content',
  inputSchema: z.object({
    boardId: z.string().describe('ID of the board'),
    assetCount: z.number().optional().describe('Number of assets on the board'),
    contentType: z
      .enum(['images', 'videos', 'mixed'])
      .optional()
      .describe('Primary content type'),
    stylePreference: z
      .enum(['grid', 'masonry', 'carousel'])
      .optional()
      .describe("User's layout preference"),
  }),
  outputSchema: z.object({
    suggestedLayout: z.string(),
    reasoning: z.string(),
    configuration: z.record(z.unknown()).optional(),
  }),
  execute: async ({ context }) => {
    const { boardId, assetCount, contentType, stylePreference } = context;
    try {
      // Analyze board content and suggest best layout
      let layout = 'grid';
      let reasoning = '';

      if (!assetCount || assetCount < 10) {
        layout = stylePreference || 'grid';
        reasoning = 'Small collections work well with a clean grid layout';
      } else if (assetCount > 50) {
        layout = 'masonry';
        reasoning =
          'Large collections benefit from masonry layout for better space utilization';
      }

      if (contentType === 'videos') {
        layout = 'carousel';
        reasoning = 'Video content is best showcased in a carousel format';
      }

      return {
        suggestedLayout: layout,
        reasoning,
        configuration: {
          columns: layout === 'grid' ? 3 : undefined,
          gap: '1rem',
        },
      };
    } catch (error) {
      throw new Error(`Failed to suggest layout: ${error}`);
    }
  },
});
````

## File: apps/ai/src/mastra/mcp/tools/collaboration/index.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

export const generateCommentsTool = createTool({
  id: 'generate-board-comments',
  description:
    'Generate thoughtful comments for board assets to spark collaboration',
  inputSchema: z.object({
    boardId: z.string().describe('ID of the board'),
    assetIds: z.array(z.string()).describe('Array of asset IDs to comment on'),
    commentStyle: z
      .enum(['encouraging', 'constructive', 'questioning', 'inspirational'])
      .default('encouraging'),
    userId: z.string().describe('User ID requesting comments'),
  }),
  outputSchema: z.object({
    comments: z.array(
      z.object({
        assetId: z.string(),
        comment: z.string(),
        type: z.string(),
      })
    ),
  }),
  execute: async ({ context }) => {
    const { boardId, assetIds, commentStyle, userId } = context;
    try {
      const templates = {
        encouraging: [
          'Love the vibe of this asset! It really brings the board together.',
          'This piece speaks volumes about your creative vision.',
          'The aesthetic here is absolutely inspiring!',
          "You've captured something truly special here.",
        ],
        constructive: [
          'Have you considered how this might look in a different arrangement?',
          'This could be enhanced by playing with the surrounding elements.',
          'The composition is strong - maybe try adjusting the scale?',
          'Interesting choice! How would this work with more negative space?',
        ],
        questioning: [
          'What inspired you to include this particular piece?',
          'How does this asset connect to your overall theme?',
          'What story do you think this element tells?',
          'How does this make you feel when you look at it?',
        ],
        inspirational: [
          'This opens up so many creative possibilities!',
          'I can imagine this evolving into an entire series.',
          "There's a whole world of inspiration hidden in this asset.",
          'This reminds me that creativity knows no bounds.',
        ],
      };

      const comments = assetIds.map((assetId) => ({
        assetId,
        comment:
          templates[commentStyle][
            Math.floor(Math.random() * templates[commentStyle].length)
          ],
        type: commentStyle,
      }));

      return { comments };
    } catch (error) {
      throw new Error(`Failed to generate comments: ${error}`);
    }
  },
});

export const suggestCollaborationsTool = createTool({
  id: 'suggest-collaborations',
  description:
    'Suggest collaboration opportunities based on board content and user interests',
  inputSchema: z.object({
    boardId: z.string().describe('ID of the board to analyze'),
    userId: z.string().describe('User ID requesting suggestions'),
    maxSuggestions: z
      .number()
      .min(1)
      .max(10)
      .default(5)
      .describe('Maximum number of suggestions'),
  }),
  outputSchema: z.object({
    suggestions: z.array(
      z.object({
        type: z.string(),
        title: z.string(),
        description: z.string(),
        potentialCollaborators: z.array(z.string()).optional(),
      })
    ),
  }),
  execute: async ({ context }) => {
    const { boardId, userId, maxSuggestions } = context;
    try {
      const suggestions = [
        {
          type: 'theme_extension',
          title: 'Expand the Theme',
          description:
            'Collaborate with artists who specialize in complementary styles',
          potentialCollaborators: [
            'digital-artists',
            'photographers',
            'illustrators',
          ],
        },
        {
          type: 'series_creation',
          title: 'Create a Series',
          description:
            'Work with others to turn this concept into a multi-part collection',
          potentialCollaborators: [
            'storytellers',
            'creative-directors',
            'designers',
          ],
        },
        {
          type: 'community_challenge',
          title: 'Community Challenge',
          description:
            'Turn this theme into a weekly challenge for the community',
          potentialCollaborators: ['community-managers', 'content-creators'],
        },
        {
          type: 'expert_feedback',
          title: 'Get Expert Feedback',
          description:
            'Invite professionals to provide insights on this collection',
          potentialCollaborators: ['art-directors', 'curators', 'critics'],
        },
        {
          type: 'cross_platform',
          title: 'Cross-Platform Project',
          description: 'Adapt this concept for different mediums or platforms',
          potentialCollaborators: [
            'multimedia-artists',
            'developers',
            'animators',
          ],
        },
      ];

      return {
        suggestions: suggestions.slice(0, maxSuggestions),
      };
    } catch (error) {
      throw new Error(`Failed to suggest collaborations: ${error}`);
    }
  },
});
````

## File: apps/ai/src/mastra/mcp/index.ts
````typescript
import { MCPServer } from '@mastra/mcp';
import { mastra } from '../mastra';
import { analyzeAssetTool, generateTagsTool } from './tools/asset';
import { createBoardTool, suggestBoardLayoutTool } from './tools/board';
import {
  generateCommentsTool,
  suggestCollaborationsTool,
} from './tools/collaboration';

// Create MCP Server for Squish AI
const server = new MCPServer({
  name: 'squish-ai-mcp',
  version: '1.0.0',
  description: 'Squish AI MCP server providing creative assistance tools',

  // Expose existing agents as tools
  agents: {
    searchEnhancer: mastra.getAgent('search-enhancer'),
    contentAnalysis: mastra.getAgent('content-analysis'),
    squishChat: mastra.getAgent('squish-chat'),
  },

  // Expose workflows
  workflows: {
    multimodalRag: mastra.getWorkflow('multimodal-rag'),
    contentAnalysis: mastra.getWorkflow('content-analysis'),
  },

  // Squish-specific tools
  tools: {
    // Board management tools
    createBoard: createBoardTool,
    suggestBoardLayout: suggestBoardLayoutTool,

    // Asset analysis tools
    analyzeAssetPersonalities: analyzeAssetTool,
    generateCollectionTags: generateTagsTool,

    // Collaboration tools
    generateBoardComments: generateCommentsTool,
    suggestCollaborations: suggestCollaborationsTool,
  },

  // Server configuration
  server: {
    capabilities: {
      tools: true,
      agents: true,
      workflows: true,
      resources: true,
      prompts: true,
    },
  },

  // Error handling
  onError: (_error) => {},
});

// Graceful shutdown
process.on('SIGTERM', () => {
  server.close();
});

process.on('SIGINT', () => {
  server.close();
});

// Start server
async function startServer() {
  try {
    await server.startStdio();
  } catch (_error) {
    process.exit(1);
  }
}

// Export for direct import
export { server };

// Start if running directly
if (import.meta.url === `file://${process.argv[1]}`) {
  startServer();
}
````

## File: apps/ai/src/mastra/schemas/index.ts
````typescript
import { z } from 'zod';

export const contentPersonalitySchema = z.object({
  description: z.string().describe('Engaging 1-2 sentence description'),
  emoji: z.string().describe('Perfect emoji to represent the content'),
  mood: z.string().describe('The overall mood or emotional tone'),
  themes: z.array(z.string()).describe('Key themes and concepts'),
  vibe: z.string().describe('Overall vibe in 2-3 words'),
  contentType: z.string().describe('Detected content type'),
});

export const searchEnhancementSchema = z.object({
  original: z.string(),
  enhanced: z.string(),
  entities: z.array(z.string()),
  context: z.array(z.string()),
  corrections: z.record(z.string()),
});

export type ContentPersonality = z.infer<typeof contentPersonalitySchema>;
export type SearchEnhancement = z.infer<typeof searchEnhancementSchema>;
````

## File: apps/ai/src/mastra/tools/asset/categorize-assets.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Automatically categorize assets using AI-powered content analysis
 */
export const categorizeAssetsTool = createTool({
  id: 'categorize-assets',
  description: 'Analyze and automatically categorize assets using computer vision, content analysis, and machine learning',
  inputSchema: z.object({
    assetIds: z.array(z.string()).min(1).max(100).describe('Array of asset IDs to categorize'),
    userId: z.string().describe('User ID requesting the categorization'),
    categorySystem: z.enum(['smart', 'thematic', 'technical', 'custom']).default('smart').describe('Categorization approach to use'),
    customCategories: z.array(z.object({
      name: z.string(),
      description: z.string(),
      keywords: z.array(z.string()),
      visualFeatures: z.array(z.string()).optional(),
    })).optional().describe('Custom category definitions for custom system'),
    analysisDepth: z.enum(['basic', 'detailed', 'comprehensive']).default('detailed').describe('Depth of analysis to perform'),
    confidence: z.object({
      minimum: z.number().min(0).max(1).default(0.6).describe('Minimum confidence threshold for categorization'),
      requireManualReview: z.number().min(0).max(1).default(0.8).describe('Confidence threshold requiring manual review'),
    }).default({}),
    options: z.object({
      allowMultipleCategories: z.boolean().default(true).describe('Allow assets to belong to multiple categories'),
      generateSubcategories: z.boolean().default(false).describe('Create hierarchical subcategories'),
      updateExistingTags: z.boolean().default(true).describe('Update asset tags based on categorization'),
      createNewBoards: z.boolean().default(false).describe('Suggest creating new boards for discovered categories'),
    }).default({}),
  }),
  outputSchema: z.object({
    categorization: z.array(z.object({
      assetId: z.string(),
      categories: z.array(z.object({
        name: z.string(),
        confidence: z.number(),
        subcategory: z.string().optional(),
        reasoning: z.string(),
        suggestedTags: z.array(z.string()),
        visualFeatures: z.array(z.string()).optional(),
        metadata: z.record(z.unknown()).optional(),
      })),
      overallConfidence: z.number(),
      requiresReview: z.boolean(),
      analysisDetails: z.object({
        contentType: z.string(),
        visualComplexity: z.number(),
        technicalQuality: z.number(),
        uniquenessScore: z.number(),
      }).optional(),
    })),
    categoryStats: z.object({
      totalAssets: z.number(),
      categorized: z.number(),
      requireReview: z.number(),
      averageConfidence: z.number(),
      categoriesFound: z.array(z.object({
        name: z.string(),
        count: z.number(),
        averageConfidence: z.number(),
        description: z.string(),
      })),
    }),
    suggestions: z.object({
      newCategories: z.array(z.object({
        name: z.string(),
        description: z.string(),
        assetCount: z.number(),
        confidence: z.number(),
      })),
      boardCreation: z.array(z.object({
        suggestedName: z.string(),
        description: z.string(),
        assetIds: z.array(z.string()),
        reasoning: z.string(),
      })).optional(),
      tagOptimization: z.array(z.object({
        currentTag: z.string(),
        suggestedTag: z.string(),
        affectedAssets: z.number(),
        reason: z.string(),
      })),
    }),
    executionMetadata: z.object({
      processingTime: z.number(),
      modelsUsed: z.array(z.string()),
      analysisDepth: z.string(),
      batchProcessed: z.boolean(),
    }),
  }),
  execute: async ({ context }) => {
    const { assetIds, userId, categorySystem, customCategories, analysisDepth, confidence, options } = context;
    try {
      const startTime = Date.now();
      
      // Mock categorization results - in production this would:
      // 1. Load assets and their metadata
      // 2. Run computer vision analysis for visual features
      // 3. Analyze content with AI models
      // 4. Apply categorization rules based on system type
      // 5. Return categorized results with confidence scores

      const categorization = assetIds.map((assetId, index) => {
        // Simulate different asset types and categories
        const mockCategories = generateMockCategories(categorySystem, index);
        
        return {
          assetId,
          categories: mockCategories,
          overallConfidence: Math.max(...mockCategories.map(c => c.confidence)),
          requiresReview: mockCategories.some(c => c.confidence < confidence.requireManualReview),
          analysisDetails: analysisDepth !== 'basic' ? {
            contentType: ['photography', 'digital_art', 'document', 'video'][index % 4],
            visualComplexity: Math.random() * 0.5 + 0.5,
            technicalQuality: Math.random() * 0.3 + 0.7,
            uniquenessScore: Math.random() * 0.4 + 0.6,
          } : undefined,
        };
      });

      // Calculate category statistics
      const allCategories = categorization.flatMap(item => item.categories);
      const categoryMap = new Map<string, { count: number; confidences: number[] }>();
      
      allCategories.forEach(cat => {
        const existing = categoryMap.get(cat.name) || { count: 0, confidences: [] };
        existing.count++;
        existing.confidences.push(cat.confidence);
        categoryMap.set(cat.name, existing);
      });

      const categoriesFound = Array.from(categoryMap.entries()).map(([name, data]) => ({
        name,
        count: data.count,
        averageConfidence: data.confidences.reduce((a, b) => a + b, 0) / data.confidences.length,
        description: getCategoryDescription(name),
      }));

      const categoryStats = {
        totalAssets: assetIds.length,
        categorized: categorization.filter(item => item.categories.length > 0).length,
        requireReview: categorization.filter(item => item.requiresReview).length,
        averageConfidence: allCategories.length > 0 
          ? allCategories.reduce((sum, cat) => sum + cat.confidence, 0) / allCategories.length 
          : 0,
        categoriesFound,
      };

      // Generate suggestions based on categorization results
      const suggestions = {
        newCategories: [
          {
            name: 'Architectural Details',
            description: 'Close-up shots of building elements and structural features',
            assetCount: 3,
            confidence: 0.84,
          },
          {
            name: 'Urban Landscapes',
            description: 'Wide shots of city environments and skylines',
            assetCount: 5,
            confidence: 0.91,
          },
        ],
        boardCreation: options.createNewBoards ? [
          {
            suggestedName: 'Street Photography Collection',
            description: 'Curated collection of urban street photography',
            assetIds: assetIds.slice(0, 3),
            reasoning: 'High concentration of street photography content with similar aesthetic',
          },
        ] : undefined,
        tagOptimization: [
          {
            currentTag: 'photo',
            suggestedTag: 'photography',
            affectedAssets: 8,
            reason: 'More specific and searchable tag',
          },
          {
            currentTag: 'city',
            suggestedTag: 'urban',
            affectedAssets: 12,
            reason: 'Better aligns with photography terminology',
          },
        ],
      };

      const executionMetadata = {
        processingTime: Date.now() - startTime,
        modelsUsed: ['vision-transformer', 'content-classifier', 'semantic-analyzer'],
        analysisDepth,
        batchProcessed: assetIds.length > 1,
      };

      return {
        categorization,
        categoryStats,
        suggestions,
        executionMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to categorize assets: ${error}`);
    }
  },
});

// Helper function to generate mock categories based on system type
function generateMockCategories(system: string, index: number) {
  const baseSystems = {
    smart: [
      ['Street Photography', 'Documentary photography capturing urban life and culture'],
      ['Architecture', 'Structural and design elements of buildings and spaces'],
      ['Portrait', 'Human subjects and character studies'],
      ['Landscape', 'Natural and urban environmental scenes'],
    ],
    thematic: [
      ['Urban Life', 'City environments and metropolitan themes'],
      ['Cultural Expression', 'Art, music, and cultural activities'],
      ['Natural World', 'Nature, wildlife, and outdoor environments'],
      ['Human Connection', 'Relationships and social interactions'],
    ],
    technical: [
      ['High Resolution', 'Images with high pixel density and detail'],
      ['Professional Quality', 'Well-composed and technically excellent shots'],
      ['Mobile Photography', 'Photos taken with mobile devices'],
      ['Post-Processed', 'Images with significant digital editing'],
    ],
  };

  const categories = baseSystems[system as keyof typeof baseSystems] || baseSystems.smart;
  const selectedCategory = categories[index % categories.length];
  
  const confidence = Math.random() * 0.3 + 0.7; // Random confidence between 0.7-1.0
  
  return [
    {
      name: selectedCategory[0],
      confidence,
      reasoning: selectedCategory[1],
      suggestedTags: generateTagsForCategory(selectedCategory[0]),
      visualFeatures: generateVisualFeatures(selectedCategory[0]),
    },
  ];
}

// Helper function to get category description
function getCategoryDescription(categoryName: string): string {
  const descriptions: Record<string, string> = {
    'Street Photography': 'Documentary-style photography capturing candid moments in urban environments',
    'Architecture': 'Photography focusing on building design, structural elements, and spatial composition',
    'Portrait': 'Images featuring human subjects with emphasis on expression and character',
    'Landscape': 'Wide-angle photography of natural or urban environments and scenic vistas',
    'Urban Life': 'Scenes depicting city culture, metropolitan activities, and urban lifestyle',
    'Cultural Expression': 'Documentation of artistic, musical, and cultural activities and expressions',
    'Natural World': 'Photography of nature, wildlife, outdoor environments, and natural phenomena',
    'Human Connection': 'Images capturing relationships, interactions, and social dynamics between people',
  };
  
  return descriptions[categoryName] || 'Automatically categorized content based on AI analysis';
}

// Helper function to generate relevant tags for a category
function generateTagsForCategory(categoryName: string): string[] {
  const tagMap: Record<string, string[]> = {
    'Street Photography': ['street', 'urban', 'candid', 'documentary', 'city'],
    'Architecture': ['building', 'design', 'structure', 'geometric', 'architectural'],
    'Portrait': ['person', 'face', 'expression', 'character', 'human'],
    'Landscape': ['scenery', 'vista', 'horizon', 'natural', 'environmental'],
    'Urban Life': ['metropolitan', 'lifestyle', 'culture', 'community', 'social'],
    'Cultural Expression': ['art', 'creative', 'cultural', 'performance', 'artistic'],
    'Natural World': ['nature', 'outdoor', 'wildlife', 'natural', 'environmental'],
    'Human Connection': ['relationship', 'interaction', 'social', 'community', 'togetherness'],
  };
  
  return tagMap[categoryName] || ['general', 'uncategorized'];
}

// Helper function to generate visual features
function generateVisualFeatures(categoryName: string): string[] {
  const featureMap: Record<string, string[]> = {
    'Street Photography': ['high_contrast', 'documentary_style', 'urban_textures'],
    'Architecture': ['geometric_patterns', 'structural_lines', 'perspective_depth'],
    'Portrait': ['human_features', 'facial_composition', 'shallow_depth'],
    'Landscape': ['wide_composition', 'natural_lighting', 'horizon_lines'],
    'Urban Life': ['crowd_scenes', 'city_activity', 'environmental_context'],
    'Cultural Expression': ['artistic_elements', 'creative_composition', 'expressive_content'],
    'Natural World': ['organic_shapes', 'natural_textures', 'environmental_lighting'],
    'Human Connection': ['multiple_subjects', 'interaction_dynamics', 'emotional_content'],
  };
  
  return featureMap[categoryName] || ['general_composition'];
}
````

## File: apps/ai/src/mastra/tools/asset/find-similar-assets.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Find visually and semantically similar assets using AI-powered similarity matching
 */
export const findSimilarAssetsTool = createTool({
  id: 'find-similar-assets',
  description: 'Find assets similar to a given asset using visual features, semantic meaning, metadata, and content analysis',
  inputSchema: z.object({
    sourceAssetId: z.string().describe('ID of the asset to find similar items for'),
    userId: z.string().describe('User ID requesting the similarity search'),
    similarityTypes: z.object({
      visual: z.boolean().default(true).describe('Match visual features like colors, composition, style'),
      semantic: z.boolean().default(true).describe('Match semantic meaning and conceptual similarity'),
      contextual: z.boolean().default(false).describe('Match contextual information like location, time, event'),
      stylistic: z.boolean().default(true).describe('Match artistic/photographic style and techniques'),
      technical: z.boolean().default(false).describe('Match technical attributes like camera settings, quality'),
    }).default({}),
    searchScope: z.object({
      userAssets: z.boolean().default(true).describe('Search within user\'s own assets'),
      publicBoards: z.boolean().default(false).describe('Search public boards'),
      specificBoards: z.array(z.string()).optional().describe('Search within specific board IDs'),
      excludeAssets: z.array(z.string()).default([]).describe('Asset IDs to exclude from results'),
    }).default({}),
    filters: z.object({
      assetTypes: z.array(z.enum(['image', 'video', 'audio', 'document', 'gif'])).optional(),
      minSimilarity: z.number().min(0).max(1).default(0.7).describe('Minimum similarity threshold'),
      maxResults: z.number().min(1).max(50).default(10).describe('Maximum number of similar assets to return'),
      includeVariations: z.boolean().default(false).describe('Include different crops/edits of the same asset'),
      recencyBias: z.number().min(0).max(1).default(0.1).describe('Boost score for more recent assets'),
    }).default({}),
    analysisDepth: z.enum(['fast', 'detailed', 'comprehensive']).default('detailed').describe('Depth of similarity analysis'),
    groupResults: z.boolean().default(false).describe('Group results by similarity clusters'),
  }),
  outputSchema: z.object({
    sourceAsset: z.object({
      id: z.string(),
      name: z.string(),
      type: z.string(),
      url: z.string(),
      analysisFeatures: z.object({
        dominantColors: z.array(z.string()),
        composition: z.string(),
        style: z.array(z.string()),
        semanticTags: z.array(z.string()),
        technicalAttributes: z.record(z.unknown()).optional(),
      }),
    }),
    similarAssets: z.array(z.object({
      id: z.string(),
      name: z.string(),
      type: z.string(),
      url: z.string(),
      thumbnailUrl: z.string().optional(),
      overallSimilarity: z.number(),
      similarityScores: z.object({
        visual: z.number().optional(),
        semantic: z.number().optional(),
        contextual: z.number().optional(),
        stylistic: z.number().optional(),
        technical: z.number().optional(),
      }),
      matchReasons: z.array(z.object({
        type: z.string(),
        description: z.string(),
        confidence: z.number(),
      })),
      sharedFeatures: z.array(z.string()),
      differences: z.array(z.string()).optional(),
      boardContext: z.array(z.object({
        boardId: z.string(),
        boardName: z.string(),
      })).optional(),
      createdAt: z.string(),
    })),
    clusters: z.array(z.object({
      id: z.string(),
      theme: z.string(),
      description: z.string(),
      assetIds: z.array(z.string()),
      averageSimilarity: z.number(),
      keyFeatures: z.array(z.string()),
    })).optional(),
    insights: z.object({
      primarySimilarityFactors: z.array(z.string()),
      patternAnalysis: z.array(z.string()),
      recommendations: z.array(z.object({
        type: z.string(),
        title: z.string(),
        description: z.string(),
      })),
    }),
    searchMetadata: z.object({
      totalCandidates: z.number(),
      filteredResults: z.number(),
      processingTime: z.number(),
      algorithmsUsed: z.array(z.string()),
      searchScope: z.object({
        assetsSearched: z.number(),
        boardsSearched: z.number(),
      }),
    }),
  }),
  execute: async ({ context }) => {
    const { 
      sourceAssetId, 
      userId, 
      similarityTypes, 
      searchScope, 
      filters, 
      analysisDepth, 
      groupResults 
    } = context;
    try {
      const startTime = Date.now();
      
      // Mock source asset analysis - in production this would:
      // 1. Load source asset and extract features
      // 2. Generate visual embeddings using computer vision models
      // 3. Create semantic embeddings from metadata and context
      // 4. Search for similar assets using vector similarity
      // 5. Rank results by combined similarity scores

      const sourceAsset = {
        id: sourceAssetId,
        name: 'Urban Street Scene.jpg',
        type: 'image',
        url: 'https://example.com/assets/urban-street-scene.jpg',
        analysisFeatures: {
          dominantColors: ['#2C3E50', '#34495E', '#E67E22', '#F39C12'],
          composition: 'rule_of_thirds',
          style: ['street_photography', 'documentary', 'urban'],
          semanticTags: ['city', 'street', 'people', 'architecture', 'urban_life'],
          technicalAttributes: analysisDepth !== 'fast' ? {
            exposure: 'well_exposed',
            contrast: 'high',
            saturation: 'moderate',
            sharpness: 'high',
            colorGrading: 'warm_tones',
          } : undefined,
        },
      };

      // Generate mock similar assets
      const similarAssets = generateSimilarAssets(sourceAsset, filters.maxResults, similarityTypes);

      // Create similarity clusters if requested
      const clusters = groupResults ? [
        {
          id: 'cluster-1',
          theme: 'Urban Street Photography',
          description: 'Street-level photography with architectural elements and human activity',
          assetIds: similarAssets.slice(0, 4).map(a => a.id),
          averageSimilarity: 0.87,
          keyFeatures: ['street_level_perspective', 'urban_architecture', 'documentary_style'],
        },
        {
          id: 'cluster-2',
          theme: 'Warm-Toned Cityscapes',
          description: 'Urban scenes with warm color grading and golden hour lighting',
          assetIds: similarAssets.slice(4, 7).map(a => a.id),
          averageSimilarity: 0.82,
          keyFeatures: ['warm_color_palette', 'golden_lighting', 'urban_environment'],
        },
      ] : undefined;

      // Generate insights based on similarity analysis
      const insights = {
        primarySimilarityFactors: [
          'Visual composition and perspective',
          'Color palette and lighting',
          'Urban photography style',
          'Documentary approach to street scenes',
        ],
        patternAnalysis: [
          '73% of similar assets share warm color grading',
          'Street-level perspective is the strongest visual similarity factor',
          'Urban architecture elements appear in 89% of matches',
          'Documentary photography style dominates similar content',
        ],
        recommendations: [
          {
            type: 'collection_expansion',
            title: 'Expand Urban Photography Collection',
            description: 'Create a dedicated board for street photography with similar aesthetic',
          },
          {
            type: 'style_development',
            title: 'Develop Signature Style',
            description: 'Your urban photography shows consistent warm tones and composition - consider making this your signature style',
          },
          {
            type: 'content_discovery',
            title: 'Explore Related Themes',
            description: 'Consider adding architectural details and urban portraits to complement your street scenes',
          },
        ],
      };

      const searchMetadata = {
        totalCandidates: 2847,
        filteredResults: similarAssets.length,
        processingTime: Date.now() - startTime,
        algorithmsUsed: [
          ...(similarityTypes.visual ? ['visual_feature_matching', 'color_histogram_comparison'] : []),
          ...(similarityTypes.semantic ? ['semantic_embedding_similarity'] : []),
          ...(similarityTypes.stylistic ? ['style_transfer_analysis'] : []),
          ...(similarityTypes.contextual ? ['metadata_correlation'] : []),
        ],
        searchScope: {
          assetsSearched: searchScope.userAssets ? 1247 : 0 + (searchScope.publicBoards ? 1600 : 0),
          boardsSearched: searchScope.specificBoards?.length || (searchScope.userAssets ? 23 : 0),
        },
      };

      return {
        sourceAsset,
        similarAssets,
        clusters,
        insights,
        searchMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to find similar assets: ${error}`);
    }
  },
});

// Helper function to generate mock similar assets
function generateSimilarAssets(sourceAsset: any, maxResults: number, similarityTypes: any) {
  const mockSimilarAssets = [
    {
      id: 'asset-sim-1',
      name: 'City Corner at Sunset.jpg',
      type: 'image',
      url: 'https://example.com/assets/city-corner-sunset.jpg',
      thumbnailUrl: 'https://example.com/thumbs/city-corner-sunset.jpg',
      overallSimilarity: 0.94,
      similarityScores: {
        visual: similarityTypes.visual ? 0.91 : undefined,
        semantic: similarityTypes.semantic ? 0.89 : undefined,
        stylistic: similarityTypes.stylistic ? 0.95 : undefined,
        contextual: similarityTypes.contextual ? 0.87 : undefined,
      },
      matchReasons: [
        {
          type: 'visual',
          description: 'Similar warm color palette and urban composition',
          confidence: 0.91,
        },
        {
          type: 'stylistic',
          description: 'Matching documentary street photography style',
          confidence: 0.95,
        },
        {
          type: 'semantic',
          description: 'Urban environment with architectural elements',
          confidence: 0.89,
        },
      ],
      sharedFeatures: ['warm_tones', 'urban_architecture', 'street_level', 'documentary_style'],
      differences: ['different_time_of_day', 'more_pedestrian_activity'],
      boardContext: [
        { boardId: 'board-1', boardName: 'Urban Photography Collection' },
      ],
      createdAt: new Date(Date.now() - 86400000).toISOString(),
    },
    {
      id: 'asset-sim-2',
      name: 'Downtown Architecture Detail.jpg',
      type: 'image',
      url: 'https://example.com/assets/downtown-architecture.jpg',
      thumbnailUrl: 'https://example.com/thumbs/downtown-architecture.jpg',
      overallSimilarity: 0.88,
      similarityScores: {
        visual: similarityTypes.visual ? 0.85 : undefined,
        semantic: similarityTypes.semantic ? 0.92 : undefined,
        stylistic: similarityTypes.stylistic ? 0.86 : undefined,
      },
      matchReasons: [
        {
          type: 'semantic',
          description: 'Strong thematic match in urban architecture focus',
          confidence: 0.92,
        },
        {
          type: 'visual',
          description: 'Similar geometric patterns and urban textures',
          confidence: 0.85,
        },
      ],
      sharedFeatures: ['architectural_focus', 'urban_setting', 'geometric_composition'],
      differences: ['closer_framing', 'different_architectural_style'],
      boardContext: [
        { boardId: 'board-3', boardName: 'Architecture & Design' },
      ],
      createdAt: new Date(Date.now() - 172800000).toISOString(),
    },
    {
      id: 'asset-sim-3',
      name: 'Street Life Documentary.jpg',
      type: 'image',
      url: 'https://example.com/assets/street-life-doc.jpg',
      thumbnailUrl: 'https://example.com/thumbs/street-life-doc.jpg',
      overallSimilarity: 0.85,
      similarityScores: {
        visual: similarityTypes.visual ? 0.82 : undefined,
        semantic: similarityTypes.semantic ? 0.91 : undefined,
        stylistic: similarityTypes.stylistic ? 0.88 : undefined,
      },
      matchReasons: [
        {
          type: 'stylistic',
          description: 'Similar documentary photography approach',
          confidence: 0.88,
        },
        {
          type: 'semantic',
          description: 'Captures urban life and street activity',
          confidence: 0.91,
        },
      ],
      sharedFeatures: ['documentary_style', 'street_photography', 'urban_life', 'candid_moments'],
      differences: ['more_people_focused', 'different_lighting_conditions'],
      boardContext: [
        { boardId: 'board-2', boardName: 'Street Photography' },
      ],
      createdAt: new Date(Date.now() - 259200000).toISOString(),
    },
  ];

  // Filter and limit results
  return mockSimilarAssets
    .filter(asset => asset.overallSimilarity >= 0.7) // Apply minimum similarity filter
    .slice(0, maxResults);
}
````

## File: apps/ai/src/mastra/tools/asset/generate-asset-tags.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Generate relevant tags for assets using AI-powered content analysis
 */
export const generateAssetTagsTool = createTool({
  id: 'generate-asset-tags',
  description: 'Automatically generate relevant, searchable tags for assets using computer vision, semantic analysis, and content understanding',
  inputSchema: z.object({
    assetIds: z.array(z.string()).min(1).max(50).describe('Array of asset IDs to generate tags for'),
    userId: z.string().describe('User ID requesting tag generation'),
    tagSources: z.object({
      visual: z.boolean().default(true).describe('Generate tags from visual content analysis'),
      metadata: z.boolean().default(true).describe('Generate tags from existing metadata'),
      content: z.boolean().default(false).describe('Generate tags from text content within assets (OCR/ASR)'),
      context: z.boolean().default(true).describe('Generate tags from contextual information (location, time, etc.)'),
      semantic: z.boolean().default(true).describe('Generate tags from semantic understanding of content'),
    }).default({}),
    tagTypes: z.object({
      descriptive: z.boolean().default(true).describe('Descriptive tags (colors, objects, scenes)'),
      emotional: z.boolean().default(true).describe('Emotional or mood-based tags'),
      stylistic: z.boolean().default(true).describe('Artistic style and technique tags'),
      technical: z.boolean().default(false).describe('Technical photography/media tags'),
      thematic: z.boolean().default(true).describe('High-level theme and concept tags'),
      categorical: z.boolean().default(true).describe('Category and classification tags'),
    }).default({}),
    preferences: z.object({
      maxTagsPerAsset: z.number().min(1).max(30).default(10).describe('Maximum tags to generate per asset'),
      minConfidence: z.number().min(0).max(1).default(0.6).describe('Minimum confidence threshold for tag inclusion'),
      languageStyle: z.enum(['casual', 'professional', 'artistic', 'technical']).default('casual').describe('Style of language for generated tags'),
      includeHierarchy: z.boolean().default(false).describe('Include hierarchical tags (broad to specific)'),
      excludeCommon: z.boolean().default(true).describe('Exclude overly common or generic tags'),
    }).default({}),
    existingTags: z.record(z.array(z.string())).optional().describe('Existing tags for each asset (assetId -> tags[])'),
    customVocabulary: z.array(z.string()).optional().describe('Custom vocabulary to prefer in tag generation'),
  }),
  outputSchema: z.object({
    tagResults: z.array(z.object({
      assetId: z.string(),
      generatedTags: z.array(z.object({
        tag: z.string(),
        confidence: z.number(),
        source: z.array(z.string()),
        category: z.string(),
        reasoning: z.string(),
        isNew: z.boolean(),
      })),
      existingTags: z.array(z.string()).optional(),
      tagSummary: z.object({
        totalGenerated: z.number(),
        newTags: z.number(),
        enhancedTags: z.number(),
        averageConfidence: z.number(),
        primaryCategories: z.array(z.string()),
      }),
      recommendations: z.array(z.object({
        type: z.string(),
        suggestion: z.string(),
        reason: z.string(),
      })),
    })),
    overallInsights: z.object({
      mostCommonTags: z.array(z.object({
        tag: z.string(),
        frequency: z.number(),
        category: z.string(),
      })),
      tagDistribution: z.object({
        descriptive: z.number(),
        emotional: z.number(),
        stylistic: z.number(),
        technical: z.number(),
        thematic: z.number(),
        categorical: z.number(),
      }),
      vocabularyAnalysis: z.object({
        uniqueTags: z.number(),
        averageTagsPerAsset: z.number(),
        tagConsistency: z.number(),
        languageQuality: z.number(),
      }),
      suggestions: z.array(z.object({
        type: z.string(),
        title: z.string(),
        description: z.string(),
        impact: z.string(),
      })),
    }),
    executionMetadata: z.object({
      processingTime: z.number(),
      modelsUsed: z.array(z.string()),
      assetsProcessed: z.number(),
      totalTagsGenerated: z.number(),
      batchProcessed: z.boolean(),
    }),
  }),
  execute: async ({ context }) => {
    const { 
      assetIds, 
      userId, 
      tagSources, 
      tagTypes, 
      preferences, 
      existingTags, 
      customVocabulary 
    } = context;
    try {
      const startTime = Date.now();
      
      // Mock tag generation - in production this would:
      // 1. Load asset data and analyze visual content with computer vision
      // 2. Extract metadata and contextual information
      // 3. Generate semantic embeddings and analyze content meaning
      // 4. Apply NLP for text content extraction (OCR/ASR)
      // 5. Generate tags based on configured sources and types
      // 6. Filter and rank tags by confidence and relevance

      const tagResults = assetIds.map((assetId, index) => {
        const mockTags = generateMockTags(assetId, index, tagTypes, preferences, customVocabulary);
        const existingAssetTags = existingTags?.[assetId] || [];
        
        // Determine which tags are new
        const enrichedTags = mockTags.map(tag => ({
          ...tag,
          isNew: !existingAssetTags.includes(tag.tag),
        }));

        const newTagsCount = enrichedTags.filter(t => t.isNew).length;
        const enhancedTagsCount = enrichedTags.length - newTagsCount;

        return {
          assetId,
          generatedTags: enrichedTags,
          existingTags: existingAssetTags.length > 0 ? existingAssetTags : undefined,
          tagSummary: {
            totalGenerated: enrichedTags.length,
            newTags: newTagsCount,
            enhancedTags: enhancedTagsCount,
            averageConfidence: enrichedTags.reduce((sum, tag) => sum + tag.confidence, 0) / enrichedTags.length,
            primaryCategories: Array.from(new Set(enrichedTags.map(tag => tag.category))),
          },
          recommendations: generateTagRecommendations(assetId, enrichedTags, index),
        };
      });

      // Calculate overall insights
      const allGeneratedTags = tagResults.flatMap(result => result.generatedTags);
      const tagFrequency = new Map<string, number>();
      const categoryDistribution: Record<string, number> = {
        descriptive: 0,
        emotional: 0,
        stylistic: 0,
        technical: 0,
        thematic: 0,
        categorical: 0,
      };

      allGeneratedTags.forEach(tag => {
        tagFrequency.set(tag.tag, (tagFrequency.get(tag.tag) || 0) + 1);
        categoryDistribution[tag.category] = (categoryDistribution[tag.category] || 0) + 1;
      });

      const mostCommonTags = Array.from(tagFrequency.entries())
        .sort(([, a], [, b]) => b - a)
        .slice(0, 10)
        .map(([tag, frequency]) => {
          const tagObj = allGeneratedTags.find(t => t.tag === tag);
          return {
            tag,
            frequency,
            category: tagObj?.category || 'unknown',
          };
        });

      const overallInsights = {
        mostCommonTags,
        tagDistribution: categoryDistribution,
        vocabularyAnalysis: {
          uniqueTags: tagFrequency.size,
          averageTagsPerAsset: allGeneratedTags.length / assetIds.length,
          tagConsistency: calculateTagConsistency(tagResults),
          languageQuality: calculateLanguageQuality(allGeneratedTags),
        },
        suggestions: generateOverallSuggestions(tagResults, mostCommonTags),
      };

      const executionMetadata = {
        processingTime: Date.now() - startTime,
        modelsUsed: [
          ...(tagSources.visual ? ['vision-transformer', 'object-detection'] : []),
          ...(tagSources.semantic ? ['semantic-analyzer', 'concept-recognition'] : []),
          ...(tagSources.content ? ['ocr-engine', 'speech-to-text'] : []),
          'tag-ranker', 'confidence-scorer'
        ],
        assetsProcessed: assetIds.length,
        totalTagsGenerated: allGeneratedTags.length,
        batchProcessed: assetIds.length > 1,
      };

      return {
        tagResults,
        overallInsights,
        executionMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to generate asset tags: ${error}`);
    }
  },
});

// Helper function to generate mock tags for an asset
function generateMockTags(
  assetId: string, 
  index: number, 
  tagTypes: any, 
  preferences: any, 
  customVocabulary?: string[]
) {
  const tagPools = {
    descriptive: ['urban', 'colorful', 'architectural', 'people', 'street', 'building', 'window', 'shadow', 'light'],
    emotional: ['inspiring', 'energetic', 'calm', 'dramatic', 'peaceful', 'vibrant', 'moody', 'uplifting'],
    stylistic: ['documentary', 'minimalist', 'contemporary', 'artistic', 'professional', 'candid', 'composed'],
    technical: ['high-resolution', 'sharp', 'well-exposed', 'natural-lighting', 'handheld', 'wide-angle'],
    thematic: ['city-life', 'urban-exploration', 'architecture', 'street-photography', 'lifestyle', 'culture'],
    categorical: ['photography', 'urban', 'architectural', 'lifestyle', 'documentary', 'street-art'],
  };

  const tags: Array<{
    tag: string;
    confidence: number;
    source: string[];
    category: string;
    reasoning: string;
    isNew: boolean;
  }> = [];

  // Generate tags for each enabled type
  Object.entries(tagTypes).forEach(([category, enabled]) => {
    if (enabled && tagPools[category as keyof typeof tagPools]) {
      const pool = tagPools[category as keyof typeof tagPools];
      const numTags = Math.min(Math.ceil(preferences.maxTagsPerAsset / Object.keys(tagTypes).length), 3);
      
      for (let i = 0; i < numTags; i++) {
        const tagIndex = (index + i) % pool.length;
        const tag = pool[tagIndex];
        const confidence = Math.random() * 0.3 + 0.7; // Random confidence between 0.7-1.0
        
        if (confidence >= preferences.minConfidence) {
          tags.push({
            tag,
            confidence,
            source: getSourcesToGenerateTag(category),
            category,
            reasoning: generateTagReasoning(tag, category),
            isNew: false, // Will be determined later
          });
        }
      }
    }
  });

  // Add custom vocabulary tags if provided
  if (customVocabulary && customVocabulary.length > 0) {
    const customTag = customVocabulary[index % customVocabulary.length];
    tags.push({
      tag: customTag,
      confidence: 0.85,
      source: ['custom-vocabulary'],
      category: 'custom',
      reasoning: 'Added from custom vocabulary preferences',
      isNew: false,
    });
  }

  // Sort by confidence and limit to max tags
  return tags
    .sort((a, b) => b.confidence - a.confidence)
    .slice(0, preferences.maxTagsPerAsset);
}

// Helper function to get sources that would generate a tag
function getSourcesToGenerateTag(category: string): string[] {
  const sourceMap: Record<string, string[]> = {
    descriptive: ['visual', 'metadata'],
    emotional: ['semantic', 'visual'],
    stylistic: ['visual', 'semantic'],
    technical: ['metadata', 'content'],
    thematic: ['semantic', 'context'],
    categorical: ['semantic', 'visual'],
  };
  
  return sourceMap[category] || ['visual'];
}

// Helper function to generate reasoning for a tag
function generateTagReasoning(tag: string, category: string): string {
  const reasoningTemplates: Record<string, string[]> = {
    descriptive: [
      `Visual analysis detected ${tag} elements in the image`,
      `Object recognition identified ${tag} features prominently`,
      `Color and composition analysis suggests ${tag} characteristics`,
    ],
    emotional: [
      `Visual mood analysis indicates ${tag} emotional qualities`,
      `Color palette and composition convey ${tag} feelings`,
      `Overall aesthetic creates ${tag} atmosphere`,
    ],
    stylistic: [
      `Photography style analysis identifies ${tag} techniques`,
      `Composition and framing suggest ${tag} approach`,
      `Visual characteristics align with ${tag} aesthetic`,
    ],
    thematic: [
      `Content analysis reveals ${tag} thematic elements`,
      `Semantic understanding identifies ${tag} conceptual focus`,
      `Context and subject matter suggest ${tag} themes`,
    ],
  };
  
  const templates = reasoningTemplates[category] || [`Generated based on ${category} analysis`];
  return templates[Math.floor(Math.random() * templates.length)];
}

// Helper function to generate recommendations for an asset's tags
function generateTagRecommendations(assetId: string, tags: any[], index: number) {
  const recommendations = [
    {
      type: 'optimization',
      suggestion: 'Add location-specific tags for better discoverability',
      reason: 'Geographic tags improve search relevance for location-based queries',
    },
    {
      type: 'consistency',
      suggestion: 'Use consistent terminology across similar assets',
      reason: 'Standardized vocabulary improves collection organization',
    },
    {
      type: 'enhancement',
      suggestion: 'Consider adding more specific descriptive tags',
      reason: 'Detailed tags help users find exactly what they\'re looking for',
    },
  ];
  
  return recommendations.slice(0, 2); // Return subset for each asset
}

// Helper function to calculate tag consistency across assets
function calculateTagConsistency(tagResults: any[]): number {
  // Mock calculation - in reality this would analyze tag vocabulary consistency
  const allTags = tagResults.flatMap(result => result.generatedTags.map((t: any) => t.tag));
  const uniqueTags = new Set(allTags);
  
  // Higher ratio of reused tags indicates better consistency
  return Math.min(allTags.length / uniqueTags.size / 2, 1);
}

// Helper function to calculate language quality of generated tags
function calculateLanguageQuality(tags: any[]): number {
  // Mock calculation - in reality this would analyze tag quality, spelling, relevance
  const avgConfidence = tags.reduce((sum, tag) => sum + tag.confidence, 0) / tags.length;
  const hasVariedCategories = new Set(tags.map(tag => tag.category)).size > 3;
  
  return (avgConfidence + (hasVariedCategories ? 0.1 : 0));
}

// Helper function to generate overall suggestions for the tag generation process
function generateOverallSuggestions(tagResults: any[], mostCommonTags: any[]) {
  return [
    {
      type: 'vocabulary',
      title: 'Standardize Tag Vocabulary',
      description: 'Consider creating a custom vocabulary list to ensure consistent terminology across your collection',
      impact: 'Improved searchability and organization',
    },
    {
      type: 'automation',
      title: 'Enable Automatic Tagging',
      description: 'Set up automatic tag generation for new assets to maintain consistent metadata',
      impact: 'Reduced manual effort and consistent tagging',
    },
    {
      type: 'curation',
      title: 'Review and Refine Common Tags',
      description: `Your most common tags (${mostCommonTags.slice(0, 3).map(t => t.tag).join(', ')}) could be refined for better specificity`,
      impact: 'More precise asset discovery and categorization',
    },
  ];
}
````

## File: apps/ai/src/mastra/tools/asset/index.ts
````typescript
// Asset Organization Tools
// These tools provide AI-powered assistance for asset discovery, categorization, and organization

export { searchAssetsTool } from './search-assets';
export { categorizeAssetsTool } from './categorize-assets';
export { findSimilarAssetsTool } from './find-similar-assets';
export { generateAssetTagsTool } from './generate-asset-tags';
export { organizeAssetsByThemeTool } from './organize-by-theme';

// Re-export types and utilities
export type SearchMethod = 'semantic' | 'visual' | 'metadata' | 'content';
export type CategorySystem = 'smart' | 'thematic' | 'technical' | 'custom';
export type SimilarityType = 'visual' | 'semantic' | 'contextual' | 'stylistic' | 'technical';
export type TagSource = 'visual' | 'metadata' | 'content' | 'context' | 'semantic';
export type TagType = 'descriptive' | 'emotional' | 'stylistic' | 'technical' | 'thematic' | 'categorical';
export type OrganizationMethod = 'visual' | 'semantic' | 'hybrid' | 'temporal' | 'contextual';

// Asset search filters interface
export interface AssetSearchFilters {
  assetTypes?: ('image' | 'video' | 'audio' | 'document' | 'gif')[];
  boardIds?: string[];
  tags?: string[];
  dateRange?: {
    start?: string;
    end?: string;
  };
  visualAttributes?: {
    dominantColors?: string[];
    brightness?: 'dark' | 'medium' | 'bright';
    saturation?: 'low' | 'medium' | 'high';
    composition?: 'portrait' | 'landscape' | 'square';
  };
  minWidth?: number;
  minHeight?: number;
  maxFileSize?: number;
}

// Similarity search scope interface
export interface SimilaritySearchScope {
  userAssets?: boolean;
  publicBoards?: boolean;
  specificBoards?: string[];
  excludeAssets?: string[];
}

// Theme organization parameters interface
export interface ThemeParameters {
  minThemeSize?: number;
  maxThemes?: number;
  themeOverlap?: boolean;
  hierarchicalThemes?: boolean;
  confidenceThreshold?: number;
}
````

## File: apps/ai/src/mastra/tools/asset/organize-by-theme.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Organize assets by automatically detected themes using AI-powered content analysis
 */
export const organizeAssetsByThemeTool = createTool({
  id: 'organize-assets-by-theme',
  description: 'Automatically group assets into thematic collections using visual similarity, semantic analysis, and content understanding',
  inputSchema: z.object({
    assetIds: z.array(z.string()).min(2).max(200).describe('Array of asset IDs to organize thematically'),
    userId: z.string().describe('User ID requesting the organization'),
    organizationMethod: z.enum(['visual', 'semantic', 'hybrid', 'temporal', 'contextual']).default('hybrid').describe('Primary method for theme detection'),
    themeParameters: z.object({
      minThemeSize: z.number().min(2).max(20).default(3).describe('Minimum number of assets required to form a theme'),
      maxThemes: z.number().min(2).max(50).default(10).describe('Maximum number of themes to create'),
      themeOverlap: z.boolean().default(false).describe('Allow assets to belong to multiple themes'),
      hierarchicalThemes: z.boolean().default(false).describe('Create nested theme hierarchies'),
      confidenceThreshold: z.number().min(0).max(1).default(0.7).describe('Minimum confidence for theme assignment'),
    }).default({}),
    analysisFeatures: z.object({
      visualFeatures: z.boolean().default(true).describe('Use color, composition, and visual elements'),
      contentAnalysis: z.boolean().default(true).describe('Analyze semantic content and meaning'),
      metadataAnalysis: z.boolean().default(true).describe('Use existing metadata and tags'),
      temporalPatterns: z.boolean().default(false).describe('Consider creation time and temporal patterns'),
      geographicData: z.boolean().default(false).describe('Use location data if available'),
      styleAnalysis: z.boolean().default(true).describe('Analyze artistic and photographic style'),
    }).default({}),
    outputFormat: z.object({
      createCollections: z.boolean().default(false).describe('Create suggested board collections for themes'),
      generateTitles: z.boolean().default(true).describe('Generate descriptive titles for each theme'),
      includeAnalysis: z.boolean().default(true).describe('Include detailed analysis of each theme'),
      suggestTags: z.boolean().default(true).describe('Suggest tags for each thematic group'),
    }).default({}),
  }),
  outputSchema: z.object({
    themes: z.array(z.object({
      id: z.string(),
      title: z.string(),
      description: z.string(),
      assetIds: z.array(z.string()),
      confidence: z.number(),
      characteristics: z.object({
        visualStyle: z.array(z.string()),
        colorPalette: z.array(z.string()),
        subjects: z.array(z.string()),
        mood: z.string(),
        photographyStyle: z.string().optional(),
        technicalAttributes: z.array(z.string()).optional(),
      }),
      suggestedTags: z.array(z.string()),
      representativeAsset: z.string().describe('Asset ID that best represents this theme'),
      subthemes: z.array(z.object({
        name: z.string(),
        assetIds: z.array(z.string()),
        distinctiveFeature: z.string(),
      })).optional(),
      relationships: z.array(z.object({
        relatedThemeId: z.string(),
        relationship: z.string(),
        strength: z.number(),
      })).optional(),
    })),
    unorganized: z.object({
      assetIds: z.array(z.string()),
      reasons: z.array(z.object({
        assetId: z.string(),
        reason: z.string(),
        suggestions: z.array(z.string()),
      })),
    }),
    organizationInsights: z.object({
      totalAssets: z.number(),
      organizedAssets: z.number(),
      organizationRate: z.number(),
      dominantThemes: z.array(z.string()),
      styleConsistency: z.number(),
      thematicDiversity: z.number(),
      recommendations: z.array(z.object({
        type: z.string(),
        title: z.string(),
        description: z.string(),
        priority: z.enum(['high', 'medium', 'low']),
      })),
    }),
    collections: z.array(z.object({
      suggestedName: z.string(),
      description: z.string(),
      themeIds: z.array(z.string()),
      assetCount: z.number(),
      rationale: z.string(),
    })).optional(),
    executionMetadata: z.object({
      processingTime: z.number(),
      algorithmsUsed: z.array(z.string()),
      themeDetectionMethod: z.string(),
      clusteringAccuracy: z.number(),
    }),
  }),
  execute: async ({ context }) => {
    const { 
      assetIds, 
      userId, 
      organizationMethod, 
      themeParameters, 
      analysisFeatures, 
      outputFormat 
    } = context;
    try {
      const startTime = Date.now();
      
      // Mock thematic organization - in production this would:
      // 1. Load all assets and extract features (visual, semantic, metadata)
      // 2. Generate embeddings for visual and semantic similarity
      // 3. Apply clustering algorithms to group similar assets
      // 4. Analyze clusters to identify themes and characteristics
      // 5. Generate titles, descriptions, and tags for each theme
      // 6. Suggest board organizations and collections

      const themes = generateMockThemes(assetIds, themeParameters, analysisFeatures);
      
      // Determine which assets couldn't be organized into themes
      const organizedAssetIds = new Set(themes.flatMap(theme => theme.assetIds));
      const unorganizedAssetIds = assetIds.filter(id => !organizedAssetIds.has(id));
      
      const unorganized = {
        assetIds: unorganizedAssetIds,
        reasons: unorganizedAssetIds.map(assetId => ({
          assetId,
          reason: 'Insufficient similarity to other assets to form a cohesive theme',
          suggestions: [
            'Consider manual categorization',
            'Add more descriptive metadata',
            'Include in a miscellaneous collection',
          ],
        })),
      };

      // Calculate organization insights
      const organizationInsights = {
        totalAssets: assetIds.length,
        organizedAssets: assetIds.length - unorganizedAssetIds.length,
        organizationRate: (assetIds.length - unorganizedAssetIds.length) / assetIds.length,
        dominantThemes: themes
          .sort((a, b) => b.assetIds.length - a.assetIds.length)
          .slice(0, 3)
          .map(theme => theme.title),
        styleConsistency: calculateStyleConsistency(themes),
        thematicDiversity: calculateThematicDiversity(themes),
        recommendations: generateOrganizationRecommendations(themes, unorganized),
      };

      // Generate collection suggestions if requested
      const collections = outputFormat.createCollections ? [
        {
          suggestedName: 'Urban Photography Collection',
          description: 'A curated selection of street and architectural photography',
          themeIds: themes.filter(t => 
            t.title.includes('Street') || t.title.includes('Architecture')
          ).map(t => t.id),
          assetCount: themes
            .filter(t => t.title.includes('Street') || t.title.includes('Architecture'))
            .reduce((sum, t) => sum + t.assetIds.length, 0),
          rationale: 'Strong thematic coherence in urban photography styles',
        },
        {
          suggestedName: 'Portrait & People',
          description: 'Human-focused photography and portraiture',
          themeIds: themes.filter(t => t.title.includes('Portrait')).map(t => t.id),
          assetCount: themes
            .filter(t => t.title.includes('Portrait'))
            .reduce((sum, t) => sum + t.assetIds.length, 0),
          rationale: 'Distinct portrait photography style with consistent approach',
        },
      ] : undefined;

      const executionMetadata = {
        processingTime: Date.now() - startTime,
        algorithmsUsed: [
          ...(analysisFeatures.visualFeatures ? ['visual-clustering', 'color-analysis'] : []),
          ...(analysisFeatures.contentAnalysis ? ['semantic-clustering', 'content-analysis'] : []),
          ...(analysisFeatures.styleAnalysis ? ['style-recognition', 'technique-analysis'] : []),
          'theme-detection', 'similarity-matching',
        ],
        themeDetectionMethod: organizationMethod,
        clusteringAccuracy: 0.87, // Mock accuracy score
      };

      return {
        themes,
        unorganized,
        organizationInsights,
        collections,
        executionMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to organize assets by theme: ${error}`);
    }
  },
});

// Helper function to generate mock themes
function generateMockThemes(assetIds: string[], themeParams: any, features: any) {
  const themeTemplates = [
    {
      title: 'Urban Street Photography',
      description: 'Candid street scenes capturing city life and urban culture',
      colorPalette: ['#2C3E50', '#34495E', '#E67E22'],
      mood: 'documentary',
      subjects: ['people', 'streets', 'buildings', 'urban_life'],
      visualStyle: ['high_contrast', 'documentary', 'candid'],
      tags: ['street', 'urban', 'documentary', 'city', 'people'],
    },
    {
      title: 'Architectural Details',
      description: 'Close-up and detailed views of building elements and structures',
      colorPalette: ['#95A5A6', '#BDC3C7', '#ECF0F1'],
      mood: 'minimalist',
      subjects: ['architecture', 'buildings', 'details', 'structures'],
      visualStyle: ['geometric', 'minimalist', 'structured'],
      tags: ['architecture', 'building', 'detail', 'geometric', 'structure'],
    },
    {
      title: 'Natural Landscapes',
      description: 'Scenic outdoor environments and natural beauty',
      colorPalette: ['#27AE60', '#2ECC71', '#3498DB'],
      mood: 'peaceful',
      subjects: ['nature', 'landscapes', 'outdoors', 'scenery'],
      visualStyle: ['wide_angle', 'natural', 'scenic'],
      tags: ['nature', 'landscape', 'outdoor', 'scenic', 'natural'],
    },
    {
      title: 'Portrait Photography',
      description: 'Human subjects with focus on expression and character',
      colorPalette: ['#E74C3C', '#C0392B', '#F39C12'],
      mood: 'intimate',
      subjects: ['people', 'faces', 'portraits', 'expressions'],
      visualStyle: ['shallow_depth', 'portrait', 'personal'],
      tags: ['portrait', 'person', 'face', 'expression', 'human'],
    },
    {
      title: 'Abstract Compositions',
      description: 'Creative and artistic interpretations with abstract elements',
      colorPalette: ['#9B59B6', '#8E44AD', '#E91E63'],
      mood: 'artistic',
      subjects: ['abstract', 'artistic', 'creative', 'experimental'],
      visualStyle: ['abstract', 'artistic', 'experimental'],
      tags: ['abstract', 'artistic', 'creative', 'experimental', 'composition'],
    },
  ];

  const themes = [];
  const usedAssets = new Set<string>();
  
  // Distribute assets across themes
  let currentThemeIndex = 0;
  const assetsPerTheme = Math.max(
    themeParams.minThemeSize, 
    Math.floor(assetIds.length / Math.min(themeParams.maxThemes, themeTemplates.length))
  );

  for (let i = 0; i < Math.min(themeParams.maxThemes, themeTemplates.length); i++) {
    const template = themeTemplates[i];
    const themeAssets = [];
    
    // Assign assets to this theme
    for (let j = 0; j < assetsPerTheme && usedAssets.size < assetIds.length; j++) {
      let assetIndex = (currentThemeIndex * assetsPerTheme + j) % assetIds.length;
      let attempts = 0;
      
      // Find an unused asset (unless overlap is allowed)
      while (usedAssets.has(assetIds[assetIndex]) && !themeParams.themeOverlap && attempts < assetIds.length) {
        assetIndex = (assetIndex + 1) % assetIds.length;
        attempts++;
      }
      
      if (attempts < assetIds.length) {
        themeAssets.push(assetIds[assetIndex]);
        if (!themeParams.themeOverlap) {
          usedAssets.add(assetIds[assetIndex]);
        }
      }
    }

    if (themeAssets.length >= themeParams.minThemeSize) {
      const theme = {
        id: `theme-${i + 1}`,
        title: template.title,
        description: template.description,
        assetIds: themeAssets,
        confidence: Math.random() * 0.2 + 0.8, // Random confidence between 0.8-1.0
        characteristics: {
          visualStyle: template.visualStyle,
          colorPalette: template.colorPalette,
          subjects: template.subjects,
          mood: template.mood,
          photographyStyle: features.styleAnalysis ? getPhotographyStyle(template.mood) : undefined,
          technicalAttributes: features.styleAnalysis ? getTechnicalAttributes(template.visualStyle) : undefined,
        },
        suggestedTags: template.tags,
        representativeAsset: themeAssets[0], // First asset as representative
        subthemes: themeParams.hierarchicalThemes ? generateSubthemes(themeAssets, template) : undefined,
        relationships: generateThemeRelationships(i, themes.length),
      };
      
      themes.push(theme);
      currentThemeIndex++;
    }
  }

  return themes;
}

// Helper function to get photography style based on mood
function getPhotographyStyle(mood: string): string {
  const styleMap: Record<string, string> = {
    documentary: 'Documentary Photography',
    minimalist: 'Minimalist Photography',
    peaceful: 'Landscape Photography',
    intimate: 'Portrait Photography',
    artistic: 'Fine Art Photography',
  };
  
  return styleMap[mood] || 'Contemporary Photography';
}

// Helper function to get technical attributes
function getTechnicalAttributes(visualStyles: string[]): string[] {
  const attributeMap: Record<string, string[]> = {
    high_contrast: ['high_contrast', 'dramatic_lighting'],
    documentary: ['natural_lighting', 'fast_shutter'],
    candid: ['available_light', 'handheld'],
    geometric: ['sharp_focus', 'wide_angle'],
    minimalist: ['clean_composition', 'negative_space'],
    structured: ['tripod_stable', 'precise_framing'],
  };
  
  const attributes = new Set<string>();
  visualStyles.forEach(style => {
    (attributeMap[style] || []).forEach(attr => attributes.add(attr));
  });
  
  return Array.from(attributes);
}

// Helper function to generate subthemes
function generateSubthemes(assetIds: string[], template: any) {
  if (assetIds.length < 6) return undefined;
  
  const midpoint = Math.floor(assetIds.length / 2);
  return [
    {
      name: `${template.title} - Style A`,
      assetIds: assetIds.slice(0, midpoint),
      distinctiveFeature: 'Color-focused composition',
    },
    {
      name: `${template.title} - Style B`,
      assetIds: assetIds.slice(midpoint),
      distinctiveFeature: 'Light and shadow emphasis',
    },
  ];
}

// Helper function to generate theme relationships
function generateThemeRelationships(currentIndex: number, totalThemes: number) {
  if (totalThemes < 2) return undefined;
  
  const relationships = [];
  
  // Create relationship with previous theme if exists
  if (currentIndex > 0) {
    relationships.push({
      relatedThemeId: `theme-${currentIndex}`,
      relationship: 'complementary_style',
      strength: Math.random() * 0.4 + 0.4, // 0.4-0.8
    });
  }
  
  return relationships.length > 0 ? relationships : undefined;
}

// Helper function to calculate style consistency across themes
function calculateStyleConsistency(themes: any[]): number {
  // Mock calculation - in reality this would analyze visual consistency
  const totalAssets = themes.reduce((sum, theme) => sum + theme.assetIds.length, 0);
  const avgConfidence = themes.reduce((sum, theme) => sum + theme.confidence, 0) / themes.length;
  
  return Math.min(avgConfidence + (themes.length > 2 ? 0.1 : 0), 1);
}

// Helper function to calculate thematic diversity
function calculateThematicDiversity(themes: any[]): number {
  // Mock calculation - more themes with varied subjects = higher diversity
  const uniqueSubjects = new Set();
  themes.forEach(theme => {
    theme.characteristics.subjects.forEach((subject: string) => uniqueSubjects.add(subject));
  });
  
  return Math.min(uniqueSubjects.size / 10, 1); // Normalize to 0-1
}

// Helper function to generate organization recommendations
function generateOrganizationRecommendations(themes: any[], unorganized: any) {
  const recommendations = [];
  
  if (unorganized.assetIds.length > 0) {
    recommendations.push({
      type: 'completion',
      title: 'Organize Remaining Assets',
      description: `${unorganized.assetIds.length} assets couldn't be automatically organized. Consider manual review.`,
      priority: 'medium' as const,
    });
  }
  
  if (themes.length > 8) {
    recommendations.push({
      type: 'consolidation',
      title: 'Consider Theme Consolidation',
      description: 'You have many small themes. Consider merging similar ones for better organization.',
      priority: 'low' as const,
    });
  }
  
  const largeThemes = themes.filter(theme => theme.assetIds.length > 10);
  if (largeThemes.length > 0) {
    recommendations.push({
      type: 'subdivision',
      title: 'Consider Subdividing Large Themes',
      description: `Themes like "${largeThemes[0].title}" could be split into more specific subcategories.`,
      priority: 'medium' as const,
    });
  }
  
  return recommendations;
}
````

## File: apps/ai/src/mastra/tools/asset/search-assets.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';
import { aiServiceClient } from '../../lib/orpc-client';

/**
 * Perform semantic and multimodal search across assets
 * Uses ORPC client to communicate with API layer
 */
export const searchAssetsTool = createTool({
  id: 'search-assets',
  description: 'Search assets using semantic similarity, visual features, metadata, and AI-powered content understanding',
  inputSchema: z.object({
    query: z.string().describe('Search query (text description, keywords, or semantic concept)'),
    userId: z.string().describe('User ID to search assets for'),
    searchMethods: z.object({
      semantic: z.boolean().default(true).describe('Use vector embeddings for semantic search'),
      visual: z.boolean().default(true).describe('Use computer vision for visual similarity'),
      metadata: z.boolean().default(true).describe('Search metadata and captions'),
      content: z.boolean().default(false).describe('Use OCR/ASR for content within assets'),
    }).default({}),
    filters: z.object({
      assetTypes: z.array(z.enum(['image', 'video', 'audio', 'document', 'gif'])).optional(),
      boardIds: z.array(z.string()).optional().describe('Limit search to specific boards'),
      tags: z.array(z.string()).optional().describe('Filter by tags'),
      dateRange: z.object({
        start: z.string().optional(),
        end: z.string().optional(),
      }).optional(),
      visualAttributes: z.object({
        dominantColors: z.array(z.string()).optional(),
        brightness: z.enum(['dark', 'medium', 'bright']).optional(),
        saturation: z.enum(['low', 'medium', 'high']).optional(),
        composition: z.enum(['portrait', 'landscape', 'square']).optional(),
      }).optional(),
      minWidth: z.number().optional(),
      minHeight: z.number().optional(),
      maxFileSize: z.number().optional(),
    }).default({}),
    ranking: z.object({
      relevanceWeight: z.number().min(0).max(1).default(0.4),
      recencyWeight: z.number().min(0).max(1).default(0.2),
      qualityWeight: z.number().min(0).max(1).default(0.2),
      popularityWeight: z.number().min(0).max(1).default(0.2),
    }).default({}),
    limit: z.number().min(1).max(100).default(20),
    offset: z.number().min(0).default(0),
    includeAnalysis: z.boolean().default(false).describe('Include AI analysis of results'),
  }),
  outputSchema: z.object({
    assets: z.array(z.object({
      id: z.string(),
      name: z.string(),
      type: z.string(),
      url: z.string(),
      thumbnailUrl: z.string().optional(),
      width: z.number().optional(),
      height: z.number().optional(),
      size: z.number().optional(),
      mimeType: z.string().optional(),
      createdAt: z.string(),
      updatedAt: z.string(),
      relevanceScore: z.number(),
      matchDetails: z.object({
        semanticScore: z.number().optional(),
        visualScore: z.number().optional(),
        metadataScore: z.number().optional(),
        contentScore: z.number().optional(),
        matchType: z.array(z.string()),
        matchReasons: z.array(z.string()),
      }),
      metadata: z.record(z.unknown()).optional(),
      tags: z.array(z.string()).optional(),
      boards: z.array(z.object({
        id: z.string(),
        name: z.string(),
      })).optional(),
    })),
    totalCount: z.number(),
    searchMetadata: z.object({
      searchMethods: z.array(z.string()),
      executionTime: z.number(),
      indexesUsed: z.array(z.string()),
      filterStats: z.object({
        beforeFilters: z.number(),
        afterFilters: z.number(),
        filtersApplied: z.array(z.string()),
      }),
    }),
    suggestions: z.array(z.object({
      type: z.string(),
      query: z.string(),
      reason: z.string(),
    })).optional(),
    analysis: z.object({
      queryInterpretation: z.string(),
      resultPatterns: z.array(z.string()),
      recommendations: z.array(z.string()),
    }).optional(),
  }),
  execute: async ({ context }) => {
    const { query, userId, searchMethods, filters, ranking, limit, offset, includeAnalysis } = context;
    try {
      const startTime = Date.now();
      
      // Use ORPC client to search assets via API
      const searchResult = await aiServiceClient.searchAssets(query, filters.boardIds?.[0]);
      
      // Transform API response to match tool output schema
      const assets = searchResult.assets?.map((asset: any) => ({
        id: asset.id,
        name: asset.name,
        type: asset.type,
        url: asset.url,
        thumbnailUrl: asset.thumbnailUrl || asset.url,
        width: asset.width,
        height: asset.height,
        size: asset.size,
        mimeType: asset.mimeType,
        createdAt: asset.createdAt,
        updatedAt: asset.updatedAt,
        relevanceScore: asset.score || 0.5,
        matchDetails: {
          semanticScore: asset.semanticScore || 0,
          visualScore: asset.visualScore || 0,
          metadataScore: asset.metadataScore || 0,
          matchType: ['semantic'],
          matchReasons: [`Match for query: ${query}`],
        },
        metadata: asset.metadata || {},
        tags: asset.tags || [],
        boards: asset.boards || [],
      })) || [];

      // Apply additional filters if needed
      let results = assets;
      if (filters.assetTypes && filters.assetTypes.length > 0) {
        results = results.filter(asset => filters.assetTypes!.includes(asset.type as any));
      }

      const executionTime = Date.now() - startTime;
      const totalCount = results.length;
      const paginatedResults = results.slice(offset, offset + limit);

      const searchMetadata = {
        searchMethods: Object.entries(searchMethods)
          .filter(([, enabled]) => enabled)
          .map(([method]) => method),
        executionTime,
        indexesUsed: ['vector_embeddings', 'metadata_search', 'tag_index'],
        filterStats: {
          beforeFilters: filteredAssets.length,
          afterFilters: totalCount,
          filtersApplied: [
            ...(filters.assetTypes ? ['assetTypes'] : []),
            ...(filters.boardIds ? ['boardIds'] : []),
            ...(filters.tags ? ['tags'] : []),
          ],
        },
      };

      const suggestions = query.length < 3 ? [
        {
          type: 'query_expansion',
          query: 'urban photography street art',
          reason: 'Try adding more descriptive terms for better results',
        },
        {
          type: 'filter_suggestion',
          query: 'architecture modern buildings',
          reason: 'Consider filtering by image type for architectural content',
        },
      ] : undefined;

      const analysis = includeAnalysis ? {
        queryInterpretation: `Searching for visual content related to "${query}" with emphasis on ${searchMethods.visual ? 'visual similarity' : 'semantic meaning'}`,
        resultPatterns: [
          'Results show strong preference for urban photography themes',
          'High-quality images with detailed metadata perform better',
          'Recent assets tend to rank higher in search results',
        ],
        recommendations: [
          'Consider adding more descriptive tags to improve searchability',
          'Images with location metadata show better discoverability',
          'Try semantic search for conceptual queries, keyword search for specific terms',
        ],
      } : undefined;

      return {
        assets: paginatedResults,
        totalCount,
        searchMetadata,
        suggestions,
        analysis,
      };
    } catch (error) {
      throw new Error(`Failed to search assets: ${error}`);
    }
  },
});
````

## File: apps/ai/src/mastra/tools/board/analyze-board.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';
import { aiServiceClient } from '../../lib/orpc-client';

/**
 * Analyze board content and structure to provide insights and recommendations
 * Uses ORPC client to fetch board data from API layer
 */
export const analyzeBoardTool = createTool({
  id: 'analyze-board',
  description: 'Analyze board content, structure, and user engagement to provide insights and improvement recommendations',
  inputSchema: z.object({
    boardId: z.string().describe('ID of the board to analyze'),
    userId: z.string().describe('User ID requesting the analysis'),
    analysisDepth: z.enum(['basic', 'detailed', 'comprehensive']).default('detailed').describe('Depth of analysis to perform'),
    includeMetrics: z.boolean().default(true).describe('Include engagement and performance metrics'),
    includeRecommendations: z.boolean().default(true).describe('Include improvement recommendations'),
    timeframe: z.enum(['1d', '7d', '30d', '90d', 'all']).default('30d').describe('Timeframe for metrics analysis'),
  }),
  outputSchema: z.object({
    boardAnalysis: z.object({
      id: z.string(),
      name: z.string(),
      totalAssets: z.number(),
      assetDistribution: z.object({
        images: z.number(),
        videos: z.number(),
        audio: z.number(),
        documents: z.number(),
        other: z.number(),
      }),
      themes: z.array(z.object({
        name: z.string(),
        confidence: z.number(),
        assetCount: z.number(),
        description: z.string(),
      })),
      visualCharacteristics: z.object({
        dominantColors: z.array(z.string()),
        averageColorSaturation: z.number(),
        averageBrightness: z.number(),
        styleConsistency: z.number(),
        aestheticPersonality: z.array(z.string()),
      }),
      organizationalHealth: z.object({
        structureScore: z.number(),
        coherenceScore: z.number(),
        completenessScore: z.number(),
        overallScore: z.number(),
      }),
    }),
    metrics: z.object({
      views: z.number(),
      likes: z.number(),
      comments: z.number(),
      shares: z.number(),
      engagementRate: z.number(),
      averageTimeSpent: z.number(),
      uniqueViewers: z.number(),
      returningViewers: z.number(),
    }).optional(),
    insights: z.array(z.object({
      type: z.enum(['strength', 'opportunity', 'warning', 'trend']),
      title: z.string(),
      description: z.string(),
      impact: z.enum(['high', 'medium', 'low']),
      category: z.string(),
    })),
    recommendations: z.array(z.object({
      priority: z.enum(['high', 'medium', 'low']),
      category: z.string(),
      title: z.string(),
      description: z.string(),
      expectedImpact: z.string(),
      effort: z.enum(['low', 'medium', 'high']),
      actionSteps: z.array(z.string()),
    })).optional(),
    comparativeAnalysis: z.object({
      similarBoards: z.number(),
      performancePercentile: z.number(),
      benchmarkComparison: z.object({
        avgAssetsPerBoard: z.number(),
        avgEngagementRate: z.number(),
        avgViewsPerAsset: z.number(),
      }),
    }).optional(),
  }),
  execute: async ({ context }) => {
    const { boardId, userId, analysisDepth, includeMetrics, includeRecommendations, timeframe } = context;
    try {
      // Fetch board data from API
      const board = await aiServiceClient.getBoard(boardId, userId);
      const assets = await aiServiceClient.getBoardAssets(boardId);
      
      // Analyze asset distribution
      const assetDistribution = {
        images: 0,
        videos: 0,
        audio: 0,
        documents: 0,
        other: 0,
      };
      
      assets.forEach((asset: any) => {
        switch (asset.type) {
          case 'image':
          case 'gif':
            assetDistribution.images++;
            break;
          case 'video':
            assetDistribution.videos++;
            break;
          case 'audio':
            assetDistribution.audio++;
            break;
          case 'text':
            assetDistribution.documents++;
            break;
          default:
            assetDistribution.other++;
        }
      });

      const boardAnalysis = {
        id: board.id,
        name: board.name,
        totalAssets: 24,
        assetDistribution: {
          images: 20,
          videos: 3,
          audio: 0,
          documents: 1,
          other: 0,
        },
        themes: [
          {
            name: 'Urban Photography',
            confidence: 0.87,
            assetCount: 12,
            description: 'Street photography with urban landscapes and architectural elements',
          },
          {
            name: 'Portrait Photography',
            confidence: 0.73,
            assetCount: 8,
            description: 'Professional portraits with natural lighting and composition',
          },
          {
            name: 'Nature & Landscape',
            confidence: 0.62,
            assetCount: 4,
            description: 'Outdoor scenes with natural elements and wide compositions',
          },
        ],
        visualCharacteristics: {
          dominantColors: ['#2C3E50', '#E74C3C', '#F39C12', '#3498DB'],
          averageColorSaturation: 0.72,
          averageBrightness: 0.68,
          styleConsistency: 0.84,
          aestheticPersonality: ['modern', 'dramatic', 'professional', 'sophisticated'],
        },
        organizationalHealth: {
          structureScore: 0.78,
          coherenceScore: 0.85,
          completenessScore: 0.71,
          overallScore: 0.78,
        },
      };

      const metrics = includeMetrics ? {
        views: 1247,
        likes: 89,
        comments: 23,
        shares: 12,
        engagementRate: 0.096,
        averageTimeSpent: 145,
        uniqueViewers: 342,
        returningViewers: 67,
      } : undefined;

      const insights = [
        {
          type: 'strength' as const,
          title: 'Strong Visual Cohesion',
          description: 'Your board maintains excellent visual consistency with a unified color palette and style approach.',
          impact: 'high' as const,
          category: 'Visual Design',
        },
        {
          type: 'opportunity' as const,
          title: 'Theme Diversification',
          description: 'Consider adding more variety to your nature photography theme to increase visual interest.',
          impact: 'medium' as const,
          category: 'Content Strategy',
        },
        {
          type: 'trend' as const,
          title: 'Growing Urban Photography Interest',
          description: 'Your urban photography content is performing 23% above average engagement.',
          impact: 'medium' as const,
          category: 'Performance',
        },
        {
          type: 'warning' as const,
          title: 'Low Caption Engagement',
          description: 'Only 35% of your assets have descriptive captions, which limits discoverability.',
          impact: 'medium' as const,
          category: 'Content Optimization',
        },
      ];

      const recommendations = includeRecommendations ? [
        {
          priority: 'high' as const,
          category: 'Content Optimization',
          title: 'Add Descriptive Captions',
          description: 'Increase asset discoverability and engagement by adding thoughtful captions to all content.',
          expectedImpact: 'Could increase engagement by 15-25%',
          effort: 'low' as const,
          actionSteps: [
            'Review assets without captions',
            'Write 1-2 sentence descriptions focusing on mood and technique',
            'Include relevant keywords naturally',
            'Ask questions to encourage comments',
          ],
        },
        {
          priority: 'medium' as const,
          category: 'Visual Organization',
          title: 'Optimize Layout for Mobile',
          description: 'Reorganize your grid layout to better showcase vertical images on mobile devices.',
          expectedImpact: 'Improved mobile user experience and retention',
          effort: 'medium' as const,
          actionSteps: [
            'Analyze current mobile viewing patterns',
            'Experiment with masonry layout',
            'Test different aspect ratios',
            'Gather user feedback on mobile experience',
          ],
        },
        {
          priority: 'medium' as const,
          category: 'Content Strategy',
          title: 'Create Themed Sub-Collections',
          description: 'Group similar content into focused collections to improve navigation and discovery.',
          expectedImpact: 'Better content organization and user navigation',
          effort: 'medium' as const,
          actionSteps: [
            'Identify natural content groupings',
            'Create themed sections within the board',
            'Add section headers and descriptions',
            'Consider creating separate boards for major themes',
          ],
        },
        {
          priority: 'low' as const,
          category: 'Community Building',
          title: 'Increase Social Engagement',
          description: 'Encourage more community interaction through strategic posting and engagement.',
          expectedImpact: 'Higher visibility and community growth',
          effort: 'high' as const,
          actionSteps: [
            'Respond to all comments within 24 hours',
            'Ask specific questions in captions',
            'Share behind-the-scenes content',
            'Collaborate with other creators',
          ],
        },
      ] : undefined;

      const comparativeAnalysis = analysisDepth === 'comprehensive' ? {
        similarBoards: 156,
        performancePercentile: 73,
        benchmarkComparison: {
          avgAssetsPerBoard: 18.5,
          avgEngagementRate: 0.078,
          avgViewsPerAsset: 47.2,
        },
      } : undefined;

      return {
        boardAnalysis,
        metrics,
        insights,
        recommendations,
        comparativeAnalysis,
      };
    } catch (error) {
      throw new Error(`Failed to analyze board: ${error}`);
    }
  },
});
````

## File: apps/ai/src/mastra/tools/board/create-board.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';
import { aiServiceClient } from '../../lib/orpc-client';

/**
 * Create a new board with AI assistance for theme, organization, and setup
 * Uses ORPC client to communicate with API layer
 */
export const createBoardTool = createTool({
  id: 'create-board',
  description: 'Create a new board with AI-powered theme suggestions, organization templates, and smart defaults',
  inputSchema: z.object({
    name: z.string().min(1).max(100).describe('Name of the board'),
    description: z.string().optional().describe('Optional description of the board'),
    userId: z.string().describe('User ID creating the board'),
    theme: z.object({
      style: z.enum(['minimal', 'vibrant', 'professional', 'artistic', 'cozy', 'modern']).optional(),
      colors: z.array(z.string()).optional().describe('Hex color codes for theme'),
      mood: z.enum(['inspiring', 'calm', 'energetic', 'focused', 'playful', 'sophisticated']).optional(),
    }).optional().describe('Theme preferences for the board'),
    organizationTemplate: z.enum(['grid', 'masonry', 'timeline', 'categories', 'freeform']).optional().describe('Initial organization template'),
    visibility: z.enum(['public', 'private']).default('private').describe('Board visibility'),
    aiAssistance: z.object({
      generateIcon: z.boolean().default(true).describe('Let AI suggest an appropriate icon'),
      suggestTags: z.boolean().default(true).describe('Generate relevant tags based on name/description'),
      createTemplate: z.boolean().default(false).describe('Create a starter template with sample assets'),
    }).default({}),
    sources: z.array(z.string()).optional().describe('Source URLs or references that inspired this board'),
  }),
  outputSchema: z.object({
    success: z.boolean(),
    board: z.object({
      id: z.string(),
      name: z.string(),
      description: z.string().optional(),
      icon: z.string(),
      visibility: z.string(),
      theme: z.object({
        style: z.string(),
        colors: z.array(z.string()),
        mood: z.string(),
      }),
      tags: z.array(z.string()),
      organizationTemplate: z.string(),
      createdAt: z.string(),
    }).optional(),
    aiSuggestions: z.object({
      alternativeNames: z.array(z.string()),
      recommendedTags: z.array(z.string()),
      themeVariations: z.array(z.object({
        name: z.string(),
        description: z.string(),
        colors: z.array(z.string()),
      })),
      contentSuggestions: z.array(z.string()),
    }),
    message: z.string(),
  }),
  execute: async ({ context }) => {
    const { name, description, userId, theme, organizationTemplate, visibility, aiAssistance, sources } = context;
    try {
      // Generate AI suggestions based on board name and description
      const aiSuggestions = {
        alternativeNames: [
          `${name} Collection`,
          `${name} Inspiration`,
          `${name} Studio`,
        ],
        recommendedTags: generateSmartTags(name, description),
        themeVariations: generateThemeVariations(theme?.style || 'modern'),
        contentSuggestions: generateContentSuggestions(name, description),
      };

      // Select or generate appropriate icon
      const icon = aiAssistance.generateIcon ? 
        selectIconForBoard(name, description, theme?.mood) : 
        'üìå';

      // Generate theme if not provided
      const finalTheme = theme || generateDefaultTheme(name, description);

      // Create the board using ORPC client
      const createdBoard = await aiServiceClient.createBoard({
        name,
        description: description || `A curated collection focused on ${name.toLowerCase()}`,
        visibility,
        emoji: icon,
      });

      // Combine API response with AI enhancements
      const board = {
        id: createdBoard.id,
        name: createdBoard.name,
        description: createdBoard.description || description || `A curated collection focused on ${name.toLowerCase()}`,
        icon: createdBoard.icon || icon,
        visibility: createdBoard.visibility,
        theme: {
          style: finalTheme.style || 'modern',
          colors: finalTheme.colors || ['#4F46E5', '#06B6D4', '#10B981'],
          mood: finalTheme.mood || 'inspiring',
        },
        tags: aiAssistance.suggestTags ? aiSuggestions.recommendedTags : [],
        organizationTemplate: organizationTemplate || 'grid',
        createdAt: createdBoard.createdAt,
      };

      return {
        success: true,
        board,
        aiSuggestions,
        message: `Successfully created board "${name}" with AI-powered theme and organization suggestions`,
      };
    } catch (error) {
      return {
        success: false,
        aiSuggestions: {
          alternativeNames: [],
          recommendedTags: [],
          themeVariations: [],
          contentSuggestions: [],
        },
        message: `Failed to create board: ${error}`,
      };
    }
  },
});

// Helper functions for AI assistance
function generateSmartTags(name: string, description?: string): string[] {
  const content = `${name} ${description || ''}`.toLowerCase();
  const tagSuggestions: Record<string, string[]> = {
    'photo': ['photography', 'visual', 'captured', 'moments'],
    'design': ['creative', 'aesthetic', 'visual', 'artistic'],
    'art': ['creative', 'artistic', 'expression', 'visual'],
    'inspiration': ['inspiring', 'motivational', 'ideas', 'creative'],
    'travel': ['wanderlust', 'adventure', 'places', 'journey'],
    'nature': ['outdoors', 'natural', 'organic', 'peaceful'],
    'fashion': ['style', 'trendy', 'aesthetic', 'clothing'],
    'food': ['culinary', 'delicious', 'recipes', 'cooking'],
    'architecture': ['building', 'structure', 'design', 'space'],
    'lifestyle': ['living', 'daily', 'personal', 'routine'],
  };

  const tags = new Set<string>();
  
  for (const [keyword, relatedTags] of Object.entries(tagSuggestions)) {
    if (content.includes(keyword)) {
      relatedTags.forEach(tag => tags.add(tag));
    }
  }

  // Add base tags from the name
  const words = name.toLowerCase().split(/\s+/);
  words.forEach(word => {
    if (word.length > 3) tags.add(word);
  });

  return Array.from(tags).slice(0, 6);
}

function generateThemeVariations(style: string = 'modern') {
  const themes = {
    minimal: [
      { name: 'Clean Minimal', description: 'Pure white backgrounds with subtle shadows', colors: ['#FFFFFF', '#F8F9FA', '#E9ECEF'] },
      { name: 'Warm Minimal', description: 'Soft beiges and warm grays', colors: ['#FFF8F0', '#F5F1EB', '#E8E2D5'] },
      { name: 'Cool Minimal', description: 'Light blues and cool grays', colors: ['#F8FAFC', '#F1F5F9', '#E2E8F0'] },
    ],
    vibrant: [
      { name: 'Sunset Vibes', description: 'Warm oranges and pinks', colors: ['#FF6B6B', '#FF8E53', '#FF6B9D'] },
      { name: 'Ocean Energy', description: 'Deep blues and turquoise', colors: ['#4ECDC4', '#45B7D1', '#96CEB4'] },
      { name: 'Electric Pop', description: 'Bright neons and bold colors', colors: ['#FF0080', '#00FF80', '#8000FF'] },
    ],
    modern: [
      { name: 'Tech Forward', description: 'Clean gradients and modern colors', colors: ['#667EEA', '#764BA2', '#f093fb'] },
      { name: 'Corporate Modern', description: 'Professional blues and grays', colors: ['#4F46E5', '#06B6D4', '#6366F1'] },
      { name: 'Soft Modern', description: 'Muted pastels with modern feel', colors: ['#A8E6CF', '#FFD3A5', '#FD8A8A'] },
    ],
  };

  return themes[style as keyof typeof themes] || themes.modern;
}

function generateContentSuggestions(name: string, description?: string): string[] {
  const content = `${name} ${description || ''}`.toLowerCase();
  const suggestions = [];

  if (content.includes('photo') || content.includes('image')) {
    suggestions.push('Add high-quality photos that match your theme');
    suggestions.push('Consider organizing by color or composition');
    suggestions.push('Mix different photography styles for variety');
  }

  if (content.includes('design') || content.includes('creative')) {
    suggestions.push('Include design process sketches and wireframes');
    suggestions.push('Add color palette references');
    suggestions.push('Document design decisions and rationale');
  }

  if (content.includes('inspiration')) {
    suggestions.push('Collect diverse sources of inspiration');
    suggestions.push('Add notes about what inspires you in each piece');
    suggestions.push('Organize by mood or style direction');
  }

  // Default suggestions
  if (suggestions.length === 0) {
    suggestions.push('Start with 5-10 carefully curated pieces');
    suggestions.push('Add descriptive captions to provide context');
    suggestions.push('Consider grouping similar items together');
  }

  return suggestions.slice(0, 3);
}

function selectIconForBoard(name: string, description?: string, mood?: string): string {
  const content = `${name} ${description || ''}`.toLowerCase();
  
  // Mood-based icons
  const moodIcons = {
    inspiring: '‚ú®',
    calm: 'üåô',
    energetic: '‚ö°',
    focused: 'üéØ',
    playful: 'üé®',
    sophisticated: 'üíé',
  };

  if (mood && moodIcons[mood as keyof typeof moodIcons]) {
    return moodIcons[mood as keyof typeof moodIcons];
  }

  // Content-based icon selection
  const iconMap = {
    photo: 'üì∏', image: 'üñºÔ∏è', picture: 'üì∑',
    art: 'üé®', design: '‚úèÔ∏è', creative: 'üí°',
    music: 'üéµ', audio: 'üéß', sound: 'üîä',
    video: 'üé¨', film: 'üìπ', movie: 'üçø',
    travel: '‚úàÔ∏è', place: 'üó∫Ô∏è', journey: 'üß≠',
    food: 'üçΩÔ∏è', recipe: 'üë®‚Äçüç≥', cooking: 'üî•',
    nature: 'üåø', plant: 'üå±', outdoor: 'üèîÔ∏è',
    fashion: 'üëó', style: 'üíÑ', clothing: 'üëî',
    book: 'üìö', read: 'üìñ', story: 'üìù',
    tech: 'üíª', code: '‚öôÔ∏è', digital: 'üì±',
  };

  for (const [keyword, icon] of Object.entries(iconMap)) {
    if (content.includes(keyword)) {
      return icon;
    }
  }

  return 'üìå'; // Default fallback
}
````

## File: apps/ai/src/mastra/tools/board/index.ts
````typescript
// Board Management Tools
// These tools provide AI-powered assistance for board creation, analysis, and organization

export { searchBoardsTool } from './search-boards';
export { createBoardTool } from './create-board';
export { analyzeBoardTool } from './analyze-board';
export { suggestBoardOrganizationTool } from './suggest-organization';

// Re-export types and utilities if needed
export type BoardSearchFilters = {
  visibility?: 'public' | 'private' | 'all';
  createdAfter?: string;
  createdBefore?: string;
  tags?: string[];
  hasAssets?: boolean;
};

export type BoardAnalysisDepth = 'basic' | 'detailed' | 'comprehensive';
export type OrganizationGoal = 'discoverability' | 'visual_appeal' | 'navigation' | 'storytelling' | 'categorization' | 'chronological' | 'thematic' | 'engagement';
export type LayoutType = 'grid' | 'masonry' | 'timeline' | 'categories' | 'freeform';
````

## File: apps/ai/src/mastra/tools/board/search-boards.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Search boards by name, tags, or metadata using semantic and keyword search
 * Uses ORPC client to communicate with API layer
 */
export const searchBoardsTool = createTool({
  id: 'search-boards',
  description: 'Search boards by name, description, tags, or semantic meaning using vector embeddings',
  inputSchema: z.object({
    query: z.string().describe('Search query for boards'),
    userId: z.string().describe('User ID to search boards for'),
    filters: z.object({
      visibility: z.enum(['public', 'private', 'all']).default('all').describe('Board visibility filter'),
      createdAfter: z.string().optional().describe('ISO date string to filter boards created after'),
      createdBefore: z.string().optional().describe('ISO date string to filter boards created before'),
      tags: z.array(z.string()).optional().describe('Tags to filter by'),
      hasAssets: z.boolean().optional().describe('Filter boards that have assets'),
    }).default({}),
    searchType: z.enum(['semantic', 'keyword', 'hybrid']).default('hybrid').describe('Type of search to perform'),
    limit: z.number().min(1).max(50).default(20).describe('Maximum number of results to return'),
    offset: z.number().min(0).default(0).describe('Number of results to skip for pagination'),
  }),
  outputSchema: z.object({
    boards: z.array(z.object({
      id: z.string(),
      name: z.string(),
      description: z.string().optional(),
      visibility: z.string(),
      icon: z.string(),
      assetCount: z.number(),
      creatorId: z.string(),
      createdAt: z.string(),
      updatedAt: z.string(),
      relevanceScore: z.number().optional(),
      matchReason: z.string().optional(),
    })),
    totalCount: z.number(),
    searchMetadata: z.object({
      searchType: z.string(),
      semanticResults: z.number(),
      keywordResults: z.number(),
      executionTime: z.number(),
    }),
  }),
  execute: async ({ context }) => {
    const { query, userId, filters, searchType, limit, offset } = context;
    try {
      const startTime = Date.now();
      
      // Use ORPC client to search boards via API
      const searchResult = await aiServiceClient.enhancedSearch({
        query,
        type: 'board',
        filters: {
          boardVisibility: filters.visibility !== 'all' ? [filters.visibility] : undefined,
        },
        limit,
      });

      // Transform API response to match tool output schema
      const boards = searchResult.boards?.map((board: any) => ({
        id: board.id,
        name: board.name,
        description: board.description || '',
        visibility: board.visibility,
        icon: board.icon || 'üìã',
        assetCount: board.assetCount || 0,
        creatorId: board.ownerId || userId,
        createdAt: board.createdAt,
        updatedAt: board.updatedAt,
        relevanceScore: board.score || 0,
        matchReason: board.matchReason || `Match for query: ${query}`,
      })) || [];

      const executionTime = Date.now() - startTime;
      
      return {
        boards: boards.slice(offset, offset + limit),
        totalCount: boards.length,
        searchMetadata: {
          searchType,
          semanticResults: searchType === 'keyword' ? 0 : boards.length,
          keywordResults: searchType === 'semantic' ? 0 : boards.length,
          executionTime,
        },
      };
    } catch (error) {
      throw new Error(`Failed to search boards: ${error}`);
    }
  },
});
````

## File: apps/ai/src/mastra/tools/board/suggest-organization.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Suggest optimal organization and layout for board content
 */
export const suggestBoardOrganizationTool = createTool({
  id: 'suggest-board-organization',
  description: 'Analyze board content and suggest optimal organization strategies, layouts, and structural improvements',
  inputSchema: z.object({
    boardId: z.string().describe('ID of the board to analyze'),
    userId: z.string().describe('User ID requesting organization suggestions'),
    currentLayout: z.enum(['grid', 'masonry', 'timeline', 'categories', 'freeform']).optional().describe('Current board layout'),
    organizationGoals: z.array(z.enum([
      'discoverability', 
      'visual_appeal', 
      'navigation', 
      'storytelling', 
      'categorization',
      'chronological',
      'thematic',
      'engagement'
    ])).default(['visual_appeal', 'navigation']).describe('Primary organization objectives'),
    contentAnalysis: z.object({
      assetTypes: z.record(z.number()).optional(),
      themes: z.array(z.string()).optional(),
      colors: z.array(z.string()).optional(),
      timeframe: z.string().optional(),
    }).optional().describe('Optional pre-analyzed content characteristics'),
    constraints: z.object({
      maxSections: z.number().optional(),
      preserveExisting: z.boolean().default(false),
      mobileFriendly: z.boolean().default(true),
      accessibilityFocused: z.boolean().default(true),
    }).default({}),
  }),
  outputSchema: z.object({
    currentAnalysis: z.object({
      strengths: z.array(z.string()),
      weaknesses: z.array(z.string()),
      organizationScore: z.number(),
      userFlowRating: z.number(),
    }),
    recommendations: z.array(z.object({
      strategy: z.string(),
      title: z.string(),
      description: z.string(),
      layoutType: z.string(),
      sections: z.array(z.object({
        name: z.string(),
        description: z.string(),
        assetCount: z.number(),
        arrangement: z.string(),
        priority: z.number(),
      })),
      benefits: z.array(z.string()),
      implementation: z.object({
        difficulty: z.enum(['easy', 'medium', 'complex']),
        estimatedTime: z.string(),
        steps: z.array(z.string()),
        considerations: z.array(z.string()),
      }),
      score: z.number(),
    })),
    quickWins: z.array(z.object({
      title: z.string(),
      description: z.string(),
      impact: z.enum(['high', 'medium', 'low']),
      effort: z.enum(['low', 'medium', 'high']),
      steps: z.array(z.string()),
    })),
    layoutComparison: z.object({
      recommended: z.string(),
      alternatives: z.array(z.object({
        layout: z.string(),
        pros: z.array(z.string()),
        cons: z.array(z.string()),
        bestFor: z.array(z.string()),
        score: z.number(),
      })),
    }),
  }),
  execute: async ({ context }) => {
    const { boardId, userId, currentLayout, organizationGoals, contentAnalysis, constraints } = context;
    try {
      // Analyze current organization state
      const currentAnalysis = {
        strengths: [
          'Visual consistency across assets',
          'Clear color palette theme',
          'Good use of whitespace',
        ],
        weaknesses: [
          'No clear content grouping',
          'Some visual hierarchy issues',
          'Limited navigation aids',
        ],
        organizationScore: 0.72,
        userFlowRating: 0.68,
      };

      // Generate organization recommendations based on goals and content
      const recommendations = generateOrganizationStrategies(organizationGoals, contentAnalysis, constraints);

      // Quick improvement suggestions
      const quickWins = [
        {
          title: 'Add Section Headers',
          description: 'Create visual breaks between content themes with descriptive headers',
          impact: 'medium' as const,
          effort: 'low' as const,
          steps: [
            'Identify 3-5 natural content groupings',
            'Create descriptive section titles',
            'Add visual separators between sections',
            'Include brief section descriptions',
          ],
        },
        {
          title: 'Optimize Asset Ordering',
          description: 'Rearrange assets to create better visual flow and narrative',
          impact: 'high' as const,
          effort: 'medium' as const,
          steps: [
            'Review current asset sequence',
            'Group similar content types',
            'Create visual rhythm with varied sizes',
            'End sections with strongest pieces',
          ],
        },
        {
          title: 'Improve Mobile Experience',
          description: 'Adjust layout to work better on mobile devices',
          impact: 'high' as const,
          effort: 'low' as const,
          steps: [
            'Test current layout on mobile',
            'Adjust grid spacing for smaller screens',
            'Optimize image aspect ratios',
            'Ensure touch targets are adequate',
          ],
        },
      ];

      // Compare different layout approaches
      const layoutComparison = {
        recommended: 'masonry',
        alternatives: [
          {
            layout: 'grid',
            pros: ['Clean and organized', 'Predictable layout', 'Easy to implement'],
            cons: ['Can be rigid', 'May waste space', 'Less dynamic'],
            bestFor: ['uniform content', 'professional presentations', 'minimal aesthetics'],
            score: 0.75,
          },
          {
            layout: 'masonry',
            pros: ['Efficient space use', 'Dynamic and interesting', 'Handles varied content well'],
            cons: ['Can be chaotic', 'Harder to scan', 'Complex implementation'],
            bestFor: ['mixed content types', 'visual portfolios', 'creative presentations'],
            score: 0.88,
          },
          {
            layout: 'timeline',
            pros: ['Clear narrative flow', 'Good for stories', 'Easy to follow'],
            cons: ['Limited visual impact', 'Can be monotonous', 'Not great for browsing'],
            bestFor: ['chronological content', 'project documentation', 'progress tracking'],
            score: 0.65,
          },
          {
            layout: 'categories',
            pros: ['Excellent organization', 'Easy navigation', 'Clear structure'],
            cons: ['Can be overwhelming', 'Requires maintenance', 'Less visual flow'],
            bestFor: ['large collections', 'diverse content', 'reference materials'],
            score: 0.82,
          },
        ],
      };

      return {
        currentAnalysis,
        recommendations,
        quickWins,
        layoutComparison,
      };
    } catch (error) {
      throw new Error(`Failed to generate organization suggestions: ${error}`);
    }
  },
});

// Helper function to generate organization strategies
function generateOrganizationStrategies(
  goals: string[],
  contentAnalysis?: any,
  constraints: any = {}
) {
  const strategies = [];

  // Theme-based organization
  if (goals.includes('thematic') || goals.includes('categorization')) {
    strategies.push({
      strategy: 'thematic-sections',
      title: 'Organize by Content Themes',
      description: 'Group assets into thematic sections based on visual style, subject matter, or conceptual similarity',
      layoutType: 'categories',
      sections: [
        {
          name: 'Urban Photography',
          description: 'Street scenes and architectural photography',
          assetCount: 12,
          arrangement: 'masonry',
          priority: 1,
        },
        {
          name: 'Portrait Work',
          description: 'Professional and candid portrait photography',
          assetCount: 8,
          arrangement: 'grid',
          priority: 2,
        },
        {
          name: 'Nature & Landscapes',
          description: 'Outdoor and natural environment photography',
          assetCount: 4,
          arrangement: 'masonry',
          priority: 3,
        },
      ],
      benefits: [
        'Improved content discoverability',
        'Clear navigation structure',
        'Better user understanding',
        'Easier maintenance',
      ],
      implementation: {
        difficulty: 'medium' as const,
        estimatedTime: '2-3 hours',
        steps: [
          'Analyze and categorize existing content',
          'Create section headers and descriptions',
          'Reorganize assets into themed groups',
          'Add navigation between sections',
          'Test user flow and adjust',
        ],
        considerations: [
          'Some assets may fit multiple themes',
          'Requires ongoing maintenance',
          'May need user education',
        ],
      },
      score: 0.89,
    });
  }

  // Visual flow optimization
  if (goals.includes('visual_appeal') || goals.includes('engagement')) {
    strategies.push({
      strategy: 'visual-flow',
      title: 'Optimize Visual Rhythm and Flow',
      description: 'Arrange content to create engaging visual patterns that guide the eye naturally through the board',
      layoutType: 'masonry',
      sections: [
        {
          name: 'Hero Section',
          description: 'Most impactful pieces to capture attention',
          assetCount: 3,
          arrangement: 'featured-grid',
          priority: 1,
        },
        {
          name: 'Main Collection',
          description: 'Core content arranged in visual harmony',
          assetCount: 18,
          arrangement: 'masonry-flow',
          priority: 2,
        },
        {
          name: 'Supporting Elements',
          description: 'Complementary pieces to round out the story',
          assetCount: 3,
          arrangement: 'compact-grid',
          priority: 3,
        },
      ],
      benefits: [
        'Increased visual engagement',
        'Better first impression',
        'Natural content discovery',
        'Improved time on board',
      ],
      implementation: {
        difficulty: 'medium' as const,
        estimatedTime: '1-2 hours',
        steps: [
          'Identify strongest visual pieces',
          'Create visual hierarchy with size variations',
          'Balance colors and composition across sections',
          'Test on different screen sizes',
          'Iterate based on engagement metrics',
        ],
        considerations: [
          'Requires design sensibility',
          'May need regular adjustment',
          'Should align with brand aesthetic',
        ],
      },
      score: 0.85,
    });
  }

  // Storytelling organization
  if (goals.includes('storytelling') || goals.includes('chronological')) {
    strategies.push({
      strategy: 'narrative-flow',
      title: 'Create a Storytelling Journey',
      description: 'Organize content to tell a compelling story or document a process from beginning to end',
      layoutType: 'timeline',
      sections: [
        {
          name: 'Introduction',
          description: 'Set the context and grab attention',
          assetCount: 2,
          arrangement: 'hero-layout',
          priority: 1,
        },
        {
          name: 'Development',
          description: 'Build the narrative with supporting content',
          assetCount: 16,
          arrangement: 'story-flow',
          priority: 2,
        },
        {
          name: 'Conclusion',
          description: 'Strong finish that reinforces the message',
          assetCount: 6,
          arrangement: 'summary-grid',
          priority: 3,
        },
      ],
      benefits: [
        'Clear narrative arc',
        'Emotional engagement',
        'Memorable experience',
        'Natural progression',
      ],
      implementation: {
        difficulty: 'complex' as const,
        estimatedTime: '3-4 hours',
        steps: [
          'Define the story or journey to tell',
          'Sequence content to support narrative',
          'Add transitional elements between sections',
          'Include contextual descriptions',
          'Test story comprehension with users',
        ],
        considerations: [
          'Requires strong editorial vision',
          'May not suit all content types',
          'Needs regular story maintenance',
        ],
      },
      score: 0.78,
    });
  }

  return strategies.length > 0 ? strategies : [
    {
      strategy: 'balanced-approach',
      title: 'Balanced Visual Organization',
      description: 'A versatile approach that combines good visual flow with practical organization',
      layoutType: 'masonry',
      sections: [
        {
          name: 'Featured',
          description: 'Highlighted content for maximum impact',
          assetCount: 6,
          arrangement: 'featured',
          priority: 1,
        },
        {
          name: 'Main Collection',
          description: 'Primary content organized visually',
          assetCount: 18,
          arrangement: 'masonry',
          priority: 2,
        },
      ],
      benefits: [
        'Good visual appeal',
        'Easy to maintain',
        'Works for most content',
        'Flexible structure',
      ],
      implementation: {
        difficulty: 'easy' as const,
        estimatedTime: '1 hour',
        steps: [
          'Select featured content',
          'Arrange remaining items visually',
          'Adjust spacing and sizing',
          'Test across devices',
        ],
        considerations: [
          'May need periodic refreshing',
          'Should maintain visual balance',
        ],
      },
      score: 0.75,
    },
  ];
}
````

## File: apps/ai/src/mastra/tools/collaboration/detect-duplicates.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Detect duplicate and similar content across boards and assets
 */
export const detectDuplicatesTool = createTool({
  id: 'detect-duplicates',
  description: 'Find duplicate, near-duplicate, and highly similar content across boards using visual similarity, metadata analysis, and content fingerprinting',
  inputSchema: z.object({
    scope: z.object({
      boardIds: z.array(z.string()).optional().describe('Specific boards to analyze (if not provided, analyzes all user boards)'),
      userId: z.string().describe('User ID to analyze content for'),
      includePublicBoards: z.boolean().default(false).describe('Include public boards in duplicate detection'),
      crossUserDetection: z.boolean().default(false).describe('Detect duplicates across different users (requires permissions)'),
    }),
    detectionMethods: z.object({
      exactDuplicates: z.boolean().default(true).describe('Find identical files (same hash/checksum)'),
      visualSimilarity: z.boolean().default(true).describe('Find visually similar images using perceptual hashing'),
      metadataSimilarity: z.boolean().default(true).describe('Find assets with identical or very similar metadata'),
      contentSimilarity: z.boolean().default(false).describe('Find similar text content within documents/images (OCR)'),
      semanticSimilarity: z.boolean().default(false).describe('Find semantically similar content using AI analysis'),
    }).default({}),
    similarityThresholds: z.object({
      visualSimilarity: z.number().min(0).max(1).default(0.95).describe('Visual similarity threshold (0-1, higher = more similar)'),
      metadataMatch: z.number().min(0).max(1).default(0.8).describe('Metadata similarity threshold'),
      semanticSimilarity: z.number().min(0).max(1).default(0.85).describe('Semantic similarity threshold'),
      filenameSimilarity: z.number().min(0).max(1).default(0.7).describe('Filename similarity threshold'),
    }).default({}),
    analysisOptions: z.object({
      groupSimilarAssets: z.boolean().default(true).describe('Group similar assets into clusters'),
      identifyVersions: z.boolean().default(true).describe('Identify different versions of the same asset'),
      suggestActions: z.boolean().default(true).describe('Suggest actions for found duplicates'),
      preserveOriginals: z.boolean().default(true).describe('Always preserve the original/oldest version'),
      analyzeQuality: z.boolean().default(true).describe('Analyze and compare quality between duplicates'),
    }).default({}),
    filterOptions: z.object({
      minFileSize: z.number().optional().describe('Minimum file size to consider (bytes)'),
      maxFileSize: z.number().optional().describe('Maximum file size to consider (bytes)'),
      assetTypes: z.array(z.enum(['image', 'video', 'audio', 'document', 'gif'])).optional().describe('Limit to specific asset types'),
      excludeBoards: z.array(z.string()).default([]).describe('Board IDs to exclude from analysis'),
      dateRange: z.object({
        start: z.string().optional(),
        end: z.string().optional(),
      }).optional().describe('Only analyze assets within this date range'),
    }).default({}),
  }),
  outputSchema: z.object({
    duplicateGroups: z.array(z.object({
      groupId: z.string(),
      groupType: z.enum(['exact_duplicate', 'visual_similar', 'metadata_similar', 'content_similar', 'semantic_similar']),
      confidence: z.number(),
      assets: z.array(z.object({
        id: z.string(),
        name: z.string(),
        url: z.string(),
        thumbnailUrl: z.string().optional(),
        boardId: z.string(),
        boardName: z.string(),
        createdAt: z.string(),
        fileSize: z.number().optional(),
        dimensions: z.object({
          width: z.number(),
          height: z.number(),
        }).optional(),
        qualityScore: z.number().optional(),
        isOriginal: z.boolean(),
        metadata: z.record(z.unknown()).optional(),
      })),
      similarityScores: z.array(z.object({
        assetId1: z.string(),
        assetId2: z.string(),
        visualSimilarity: z.number().optional(),
        metadataSimilarity: z.number().optional(),
        contentSimilarity: z.number().optional(),
        overallSimilarity: z.number(),
      })),
      detectionReason: z.string(),
      suggestedActions: z.array(z.object({
        action: z.enum(['delete', 'merge', 'keep_both', 'review', 'replace']),
        target: z.string(),
        reasoning: z.string(),
        impact: z.enum(['safe', 'caution', 'risky']),
      })),
    })),
    statistics: z.object({
      totalAssetsAnalyzed: z.number(),
      totalDuplicatesFound: z.number(),
      exactDuplicates: z.number(),
      nearDuplicates: z.number(),
      potentialSpaceSavings: z.object({
        bytes: z.number(),
        humanReadable: z.string(),
      }),
      boardsAffected: z.number(),
      duplicatesByType: z.record(z.number()),
    }),
    recommendations: z.object({
      cleanupPriority: z.array(z.object({
        groupId: z.string(),
        priority: z.enum(['high', 'medium', 'low']),
        reason: z.string(),
        potentialSavings: z.string(),
      })),
      preventionSuggestions: z.array(z.object({
        type: z.string(),
        suggestion: z.string(),
        implementation: z.string(),
      })),
      organizationImprovements: z.array(z.string()),
    }),
    executionMetadata: z.object({
      analysisTime: z.number(),
      algorithmsUsed: z.array(z.string()),
      accuracy: z.object({
        expectedPrecision: z.number(),
        expectedRecall: z.number(),
        falsePositiveRate: z.number(),
      }),
      processingDetails: z.object({
        boardsAnalyzed: z.number(),
        comparisonsPerformed: z.number(),
        indexingTime: z.number(),
        matchingTime: z.number(),
      }),
    }),
  }),
  execute: async ({ context }) => {
    const { scope, detectionMethods, similarityThresholds, analysisOptions, filterOptions } = context;
    try {
      const startTime = Date.now();
      
      // Mock duplicate detection - in production this would:
      // 1. Load and index all assets within scope
      // 2. Generate perceptual hashes for visual similarity
      // 3. Extract and compare metadata
      // 4. Perform content analysis using OCR/AI
      // 5. Group similar assets and calculate similarity scores
      // 6. Suggest cleanup actions based on quality and usage

      const duplicateGroups = generateMockDuplicateGroups(detectionMethods, analysisOptions);
      
      // Calculate statistics
      const totalAssets = duplicateGroups.reduce((sum, group) => sum + group.assets.length, 0);
      const exactDuplicates = duplicateGroups.filter(g => g.groupType === 'exact_duplicate').length;
      const nearDuplicates = duplicateGroups.length - exactDuplicates;
      
      const statistics = {
        totalAssetsAnalyzed: 1247, // Mock total
        totalDuplicatesFound: totalAssets,
        exactDuplicates,
        nearDuplicates,
        potentialSpaceSavings: {
          bytes: 45672890, // ~45MB
          humanReadable: '45.7 MB',
        },
        boardsAffected: new Set(duplicateGroups.flatMap(g => g.assets.map(a => a.boardId))).size,
        duplicatesByType: {
          image: duplicateGroups.filter(g => g.groupType.includes('visual')).length,
          video: Math.floor(duplicateGroups.length * 0.2),
          document: Math.floor(duplicateGroups.length * 0.1),
          audio: Math.floor(duplicateGroups.length * 0.05),
        },
      };

      const recommendations = {
        cleanupPriority: duplicateGroups.map((group, index) => ({
          groupId: group.groupId,
          priority: index < 2 ? 'high' as const : index < 5 ? 'medium' as const : 'low' as const,
          reason: group.groupType === 'exact_duplicate' 
            ? 'Exact duplicates can be safely removed'
            : 'Similar assets may need manual review',
          potentialSavings: `${Math.floor(Math.random() * 10 + 2)} MB`,
        })),
        preventionSuggestions: [
          {
            type: 'automated_detection',
            suggestion: 'Enable automatic duplicate detection on upload',
            implementation: 'Configure upload process to check for existing similar assets',
          },
          {
            type: 'naming_conventions',
            suggestion: 'Use consistent file naming conventions',
            implementation: 'Establish naming patterns that include date, version, and purpose',
          },
          {
            type: 'version_control',
            suggestion: 'Implement version tracking for asset iterations',
            implementation: 'Use versioning system to manage multiple versions of same asset',
          },
        ],
        organizationImprovements: [
          'Create separate boards for different asset versions',
          'Use tags to mark assets as drafts, finals, or variations',
          'Establish clear workflows for asset approval and archiving',
        ],
      };

      const executionMetadata = {
        analysisTime: Date.now() - startTime,
        algorithmsUsed: [
          ...(detectionMethods.exactDuplicates ? ['md5_hashing', 'file_comparison'] : []),
          ...(detectionMethods.visualSimilarity ? ['perceptual_hashing', 'visual_fingerprinting'] : []),
          ...(detectionMethods.metadataSimilarity ? ['metadata_comparison', 'fuzzy_matching'] : []),
          ...(detectionMethods.semanticSimilarity ? ['semantic_embeddings', 'content_analysis'] : []),
        ],
        accuracy: {
          expectedPrecision: 0.94,
          expectedRecall: 0.89,
          falsePositiveRate: 0.06,
        },
        processingDetails: {
          boardsAnalyzed: scope.boardIds?.length || 12,
          comparisonsPerformed: Math.floor(statistics.totalAssetsAnalyzed * (statistics.totalAssetsAnalyzed - 1) / 2),
          indexingTime: Math.floor((Date.now() - startTime) * 0.3),
          matchingTime: Math.floor((Date.now() - startTime) * 0.7),
        },
      };

      return {
        duplicateGroups,
        statistics,
        recommendations,
        executionMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to detect duplicates: ${error}`);
    }
  },
});

// Helper function to generate mock duplicate groups
function generateMockDuplicateGroups(detectionMethods: any, analysisOptions: any) {
  const groups = [];
  
  // Generate exact duplicates group
  if (detectionMethods.exactDuplicates) {
    groups.push({
      groupId: 'dup-group-1',
      groupType: 'exact_duplicate' as const,
      confidence: 1.0,
      assets: [
        {
          id: 'asset-dup-1a',
          name: 'street-scene.jpg',
          url: 'https://example.com/assets/street-scene.jpg',
          thumbnailUrl: 'https://example.com/thumbs/street-scene.jpg',
          boardId: 'board-1',
          boardName: 'Urban Photography',
          createdAt: new Date(Date.now() - 86400000).toISOString(),
          fileSize: 2145678,
          dimensions: { width: 1920, height: 1080 },
          qualityScore: analysisOptions.analyzeQuality ? 8.5 : undefined,
          isOriginal: true,
        },
        {
          id: 'asset-dup-1b',
          name: 'street-scene (1).jpg',
          url: 'https://example.com/assets/street-scene-copy.jpg',
          thumbnailUrl: 'https://example.com/thumbs/street-scene-copy.jpg',
          boardId: 'board-3',
          boardName: 'Architecture Collection',
          createdAt: new Date(Date.now() - 43200000).toISOString(),
          fileSize: 2145678, // Same file size
          dimensions: { width: 1920, height: 1080 },
          qualityScore: analysisOptions.analyzeQuality ? 8.5 : undefined,
          isOriginal: false,
        },
      ],
      similarityScores: [
        {
          assetId1: 'asset-dup-1a',
          assetId2: 'asset-dup-1b',
          visualSimilarity: 1.0,
          metadataSimilarity: 0.95,
          overallSimilarity: 1.0,
        },
      ],
      detectionReason: 'Identical file hash and metadata',
      suggestedActions: [
        {
          action: 'delete' as const,
          target: 'asset-dup-1b',
          reasoning: 'Duplicate copy can be safely removed, original exists in primary board',
          impact: 'safe' as const,
        },
      ],
    });
  }

  // Generate visual similarity group
  if (detectionMethods.visualSimilarity) {
    groups.push({
      groupId: 'dup-group-2',
      groupType: 'visual_similar' as const,
      confidence: 0.92,
      assets: [
        {
          id: 'asset-sim-2a',
          name: 'city-lights-original.jpg',
          url: 'https://example.com/assets/city-lights-original.jpg',
          thumbnailUrl: 'https://example.com/thumbs/city-lights-original.jpg',
          boardId: 'board-2',
          boardName: 'Night Photography',
          createdAt: new Date(Date.now() - 172800000).toISOString(),
          fileSize: 3421567,
          dimensions: { width: 2560, height: 1440 },
          qualityScore: analysisOptions.analyzeQuality ? 9.2 : undefined,
          isOriginal: true,
        },
        {
          id: 'asset-sim-2b',
          name: 'city-lights-edited.jpg',
          url: 'https://example.com/assets/city-lights-edited.jpg',
          thumbnailUrl: 'https://example.com/thumbs/city-lights-edited.jpg',
          boardId: 'board-2',
          boardName: 'Night Photography',
          createdAt: new Date(Date.now() - 86400000).toISOString(),
          fileSize: 2987432,
          dimensions: { width: 2560, height: 1440 },
          qualityScore: analysisOptions.analyzeQuality ? 8.8 : undefined,
          isOriginal: false,
        },
        {
          id: 'asset-sim-2c',
          name: 'city-lights-bw.jpg',
          url: 'https://example.com/assets/city-lights-bw.jpg',
          thumbnailUrl: 'https://example.com/thumbs/city-lights-bw.jpg',
          boardId: 'board-4',
          boardName: 'Black & White Collection',
          createdAt: new Date(Date.now() - 43200000).toISOString(),
          fileSize: 2156789,
          dimensions: { width: 2560, height: 1440 },
          qualityScore: analysisOptions.analyzeQuality ? 8.1 : undefined,
          isOriginal: false,
        },
      ],
      similarityScores: [
        {
          assetId1: 'asset-sim-2a',
          assetId2: 'asset-sim-2b',
          visualSimilarity: 0.94,
          metadataSimilarity: 0.89,
          overallSimilarity: 0.92,
        },
        {
          assetId1: 'asset-sim-2a',
          assetId2: 'asset-sim-2c',
          visualSimilarity: 0.88,
          metadataSimilarity: 0.85,
          overallSimilarity: 0.87,
        },
        {
          assetId1: 'asset-sim-2b',
          assetId2: 'asset-sim-2c',
          visualSimilarity: 0.82,
          metadataSimilarity: 0.83,
          overallSimilarity: 0.82,
        },
      ],
      detectionReason: 'High visual similarity indicates different versions of same photo',
      suggestedActions: [
        {
          action: 'keep_both' as const,
          target: 'asset-sim-2a',
          reasoning: 'Original version has highest quality, keep as primary',
          impact: 'safe' as const,
        },
        {
          action: 'review' as const,
          target: 'asset-sim-2b,asset-sim-2c',
          reasoning: 'Consider consolidating edited versions or clearly marking as variations',
          impact: 'caution' as const,
        },
      ],
    });
  }

  // Generate metadata similarity group
  if (detectionMethods.metadataSimilarity) {
    groups.push({
      groupId: 'dup-group-3',
      groupType: 'metadata_similar' as const,
      confidence: 0.78,
      assets: [
        {
          id: 'asset-meta-3a',
          name: 'DSC_0245.jpg',
          url: 'https://example.com/assets/DSC_0245.jpg',
          boardId: 'board-1',
          boardName: 'Urban Photography',
          createdAt: '2024-01-15T10:30:00Z',
          fileSize: 1876543,
          dimensions: { width: 1600, height: 2400 },
          isOriginal: true,
          metadata: {
            camera: 'Nikon D850',
            lens: '24-70mm f/2.8',
            iso: 400,
            aperture: 'f/4.0',
            shutterSpeed: '1/125',
            location: { lat: 40.7589, lng: -73.9851 },
          },
        },
        {
          id: 'asset-meta-3b',
          name: 'DSC_0246.jpg',
          url: 'https://example.com/assets/DSC_0246.jpg',
          boardId: 'board-1',
          boardName: 'Urban Photography',
          createdAt: '2024-01-15T10:30:02Z', // 2 seconds later
          fileSize: 1923456,
          dimensions: { width: 1600, height: 2400 },
          isOriginal: false,
          metadata: {
            camera: 'Nikon D850',
            lens: '24-70mm f/2.8',
            iso: 400,
            aperture: 'f/4.0',
            shutterSpeed: '1/125',
            location: { lat: 40.7589, lng: -73.9851 }, // Same location
          },
        },
      ],
      similarityScores: [
        {
          assetId1: 'asset-meta-3a',
          assetId2: 'asset-meta-3b',
          visualSimilarity: 0.72,
          metadataSimilarity: 0.96,
          overallSimilarity: 0.78,
        },
      ],
      detectionReason: 'Identical camera settings and location, sequential capture times',
      suggestedActions: [
        {
          action: 'review' as const,
          target: 'asset-meta-3a,asset-meta-3b',
          reasoning: 'Likely sequential shots from same session - evaluate which is better composed',
          impact: 'caution' as const,
        },
      ],
    });
  }

  return groups;
}
````

## File: apps/ai/src/mastra/tools/collaboration/generate-board-summary.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Generate AI-powered summaries of board content for collaboration and sharing
 */
export const generateBoardSummaryTool = createTool({
  id: 'generate-board-summary',
  description: 'Create comprehensive, AI-generated summaries of board content including themes, insights, and collaboration opportunities',
  inputSchema: z.object({
    boardId: z.string().describe('ID of the board to summarize'),
    userId: z.string().describe('User ID requesting the summary'),
    summaryType: z.enum(['overview', 'detailed', 'collaborative', 'presentation', 'archive']).default('overview').describe('Type of summary to generate'),
    includeElements: z.object({
      themeAnalysis: z.boolean().default(true).describe('Include analysis of visual and conceptual themes'),
      assetBreakdown: z.boolean().default(true).describe('Include statistics about asset types and counts'),
      styleInsights: z.boolean().default(true).describe('Include insights about artistic and aesthetic style'),
      collaboratorNotes: z.boolean().default(false).describe('Include notes from collaborators and comments'),
      progressTracking: z.boolean().default(false).describe('Include project progress and milestones'),
      recommendations: z.boolean().default(true).describe('Include AI recommendations for improvement'),
    }).default({}),
    audience: z.enum(['creator', 'collaborator', 'public', 'client', 'archive']).default('creator').describe('Target audience for the summary'),
    format: z.object({
      length: z.enum(['brief', 'standard', 'comprehensive']).default('standard').describe('Desired length of summary'),
      tone: z.enum(['professional', 'casual', 'creative', 'technical']).default('creative').describe('Writing tone and style'),
      includeVisuals: z.boolean().default(true).describe('Include representative asset references'),
      structuredSections: z.boolean().default(true).describe('Organize into clear sections'),
    }).default({}),
    contextualInfo: z.object({
      projectName: z.string().optional().describe('Name of the project this board belongs to'),
      creationPeriod: z.string().optional().describe('Time period when board was created'),
      collaborators: z.array(z.string()).optional().describe('Names or usernames of collaborators'),
      projectGoals: z.array(z.string()).optional().describe('Stated goals for the project'),
    }).optional().describe('Additional context to include in summary'),
  }),
  outputSchema: z.object({
    summary: z.object({
      title: z.string(),
      overview: z.string(),
      sections: z.array(z.object({
        heading: z.string(),
        content: z.string(),
        insights: z.array(z.string()).optional(),
        assets: z.array(z.object({
          id: z.string(),
          name: z.string(),
          relevance: z.string(),
        })).optional(),
      })),
      keyHighlights: z.array(z.string()),
      recommendations: z.array(z.object({
        category: z.string(),
        suggestion: z.string(),
        reasoning: z.string(),
        priority: z.enum(['high', 'medium', 'low']),
      })).optional(),
      collaborationOpportunities: z.array(z.object({
        type: z.string(),
        description: z.string(),
        skillsNeeded: z.array(z.string()),
        potential: z.enum(['high', 'medium', 'low']),
      })).optional(),
    }),
    analytics: z.object({
      boardMetrics: z.object({
        totalAssets: z.number(),
        assetTypes: z.record(z.number()),
        creationSpan: z.string(),
        lastUpdated: z.string(),
        engagement: z.object({
          views: z.number(),
          likes: z.number(),
          comments: z.number(),
          shares: z.number(),
        }).optional(),
      }),
      contentAnalysis: z.object({
        dominantThemes: z.array(z.object({
          theme: z.string(),
          confidence: z.number(),
          assetCount: z.number(),
        })),
        styleCharacteristics: z.array(z.string()),
        colorPalette: z.array(z.string()),
        technicalQuality: z.object({
          averageScore: z.number(),
          consistency: z.number(),
          professionalLevel: z.string(),
        }),
      }),
      collaborationMetrics: z.object({
        collaboratorCount: z.number(),
        commentDensity: z.number(),
        iterationCount: z.number(),
        consensusLevel: z.number(),
      }).optional(),
    }),
    sharing: z.object({
      suggestedPlatforms: z.array(z.object({
        platform: z.string(),
        suitability: z.number(),
        customizedSummary: z.string(),
        hashtags: z.array(z.string()).optional(),
      })),
      exportFormats: z.array(z.object({
        format: z.string(),
        description: z.string(),
        useCase: z.string(),
      })),
    }),
    metadata: z.object({
      generatedAt: z.string(),
      wordCount: z.number(),
      readingTime: z.string(),
      summaryVersion: z.string(),
      aiConfidence: z.number(),
      processingTime: z.number(),
    }),
  }),
  execute: async ({ context }) => {
    const { 
      boardId, 
      userId, 
      summaryType, 
      includeElements, 
      audience, 
      format, 
      contextualInfo 
    } = context;
    try {
      const startTime = Date.now();
      
      // Mock board summary generation - in production this would:
      // 1. Load board data, assets, and metadata
      // 2. Analyze visual content using computer vision
      // 3. Extract themes, styles, and patterns
      // 4. Generate natural language summaries using LLM
      // 5. Customize content based on audience and format preferences
      // 6. Provide actionable insights and recommendations

      const boardTitle = contextualInfo?.projectName || 'Urban Photography Collection';
      
      const summary = {
        title: generateSummaryTitle(boardTitle, summaryType),
        overview: generateOverview(boardTitle, format.tone, audience),
        sections: generateSummarySections(summaryType, includeElements, format),
        keyHighlights: [
          'Strong cohesive visual style with urban photography focus',
          '24 high-quality images showcasing street life and architecture', 
          'Consistent warm color palette creating emotional connection',
          'Professional-level composition and technical execution',
          'Clear documentary storytelling approach throughout collection',
        ],
        recommendations: includeElements.recommendations ? [
          {
            category: 'Content Enhancement',
            suggestion: 'Add captions to increase engagement and context',
            reasoning: 'Descriptive captions help viewers connect with the stories behind each image',
            priority: 'medium' as const,
          },
          {
            category: 'Organization',
            suggestion: 'Create themed sub-sections within the board',
            reasoning: 'Grouping similar content improves navigation and storytelling flow',
            priority: 'low' as const,
          },
          {
            category: 'Collaboration',
            suggestion: 'Invite a writer to develop accompanying narratives',
            reasoning: 'Written stories would complement the visual narrative and expand creative impact',
            priority: 'high' as const,
          },
        ] : undefined,
        collaborationOpportunities: includeElements.collaboratorNotes ? [
          {
            type: 'Creative Writing',
            description: 'Partner with a writer to create stories that complement the visual narrative',
            skillsNeeded: ['creative_writing', 'storytelling', 'urban_culture'],
            potential: 'high' as const,
          },
          {
            type: 'Video Production',
            description: 'Transform static images into a documentary-style video presentation',
            skillsNeeded: ['video_editing', 'sound_design', 'documentary_filmmaking'],
            potential: 'medium' as const,
          },
          {
            type: 'Exhibition Curation',
            description: 'Curate a physical or virtual exhibition showcasing the urban photography',
            skillsNeeded: ['curation', 'exhibition_design', 'art_direction'],
            potential: 'medium' as const,
          },
        ] : undefined,
      };

      const analytics = {
        boardMetrics: {
          totalAssets: 24,
          assetTypes: {
            image: 20,
            video: 3,
            document: 1,
          },
          creationSpan: '3 months',
          lastUpdated: new Date().toISOString(),
          engagement: audience !== 'archive' ? {
            views: 1247,
            likes: 89,
            comments: 23,
            shares: 12,
          } : undefined,
        },
        contentAnalysis: {
          dominantThemes: [
            { theme: 'Urban Street Life', confidence: 0.89, assetCount: 12 },
            { theme: 'Architectural Elements', confidence: 0.82, assetCount: 8 },
            { theme: 'Human Stories', confidence: 0.76, assetCount: 4 },
          ],
          styleCharacteristics: [
            'Documentary photography approach',
            'High contrast black and white with selective color',
            'Street-level perspective and candid moments',
            'Professional composition following rule of thirds',
          ],
          colorPalette: ['#2C3E50', '#E67E22', '#F39C12', '#95A5A6'],
          technicalQuality: {
            averageScore: 8.7,
            consistency: 0.91,
            professionalLevel: 'Advanced Amateur to Professional',
          },
        },
        collaborationMetrics: includeElements.collaboratorNotes ? {
          collaboratorCount: 3,
          commentDensity: 0.96, // comments per asset
          iterationCount: 7,
          consensusLevel: 0.84,
        } : undefined,
      };

      const sharing = {
        suggestedPlatforms: [
          {
            platform: 'Instagram',
            suitability: 0.95,
            customizedSummary: 'Urban photography collection capturing the soul of city life through 24 compelling images. Each shot tells a story of human connection in metropolitan spaces.',
            hashtags: ['#urbanphotography', '#streetlife', '#citystories', '#documentaryphotography'],
          },
          {
            platform: 'Behance',
            suitability: 0.88,
            customizedSummary: 'A professional portfolio showcasing documentary-style urban photography with consistent aesthetic and storytelling approach.',
            hashtags: ['#photography', '#portfolio', '#urban', '#documentary'],
          },
          {
            platform: 'Pinterest',
            suitability: 0.72,
            customizedSummary: 'Inspiring urban photography collection featuring architectural details and street life moments.',
          },
        ],
        exportFormats: [
          {
            format: 'PDF Portfolio',
            description: 'Professional layout with summary text and representative images',
            useCase: 'Client presentations and portfolio reviews',
          },
          {
            format: 'Social Media Kit',
            description: 'Formatted summaries and images optimized for different platforms',
            useCase: 'Sharing across social media channels',
          },
          {
            format: 'Presentation Slides',
            description: 'Structured slide deck with key insights and visual examples',
            useCase: 'Speaking engagements and educational content',
          },
        ],
      };

      const metadata = {
        generatedAt: new Date().toISOString(),
        wordCount: calculateWordCount(summary),
        readingTime: calculateReadingTime(summary),
        summaryVersion: '1.0',
        aiConfidence: 0.87,
        processingTime: Date.now() - startTime,
      };

      return {
        summary,
        analytics,
        sharing,
        metadata,
      };
    } catch (error) {
      throw new Error(`Failed to generate board summary: ${error}`);
    }
  },
});

// Helper function to generate summary title
function generateSummaryTitle(boardTitle: string, summaryType: string): string {
  const titleTemplates: Record<string, string> = {
    overview: `${boardTitle}: Creative Collection Overview`,
    detailed: `${boardTitle}: Comprehensive Analysis & Insights`,
    collaborative: `${boardTitle}: Collaboration Summary & Opportunities`,
    presentation: `${boardTitle}: Portfolio Presentation`,
    archive: `${boardTitle}: Archive Documentation`,
  };
  
  return titleTemplates[summaryType] || `${boardTitle}: Summary`;
}

// Helper function to generate overview text
function generateOverview(boardTitle: string, tone: string, audience: string): string {
  const toneStyles: Record<string, string> = {
    professional: `This collection represents a cohesive body of work focused on urban photography and street life documentation. The ${boardTitle} demonstrates strong technical execution and consistent artistic vision throughout 24 carefully curated pieces.`,
    casual: `Check out this amazing collection of urban photography! The ${boardTitle} brings together some really compelling street scenes and architectural shots that tell the story of city life in a unique way.`,
    creative: `The ${boardTitle} captures the pulse and poetry of urban existence through a lens of curiosity and compassion. Each image serves as a window into the layered narratives that unfold in metropolitan spaces, creating a visual symphony of human connection and architectural beauty.`,
    technical: `The ${boardTitle} comprises 24 assets with consistent technical parameters and compositional approach. Image quality analysis indicates professional-level execution with average technical scores of 8.7/10 and 91% consistency across the collection.`,
  };
  
  return toneStyles[tone] || toneStyles.creative;
}

// Helper function to generate summary sections
function generateSummarySections(summaryType: string, includeElements: any, format: any) {
  const baseSections = [
    {
      heading: 'Visual Themes & Style',
      content: 'The collection demonstrates a strong documentary photography approach with emphasis on street-level perspectives and candid human moments. The visual style is characterized by high contrast processing, selective use of warm tones, and professional composition techniques that create emotional engagement with urban subjects.',
      insights: includeElements.styleInsights ? [
        'Consistent use of rule of thirds creates visual harmony',
        'Warm color grading enhances emotional connection',
        'Street-level perspective creates intimacy with subjects',
      ] : undefined,
    },
    {
      heading: 'Content Analysis',
      content: 'Twenty-four assets span three primary thematic areas: urban street life (12 assets), architectural elements (8 assets), and human stories (4 assets). The content demonstrates professional-level curation with each piece contributing to an overarching narrative about metropolitan life and human connection.',
      insights: includeElements.themeAnalysis ? [
        'Urban street life theme shows strongest consistency',
        'Architectural elements provide structural foundation',
        'Human stories create emotional anchors throughout',
      ] : undefined,
    },
  ];

  if (summaryType === 'detailed' || summaryType === 'comprehensive') {
    baseSections.push({
      heading: 'Technical Excellence',
      content: 'The collection maintains high technical standards with average quality scores of 8.7/10. Consistent exposure, sharp focus, and professional-grade post-processing demonstrate serious artistic commitment and technical proficiency.',
      insights: includeElements.assetBreakdown ? [
        '91% consistency across technical parameters',
        'Professional-level composition in 89% of assets',
        'Effective use of natural light in street environments',
      ] : undefined,
    });
  }

  if (summaryType === 'collaborative') {
    baseSections.push({
      heading: 'Collaboration Insights',
      content: 'The board shows evidence of thoughtful curation and potential for expanded collaborative development. Current structure supports additional narrative elements, video integration, and community engagement opportunities.',
      insights: includeElements.collaboratorNotes ? [
        'Strong foundation for multimedia expansion',
        'Narrative threads ready for written accompaniment',
        'Community engagement potential through story sharing',
      ] : undefined,
    });
  }

  return baseSections;
}

// Helper function to calculate word count
function calculateWordCount(summary: any): number {
  let wordCount = 0;
  
  // Count words in overview
  wordCount += summary.overview.split(' ').length;
  
  // Count words in sections
  summary.sections.forEach((section: any) => {
    wordCount += section.content.split(' ').length;
    if (section.insights) {
      section.insights.forEach((insight: string) => {
        wordCount += insight.split(' ').length;
      });
    }
  });
  
  // Count words in highlights and recommendations
  wordCount += summary.keyHighlights.reduce((sum: number, highlight: string) => 
    sum + highlight.split(' ').length, 0);
  
  if (summary.recommendations) {
    summary.recommendations.forEach((rec: any) => {
      wordCount += rec.suggestion.split(' ').length;
      wordCount += rec.reasoning.split(' ').length;
    });
  }
  
  return wordCount;
}

// Helper function to calculate reading time
function calculateReadingTime(summary: any): string {
  const wordCount = calculateWordCount(summary);
  const averageReadingSpeed = 200; // words per minute
  const minutes = Math.ceil(wordCount / averageReadingSpeed);
  
  if (minutes === 1) return '1 minute';
  if (minutes < 60) return `${minutes} minutes`;
  
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  
  if (remainingMinutes === 0) return `${hours} hour${hours > 1 ? 's' : ''}`;
  return `${hours} hour${hours > 1 ? 's' : ''} ${remainingMinutes} minute${remainingMinutes > 1 ? 's' : ''}`;
}
````

## File: apps/ai/src/mastra/tools/collaboration/index.ts
````typescript
// Collaboration Tools
// These tools provide AI-powered assistance for team collaboration, content sharing, and community building

export { suggestCollaboratorsTool } from './suggest-collaborators';
export { generateBoardSummaryTool } from './generate-board-summary';
export { detectDuplicatesTool } from './detect-duplicates';
export { mergeBoardsTool } from './merge-boards';

// Re-export types and utilities
export type CollaborationType = 'creative' | 'technical' | 'curatorial' | 'educational' | 'commercial';
export type ExperienceLevel = 'beginner' | 'intermediate' | 'expert' | 'any';
export type WorkStyle = 'structured' | 'flexible' | 'experimental' | 'professional';
export type ProjectScope = 'single_board' | 'ongoing_project' | 'series' | 'community_initiative';

export type SummaryType = 'overview' | 'detailed' | 'collaborative' | 'presentation' | 'archive';
export type SummaryAudience = 'creator' | 'collaborator' | 'public' | 'client' | 'archive';
export type SummaryTone = 'professional' | 'casual' | 'creative' | 'technical';
export type SummaryLength = 'brief' | 'standard' | 'comprehensive';

export type DuplicateType = 'exact_duplicate' | 'visual_similar' | 'metadata_similar' | 'content_similar' | 'semantic_similar';
export type DuplicateAction = 'delete' | 'merge' | 'keep_both' | 'review' | 'replace';
export type DetectionMethod = 'exactDuplicates' | 'visualSimilarity' | 'metadataSimilarity' | 'contentSimilarity' | 'semanticSimilarity';

export type MergeStrategy = 'chronological' | 'thematic' | 'quality_based' | 'board_sections' | 'ai_optimal';
export type ConflictResolution = 'keep_highest_quality' | 'keep_oldest' | 'keep_newest' | 'keep_all' | 'manual_review';
export type TagConflictResolution = 'merge_all' | 'keep_common' | 'prioritize_target' | 'ai_curated';

// Collaboration preferences interface
export interface CollaborationPreferences {
  experienceLevel?: ExperienceLevel;
  location?: string;
  workStyle?: WorkStyle;
  timeCommitment?: 'light' | 'moderate' | 'intensive';
}

// Board summary configuration interface
export interface SummaryConfiguration {
  summaryType?: SummaryType;
  audience?: SummaryAudience;
  format?: {
    length?: SummaryLength;
    tone?: SummaryTone;
    includeVisuals?: boolean;
    structuredSections?: boolean;
  };
  includeElements?: {
    themeAnalysis?: boolean;
    assetBreakdown?: boolean;
    styleInsights?: boolean;
    collaboratorNotes?: boolean;
    progressTracking?: boolean;
    recommendations?: boolean;
  };
}

// Duplicate detection configuration interface
export interface DuplicateDetectionConfig {
  detectionMethods?: {
    exactDuplicates?: boolean;
    visualSimilarity?: boolean;
    metadataSimilarity?: boolean;
    contentSimilarity?: boolean;
    semanticSimilarity?: boolean;
  };
  similarityThresholds?: {
    visualSimilarity?: number;
    metadataMatch?: number;
    semanticSimilarity?: number;
    filenameSimilarity?: number;
  };
  analysisOptions?: {
    groupSimilarAssets?: boolean;
    identifyVersions?: boolean;
    suggestActions?: boolean;
    preserveOriginals?: boolean;
    analyzeQuality?: boolean;
  };
}

// Board merge configuration interface
export interface BoardMergeConfig {
  organizationStrategy?: MergeStrategy;
  duplicateResolution?: ConflictResolution;
  conflictingTags?: TagConflictResolution;
  preserveSourceBoards?: boolean;
  qualityControl?: {
    performQualityAnalysis?: boolean;
    removeLowQuality?: boolean;
    qualityThreshold?: number;
    consolidateVariations?: boolean;
  };
}
````

## File: apps/ai/src/mastra/tools/collaboration/merge-boards.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';

/**
 * Intelligently merge multiple boards with AI-powered organization and conflict resolution
 */
export const mergeBoardsTool = createTool({
  id: 'merge-boards',
  description: 'Merge multiple boards into a single cohesive collection with AI-powered asset organization, theme analysis, and conflict resolution',
  inputSchema: z.object({
    sourceBoardIds: z.array(z.string()).min(2).max(10).describe('IDs of boards to merge (2-10 boards)'),
    userId: z.string().describe('User ID requesting the merge'),
    mergeConfiguration: z.object({
      targetBoardId: z.string().optional().describe('ID of existing board to merge into (if not provided, creates new board)'),
      newBoardName: z.string().optional().describe('Name for new merged board (required if targetBoardId not provided)'),
      preserveSourceBoards: z.boolean().default(false).describe('Keep original boards after merge'),
      organizationStrategy: z.enum(['chronological', 'thematic', 'quality_based', 'board_sections', 'ai_optimal']).default('ai_optimal').describe('How to organize merged content'),
    }),
    contentHandling: z.object({
      duplicateResolution: z.enum(['keep_highest_quality', 'keep_oldest', 'keep_newest', 'keep_all', 'manual_review']).default('keep_highest_quality').describe('How to handle duplicate assets'),
      conflictingTags: z.enum(['merge_all', 'keep_common', 'prioritize_target', 'ai_curated']).default('ai_curated').describe('How to handle conflicting tags'),
      metadataHandling: z.enum(['preserve_all', 'merge_compatible', 'prioritize_complete']).default('merge_compatible').describe('How to handle metadata conflicts'),
      namingConflicts: z.enum(['append_suffix', 'preserve_original', 'ai_rename']).default('ai_rename').describe('How to resolve asset naming conflicts'),
    }).default({}),
    qualityControl: z.object({
      performQualityAnalysis: z.boolean().default(true).describe('Analyze asset quality during merge'),
      removeLowQuality: z.boolean().default(false).describe('Automatically remove low-quality duplicates'),
      qualityThreshold: z.number().min(0).max(10).default(6.0).describe('Minimum quality score to retain assets'),
      consolidateVariations: z.boolean().default(true).describe('Group and consolidate asset variations'),
    }).default({}),
    postMergeActions: z.object({
      generateSummary: z.boolean().default(true).describe('Generate summary of merged board'),
      optimizeLayout: z.boolean().default(true).describe('Optimize visual layout after merge'),
      updateTags: z.boolean().default(true).describe('Update and optimize tags across merged content'),
      createSections: z.boolean().default(true).describe('Create thematic sections within merged board'),
    }).default({}),
  }),
  outputSchema: z.object({
    mergeResult: z.object({
      success: z.boolean(),
      targetBoardId: z.string(),
      targetBoardName: z.string(),
      mergedAssetCount: z.number(),
      sectionsCreated: z.array(z.object({
        name: z.string(),
        description: z.string(),
        assetIds: z.array(z.string()),
        theme: z.string(),
        sourceBoards: z.array(z.string()),
      })).optional(),
      organizationStrategy: z.string(),
      processingTime: z.number(),
    }),
    assetProcessing: z.object({
      totalAssets: z.number(),
      duplicatesFound: z.number(),
      duplicatesResolved: z.number(),
      assetsRemoved: z.number(),
      assetsRenamed: z.number(),
      qualityIssuesFound: z.number(),
      qualityIssuesResolved: z.number(),
      processingDetails: z.array(z.object({
        assetId: z.string(),
        originalName: z.string(),
        finalName: z.string(),
        action: z.enum(['kept', 'removed', 'renamed', 'merged', 'quality_filtered']),
        reasoning: z.string(),
        sourceBoard: z.string(),
        qualityScore: z.number().optional(),
      })),
    }),
    conflictResolution: z.object({
      tagConflicts: z.array(z.object({
        assetId: z.string(),
        conflictingTags: z.array(z.string()),
        resolvedTags: z.array(z.string()),
        resolution: z.string(),
      })),
      metadataConflicts: z.array(z.object({
        assetId: z.string(),
        conflictType: z.string(),
        conflictingValues: z.array(z.string()),
        resolvedValue: z.string(),
        resolution: z.string(),
      })),
      namingConflicts: z.array(z.object({
        originalName: z.string(),
        conflictingAssets: z.array(z.string()),
        resolvedNames: z.array(z.string()),
        resolution: z.string(),
      })),
    }),
    boardAnalysis: z.object({
      sourceBoards: z.array(z.object({
        boardId: z.string(),
        name: z.string(),
        assetCount: z.number(),
        themes: z.array(z.string()),
        qualityScore: z.number(),
        contributionToMerge: z.number(), // Percentage of assets that made it to final merge
      })),
      thematicAnalysis: z.object({
        identifiedThemes: z.array(z.object({
          theme: z.string(),
          confidence: z.number(),
          assetCount: z.number(),
          sourceBoards: z.array(z.string()),
        })),
        thematicCoherence: z.number(),
        organizationalComplexity: z.number(),
      }),
      qualityDistribution: z.object({
        averageQuality: z.number(),
        qualityRange: z.object({
          minimum: z.number(),
          maximum: z.number(),
        }),
        qualityByTheme: z.array(z.object({
          theme: z.string(),
          averageQuality: z.number(),
        })),
      }),
    }),
    recommendations: z.object({
      postMergeOptimizations: z.array(z.object({
        type: z.string(),
        title: z.string(),
        description: z.string(),
        priority: z.enum(['high', 'medium', 'low']),
        estimatedImpact: z.string(),
      })),
      futurePreventions: z.array(z.object({
        issue: z.string(),
        prevention: z.string(),
        implementation: z.string(),
      })),
      qualityImprovements: z.array(z.string()),
    }),
    executionMetadata: z.object({
      totalProcessingTime: z.number(),
      algorithmicDecisions: z.number(),
      manualReviewRequired: z.number(),
      confidenceScore: z.number(),
      rollbackAvailable: z.boolean(),
      backupCreated: z.string().optional(),
    }),
  }),
  execute: async ({ context }) => {
    const { 
      sourceBoardIds, 
      userId, 
      mergeConfiguration, 
      contentHandling, 
      qualityControl, 
      postMergeActions 
    } = context;
    try {
      const startTime = Date.now();
      
      // Mock board merging - in production this would:
      // 1. Load all source boards and their assets
      // 2. Analyze themes, quality, and potential conflicts
      // 3. Apply duplicate detection and resolution strategies
      // 4. Organize content according to chosen strategy
      // 5. Resolve naming, tagging, and metadata conflicts
      // 6. Create optimized structure and layout
      // 7. Generate comprehensive merge report

      const targetBoardId = mergeConfiguration.targetBoardId || `merged-board-${Date.now()}`;
      const targetBoardName = mergeConfiguration.newBoardName || 'Merged Collection';

      // Mock asset processing
      const assetProcessing = generateAssetProcessing(sourceBoardIds, contentHandling, qualityControl);
      
      // Mock conflict resolution
      const conflictResolution = generateConflictResolution(contentHandling);
      
      // Mock board analysis
      const boardAnalysis = generateBoardAnalysis(sourceBoardIds);
      
      // Create sections based on thematic analysis
      const sectionsCreated = postMergeActions.createSections ? [
        {
          name: 'Urban Photography',
          description: 'Street scenes and architectural photography',
          assetIds: ['asset-1', 'asset-2', 'asset-5', 'asset-8', 'asset-12'],
          theme: 'urban_life',
          sourceBoards: sourceBoardIds.slice(0, 2),
        },
        {
          name: 'Portrait Collection',
          description: 'Professional and candid portrait photography',
          assetIds: ['asset-3', 'asset-7', 'asset-11'],
          theme: 'portraiture',
          sourceBoards: sourceBoardIds.slice(1, 3),
        },
        {
          name: 'Nature & Landscapes',
          description: 'Outdoor scenes and natural environments',
          assetIds: ['asset-4', 'asset-6', 'asset-9', 'asset-10'],
          theme: 'nature',
          sourceBoards: sourceBoardIds.slice(2),
        },
      ] : undefined;

      const mergeResult = {
        success: true,
        targetBoardId,
        targetBoardName,
        mergedAssetCount: assetProcessing.totalAssets - assetProcessing.assetsRemoved,
        sectionsCreated,
        organizationStrategy: mergeConfiguration.organizationStrategy,
        processingTime: Date.now() - startTime,
      };

      const recommendations = {
        postMergeOptimizations: [
          {
            type: 'layout_optimization',
            title: 'Optimize Visual Layout',
            description: 'Rearrange assets within sections for better visual flow and storytelling',
            priority: 'high' as const,
            estimatedImpact: 'Improved user engagement and content discoverability',
          },
          {
            type: 'tag_consolidation',
            title: 'Consolidate Tag Vocabulary',
            description: 'Standardize similar tags to improve searchability and organization',
            priority: 'medium' as const,
            estimatedImpact: 'Better content organization and search functionality',
          },
          {
            type: 'quality_enhancement',
            title: 'Address Quality Inconsistencies',
            description: 'Review and potentially enhance lower-quality assets that were retained',
            priority: 'low' as const,
            estimatedImpact: 'More professional and consistent collection appearance',
          },
        ],
        futurePreventions: [
          {
            issue: 'Duplicate content across boards',
            prevention: 'Implement cross-board duplicate detection before uploads',
            implementation: 'Enable automatic duplicate checking during asset upload process',
          },
          {
            issue: 'Inconsistent tagging practices',
            prevention: 'Establish standardized tagging guidelines',
            implementation: 'Create tag suggestions and validation rules for new content',
          },
          {
            issue: 'Quality variations',
            prevention: 'Set minimum quality standards for uploads',
            implementation: 'Implement quality scoring and filtering during upload workflow',
          },
        ],
        qualityImprovements: [
          'Consider professional editing for key pieces in the collection',
          'Add descriptive captions to enhance storytelling',
          'Create consistent color grading across similar themes',
          'Develop signature style elements to unify the collection',
        ],
      };

      const executionMetadata = {
        totalProcessingTime: Date.now() - startTime,
        algorithmicDecisions: 127, // Mock number of AI decisions made
        manualReviewRequired: 8, // Mock items requiring manual review
        confidenceScore: 0.89,
        rollbackAvailable: true,
        backupCreated: mergeConfiguration.preserveSourceBoards ? undefined : `backup-${Date.now()}`,
      };

      return {
        mergeResult,
        assetProcessing,
        conflictResolution,
        boardAnalysis,
        recommendations,
        executionMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to merge boards: ${error}`);
    }
  },
});

// Helper function to generate asset processing details
function generateAssetProcessing(sourceBoardIds: string[], contentHandling: any, qualityControl: any) {
  const totalAssets = sourceBoardIds.length * 15; // Mock: ~15 assets per board
  const duplicatesFound = Math.floor(totalAssets * 0.15); // 15% duplicates
  const assetsRemoved = Math.floor(duplicatesFound * 0.8); // Remove 80% of duplicates
  const assetsRenamed = Math.floor(totalAssets * 0.1); // 10% renamed for conflicts
  const qualityIssuesFound = qualityControl.performQualityAnalysis ? Math.floor(totalAssets * 0.12) : 0;
  const qualityIssuesResolved = qualityControl.removeLowQuality ? Math.floor(qualityIssuesFound * 0.6) : 0;

  const processingDetails = [];
  
  // Generate sample processing details
  for (let i = 0; i < Math.min(10, totalAssets); i++) {
    const actions = ['kept', 'removed', 'renamed', 'merged', 'quality_filtered'] as const;
    const action = actions[Math.floor(Math.random() * actions.length)];
    
    processingDetails.push({
      assetId: `asset-${i + 1}`,
      originalName: `image-${i + 1}.jpg`,
      finalName: action === 'renamed' ? `urban-photo-${i + 1}.jpg` : `image-${i + 1}.jpg`,
      action,
      reasoning: getReasoningForAction(action),
      sourceBoard: sourceBoardIds[i % sourceBoardIds.length],
      qualityScore: qualityControl.performQualityAnalysis ? Math.random() * 4 + 6 : undefined,
    });
  }

  return {
    totalAssets,
    duplicatesFound,
    duplicatesResolved: duplicatesFound,
    assetsRemoved,
    assetsRenamed,
    qualityIssuesFound,
    qualityIssuesResolved,
    processingDetails,
  };
}

// Helper function to generate conflict resolution details
function generateConflictResolution(contentHandling: any) {
  return {
    tagConflicts: [
      {
        assetId: 'asset-3',
        conflictingTags: ['street', 'urban', 'city'],
        resolvedTags: ['urban', 'street'],
        resolution: contentHandling.conflictingTags === 'ai_curated' 
          ? 'AI selected most specific and common tags' 
          : 'Applied configured conflict resolution strategy',
      },
      {
        assetId: 'asset-7',
        conflictingTags: ['portrait', 'person', 'headshot'],
        resolvedTags: ['portrait', 'person'],
        resolution: 'Merged semantically similar tags, kept most descriptive',
      },
    ],
    metadataConflicts: [
      {
        assetId: 'asset-5',
        conflictType: 'creation_date',
        conflictingValues: ['2024-01-15', '2024-01-16'],
        resolvedValue: '2024-01-15',
        resolution: 'Kept earliest creation date as authoritative',
      },
    ],
    namingConflicts: [
      {
        originalName: 'DSC_0001.jpg',
        conflictingAssets: ['asset-2', 'asset-8'],
        resolvedNames: ['DSC_0001_urban.jpg', 'DSC_0001_portrait.jpg'],
        resolution: contentHandling.namingConflicts === 'ai_rename' 
          ? 'AI generated descriptive names based on content analysis' 
          : 'Applied suffix to resolve naming conflict',
      },
    ],
  };
}

// Helper function to generate board analysis
function generateBoardAnalysis(sourceBoardIds: string[]) {
  const sourceBoards = sourceBoardIds.map((boardId, index) => ({
    boardId,
    name: `Source Board ${index + 1}`,
    assetCount: Math.floor(Math.random() * 10 + 10), // 10-20 assets
    themes: [`theme_${index + 1}`, `style_${index + 1}`],
    qualityScore: Math.random() * 2 + 7, // 7-9 quality score
    contributionToMerge: Math.random() * 0.3 + 0.7, // 70-100% contribution
  }));

  const identifiedThemes = [
    {
      theme: 'Urban Photography',
      confidence: 0.89,
      assetCount: 12,
      sourceBoards: sourceBoardIds.slice(0, 2),
    },
    {
      theme: 'Portrait Photography',
      confidence: 0.82,
      assetCount: 8,
      sourceBoards: sourceBoardIds.slice(1, 3),
    },
    {
      theme: 'Landscape Photography',
      confidence: 0.75,
      assetCount: 6,
      sourceBoards: sourceBoardIds.slice(2),
    },
  ];

  return {
    sourceBoards,
    thematicAnalysis: {
      identifiedThemes,
      thematicCoherence: 0.84,
      organizationalComplexity: 0.67,
    },
    qualityDistribution: {
      averageQuality: 8.2,
      qualityRange: {
        minimum: 6.1,
        maximum: 9.6,
      },
      qualityByTheme: identifiedThemes.map(theme => ({
        theme: theme.theme,
        averageQuality: Math.random() * 1.5 + 7.5, // 7.5-9.0
      })),
    },
  };
}

// Helper function to get reasoning for processing actions
function getReasoningForAction(action: string): string {
  const reasoningMap: Record<string, string> = {
    kept: 'High quality asset with unique content, preserved in merged collection',
    removed: 'Duplicate asset with lower quality than retained version',
    renamed: 'Renamed to resolve naming conflict and improve descriptiveness',
    merged: 'Combined with similar asset to reduce redundancy',
    quality_filtered: 'Removed due to quality score below configured threshold',
  };
  
  return reasoningMap[action] || 'Processed according to merge configuration';
}
````

## File: apps/ai/src/mastra/tools/collaboration/suggest-collaborators.ts
````typescript
import { createTool } from '@mastra/core';
import { z } from 'zod';
import { aiServiceClient } from '../../lib/orpc-client';

/**
 * Suggest potential collaborators based on expertise, interests, and content analysis
 * Uses ORPC client to fetch user and board data from API layer
 */
export const suggestCollaboratorsTool = createTool({
  id: 'suggest-collaborators',
  description: 'Recommend potential collaborators based on board content, user interests, expertise areas, and collaboration history',
  inputSchema: z.object({
    boardId: z.string().optional().describe('Board ID to find collaborators for (optional)'),
    userId: z.string().describe('User ID requesting collaborator suggestions'),
    collaborationType: z.enum(['creative', 'technical', 'curatorial', 'educational', 'commercial']).default('creative').describe('Type of collaboration sought'),
    expertiseAreas: z.array(z.string()).optional().describe('Specific expertise areas needed (e.g., photography, design, writing)'),
    projectScope: z.enum(['single_board', 'ongoing_project', 'series', 'community_initiative']).default('single_board').describe('Scope of the collaboration'),
    preferences: z.object({
      experienceLevel: z.enum(['beginner', 'intermediate', 'expert', 'any']).default('any').describe('Preferred collaborator experience level'),
      location: z.string().optional().describe('Geographic preference for collaborators'),
      workStyle: z.enum(['structured', 'flexible', 'experimental', 'professional']).optional().describe('Preferred working style'),
      timeCommitment: z.enum(['light', 'moderate', 'intensive']).default('moderate').describe('Expected time commitment'),
    }).default({}),
    contentAnalysis: z.object({
      includeContentMatch: z.boolean().default(true).describe('Match based on similar content interests'),
      includeStyleMatch: z.boolean().default(true).describe('Match based on similar artistic style'),
      includeSkillGaps: z.boolean().default(false).describe('Find collaborators who complement missing skills'),
    }).default({}),
    filterOptions: z.object({
      excludePreviousCollaborators: z.boolean().default(false).describe('Exclude users previously collaborated with'),
      minimumReputation: z.number().min(0).max(100).optional().describe('Minimum reputation score required'),
      activeInLastDays: z.number().default(30).describe('Only include users active within this many days'),
      maxSuggestions: z.number().min(1).max(20).default(10).describe('Maximum number of suggestions to return'),
    }).default({}),
  }),
  outputSchema: z.object({
    collaborators: z.array(z.object({
      userId: z.string(),
      username: z.string(),
      displayName: z.string().optional(),
      profilePicture: z.string().optional(),
      matchScore: z.number(),
      matchReasons: z.array(z.object({
        type: z.enum(['content', 'style', 'expertise', 'activity', 'reputation', 'collaboration_history']),
        description: z.string(),
        strength: z.number(),
      })),
      expertise: z.array(z.object({
        area: z.string(),
        level: z.enum(['beginner', 'intermediate', 'expert']),
        confidence: z.number(),
        evidence: z.array(z.string()),
      })),
      recentWork: z.array(z.object({
        boardId: z.string(),
        boardName: z.string(),
        assetCount: z.number(),
        style: z.array(z.string()),
        createdAt: z.string(),
      })),
      collaborationHistory: z.object({
        totalProjects: z.number(),
        successRate: z.number(),
        averageRating: z.number().optional(),
        commonCollaborators: z.array(z.string()).optional(),
      }),
      contactInfo: z.object({
        preferredMethod: z.string().optional(),
        responseTime: z.string().optional(),
        availability: z.string().optional(),
        timezone: z.string().optional(),
      }).optional(),
      compatibility: z.object({
        workStyleMatch: z.number(),
        communicationStyle: z.string(),
        projectApproach: z.string(),
        timeZoneCompatibility: z.number().optional(),
      }),
    })),
    alternativeSuggestions: z.array(z.object({
      type: z.string(),
      title: z.string(),
      description: z.string(),
      actionRequired: z.string(),
    })),
    collaborationInsights: z.object({
      commonThemes: z.array(z.string()),
      skillGaps: z.array(z.string()),
      opportunityAreas: z.array(z.string()),
      networkRecommendations: z.array(z.string()),
    }),
    searchMetadata: z.object({
      totalUsersAnalyzed: z.number(),
      matchingAlgorithm: z.string(),
      filtersCriteria: z.array(z.string()),
      processingTime: z.number(),
    }),
  }),
  execute: async ({ context }) => {
    const { 
      boardId, 
      userId, 
      collaborationType, 
      expertiseAreas, 
      projectScope, 
      preferences, 
      contentAnalysis, 
      filterOptions 
    } = context;
    try {
      const startTime = Date.now();
      
      // Fetch user data and board information if provided
      const currentUser = await aiServiceClient.getUser(userId);
      let boardContent = null;
      if (boardId) {
        boardContent = await aiServiceClient.getBoard(boardId, userId);
      }
      
      // Generate collaborator suggestions based on real data
      // In production, this would query a recommendation engine
      const collaborators = generateMockCollaborators(
        collaborationType, 
        expertiseAreas, 
        preferences, 
        filterOptions.maxSuggestions
      );

      const alternativeSuggestions = [
        {
          type: 'community_post',
          title: 'Create a Collaboration Post',
          description: 'Post in the community to attract collaborators with specific skills',
          actionRequired: 'Draft a collaboration request detailing your project needs',
        },
        {
          type: 'skill_exchange',
          title: 'Skill Exchange Opportunity',
          description: 'Offer to teach your expertise in exchange for the skills you need',
          actionRequired: 'Define what you can teach and what you want to learn',
        },
        {
          type: 'workshop_participation',
          title: 'Join Relevant Workshops',
          description: 'Participate in workshops to meet like-minded creators',
          actionRequired: 'Browse upcoming workshops in your interest areas',
        },
      ];

      const collaborationInsights = {
        commonThemes: ['urban_photography', 'street_art', 'architectural_design', 'creative_storytelling'],
        skillGaps: ['video_editing', 'sound_design', 'copywriting', 'social_media_marketing'],
        opportunityAreas: [
          'Cross-disciplinary projects combining photography and design',
          'Educational content creation',
          'Community art initiatives',
        ],
        networkRecommendations: [
          'Connect with more designers to expand creative options',
          'Build relationships with writers for storytelling projects',
          'Engage with community organizers for larger initiatives',
        ],
      };

      const searchMetadata = {
        totalUsersAnalyzed: 2847,
        matchingAlgorithm: 'hybrid_content_expertise_matching',
        filtersCriteria: [
          ...(preferences.experienceLevel !== 'any' ? ['experience_level'] : []),
          ...(preferences.location ? ['geographic_location'] : []),
          'activity_recency',
          ...(filterOptions.minimumReputation ? ['reputation_score'] : []),
        ],
        processingTime: Date.now() - startTime,
      };

      return {
        collaborators,
        alternativeSuggestions,
        collaborationInsights,
        searchMetadata,
      };
    } catch (error) {
      throw new Error(`Failed to suggest collaborators: ${error}`);
    }
  },
});

// Helper function to generate mock collaborators
function generateMockCollaborators(
  collaborationType: string,
  expertiseAreas?: string[],
  preferences: any = {},
  maxSuggestions: number = 10
) {
  const mockUsers = [
    {
      userId: 'user-collab-1',
      username: 'alexphoto',
      displayName: 'Alex Chen',
      profilePicture: 'https://example.com/profiles/alex.jpg',
      expertise: [
        { area: 'street_photography', level: 'expert' as const, confidence: 0.92 },
        { area: 'photo_editing', level: 'expert' as const, confidence: 0.88 },
        { area: 'urban_exploration', level: 'intermediate' as const, confidence: 0.75 },
      ],
      workStyle: 'flexible',
      location: 'New York, NY',
      timezone: 'EST',
    },
    {
      userId: 'user-collab-2',
      username: 'designmaria',
      displayName: 'Maria Rodriguez',
      profilePicture: 'https://example.com/profiles/maria.jpg',
      expertise: [
        { area: 'graphic_design', level: 'expert' as const, confidence: 0.95 },
        { area: 'typography', level: 'expert' as const, confidence: 0.89 },
        { area: 'brand_identity', level: 'intermediate' as const, confidence: 0.82 },
      ],
      workStyle: 'structured',
      location: 'Los Angeles, CA',
      timezone: 'PST',
    },
    {
      userId: 'user-collab-3',
      username: 'videojas',
      displayName: 'Jasper Williams',
      profilePicture: 'https://example.com/profiles/jasper.jpg',
      expertise: [
        { area: 'video_production', level: 'expert' as const, confidence: 0.91 },
        { area: 'motion_graphics', level: 'intermediate' as const, confidence: 0.78 },
        { area: 'storytelling', level: 'expert' as const, confidence: 0.85 },
      ],
      workStyle: 'experimental',
      location: 'Austin, TX',
      timezone: 'CST',
    },
    {
      userId: 'user-collab-4',
      username: 'writesamira',
      displayName: 'Samira Patel',
      profilePicture: 'https://example.com/profiles/samira.jpg',
      expertise: [
        { area: 'creative_writing', level: 'expert' as const, confidence: 0.93 },
        { area: 'content_strategy', level: 'intermediate' as const, confidence: 0.81 },
        { area: 'storytelling', level: 'expert' as const, confidence: 0.87 },
      ],
      workStyle: 'professional',
      location: 'Chicago, IL',
      timezone: 'CST',
    },
    {
      userId: 'user-collab-5',
      username: 'archben',
      displayName: 'Ben Thompson',
      profilePicture: 'https://example.com/profiles/ben.jpg',
      expertise: [
        { area: 'architecture_photography', level: 'expert' as const, confidence: 0.90 },
        { area: 'urban_planning', level: 'intermediate' as const, confidence: 0.76 },
        { area: 'spatial_design', level: 'expert' as const, confidence: 0.84 },
      ],
      workStyle: 'structured',
      location: 'Seattle, WA',
      timezone: 'PST',
    },
  ];

  return mockUsers.slice(0, maxSuggestions).map((user, index) => {
    const matchScore = Math.random() * 0.3 + 0.7; // Random score between 0.7-1.0
    
    const matchReasons = generateMatchReasons(user, collaborationType, expertiseAreas);
    
    return {
      userId: user.userId,
      username: user.username,
      displayName: user.displayName,
      profilePicture: user.profilePicture,
      matchScore,
      matchReasons,
      expertise: user.expertise.map(exp => ({
        ...exp,
        evidence: [
          `${Math.floor(Math.random() * 20 + 10)} successful projects`,
          `Rated ${(Math.random() * 0.8 + 4.2).toFixed(1)}/5.0 by collaborators`,
          `${Math.floor(Math.random() * 500 + 100)} community endorsements`,
        ],
      })),
      recentWork: [
        {
          boardId: `board-${index + 1}`,
          boardName: `${user.displayName?.split(' ')[0]}'s Portfolio`,
          assetCount: Math.floor(Math.random() * 30 + 10),
          style: user.expertise.map(e => e.area),
          createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
        },
      ],
      collaborationHistory: {
        totalProjects: Math.floor(Math.random() * 15 + 5),
        successRate: Math.random() * 0.2 + 0.8, // 0.8-1.0
        averageRating: Math.random() * 0.8 + 4.2, // 4.2-5.0
        commonCollaborators: [`user-${index + 10}`, `user-${index + 20}`],
      },
      contactInfo: {
        preferredMethod: ['email', 'direct_message', 'video_call'][Math.floor(Math.random() * 3)],
        responseTime: ['within_hours', 'within_day', 'within_week'][Math.floor(Math.random() * 3)],
        availability: ['weekdays', 'weekends', 'flexible'][Math.floor(Math.random() * 3)],
        timezone: user.timezone,
      },
      compatibility: {
        workStyleMatch: calculateWorkStyleMatch(user.workStyle, preferences.workStyle),
        communicationStyle: 'collaborative',
        projectApproach: 'detail_oriented',
        timeZoneCompatibility: preferences.location ? 
          calculateTimezoneCompatibility(user.timezone, preferences.location) : undefined,
      },
    };
  });
}

// Helper function to generate match reasons
function generateMatchReasons(user: any, collaborationType: string, expertiseAreas?: string[]) {
  const reasons = [];
  
  // Content expertise match
  if (expertiseAreas) {
    const matchingExpertise = user.expertise.filter((exp: any) => 
      expertiseAreas.some(area => exp.area.includes(area.toLowerCase().replace(' ', '_')))
    );
    
    if (matchingExpertise.length > 0) {
      reasons.push({
        type: 'expertise' as const,
        description: `Expert in ${matchingExpertise.map((e: any) => e.area).join(', ')}`,
        strength: matchingExpertise.reduce((sum: number, exp: any) => sum + exp.confidence, 0) / matchingExpertise.length,
      });
    }
  }

  // Collaboration type match
  reasons.push({
    type: 'activity' as const,
    description: `Active in ${collaborationType} projects with strong track record`,
    strength: Math.random() * 0.2 + 0.8,
  });

  // Work style compatibility
  reasons.push({
    type: 'collaboration_history' as const,
    description: `${user.collaborationHistory?.successRate > 0.9 ? 'Excellent' : 'Good'} collaboration success rate`,
    strength: user.collaborationHistory?.successRate || 0.85,
  });

  return reasons;
}

// Helper function to calculate work style compatibility
function calculateWorkStyleMatch(userStyle: string, preferredStyle?: string): number {
  if (!preferredStyle) return 0.8; // Neutral match if no preference
  
  const compatibilityMatrix: Record<string, Record<string, number>> = {
    structured: { structured: 1.0, professional: 0.9, flexible: 0.6, experimental: 0.4 },
    flexible: { flexible: 1.0, experimental: 0.8, structured: 0.6, professional: 0.7 },
    experimental: { experimental: 1.0, flexible: 0.8, professional: 0.5, structured: 0.4 },
    professional: { professional: 1.0, structured: 0.9, flexible: 0.7, experimental: 0.5 },
  };
  
  return compatibilityMatrix[userStyle]?.[preferredStyle] || 0.7;
}

// Helper function to calculate timezone compatibility
function calculateTimezoneCompatibility(userTimezone: string, preferredLocation: string): number {
  // Mock calculation - in reality this would use actual timezone data
  const timezoneGroups = {
    'EST': ['New York', 'Boston', 'Miami'],
    'CST': ['Chicago', 'Austin', 'Dallas'],
    'PST': ['Los Angeles', 'Seattle', 'San Francisco'],
  };
  
  for (const [tz, locations] of Object.entries(timezoneGroups)) {
    if (userTimezone === tz && locations.some(loc => preferredLocation.includes(loc))) {
      return 1.0; // Same timezone
    }
  }
  
  return Math.random() * 0.4 + 0.6; // Random compatibility for different timezones
}
````

## File: apps/ai/src/mastra/tools/index.ts
````typescript
// Export all Mastra tools
// These tools provide AI-powered assistance for the Squish platform

// Board Management Tools
export * from './board';

// Asset Organization Tools  
export * from './asset';

// Collaboration Tools
export * from './collaboration';

// Tool Registry
export const availableTools = {
  // Board Management
  searchBoards: 'search-boards',
  createBoard: 'create-board', 
  analyzeBoard: 'analyze-board',
  suggestBoardOrganization: 'suggest-board-organization',

  // Asset Organization
  searchAssets: 'search-assets',
  categorizeAssets: 'categorize-assets',
  findSimilarAssets: 'find-similar-assets',
  generateAssetTags: 'generate-asset-tags',
  organizeAssetsByTheme: 'organize-assets-by-theme',

  // Collaboration
  suggestCollaborators: 'suggest-collaborators',
  generateBoardSummary: 'generate-board-summary',
  detectDuplicates: 'detect-duplicates',
  mergeBoards: 'merge-boards',
};

// Tool Categories for organization
export const toolCategories = {
  boardManagement: [
    'search-boards',
    'create-board',
    'analyze-board', 
    'suggest-board-organization',
  ],
  assetOrganization: [
    'search-assets',
    'categorize-assets',
    'find-similar-assets',
    'generate-asset-tags',
    'organize-assets-by-theme',
  ],
  collaboration: [
    'suggest-collaborators',
    'generate-board-summary',
    'detect-duplicates',
    'merge-boards',
  ],
};

// Tool descriptions for documentation
export const toolDescriptions = {
  'search-boards': 'Search boards by name, description, tags, or semantic meaning using vector embeddings',
  'create-board': 'Create a new board with AI-powered theme suggestions, organization templates, and smart defaults',
  'analyze-board': 'Analyze board content, structure, and user engagement to provide insights and improvement recommendations',
  'suggest-board-organization': 'Analyze board content and suggest optimal organization strategies, layouts, and structural improvements',
  
  'search-assets': 'Search assets using semantic similarity, visual features, metadata, and AI-powered content understanding',
  'categorize-assets': 'Analyze and automatically categorize assets using computer vision, content analysis, and machine learning',
  'find-similar-assets': 'Find assets similar to a given asset using visual features, semantic meaning, metadata, and content analysis',
  'generate-asset-tags': 'Automatically generate relevant, searchable tags for assets using computer vision, semantic analysis, and content understanding',
  'organize-assets-by-theme': 'Automatically group assets into thematic collections using visual similarity, semantic analysis, and content understanding',
  
  'suggest-collaborators': 'Recommend potential collaborators based on board content, user interests, expertise areas, and collaboration history',
  'generate-board-summary': 'Create comprehensive, AI-generated summaries of board content including themes, insights, and collaboration opportunities',
  'detect-duplicates': 'Find duplicate, near-duplicate, and highly similar content across boards using visual similarity, metadata analysis, and content fingerprinting',
  'merge-boards': 'Merge multiple boards into a single cohesive collection with AI-powered asset organization, theme analysis, and conflict resolution',
};
````

## File: apps/ai/src/mastra/tools/README.md
````markdown
# Squish AI Tools

This directory contains comprehensive AI-powered tools for the Squish platform, built using the Mastra framework. These tools provide intelligent assistance for board management, asset organization, and collaboration.

## Overview

The Squish AI tools are organized into three main categories:

1. **Board Management** - Tools for creating, analyzing, and organizing boards
2. **Asset Organization** - Tools for discovering, categorizing, and organizing assets
3. **Collaboration** - Tools for team collaboration, content sharing, and community building

## Tool Categories

### Board Management Tools

#### `searchBoardsTool`
- **ID**: `search-boards`
- **Purpose**: Search boards using semantic and keyword search capabilities
- **Features**:
  - Vector embedding-based semantic search
  - Keyword and metadata filtering
  - Advanced filters (visibility, dates, tags)
  - Hybrid search combining multiple methods
  - Relevance scoring and match explanations

#### `createBoardTool`
- **ID**: `create-board`
- **Purpose**: Create new boards with AI-powered assistance
- **Features**:
  - Intelligent theme detection and suggestion
  - Smart icon selection based on content
  - Automatic tag generation
  - Organization template recommendations
  - Theme variations and color palette suggestions

#### `analyzeBoardTool`
- **ID**: `analyze-board`
- **Purpose**: Comprehensive analysis of board content and performance
- **Features**:
  - Content distribution analysis
  - Visual theme identification
  - Organizational health scoring
  - Performance metrics and insights
  - Improvement recommendations

#### `suggestBoardOrganizationTool`
- **ID**: `suggest-board-organization`
- **Purpose**: Optimize board layout and organization
- **Features**:
  - Multiple organization strategies
  - Visual flow optimization
  - User experience improvement
  - Layout comparison and recommendations
  - Implementation guidance

### Asset Organization Tools

#### `searchAssetsTool`
- **ID**: `search-assets`
- **Purpose**: Multi-modal asset search with AI-powered understanding
- **Features**:
  - Semantic similarity search using vector embeddings
  - Computer vision-based visual search
  - Metadata and content analysis
  - Advanced filtering options
  - Hybrid ranking algorithms

#### `categorizeAssetsTool`
- **ID**: `categorize-assets`
- **Purpose**: Automatic asset categorization using AI
- **Features**:
  - Multiple categorization systems
  - Computer vision analysis
  - Content understanding and tagging
  - Confidence scoring
  - Batch processing capabilities

#### `findSimilarAssetsTool`
- **ID**: `find-similar-assets`
- **Purpose**: Find visually and semantically similar assets
- **Features**:
  - Multi-dimensional similarity matching
  - Visual feature comparison
  - Semantic understanding
  - Similarity clustering
  - Match explanation and reasoning

#### `generateAssetTagsTool`
- **ID**: `generate-asset-tags`
- **Purpose**: AI-powered tag generation for improved discoverability
- **Features**:
  - Multiple tag sources (visual, metadata, content)
  - Various tag types (descriptive, emotional, stylistic)
  - Custom vocabulary integration
  - Quality scoring and filtering
  - Batch tag generation

#### `organizeAssetsByThemeTool`
- **ID**: `organize-assets-by-theme`
- **Purpose**: Automatic thematic organization of asset collections
- **Features**:
  - AI-powered theme detection
  - Multiple organization methods
  - Hierarchical theme structures
  - Quality-based filtering
  - Collection suggestions

### Collaboration Tools

#### `suggestCollaboratorsTool`
- **ID**: `suggest-collaborators`
- **Purpose**: Find and recommend potential collaborators
- **Features**:
  - Expertise matching algorithms
  - Content-based compatibility analysis
  - Collaboration history evaluation
  - Multi-factor matching criteria
  - Communication preference matching

#### `generateBoardSummaryTool`
- **ID**: `generate-board-summary`
- **Purpose**: Generate comprehensive board summaries for sharing
- **Features**:
  - Multiple summary types and formats
  - Audience-specific customization
  - AI-powered content analysis
  - Collaboration insights
  - Multi-platform sharing optimization

#### `detectDuplicatesTool`
- **ID**: `detect-duplicates`
- **Purpose**: Find and manage duplicate content across boards
- **Features**:
  - Multiple detection methods
  - Visual similarity analysis
  - Metadata comparison
  - Automated cleanup suggestions
  - Quality-based conflict resolution

#### `mergeBoardsTool`
- **ID**: `merge-boards`
- **Purpose**: Intelligently merge multiple boards
- **Features**:
  - AI-powered organization strategies
  - Conflict resolution automation
  - Quality analysis and filtering
  - Theme-based organization
  - Comprehensive merge reporting

## Usage Examples

### Basic Tool Usage

```typescript
import { searchBoardsTool } from '@ai/mastra/tools/board';

// Search boards semantically
const searchResult = await searchBoardsTool.handler({
  query: 'urban photography collections',
  userId: 'user-123',
  searchType: 'semantic',
  limit: 10
});
```

### Advanced Asset Search

```typescript
import { searchAssetsTool } from '@ai/mastra/tools/asset';

// Multi-modal asset search with filters
const assets = await searchAssetsTool.handler({
  query: 'street photography with warm colors',
  userId: 'user-123',
  searchMethods: {
    semantic: true,
    visual: true,
    metadata: true
  },
  filters: {
    assetTypes: ['image'],
    visualAttributes: {
      brightness: 'medium',
      saturation: 'high'
    }
  }
});
```

### Collaboration Workflow

```typescript
import { 
  analyzeBoardTool,
  suggestCollaboratorsTool,
  generateBoardSummaryTool 
} from '@ai/mastra/tools';

// Analyze board and suggest collaborations
const analysis = await analyzeBoardTool.handler({
  boardId: 'board-123',
  userId: 'user-123',
  analysisDepth: 'comprehensive'
});

const collaborators = await suggestCollaboratorsTool.handler({
  boardId: 'board-123',
  userId: 'user-123',
  collaborationType: 'creative'
});

const summary = await generateBoardSummaryTool.handler({
  boardId: 'board-123',
  userId: 'user-123',
  summaryType: 'collaborative',
  audience: 'collaborator'
});
```

## Configuration

### Tool Registry

All tools are registered in the main index file and can be accessed via the `availableTools` registry:

```typescript
import { availableTools, toolCategories } from '@ai/mastra/tools';

// Access tool IDs
const searchBoardId = availableTools.searchBoards; // 'search-boards'

// Access tools by category
const boardTools = toolCategories.boardManagement;
const assetTools = toolCategories.assetOrganization;
const collabTools = toolCategories.collaboration;
```

### Integration with Agents

Tools can be integrated with Mastra agents:

```typescript
import { Agent } from '@mastra/core';
import { 
  searchBoardsTool, 
  searchAssetsTool, 
  suggestCollaboratorsTool 
} from '@ai/mastra/tools';

const squishAgent = new Agent({
  name: 'Squish Assistant',
  instructions: 'Help users manage their creative collections...',
  model: 'gpt-4',
  tools: [
    searchBoardsTool,
    searchAssetsTool,
    suggestCollaboratorsTool
  ]
});
```

## Development

### Adding New Tools

1. Create tool file in appropriate category directory
2. Follow the established patterns for input/output schemas
3. Implement comprehensive error handling
4. Add tool to category index file
5. Update main tools index
6. Add documentation

### Tool Structure

Each tool follows this structure:

```typescript
import { tool } from '@mastra/core/tool';
import { z } from 'zod';

export const myTool = tool({
  id: 'my-tool-id',
  description: 'Clear description of tool purpose and capabilities',
  inputSchema: z.object({
    // Define input parameters with descriptions
  }),
  outputSchema: z.object({
    // Define output structure with detailed schemas
  }),
  handler: async (input) => {
    try {
      // Implementation logic
      return result;
    } catch (error) {
      throw new Error(`Failed to execute tool: ${error}`);
    }
  },
});
```

### Best Practices

1. **Comprehensive Input Validation**: Use Zod schemas to validate all inputs
2. **Detailed Output Schemas**: Provide complete type definitions for outputs
3. **Error Handling**: Always wrap handler logic in try-catch blocks
4. **Documentation**: Include clear descriptions for all parameters
5. **Mock Data**: Provide realistic mock data for development and testing
6. **Performance**: Consider performance implications for large datasets
7. **Extensibility**: Design tools to be easily extended and modified

## Production Considerations

### Database Integration

In production, these tools would integrate with:

- PostgreSQL database via Drizzle ORM
- Vector embeddings stored in database
- File metadata and storage references
- User authentication and permissions

### AI Model Integration

Production implementation would include:

- Computer vision models for visual analysis
- Large language models for semantic understanding
- Vector embedding generation and similarity search
- Content analysis and natural language processing

### Performance Optimization

- Implement caching for frequently accessed data
- Use batch processing for large operations
- Optimize database queries with proper indexing
- Consider rate limiting for API endpoints

### Security and Privacy

- Implement proper user authorization
- Respect privacy settings for content analysis
- Secure handling of user data and metadata
- Audit logging for sensitive operations

## API Reference

For detailed API documentation including all input/output schemas, parameter descriptions, and usage examples, refer to the individual tool files in their respective directories:

- `./board/` - Board management tools
- `./asset/` - Asset organization tools  
- `./collaboration/` - Collaboration tools

Each tool file contains comprehensive JSDoc comments and TypeScript type definitions for full API documentation.
````

## File: apps/ai/src/mastra/types/runtime-context.ts
````typescript
export type SquishRuntimeContext = {
  'chat-model'?: string;
  'openai-api-key'?: string;
  'anthropic-api-key'?: string;
  'google-api-key'?: string;
  'openrouter-api-key'?: string;
  [key: string]: any;
};
````

## File: apps/ai/src/mastra/utils/loadPrompt.ts
````typescript
import { existsSync, readFileSync } from 'node:fs';
import path from 'node:path';

/**
 * Loads a prompt template from an XML file
 * @param relativePath The path relative to src/mastra
 * @param fallback A fallback template if the file can't be loaded
 * @param variables Optional variables for template substitution in paths
 * @returns The prompt template as a string
 */
export function loadPrompt(
  relativePath: string,
  fallback = '',
  variables: Record<string, string> = {}
): string {
  try {
    // Try multiple possible locations for the XML file
    // 1. First check direct path from repo root
    let xmlPath = path.join(process.cwd(), 'src/mastra', relativePath);

    // 2. If not found, try relative to app directory (for Next.js app)
    if (!existsSync(xmlPath)) {
      xmlPath = path.join(process.cwd(), '../../src/mastra', relativePath);
    }

    // 3. Try from current directory (for direct invocation)
    if (!existsSync(xmlPath)) {
      // In environments where __dirname is not defined, we'll use process.cwd()
      const dirPath =
        typeof __dirname !== 'undefined' ? __dirname : process.cwd();
      xmlPath = path.join(dirPath, '..', relativePath);
    }

    // 4. Go up a level if needed (for deeply nested imports)
    if (!existsSync(xmlPath)) {
      const dirPath =
        typeof __dirname !== 'undefined' ? __dirname : process.cwd();
      xmlPath = path.join(dirPath, '../..', relativePath);
    }

    // If we still can't find it, log detailed info to help debug
    if (!existsSync(xmlPath)) {
      const _dirPath =
        typeof __dirname !== 'undefined' ? __dirname : process.cwd();
      return fallback;
    }

    let template = readFileSync(xmlPath, 'utf-8');

    // Process includes - look for <include path="..." /> tags
    template = processIncludes(template, variables);

    return template;
  } catch (_error) {
    return fallback;
  }
}

/**
 * Process include directives in XML templates
 * @param template The template potentially containing includes
 * @param variables Variables for template substitution in include paths
 * @returns The processed template with includes expanded
 */
function processIncludes(
  template: string,
  variables: Record<string, string> = {}
): string {
  const includeRegex = /<include\s+path="([^"]+)"\s*\/>/g;

  return template.replace(includeRegex, (_match, includePath) => {
    try {
      // Apply variable substitution to the include path
      const processedPath = applyPathVariables(includePath, variables);

      // Try multiple possible locations for the included file
      const possiblePaths = [
        path.join(process.cwd(), 'src/mastra', processedPath),
        path.join(process.cwd(), '../../src/mastra', processedPath),
        path.join(process.cwd(), processedPath), // For data directory files
        path.join(process.cwd(), '../../', processedPath), // For data directory files from nested locations
      ];

      // Handle case where __dirname is not defined
      const dirPath =
        typeof __dirname !== 'undefined' ? __dirname : process.cwd();
      possiblePaths.push(path.join(dirPath, '..', processedPath));
      possiblePaths.push(path.join(dirPath, '../..', processedPath));
      possiblePaths.push(path.join(dirPath, '../../../..', processedPath)); // For data directory from deeply nested imports

      for (const p of possiblePaths) {
        if (existsSync(p)) {
          const includedContent = readFileSync(p, 'utf-8');

          // Extract just the content inside the root element (e.g., inside <tool_instructions>...</tool_instructions>)
          const contentMatch = includedContent.match(
            /<[^>]+>([\s\S]*)<\/[^>]+>/
          );
          if (contentMatch?.[1]) {
            return contentMatch[1].trim();
          }
          return includedContent;
        }
      }
      return `<!-- Include failed: File not found: ${processedPath} -->`;
    } catch (error) {
      return `<!-- Include failed: ${error instanceof Error ? error.message : String(error)} -->`;
    }
  });
}

/**
 * Apply variable substitution to a path string using {{variable}} syntax
 * @param pathString Path string with potential {{variable}} placeholders
 * @param variables Variables to substitute
 * @returns Processed path with variables replaced
 */
function applyPathVariables(
  pathString: string,
  variables: Record<string, string> = {}
): string {
  let result = pathString;

  // Replace {{variable}} with the corresponding value
  for (const [key, value] of Object.entries(variables)) {
    const placeholder = new RegExp(`{{${key}}}`, 'g');
    result = result.replace(placeholder, value);
  }

  return result;
}

/**
 * Fills a template with values from a context object
 * @param template The template string with {{placeholders}}
 * @param context An object with keys matching the placeholders
 * @returns The filled template
 */
export function fillTemplate(
  template: string,
  context: Record<string, any>
): string {
  let result = template;
  for (const key in context) {
    const placeholder = new RegExp(`{{${key}}}`, 'g');
    const value = context[key] !== undefined ? String(context[key]) : '';
    result = result.replace(placeholder, value);
  }
  return result;
}
````

## File: apps/ai/src/mastra/utils/models.ts
````typescript
// File: src/mastra/utils/models.ts

import { createVertex } from '@ai-sdk/google-vertex';
import type { LanguageModelV1 } from 'ai';
import { normalizeRuntimeContext } from './runtime-context-builder';

// Parse Google credentials from environment
function getGoogleAuthFromEnv() {
  const credentialsJson = process.env.GOOGLE_APPLICATION_CREDENTIALS;

  if (credentialsJson?.startsWith('{')) {
    // If GOOGLE_APPLICATION_CREDENTIALS contains JSON, we need to temporarily
    // unset it to prevent Google's auth library from treating it as a file path
    process.env.GOOGLE_APPLICATION_CREDENTIALS = undefined;

    try {
      const serviceAccount = JSON.parse(credentialsJson);
      return {
        googleAuthOptions: {
          credentials: {
            client_email: serviceAccount.client_email,
            private_key: serviceAccount.private_key.replace(/\\n/g, '\n'),
            private_key_id: serviceAccount.private_key_id,
          },
        },
      };
    } catch (_error) {}
  }

  return {};
}

// Streamlined to use only Vertex AI with Gemini models
export function createModelFromContext({
  runtimeContext,
  defaultModelId = 'gemini-2.0-flash-exp',
}: {
  runtimeContext: any;
  defaultModelId?: string;
}): LanguageModelV1 {
  const normalizedContext = normalizeRuntimeContext(runtimeContext);
  const modelId = normalizedContext.get('chat-model') || defaultModelId;

  // Get credentials and config
  const googleAuth = getGoogleAuthFromEnv();
  const project =
    process.env.GOOGLE_CLOUD_PROJECT ||
    process.env.GOOGLE_VERTEX_PROJECT ||
    'squish-441207';
  const location =
    process.env.GOOGLE_CLOUD_LOCATION ||
    process.env.GOOGLE_VERTEX_LOCATION ||
    'us-central1';

  // Create vertex provider with auth
  const vertexProvider = createVertex({
    project,
    location,
    ...googleAuth,
  });

  // Ensure we're using a Gemini model
  if (!modelId.startsWith('gemini-')) {
    return vertexProvider(defaultModelId);
  }

  return vertexProvider(modelId);
}
````

## File: apps/ai/src/mastra/utils/runtime-context-builder.ts
````typescript
/**
 * Normalizes runtime context to ensure consistent access
 * Returns an object with a get method that works for both RuntimeContext instances and plain objects
 */
export function normalizeRuntimeContext(runtimeContext: any): {
  get: (key: string) => any;
} {
  if (!runtimeContext) {
    return { get: () => undefined };
  }

  // If it already has a get method, return as-is
  if (typeof runtimeContext.get === 'function') {
    return runtimeContext;
  }

  // Create a wrapper with get method for plain objects
  return {
    get: (key: string) => runtimeContext[key],
  };
}

/**
 * Helper to access runtime context values that works with both
 * RuntimeContext instances (with get method) and plain objects
 */
export function getRuntimeContextValue<K extends string>(
  runtimeContext: any,
  key: K
): any {
  if (!runtimeContext) {
    return undefined;
  }

  // Try get method first (RuntimeContext instance)
  if (typeof runtimeContext.get === 'function') {
    return runtimeContext.get(key);
  }

  // Fall back to direct property access (plain object)
  return runtimeContext[key];
}

/**
 * Creates a runtime context object from a plain object
 */
export function createRuntimeContext(context: Record<string, any>) {
  return normalizeRuntimeContext(context);
}
````

## File: apps/ai/src/mastra/workflows/content-analysis/index.ts
````typescript
import { createStep, createWorkflow } from '@mastra/core';
import {
  analyzeContentInputSchema,
  analyzeContentOutputSchema,
} from './schema';

// Content analysis step
const contentAnalysisStep = createStep({
  id: 'content-analysis',
  description:
    'Analyzes content and extracts personality, themes, and visual data',
  inputSchema: analyzeContentInputSchema,
  outputSchema: analyzeContentOutputSchema,
  execute: async ({ inputData }) => {
    const { contentUrl, contentType, metadata } = inputData;

    // Simplified workflow implementation
    return {
      personality: {
        description: 'Engaging content perfect for social discovery',
        emoji: '‚ú®',
        mood: 'vibrant',
        themes: ['social', 'creative', 'trending'],
        vibe: 'squish magic',
      },
      embedding: Array.from({ length: 768 }, () => Math.random() - 0.5),
      contentHash: `hash_${Date.now()}`,
      keyWords: ['modern', 'creative', 'viral', contentType],
      colorAnalysis: {
        dominant: ['warm', 'vivid', 'expressive'],
        palette: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57'],
      },
      processingTime: 150,
      success: true,
    };
  },
});

// Simple workflow for content analysis - more focused approach
export const analyzeContentWorkflow = createWorkflow({
  id: 'analyzeContent',
  description:
    'Complete content analysis workflow for squish content discovery',
  inputSchema: analyzeContentInputSchema,
  outputSchema: analyzeContentOutputSchema,
  steps: [contentAnalysisStep],
})
  .then(contentAnalysisStep)
  .commit();

export default analyzeContentWorkflow;
````

## File: apps/ai/src/mastra/workflows/content-analysis/schema.ts
````typescript
import { z } from 'zod';

// Input schema for content analysis workflow
export const analyzeContentInputSchema = z.object({
  contentUrl: z.string().describe('URL or path to the content to analyze'),
  contentType: z
    .enum(['image', 'video', 'audio', 'text', 'gif'])
    .describe('Type of content'),
  mimeType: z.string().optional().describe('MIME type of the content'),
  metadata: z
    .record(z.any())
    .optional()
    .describe('Additional metadata like creator, date, etc.'),
});

// Output schema for content analysis workflow
export const analyzeContentOutputSchema = z.object({
  personality: z.object({
    description: z.string(),
    emoji: z.string(),
    mood: z.string(),
    themes: z.array(z.string()),
    vibe: z.string(),
  }),
  embedding: z.array(z.number()),
  contentHash: z.string(),
  keyWords: z.array(z.string()),
  colorAnalysis: z
    .object({
      dominant: z.array(z.string()).optional(),
      palette: z.array(z.string()).optional(),
    })
    .optional(),
  processingTime: z.number(),
  success: z.boolean(),
});

export type AnalyzeContentInput = z.infer<typeof analyzeContentInputSchema>;
export type AnalyzeContentOutput = z.infer<typeof analyzeContentOutputSchema>;
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/multimodal-analysis/index.ts
````typescript
import { createStep } from '@mastra/core';
import {
  multimodalAnalysisInputSchema,
  multimodalAnalysisOutputSchema,
} from './schema';

export const multimodalAnalysisStep = createStep({
  id: 'multimodal-analysis',
  description: 'Analyzes multimodal content from files',
  inputSchema: multimodalAnalysisInputSchema,
  outputSchema: multimodalAnalysisOutputSchema,
  execute: async ({ inputData, mastra, runtimeContext }) => {
    const { query, enhancedQuery, files, limit, startTime } = inputData;

    const fileAnalyses = [];

    if (files && files.length > 0) {
      const contentAnalysisAgent = mastra?.getAgent('contentAnalysis');

      if (!contentAnalysisAgent) {
        return {
          ...inputData,
          fileAnalyses: [],
        };
      }

      for (const file of files.slice(0, 3)) {
        // Limit to 3 files
        try {
          const messages = [
            {
              role: 'user' as const,
              content: `Analyze this ${file.type} content: ${file.url}`,
            },
          ];

          const analysis = await contentAnalysisAgent.generate(messages, {
            runtimeContext,
          });

          fileAnalyses.push({
            url: file.url,
            type: file.type,
            analysis: analysis.text,
          });
        } catch (_error) {}
      }
    }

    return {
      query,
      enhancedQuery,
      files,
      fileAnalyses,
      limit,
      startTime,
    };
  },
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/multimodal-analysis/schema.ts
````typescript
import { z } from 'zod';

export const multimodalAnalysisInputSchema = z.object({
  query: z.string(),
  enhancedQuery: z.string(),
  files: z
    .array(
      z.object({
        url: z.string(),
        type: z.enum(['image', 'video', 'audio']),
        mimeType: z.string().optional(),
      })
    )
    .optional(),
  limit: z.number(),
  startTime: z.number(),
});

export const multimodalAnalysisOutputSchema = z.object({
  query: z.string(),
  enhancedQuery: z.string(),
  files: z
    .array(
      z.object({
        url: z.string(),
        type: z.enum(['image', 'video', 'audio']),
        mimeType: z.string().optional(),
      })
    )
    .optional(),
  fileAnalyses: z
    .array(
      z.object({
        url: z.string(),
        type: z.string(),
        analysis: z.string().optional(),
      })
    )
    .optional(),
  limit: z.number(),
  startTime: z.number(),
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/query-enhancement/index.ts
````typescript
import { createStep } from '@mastra/core';
import {
  queryEnhancementInputSchema,
  queryEnhancementOutputSchema,
} from './schema';

export const queryEnhancementStep = createStep({
  id: 'query-enhancement',
  description: 'Enhances search query using AI agent',
  inputSchema: queryEnhancementInputSchema,
  outputSchema: queryEnhancementOutputSchema,
  execute: async ({ inputData, mastra, runtimeContext }) => {
    const startTime = Date.now();
    const { query, files, limit } = inputData;

    try {
      const searchEnhancerAgent = mastra?.getAgent('searchEnhancer');

      if (!searchEnhancerAgent) {
        return {
          query,
          enhancedQuery: query,
          files,
          limit,
          startTime,
        };
      }

      const messages = [
        {
          role: 'user' as const,
          content: `Enhance this search query for better results: "${query}"`,
        },
      ];

      const enhanced = await searchEnhancerAgent.generate(messages, {
        runtimeContext,
      });

      const enhancedQuery = enhanced.text || query;

      return {
        query,
        enhancedQuery,
        files,
        limit,
        startTime,
      };
    } catch (_error) {
      return {
        query,
        enhancedQuery: query,
        files,
        limit,
        startTime,
      };
    }
  },
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/query-enhancement/schema.ts
````typescript
import { z } from 'zod';

export const queryEnhancementInputSchema = z.object({
  query: z.string().describe('User search query'),
  files: z
    .array(
      z.object({
        url: z.string(),
        type: z.enum(['image', 'video', 'audio']),
        mimeType: z.string().optional(),
      })
    )
    .optional()
    .describe('Multimodal search files'),
  limit: z.number().optional().default(10),
});

export const queryEnhancementOutputSchema = z.object({
  query: z.string(),
  enhancedQuery: z.string(),
  files: z
    .array(
      z.object({
        url: z.string(),
        type: z.enum(['image', 'video', 'audio']),
        mimeType: z.string().optional(),
      })
    )
    .optional(),
  limit: z.number(),
  startTime: z.number(),
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/response-generation/index.ts
````typescript
import { createStep } from '@mastra/core';
import {
  responseGenerationInputSchema,
  responseGenerationOutputSchema,
} from './schema';

export const responseGenerationStep = createStep({
  id: 'response-generation',
  description: 'Generates final response based on search results',
  inputSchema: responseGenerationInputSchema,
  outputSchema: responseGenerationOutputSchema,
  execute: async ({ inputData, mastra, runtimeContext }) => {
    const { enhancedQuery, results, startTime } = inputData;

    try {
      const contentAnalysisAgent = mastra?.getAgent('contentAnalysis');

      if (!contentAnalysisAgent) {
        return {
          enhancedQuery,
          results,
          generatedResponse: `Found ${results.length} results for your search.`,
          processingTime: Date.now() - startTime,
        };
      }

      // Prepare context for generation
      const contextText = results
        .map(
          (result, index) =>
            `${index + 1}. ${result.name}: ${result.description}`
        )
        .join('\n');

      const messages = [
        {
          role: 'system' as const,
          content:
            'You are a helpful assistant that provides informative responses based on search results.',
        },
        {
          role: 'user' as const,
          content: `Based on these search results for "${enhancedQuery}":\n\n${contextText}\n\nProvide a helpful summary.`,
        },
      ];

      const response = await contentAnalysisAgent.generate(messages, {
        runtimeContext,
      });

      return {
        enhancedQuery,
        results,
        generatedResponse: response.text || 'Here are your search results.',
        processingTime: Date.now() - startTime,
      };
    } catch (_error) {
      return {
        enhancedQuery,
        results,
        generatedResponse: `Found ${results.length} results for your search.`,
        processingTime: Date.now() - startTime,
      };
    }
  },
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/response-generation/schema.ts
````typescript
import { z } from 'zod';

export const responseGenerationInputSchema = z.object({
  query: z.string(),
  enhancedQuery: z.string(),
  results: z.array(
    z.object({
      id: z.string(),
      name: z.string(),
      description: z.string(),
      relevanceScore: z.number(),
      metadata: z.record(z.any()).optional(),
    })
  ),
  startTime: z.number(),
});

export const responseGenerationOutputSchema = z.object({
  enhancedQuery: z.string(),
  results: z.array(
    z.object({
      id: z.string(),
      name: z.string(),
      description: z.string(),
      relevanceScore: z.number(),
      metadata: z.record(z.any()).optional(),
    })
  ),
  generatedResponse: z.string(),
  processingTime: z.number(),
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/result-generation/index.ts
````typescript
import { createStep } from '@mastra/core';
import {
  resultGenerationInputSchema,
  resultGenerationOutputSchema,
} from './schema';

export const resultGenerationStep = createStep({
  id: 'result-generation',
  description: 'Generates search results based on query and file analyses',
  inputSchema: resultGenerationInputSchema,
  outputSchema: resultGenerationOutputSchema,
  execute: async ({ inputData }) => {
    const { query, enhancedQuery, fileAnalyses, startTime } = inputData;

    // In a real implementation, this would do vector search
    // For now, generate mock results based on the query
    const mockResults: Array<{
      id: string;
      name: string;
      description: string;
      relevanceScore: number;
      metadata?: Record<string, any>;
    }> = [
      {
        id: `result-${Date.now()}-1`,
        name: `Result for: ${enhancedQuery}`,
        description: 'This is a relevant result based on your search query',
        relevanceScore: 0.95,
        metadata: { source: 'text-search' },
      },
    ];

    // Add results from file analyses
    fileAnalyses?.forEach((analysis, index) => {
      mockResults.push({
        id: `result-${Date.now()}-file-${index}`,
        name: `${analysis.type} Analysis`,
        description: analysis.analysis || 'Content analyzed successfully',
        relevanceScore: 0.9 - index * 0.05,
        metadata: {
          source: 'file-analysis',
          type: analysis.type,
          url: analysis.url,
        },
      });
    });

    return {
      query,
      enhancedQuery,
      results: mockResults.slice(0, inputData.limit),
      startTime,
    };
  },
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/steps/result-generation/schema.ts
````typescript
import { z } from 'zod';

export const resultGenerationInputSchema = z.object({
  query: z.string(),
  enhancedQuery: z.string(),
  files: z
    .array(
      z.object({
        url: z.string(),
        type: z.enum(['image', 'video', 'audio']),
        mimeType: z.string().optional(),
      })
    )
    .optional(),
  fileAnalyses: z
    .array(
      z.object({
        url: z.string(),
        type: z.string(),
        analysis: z.string().optional(),
      })
    )
    .optional(),
  limit: z.number(),
  startTime: z.number(),
});

export const resultGenerationOutputSchema = z.object({
  query: z.string(),
  enhancedQuery: z.string(),
  results: z.array(
    z.object({
      id: z.string(),
      name: z.string(),
      description: z.string(),
      relevanceScore: z.number(),
      metadata: z.record(z.any()).optional(),
    })
  ),
  startTime: z.number(),
});
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/index.ts
````typescript
import { createWorkflow } from '@mastra/core';
import { multimodalRagInputSchema, multimodalRagOutputSchema } from './schema';
import { multimodalAnalysisStep } from './steps/multimodal-analysis';
import { queryEnhancementStep } from './steps/query-enhancement';
import { responseGenerationStep } from './steps/response-generation';
import { resultGenerationStep } from './steps/result-generation';

/**
 * Multimodal RAG Workflow
 * Simplified retrieval augmented generation for enhanced search
 *
 * Steps:
 * 1. queryEnhancementStep - Enhances the user query using AI
 * 2. multimodalAnalysisStep - Analyzes multimodal content from files
 * 3. resultGenerationStep - Generates search results
 * 4. responseGenerationStep - Creates final response based on results
 */
export const multimodalRagWorkflow = createWorkflow({
  id: 'multimodal-rag',
  description:
    'Query enhancement, multimodal retrieval, and contextual generation',
  inputSchema: multimodalRagInputSchema,
  outputSchema: multimodalRagOutputSchema,
  steps: [
    queryEnhancementStep,
    multimodalAnalysisStep,
    resultGenerationStep,
    responseGenerationStep,
  ],
})
  .then(queryEnhancementStep)
  .then(multimodalAnalysisStep)
  .then(resultGenerationStep)
  .then(responseGenerationStep)
  .commit();

export default multimodalRagWorkflow;
````

## File: apps/ai/src/mastra/workflows/multimodal-rag/schema.ts
````typescript
import { z } from 'zod';

export const multimodalRagInputSchema = z.object({
  query: z.string().describe('User search query'),
  files: z
    .array(
      z.object({
        url: z.string(),
        type: z.enum(['image', 'video', 'audio']),
        mimeType: z.string().optional(),
      })
    )
    .optional()
    .describe('Multimodal search files'),
  limit: z.number().optional().default(10),
});

export const multimodalRagOutputSchema = z.object({
  enhancedQuery: z.string(),
  results: z.array(
    z.object({
      id: z.string(),
      name: z.string(),
      description: z.string(),
      relevanceScore: z.number(),
      metadata: z.record(z.any()).optional(),
    })
  ),
  generatedResponse: z.string(),
  processingTime: z.number(),
});
````

## File: apps/ai/src/mastra/workflows/index.ts
````typescript
import { analyzeContentWorkflow } from './content-analysis';
import { multimodalRagWorkflow } from './multimodal-rag';

// Export workflows directly and via registry
export { analyzeContentWorkflow } from './content-analysis';
export { multimodalRagWorkflow } from './multimodal-rag';

// Registry object for Mastra
export const availableWorkflows = {
  analyzeContent: analyzeContentWorkflow,
  multimodalRag: multimodalRagWorkflow,
};
````

## File: apps/ai/src/mastra/cache-integration.ts
````typescript
import { aiCache, cacheUtils, CacheAside } from './lib/cache';
import { aiServiceClient } from './lib/orpc-client';

/**
 * Cache integration for Mastra tools
 * Optimizes performance by caching frequently accessed data
 */

/**
 * Cached ORPC client wrapper
 */
export class CachedAIServiceClient {
  private boardCache: CacheAside<any>;
  private assetCache: CacheAside<any>;
  private userCache: CacheAside<any>;
  
  constructor(private client: typeof aiServiceClient) {
    // Initialize cache-aside patterns for different entities
    this.boardCache = new CacheAside(
      aiCache,
      (boardId: string) => this.client.getBoard(boardId),
      { ttl: 600000, keyPrefix: 'board' } // 10 minutes
    );
    
    this.assetCache = new CacheAside(
      aiCache,
      (assetId: string) => this.client.getAsset(assetId),
      { ttl: 600000, keyPrefix: 'asset' }
    );
    
    this.userCache = new CacheAside(
      aiCache,
      (userId: string) => this.client.getUser(userId),
      { ttl: 1800000, keyPrefix: 'user' } // 30 minutes
    );
  }
  
  /**
   * Cached board operations
   */
  async getBoard(boardId: string, userId?: string): Promise<any> {
    return this.boardCache.get(boardId);
  }
  
  async getBoardAssets(boardId: string): Promise<any[]> {
    const cacheKey = `board-assets:${boardId}`;
    
    // Check cache
    const cached = await aiCache.get(cacheKey);
    if (cached) return cached;
    
    // Fetch from API
    const assets = await this.client.getBoardAssets(boardId);
    
    // Cache for 5 minutes
    await aiCache.set(cacheKey, assets, 300000);
    
    return assets;
  }
  
  /**
   * Cached search with smart invalidation
   */
  async searchBoards(query: string, filters?: any): Promise<any> {
    // Check if we have cached embeddings for this query
    const cachedEmbeddings = await aiCache.getCachedEmbeddings(query);
    
    // Check search cache
    const cachedResults = await aiCache.getCachedSearchResults(
      query,
      'board',
      filters
    );
    
    if (cachedResults && Date.now() - cachedResults.timestamp < 300000) {
      return cachedResults.results;
    }
    
    // Perform search
    const results = await this.client.searchBoards(query, filters);
    
    // Cache results
    await aiCache.cacheSearchResults(query, 'board', filters, results);
    
    return results;
  }
  
  /**
   * Cached asset operations
   */
  async getAsset(assetId: string): Promise<any> {
    return this.assetCache.get(assetId);
  }
  
  async searchAssets(query: string, boardId?: string): Promise<any> {
    const filters = { boardId };
    
    // Check search cache
    const cachedResults = await aiCache.getCachedSearchResults(
      query,
      'asset',
      filters
    );
    
    if (cachedResults) return cachedResults.results;
    
    // Perform search
    const results = await this.client.searchAssets(query, boardId);
    
    // Cache results
    await aiCache.cacheSearchResults(query, 'asset', filters, results);
    
    return results;
  }
  
  /**
   * Cached user operations
   */
  async getUser(userId?: string): Promise<any> {
    if (!userId) return this.client.getUser(userId);
    return this.userCache.get(userId);
  }
  
  async getUserStats(userId?: string): Promise<any> {
    const cacheKey = `user-stats:${userId || 'current'}`;
    
    // Check cache
    const cached = await aiCache.get(cacheKey);
    if (cached) return cached;
    
    // Fetch from API
    const stats = await this.client.getUserStats(userId);
    
    // Cache for 10 minutes
    await aiCache.set(cacheKey, stats, 600000);
    
    return stats;
  }
  
  /**
   * Batch operations with caching
   */
  async batchGetBoards(boardIds: string[]): Promise<Map<string, any>> {
    return cacheUtils.batchGet(
      boardIds,
      async (ids) => {
        const boards = await Promise.all(
          ids.map(id => this.client.getBoard(id))
        );
        const map = new Map<string, any>();
        boards.forEach((board, i) => map.set(ids[i], board));
        return map;
      }
    );
  }
  
  async batchGetAssets(assetIds: string[]): Promise<Map<string, any>> {
    return cacheUtils.batchGet(
      assetIds,
      async (ids) => {
        const assets = await Promise.all(
          ids.map(id => this.client.getAsset(id))
        );
        const map = new Map<string, any>();
        assets.forEach((asset, i) => map.set(ids[i], asset));
        return map;
      }
    );
  }
  
  /**
   * Cache invalidation methods
   */
  async invalidateBoard(boardId: string): Promise<void> {
    await this.boardCache.invalidate(boardId);
    await aiCache.delete(`board-assets:${boardId}`);
    await aiCache.invalidate(`search:board:`);
  }
  
  async invalidateAsset(assetId: string): Promise<void> {
    await this.assetCache.invalidate(assetId);
    await aiCache.invalidate(`search:asset:`);
  }
  
  async invalidateUser(userId: string): Promise<void> {
    await this.userCache.invalidate(userId);
    await aiCache.delete(`user-stats:${userId}`);
  }
  
  /**
   * Preload cache with predicted content
   */
  async preloadCache(strategy: 'popular' | 'recent' | 'user-based', userId?: string): Promise<void> {
    switch (strategy) {
      case 'popular':
        // Preload popular boards and assets
        const popularBoards = await this.client.enhancedSearch({
          query: '',
          type: 'board',
          limit: 20,
        });
        
        for (const board of popularBoards.boards || []) {
          await this.boardCache.get(board.id);
        }
        break;
        
      case 'recent':
        // Preload recently accessed content
        if (userId) {
          const recentAssets = await this.client.getUserRecentAssets(userId, 10);
          for (const asset of recentAssets) {
            await this.assetCache.get(asset.id);
          }
        }
        break;
        
      case 'user-based':
        // Preload based on user preferences
        if (userId) {
          const userContext = await aiCache.getCachedUserContext(userId);
          if (userContext?.frequentBoards) {
            await this.batchGetBoards(userContext.frequentBoards);
          }
        }
        break;
    }
  }
}

/**
 * Create cached Mastra tool wrapper
 */
export function createCachedTool(tool: any) {
  const cachedClient = new CachedAIServiceClient(aiServiceClient);
  
  return {
    ...tool,
    execute: cacheUtils.memoize(
      async (context: any) => {
        // Replace client calls with cached versions
        const originalClient = (global as any).aiServiceClient;
        (global as any).aiServiceClient = cachedClient;
        
        try {
          const result = await tool.execute({ context });
          return result;
        } finally {
          // Restore original client
          (global as any).aiServiceClient = originalClient;
        }
      },
      {
        ttl: 300000, // 5 minutes
        keyGenerator: (context) => `tool:${tool.id}:${JSON.stringify(context)}`,
      }
    ),
  };
}

/**
 * Embedding cache service
 */
export class EmbeddingCacheService {
  /**
   * Get embeddings with caching
   */
  async getEmbeddings(text: string): Promise<number[]> {
    // Check cache first
    const cached = await aiCache.getCachedEmbeddings(text);
    if (cached) return cached;
    
    // Generate embeddings (this would call your embedding service)
    const embeddings = await this.generateEmbeddings(text);
    
    // Cache for future use
    await aiCache.cacheEmbeddings(text, embeddings);
    
    return embeddings;
  }
  
  /**
   * Batch get embeddings with caching
   */
  async batchGetEmbeddings(texts: string[]): Promise<Map<string, number[]>> {
    const results = new Map<string, number[]>();
    const uncached: string[] = [];
    
    // Check cache for each text
    for (const text of texts) {
      const cached = await aiCache.getCachedEmbeddings(text);
      if (cached) {
        results.set(text, cached);
      } else {
        uncached.push(text);
      }
    }
    
    // Generate embeddings for uncached texts
    if (uncached.length > 0) {
      const embeddings = await this.batchGenerateEmbeddings(uncached);
      
      // Cache and add to results
      for (let i = 0; i < uncached.length; i++) {
        const text = uncached[i];
        const embedding = embeddings[i];
        await aiCache.cacheEmbeddings(text, embedding);
        results.set(text, embedding);
      }
    }
    
    return results;
  }
  
  private async generateEmbeddings(text: string): Promise<number[]> {
    // This would call your actual embedding service
    return Array(768).fill(0).map(() => Math.random());
  }
  
  private async batchGenerateEmbeddings(texts: string[]): Promise<number[][]> {
    // This would call your actual embedding service
    return texts.map(() => Array(768).fill(0).map(() => Math.random()));
  }
}

/**
 * Cache warming service
 */
export class CacheWarmingService {
  private warmingInterval: NodeJS.Timeout | null = null;
  
  /**
   * Start cache warming
   */
  startWarming(intervalMs: number = 300000) {
    this.warmingInterval = setInterval(async () => {
      await this.warmCache();
    }, intervalMs);
  }
  
  /**
   * Stop cache warming
   */
  stopWarming() {
    if (this.warmingInterval) {
      clearInterval(this.warmingInterval);
      this.warmingInterval = null;
    }
  }
  
  private async warmCache() {
    try {
      // Warm different cache strategies
      await aiCache.warmCache('popular');
      await aiCache.warmCache('recent');
      
      // Log cache stats
      const stats = aiCache.getStats();
      console.log('Cache stats:', stats);
    } catch (error) {
      console.error('Cache warming failed:', error);
    }
  }
}

// Export singleton instances
export const cachedClient = new CachedAIServiceClient(aiServiceClient);
export const embeddingCache = new EmbeddingCacheService();
export const cacheWarmer = new CacheWarmingService();

// Start cache warming in production
if (process.env.NODE_ENV === 'production') {
  cacheWarmer.startWarming();
}
````

## File: apps/ai/src/mastra/index.ts
````typescript
/**
 * Mastra Configuration
 * Ready for deployment to Mastra Cloud
 * AI SDK v5 Beta Support
 */

import { Mastra } from '@mastra/core';
import { PinoLogger } from '@mastra/loggers';
import { createPostgresStorage } from './lib/storage/postgres';

// Import agents
import contentAnalysisAgent from './agents/content-analysis';
import searchEnhancerAgent from './agents/search-enhancer';
import { squishChatAgent } from './agents/squish-chat';
import { boardAgent } from './agents/board-agent';
import { assetAgent } from './agents/asset-agent';
import { collaborationAgent } from './agents/collaboration-agent';

// Import workflows
import { availableWorkflows } from './workflows';

// Logger configuration
const logger = new PinoLogger({
  name: 'squish-ai',
  level:
    (process.env.LOG_LEVEL as 'debug' | 'info' | 'warn' | 'error') || 'info',
});

// Storage configuration
const { storage, vectorDB } = createPostgresStorage();

// Create and export Mastra instance - fully migrated to AI SDK v5
export const mastra: Mastra = new Mastra({
  workflows: availableWorkflows,
  agents: {
    contentAnalysis: contentAnalysisAgent,
    searchEnhancer: searchEnhancerAgent,
    squishChat: squishChatAgent,
    board: boardAgent,
    asset: assetAgent,
    collaboration: collaborationAgent,
  },
  logger,
  storage,
  vectorDB,
  server: {
    middleware: [
      // Runtime context middleware for v5 patterns
      async (c, next) => {
        const runtimeContext = c.get('runtimeContext');

        if (c.req.method === 'POST') {
          try {
            const contentType = c.req.header('content-type');
            if (contentType?.includes('application/json')) {
              const clonedReq = c.req.raw.clone();
              const body = await clonedReq.json();

              // Extract data from v5 messages format
              if (body?.data) {
                for (const [key, value] of Object.entries(body.data)) {
                  runtimeContext.set(key, value);
                }
              }
            }
          } catch (_error) {}
        }

        await next();
      },
    ],
  },
});

// Export individual components for direct access
export {
  contentAnalysisAgent,
  searchEnhancerAgent,
  squishChatAgent,
  boardAgent,
  assetAgent,
  collaborationAgent,
};

// Export utilities for runtime context management
export { normalizeRuntimeContext } from './utils/runtime-context-builder';

// Export schemas for type safety
export * from './schemas';
export * from './types/runtime-context';
````

## File: apps/ai/src/mastra/streaming-integration.ts
````typescript
import { streamHandler, sseHandler } from './lib/streaming';
import { aiServiceClient } from './lib/orpc-client';

/**
 * Streaming integration for Mastra tools
 * Enables real-time streaming capabilities for AI operations
 */

/**
 * Create a streaming wrapper for Mastra tools
 */
export function createStreamingTool(tool: any) {
  return {
    ...tool,
    executeStream: async function* (context: any) {
      const { toolId } = tool;
      
      // Start streaming response
      const stream = await streamHandler.streamToolResponse(
        toolId,
        context.query || context.prompt || '',
        context,
        {
          model: 'gemini-pro',
          temperature: 0.7,
          tools: tool.availableTools,
        }
      );

      // Yield chunks as they arrive
      for await (const chunk of stream.textStream) {
        yield {
          type: 'text',
          content: chunk,
        };
      }

      // Execute the actual tool
      const result = await tool.execute({ context });
      
      yield {
        type: 'result',
        data: result,
      };
    },
  };
}

/**
 * Streaming search with progressive results
 */
export async function* streamingSearch(
  query: string,
  searchType: 'boards' | 'assets' | 'users' | 'all',
  options: {
    userId?: string;
    filters?: any;
    limit?: number;
  } = {}
) {
  const results = new Map<string, any>();
  
  // Phase 1: Quick local search
  yield {
    phase: 'quick_search',
    status: 'started',
  };
  
  const quickResults = await aiServiceClient.enhancedSearch({
    query,
    type: searchType,
    filters: options.filters,
    limit: options.limit || 10,
  });
  
  for (const result of quickResults.results || []) {
    results.set(result.id, result);
    yield {
      phase: 'quick_search',
      type: 'result',
      data: result,
    };
  }
  
  // Phase 2: Semantic search
  yield {
    phase: 'semantic_search',
    status: 'started',
  };
  
  await streamHandler.streamSearchResults(
    query,
    searchType as any,
    (result) => {
      if (result.type === 'semantic' && !results.has(result.data.id)) {
        results.set(result.data.id, result.data);
        // This would need to be yielded through a different mechanism
        // Since we can't yield from a callback
      }
    }
  );
  
  // Phase 3: AI-enhanced results
  yield {
    phase: 'ai_enhancement',
    status: 'started',
  };
  
  // Enhance existing results with AI
  const enhancedResults = Array.from(results.values()).map(result => ({
    ...result,
    aiScore: Math.random() * 0.3 + 0.7,
    aiInsights: [
      'High relevance to query',
      'Popular with similar users',
      'Trending in category',
    ],
  }));
  
  for (const result of enhancedResults) {
    yield {
      phase: 'ai_enhancement',
      type: 'enhanced_result',
      data: result,
    };
  }
  
  yield {
    phase: 'complete',
    totalResults: results.size,
    finalResults: Array.from(results.values()),
  };
}

/**
 * Streaming board analysis with progressive insights
 */
export async function* streamingBoardAnalysis(
  boardId: string,
  userId: string,
  analysisDepth: 'basic' | 'detailed' | 'comprehensive' = 'detailed'
) {
  // Phase 1: Basic metrics
  yield {
    phase: 'basic_metrics',
    status: 'analyzing',
  };
  
  const board = await aiServiceClient.getBoard(boardId, userId);
  const assets = await aiServiceClient.getBoardAssets(boardId);
  
  yield {
    phase: 'basic_metrics',
    data: {
      totalAssets: assets.length,
      boardName: board.name,
      visibility: board.visibility,
      createdAt: board.createdAt,
    },
  };
  
  // Phase 2: Content analysis
  if (analysisDepth !== 'basic') {
    yield {
      phase: 'content_analysis',
      status: 'analyzing',
    };
    
    const assetTypes = assets.reduce((acc: any, asset: any) => {
      acc[asset.type] = (acc[asset.type] || 0) + 1;
      return acc;
    }, {});
    
    yield {
      phase: 'content_analysis',
      data: {
        assetDistribution: assetTypes,
        dominantType: Object.entries(assetTypes).sort((a: any, b: any) => b[1] - a[1])[0]?.[0],
      },
    };
  }
  
  // Phase 3: AI insights
  if (analysisDepth === 'comprehensive') {
    yield {
      phase: 'ai_insights',
      status: 'generating',
    };
    
    // Stream AI-generated insights
    const insightStream = await streamHandler.streamToolResponse(
      'analyze-board',
      `Analyze the board "${board.name}" with ${assets.length} assets`,
      { boardId, userId, assets: assets.slice(0, 5) },
      { model: 'gemini-pro' }
    );
    
    for await (const chunk of insightStream.textStream) {
      yield {
        phase: 'ai_insights',
        type: 'text',
        content: chunk,
      };
    }
  }
  
  yield {
    phase: 'complete',
    summary: {
      boardId,
      analysisDepth,
      timestamp: new Date().toISOString(),
    },
  };
}

/**
 * Streaming collaboration suggestions
 */
export async function* streamingCollaboratorSuggestions(
  boardId: string,
  userId: string,
  preferences: any = {}
) {
  const suggestions = new Map<string, any>();
  
  // Stream suggestions progressively
  yield {
    phase: 'analyzing_preferences',
    status: 'started',
  };
  
  // Get user profile and board content
  const [user, board] = await Promise.all([
    aiServiceClient.getUser(userId),
    aiServiceClient.getBoard(boardId, userId),
  ]);
  
  yield {
    phase: 'analyzing_preferences',
    data: {
      userInterests: ['photography', 'design', 'art'],
      boardThemes: ['urban', 'architecture', 'creative'],
    },
  };
  
  // Stream collaborator suggestions by relevance
  const streamId = await streamHandler.streamCollaborationSuggestions(
    boardId,
    userId,
    (suggestion) => {
      if (!suggestions.has(suggestion.userId)) {
        suggestions.set(suggestion.userId, suggestion);
        // Would need to yield through a different mechanism
      }
    }
  );
  
  // Mock some suggestions for demonstration
  const mockSuggestions = [
    {
      userId: 'user-1',
      username: 'creative_alex',
      matchScore: 0.92,
      expertise: ['photography', 'editing'],
      reason: 'Similar artistic style and interests',
    },
    {
      userId: 'user-2',
      username: 'design_maria',
      matchScore: 0.87,
      expertise: ['graphic_design', 'branding'],
      reason: 'Complementary skills for your projects',
    },
  ];
  
  for (const suggestion of mockSuggestions) {
    yield {
      phase: 'finding_matches',
      type: 'suggestion',
      data: suggestion,
    };
    
    // Simulate progressive loading
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  yield {
    phase: 'complete',
    totalSuggestions: mockSuggestions.length,
    topMatch: mockSuggestions[0],
  };
}

/**
 * Create SSE endpoint for real-time updates
 */
export function createSSEEndpoint() {
  return {
    connect: (clientId: string) => {
      return sseHandler.createConnection(clientId);
    },
    
    sendUpdate: (clientId: string, update: any) => {
      return sseHandler.sendEvent(clientId, 'update', update);
    },
    
    broadcast: (event: string, data: any) => {
      return sseHandler.broadcast(event, data);
    },
    
    disconnect: (clientId: string) => {
      sseHandler.closeConnection(clientId);
    },
  };
}

/**
 * WebSocket-like interface for bidirectional streaming
 */
export class StreamingChannel {
  private streamId: string;
  private handlers = new Map<string, Function>();
  
  constructor(channelId: string) {
    this.streamId = `channel-${channelId}-${Date.now()}`;
  }
  
  on(event: string, handler: Function) {
    this.handlers.set(event, handler);
    return this;
  }
  
  async emit(event: string, data: any) {
    const handler = this.handlers.get(event);
    if (handler) {
      return await handler(data);
    }
  }
  
  async streamToClient(generator: AsyncGenerator) {
    for await (const chunk of generator) {
      await this.emit('data', chunk);
    }
    await this.emit('end', { streamId: this.streamId });
  }
  
  close() {
    this.handlers.clear();
    streamHandler.abortStream(this.streamId);
  }
}
````

## File: apps/ai/.gitignore
````
# Dependencies
node_modules/

# Environment files
.env
.env.local
.env.production
.env.development

# Build outputs
.mastra/
dist/
build/

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# IDE
.vscode/
.idea/
*.swp
*.swo
.DS_Store

# Credentials
src/mastra/credentials/*.json
!src/mastra/credentials/README.md
````

## File: apps/ai/CLAUDE.md
````markdown
# Squish AI Service Context (apps/ai)

## Development Standards

### Project Context
This is the Mastra-powered AI service for Squish, providing intelligent search, content understanding, and AI-powered features. It integrates with Vertex AI for multimodal capabilities including text, image, and document processing.

### Technology Stack
- **Framework**: Mastra (latest) - AI orchestration framework
- **Runtime**: Node.js with Cloudflare Workers compatibility
- **AI Provider**: Google Vertex AI with Gemini models
- **Embeddings**: Custom embedding models for semantic search
- **Vector Storage**: Integrated with main PostgreSQL database
- **TypeScript**: 5.8.3 with strict configuration
- **Deployment**: Mastra Cloud

### Key Dependencies
```json
{
  "dependencies": {
    "@mastra/core": "latest",
    "@mastra/memory": "latest",
    "@mastra/rag": "latest",
    "@google-cloud/vertexai": "^1.6.0",
    "@google-cloud/storage": "^7.14.0",
    "postgres": "^3.4.5",
    "drizzle-orm": "^0.38.2",
    "zod": "^3.25.28",
    "ai": "^3.4.33",
    "@ai-sdk/google": "^1.0.13"
  },
  "devDependencies": {
    "mastra": "latest",
    "@repo/typescript-config": "workspace:*"
  }
}
```

## Project Structure

### Directory Layout
```
src/
‚îú‚îÄ‚îÄ index.ts              # Mastra service entry point
‚îú‚îÄ‚îÄ mastra/               # Mastra configuration and setup
‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # Mastra initialization
‚îÇ   ‚îú‚îÄ‚îÄ memory.ts         # Memory vector store configuration
‚îÇ   ‚îú‚îÄ‚îÄ providers.ts      # AI provider configurations
‚îÇ   ‚îî‚îÄ‚îÄ tools.ts          # AI tool definitions
‚îú‚îÄ‚îÄ agents/               # Mastra agent definitions
‚îÇ   ‚îú‚îÄ‚îÄ search.ts         # Search specialist agent
‚îÇ   ‚îú‚îÄ‚îÄ content.ts        # Content understanding agent
‚îÇ   ‚îú‚îÄ‚îÄ analysis.ts       # Data analysis agent
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Agent registry
‚îú‚îÄ‚îÄ tools/                # AI tool implementations
‚îÇ   ‚îú‚îÄ‚îÄ search.ts         # Search and retrieval tools
‚îÇ   ‚îú‚îÄ‚îÄ content.ts        # Content processing tools
‚îÇ   ‚îú‚îÄ‚îÄ analysis.ts       # Data analysis tools
‚îÇ   ‚îú‚îÄ‚îÄ storage.ts        # File handling tools
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Tool registry
‚îú‚îÄ‚îÄ services/             # AI service implementations
‚îÇ   ‚îú‚îÄ‚îÄ embedding.ts      # Embedding generation
‚îÇ   ‚îú‚îÄ‚îÄ retrieval.ts      # Semantic search
‚îÇ   ‚îú‚îÄ‚îÄ reasoning.ts      # Reasoning and synthesis
‚îÇ   ‚îú‚îÄ‚îÄ multimodal.ts     # Multimodal processing
‚îÇ   ‚îú‚îÄ‚îÄ rag.ts            # RAG pipeline
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Service exports
‚îú‚îÄ‚îÄ prompts/              # AI prompt templates
‚îÇ   ‚îú‚îÄ‚îÄ search.ts         # Search-related prompts
‚îÇ   ‚îú‚îÄ‚îÄ analysis.ts       # Analysis prompts
‚îÇ   ‚îú‚îÄ‚îÄ templates.ts      # Prompt templates
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Prompt registry
‚îú‚îÄ‚îÄ utils/                # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ text-processing.ts # Text processing helpers
‚îÇ   ‚îú‚îÄ‚îÄ embedding-utils.ts # Embedding utilities
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Utility exports
‚îî‚îÄ‚îÄ types/                # AI-specific type definitions
    ‚îú‚îÄ‚îÄ agents.ts         # Agent types
    ‚îú‚îÄ‚îÄ tools.ts          # Tool types
    ‚îî‚îÄ‚îÄ index.ts          # Type exports
```

## Mastra Framework Architecture

### Mastra Service Configuration
```typescript
// src/mastra/index.ts
import { Mastra } from '@mastra/core';

export const mastra = new Mastra({
  // Memory configuration for vector store
  memory: {
    provider: 'postgres',
    connectionString: process.env.DATABASE_URL,
  },
  
  // AI provider configuration
  providers: {
    vertex: {
      project: process.env.VERTEX_AI_PROJECT,
      location: process.env.VERTEX_AI_LOCATION,
      credentials: JSON.parse(process.env.GOOGLE_APPLICATION_CREDENTIALS!),
    },
  },
  
  // Tool registration
  tools: {
    search: searchTools,
    content: contentTools,
    analysis: analysisTools,
  },
});
```

### Agent Pattern
```typescript
// src/agents/search.ts
import { Agent } from '@mastra/core';

export const searchAgent = new Agent({
  name: 'search',
  instructions: `
    You are a search specialist for the Squish platform.
    Your capabilities include:
    1. Semantic search across all content
    2. Query understanding and expansion
    3. Result ranking and relevance scoring
    4. Multi-turn search conversations
  `,
  tools: ['search', 'embed', 'retrieve'],
  model: 'gemini-1.5-pro',
});

// Usage in service
const result = await searchAgent.generate(
  'Find documents about project planning strategies',
  { userId }
);
```

### Tool Implementation Pattern
```typescript
// src/tools/search.ts
import { Tool } from '@mastra/core';

export const searchTool = new Tool({
  name: 'semantic-search',
  description: 'Search documents using semantic similarity',
  inputSchema: z.object({
    query: z.string(),
    limit: z.number().default(10),
    filters: z.object({
      boardId: z.string().optional(),
      contentType: z.enum(['text', 'image', 'document']).optional(),
    }).optional(),
  }),
  
  async execute({ query, limit, filters }) {
    const embeddings = await embeddingService.generate(query);
    const results = await retrievalService.semanticSearch(
      embeddings,
      limit,
      filters
    );
    
    return {
      results,
      query,
      timestamp: new Date().toISOString(),
    };
  },
});
```

## AI Integration Patterns

### Vertex AI Integration
```typescript
// src/mastra/providers.ts
import { VertexAI } from '@google-cloud/vertexai';

const vertexAI = new VertexAI({
  project: process.env.VERTEX_AI_PROJECT!,
  location: process.env.VERTEX_AI_LOCATION!,
  googleAuthOptions: {
    credentials: JSON.parse(process.env.GOOGLE_APPLICATION_CREDENTIALS!),
  },
});

// Multimodal model usage
const generativeModel = vertexAI.getGenerativeModel({
  model: 'gemini-1.5-pro',
});

const multimodalResult = await generativeModel.generateContent([
  'Analyze this document:',
  { fileData: { mimeType, fileUri } },
]);
```

### AI SDK Integration
```typescript
// Using AI SDK for streaming responses
import { openai } from '@ai-sdk/openai';
import { streamText } from 'ai';

export async function generateResponse(messages: Message[]) {
  const result = await streamText({
    model: openai('gpt-4-turbo'),
    messages,
    tools: {
      search: {
        description: 'Search for information',
        parameters: searchToolSchema,
      },
    },
  });
  
  return result.toDataStreamResponse();
}
```

## RAG (Retrieval-Augmented Generation)

### RAG Pipeline Implementation
```typescript
// src/services/rag.ts
export class RAGService {
  constructor(
    private embeddingService: EmbeddingService,
    private retrievalService: RetrievalService,
    private llmService: LLMService
  ) {}
  
  async query(query: string, context?: QueryContext) {
    // Step 1: Understand query intent
    const intent = await this.analyzeIntent(query);
    
    // Step 2: Retrieve relevant documents
    const documents = await this.retrievalService.retrieve(
      query,
      intent.filters,
      10
    );
    
    // Step 3: Generate response with context
    const response = await this.llmService.generate(
      query,
      documents,
      context
    );
    
    return {
      response,
      sources: documents,
      intent,
      timestamp: new Date().toISOString(),
    };
  }
}
```

### Embedding Generation
```typescript
// src/services/embedding.ts
export class EmbeddingService {
  private model = new TextEmbeddingModel();
  
  async generate(text: string | string[]): Promise<number[]> {
    const texts = Array.isArray(text) ? text : [text];
    
    // Generate embeddings using Vertex AI
    const embeddings = await this.model.embed(texts);
    
    return Array.isArray(embeddings[0]) 
      ? embeddings[0] 
      : embeddings;
  }
  
  async batchGenerate(texts: string[]): Promise<number[][]> {
    const batchSize = 100;
    const results: number[][] = [];
    
    for (let i = 0; i < texts.length; i += batchSize) {
      const batch = texts.slice(i, i + batchSize);
      const embeddings = await this.model.embed(batch);
      results.push(...(Array.isArray(embeddings[0]) ? embeddings : [embeddings]));
    }
    
    return results;
  }
}
```

## Multimodal Processing

### Image Understanding
```typescript
// src/services/multimodal.ts
export class MultimodalService {
  async analyzeImage(imageUrl: string, query: string) {
    const visionModel = vertexAI.getGenerativeModel({
      model: 'gemini-1.5-pro-vision',
    });
    
    const result = await visionModel.generateContent([
      query,
      {
        fileData: {
          mimeType: 'image/jpeg',
          fileUri: imageUrl,
        },
      },
    ]);
    
    return {
      analysis: result.response.text(),
      metadata: {
        model: 'gemini-1.5-pro-vision',
        timestamp: new Date().toISOString(),
      },
    };
  }
  
  async processDocument(fileUrl: string, type: 'pdf' | 'docx' | 'txt') {
    // Document processing logic
    const extractedText = await this.extractText(fileUrl, type);
    const summary = await this.generateSummary(extractedText);
    
    return {
      text: extractedText,
      summary,
      wordCount: extractedText.split(' ').length,
    };
  }
}
```

## Prompt Engineering

### Prompt Template System
```typescript
// src/prompts/templates.ts
export const prompts = {
  search: {
    queryExpansion: `
      Given a user's search query, generate 3-5 expanded queries
      that capture different aspects of what the user might be looking for.
      
      Original query: {query}
      Context: {context}
      
      Return as JSON array of strings.
    `,
    
    resultSummary: `
      Summarize the following search results in a helpful way:
      
      Query: {query}
      Results: {results}
      
      Provide a concise summary highlighting the most relevant information.
    `,
  },
  
  analysis: {
    sentiment: `
      Analyze the sentiment of the following text:
      
      Text: {text}
      
      Return JSON with:
      - sentiment: "positive" | "neutral" | "negative"
      - confidence: 0-1
      - keyPhrases: string[]
      - topics: string[]
    `,
  },
};
```

### Dynamic Prompt Construction
```typescript
// src/prompts/index.ts
export class PromptBuilder {
  constructor(private templates: Record<string, string>) {}
  
  build(templateName: string, variables: Record<string, any>) {
    let template = this.templates[templateName];
    
    // Replace variables
    for (const [key, value] of Object.entries(variables)) {
      template = template.replace(new RegExp(`{${key}}`, 'g'), String(value));
    }
    
    return template;
  }
  
  buildSystemPrompt(agents: string[], tools: string[]) {
    return `
      You are an AI assistant for the Squish platform.
      
      Available agents: ${agents.join(', ')}
      Available tools: ${tools.join(', ')}
      
      Always use the appropriate tools when answering questions.
      If you need to search for information, use the search tool.
      `;
  }
}
```

## Memory and Context Management

### Conversation Memory
```typescript
// src/mastra/memory.ts
export class ConversationMemory {
  private storage = new MastraMemory({
    connectionString: process.env.DATABASE_URL,
  });
  
  async storeMessage(
    conversationId: string,
    role: 'user' | 'assistant',
    content: string,
    metadata?: any
  ) {
    await this.storage.store({
      conversationId,
      role,
      content,
      timestamp: new Date().toISOString(),
      metadata,
    });
  }
  
  async getContext(conversationId: string, limit = 10) {
    const messages = await this.storage.getConversation(
      conversationId,
      limit
    );
    
    return {
      messages,
      summary: await this.summarizeConversation(messages),
    };
  }
}
```

### Working Memory
```typescript
// Short-term memory for agent interactions
interface WorkingMemory {
  currentTask: string;
  context: Record<string, any>;
  toolsUsed: string[];
  intermediateResults: any[];
}

export function createWorkingMemory(): WorkingMemory {
  return {
    currentTask: '',
    context: {},
    toolsUsed: [],
    intermediateResults: [],
  };
}
```

## Development Workflow

### Local Development
```bash
# Start Mastra development server
bun run dev

# Build for deployment
bun run build

# Deploy to Mastra Cloud
bunx mastra deploy

# Run tests
bun run test
```

### Environment Variables
```typescript
interface Env {
  // Vertex AI
  VERTEX_AI_PROJECT: string;
  VERTEX_AI_LOCATION: string;
  GOOGLE_APPLICATION_CREDENTIALS: string;
  
  // Database
  DATABASE_URL: string;
  
  // External services
  AI_SERVICE_URL: string;
  
  // Mastra Cloud
  MASTRA_ENVIRONMENT: 'development' | 'production';
}
```

## Testing Patterns

### Agent Testing
```typescript
// tests/agents.test.ts
import { test } from 'vitest';
import { searchAgent } from '../src/agents/search';

test.describe('Search Agent', () => {
  test('should expand query appropriately', async () => {
    const result = await searchAgent.generate(
      'Find project management docs',
      { userId: 'test-user' }
    );
    
    expect(result.content).toContain('project');
    expect(result.toolsUsed).toContain('search');
  });
});
```

### Tool Testing
```typescript
// tests/tools.test.ts
test('semantic search tool should return relevant results', async () => {
  const results = await searchTool.execute({
    query: 'database design patterns',
    limit: 5,
  });
  
  expect(results.results).toHaveLength(5);
  expect(results.results[0].score).toBeGreaterThan(0.7);
});
```

## Performance Optimization

### Caching Strategy
```typescript
// Implement caching for embeddings and search results
export class CachedEmbeddingService {
  private cache = new Map<string, number[]>();
  
  async generate(text: string): Promise<number[]> {
    const cacheKey = `embed:${text}`;
    
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey)!;
    }
    
    const embedding = await this.model.embed(text);
    this.cache.set(cacheKey, embedding);
    
    // Cache for 1 hour
    setTimeout(() => this.cache.delete(cacheKey), 3600000);
    
    return embedding;
  }
}
```

### Batch Processing
```typescript
// Process multiple requests efficiently
export async function batchProcessEmbeddings(texts: string[]) {
  const uncached = [];
  const results: Record<string, number[]> = {};
  
  for (const text of texts) {
    if (this.cache.has(text)) {
      results[text] = this.cache.get(text)!;
    } else {
      uncached.push(text);
    }
  }
  
  if (uncached.length > 0) {
    const embeddings = await this.model.embed(uncached);
    uncached.forEach((text, i) => {
      results[text] = embeddings[i];
      this.cache.set(text, embeddings[i]);
    });
  }
  
  return texts.map(text => results[text]);
}
```

## Monitoring and Observability

### AI Metrics
```typescript
// Track AI-specific metrics
export class AIMetrics {
  private metrics = {
    requestsTotal: 0,
    latency: [],
    tokenUsage: { total: 0, prompt: 0, completion: 0 },
    errors: 0,
  };
  
  recordRequest(duration: number, tokens?: { prompt: number; completion: number }) {
    this.metrics.requestsTotal++;
    this.metrics.latency.push(duration);
    
    if (tokens) {
      this.metrics.tokenUsage.total += tokens.prompt + tokens.completion;
      this.metrics.tokenUsage.prompt += tokens.prompt;
      this.metrics.tokenUsage.completion += tokens.completion;
    }
  }
  
  getStats() {
    return {
      ...this.metrics,
      avgLatency: this.metrics.latency.reduce((a, b) => a + b, 0) / this.metrics.latency.length,
    };
  }
}
```

## Security Considerations

### Content Filtering
```typescript
// Implement content safety checks
export async function validateContent(content: string): Promise<boolean> {
  const moderationModel = vertexAI.getGenerativeModel({
    model: 'gemini-1.5-pro',
  });
  
  const result = await moderationModel.generateContent([
    `Check if this content is appropriate: ${content}`,
  ]);
  
  const appropriate = result.response.text().toLowerCase().includes('appropriate');
  return appropriate;
}
```

## Common Tasks

### Adding a New Agent
1. Create agent file in `src/agents/`
2. Define agent instructions and tools
3. Register agent in `src/agents/index.ts`
4. Write tests for the agent
5. Update documentation

### Adding a New Tool
1. Create tool implementation in `src/tools/`
2. Define input/output schemas with Zod
3. Register tool in `src/tools/index.ts`
4. Add to Mastra configuration
5. Test with actual AI calls

### Adding New Prompt Templates
1. Create prompt in `src/prompts/[domain].ts`
2. Add to prompt builder
3. Test with various inputs
4. Document usage patterns

## Files to Know

- `src/mastra/index.ts` - Mastra configuration
- `src/agents/` - AI agent definitions
- `src/tools/` - AI tool implementations
- `src/services/rag.ts` - RAG pipeline
- `src/prompts/` - Prompt templates
- `src/services/embedding.ts` - Embedding service

## Quality Checklist

Before committing changes to this AI service:
- [ ] All agents properly defined with clear instructions
- [ ] Tools have comprehensive schemas and error handling
- [ ] Prompt templates tested for clarity
- [ ] AI responses tested for quality
- [ ] Tests pass for new functionality
- [ ] Performance metrics considered
- [ ] Content filtering implemented where needed
- [ ] Memory management is efficient
- [ ] Documentation updated
- [ ] No hardcoded credentials or keys

---

*This context ensures Claude Code understands the AI service structure and patterns when working on AI features.*
````

## File: apps/ai/package.json
````json
{
  "name": "ai",
  "private": true,
  "main": "index.js",
  "type": "module",
  "scripts": {
    "dev": "mastra dev -p 9998",
    "start": "mastra start",
    "build": "mastra build",
    "postinstall": "node scripts/fix-mastra-a2a.js"
  },
  "dependencies": {
    "@ai-sdk/google-vertex": "^2.2.27",
    "@google-cloud/vertexai": "^1.9.0",
    "@mastra/core": "^0.13.2",
    "@mastra/libsql": "^0.13.2",
    "@mastra/loggers": "^0.10.6",
    "@mastra/mcp": "^0.10.11",
    "@mastra/memory": "^0.12.2",
    "@mastra/pg": "^0.14.0",
    "@repo/orpc": "workspace:*",
    "ai": "^4.0.0",
    "hono": "^4.6.15",
    "lru-cache": "^11.1.0",
    "zod": "^3.25.69"
  },
  "devDependencies": {
    "@types/node": "^24.0.10",
    "mastra": "^0.10.21",
    "typescript": "^5.8.3"
  }
}
````

## File: apps/ai/README.md
````markdown
# Squish AI Service

AI service for Squish platform providing multimodal embeddings, RAG pipeline, and hybrid search capabilities.

## üöÄ Recent Enhancements

### Phase 1: Critical Issues Fixed ‚úÖ
1. **‚úÖ Dimension Mismatch Resolved**: All embeddings now standardized to 1408 dimensions
2. **‚úÖ Vertex AI Integration**: Full production integration with proper REST API calls
3. **‚úÖ Audio Support**: Transcription fallback via Gemini 1.5 Pro
4. **‚úÖ Text Length Handling**: Automatic fallback for text >32 tokens
5. **‚úÖ Embedding Cache**: LRU cache with configurable TTL for performance
6. **‚úÖ Comprehensive Tests**: Full test coverage for all components

### Phase 2: Advanced Features Delivered ‚úÖ
1. **‚úÖ Custom Vertex AI Tools**: Direct SDK integration for optimal performance
   - `vertex-multimodal-embed`: Multimodal embeddings with caching
   - `vertex-text-embed`: Long text handling with chunking
   - `vertex-gemini-generate`: Multimodal generation for RAG
2. **‚úÖ Multimodal RAG Pipeline**: Complete retrieval-augmented generation workflow
   - Query enhancement
   - pgvector KNN search
   - Context fusion and ranking
   - Citation extraction
3. **‚úÖ Hybrid Search**: Weighted scoring (0.3 keyword + 0.7 vector)
   - PostgreSQL full-text search
   - pgvector similarity search
   - Result fusion and re-ranking
4. **‚úÖ Batch Processing System**: Enterprise-grade bulk operations
   - Progress tracking with EventEmitter
   - Configurable batching and rate limiting
   - Job management workflows
   - Retry logic with exponential backoff

## üìã Architecture

```
apps/ai/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ mastra/                # Mastra framework components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agents/            # AI agents (search-enhancer, content-analysis)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/             # Tools for AI operations
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ multimodal-embedding/  # Original Mastra-based tool
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vertex-multimodal-embed/  # Direct SDK integration
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vertex-text-embed/        # Long text embeddings
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vertex-gemini-generate/   # Multimodal generation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workflows/         # Orchestration workflows
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ content-analysis/         # Content personality analysis
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ multimodal-rag/          # RAG pipeline
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ batch-embeddings/        # Batch processing
‚îÇ   ‚îú‚îÄ‚îÄ providers/             # AI providers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vertex-ai.ts       # Google Vertex AI REST integration
‚îÇ   ‚îî‚îÄ‚îÄ services/              # Support services
‚îÇ       ‚îú‚îÄ‚îÄ cache/             # Embedding cache layer
‚îÇ       ‚îú‚îÄ‚îÄ search/            # Search services
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ hybrid.ts      # Hybrid search implementation
‚îÇ       ‚îî‚îÄ‚îÄ queue/             # Queue services
‚îÇ           ‚îî‚îÄ‚îÄ batch-embed.ts # Batch processor with events
‚îî‚îÄ‚îÄ tests/                     # Comprehensive test coverage
```

## üîß Key Components

### 1. Custom Vertex AI Tools (NEW)
- **vertex-multimodal-embed**: Direct SDK integration for multimodal content
  - Bypasses Mastra abstraction for 2x performance
  - Handles images, videos, GIFs, and short text
  - Integrated cache and quota management
- **vertex-text-embed**: Specialized for long text content
  - Handles text >32 tokens (multimodal limit)
  - Smart chunking and aggregation
  - Pads to 1408 dimensions for compatibility
- **vertex-gemini-generate**: Multimodal generation
  - Powers RAG response generation
  - Supports Gemini 2 Flash and Pro models
  - Extracts citations from responses

### 2. Multimodal RAG Pipeline (NEW)
- Complete retrieval-augmented generation workflow
- Query enhancement using search-enhancer agent
- pgvector KNN search for similarity matching
- Context fusion from multiple sources
- Citation extraction and attribution

### 3. Hybrid Search Service (NEW)
- Combines keyword and vector search
- Configurable weights (default: 0.3 keyword + 0.7 vector)
- PostgreSQL full-text search for keywords
- pgvector cosine similarity for semantics
- Result fusion with score normalization

### 4. Batch Processing System (NEW)
- Enterprise-grade bulk embedding generation
- EventEmitter-based progress tracking
- Configurable batch sizes and delays
- Automatic retry with exponential backoff
- Job management (create, status, cancel, list)

### 5. Vertex AI Provider
- Production REST API integration
- Multimodal embeddings for visual content
- Audio transcription fallback via Gemini
- Text embeddings with dimension standardization
- Comprehensive error handling

### 6. Embedding Cache
- In-memory LRU cache
- Configurable TTL and size limits
- Cache hit rates >70% after warmup
- Thread-safe operations

## üöÄ Getting Started

### Prerequisites
- Node.js >= 20.9.0
- Google Cloud Project with Vertex AI enabled
- gcloud CLI authenticated

### Installation
```bash
cd apps/ai
bun install
```

### Configuration
```env
# Required
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_CLOUD_LOCATION=us-central1

# Optional
EMBEDDING_CACHE_TTL=86400      # Cache TTL in seconds (default: 24h)
EMBEDDING_CACHE_MAX_SIZE=1000  # Max cache entries (default: 1000)
NODE_ENV=production            # Enable production mode
```

### Running the Service
```bash
# Development (port 9998)
bun run dev

# Production
bun run build
bun run start

# Run tests
bun run test
bun run test:coverage
```

## üì° API Endpoints

The Mastra framework automatically exposes REST endpoints:

### Tools
- `POST /api/tools/multimodal-embedding/execute` - Original Mastra tool
- `POST /api/tools/vertex-multimodal-embed/execute` - Direct SDK multimodal
  ```json
  {
    "content": "https://example.com/image.jpg",
    "contentType": "image",
    "mimeType": "image/jpeg"
  }
  ```
- `POST /api/tools/vertex-text-embed/execute` - Long text embeddings
  ```json
  {
    "text": "Long text content...",
    "model": "text-embedding-005"
  }
  ```
- `POST /api/tools/vertex-gemini-generate/execute` - Multimodal generation
  ```json
  {
    "prompt": "Describe this image",
    "context": [{"type": "image", "content": "base64..."}],
    "model": "gemini-2.0-flash-exp"
  }
  ```

### Agents
- `/api/agents/search-enhancer` - Query enhancement
- `/api/agents/content-analysis` - Content personality analysis

### Workflows
- `/api/workflows/analyze-content` - Content analysis pipeline
- `/api/workflows/multimodal-rag` - RAG pipeline
  ```json
  {
    "query": "find modern architecture",
    "multimodalContext": [{"url": "...", "type": "image"}],
    "searchType": "assets",
    "limit": 10
  }
  ```
- `/api/workflows/batch-embeddings` - Start batch job
- `/api/workflows/get-batch-job-status` - Check job status
- `/api/workflows/cancel-batch-job` - Cancel running job
- `/api/workflows/list-batch-jobs` - List all jobs

## üß™ Testing

```bash
# Run all tests
bun run test

# Watch mode
bun run test:watch

# Coverage report
bun run test:coverage
```

## üìä Performance

### Embedding Generation Times
- **Cached**: <10ms
- **Images/Videos**: ~500-1000ms
- **Audio (with transcription)**: ~2000-3000ms
- **Text**: ~300-500ms

### Cache Performance
- Hit rate: Typically 70-80% after warmup
- Memory usage: ~1.5KB per cached embedding
- Eviction: LRU policy ensures most-used embeddings stay cached

## üîç Monitoring

### Logs to Watch
- `[CACHE HIT]` - Embedding retrieved from cache
- `[CACHE STORE]` - New embedding cached
- `[WARNING]` - Audio transcription fallback
- `[DEV]` - Development mode indicators

### Health Check
```bash
curl http://localhost:9998/health
```

## üöß Production Readiness Tasks

See [Outstanding Work](../../docs/search/outstanding-work.md) for detailed status.

### High Priority
1. **pgvector Indexes** - Create proper indexes for performance
2. **Search History** - Implement history tracking and UI
3. **File Upload Pipeline** - Enable multimodal file uploads to GCS
4. **Production Auth** - Replace gcloud CLI with ADC

### Medium Priority
1. **Real-time Progress** - SSE/WebSocket for batch updates
2. **Result Pagination** - Virtual scrolling for large results
3. **Distributed Cache** - Migrate to Redis for multi-instance
4. **Quota Management** - Implement actual quota tracking

## üìö Documentation

- [Search System Overview](../../docs/search/README.md)
- [AI Integration Guide](../../docs/search/ai-integration.md)
- [API Reference](../../docs/search/api-reference.md)

## ü§ù Contributing

1. Follow existing patterns for new tools/agents
2. Add comprehensive tests for new features
3. Update documentation for API changes
4. Ensure all embeddings are 1408 dimensions

## üìù License

¬© 2024 Squish Labs - All rights reserved
````

## File: apps/ai/tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "bundler",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true,
    "noEmit": true,
    "outDir": "dist"
  },
  "include": ["src/**/*"]
}
````

## File: apps/api/__tests__/health.test.ts
````typescript
import { expect, test } from 'vitest';
import { GET } from '../src/app/health/route';

test('Health Check', async () => {
  const response = await GET();
  expect(response.status).toBe(200);
  expect(await response.text()).toBe('OK');
});
````

## File: apps/api/dist-dry-run/README.md
````markdown
This folder contains the built output assets for the worker "squish-api" generated at 2025-08-09T06:22:33.931Z.
````

## File: apps/api/scripts/setup-hyperdrive.sh
````bash
#!/bin/bash

# Script to set up Cloudflare Hyperdrive for database connection pooling
# This provides optimized database connectivity for Cloudflare Workers

echo "Setting up Cloudflare Hyperdrive for Squish API..."

# Get the database URL from .dev.vars
DB_URL=$(grep DATABASE_URL .dev.vars | cut -d'=' -f2-)

if [ -z "$DB_URL" ]; then
  echo "Error: DATABASE_URL not found in .dev.vars"
  exit 1
fi

echo "Creating Hyperdrive configuration..."
echo "Using database URL: ${DB_URL:0:30}..."

# Create Hyperdrive configuration
# Note: This will prompt for Cloudflare auth if not already logged in
wrangler hyperdrive create squish-api-db --connection-string="$DB_URL"

echo ""
echo "Hyperdrive configuration created!"
echo ""
echo "Add the following to your wrangler.toml:"
echo ""
echo "[[hyperdrive]]"
echo "binding = \"HYPERDRIVE\""
echo "id = \"<your-hyperdrive-id-here>\""
echo ""
echo "Remember to update the ID with the one provided above."
````

## File: apps/api/scripts/skip-ci.js
````javascript
const { execSync } = require('node:child_process');

const commitMessage = execSync('git log -1 --pretty=%B').toString().trim();

if (commitMessage.includes('[skip ci]')) {
  process.exit(0); // this causes Vercel to skip the build
}

process.exit(1); // continue with build
````

## File: apps/api/src/constants/error.ts
````typescript
/**
 * Common error messages as an enum to avoid magic strings
 */
export enum ErrorMessage {
  AUTHENTICATION_REQUIRED = 'Authentication is required',
  DATABASE_ERROR = 'A database error occurred',
  NOT_AUTHENTICATED = 'Authentication is required to access this resource',
  NOT_FOUND = 'The requested resource was not found',
  RATE_LIMITED = 'Rate limit exceeded. Try again later',
  SERVER_ERROR = 'An unexpected error occurred',
  UNAUTHORIZED = 'You are not authorized to perform this action',
  VALIDATION_ERROR = 'The provided data failed validation',
}

/**
 * Error types for standardized error responses
 */
export enum ErrorType {
  AUTHENTICATION = 'AUTHENTICATION_REQUIRED',
  AUTHORIZATION = 'UNAUTHORIZED',
  BAD_REQUEST = 'BAD_REQUEST',
  DATABASE_ERROR = 'DATABASE_ERROR',
  INVALID_PARAM = 'INVALID_PARAM',
  MISSING_PARAM = 'MISSING_PARAM',
  NOT_FOUND = 'NOT_FOUND',
  RATE_LIMITED = 'RATE_LIMITED',
  SERVER_ERROR = 'SERVER_ERROR',
  VALIDATION = 'VALIDATION_ERROR',
  // Additional error types from original implementation
  USER_NOT_FOUND = 'USER_NOT_FOUND',
  AUTH_FAILED = 'AUTH_FAILED',
}

/**
 * Standard error messages for error types
 */
export const ERROR_MESSAGES: Record<ErrorType, string> = {
  [ErrorType.AUTHENTICATION]:
    'Authentication is required to access this resource',
  [ErrorType.AUTHORIZATION]: 'You are not authorized to perform this action',
  [ErrorType.BAD_REQUEST]: 'Invalid request parameters',
  [ErrorType.DATABASE_ERROR]: 'A database error occurred',
  [ErrorType.INVALID_PARAM]: 'Invalid parameter value provided',
  [ErrorType.MISSING_PARAM]: 'Required parameter is missing',
  [ErrorType.NOT_FOUND]: 'The requested resource was not found',
  [ErrorType.RATE_LIMITED]: 'Rate limit exceeded. Try again later',
  [ErrorType.SERVER_ERROR]: 'An unexpected error occurred',
  [ErrorType.VALIDATION]: 'The provided data failed validation',
  [ErrorType.USER_NOT_FOUND]: 'User not found',
  [ErrorType.AUTH_FAILED]: 'Authentication failed',
};
````

## File: apps/api/src/constants/index.ts
````typescript
export * from './error';

// Resource types for error messages
export enum ResourceType {
  USER = 'User',
  ASSET = 'Asset',
  BOARD = 'Board',
  SEARCH = 'Search',
  REPORT = 'Report',
  THREAD = 'Thread',
  MESSAGE = 'Message',
  SPACE = 'Space',
  MEMBER = 'Member',
}
````

## File: apps/api/src/lib/utils/errors.ts
````typescript
import { HTTPException } from 'hono/http-exception';

export class ApiError extends HTTPException {
  constructor(status: number, message: string, options?: { cause?: any }) {
    super(status as any, { message, cause: options?.cause });
  }
}

export const unauthorized = (message = 'Unauthorized') =>
  new ApiError(401, message);
export const forbidden = (message = 'Forbidden') => new ApiError(403, message);
export const notFound = (message = 'Not found') => new ApiError(404, message);
export const badRequest = (message = 'Bad request') =>
  new ApiError(400, message);
export const conflict = (message = 'Conflict') => new ApiError(409, message);
export const internalError = (message = 'Internal server error') =>
  new ApiError(500, message);
````

## File: apps/api/src/lib/auth.ts
````typescript
import { auth } from '@repo/auth/server';
import { unauthorized } from './utils/errors';

/**
 * Define the type for your authenticated route handler
 */
type AuthenticatedHandler = (
  req: Request,
  { params, user }: { params?: any; user: { userId: string } }
) => Promise<Response>;

/**
 * Higher-order function to handle authentication.
 * It fetches the Clerk user ID and passes it to the wrapped handler.
 *
 * @param handler The actual route handler function to wrap.
 * @returns A new route handler that includes the authenticated userId in its context.
 */
export function withAuthenticatedUser(handler: AuthenticatedHandler) {
  return async (req: Request, context?: { params?: any }) => {
    const { userId: clerkId } = await auth();

    if (!clerkId) {
      throw unauthorized('User not authenticated');
    }

    return handler(req, {
      params: context?.params,
      user: { userId: clerkId },
    });
  };
}
````

## File: apps/api/src/lib/database.ts
````typescript
import * as schema from '@repo/database/schema';
import { type PostgresJsDatabase, drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import type { Env } from '../index';

let db: PostgresJsDatabase<typeof schema> | null = null;

/**
 * Get database connection using Hyperdrive when available (in production)
 * or direct connection in development
 */
export function getDatabase(env: Env): PostgresJsDatabase<typeof schema> {
  if (db) {
    return db;
  }

  // In production with Hyperdrive
  if (env.HYPERDRIVE?.connectionString) {
    const sql = postgres(env.HYPERDRIVE.connectionString, {
      max: 5, // Limit connections for Workers
      fetch_types: false, // Disable if not using array types for better performance
    });
    db = drizzle(sql, { schema });
    return db;
  }

  // Fallback to direct connection (development or when Hyperdrive not configured)
  if (env.DATABASE_URL) {
    const sql = postgres(env.DATABASE_URL, {
      max: 10, // Can use more connections when not in Workers environment
    });
    db = drizzle(sql, { schema });
    return db;
  }

  throw new Error('No database connection available');
}

/**
 * Close database connection
 * Important: Call this in ctx.waitUntil() to ensure cleanup
 */
export async function closeDatabase(): Promise<void> {
  if (db) {
    const sql = (db as any).sql;
    if (sql && typeof sql.end === 'function') {
      await sql.end();
    }
    db = null;
  }
}
````

## File: apps/api/src/lib/errors.ts
````typescript
import type { ZodError } from 'zod';
import type { ResourceType } from '../../../../apps/api/src/constants';
import {
  ERROR_MESSAGES,
  ErrorType,
} from '../../../../apps/api/src/constants/error';

/**
 * Custom error class with error type
 */
export class ApiError extends Error {
  details?: any;
  status: number;
  code: ErrorType | string;

  constructor(code: ErrorType | string, message?: string, details?: any) {
    super(
      message ||
        (code in ERROR_MESSAGES ? ERROR_MESSAGES[code as ErrorType] : code)
    );

    this.name = 'ApiError';
    this.code = code;
    this.details = details;
    this.status = this.getStatusCode(code);
  }

  /**
   * Map error types to HTTP status codes
   */
  private getStatusCode(type: ErrorType | string): number {
    switch (type) {
      case ErrorType.NOT_FOUND:
      case ErrorType.USER_NOT_FOUND:
        return 404;
      case ErrorType.AUTHENTICATION:
        return 401;
      case ErrorType.AUTHORIZATION:
      case ErrorType.AUTH_FAILED:
        return 403;
      case ErrorType.VALIDATION:
      case ErrorType.BAD_REQUEST:
      case ErrorType.INVALID_PARAM:
      case ErrorType.MISSING_PARAM:
        return 400;
      case ErrorType.RATE_LIMITED:
        return 429;
      default:
        return 500;
    }
  }

  // Helper for resource not found errors
  static notFound(resource: ResourceType | string, id?: string): ApiError {
    return new ApiError(
      ErrorType.NOT_FOUND,
      `${resource} not found`,
      id ? { id } : undefined
    );
  }

  // Helper for database-related errors
  static database(message?: string, details?: any): ApiError {
    return new ApiError(
      ErrorType.DATABASE_ERROR,
      message || ERROR_MESSAGES[ErrorType.DATABASE_ERROR],
      details
    );
  }

  // Helper for unauthorized errors
  static unauthorized(message?: string): ApiError {
    return new ApiError(
      ErrorType.AUTHORIZATION,
      message || ERROR_MESSAGES[ErrorType.AUTHORIZATION]
    );
  }

  // Helper for authentication errors
  static unauthenticated(message?: string): ApiError {
    return new ApiError(
      ErrorType.AUTHENTICATION,
      message || ERROR_MESSAGES[ErrorType.AUTHENTICATION]
    );
  }

  // Helper for validation errors
  static validation(details: any): ApiError {
    return new ApiError(
      ErrorType.VALIDATION,
      ERROR_MESSAGES[ErrorType.VALIDATION],
      details
    );
  }

  // Helper for invalid parameter errors
  static invalidParam(param: string, message?: string): ApiError {
    return new ApiError(
      ErrorType.INVALID_PARAM,
      message || `Invalid value for parameter: ${param}`,
      { param }
    );
  }

  // Helper for missing parameter errors
  static missingParam(param: string | string[]): ApiError {
    const params = Array.isArray(param) ? param : [param];
    const paramList = params.join(', ');
    return new ApiError(
      ErrorType.MISSING_PARAM,
      `Missing required parameter${params.length > 1 ? 's' : ''}: ${paramList}`,
      { params }
    );
  }

  // Helper for bad request errors
  static badRequest(message: string, details?: any): ApiError {
    return new ApiError(ErrorType.BAD_REQUEST, message, details);
  }

  // Helper for forbidden errors
  static forbidden(message?: string): ApiError {
    return new ApiError(
      ErrorType.AUTHORIZATION,
      message || ERROR_MESSAGES[ErrorType.AUTHORIZATION]
    );
  }

  /**
   * Format the error for HTTP response
   */
  toResponse() {
    return {
      error: {
        code: this.code,
        message: this.message,
        ...(this.details && { details: this.details }),
      },
    };
  }
}

/**
 * Convert a Zod error to an ApiError
 */
export function handleZodError(error: ZodError): ApiError {
  // Format the validation errors in a more user-friendly way
  const details = error.errors.reduce(
    (acc, curr) => {
      const path = curr.path.join('.');
      acc[path] = curr.message;
      return acc;
    },
    {} as Record<string, string>
  );

  return new ApiError(ErrorType.VALIDATION, 'Validation error', details);
}

// Legacy error codes for backwards compatibility
export const ErrorCodes = {
  // Auth errors
  INVALID_CREDENTIALS: 'INVALID_CREDENTIALS',
  PHONE_NOT_FOUND: 'PHONE_NOT_FOUND',
  USERNAME_TAKEN: 'USERNAME_TAKEN',
  VERIFICATION_FAILED: 'VERIFICATION_FAILED',
  UNAUTHORIZED: ErrorType.AUTHORIZATION,
  USER_NOT_FOUND: ErrorType.USER_NOT_FOUND,
  AUTH_FAILED: ErrorType.AUTH_FAILED,

  // Resource errors
  NOT_FOUND: ErrorType.NOT_FOUND,
  ALREADY_EXISTS: 'ALREADY_EXISTS',
  PERMISSION_DENIED: ErrorType.AUTHORIZATION,

  // Storage errors
  UPLOAD_FAILED: 'UPLOAD_FAILED',
  FILE_TOO_LARGE: 'FILE_TOO_LARGE',
  INVALID_FILE_TYPE: 'INVALID_FILE_TYPE',

  // AI errors
  EMBEDDING_FAILED: 'EMBEDDING_FAILED',
  SEARCH_FAILED: 'SEARCH_FAILED',

  // System errors
  INTERNAL_ERROR: ErrorType.SERVER_ERROR,
  RATE_LIMITED: ErrorType.RATE_LIMITED,
  SERVICE_UNAVAILABLE: 'SERVICE_UNAVAILABLE',
} as const;
````

## File: apps/api/src/lib/responses.ts
````typescript
import { ApiError } from './errors';

export class ApiResponse {
  static success<T>(data: T, status = 200) {
    return new Response(JSON.stringify({ success: true, data }), {
      status,
      headers: {
        'Content-Type': 'application/json',
      },
    });
  }

  static error(error: ApiError | Error | string, status?: number) {
    if (typeof error === 'string') {
      error = new ApiError('UNKNOWN_ERROR', error);
    }

    const apiError =
      error instanceof ApiError
        ? error
        : new ApiError(
            'INTERNAL_ERROR',
            error.message || 'Internal server error'
          );

    return new Response(
      JSON.stringify({
        success: false,
        error: {
          code: apiError.code,
          message: apiError.message,
          details: apiError.details,
        },
      }),
      {
        status: status || apiError.status,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );
  }
}
````

## File: apps/api/src/lib/user.ts
````typescript
import { db, eq, schema } from '@repo/database';
import { notFound, unauthorized } from './utils/errors';

export async function getAuthenticatedUser(userId?: string | null) {
  if (!userId) {
    throw unauthorized('Unauthorized');
  }

  const [user] = await db
    .select()
    .from(schema.users)
    .where(eq(schema.users.clerkId, userId))
    .limit(1);

  if (!user) {
    throw notFound('User not found');
  }

  return user;
}

export async function withAuthenticatedUser<T>(
  handler: (
    user: Awaited<ReturnType<typeof getAuthenticatedUser>>
  ) => Promise<T>
): Promise<T> {
  const user = await getAuthenticatedUser();
  return await handler(user);
}

export function generateUsername(email: string): string {
  const [localPart] = email.split('@');
  const cleanUsername = localPart
    .toLowerCase()
    .replace(/[^a-z0-9]/g, '')
    .slice(0, 20);

  return cleanUsername || 'user';
}

export function isValidEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}
````

## File: apps/api/src/middleware/auth.ts
````typescript
import { verifyToken } from '@clerk/backend';
import { createMiddleware } from 'hono/factory';
import { HTTPException } from 'hono/http-exception';
import type { Env } from '../index';

export interface AuthUser {
  userId: string;
  sessionId: string;
  orgId?: string;
  orgRole?: string;
  orgSlug?: string;
  email?: string;
}

declare module 'hono' {
  interface ContextVariableMap {
    user: AuthUser;
  }
}

export const auth = createMiddleware<{ Bindings: Env }>(async (c, next) => {
  const authHeader = c.req.header('Authorization');

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    throw new HTTPException(401, { message: 'Unauthorized' });
  }

  const token = authHeader.substring(7);

  try {
    const verified = await verifyToken(token, {
      secretKey: c.env.CLERK_SECRET_KEY,
    });

    if (!verified || !verified.sub) {
      throw new HTTPException(401, { message: 'Invalid token' });
    }

    const user: AuthUser = {
      userId: verified.sub,
      sessionId: verified.sid || '',
      orgId: verified.org_id as string | undefined,
      orgRole: verified.org_role as string | undefined,
      orgSlug: verified.org_slug as string | undefined,
      email: verified.email as string | undefined,
    };

    c.set('user', user);

    await next();
  } catch (_error) {
    throw new HTTPException(401, { message: 'Invalid token' });
  }
});

// Optional auth middleware that doesn't throw on missing auth
export const optionalAuth = createMiddleware<{ Bindings: Env }>(
  async (c, next) => {
    const authHeader = c.req.header('Authorization');

    if (authHeader?.startsWith('Bearer ')) {
      const token = authHeader.substring(7);

      try {
        const verified = await verifyToken(token, {
          secretKey: c.env.CLERK_SECRET_KEY,
        });

        if (verified?.sub) {
          const user: AuthUser = {
            userId: verified.sub,
            sessionId: verified.sid || '',
            orgId: verified.org_id as string | undefined,
            orgRole: verified.org_role as string | undefined,
            orgSlug: verified.org_slug as string | undefined,
            email: verified.email as string | undefined,
          };

          c.set('user', user);
        }
      } catch (_error) {}
    }

    await next();
  }
);
````

## File: apps/api/src/schemas/ai.ts
````typescript
import { z } from 'zod';

// AI action types
export const aiActionEnum = z.enum([
  'generate_caption',
  'suggest_tags',
  'enhance_search',
  'generate_board_name',
  'analyze_content',
]);

// AI caption generation schema
export const generateCaptionSchema = z.object({
  assetId: z.string().uuid(),
  style: z
    .enum(['descriptive', 'creative', 'technical', 'casual'])
    .default('descriptive'),
  maxLength: z.number().int().positive().max(500).default(200),
});

// AI tag suggestion schema
export const suggestTagsSchema = z.object({
  assetId: z.string().uuid(),
  maxTags: z.number().int().positive().max(20).default(10),
  includeCategories: z.boolean().default(true),
});

// AI search enhancement schema
export const enhanceSearchSchema = z.object({
  query: z.string().min(1).max(200),
  context: z
    .object({
      previousQueries: z.array(z.string()).optional(),
      userInterests: z.array(z.string()).optional(),
    })
    .optional(),
});

// AI board name generation schema
export const generateBoardNameSchema = z.object({
  assetIds: z.array(z.string().uuid()).min(1).max(20),
  style: z.enum(['descriptive', 'creative', 'minimal']).default('creative'),
  maxSuggestions: z.number().int().positive().max(10).default(5),
});

// AI content analysis schema
export const analyzeContentSchema = z.object({
  assetId: z.string().uuid(),
  analysisTypes: z
    .array(z.enum(['objects', 'scenes', 'emotions', 'colors', 'text', 'faces']))
    .min(1),
});

// Types
export type AIAction = z.infer<typeof aiActionEnum>;
export type GenerateCaptionInput = z.infer<typeof generateCaptionSchema>;
export type SuggestTagsInput = z.infer<typeof suggestTagsSchema>;
export type EnhanceSearchInput = z.infer<typeof enhanceSearchSchema>;
export type GenerateBoardNameInput = z.infer<typeof generateBoardNameSchema>;
export type AnalyzeContentInput = z.infer<typeof analyzeContentSchema>;
````

## File: apps/api/src/schemas/asset.ts
````typescript
import { z } from 'zod';

// Asset type enum
export const assetTypeEnum = z.enum(['IMAGE', 'VIDEO', 'AUDIO', 'GIF']);

// Asset creation schema
export const createAssetSchema = z.object({
  url: z.string().url(),
  type: assetTypeEnum,
  title: z.string().optional(),
  description: z.string().optional(),
  metadata: z.record(z.any()).optional(),
  boardId: z.string().uuid().optional(),
});

// Asset update schema
export const updateAssetSchema = z.object({
  title: z.string().optional(),
  description: z.string().optional(),
  metadata: z.record(z.any()).optional(),
});

// Asset query params schema
export const assetQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(100).default(20),
  type: assetTypeEnum.optional(),
  boardId: z.string().uuid().optional(),
  sortBy: z.enum(['createdAt', 'updatedAt', 'title']).default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
  search: z.string().optional(),
});

// Asset ID params schema
export const assetIdSchema = z.object({
  assetId: z.string().uuid(),
});

// Bulk asset operations schema
export const bulkAssetOperationSchema = z.object({
  assetIds: z.array(z.string().uuid()).min(1).max(100),
});

// Asset upload schema
export const assetUploadSchema = z.object({
  files: z.array(z.any()).min(1).max(10), // Will be validated at runtime
  boardId: z.string().uuid().optional(),
});

// Types
export type AssetType = z.infer<typeof assetTypeEnum>;
export type CreateAssetInput = z.infer<typeof createAssetSchema>;
export type UpdateAssetInput = z.infer<typeof updateAssetSchema>;
export type AssetQueryParams = z.infer<typeof assetQuerySchema>;
export type AssetIdParams = z.infer<typeof assetIdSchema>;
export type BulkAssetOperation = z.infer<typeof bulkAssetOperationSchema>;
export type AssetUploadInput = z.infer<typeof assetUploadSchema>;
````

## File: apps/api/src/schemas/board.ts
````typescript
import { z } from 'zod';

// Board creation schema
export const createBoardSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().optional(),
  isPublic: z.boolean().default(false),
});

// Legacy alias for backward compatibility
export const CreateBoardBodySchema = createBoardSchema;

// Board update schema
export const updateBoardSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  description: z.string().optional(),
  isPublic: z.boolean().optional(),
});

// Legacy alias for backward compatibility
export const UpdateBoardBodySchema = updateBoardSchema;

// Board icon update schema
export const UpdateBoardIconBodySchema = z.object({
  icon: z.string().emoji().optional(),
});

// Add collaborator schema
export const AddBoardCollaboratorBodySchema = z.object({
  userId: z.string().uuid(),
  accessLevel: z.enum(['view', 'edit', 'admin']).default('view'),
});

// Board query params schema
export const boardQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(100).default(20),
  sortBy: z.enum(['createdAt', 'updatedAt', 'name']).default('updatedAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
  search: z.string().optional(),
});

// Board ID params schema
export const boardIdSchema = z.object({
  boardId: z.string().uuid(),
});

// Add assets to board schema
export const addAssetsToBoardSchema = z.object({
  assetIds: z.array(z.string().uuid()).min(1),
});

// Types
export type CreateBoardInput = z.infer<typeof createBoardSchema>;
export type UpdateBoardInput = z.infer<typeof updateBoardSchema>;
export type BoardQueryParams = z.infer<typeof boardQuerySchema>;
export type BoardIdParams = z.infer<typeof boardIdSchema>;
export type AddAssetsToBoardInput = z.infer<typeof addAssetsToBoardSchema>;
export type UpdateBoardIconInput = z.infer<typeof UpdateBoardIconBodySchema>;
export type AddBoardCollaboratorInput = z.infer<
  typeof AddBoardCollaboratorBodySchema
>;
````

## File: apps/api/src/schemas/index.ts
````typescript
// Export all schemas
export * from './board';
export * from './asset';
export * from './user';
export * from './search';
export * from './ai';

// Common schemas
import { z } from 'zod';

// Pagination schema
export const paginationSchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(100).default(20),
});

// Sort schema
export const sortSchema = z.object({
  sortBy: z.string().optional(),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
});

// Common ID schema
export const idSchema = z.object({
  id: z.string().uuid(),
});

// Error response schema
export const errorResponseSchema = z.object({
  error: z.string(),
  message: z.string(),
  details: z.any().optional(),
});

// Success response schema
export const successResponseSchema = z.object({
  success: z.boolean(),
  message: z.string().optional(),
  data: z.any().optional(),
});

// Types
export type PaginationParams = z.infer<typeof paginationSchema>;
export type SortParams = z.infer<typeof sortSchema>;
export type IdParams = z.infer<typeof idSchema>;
export type ErrorResponse = z.infer<typeof errorResponseSchema>;
export type SuccessResponse = z.infer<typeof successResponseSchema>;
````

## File: apps/api/src/schemas/search.ts
````typescript
import { z } from 'zod';

// Search type enum
export const searchTypeEnum = z.enum(['all', 'assets', 'boards', 'users']);

// Search query schema
export const searchQuerySchema = z.object({
  query: z.string().min(1).max(200),
  type: searchTypeEnum.default('all'),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(50).default(20),
  filters: z
    .object({
      assetType: z.enum(['IMAGE', 'VIDEO', 'AUDIO', 'GIF']).optional(),
      dateFrom: z.string().datetime().optional(),
      dateTo: z.string().datetime().optional(),
      userId: z.string().uuid().optional(),
      boardId: z.string().uuid().optional(),
    })
    .optional(),
});

// Search history schema
export const searchHistorySchema = z.object({
  limit: z.coerce.number().int().positive().max(50).default(10),
});

// Save search schema
export const saveSearchSchema = z.object({
  query: z.string().min(1).max(200),
  filters: z.record(z.any()).optional(),
});

// Search suggestions schema
export const searchSuggestionsSchema = z.object({
  query: z.string().min(1).max(100),
  limit: z.coerce.number().int().positive().max(10).default(5),
});

// Types
export type SearchType = z.infer<typeof searchTypeEnum>;
export type SearchQueryInput = z.infer<typeof searchQuerySchema>;
export type SearchHistoryParams = z.infer<typeof searchHistorySchema>;
export type SaveSearchInput = z.infer<typeof saveSearchSchema>;
export type SearchSuggestionsInput = z.infer<typeof searchSuggestionsSchema>;
````

## File: apps/api/src/schemas/user.ts
````typescript
import { z } from 'zod';

// User update schema
export const updateUserSchema = z.object({
  username: z
    .string()
    .min(3)
    .max(30)
    .regex(/^[a-zA-Z0-9_]+$/)
    .optional(),
  displayName: z.string().min(1).max(50).optional(),
  bio: z.string().max(500).optional(),
  avatarUrl: z.string().url().optional(),
  interests: z.array(z.string()).max(10).optional(),
  pronouns: z.string().optional(),
});

// User query params schema
export const userQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(100).default(20),
  search: z.string().optional(),
});

// Username params schema
export const usernameSchema = z.object({
  username: z
    .string()
    .min(3)
    .max(30)
    .regex(/^[a-zA-Z0-9_]+$/),
});

// User ID params schema
export const userIdSchema = z.object({
  userId: z.string().uuid(),
});

// Follow/unfollow schema
export const followUserSchema = z.object({
  targetUserId: z.string().uuid(),
});

// User preferences schema
export const updatePreferencesSchema = z.object({
  theme: z.enum(['light', 'dark', 'system']).optional(),
  emailNotifications: z.boolean().optional(),
  pushNotifications: z.boolean().optional(),
  language: z.string().optional(),
});

// Types
export type UpdateUserInput = z.infer<typeof updateUserSchema>;
export type UserQueryParams = z.infer<typeof userQuerySchema>;
export type UsernameParams = z.infer<typeof usernameSchema>;
export type UserIdParams = z.infer<typeof userIdSchema>;
export type FollowUserInput = z.infer<typeof followUserSchema>;
export type UpdatePreferencesInput = z.infer<typeof updatePreferencesSchema>;
````

## File: apps/api/src/types/env.js
````javascript
export {};
````

## File: apps/api/src/types/env.ts
````typescript
export interface Env {
  // Database
  DATABASE_URL: string;
  HYPERDRIVE?: {
    connectionString: string;
  };
  
  // Authentication
  CLERK_SECRET_KEY: string;
  CLERK_PUBLISHABLE_KEY?: string;
  
  // External services
  AI_SERVICE_URL?: string;
  RESEND_API_KEY?: string;
  PUSHER_APP_ID?: string;
  PUSHER_KEY?: string;
  PUSHER_SECRET?: string;
  PUSHER_CLUSTER?: string;
  
  // Storage
  R2_ACCOUNT_ID?: string;
  R2_ACCESS_KEY_ID?: string;
  R2_SECRET_ACCESS_KEY?: string;
  R2_BUCKET_NAME?: string;
  
  // AI services
  VERTEX_AI_PROJECT?: string;
  VERTEX_AI_LOCATION?: string;
  GOOGLE_APPLICATION_CREDENTIALS?: string;
  
  // Monitoring
  SENTRY_DSN?: string;
  REDIS_URL?: string;
  
  // Environment
  NODE_ENV?: string;
  NEXT_PUBLIC_APP_URL?: string;
}
````

## File: apps/api/src/index.ts
````typescript
import { verifyToken } from '@clerk/backend';
import { RPCHandler } from '@orpc/server/fetch';
import { appRouter, createContext } from '@repo/orpc';
import { createDatabaseClient } from '@repo/database';
import { createServices } from '@repo/services';
import { Hono } from 'hono';
import { compress } from 'hono/compress';
import { cors } from 'hono/cors';
import { HTTPException } from 'hono/http-exception';
import { logger } from 'hono/logger';
import type { Env } from './types/env';

// Re-export Env type for compatibility
export type { Env };

const app = new Hono<{ Bindings: Env }>();

// Global middleware
app.use('*', logger());
// app.use('*', compress()); // Temporarily disable compression for debugging

// CORS configuration - first, doesn't read body
app.use(
  '*',
  cors({
    origin: (origin) => {
      const allowed = [
        'http://localhost:3000',
        'http://localhost:9999',
        'https://squish.xyz',
        'https://*.squish.xyz',
        'https://*.vercel.app',
        'https://squish.vercel.app',
      ];

      if (!origin) {
        return null;
      }

      for (const pattern of allowed) {
        if (pattern.includes('*')) {
          const regex = new RegExp(pattern.replace('*', '.*'));
          if (regex.test(origin)) {
            return origin;
          }
        } else if (origin === pattern) {
          return origin;
        }
      }

      return null;
    },
    allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowHeaders: ['Content-Type', 'Authorization', 'X-Request-ID'],
    exposeHeaders: ['Content-Length', 'X-Request-ID'],
    maxAge: 600,
    credentials: true,
  })
);

// Health check endpoint - normal route
app.get('/health', (c) => {
  return c.json({ status: 'ok', service: 'squish-api' });
});

// --- ORPC x Hono (consensus best-practices pattern) ---
const orpcHandler = new RPCHandler(appRouter);

// Prevent double body-reading if any other middleware could parse the body
const BODY_PARSER_METHODS = new Set(['arrayBuffer', 'blob', 'formData', 'json', 'text'] as const);
type BodyParserMethod = typeof BODY_PARSER_METHODS extends Set<infer T> ? T : never;

app.use('/api/orpc/*', async (c, next) => {
  // Optional auth decode here (Clerk JWT)
  const authHeader = c.req.header('Authorization');
  let user = null;

  if (authHeader?.startsWith('Bearer ')) {
    const token = authHeader.substring(7);
    try {
      const verified = await verifyToken(token, {
        secretKey: c.env.CLERK_SECRET_KEY,
      });

      if (verified?.sub) {
        user = {
          userId: verified.sub,
          sessionId: verified.sid || '',
          orgId: verified.org_id as string | undefined,
          orgRole: verified.org_role as string | undefined,
          orgSlug: verified.org_slug as string | undefined,
          email: verified.email as string | undefined,
        };
      }
    } catch (_error) {
      // Silent fail for auth - some endpoints are public
    }
  }

  // Create database client and services
  const db = createDatabaseClient(c.env.DATABASE_URL);
  const services = createServices({ db, env: c.env });

  const context = createContext({
    user,
    env: c.env,
    requestId: c.req.header('X-Request-ID') ?? crypto.randomUUID(),
    services,
  });

  // Proxy raw Request so body-readers defer to Hono's c.req methods
  const request = new Proxy(c.req.raw, {
    get(target, prop) {
      if (BODY_PARSER_METHODS.has(prop as BodyParserMethod)) {
        return () => (c.req as any)[prop as BodyParserMethod]();
      }
      return Reflect.get(target, prop, target);
    },
  });

  const { matched, response } = await orpcHandler.handle(request, {
    prefix: '/api/orpc', // <-- keep explicit and in sync with the mount path
    context,
  });

  if (matched) {
    return c.newResponse(response.body, response);
  }
  
  await next();
});

// 404 fallback for unmatched ORPC routes
app.all('/api/orpc/*', (c) => {
  return c.json({ error: 'ORPC procedure not found', status: 404 }, 404);
});

// Global error handler
app.onError((err, c) => {
  if (err instanceof HTTPException) {
    return c.json(
      {
        error: err.message,
        status: err.status,
      },
      err.status
    );
  }

  return c.json(
    {
      error: 'Internal Server Error',
      status: 500,
    },
    500
  );
});

// 404 handler
app.notFound((c) => {
  return c.json(
    {
      error: 'Not Found',
      status: 404,
      path: c.req.path,
    },
    404
  );
});

export default app;
````

## File: apps/api/.env.example
````
# Server
CLERK_SECRET_KEY=""
CLERK_WEBHOOK_SECRET=""
RESEND_FROM=""
DATABASE_URL=""
RESEND_TOKEN=""
STRIPE_SECRET_KEY=""
STRIPE_WEBHOOK_SECRET=""
BETTERSTACK_API_KEY=""
BETTERSTACK_URL=""
FLAGS_SECRET=""
ARCJET_KEY=""
SVIX_TOKEN=""
LIVEBLOCKS_SECRET=""
BASEHUB_TOKEN=""
KNOCK_API_KEY=""
KNOCK_FEED_CHANNEL_ID=""

# Client
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=""
NEXT_PUBLIC_CLERK_SIGN_IN_URL="/sign-in"
NEXT_PUBLIC_CLERK_SIGN_UP_URL="/sign-up"
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL="/"
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL="/"
NEXT_PUBLIC_GA_MEASUREMENT_ID=""
NEXT_PUBLIC_POSTHOG_KEY=""
NEXT_PUBLIC_POSTHOG_HOST=""
NEXT_PUBLIC_DOCS_URL="http://localhost:3004"
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_WEB_URL="http://localhost:3001"
````

## File: apps/api/CLAUDE.md
````markdown
# Squish API Service Context (apps/api)

## Development Standards

### Project Context
This is the Cloudflare Workers API service for Squish, built with Hono framework. It provides RESTful APIs for all application features including authentication, board management, asset handling, search, and AI integrations.

### Technology Stack
- **Runtime**: Cloudflare Workers with Node.js compatibility
- **Framework**: Hono 4.6.15 - Fast, lightweight web framework
- **TypeScript**: 5.8.3 with strict configuration
- **ORM**: Drizzle 0.38.2 with PostgreSQL
- **Authentication**: Clerk Backend 1.20.1
- **Validation**: Zod 3.25.28
- **Deployment**: Wrangler CLI for Cloudflare Workers deployment

### Key Dependencies
```json
{
  "dependencies": {
    "hono": "^4.6.15",
    "@cloudflare/workers-types": "^4.20241011.0",
    "@clerk/backend": "^1.20.1",
    "@orpc/server": "^1.7.5",
    "drizzle-orm": "^0.38.2",
    "postgres": "^3.4.5",
    "zod": "^3.25.28",
    "pusher": "^5.2.0",
    "resend": "^4.0.1",
    "stripe": "^17.7.0",
    "svix": "^1.66.0"
  },
  "devDependencies": {
    "wrangler": "^3.100.3",
    "vitest": "^3.1.4"
  }
}
```

## Project Structure

### Directory Layout
```
src/
‚îú‚îÄ‚îÄ index.ts              # Main application entry point
‚îú‚îÄ‚îÄ constants/            # Application constants
‚îÇ   ‚îú‚îÄ‚îÄ error.ts         # Error codes and messages
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Shared constants
‚îú‚îÄ‚îÄ lib/                  # Utility libraries
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts          # Authentication utilities
‚îÇ   ‚îú‚îÄ‚îÄ database.ts      # Database connection
‚îÇ   ‚îú‚îÄ‚îÄ errors.ts        # Error handling helpers
‚îÇ   ‚îú‚îÄ‚îÄ responses.ts     # Standardized response formats
‚îÇ   ‚îú‚îÄ‚îÄ user.ts          # User utilities
‚îÇ   ‚îî‚îÄ‚îÄ utils/           # Additional utilities
‚îú‚îÄ‚îÄ middleware/           # Route middleware
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts          # Authentication middleware
‚îú‚îÄ‚îÄ routes/               # API route definitions
‚îÇ   ‚îú‚îÄ‚îÄ ai.ts            # AI-related endpoints
‚îÇ   ‚îú‚îÄ‚îÄ asset.ts         # Asset management
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts          # Authentication endpoints
‚îÇ   ‚îú‚îÄ‚îÄ board.ts         # Board management
‚îÇ   ‚îú‚îÄ‚îÄ email.ts         # Email services
‚îÇ   ‚îú‚îÄ‚îÄ health.ts        # Health check
‚îÇ   ‚îú‚îÄ‚îÄ presence.ts      # Real-time presence
‚îÇ   ‚îú‚îÄ‚îÄ report.ts        # Reporting endpoints
‚îÇ   ‚îú‚îÄ‚îÄ search.ts        # Search functionality
‚îÇ   ‚îú‚îÄ‚îÄ user.ts          # User management
‚îÇ   ‚îî‚îÄ‚îÄ webhooks.ts      # Webhook handlers
‚îú‚îÄ‚îÄ schemas/              # Zod validation schemas
‚îÇ   ‚îú‚îÄ‚îÄ ai.ts            # AI request/response schemas
‚îÇ   ‚îú‚îÄ‚îÄ asset.ts         # Asset schemas
‚îÇ   ‚îú‚îÄ‚îÄ board.ts         # Board schemas
‚îÇ   ‚îú‚îÄ‚îÄ index.ts         # Schema exports
‚îÇ   ‚îú‚îÄ‚îÄ search.ts        # Search schemas
‚îÇ   ‚îî‚îÄ‚îÄ user.ts          # User schemas
‚îú‚îÄ‚îÄ services/             # Business logic services
‚îÇ   ‚îú‚îÄ‚îÄ ai.ts            # AI service integration
‚îÇ   ‚îú‚îÄ‚îÄ asset.ts         # Asset business logic
‚îÇ   ‚îú‚îÄ‚îÄ board.ts         # Board business logic
‚îÇ   ‚îú‚îÄ‚îÄ index.ts         # Service exports
‚îÇ   ‚îú‚îÄ‚îÄ search.ts        # Search service
‚îÇ   ‚îú‚îÄ‚îÄ unified-ai.ts    # Unified AI orchestration
‚îÇ   ‚îî‚îÄ‚îÄ user.ts          # User service
‚îî‚îÄ‚îÄ env.ts               # Environment variables typing
```

## Architecture Patterns

### Service-Oriented Architecture
The API follows a service-oriented pattern with clear separation:
- **Routes**: HTTP endpoint definitions and request handling
- **Services**: Business logic and domain operations
- **Schemas**: Request/response validation and typing
- **Libraries**: Cross-cutting concerns and utilities
- **Middleware**: Request preprocessing and authentication

### Environment Bindings
```typescript
// src/index.ts - Environment interface
export interface Env {
  // Hyperdrive for database connection pooling
  HYPERDRIVE?: {
    connectionString: string;
  };
  
  // Environment variables
  DATABASE_URL: string;
  CLERK_SECRET_KEY: string;
  // ... other env vars
}
```

## API Patterns

### Route Definition Pattern
```typescript
// src/routes/[feature].ts
import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';
import { createItemSchema, updateItemSchema } from '../schemas';

const app = new Hono<{ Bindings: Env }>();

// GET /api/items
app.get('/', zValidator('query', listItemsSchema), async (c) => {
  const query = c.req.valid('query');
  const items = await itemService.list(query);
  return c.json({ success: true, data: items });
});

// POST /api/items
app.post('/', zValidator('json', createItemSchema), async (c) => {
  const data = c.req.valid('json');
  const item = await itemService.create(data);
  return c.json({ success: true, data: item }, 201);
});

export default app;
```

### Service Layer Pattern
```typescript
// src/services/[feature].ts
export class ItemService {
  constructor(private db: Database) {}
  
  async list(query: ListItemsQuery): Promise<Item[]> {
    const result = await this.db.query.items.findMany({
      where: buildWhereClause(query),
      orderBy: [desc(items.createdAt)],
      limit: query.limit,
    });
    return result;
  }
  
  async create(data: CreateItemInput): Promise<Item> {
    const result = await this.db
      .insert(items)
      .values(data)
      .returning();
    return result[0];
  }
}
```

### Schema Validation Pattern
```typescript
// src/schemas/[feature].ts
import { z } from 'zod';

export const createItemSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().optional(),
  tags: z.array(z.string()).default([]),
  boardId: z.string().uuid(),
});

export type CreateItemInput = z.infer<typeof createItemSchema>;
```

## Database Patterns

### Drizzle ORM Usage
```typescript
// src/lib/database.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from '@repo/database/schema';

export function createDatabase(env: Env) {
  const client = postgres(env.DATABASE_URL, {
    prepare: false,
  });
  
  return drizzle(client, { schema });
}
```

### Query Building
```typescript
// Using Drizzle type-safe queries
const result = await db
  .select()
  .from(boards)
  .leftJoin(boardMembers, eq(boards.id, boardMembers.boardId))
  .where(eq(boardMembers.userId, userId))
  .orderBy(desc(boards.updatedAt));
```

## Authentication Middleware

### Clerk Integration
```typescript
// src/middleware/auth.ts
import { auth } from '@clerk/backend';
import { HTTPException } from 'hono/http-exception';

export const authMiddleware = async (c: Context, next: Next) => {
  const authHeader = c.req.header('Authorization');
  
  if (!authHeader) {
    throw new HTTPException(401, { message: 'Missing authorization header' });
  }
  
  const token = authHeader.replace('Bearer ', '');
  const { userId } = await auth().verifyToken(token);
  
  if (!userId) {
    throw new HTTPException(401, { message: 'Invalid token' });
  }
  
  c.set('userId', userId);
  await next();
};
```

### Protected Route Usage
```typescript
// In route definition
app.use('/protected/*', authMiddleware);

app.get('/protected/data', async (c) => {
  const userId = c.get('userId');
  const data = await service.getUserData(userId);
  return c.json({ data });
});
```

## Error Handling Patterns

### Standardized Responses
```typescript
// src/lib/responses.ts
export const success = (data: any, status = 200) => ({
  success: true,
  data,
  timestamp: new Date().toISOString(),
});

export const error = (message: string, code = 400, details?: any) => ({
  success: false,
  error: {
    message,
    code,
    details,
  },
  timestamp: new Date().toISOString(),
});
```

### Error Types
```typescript
// src/constants/error.ts
export const ErrorCode = {
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  NOT_FOUND: 'NOT_FOUND',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
} as const;

export class AppError extends Error {
  constructor(
    public code: keyof typeof ErrorCode,
    message: string,
    public details?: any
  ) {
    super(message);
    this.name = 'AppError';
  }
}
```

## Testing Patterns

### Vitest Setup
```typescript
// Tests for routes
import { test } from 'vitest';
import { createApp } from '../src/index';
import { createTestContext } from './utils';

test.describe('API Routes', () => {
  let app: any;
  let context: TestContext;
  
  test.beforeEach(() => {
    context = createTestContext();
    app = createApp(context.env);
  });
  
  test('GET /api/health', async () => {
    const res = await app.request('/health');
    expect(res.status).toBe(200);
    const body = await res.json();
    expect(body.success).toBe(true);
  });
});
```

## Deployment Configuration

### Wrangler Configuration
```toml
# wrangler.toml
name = "squish-api"
main = "src/index.ts"
compatibility_date = "2025-04-01"
compatibility_flags = ["nodejs_compat"]

# Observability
[observability]
enabled = true

[observability.logs]
enabled = true

# Environment variables (development)
[vars]
NODE_ENV = "development"
```

### Environment Variables
```typescript
// src/env.ts - Type-safe environment variables
interface Env {
  // Database
  DATABASE_URL: string;
  
  // Authentication
  CLERK_SECRET_KEY: string;
  CLERK_PUBLISHABLE_KEY: string;
  
  // External services
  AI_SERVICE_URL: string;
  RESEND_API_KEY: string;
  PUSHER_APP_ID: string;
  PUSHER_KEY: string;
  PUSHER_SECRET: string;
  PUSHER_CLUSTER: string;
  
  // Storage
  R2_ACCOUNT_ID: string;
  R2_ACCESS_KEY_ID: string;
  R2_SECRET_ACCESS_KEY: string;
  R2_BUCKET_NAME: string;
  
  // AI services
  VERTEX_AI_PROJECT: string;
  VERTEX_AI_LOCATION: string;
  GOOGLE_APPLICATION_CREDENTIALS: string;
  
  // Monitoring
  SENTRY_DSN: string;
  REDIS_URL: string;
}
```

## Development Workflow

### Local Development
```bash
# Start development server
bun run dev

# Build for deployment
bun run build

# Deploy to Cloudflare
bun run deploy

# Deploy to production
bun run deploy:production
```

### Database Setup
```bash
# Setup Hyperdrive for local development
wrangler hyperdrive create squish-db --connection-string="$DATABASE_URL"

# Run database migrations
bun run db:migrate
```

### Testing
```bash
# Run tests
bun run test

# Run tests with coverage
bun run test:coverage

# Type checking
bun run typecheck
```

## Performance Considerations

### Cloudflare Workers Optimization
- Keep CPU time under 10ms for most operations
- Use streaming for large responses
- Cache frequently accessed data
- Minimize cold starts with proper warming

### Database Optimization
- Use Hyperdrive for connection pooling
- Implement query result caching
- Use proper indexing strategies
- Monitor query performance

### API Optimization
- Implement rate limiting
- Use compression middleware
- Optimize response payloads
- Implement pagination

## Monitoring and Observability

### Logging
```typescript
// Structured logging pattern
export const logger = {
  info: (message: string, data?: any) => {
    console.log(JSON.stringify({
      level: 'info',
      message,
      data,
      timestamp: new Date().toISOString(),
    }));
  },
  
  error: (message: string, error?: any) => {
    console.error(JSON.stringify({
      level: 'error',
      message,
      error: error?.stack || error,
      timestamp: new Date().toISOString(),
    }));
  }
};
```

### Metrics
- Track request duration and success rates
- Monitor database query performance
- Track error rates by endpoint
- Monitor memory usage

## Security Considerations

### CORS Configuration
```typescript
// src/index.ts - CORS setup
app.use('*', cors({
  origin: ['https://squish.xyz', 'http://localhost:3000'],
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowHeaders: ['Content-Type', 'Authorization'],
}));
```

### Rate Limiting
```typescript
// Implement rate limiting middleware
const rateLimit = new Map<string, { count: number; reset: number }>();

app.use('*', async (c, next) => {
  const clientIP = c.req.header('CF-Connecting-IP');
  // Implement rate limiting logic
});
```

## Common Tasks

### Adding a New API Endpoint
1. Create schema in `src/schemas/[feature].ts`
2. Add route in `src/routes/[feature].ts`
3. Implement service method in `src/services/[feature].ts`
4. Add authentication middleware if needed
5. Write tests for the endpoint
6. Update API documentation

### Adding a New Database Model
1. Update schema in `@repo/database/src/schema.ts`
2. Generate types: `bun run db:generate`
3. Create migration if needed
4. Update service files with new model usage
5. Update API schemas

### Adding External Integration
1. Add environment variables to `Env` interface
2. Create client/service in `src/lib/` or `src/services/`
2. Add necessary dependencies to package.json
3. Implement error handling for the service
4. Add tests for the integration

## Files to Know

- `src/index.ts` - Main application setup and middleware
- `src/routes/` - All API endpoint definitions
- `src/services/` - Business logic implementations
- `src/schemas/` - Zod validation schemas
- `wrangler.toml` - Cloudflare Workers configuration
- `src/lib/database.ts` - Database connection setup

## Quality Checklist

Before committing changes to this API:
- [ ] TypeScript compiles without errors
- [ ] All API endpoints have proper validation
- [ ] Error handling is implemented
- [ ] Authentication middleware is applied where needed
- [ ] Tests pass for modified endpoints
- [ ] Database queries are optimized
- [ ] CORS and security headers are correct
- [ ] Environment variables are properly typed
- [ ] No sensitive data is logged
- [ ] API documentation is updated

---

*This context ensures Claude Code understands the API service structure and patterns when working on the backend.*
````

## File: apps/api/env.ts
````typescript
// Environment configuration for Hono/Cloudflare Workers
// This file can be removed or simplified as Hono handles environment variables differently
// Environment variables are accessed directly from the context in Hono (c.env)

export const env = {
  // This is a placeholder - actual environment variables are accessed via c.env in Hono
  // Consider removing this file and accessing env vars directly from context
};
````

## File: apps/api/package.json
````json
{
  "name": "api",
  "private": true,
  "scripts": {
    "dev": "wrangler dev",
    "build": "tsc && wrangler deploy --dry-run",
    "deploy": "wrangler deploy",
    "deploy:production": "wrangler deploy --env production",
    "test": "NODE_ENV=test vitest run",
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  },
  "dependencies": {
    "@clerk/backend": "^1.20.1",
    "@cloudflare/workers-types": "^4.20241011.0",
    "@hono/zod-validator": "^0.7.2",
    "@orpc/server": "^1.7.5",
    "@repo/analytics": "workspace:*",
    "@repo/auth": "workspace:*",
    "@repo/database": "workspace:*",
    "@repo/orpc": "workspace:*",
    "@repo/services": "workspace:*",
    "drizzle-orm": "^0.38.2",
    "hono": "^4.6.15",
    "postgres": "^3.4.5",
    "pusher": "^5.2.0",
    "resend": "^4.0.1",
    "stripe": "^17.7.0",
    "svix": "^1.66.0",
    "zod": "^3.25.28"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@types/node": "22.15.21",
    "typescript": "^5.8.3",
    "vitest": "^3.1.4",
    "wrangler": "^3.100.3"
  }
}
````

## File: apps/api/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "lib": ["ES2022", "DOM"],
    "module": "ES2022",
    "target": "ES2022",
    "moduleResolution": "bundler",
    "moduleDetection": "force",
    "allowImportingTsExtensions": true,
    "noEmit": true,
    "composite": true,
    "strict": true,
    "downlevelIteration": true,
    "skipLibCheck": true,
    "jsx": "react-jsx",
    "allowSyntheticDefaultImports": true,
    "forceConsistentCasingInFileNames": true,
    "allowJs": true,
    "types": ["@cloudflare/workers-types"],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@repo/*": ["../../packages/*"]
    }
  },
  "include": [
    "src/**/*",
    "../../packages/orpc/*.ts",
    "../../packages/orpc/adapters/*.ts",
    "../../packages/orpc/dist/**/*.d.ts",
    "../../packages/auth/*.ts",
    "../../packages/auth/types.ts",
    "../../packages/database/*.ts",
    "../../packages/database/src/**/*.ts",
    "../../packages/services/src/**/*.ts",
    "../../packages/storage/*.ts",
    "../../packages/storage/src/**/*.ts",
    "../../packages/logger/*.ts"
  ],
  "exclude": [
    "node_modules",
    "dist",
    "**/*.test.ts",
    "**/*.test.tsx",
    "**/*.spec.ts",
    "**/*.spec.tsx",
    "**/tests/**",
    "**/tests.bak/**",
    "**/__tests__/**",
    "**/__tests__.bak/**",
    "**/test-setup.ts",
    "**/examples/**",
    "**/examples.bak/**",
    "../../packages/database/src/test-setup.ts",
    "../../packages/database/src/env.ts",
    "../../packages/auth/token.ts",
    "../../packages/auth/keys.ts",
    "../../packages/auth/index.ts",
    "../../packages/auth/**/*.tsx",
    "../../packages/orpc/**/*.tsx",
    "../../packages/orpc/hooks/**",
    "../../packages/orpc/__tests__.bak/**",
    "../../packages/orpc/actions.ts",
    "../../packages/storage/src/__tests__/**"
  ]
}
````

## File: apps/api/vitest.config.ts
````typescript
export { default } from '@repo/testing';
````

## File: apps/api/wrangler.toml
````toml
name = "squish-api"
main = "src/index.ts"
compatibility_date = "2025-04-01"

# Compatibility flags required for database drivers
compatibility_flags = ["nodejs_compat"]

# Environment variables
[vars]
NODE_ENV = "production"
AI_SERVICE_URL = "https://black-young-motherboard.mastra.cloud"
NEXT_PUBLIC_APP_URL = "https://squish.xyz"
STORAGE_PROVIDER = "r2"
R2_ACCOUNT_ID = "ace708c6a8408e0711aac868ccb94a82"
R2_BUCKET_NAME = "squish-assets"

# R2 bucket binding
[[r2_buckets]]
binding = "ASSETS_BUCKET"
bucket_name = "squish-assets"

# Observability
[observability]
enabled = true

[observability.logs]
enabled = true

# Routes - to be configured after deployment
# [[routes]]
# pattern = "api.squish.xyz"
# custom_domain = true

# Note: Sensitive environment variables should be set via wrangler secrets:
# wrangler secret put DATABASE_URL
# wrangler secret put CLERK_SECRET_KEY
# wrangler secret put CLERK_PUBLISHABLE_KEY
# wrangler secret put REDIS_URL
# wrangler secret put SENTRY_DSN
# wrangler secret put VERTEX_AI_PROJECT
# wrangler secret put VERTEX_AI_LOCATION
# wrangler secret put GOOGLE_APPLICATION_CREDENTIALS
# wrangler secret put RESEND_API_KEY
# wrangler secret put PUSHER_APP_ID
# wrangler secret put PUSHER_KEY
# wrangler secret put PUSHER_SECRET
# wrangler secret put PUSHER_CLUSTER
# wrangler secret put R2_ACCOUNT_ID
# wrangler secret put R2_ACCESS_KEY_ID
# wrangler secret put R2_SECRET_ACCESS_KEY
# wrangler secret put R2_BUCKET_NAME
````

## File: apps/app/prisma/schema.prisma
````
datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
  extensions = [vector]
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

model Profile {
  id         String   @id @default(cuid())
  email      String   @unique
  full_name  String?
  avatar_url String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  messages           Message[]
  chat_participants ChatParticipant[]
  created_chats     Chat[]          @relation("CreatedBy")

  @@map("profiles")
}

model Chat {
  id         String   @id @default(cuid())
  title      String?
  type       String   @default("personal") // personal, direct, group
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by String
  pinned     Boolean  @default(false)
  is_archived Boolean @default(false)
  labels     String[] @default([])

  // Relations
  creator           Profile           @relation("CreatedBy", fields: [created_by], references: [id])
  chat_participants ChatParticipant[]
  messages          Message[]

  @@map("chats")
}

model ChatParticipant {
  id           String   @id @default(cuid())
  chat_id      String
  user_id      String
  joined_at    DateTime @default(now())
  last_read_at DateTime @default(now())

  // Relations
  chat    Chat    @relation(fields: [chat_id], references: [id], onDelete: Cascade)
  profile Profile @relation(fields: [user_id], references: [id])

  @@unique([chat_id, user_id])
  @@map("chat_participants")
}

model Message {
  id         String                 @id @default(cuid())
  chat_id    String
  content    String
  sender_id  String
  created_at DateTime               @default(now())
  embedding  Unsupported("vector")?
  references Json?

  // Relations
  chat   Chat    @relation(fields: [chat_id], references: [id], onDelete: Cascade)
  sender Profile @relation(fields: [sender_id], references: [id])

  @@map("messages")
}
````

## File: apps/app/public/file.svg
````
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
````

## File: apps/app/public/globe.svg
````
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
````

## File: apps/app/public/logo.svg
````
<?xml version="1.0" encoding="UTF-8"?>
<svg id="Layer_2" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 498 492">
  <defs>
    <style>
      .cls-1 {
        fill: #178bf1;
        stroke-width: 0px;
      }
    </style>
  </defs>
  <g id="Layer_1-2" data-name="Layer 1">
    <path class="cls-1" d="M397.46,48.27C314.78-14.46,71.09-55.46,8.3,185.55c-18.48,70.95-3.89,132.11,22.17,179.26,77.63,140.49,266.9,169.81,385.64,61.74,133.27-121.28,87.04-298.09-18.65-378.28h0ZM246.39,436.83C-29.08,373.24,162.91-5.6,348.35,64.75c183.39,69.57,86.41,415.56-101.95,372.07h0Z"/>
  </g>
</svg>
````

## File: apps/app/public/next.svg
````
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
````

## File: apps/app/public/vercel.svg
````
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
````

## File: apps/app/public/window.svg
````
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
````

## File: apps/app/src/app/(app)/chat/[id]/page.tsx
````typescript
"use client"

import React, { useEffect, useState } from "react"
import { useParams } from "next/navigation"
import { MessageService } from "@/lib/services/message"
import { ChatService } from "@/lib/services/chat"
import type { Message } from "@/types"
import { MessageList } from "@/components/chat/messages/MessageList"
import { MessageInput } from "@/components/chat/messages/MessageInput"
import { ChatHeader } from "@/components/chat/ChatHeader"
import { motion, AnimatePresence } from "framer-motion"
import { useSelector, useDispatch } from "react-redux"
import { useUser } from "@clerk/nextjs"
import { useAppDispatch, useAppSelector } from "@/lib/redux/store"
import { RootState } from "@/lib/redux/store"
import { setActiveContexts, removeContext } from "@/lib/redux/slices/chatSlice"
import { ContextService } from "@/lib/ai/context"
import { ContextBar } from "@/components/chat/context/ContextBar"
import { ContextPanel } from "@/components/chat/context/ContextPanel"
import { useChatContext } from "@/hooks/useChatContext"
import type { Context } from "@/types/ai/context"

export default function ChatRoomPage() {
  const params = useParams()
  const chatId = params.id as string
  const [messages, setMessages] = useState<any[]>([])
  const [localChat, setLocalChat] = useState<any>()
  const [isContextPanelOpen, setIsContextPanelOpen] = useState(false)
  const dispatch = useAppDispatch()
  const { activeContexts } = useSelector((state: RootState) => state.chat.context)
  const chat = useSelector((state: any) => 
    state.chats?.data?.find((c: any) => c.id === chatId)
  ) || localChat
  const supabase = getSupabaseClient()

  // Get chat context data
  const {
    summary,
    topics,
    files,
    participants,
    isLoading: isContextLoading
  } = useChatContext(chatId)

  // Add before the useEffect
  const handleContextChange = async (payload: any) => {
    // Fetch updated context data
    const contexts = await ContextService.getMessageContexts(chatId)
    const typeMap: Record<string, any> = {
      user: 'user',
      thread: 'thread',
      url: 'topic',
      file: 'file'
    }

    const transformedContexts = contexts.map((ctx: any) => ({
      id: ctx.id,
      type: typeMap[ctx.type] || 'topic',
      title: ctx.metadata.title || ctx.metadata.name || ctx.metadata.full_name || 'Untitled',
      subtitle: ctx.metadata.description || ctx.metadata.email,
      metadata: {
        ...ctx.metadata,
        title: ctx.metadata.title || ctx.metadata.name || ctx.metadata.full_name || 'Untitled',
        description: ctx.metadata.description || ctx.metadata.email
      }
    } as Context))
    dispatch(setActiveContexts(transformedContexts))
  }

  useEffect(() => {
    if (!chat) {
      // If chat is not in the store, fetch it directly
      getChat(chatId).then(setLocalChat)
    }

    // Get messages
    supabase
      .from('messages')
      .select(`
        *,
        sender:profiles(email, full_name)
      `)
      .eq('chat_id', chatId)
      .order('created_at', { ascending: true })
      .then(({ data }: any) => {
        if (data) setMessages(data)
      })
  }, [chatId, chat, supabase])

  // Fetch initial context
  useEffect(() => {
    ContextService.getMessageContexts(chatId)
      .then((ctxs: any) => {
        const typeMap: Record<string, any> = {
          user: 'user',
          thread: 'thread',
          url: 'topic',
          file: 'file'
        }

        const transformedContexts = ctxs.map((ctx: any) => ({
          id: ctx.id,
          type: typeMap[ctx.type] || 'topic',
          title: ctx.metadata.title || ctx.metadata.name || ctx.metadata.full_name || 'Untitled',
          subtitle: ctx.metadata.description || ctx.metadata.email,
          metadata: {
            ...ctx.metadata,
            title: ctx.metadata.title || ctx.metadata.name || ctx.metadata.full_name || 'Untitled',
            description: ctx.metadata.description || ctx.metadata.email
          }
        } as Context))
        dispatch(setActiveContexts(transformedContexts))
      })
  }, [chatId, dispatch])

  // Handle real-time context updates
  useEffect(() => {
    const channel = supabase
      .channel(`context-${chatId}`)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'contexts',
        filter: `chat_id=eq.${chatId}`
      }, handleContextChange)
      .subscribe()

    return () => {
      void channel.unsubscribe()
    }
  }, [chatId])

  if (!chat) return null

  return (
    <div className="flex-1 flex flex-col min-h-0">
      <ContextBar 
        contexts={activeContexts as unknown as Context[]}
        onContextRemove={(id) => dispatch(removeContext(id))}
      />
      {/* Header */}
      <ChatHeader
        chatId={chatId}
        type={chat.type}
        title={chat.title}
        participants={chat.chat_participants}
        isContextPanelOpen={isContextPanelOpen}
        onContextPanelToggle={() => setIsContextPanelOpen(!isContextPanelOpen)}
      />

      {/* Context Panel */}
      <ContextPanel
        chatId={chatId}
        summary={summary}
        topics={topics}
        files={files}
        isOpen={isContextPanelOpen}
        onOpenChange={setIsContextPanelOpen}
      />

      {/* Messages or Welcome */}
      <div className="flex-1 flex flex-col min-h-0 relative">
        <AnimatePresence mode="wait">
          {messages.length === 0 ? (
            <motion.div
              key="welcome"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="absolute inset-0 flex items-center justify-center p-4"
            >
              <div className="text-center space-y-4 max-w-md">
                <h2 className="text-2xl tracking-tight">
                  <span className="font-extralight tracking-[-0.05em] text-white/70">new</span>
                  <span className="font-light text-white/90"> {chat.type === 'personal' ? 'note' : 'conversation'}</span>
                </h2>
                <p className="text-sm text-white/40 font-extralight leading-relaxed">
                  {chat.type === 'personal' 
                    ? "start writing your thoughts, ideas, or anything you'd like to remember."
                    : "start a new conversation. your messages are end-to-end encrypted."}
                </p>
              </div>
            </motion.div>
          ) : (
            <MessageList messages={messages} className="flex-1 px-3" />
          )}
        </AnimatePresence>
      </div>

      {/* Input */}
      <div className="px-4 pb-4 flex-shrink-0">
        <MessageInput chatId={chatId} />
      </div>
    </div>
  )
}
````

## File: apps/app/src/app/(app)/chat/layout.tsx
````typescript
"use client"

import React, { useState, useEffect } from "react"
import { useRouter } from "next/navigation"
import { Logo } from "@/components/ui/logo"
import { NewChatMenu } from "@/components/chat/NewChatMenu"
import { ChatList } from "@/components/chat/ChatList"
import { UserMenu } from "@/components/chat/UserMenu"
import { SettingsModal } from "@/components/chat/SettingsModal"
import { createChat } from "@/lib/supabase/chats"
import { useGetProfileQuery } from "@/lib/redux/slices/apiSlice"
import { toast } from "sonner"

export default function ChatLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const [isMenuOpen, setIsMenuOpen] = useState(false)
  const [isUserMenuOpen, setIsUserMenuOpen] = useState(false)
  const [isSettingsOpen, setIsSettingsOpen] = useState(false)
  const router = useRouter()
  const { data: user, isLoading } = useGetProfileQuery()

  useEffect(() => {
    if (!isLoading && !user) {
      router.push('/login')
    }
  }, [isLoading, user, router])

  const handleCreateChat = async (userIds: string[]) => {
    try {
      const chat = await createChat(
        userIds,
        userIds.length === 0 ? 'personal' : 'group'
      )
      router.push(`/chat/${chat.id}`)
      setIsMenuOpen(false)
    } catch (error) {
      console.error('Failed to create chat:', error)
      toast.error('failed to create conversation')
    }
  }

  // Show loading state while checking auth
  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-black text-white">
        <div className="text-sm font-extralight text-white/40">loading...</div>
      </div>
    )
  }

  if (!user) {
    return null
  }

  return (
    <div className="flex h-screen bg-black text-white">
      {/* Sidebar */}
      <div className="w-80 border-r border-white/5 flex flex-col">
        {/* Header */}
        <div className="h-14 flex items-center justify-between px-4 border-b border-white/5">
          <div className="flex items-center">
            <Logo size="sm" className="mr-2" />
            <span className="text-sm font-extralight">enso</span>
          </div>
          
          {/* User menu trigger */}
          <div className="relative">
            <button
              onClick={() => setIsUserMenuOpen(true)}
              className="relative h-8 w-8 rounded-full bg-zinc-800 flex items-center justify-center overflow-hidden transition-transform hover:scale-105"
            >
              {user.user_metadata?.avatar_url ? (
                <img
                  src={user.user_metadata.avatar_url}
                  alt={user.email || ""}
                  className="h-full w-full object-cover"
                />
              ) : (
                <span className="text-sm font-light text-white/40">
                  {user.email?.[0].toUpperCase()}
                </span>
              )}
            </button>

            {/* User menu */}
            <UserMenu
              user={user}
              isOpen={isUserMenuOpen}
              onClose={() => setIsUserMenuOpen(false)}
              onOpenSettings={() => {
                setIsUserMenuOpen(false)
                setIsSettingsOpen(true)
              }}
            />
          </div>
        </div>
        
        {/* Chat list */}
        <div className="flex-1 overflow-auto">
          <ChatList />
        </div>

        {/* New chat button */}
        <div className="relative p-4 border-t border-white/5">
          <button 
            onClick={() => setIsMenuOpen(!isMenuOpen)}
            className="w-full px-4 py-2 rounded-lg bg-zinc-900/50 border border-white/5 text-sm text-white/80 font-extralight hover:bg-zinc-900 transition-colors"
          >
            new chat
          </button>

          <NewChatMenu
            isOpen={isMenuOpen}
            onClose={() => setIsMenuOpen(false)}
            onCreateChat={handleCreateChat}
          />
        </div>
      </div>

      {/* Main content */}
      <div className="flex-1 flex flex-col">
        {children}
      </div>

      {/* Settings modal */}
      <SettingsModal
        user={user}
        isOpen={isSettingsOpen}
        onClose={() => setIsSettingsOpen(false)}
      />
    </div>
  )
}
````

## File: apps/app/src/app/(app)/chat/page.tsx
````typescript
"use client"

import React from "react"

export default function ChatPage() {
  return (
    <div className="flex-1 flex flex-col items-center justify-center p-4">
      <div className="max-w-md text-center space-y-4">
        <h1 className="text-2xl tracking-tight">
          <span className="font-extralight tracking-[-0.05em] text-white/70">welcome to</span>
          <span className="font-light text-white/90"> enso</span>
        </h1>
        <p className="text-sm text-white/40 font-extralight leading-relaxed">
          start a new conversation or select an existing one from the sidebar.
          <br />
          your messages are end-to-end encrypted.
        </p>
      </div>
    </div>
  )
}
````

## File: apps/app/src/app/(auth)/login/page.tsx
````typescript
"use client"

import React, { useState } from "react"
import { useRouter } from "next/navigation"
import { getSupabaseClient } from "@/lib/supabase/client"
import { MagneticButton } from "@/components/ui/magnetic-button"
import { Logo } from "@/components/ui/logo"
import Link from "next/link"
import { toast } from "sonner"

export default function LoginPage() {
  const [email, setEmail] = useState("")
  const [password, setPassword] = useState("")
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()
  const supabase = getSupabaseClient()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)

    try {
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        throw error
      }

      router.push('/chat')
    } catch (error) {
      toast.error("Failed to sign in. Please check your credentials.")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-black text-white p-4">
      <div className="w-full max-w-sm space-y-8">
        <div className="text-center space-y-2">
          <div className="flex items-center justify-center gap-3 mb-1">
            <Logo size="sm" />
            <h1 className="text-2xl tracking-tight">
              <span className="font-extralight tracking-[-0.05em] text-white/70">welcome</span>
              <span className="font-light text-white/90"> back</span>
            </h1>
          </div>
          <p className="text-sm text-white/40 font-extralight">continue your journey</p>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="space-y-1">
            <label htmlFor="email" className="text-xs text-white/40 tracking-wider font-light">
              email
            </label>
            <div className="relative group">
              <div className="absolute -inset-0.5 rounded-lg opacity-0 group-focus-within:opacity-100 bg-[#178bf1]/20 blur transition duration-500" />
              <input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="relative w-full px-4 py-3 bg-zinc-900/50 border border-white/5 rounded-lg text-white/80 text-sm 
                         focus:outline-none focus:ring-0 transition duration-500
                         placeholder:text-white/20 font-light"
                placeholder="you@example.com"
                required
              />
            </div>
          </div>

          <div className="space-y-1">
            <label htmlFor="password" className="text-xs text-white/40 tracking-wider font-light">
              password
            </label>
            <div className="relative group">
              <div className="absolute -inset-0.5 rounded-lg opacity-0 group-focus-within:opacity-100 bg-[#178bf1]/20 blur transition duration-500" />
              <input
                id="password"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="relative w-full px-4 py-3 bg-zinc-900/50 border border-white/5 rounded-lg text-white/80 text-sm 
                         focus:outline-none focus:ring-0 transition duration-500
                         placeholder:text-white/20 font-light"
                required
              />
            </div>
          </div>

          <div className="pt-2">
            <MagneticButton type="submit" disabled={isLoading} className="w-full">
              {isLoading ? "signing in..." : "sign in"}
            </MagneticButton>
          </div>
        </form>

        <div className="text-center">
          <Link
            href="/signup"
            className="text-sm text-white/40 hover:text-white/60 transition-colors font-light"
          >
            don't have an account? sign up
          </Link>
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/app/(auth)/signup/page.tsx
````typescript
"use client"

import React, { useState } from "react"
import { useRouter } from "next/navigation"
import { createBrowserClient } from "@supabase/ssr"
import { MagneticButton } from "@/components/ui/magnetic-button"
import { Logo } from "@/components/ui/logo"
import Link from "next/link"
import { toast } from "sonner"

export default function SignUpPage() {
  const [email, setEmail] = useState("")
  const [password, setPassword] = useState("")
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)

    try {
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${location.origin}/auth/callback`,
        },
      })

      if (error) {
        throw error
      }

      router.push("/verify")
    } catch (error) {
      toast.error("failed to sign up. please try again.")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-black text-white p-4">
      <div className="w-full max-w-sm space-y-8">
        <div className="text-center space-y-2">
          <div className="flex items-center justify-center gap-3 mb-1">
            <Logo size="sm" />
            <h1 className="text-2xl tracking-tight">
              <span className="font-extralight tracking-[-0.05em] text-white/70">create</span>
              <span className="font-light text-white/90"> account</span>
            </h1>
          </div>
          <p className="text-sm text-white/40 font-extralight">begin your journey</p>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="space-y-1">
            <label htmlFor="email" className="text-xs text-white/40 tracking-wider font-light">
              email
            </label>
            <div className="relative group">
              <div className="absolute -inset-0.5 rounded-lg opacity-0 group-focus-within:opacity-100 bg-[#178bf1]/20 blur transition duration-500" />
              <input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="relative w-full px-4 py-3 bg-zinc-900/50 border border-white/5 rounded-lg text-white/80 text-sm 
                         focus:outline-none focus:ring-0 transition duration-500
                         placeholder:text-white/20 font-light"
                placeholder="you@example.com"
                required
              />
            </div>
          </div>

          <div className="space-y-1">
            <label htmlFor="password" className="text-xs text-white/40 tracking-wider font-light">
              password
            </label>
            <div className="relative group">
              <div className="absolute -inset-0.5 rounded-lg opacity-0 group-focus-within:opacity-100 bg-[#178bf1]/20 blur transition duration-500" />
              <input
                id="password"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="relative w-full px-4 py-3 bg-zinc-900/50 border border-white/5 rounded-lg text-white/80 text-sm 
                         focus:outline-none focus:ring-0 transition duration-500
                         placeholder:text-white/20 font-light"
                required
              />
            </div>
          </div>

          <div className="pt-2">
            <MagneticButton type="submit" disabled={isLoading} className="w-full">
              {isLoading ? "signing up..." : "sign up"}
            </MagneticButton>
          </div>
        </form>

        <div className="text-center">
          <Link
            href="/login"
            className="text-sm text-white/40 hover:text-white/60 transition-colors font-light"
          >
            already have an account? sign in
          </Link>
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/app/(auth)/verify/page.tsx
````typescript
"use client"

import React from "react"
import { Logo } from "@/components/ui/logo"
import { MagneticButton } from "@/components/ui/magnetic-button"
import Link from "next/link"

export default function VerifyPage() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-black text-white p-4">
      <div className="w-full max-w-sm space-y-8">
        <div className="text-center space-y-2">
          <div className="flex items-center justify-center gap-3 mb-1">
            <Logo size="sm" />
            <h1 className="text-2xl tracking-tight">
              <span className="font-extralight tracking-[-0.05em] text-white/70">check</span>
              <span className="font-light text-white/90"> your email</span>
            </h1>
          </div>
          <p className="text-sm text-white/40 font-extralight max-w-xs mx-auto">
            we sent you a verification link. click it to activate your account and start your journey.
          </p>
        </div>

        <div className="relative">
          <div className="absolute inset-0 bg-gradient-to-b from-[#178bf1]/10 via-transparent to-transparent blur-xl" />
          <div className="relative bg-zinc-900/50 border border-white/5 rounded-lg p-6 text-center space-y-4">
            <div className="text-sm text-white/60 font-extralight">
              didn't receive the email?
            </div>
            <div className="text-xs text-white/40 font-extralight">
              check your spam folder or
              <button className="text-[#178bf1] hover:text-[#178bf1]/80 transition-colors ml-1">
                request a new link
              </button>
            </div>
          </div>
        </div>

        <div className="text-center pt-4">
          <Link href="/login" passHref legacyBehavior>
            <MagneticButton>
              back to login
            </MagneticButton>
          </Link>
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/app/(marketing)/about/page.tsx
````typescript
"use client"

import React, { useEffect } from "react"
import { motion } from "framer-motion"
import { Header } from "@/components/ui/header"
import { Logo } from "@/components/ui/logo"
import { SharedFooter } from "@/components/ui/shared-footer"

export default function AboutPage() {
  // Prevent scroll issues
  useEffect(() => {
    window.scrollTo(0, 0)
  }, [])

  const fadeIn = {
    initial: { opacity: 0, y: 20 },
    animate: { opacity: 1, y: 0 },
    transition: { duration: 0.8 }
  }

  const sections = [
    {
      title: "in the space between messages,",
      subtitle: "there is meaning.",
      content: "digital conversations have become fragmented‚Äîdisconnected moments lost in time. enso reimagines messaging as a fluid space where context flows naturally and every interaction builds understanding."
    },
    {
      title: "ambient intelligence",
      subtitle: "woven into conversation.",
      content: "we don't generate responses or replace human thought. instead, we enhance your natural flow of conversation with contextual intelligence that surfaces meaning, preserves understanding, and deepens connection."
    },
    {
      title: "beyond the interface,",
      subtitle: "into experience.",
      content: "we've crafted every feature to serve meaning. from thread linking to semantic search, each capability is designed to feel natural and intentional‚Äîenhancing rather than interrupting your conversations."
    },
    {
      title: "your thoughts,",
      subtitle: "amplified.",
      content: "enso grows with you, learning the patterns of your communication and the context of your connections. it's not about artificial conversation‚Äîit's about making your natural conversations more meaningful."
    }
  ]

  const principles = [
    {
      title: "privacy by design",
      content: "your conversations are yours alone. we build trust through design, not promises. every feature, every interaction is crafted with privacy as its foundation."
    },
    {
      title: "intelligence as enhancement",
      content: "our AI features don't replace or generate conversation‚Äîthey enhance your natural communication by preserving context, surfacing connections, and deepening understanding."
    },
    {
      title: "spatial memory",
      content: "conversations have a sense of place. we preserve context through intuitive spatial relationships, making digital dialogue feel as natural as thought itself."
    }
  ]

  return (
    <div className="min-h-screen bg-black text-white">
      <Header />
      
      {/* Hero */}
      <section className="h-[95vh] flex items-center justify-center">
          <div className="text-center">
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 1, delay: 0.2 }}
            >
              <Logo className="transform scale-150 mb-16" />
            </motion.div>
            <motion.h1 
              className="text-4xl md:text-5xl lg:text-6xl font-extralight"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.8, delay: 1 }}
            >
              conversation reimagined
            </motion.h1>
        </div>
      </section>

      {/* Vision Sections */}
      <div className="max-w-4xl mx-auto px-8 pb-32">
        {sections.map((section, index) => (
          <motion.section
            key={index}
            className="mb-32 md:mb-48"
            initial="initial"
            whileInView="animate"
            viewport={{ once: true, margin: "-100px" }}
            variants={{
              initial: { opacity: 0 },
              animate: { opacity: 1 }
            }}
          >
            <motion.div 
              className="space-y-6"
              variants={fadeIn}
            >
              <div className="space-y-1">
                <h2 className="text-2xl md:text-3xl font-extralight text-white/60">
                  {section.title}
                </h2>
                <h3 className="text-2xl md:text-3xl font-light text-white/90">
                  {section.subtitle}
                </h3>
              </div>
              <p className="text-lg md:text-xl font-extralight text-white/60 leading-relaxed max-w-2xl">
                {section.content}
              </p>
            </motion.div>
          </motion.section>
        ))}

      {/* Principles */}
        <div className="border-t border-white/10 pt-32 space-y-24">
            {principles.map((principle, index) => (
            <motion.section
                key={index}
                initial="initial"
                whileInView="animate"
                viewport={{ once: true, margin: "-100px" }}
                variants={fadeIn}
              >
                <div className="space-y-4">
                <h2 className="text-2xl md:text-3xl font-light text-white/90">
                    {principle.title}
                  </h2>
                <p className="text-lg md:text-xl font-extralight text-white/60 leading-relaxed">
                    {principle.content}
                  </p>
                </div>
            </motion.section>
            ))}

          </div>

      {/* Join Us */}
        <motion.section
          className="mt-32 pt-32 border-t border-white/10"
            initial="initial"
            whileInView="animate"
            viewport={{ once: true, margin: "-100px" }}
            variants={fadeIn}
          >
          <div className="space-y-6">
            <h2 className="text-2xl md:text-3xl font-light text-white/90">
              shape the future of conversation
            </h2>
            <p className="text-lg md:text-xl font-extralight text-white/60 leading-relaxed">
              we're looking for people who understand that in the space between messages, there is meaning. who see the poetry in pixels and feel the weight of whitespace.
            </p>
            <div className="pt-8">
              <a 
                href="mailto:hello@enso.chat" 
                className="text-lg text-white/60 hover:text-white/90 transition-colors font-extralight"
              >
                hello@enso.chat
              </a>
            </div>
        </div>
        </motion.section>
      </div>

      <SharedFooter />
    </div>
  )
}
````

## File: apps/app/src/app/(marketing)/blog/page.tsx
````typescript
"use client"

import React, { useEffect, useState } from "react"
import { motion } from "framer-motion"
import { Header } from "@/components/ui/header"
import { ArrowRight, ArrowUpRight } from "lucide-react"
import Link from "next/link"
import { cn } from "@/lib/utils"

interface BlogPost {
  id: string
  title: string
  subtitle: string
  category: string
  date: string
  readTime: string
  preview: string
  href: string
  featured?: boolean
}

const fadeIn = {
  initial: { opacity: 0, y: 20 },
  animate: { opacity: 1, y: 0 },
  transition: { duration: 0.8 }
}

const posts: BlogPost[] = [
  {
    id: "1",
    title: "in the space between messages",
    subtitle: "exploring the ambient intelligence of conversation",
    category: "philosophy",
    date: "feb 2024",
    readTime: "8 min",
    preview: "how ai can enhance rather than replace human connection, creating spaces for meaning to emerge naturally",
    href: "/blog/space-between-messages",
    featured: true
  },
  {
    id: "2",
    title: "the architecture of context",
    subtitle: "building a second brain for conversation",
    category: "technology",
    date: "feb 2024", 
    readTime: "12 min",
    preview: "a deep dive into how we're creating an ai system that understands the subtle layers of human communication",
    href: "/blog/architecture-of-context",
    featured: true
  },
  {
    id: "3",
    title: "design as intelligence",
    subtitle: "the visual language of ambient ai",
    category: "design",
    date: "jan 2024",
    readTime: "6 min",
    preview: "exploring how visual design can make artificial intelligence feel natural and ambient rather than intrusive",
    href: "/blog/design-as-intelligence"
  },
  {
    id: "4",
    title: "embedding conversations",
    subtitle: "technical deep dive into our semantic core",
    category: "engineering",
    date: "feb 2024",
    readTime: "15 min",
    preview: "an in-depth exploration of how we use advanced embedding techniques to create a semantic understanding of conversations",
    href: "/blog/embedding-conversations"
  },
  {
    id: "5",
    title: "the future of digital memory",
    subtitle: "why context is the new content",
    category: "research",
    date: "feb 2024",
    readTime: "10 min",
    preview: "examining how ambient intelligence is transforming the way we think about digital memory and knowledge preservation",
    href: "/blog/future-digital-memory"
  },
  {
    id: "6",
    title: "identity in the age of ai",
    subtitle: "preserving humanity in digital spaces",
    category: "philosophy",
    date: "jan 2024",
    readTime: "7 min",
    preview: "exploring how we maintain authentic human connection while leveraging artificial intelligence in communication",
    href: "/blog/identity-ai-age"
  },
  {
    id: "7",
    title: "vector search at scale",
    subtitle: "building a performant semantic engine",
    category: "engineering",
    date: "jan 2024",
    readTime: "20 min",
    preview: "technical deep dive into our vector search implementation, optimization techniques, and scaling strategies",
    href: "/blog/vector-search-scale"
  },
  {
    id: "8",
    title: "the psychology of ambient ux",
    subtitle: "designing for subconscious interaction",
    category: "design",
    date: "jan 2024",
    readTime: "9 min",
    preview: "how we're using psychological principles to create interfaces that feel natural and intuitive",
    href: "/blog/ambient-ux-psychology"
  },
  {
    id: "9",
    title: "cross-platform context",
    subtitle: "unifying digital conversation",
    category: "product",
    date: "feb 2024",
    readTime: "8 min",
    preview: "how we're bridging the gap between different communication platforms while preserving context and meaning",
    href: "/blog/cross-platform-context"
  },
  {
    id: "10",
    title: "privacy by design",
    subtitle: "building trust in the age of ai",
    category: "security",
    date: "feb 2024",
    readTime: "11 min",
    preview: "our approach to maintaining privacy and security while leveraging advanced ai capabilities",
    href: "/blog/privacy-by-design"
  },
  {
    id: "11",
    title: "the art of suggestion",
    subtitle: "making ai feel ambient",
    category: "product",
    date: "jan 2024",
    readTime: "7 min",
    preview: "exploring how we make ai suggestions feel natural and non-intrusive in conversation flows",
    href: "/blog/art-of-suggestion"
  },
  {
    id: "12",
    title: "knowledge graphs in practice",
    subtitle: "modeling conversation context",
    category: "engineering",
    date: "jan 2024",
    readTime: "16 min",
    preview: "technical exploration of how we use knowledge graphs to model and understand conversation context",
    href: "/blog/knowledge-graphs-practice"
  }
]

// Get unique categories from posts
const categories = Array.from(new Set(posts.map(post => post.category)))

// Get more organic content size variation
const getContentSize = (post: BlogPost, index: number) => {
  // Engineering posts get more space
  if (post.category === 'engineering') {
    return 'large'
  }
  // Philosophy and research posts get medium-large space
  if (post.category === 'philosophy' || post.category === 'research') {
    return 'medium-large'
  }
  // Every fifth post gets medium size for visual interest
  if (index % 5 === 2) {
    return 'medium'
  }
  // Every seventh post gets small size
  if (index % 7 === 3) {
    return 'small'
  }
  // Others get regular size
  return 'regular'
}

export default function BlogPage() {
  const [selectedCategory, setSelectedCategory] = useState<string>('all')
  const featuredPosts = posts.filter(post => post.featured)
  const otherPosts = posts.filter(post => !post.featured)
    .filter(post => selectedCategory === 'all' || post.category === selectedCategory)

  useEffect(() => {
    // Scroll to top on mount
    window.scrollTo(0, 0)
  }, [])

  return (
    <div className="min-h-screen bg-[var(--black-pure)]">
      <Header />
      
      {/* Hero Section */}
      <section className="pt-32 pb-24 px-8 md:px-12 lg:px-16">
        <div className="max-w-[1400px] mx-auto">
          <motion.div 
            className="max-w-2xl"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8 }}
          >
            <h1 className="text-4xl md:text-5xl lg:text-6xl font-extralight tracking-wide text-white/90 leading-tight">
              compiled notes from the team
            </h1>
            <p className="mt-8 text-xl text-white/60 font-extralight leading-relaxed">
              exploring the intersection of artificial intelligence, human connection, and the future of communication
            </p>
          </motion.div>
        </div>
      </section>

      {/* Featured Posts Row */}
      <section className="px-8 md:px-12 lg:px-16 pb-24">
        <div className="max-w-[1400px] mx-auto">
          <h2 className="text-xl font-light text-white/80 mb-8">Featured</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {featuredPosts.map((post, index) => (
              <motion.div
                key={post.id}
                initial="initial"
                animate="animate"
                variants={fadeIn}
                transition={{ delay: index * 0.1 }}
              >
                <Link href={post.href} className="block group">
                  <article className="relative h-full p-8 rounded-2xl border border-white/5 bg-white/2 backdrop-blur-sm hover:bg-white/5 transition-colors">
                    <div className="flex flex-col h-full">
                      <div className="flex items-center justify-between text-sm text-white/40 mb-8">
                        <span>{post.category}</span>
                        <div className="flex items-center gap-4">
                          <span>{post.date}</span>
                          <span>{post.readTime}</span>
                        </div>
                      </div>
                      
                      <h2 className="text-2xl font-light text-white/80 mb-3 group-hover:text-white/90 transition-colors">
                        {post.title}
                      </h2>
                      
                      <h3 className="text-lg text-white/60 mb-6">
                        {post.subtitle}
                      </h3>
                      
                      <p className="text-white/40 font-light mb-8 flex-grow">
                        {post.preview}
                      </p>
                    </div>
                  </article>
                </Link>
              </motion.div>
            ))}
          </div>
        </div>
      </section>

      {/* Category Filters */}
      <section className="px-8 md:px-12 lg:px-16 pb-8">
        <div className="max-w-[1400px] mx-auto">
          <div className="flex items-center justify-center gap-0 py-1">
            <button
              onClick={() => setSelectedCategory('all')}
              className={cn(
                "px-3 py-1 text-sm font-light rounded-lg transition-colors whitespace-nowrap",
                selectedCategory === 'all' ? "text-white/90" : "text-white/40 hover:text-white/60"
              )}
            >
              all
            </button>
            {categories.map((category) => (
              <button
                key={category}
                onClick={() => setSelectedCategory(category)}
                className={cn(
                  "px-3 py-1 text-sm font-light rounded-lg transition-colors whitespace-nowrap",
                  selectedCategory === category ? "text-white/90" : "text-white/40 hover:text-white/60"
                )}
              >
                {category}
              </button>
            ))}
          </div>
        </div>
      </section>

      {/* Posts Grid - More Organic Heights */}
      <section className="px-8 md:px-12 lg:px-16 pb-32">
        <div className="max-w-[1400px] mx-auto">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {otherPosts.map((post, index) => {
              const size = getContentSize(post, index)
              return (
                <motion.div
                  key={post.id}
                  initial="initial"
                  animate="animate"
                  variants={fadeIn}
                  transition={{ delay: index * 0.1 }}
                  className={cn(
                    "group",
                    size === 'large' && "md:col-span-2 lg:col-span-1",
                    size === 'medium-large' && index % 2 === 0 && "md:col-span-2 lg:col-span-1"
                  )}
                >
                  <Link href={post.href} className="block h-full">
                    <article 
                      className={cn(
                        "relative rounded-2xl border border-white/5",
                        "bg-white/2 backdrop-blur-sm hover:bg-white/5 transition-colors h-full"
                      )}
                    >
                      <div className={cn(
                        "flex flex-col",
                        size === 'large' && "p-7",
                        size === 'medium-large' && "p-6",
                        size === 'medium' && "p-5",
                        size === 'small' && "p-4",
                        size === 'regular' && "p-5"
                      )}>
                        <div className="flex items-center justify-between text-sm text-white/40 mb-3">
                          <span>{post.category}</span>
                          <span>{post.readTime}</span>
                        </div>
                        
                        <h2 className={cn(
                          "font-light text-white/80 group-hover:text-white/90 transition-colors",
                          size === 'large' && "text-2xl mb-4",
                          size === 'medium-large' && "text-xl mb-3",
                          size === 'medium' && "text-lg mb-3",
                          size === 'small' && "text-base mb-2",
                          size === 'regular' && "text-lg mb-2"
                        )}>
                          {post.title}
                        </h2>

                        {(size === 'large' || size === 'medium-large') && (
                          <h3 className={cn(
                            "text-white/60 mb-4",
                            size === 'large' && "text-lg",
                            size === 'medium-large' && "text-base"
                          )}>
                            {post.subtitle}
                          </h3>
                        )}
                        
                        <p className={cn(
                          "text-white/40 font-light",
                          size === 'large' && "text-base line-clamp-4",
                          size === 'medium-large' && "text-base line-clamp-3",
                          size === 'medium' && "text-sm line-clamp-3",
                          size === 'small' && "text-sm line-clamp-2",
                          size === 'regular' && "text-sm line-clamp-2"
                        )}>
                          {post.preview}
                        </p>

                        {/* Visual variation for larger cards */}
                        {(size === 'large' || size === 'medium-large') && (
                          <div className="mt-6 h-[1px] w-full bg-gradient-to-r from-white/5 via-white/10 to-white/5" />
                        )}
                      </div>
                    </article>
                  </Link>
                </motion.div>
              )
            })}
          </div>
        </div>
      </section>

      {/* Newsletter Section */}
      <section className="border-t border-white/10">
        <div className="max-w-[1400px] mx-auto px-8 md:px-12 lg:px-16 py-32">
          <div className="flex flex-col md:flex-row items-start justify-between gap-16">
            <div className="flex-1">
              <h3 className="text-3xl font-light text-white/80 mb-4">
                join our newsletter
              </h3>
              <p className="text-lg text-white/60 font-light max-w-lg">
                receive monthly insights on ambient intelligence, the future of communication, and the evolution of ai
              </p>
            </div>
            
            <div className="w-full md:w-auto">
              <div className="flex gap-6">
                <input 
                  type="email" 
                  placeholder="email address" 
                  className="w-full md:w-80 bg-transparent border-b-2 border-white/20 py-3 text-xl text-white/60 placeholder:text-white/40 focus:outline-none focus:border-white/40"
                />
                <button className="text-xl text-white/60 hover:text-white/80 transition-colors flex items-center gap-3">
                  join
                  <ArrowRight className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  )
}
````

## File: apps/app/src/app/(marketing)/features/page.tsx
````typescript
"use client"

import React from "react"
import { motion, AnimatePresence } from "framer-motion"
import { Header } from "@/components/ui/header"
import { MessageInput } from "@/components/chat/messages/MessageInput"
import { MessageBubble } from "@/components/chat/messages/MessageBubble"
import { ReferencePreview } from "@/components/chat/references/ReferencePreview"
import { ChatHeader } from "@/components/chat/ChatHeader"
import { cn } from "@/lib/utils"
import { ContextPreview } from "@/components/chat/context/ContextPreview"
import { STORY_TYPES, CONTEXT_TYPES, CONTEXT_PREVIEWS, DEMO_CONTENT, type StoryType, type ContextType } from "@/lib/constants/demo-content"
import { Footer } from "@/components/ui/footer"
import { SharedFooter } from "@/components/ui/shared-footer"
import { ContextBar } from "@/components/chat/context/ContextBar"
import type { Context } from "@/types/ai/context"

type DemoContent = React.ReactNode | ((story: StoryType) => React.ReactElement)

interface Feature {
  title: string
  subtitle: string
  content: string
  demo: DemoContent
}

export default function FeaturesPage() {
  const [activeContextType, setActiveContextType] = React.useState<ContextType>('user')
  const [activeStory, setActiveStory] = React.useState<StoryType>('social')
  const [hasLoaded, setHasLoaded] = React.useState(false)

  // Set hasLoaded on mount
  React.useEffect(() => {
    setHasLoaded(true)
  }, [])

  const demoFade = {
    initial: { opacity: 0 },
    animate: { opacity: 1 },
    exit: { opacity: 0 },
    transition: { duration: 0.3 }
  }

  const getStoryContent = (story: StoryType) => DEMO_CONTENT[story]

  const demoContexts: Context[] = [
    {
      id: 'demo-user',
      type: 'user',
      title: 'Alex Rivera',
      subtitle: 'Online',
      metadata: {
        email: 'alex@enso.chat',
        avatar_url: '/avatars/alex.jpg'
      }
    },
    {
      id: 'demo-thread',
      type: 'thread',
      title: 'Project Brainstorm',
      subtitle: 'Updated 2h ago',
      metadata: { messages: 24 }
    }
  ]

  const features: Feature[] = [
    {
      title: "thread linking",
      subtitle: "conversations that remember",
      content: "naturally reference past conversations and watch as context flows between threads. no more searching through message history‚Äîjust mention a thread and watch the context emerge.",
      demo: (story: StoryType) => (
        <div className="rounded-2xl border border-white/10 bg-black/40 overflow-hidden backdrop-blur-sm h-[400px] flex flex-col">
          <ChatHeader 
            chatId="demo-1"
            type="group"
            title={getStoryContent(story).threadLinking.title}
            participants={[
              {
                user_id: "1",
                joined_at: new Date().toISOString(),
                last_read_at: new Date().toISOString(),
                profiles: {
                  id: "1",
                  email: "alex@enso.chat",
                  full_name: "Alex Rivera"
                }
              }
            ]}
          />
          
          <div className="p-6 space-y-6 flex-1 overflow-auto">
            <MessageBubble
              message={{
                id: "1",
                chat_id: "demo",
                sender_id: "system",
                content: getStoryContent(story).threadLinking.message,
                created_at: new Date().toISOString(),
                sender: {
                  email: "demo@enso.chat"
                }
              }}
              contexts={demoContexts}
            />
          </div>

          {/* Global context bar */}
          <ContextBar
            contexts={demoContexts}
            onContextRemove={(id) => console.log('remove', id)}
          />
        </div>
      )
    },
    {
      title: "message composition",
      subtitle: "express with intention",
      content: "your thoughts flow naturally into a living web of meaning, weaving connections through the digital consciousness. our ambient intelligence understands your intent, helping ideas resonate across conversations.",
      demo: (
        <div className="rounded-2xl border border-white/10 bg-black/40 overflow-hidden backdrop-blur-sm h-[400px] flex flex-col">
          {/* Add context bar above input */}
          <ContextBar 
            contexts={demoContexts}
            variant="input"
            className="border-b border-white/5"
          />
          
          <div className="p-6 flex-1">
            <MessageInput chatId="demo-2" demo={true} />
          </div>
        </div>
      )
    },
    {
      title: "context intelligence",
      subtitle: "ambient awareness",
      content: "as you chat, enso builds a rich understanding of your conversations. mentions of people, threads, and topics are automatically detected and linked, creating a living tapestry of context that grows with every interaction.",
      demo: (
        <div className="rounded-2xl border border-white/10 bg-black/40 overflow-hidden backdrop-blur-sm h-[400px]">
          <div className="p-6 space-y-4">
            <div className="flex items-center gap-2 mb-4">
              {CONTEXT_TYPES.map((type) => (
                <button
                  key={type}
                  onClick={() => setActiveContextType(type)}
                  className={cn(
                    "px-3 py-1 text-sm font-light rounded-lg transition-colors whitespace-nowrap",
                    type === activeContextType ? "text-white/90 bg-white/5" : "text-white/40 hover:text-white/60"
                  )}
                >
                  {type}
                </button>
              ))}
            </div>
            <div className="space-y-3">
              <AnimatePresence mode="wait">
                <motion.div
                  key={`${activeContextType}-${activeStory}`}
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ 
                    duration: 0.5,
                    ease: [0.4, 0, 0.2, 1]
                  }}
                >
                  <ContextPreview
                    type={activeContextType}
                    {...CONTEXT_PREVIEWS[activeStory][activeContextType]}
                  />
                </motion.div>
              </AnimatePresence>
            </div>
          </div>
        </div>
      )
    }
  ]

  const renderDemo = (feature: Feature) => {
    return (
      <motion.div
        key={`${feature.title}-${activeStory}`}
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        transition={{ 
          duration: 0.5,
          ease: [0.4, 0, 0.2, 1]
        }}
        className="absolute inset-0 lg:px-6"
      >
        {typeof feature.demo === 'function' ? feature.demo(activeStory) : feature.demo}
      </motion.div>
    )
  }

  return (
    <div className="min-h-screen bg-black text-white">
      <Header />
      
      {/* Hero */}
      <section className="h-[50vh] flex items-center justify-center">
        <div className="text-center">
          <motion.h1 
            className="text-4xl md:text-5xl lg:text-6xl font-extralight mb-6"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.6 }}
          >
            features that feel natural
          </motion.h1>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.6, delay: 0.2 }}
          >
            <p className="text-lg md:text-xl font-extralight text-white/60 max-w-2xl mx-auto">
              every capability is designed to enhance your natural flow of conversation,
              <br />not interrupt it
            </p>
          </motion.div>
        </div>
      </section>

      {/* Sticky story selector with glass effect */}
      <div className="sticky top-24 z-40 mb-16 pt-6">
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.6 }}
          className={cn(
            "py-4 px-6 backdrop-blur-[12px] backdrop-saturate-[1.8]",
            "bg-black/[0.65] rounded-xl border border-white/[0.08]",
            "supports-[backdrop-filter]:bg-black/[0.65]",
            "supports-[backdrop-filter]:backdrop-blur-[12px]",
            "inline-block left-1/2 -translate-x-1/2 relative"
          )}
        >
          <div className="flex items-center justify-center gap-0">
            {STORY_TYPES.map((story) => (
              <button
                key={story.value}
                onClick={() => setActiveStory(story.value)}
                className={cn(
                  "px-3 py-1 text-sm font-light rounded-lg transition-colors whitespace-nowrap",
                  story.value === activeStory 
                    ? "text-white/90 bg-white/5" 
                    : "text-white/40 hover:text-white/60"
                )}
              >
                {story.label}
              </button>
            ))}
          </div>
        </motion.div>
      </div>

      {/* Features */}
      <div className="max-w-6xl mx-auto px-8">
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.6 }}
        >
          {features.map((feature, index) => (
            <section
              key={`${feature.title}-${activeStory}`}
              className={cn(
                "min-h-[calc(100vh-8rem)] flex items-center",
                // Add scroll margin to the last section to push up the sticky selector
                index === features.length - 1 ? "scroll-margin-top-[96px]" : ""
              )}
              // Add id to last section for scroll behavior
              id={index === features.length - 1 ? "last-feature" : undefined}
            >
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-24 w-full">
                {/* Feature copy */}
                <div className="lg:sticky lg:top-32 space-y-6">
                  <div className="space-y-2">
                    <h3 className="text-lg text-white/60 font-extralight">
                      {feature.subtitle}
                    </h3>
                    <h2 className="text-3xl md:text-4xl font-light">
                      {feature.title}
                    </h2>
                  </div>
                  <p className="text-lg font-extralight text-white/60 leading-relaxed">
                    {feature.content}
                  </p>
                </div>
                {/* Demo container */}
                <div className="relative h-[400px]">
                  <AnimatePresence mode="wait">
                    {renderDemo(feature)}
                  </AnimatePresence>
                </div>
              </div>
            </section>
          ))}
        </motion.div>
      </div>

      <SharedFooter />
    </div>
  )
}
````

## File: apps/app/src/app/(marketing)/pricing/page.tsx
````typescript
"use client"

import React, { useState } from "react"
import { ArrowRight } from "lucide-react"
import Link from "next/link"
import { Header } from "@/components/ui/header"
import { Card } from "@/components/ui/card"
import { BorderGlowButton } from "@/components/ui/border-glow-button"
import { SharedFooter } from "@/components/ui/shared-footer"
import { cn } from "@/lib/utils"
import { motion } from "framer-motion"
import { LogoCard } from "@/components/ui/logo-card"

// Define gradient colors
const chatGradients = [
  'from-[#178bf1] to-[#4c6ef5]',  // Blue gradient
  'from-[#9333ea] to-[#7c3aed]',  // Purple gradient
  'from-[#ec4899] to-[#d946ef]',  // Pink gradient
  'from-[#2dd4bf] to-[#14b8a6]',  // Teal gradient
  'from-[#f43f5e] to-[#e11d48]',  // Rose gradient
  'from-[#8b5cf6] to-[#6d28d9]'   // Violet gradient
]

interface PricingTier {
  name: string
  price: string
  description: string
  features: string[]
  highlight?: boolean
  aiOps: string
  history: string
  glowColor?: string
  borderGlowColor?: string
}

const tiers: PricingTier[] = [
  {
    name: "essence",
    price: "$2",
    description: "personal messaging with ambient intelligence.",
    aiOps: "100 AI operations per day",
    history: "30-day message history",
    glowColor: "rgba(255, 255, 255, 0.1)",
    borderGlowColor: "rgba(255, 255, 255, 0.2)",
    features: [
      "unlimited 1:1 conversations",
      "basic thread linking & context",
      "semantic search",
      "web & mobile access",
      "basic integrations (read-only)"
    ]
  },
  {
    name: "flow",
    price: "$10",
    description: "enhanced intelligence for power users.",
    highlight: true,
    aiOps: "1000 AI operations per day",
    history: "unlimited message history",
    glowColor: "rgba(96, 165, 250, 0.2)",
    borderGlowColor: "rgba(96, 165, 250, 0.3)",
    features: [
      "everything in essence, plus:",
      "advanced semantic search",
      "voice messages & transcription",
      "advanced thread linking",
      "custom themes",
      "priority AI queue access",
      "full integrations",
      "offline access"
    ]
  },
  {
    name: "aether",
    price: "$20",
    description: "private spaces with shared intelligence.",
    aiOps: "priority AI access",
    history: "unlimited message history",
    glowColor: "rgba(167, 139, 250, 0.2)",
    borderGlowColor: "rgba(167, 139, 250, 0.3)",
    features: [
      "everything in flow, plus:",
      "private spaces (up to 12 people)",
      "shared context building",
      "group semantic search",
      "space-wide thread linking",
      "custom space themes",
      "advanced media sharing",
      "space-specific AI tuning",
      "enhanced privacy",
      "priority support"
    ]
  }
]

const faqs = [
  {
    question: "why do all plans require payment?",
    answer: "we use advanced AI models that are costly to run. rather than compromise the experience with a limited free tier, we offer a fair trial and accessible pricing for sustained quality."
  },
  {
    question: "how do AI operations work?",
    answer: "AI operations include message analysis, thread linking, semantic search, and other intelligent features. solo users get 100 operations daily, plus users get 1000, and space users get priority access."
  },
  {
    question: "what happens if i hit my AI operation limit?",
    answer: "you'll still be able to send messages and use basic features. AI features will resume the next day, or you can upgrade your plan for immediate access to more operations."
  },
  {
    question: "do you store my messages?",
    answer: "messages are stored securely and encrypted. solo tier keeps 30 days of history, while plus and space get unlimited history. you can export your data anytime."
  },
  {
    question: "what about data privacy?",
    answer: "we take privacy seriously. your messages are encrypted, and you can enable enhanced privacy mode to ensure your data is never used for model training."
  }
]

export default function PricingPage() {
  const [position, setPosition] = useState({ x: 50, y: 50 })

  const handleMouseMove = (e: React.MouseEvent<HTMLElement>) => {
    const rect = e.currentTarget.getBoundingClientRect()
    const x = ((e.clientX - rect.left) / rect.width) * 100
    const y = ((e.clientY - rect.top) / rect.height) * 100
    setPosition({ x, y })
  }

  return (
    <div className="min-h-screen bg-[var(--black-pure)] text-white">
      <Header />
      
      {/* Main content */}
      <main className="pt-32 pb-20">
        {/* Hero */}
        <div className="text-center mb-16">
          <h1 className="flex flex-col gap-2 text-4xl md:text-5xl lg:text-6xl font-light mb-4">
            <span>ambient intelligence</span>
            <span>for modern messaging</span>
          </h1>
          <div className="flex flex-col items-center gap-3">
            <p className="text-xl text-white/60 font-extralight">
              start with a 14-day trial of flow features
            </p>
            <span className="text-sm text-white/40 font-extralight tracking-wide">
              no credit card required
            </span>
          </div>
        </div>

        {/* Pricing grid */}
        <div className="max-w-[1400px] mx-auto px-8">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {tiers.map((tier) => (
              <Card
                key={tier.name}
                onMouseMove={tier.highlight ? handleMouseMove : undefined}
                className={cn(
                  "relative border rounded-lg overflow-hidden",
                  tier.highlight
                    ? "border-[var(--blue-primary)]"
                    : "border-white/10 hover:border-white/20 bg-white/[0.02]"
                )}
              >
                {tier.highlight && (
                  <motion.div
                    className="absolute inset-0 pointer-events-none"
                    animate={{
                      opacity: 1,
                    }}
                    transition={{ duration: 0.2 }}
                  >
                    <div
                      className="absolute inset-0"
                      style={{
                        background: `radial-gradient(${800}px circle at ${position.x}% ${position.y}%, rgba(96, 165, 250, 0.03), transparent 40%)`,
                      }}
                    />
                  </motion.div>
                )}
                <div className="p-6 flex flex-col h-full relative z-10">
                  {/* Header */}
                  <div className="mb-6">
                    <div className="flex items-baseline justify-between mb-2">
                      <h3 className="text-lg font-light">{tier.name}</h3>
                      <div className="flex items-baseline gap-1">
                        <span className="text-2xl font-light">{tier.price}</span>
                        <span className="text-sm text-white/60">/month</span>
                      </div>
                    </div>
                    <p className="text-sm text-white/60 font-extralight">
                      {tier.description}
                    </p>
                  </div>

                  {/* AI Stats */}
                  <div className="mb-6 py-2 border-y border-white/10">
                    <div className="text-sm font-extralight">
                      {tier.aiOps}
                    </div>
                    <div className="text-sm text-white/40 font-extralight">
                      {tier.history}
                    </div>
                  </div>

                  {/* Features */}
                  <ul className="space-y-2 mb-6 flex-grow">
                    {tier.features.map((feature, i) => (
                      <li 
                        key={feature}
                        className={cn(
                          "text-sm font-extralight pl-3 border-l",
                          i === 0 
                            ? "text-white/80 border-[var(--blue-primary)]" 
                            : "text-white/60 border-white/10"
                        )}
                      >
                        {feature}
                      </li>
                    ))}
                  </ul>

                  {/* CTA */}
                  <BorderGlowButton
                    asChild
                    glowColor={tier.highlight 
                      ? "rgba(96, 165, 250, 0.15)"
                      : tier.glowColor}
                    borderGlowColor={tier.highlight
                      ? "rgba(96, 165, 250, 0.3)"
                      : tier.borderGlowColor}
                    className={cn(
                      "w-full py-2 px-4 mt-auto",
                      "border border-white/10 hover:border-white/20",
                      tier.highlight
                        ? "bg-[var(--blue-primary)]/10 hover:bg-[var(--blue-primary)]/20 text-white/90"
                        : "text-white/60 hover:text-white/80"
                    )}
                  >
                    <Link href="/signup" className="flex items-center justify-center gap-2 text-sm font-light group">
                      start trial
                      <ArrowRight className="w-3.5 h-3.5 group-hover:translate-x-1 transition-transform" />
                    </Link>
                  </BorderGlowButton>
                </div>
              </Card>
            ))}
          </div>
        </div>

        {/* FAQs */}
        <div className="max-w-[1400px] mx-auto px-8 mt-24">
          <h2 className="text-2xl font-light mb-12 text-center">
            frequently asked questions
          </h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-6xl mx-auto">
            {/* First Row */}
            <Card
              key={faqs[0].question}
              className="relative border rounded-lg overflow-hidden border-white/10 hover:border-white/20 bg-white/[0.02] md:col-span-2"
            >
              <div className="p-6 h-full">
                <h3 className="text-base font-light mb-3 text-white/80">
                  {faqs[0].question}
                </h3>
                <p className="text-sm text-white/60 font-extralight leading-relaxed">
                  {faqs[0].answer}
                </p>
              </div>
            </Card>

            <Card
              key={faqs[1].question}
              className="relative border rounded-lg overflow-hidden border-white/10 hover:border-white/20 bg-white/[0.02] md:row-span-2"
            >
              <div className="p-6 h-full">
                <h3 className="text-base font-light mb-3 text-white/80">
                  {faqs[1].question}
                </h3>
                <p className="text-sm text-white/60 font-extralight leading-relaxed">
                  {faqs[1].answer}
                </p>
              </div>
            </Card>

            {/* First Decorative Card */}
            <Card 
              className="relative group border rounded-lg overflow-hidden border-white/10 aspect-[3/3] hover:border-white/20 transition-colors duration-300"
            >
              <LogoCard className="absolute inset-0" />
            </Card>

            <Card
              key={faqs[2].question}
              className="relative border rounded-lg overflow-hidden border-white/10 hover:border-white/20 bg-white/[0.02]"
            >
              <div className="p-6 h-full">
                <h3 className="text-base font-light mb-3 text-white/80">
                  {faqs[2].question}
                </h3>
                <p className="text-sm text-white/60 font-extralight leading-relaxed">
                  {faqs[2].answer}
                </p>
              </div>
            </Card>

            {/* Third Row */}
            <Card
              key={faqs[3].question}
              className="relative border rounded-lg overflow-hidden border-white/10 hover:border-white/20 bg-white/[0.02] md:col-span-2"
            >
              <div className="p-6 h-full">
                <h3 className="text-base font-light mb-3 text-white/80">
                  {faqs[3].question}
                </h3>
                <p className="text-sm text-white/60 font-extralight leading-relaxed">
                  {faqs[3].answer}
                </p>
              </div>
            </Card>

            {/* Second Decorative Card */}
            <Card 
              className="relative group border rounded-lg overflow-hidden border-white/10 aspect-[3/4] hover:border-white/20 transition-colors duration-300"
            >
              <LogoCard className="absolute inset-0" />
            </Card>

            {/* Fourth Row */}
            <Card
              key={faqs[4].question}
              className="relative border rounded-lg overflow-hidden border-white/10 hover:border-white/20 bg-white/[0.02] md:col-span-3"
            >
              <div className="p-6 h-full">
                <h3 className="text-base font-light mb-3 text-white/80">
                  {faqs[4].question}
                </h3>
                <p className="text-sm text-white/60 font-extralight leading-relaxed">
                  {faqs[4].answer}
                </p>
              </div>
            </Card>
          </div>
        </div>
      </main>

      <SharedFooter />
    </div>
  )
}
````

## File: apps/app/src/app/(marketing)/layout.tsx
````typescript
"use client"

import { Header } from "@/components/ui/header"
import { MobileNavDock } from "@/components/ui/mobile-nav-dock"

interface MarketingLayoutProps {
  children: React.ReactNode
}

export default function MarketingLayout({ children }: MarketingLayoutProps) {
  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1">
        {children}
      </main>
      <MobileNavDock />
    </div>
  )
}
````

## File: apps/app/src/app/(marketing)/page.tsx
````typescript
"use client"

import React, { useEffect, useState } from "react"
import { createBrowserClient } from "@supabase/ssr"
import type { Session } from "@supabase/supabase-js"
import { ArrowRight } from "lucide-react"
import Link from "next/link"
import { useRouter } from "next/navigation"
import { Logo } from "@/components/ui/logo"
import { Header } from "@/components/ui/header"
import { MessageInput } from "@/components/chat/messages/MessageInput"
import { MessageBubble } from "@/components/chat/messages/MessageBubble"
import { ReferencePreview } from "@/components/chat/references/ReferencePreview"
import { motion } from "framer-motion"
import { ChatHeader } from "@/components/chat/ChatHeader"
import { SharedFooter } from "@/components/ui/shared-footer"
import { CONTEXT_TYPES, CONTEXT_PREVIEWS } from "@/lib/constants/demo-content"

export default function RootPage() {
  const router = useRouter()
  const [isLoading, setIsLoading] = useState(true)
  const [session, setSession] = useState<Session | null>(null)

  // Prevent scroll on mount and any time content changes
  useEffect(() => {
    const preventScroll = () => {
      window.scrollTo(0, 0)
    }

    // Initial prevention
    preventScroll()

    // Add listener for any dynamic content changes
    window.addEventListener('scroll', preventScroll, { once: true })

    // Cleanup
    return () => {
      window.removeEventListener('scroll', preventScroll)
    }
  }, [])

  useEffect(() => {
    const supabase = createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )

    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setIsLoading(false)
    })
  }, [])

  // Handle loading state
  if (isLoading) return null

  // Redirect if logged in
  if (session) {
    router.push("/chat")
    return null
  }

  // Update the demo messages to show a more relatable group chat
  const demoMessages = [{
    id: "1",
    chat_id: "demo",
    sender_id: "user_1",
    content: "omg tickets secured for weekend 1!! üé°‚ú®",
    created_at: new Date().toISOString(),
    sender: { email: "kai@enso.chat" }
  }, {
    id: "2",
    chat_id: "demo",
    sender_id: "user_2",
    content: "LETS GOOO!! check the >festival-memories from last year, we need to recreate that sunset pic at the ferris wheel üåÖ",
    created_at: new Date().toISOString(),
    sender: { email: "emma@enso.chat" }
  }, {
    id: "3",
    chat_id: "demo",
    sender_id: "user_3",
    content: "@mia did you see frank ocean is headlining?? üò≠ i'm literally crying rn",
    created_at: new Date().toISOString(),
    sender: { email: "alex@enso.chat" }
  }, {
    id: "4",
    chat_id: "demo",
    sender_id: "user_1",
    content: "adding everything to #festival-fits!! need to start planning the looks asap üëó",
    created_at: new Date().toISOString(),
    sender: { email: "mia@enso.chat" }
  }
]

  return (
    <>
      <Header />
      
      {/* Hero section */}
      <section className="relative min-h-screen flex items-center justify-center bg-[var(--black-pure)]">
        <div className="absolute inset-0 overflow-hidden">
          {/* Gradient background */}
          <div className="absolute inset-0 bg-gradient-to-b from-[var(--black-pure)] via-[var(--black-pure)] to-black opacity-80" />
        </div>

        <div className="relative w-full max-w-[1400px] mx-auto px-8 md:px-12 lg:px-16">
          <div className="flex flex-col items-center text-center">
            {/* Logo */}
            <motion.div
              initial={{ opacity: 0, scale: 0.8 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ duration: 0.8 }}
            >
              <Logo size="lg" />
            </motion.div>

            {/* Taglines */}
            <div className="mt-12 space-y-4">
              <motion.h1
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.8, delay: 0.5 }}
                className="text-4xl md:text-5xl lg:text-6xl tracking-tight"
              >
                <span className="font-extralight tracking-[-0.05em] text-white/40">conversation</span>
                <span className="font-light text-white/90"> reimagined</span>
              </motion.h1>

              <div className="flex flex-col items-center space-y-2">
                <motion.p
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.8, delay: 1 }}
                  className="text-lg md:text-xl text-white/40 font-extralight max-w-xl mx-auto"
                >
                  experience chat that remembers, understands, and grows
                </motion.p>

                <motion.p
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.8, delay: 1.3 }}
                  className="text-lg md:text-xl text-white/40 font-extralight max-w-xl mx-auto"
                >
                  powered by ambient intelligence
                </motion.p>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Demo section with black background */}
      <section className="bg-[var(--black-pure)] min-h-[70vh] flex flex-col -mt-32 border-t border-white/10">
        {/* Demo container */}
        <div className="flex-1 flex items-start justify-center pt-32 pb-4">
          <div className="w-full max-w-[1400px] mx-auto px-8 md:px-12 lg:px-16">
            <div className="relative max-w-4xl mx-auto border border-white/5 rounded-2xl">
              {/* Chat window frame */}
              <div className="relative rounded-2xl bg-black/40 overflow-hidden backdrop-blur-sm">
                <ChatHeader 
                  chatId="demo"
                  type="group"
                  title="coachella chat üé°"
                  participants={[
                    {
                      user_id: "1",
                      joined_at: new Date().toISOString(),
                      last_read_at: new Date().toISOString(),
                      profiles: {
                        id: "1",
                        email: "emma@enso.chat",
                        full_name: "Emma Chen"
                      }
                    },
                    {
                      user_id: "2",
                      joined_at: new Date().toISOString(),
                      last_read_at: new Date().toISOString(),
                      profiles: {
                        id: "2",
                        email: "alex@enso.chat",
                        full_name: "Alex Rivera"
                      }
                    },
                    {
                      user_id: "3",
                      joined_at: new Date().toISOString(),
                      last_read_at: new Date().toISOString(),
                      profiles: {
                        id: "3",
                        email: "maya@enso.chat",
                        full_name: "Maya Patel"
                      }
                    }
                  ]}
                  demo={true}
                />
                {/* Chat content */}
                <div className="p-10 space-y-4">
                  {/* Messages */}
                  {demoMessages.map((message) => (
                    <MessageBubble key={message.id} message={message} className="text-lg" />
                  ))}

                  <MessageInput chatId="demo" className="text-lg" demo={true} />
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <SharedFooter />
    </>
  )
}
````

## File: apps/app/src/app/api/ai/analyze-message/route.ts
````typescript
import { NextResponse } from 'next/server'
import { VertexAI } from '@google-cloud/vertexai'
import { prisma } from '@/lib/db/client'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { content, context } = await req.json()

    // 1. Generate embedding using Vertex AI
    const vertexAI = new VertexAI({
      project: env.GOOGLE_PROJECT_ID,
      location: 'us-central1',
      googleCredentials: JSON.parse(env.GOOGLE_CREDENTIALS),
    })

    const embeddingModel = vertexAI.preview.getGenerativeModel({
      model: 'multimodalembedding@001',
    })

    const embeddingResult = await embeddingModel.embedContent({
      content: { parts: [{ text: content }] }
    })

    // 2. Quick ambient analysis with Gemini Flash
    const ambientAnalysis = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${env.OPENROUTER_API_KEY}`,
        'HTTP-Referer': env.SITE_URL || 'https://enso.chat',
        'X-Title': 'Enso AI'
      },
      body: JSON.stringify({
        model: 'google/gemini-2.0-flash-001',
        messages: [
          {
            role: 'system',
            content: 'You are an ambient intelligence system. Analyze the message for key topics, entities, sentiment, and technical details. For code or complex content, provide deeper technical insights. Be concise and focus on the most relevant information.'
          },
          {
            role: 'user',
            content: `Analyze this message in the following context:\n\nContext: ${context?.threadContext || 'No context provided'}\n\nMessage: ${content}`
          }
        ]
      })
    })

    const ambientResult = await ambientAnalysis.json()
    const quickAnalysis = ambientResult.choices[0].message.content

    // 3. Additional deep analysis if needed
    let deepAnalysis = null
    if (content.length > 100 || content.includes('```') || /\[.*?\]/.test(content)) {
      const deepResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${env.OPENROUTER_API_KEY}`,
          'HTTP-Referer': env.SITE_URL || 'https://enso.chat',
          'X-Title': 'Enso AI'
        },
        body: JSON.stringify({
          model: 'google/gemini-2.0-flash-001',
          messages: [
            {
              role: 'system',
              content: 'You are an expert analysis system. Provide deep technical insights about this message, including code analysis, technical references, and complex relationships. Focus on technical accuracy and detailed understanding.'
            },
            {
              role: 'user',
              content: `Perform deep technical analysis of this message:\n\nContext: ${context?.threadContext || 'No context provided'}\n\nMessage: ${content}`
            }
          ]
        })
      })

      const deepResult = await deepResponse.json()
      deepAnalysis = deepResult.choices[0].message.content
    }

    // Parse and structure the analysis results
    const analysis = {
      embedding: embeddingResult.embedding.values,
      topics: extractTopics(quickAnalysis),
      entities: extractEntities(quickAnalysis),
      sentiment: extractSentiment(quickAnalysis),
      references: extractReferences(quickAnalysis),
      summary: deepAnalysis || quickAnalysis
    }

    return NextResponse.json(analysis)
  } catch (error: any) {
    console.error('Error in analyze-message:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}

// Helper functions
function extractTopics(text: string): string[] {
  // Implement topic extraction logic
  return []
}

function extractEntities(text: string): string[] {
  // Implement entity extraction logic
  return []
}

function extractSentiment(text: string): string {
  // Implement sentiment extraction logic
  return 'neutral'
}

function extractReferences(text: string): {
  threads: string[]
  files: string[]
  urls: string[]
} {
  // Implement reference extraction logic
  return {
    threads: [],
    files: [],
    urls: []
  }
}
````

## File: apps/app/src/app/api/ai/find-references/route.ts
````typescript
import { NextResponse } from 'next/server'
import { VertexAI } from '@google-cloud/vertexai'
import { prisma } from '@/lib/db/client'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { query } = await req.json()

    if (!query) {
      return NextResponse.json(
        { error: 'Query parameter is required' },
        { status: 400 }
      )
    }

    // Generate embedding for query
    const vertexAI = new VertexAI({
      project: env.GOOGLE_PROJECT_ID,
      location: 'us-central1',
      googleCredentials: JSON.parse(env.GOOGLE_CREDENTIALS),
    })

    const model = vertexAI.preview.getGenerativeModel({
      model: 'multimodalembedding@001',
    })

    const result = await model.embedContent({
      content: { parts: [{ text: query }] }
    })

    const embedding = result.embedding.values

    // Search for similar content using Prisma
    const matches = await prisma.$queryRaw`
      SELECT 
        id,
        content,
        meta,
        1 - (embedding <=> ${embedding}::vector) as similarity
      FROM "Message"
      WHERE 1 - (embedding <=> ${embedding}::vector) > 0.7
      ORDER BY similarity DESC
      LIMIT 5
    `

    return NextResponse.json({ matches })
  } catch (error: any) {
    console.error('Error in find-references:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/ai/generate-embedding/route.ts
````typescript
import { NextResponse } from 'next/server'
import { VertexAI } from '@google-cloud/vertexai'
import { prisma } from '@/lib/db/client'
import { KVStorage } from '@/lib/storage/kv'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { text, imageUrl } = await req.json()
    
    // Validate input
    if (!text && !imageUrl) {
      return NextResponse.json(
        { error: "Must provide text or image URL" }, 
        { status: 400 }
      )
    }

    // Initialize Vertex AI
    const vertexAI = new VertexAI({
      project: env.GOOGLE_PROJECT_ID,
      location: 'us-central1',
      googleCredentials: JSON.parse(env.GOOGLE_CREDENTIALS),
    })

    // Generate embedding
    const model = vertexAI.preview.getGenerativeModel({
      model: 'multimodalembedding@001',
    })

    const result = await model.embedContent({
      content: { 
        parts: [
          { text },
          ...(imageUrl ? [{ image: { gcsUri: imageUrl } }] : [])
        ] 
      }
    })

    const embedding = result.embedding.values

    // Cache the embedding
    if (text) {
      const contentHash = await crypto.subtle.digest(
        'SHA-256',
        new TextEncoder().encode(text)
      )
      const hashHex = Array.from(new Uint8Array(contentHash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')

      await KVStorage.cacheEmbedding(hashHex, embedding)
    }

    return NextResponse.json({ 
      embedding,
      dimension: embedding.length
    })

  } catch (error: any) {
    console.error('Error in generate-embedding:', error)
    return NextResponse.json(
      { error: error.message }, 
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/ai/generate-response/route.ts
````typescript
import { NextResponse } from 'next/server'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { prompt, context } = await req.json()
    
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${env.OPENROUTER_API_KEY}`,
        'HTTP-Referer': env.SITE_URL || 'https://enso.chat',
        'X-Title': 'Enso AI'
      },
      body: JSON.stringify({
        model: 'google/gemini-2.0-flash-001',
        messages: [
          {
            role: 'system',
            content: 'You are a helpful and knowledgeable AI assistant. Provide accurate, relevant, and well-structured responses.'
          },
          {
            role: 'user',
            content: context ? `${context}\n\n${prompt}` : prompt,
          },
        ],
        temperature: 0.7,
        max_tokens: 1000,
      }),
    })

    const result = await response.json()

    if (!response.ok) {
      throw new Error(result.error?.message || 'Failed to generate response')
    }

    return NextResponse.json({
      response: result.choices[0].message.content,
    })
  } catch (error: any) {
    console.error('Error in generate-response:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/ai/generate-tags/route.ts
````typescript
import { NextResponse } from 'next/server'
import { VertexAI } from '@google-cloud/vertexai'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { content } = await req.json()
    
    if (!content) {
      return NextResponse.json(
        { error: 'Content is required' },
        { status: 400 }
      )
    }

    const vertexAI = new VertexAI({
      project: env.GOOGLE_PROJECT_ID,
      location: 'us-central1',
      googleCredentials: JSON.parse(env.GOOGLE_CREDENTIALS),
    })

    const model = vertexAI.preview.getGenerativeModel({
      model: 'gemini-pro',
    })

    const result = await model.generateContent({
      contents: [{ 
        role: 'user', 
        parts: [{ text: `Generate relevant tags for the following content. Return only a JSON array of strings, no additional text:\n\n${content}` }] 
      }],
    })

    const tags = JSON.parse(result.response.candidates[0].content.parts[0].text.trim())

    return NextResponse.json({ tags })
  } catch (error: any) {
    console.error('Error generating tags:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/ai/get-reference-suggestions/route.ts
````typescript
import { VertexAI } from '@google-cloud/vertexai';
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

export const runtime = 'edge';

export async function POST(request: Request) {
  try {
    // Initialize Vertex AI
    const vertexAI = new VertexAI({
      project: process.env.GOOGLE_PROJECT_ID!,
      location: 'us-central1',
    });

    const { query, type } = await request.json();
    
    if (!query) {
      return NextResponse.json(
        { error: 'Query parameter is required' },
        { status: 400 }
      );
    }

    // Generate embedding for the query
    const model = vertexAI.preview.getModel('textembedding-gecko@001');
    const embeddingRequest = {
      instances: [
        { content: query }
      ]
    };
    const response = await model.predict(embeddingRequest);
    const embedding = response.predictions[0].embeddings;

    if (!embedding) {
      return NextResponse.json(
        { error: 'Failed to generate embedding' },
        { status: 500 }
      );
    }

    // Create Supabase client
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );

    // Search for similar references using vector similarity
    const { data: references, error } = await supabase.rpc('search_references', {
      query_embedding: embedding,
      similarity_threshold: 0.7,
      match_count: 5,
      ref_type: type || null,
    });

    if (error) throw error;

    return NextResponse.json({ references: references || [] });
  } catch (error: any) {
    console.error('Error in get-reference-suggestions:', error);
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    );
  }
}
````

## File: apps/app/src/app/api/ai/process-embedding-queue/route.ts
````typescript
import { VertexAI } from '@google-cloud/vertexai';
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

export const runtime = 'edge';

export async function POST() {
  try {
    // Initialize Vertex AI
    const vertexAI = new VertexAI({
      project: process.env.GOOGLE_PROJECT_ID!,
      location: 'us-central1',
    });

    // Create Supabase client
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );

    // Get next job from queue
    const { data: job, error: jobError } = await supabase.rpc('get_next_embedding_job');
    if (jobError) throw jobError;

    if (!job) {
      return NextResponse.json(
        { message: 'No jobs to process' },
        { status: 200 }
      );
    }

    // Generate embedding
    const model = vertexAI.preview.getModel('textembedding-gecko@001');
    const request = {
      instances: [
        { content: job.content }
      ]
    };
    const response = await model.predict(request);
    const embedding = response.predictions[0].embeddings;

    // Update job status and save embedding
    await supabase.rpc('update_embedding_status', {
      job_id: job.job_id,
      new_status: 'completed',
      embedding
    });

    return NextResponse.json({
      message: 'Job processed successfully',
      job_id: job.job_id
    });
  } catch (error: any) {
    console.error('Error processing embedding queue:', error);
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    );
  }
}
````

## File: apps/app/src/app/api/ai/process-file/route.ts
````typescript
import { NextResponse } from 'next/server'
import { VertexAI } from '@google-cloud/vertexai'
import { BlobStorage } from '@/lib/storage/blob'
import { prisma } from '@/lib/db/client'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const formData = await req.formData()
    const file = formData.get('file') as File
    
    if (!file) {
      return NextResponse.json(
        { error: 'File is required' },
        { status: 400 }
      )
    }

    // 1. Upload file to Vercel Blob
    const blob = await BlobStorage.uploadFile(file, {
      access: 'public',
      prefix: 'uploads'
    })

    // 2. Initialize Vertex AI
    const vertexAI = new VertexAI({
      project: env.GOOGLE_PROJECT_ID,
      location: 'us-central1',
      googleCredentials: JSON.parse(env.GOOGLE_CREDENTIALS),
    })

    // 3. Process based on file type
    let textContent = ''
    let metadata: Record<string, any> = { 
      name: file.name,
      type: file.type,
      size: file.size,
      url: blob.url
    }

    if (file.type.startsWith('image/')) {
      // For images, use multimodal model
      const model = vertexAI.preview.getGenerativeModel({
        model: 'gemini-pro-vision',
      })

      const result = await model.generateContent({
        contents: [{ 
          role: 'user',
          parts: [
            { text: 'Describe this image in detail and extract any visible text.' },
            { inlineData: { data: await file.arrayBuffer(), mimeType: file.type } }
          ]
        }],
      })

      textContent = result.response.candidates[0].content.parts[0].text
      metadata.description = textContent
    } else if (file.type === 'application/pdf') {
      // TODO: Add PDF text extraction
      textContent = `PDF: ${file.name}`
    } else {
      textContent = `File: ${file.name} (${file.type})`
    }

    // 4. Generate embedding
    const embeddingModel = vertexAI.preview.getGenerativeModel({
      model: 'multimodalembedding@001',
    })

    const embeddingResult = await embeddingModel.embedContent({
      content: { parts: [{ text: textContent }] }
    })

    // 5. Store in database
    const fileRecord = await prisma.file.create({
      data: {
        name: file.name,
        type: file.type,
        url: blob.url,
        embedding: embeddingResult.embedding.values,
        meta: metadata
      }
    })

    return NextResponse.json({
      file: fileRecord,
      analysis: {
        content: textContent,
        embedding: embeddingResult.embedding.values
      }
    })

  } catch (error: any) {
    console.error('Error processing file:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/ai/quick-suggestions/route.ts
````typescript
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/db/client'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { query, chatId } = await req.json()
    
    // Quick analysis with Gemini Flash
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${env.OPENROUTER_API_KEY}`,
        'HTTP-Referer': env.SITE_URL || 'https://enso.chat',
        'X-Title': 'Enso AI'
      },
      body: JSON.stringify({
        model: 'google/gemini-2.0-flash-001',
        messages: [
          {
            role: 'system',
            content: `You are an ambient intelligence system that provides quick, relevant suggestions.
Your goal is to identify potential references and contexts that might be relevant to what the user is typing.
Be concise and focus on the most likely matches. Format your response as a JSON array of suggestions.
Each suggestion should have: type (thread|user|file|url), title, and optionally a preview.`
          },
          {
            role: 'user',
            content: query
          }
        ]
      })
    })

    const result = await response.json()
    let suggestions = []
    
    try {
      suggestions = JSON.parse(result.choices[0].message.content)
    } catch (e) {
      console.error('Failed to parse AI suggestions:', e)
      suggestions = []
    }

    // Get recent context from database
    const recentContexts = await prisma.context.findMany({
      where: {
        chats: {
          some: { id: chatId }
        }
      },
      orderBy: { createdAt: 'desc' },
      take: 5
    })

    // Combine AI suggestions with recent context
    const combinedSuggestions = [
      ...suggestions,
      ...recentContexts.map(ctx => ({
        id: ctx.id,
        type: ctx.type,
        title: ctx.content.slice(0, 100),
        preview: ctx.meta?.description
      }))
    ]

    return NextResponse.json({ suggestions: combinedSuggestions })
  } catch (error: any) {
    console.error('Error in quick-suggestions:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/ai/translate/route.ts
````typescript
import { NextResponse } from 'next/server'
import { VertexAI } from '@google-cloud/vertexai'
import { env } from '@/lib/env'

export const runtime = 'edge'

export async function POST(req: Request) {
  try {
    const { text, targetLang } = await req.json()
    
    if (!text || !targetLang) {
      return NextResponse.json(
        { error: 'Text and target language are required' },
        { status: 400 }
      )
    }

    const vertexAI = new VertexAI({
      project: env.GOOGLE_PROJECT_ID,
      location: 'us-central1',
      googleCredentials: JSON.parse(env.GOOGLE_CREDENTIALS),
    })

    const model = vertexAI.preview.getGenerativeModel({
      model: 'gemini-pro',
    })

    const result = await model.generateContent({
      contents: [{ 
        role: 'user', 
        parts: [{ text: `Translate the following text to ${targetLang}. Only respond with the translation, no additional text:\n\n${text}` }] 
      }],
    })

    return NextResponse.json({
      translation: result.response.candidates[0].content.parts[0].text.trim(),
    })
  } catch (error: any) {
    console.error('Error in translate:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/files/[fileId]/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { BlobStorage } from '@/lib/storage/blob'
import { prisma } from '@/lib/db'
import { getChat } from '@/lib/services/chat'

export async function GET(
  req: Request,
  { params }: { params: { chatId: string; fileId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get file with uploader info
    const file = await prisma.file.findUnique({
      where: {
        id: params.fileId,
        chat_id: params.chatId
      },
      include: {
        uploader: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    if (!file) {
      return new NextResponse('File not found', { status: 404 })
    }

    return NextResponse.json(file)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/files/[fileId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function DELETE(
  req: Request,
  { params }: { params: { chatId: string; fileId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Get file to check permissions
    const file = await prisma.file.findUnique({
      where: {
        id: params.fileId,
        chat_id: params.chatId
      }
    })

    if (!file) {
      return new NextResponse('File not found', { status: 404 })
    }

    // Get chat to check permissions
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Chat not found', { status: 404 })
    }

    // Only file uploader or chat creator can delete
    if (file.uploader_id !== session.user.id && chat.created_by !== session.user.id) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Delete file from storage
    await BlobStorage.deleteFile(file.url)

    // Delete file record
    await prisma.file.delete({
      where: {
        id: params.fileId
      }
    })

    return new NextResponse(null, { status: 204 })
  } catch (error) {
    console.error('Error in DELETE /api/chats/[chatId]/files/[fileId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/files/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { BlobStorage } from '@/lib/storage/blob'
import { prisma } from '@/lib/db'
import { getChat } from '@/lib/services/chat'

export async function GET(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get files with uploader info
    const files = await prisma.file.findMany({
      where: {
        chat_id: params.chatId
      },
      include: {
        uploader: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      },
      orderBy: {
        created_at: 'desc'
      }
    })

    return NextResponse.json(files)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/files:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    const formData = await req.formData()
    const file = formData.get('file') as File
    
    if (!file) {
      return new NextResponse(
        JSON.stringify({ error: 'File is required' }),
        { status: 400 }
      )
    }

    // Upload file to blob storage
    const blob = await BlobStorage.uploadFile(file, {
      access: 'public',
      prefix: `chats/${params.chatId}/files`
    })

    // Create file record
    const fileRecord = await prisma.file.create({
      data: {
        chat_id: params.chatId,
        name: file.name,
        type: file.type,
        size: file.size,
        url: blob.url,
        uploader_id: session.user.id
      },
      include: {
        uploader: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    return NextResponse.json(fileRecord)
  } catch (error) {
    console.error('Error in POST /api/chats/[chatId]/files:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/messages/[messageId]/reactions/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { prisma } from '@/lib/db'
import { getChat } from '@/lib/services/chat'

// Input validation schemas
const addReactionSchema = z.object({
  emoji: z.string(),
})

export async function GET(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get reactions with user info
    const reactions = await prisma.messageReaction.findMany({
      where: {
        message_id: params.messageId
      },
      include: {
        user: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    // Group reactions by emoji
    const groupedReactions = reactions.reduce((acc, reaction) => {
      if (!acc[reaction.emoji]) {
        acc[reaction.emoji] = []
      }
      acc[reaction.emoji].push(reaction.user)
      return acc
    }, {} as Record<string, any[]>)

    return NextResponse.json(groupedReactions)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/messages/[messageId]/reactions:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    const json = await req.json()
    const body = addReactionSchema.parse(json)

    // Check if message exists
    const message = await prisma.message.findUnique({
      where: {
        id: params.messageId,
        chat_id: params.chatId
      }
    })
    if (!message) {
      return new NextResponse('Message not found', { status: 404 })
    }

    // Check if reaction already exists
    const existingReaction = await prisma.messageReaction.findUnique({
      where: {
        message_id_user_id_emoji: {
          message_id: params.messageId,
          user_id: session.user.id,
          emoji: body.emoji
        }
      }
    })
    if (existingReaction) {
      return new NextResponse('Reaction already exists', { status: 400 })
    }

    // Add reaction
    const reaction = await prisma.messageReaction.create({
      data: {
        message_id: params.messageId,
        user_id: session.user.id,
        emoji: body.emoji
      },
      include: {
        user: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    return NextResponse.json(reaction)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in POST /api/chats/[chatId]/messages/[messageId]/reactions:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function DELETE(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const { searchParams } = new URL(req.url)
    const emoji = searchParams.get('emoji')
    if (!emoji) {
      return new NextResponse('Emoji parameter is required', { status: 400 })
    }

    // Delete reaction
    await prisma.messageReaction.delete({
      where: {
        message_id_user_id_emoji: {
          message_id: params.messageId,
          user_id: session.user.id,
          emoji: emoji
        }
      }
    })

    return new NextResponse(null, { status: 204 })
  } catch (error) {
    console.error('Error in DELETE /api/chats/[chatId]/messages/[messageId]/reactions:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/messages/[messageId]/thread/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { prisma } from '@/lib/db'
import { getChat } from '@/lib/services/chat'

// Input validation schemas
const createThreadReplySchema = z.object({
  content: z.string().min(1),
})

export async function GET(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get thread messages with sender info
    const threadMessages = await prisma.message.findMany({
      where: {
        parent_id: params.messageId,
        chat_id: params.chatId
      },
      include: {
        sender: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        },
        reactions: {
          include: {
            user: {
              select: {
                id: true,
                email: true,
                full_name: true,
                avatar_url: true
              }
            }
          }
        }
      },
      orderBy: {
        created_at: 'asc'
      }
    })

    // Get the parent message as well
    const parentMessage = await prisma.message.findUnique({
      where: {
        id: params.messageId,
        chat_id: params.chatId
      },
      include: {
        sender: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        },
        reactions: {
          include: {
            user: {
              select: {
                id: true,
                email: true,
                full_name: true,
                avatar_url: true
              }
            }
          }
        }
      }
    })

    if (!parentMessage) {
      return new NextResponse('Parent message not found', { status: 404 })
    }

    return NextResponse.json({
      parent: parentMessage,
      replies: threadMessages
    })
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/messages/[messageId]/thread:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Check if parent message exists
    const parentMessage = await prisma.message.findUnique({
      where: {
        id: params.messageId,
        chat_id: params.chatId
      }
    })
    if (!parentMessage) {
      return new NextResponse('Parent message not found', { status: 404 })
    }

    const json = await req.json()
    const body = createThreadReplySchema.parse(json)

    // Create thread reply
    const threadReply = await prisma.message.create({
      data: {
        chat_id: params.chatId,
        content: body.content,
        sender_id: session.user.id,
        parent_id: params.messageId
      },
      include: {
        sender: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    return NextResponse.json(threadReply)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in POST /api/chats/[chatId]/messages/[messageId]/thread:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/messages/[messageId]/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { prisma } from '@/lib/db'
import { getChat } from '@/lib/services/chat'

// Input validation schemas
const updateMessageSchema = z.object({
  content: z.string().min(1),
})

export async function GET(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get message with sender info
    const message = await prisma.message.findUnique({
      where: {
        id: params.messageId,
        chat_id: params.chatId
      },
      include: {
        sender: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    if (!message) {
      return new NextResponse('Message not found', { status: 404 })
    }

    return NextResponse.json(message)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/messages/[messageId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function PATCH(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Get message to check permissions
    const message = await prisma.message.findUnique({
      where: {
        id: params.messageId,
        chat_id: params.chatId
      }
    })

    if (!message) {
      return new NextResponse('Message not found', { status: 404 })
    }

    // Only message sender can edit
    if (message.sender_id !== session.user.id) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    const json = await req.json()
    const body = updateMessageSchema.parse(json)

    // Update message
    const updatedMessage = await prisma.message.update({
      where: {
        id: params.messageId
      },
      data: {
        content: body.content,
        updated_at: new Date()
      },
      include: {
        sender: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    return NextResponse.json(updatedMessage)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in PATCH /api/chats/[chatId]/messages/[messageId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function DELETE(
  req: Request,
  { params }: { params: { chatId: string; messageId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Get message to check permissions
    const message = await prisma.message.findUnique({
      where: {
        id: params.messageId,
        chat_id: params.chatId
      }
    })

    if (!message) {
      return new NextResponse('Message not found', { status: 404 })
    }

    // Get chat to check if user is creator
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Chat not found', { status: 404 })
    }

    // Only message sender or chat creator can delete
    if (message.sender_id !== session.user.id && chat.created_by !== session.user.id) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Delete message
    await prisma.message.delete({
      where: {
        id: params.messageId
      }
    })

    return new NextResponse(null, { status: 204 })
  } catch (error) {
    console.error('Error in DELETE /api/chats/[chatId]/messages/[messageId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/messages/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { getMessages, sendMessage } from '@/lib/services/message'
import { getChat } from '@/lib/services/chat'

// Input validation schemas
const sendMessageSchema = z.object({
  content: z.string().min(1),
})

export async function GET(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get messages
    const { searchParams } = new URL(req.url)
    const limit = parseInt(searchParams.get('limit') || '50')
    const messages = await getMessages(params.chatId, limit)

    return NextResponse.json(messages)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/messages:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Send message
    const json = await req.json()
    const body = sendMessageSchema.parse(json)

    const message = await sendMessage(
      params.chatId,
      body.content,
      session.user.id
    )

    return NextResponse.json(message)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in POST /api/chats/[chatId]/messages:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/participants/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { prisma } from '@/lib/db'
import { getChat } from '@/lib/services/chat'

// Input validation schemas
const addParticipantSchema = z.object({
  userId: z.string(),
})

export async function GET(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Get participants with their profiles
    const participants = await prisma.chatParticipant.findMany({
      where: { chat_id: params.chatId },
      include: {
        profile: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    return NextResponse.json(participants)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]/participants:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Check if user is a participant
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    // Only chat creator can add participants
    if (chat.created_by !== session.user.id) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    const json = await req.json()
    const body = addParticipantSchema.parse(json)

    // Check if user exists
    const userExists = await prisma.profile.findUnique({
      where: { id: body.userId }
    })
    if (!userExists) {
      return new NextResponse('User not found', { status: 404 })
    }

    // Check if user is already a participant
    const existingParticipant = await prisma.chatParticipant.findUnique({
      where: {
        chat_id_user_id: {
          chat_id: params.chatId,
          user_id: body.userId
        }
      }
    })
    if (existingParticipant) {
      return new NextResponse('User is already a participant', { status: 400 })
    }

    // Add participant
    const participant = await prisma.chatParticipant.create({
      data: {
        chat_id: params.chatId,
        user_id: body.userId
      },
      include: {
        profile: {
          select: {
            id: true,
            email: true,
            full_name: true,
            avatar_url: true
          }
        }
      }
    })

    return NextResponse.json(participant)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in POST /api/chats/[chatId]/participants:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function DELETE(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const { searchParams } = new URL(req.url)
    const userId = searchParams.get('userId')
    if (!userId) {
      return new NextResponse('User ID is required', { status: 400 })
    }

    // Check if chat exists
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    // Only chat creator or the participant themselves can remove a participant
    if (chat.created_by !== session.user.id && userId !== session.user.id) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Remove participant
    await prisma.chatParticipant.delete({
      where: {
        chat_id_user_id: {
          chat_id: params.chatId,
          user_id: userId
        }
      }
    })

    return new NextResponse(null, { status: 204 })
  } catch (error) {
    console.error('Error in DELETE /api/chats/[chatId]/participants:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/[chatId]/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import {
  getChat,
  updateChatTitle,
  updateChatLabels,
  archiveChat,
  unarchiveChat,
  toggleChatPin,
  deleteChat
} from '@/lib/services/chat'

// Input validation schemas
const updateChatSchema = z.object({
  title: z.string().optional(),
  labels: z.array(z.string()).optional(),
  pinned: z.boolean().optional(),
  is_archived: z.boolean().optional(),
})

export async function GET(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    // Check if user is a participant
    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    return NextResponse.json(chat)
  } catch (error) {
    console.error('Error in GET /api/chats/[chatId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function PATCH(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const json = await req.json()
    const body = updateChatSchema.parse(json)

    // Get chat to check permissions
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    // Check if user is a participant
    const isParticipant = chat.chat_participants.some(
      p => p.user_id === session.user.id
    )
    if (!isParticipant) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    // Apply updates
    if (body.title !== undefined) {
      await updateChatTitle(params.chatId, body.title)
    }
    if (body.labels !== undefined) {
      await updateChatLabels(params.chatId, body.labels)
    }
    if (body.pinned !== undefined) {
      await toggleChatPin(params.chatId)
    }
    if (body.is_archived !== undefined) {
      if (body.is_archived) {
        await archiveChat(params.chatId)
      } else {
        await unarchiveChat(params.chatId)
      }
    }

    // Get updated chat
    const updatedChat = await getChat(params.chatId)
    return NextResponse.json(updatedChat)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in PATCH /api/chats/[chatId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function DELETE(
  req: Request,
  { params }: { params: { chatId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Get chat to check permissions
    const chat = await getChat(params.chatId)
    if (!chat) {
      return new NextResponse('Not Found', { status: 404 })
    }

    // Only chat creator can delete
    if (chat.created_by !== session.user.id) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    await deleteChat(params.chatId)
    return new NextResponse(null, { status: 204 })
  } catch (error) {
    console.error('Error in DELETE /api/chats/[chatId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/chats/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { createChat, getChats } from '@/lib/services/chat'

// Input validation schemas
const createChatSchema = z.object({
  userIds: z.array(z.string()).optional(),
  type: z.enum(['personal', 'direct', 'group']).default('personal'),
})

export async function GET(req: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const { searchParams } = new URL(req.url)
    const archived = searchParams.get('archived') === 'true'
    const type = searchParams.get('type') as any
    const search = searchParams.get('search')
    const labels = searchParams.get('labels')?.split(',')

    const chats = await getChats(session.user.id, {
      archived,
      type,
      search,
      labels,
    })

    return NextResponse.json(chats)
  } catch (error) {
    console.error('Error in GET /api/chats:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(req: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const json = await req.json()
    const body = createChatSchema.parse(json)

    const chat = await createChat(
      body.userIds,
      body.type,
      session.user.id
    )

    return NextResponse.json(chat)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in POST /api/chats:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/invite/route.ts
````typescript
import { Resend } from 'resend'
import { createServerClient } from '@/lib/supabase/server'

if (!process.env.RESEND_API_KEY) {
  throw new Error('Missing RESEND_API_KEY environment variable')
}

const resend = new Resend(process.env.RESEND_API_KEY)

export async function POST(req: Request) {
  try {
    const { email, chatId } = await req.json()
    
    // Get current user using server-side client
    const supabase = await createServerClient()
    const { data: { user } } = await supabase.auth.getUser()
    
    if (!user) {
      return Response.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Get user profile
    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name, email')
      .eq('id', user.id)
      .single()

    if (!profile) {
      return Response.json(
        { error: 'User profile not found' },
        { status: 404 }
      )
    }

    // Generate invite link
    const inviteLink = `${process.env.NEXT_PUBLIC_APP_URL}/invite/${chatId}`

    // Send email with HTML template
    const { data: emailData, error: emailError } = await resend.emails.send({
      from: 'Enso <noreply@enso.chat>',
      to: email,
      subject: `${profile.full_name || profile.email.split('@')[0]} invited you to chat on enso`,
      html: `
        <div>
          <h1>You've been invited to chat!</h1>
          <p>${profile.full_name || profile.email.split('@')[0]} has invited you to chat on Enso.</p>
          <p>Click the link below to join:</p>
          <a href="${inviteLink}">${inviteLink}</a>
        </div>
      `
    })

    if (emailError) {
      console.error('Error sending email:', emailError)
      return Response.json(
        { error: 'Failed to send email' },
        { status: 500 }
      )
    }

    return Response.json({ success: true })
  } catch (error) {
    console.error('Error in invite endpoint:', error)
    return Response.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/presence/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { prisma } from '@/lib/db'

// Cache presence updates to reduce DB load
const PRESENCE_CACHE = new Map<string, { status: string; lastSeen: Date }>()
const CACHE_CLEANUP_INTERVAL = 5 * 60 * 1000 // 5 minutes

// Clean up cache periodically
setInterval(() => {
  const now = new Date()
  for (const [userId, data] of PRESENCE_CACHE.entries()) {
    if (now.getTime() - data.lastSeen.getTime() > CACHE_CLEANUP_INTERVAL) {
      PRESENCE_CACHE.delete(userId)
    }
  }
}, CACHE_CLEANUP_INTERVAL)

export async function GET(req: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const { searchParams } = new URL(req.url)
    const userIds = searchParams.get('userIds')?.split(',')

    if (!userIds?.length) {
      return new NextResponse('User IDs are required', { status: 400 })
    }

    // Get presence status for requested users
    const presenceData = await Promise.all(
      userIds.map(async (userId) => {
        // Check cache first
        const cached = PRESENCE_CACHE.get(userId)
        if (cached) {
          return {
            userId,
            status: cached.status,
            lastSeen: cached.lastSeen
          }
        }

        // Fall back to database
        const presence = await prisma.userPresence.findUnique({
          where: { user_id: userId }
        })

        return {
          userId,
          status: presence?.status || 'offline',
          lastSeen: presence?.last_seen || null
        }
      })
    )

    return NextResponse.json(presenceData)
  } catch (error) {
    console.error('Error in GET /api/presence:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(req: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const json = await req.json()
    const status = json.status || 'online'
    const now = new Date()

    // Update cache
    PRESENCE_CACHE.set(session.user.id, {
      status,
      lastSeen: now
    })

    // Update database
    await prisma.userPresence.upsert({
      where: { user_id: session.user.id },
      create: {
        user_id: session.user.id,
        status,
        last_seen: now
      },
      update: {
        status,
        last_seen: now
      }
    })

    return NextResponse.json({
      userId: session.user.id,
      status,
      lastSeen: now
    })
  } catch (error) {
    console.error('Error in POST /api/presence:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/users/[userId]/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { getProfile, updateProfile } from '@/lib/services/user'

// Input validation schemas
const updateProfileSchema = z.object({
  full_name: z.string().optional(),
  avatar_url: z.string().url().optional(),
})

export async function GET(
  req: Request,
  { params }: { params: { userId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const profile = await getProfile(params.userId)
    if (!profile) {
      return new NextResponse('Not Found', { status: 404 })
    }

    return NextResponse.json(profile)
  } catch (error) {
    console.error('Error in GET /api/users/[userId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function PATCH(
  req: Request,
  { params }: { params: { userId: string } }
) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    // Only allow users to update their own profile
    if (session.user.id !== params.userId) {
      return new NextResponse('Forbidden', { status: 403 })
    }

    const json = await req.json()
    const body = updateProfileSchema.parse(json)

    const profile = await updateProfile(params.userId, body)
    return NextResponse.json(profile)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in PATCH /api/users/[userId]:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/api/users/route.ts
````typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import * as z from 'zod'
import { searchProfiles, createProfile } from '@/lib/services/user'

// Input validation schemas
const createProfileSchema = z.object({
  email: z.string().email(),
  fullName: z.string().optional(),
  avatarUrl: z.string().url().optional(),
})

export async function GET(req: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const { searchParams } = new URL(req.url)
    const query = searchParams.get('q')
    const limit = parseInt(searchParams.get('limit') || '10')

    if (!query) {
      return new NextResponse('Search query is required', { status: 400 })
    }

    const profiles = await searchProfiles(query, limit)
    return NextResponse.json(profiles)
  } catch (error) {
    console.error('Error in GET /api/users:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}

export async function POST(req: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user) {
      return new NextResponse('Unauthorized', { status: 401 })
    }

    const json = await req.json()
    const body = createProfileSchema.parse(json)

    const profile = await createProfile(
      session.user.id,
      body.email,
      body.fullName,
      body.avatarUrl
    )

    return NextResponse.json(profile)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse(JSON.stringify(error.errors), { status: 400 })
    }

    console.error('Error in POST /api/users:', error)
    return new NextResponse(
      JSON.stringify({ error: 'Internal Server Error' }),
      { status: 500 }
    )
  }
}
````

## File: apps/app/src/app/globals.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  /* Core brand colors */
  --blue-primary: #178bf1;  /* Our brand blue */
  --grey-zen: #54514d;      /* Èº†Ëâ≤ (nezumi-iro) - Balanced warm grey */
  --orange-soft: #e8927c;   /* ÊüøËâ≤ (kaki-iro) - Soft persimmon */
  --teal-deep: #227c9d;     /* ÈùíÁ¢ß (seiheki) - Deep teal */
  
  /* Monochromatic scale */
  --white-pure: #ffffff;
  --black-pure: #000000;
  --black-rich: #0a0a0a;
  
  /* Functional colors */
  --header-fill: var(--black-pure);
  --hero-fill: var(--black-pure);
  --demo-fill: var(--blue-primary);
  --foreground-dark: var(--white-pure);
  --foreground-light: var(--black-pure);
  
  /* Opacity variants for light/dark contexts */
  --white-90: rgba(255, 255, 255, 0.9);
  --white-70: rgba(255, 255, 255, 0.7);
  --white-60: rgba(255, 255, 255, 0.6);
  --white-40: rgba(255, 255, 255, 0.4);
  --white-20: rgba(255, 255, 255, 0.2);
  --white-10: rgba(255, 255, 255, 0.1);
  --white-05: rgba(255, 255, 255, 0.05);
  
  --black-90: rgba(0, 0, 0, 0.9);
  --black-70: rgba(0, 0, 0, 0.7);
  --black-60: rgba(0, 0, 0, 0.6);
  --black-40: rgba(0, 0, 0, 0.4);
  --black-20: rgba(0, 0, 0, 0.2);
  --black-10: rgba(0, 0, 0, 0.1);
  --black-05: rgba(0, 0, 0, 0.05);
  
  /* Opacity variants */
  --opacity-90: 0.9;
  --opacity-60: 0.6;
  --opacity-40: 0.4;
  --opacity-20: 0.2;
  --opacity-10: 0.1;
  --opacity-05: 0.05;

  /* Border radii */
  --border-radius-none: 0;
  --border-radius-sm: 0.125rem;
  --border-radius-default: 0.25rem;
  --border-radius-md: 0.375rem;
  --border-radius-lg: 0.5rem;
  --border-radius-xl: 0.75rem;
  --border-radius-2xl: 1rem;
  --border-radius-3xl: 1.5rem;
  --border-radius-full: 9999px;

  /* Glow effect */
  --glow-size: 25rem;
  --glow-color: var(--blue-primary);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: var(--black-pure);
    --foreground: var(--white-pure);
  }
}

/* Base typography */
@layer base {
  html {
    font-size: 18px;
    height: 100%;
    overscroll-behavior: none;
    background: var(--black-pure);
  }

  body {
    @apply text-lg;
    height: 100%;
    overflow-x: hidden;
    background: var(--black-pure);
    font-family: var(--font-geist-sans), system-ui, -apple-system, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  /* Increase default text sizes */
  p {
    @apply text-lg leading-relaxed;
  }

  h1 {
    @apply text-4xl md:text-5xl lg:text-6xl;
  }

  h2 {
    @apply text-3xl md:text-4xl lg:text-5xl;
  }

  h3 {
    @apply text-2xl md:text-3xl lg:text-4xl;
  }
}

/* Grain animation */
@keyframes grain {
  0%, 100% { transform: translate(0, 0) }
  10% { transform: translate(-2%, -2%) }
  20% { transform: translate(2%, 2%) }
  30% { transform: translate(-1%, 1%) }
  40% { transform: translate(1%, -1%) }
  50% { transform: translate(-2%, 2%) }
  60% { transform: translate(2%, -2%) }
  70% { transform: translate(-1%, -1%) }
  80% { transform: translate(1%, 1%) }
  90% { transform: translate(-2%, -2%) }
}

/* Floating animation with subtle rotation */
@keyframes float {
  0%, 100% { 
    transform: translateY(0) rotate(0deg); 
  }
  50% { 
    transform: translateY(-10px) rotate(0.5deg); 
  }
}

/* Slow pulse animation with scale and opacity */
@keyframes pulse-slow {
  0%, 100% { 
    opacity: 0.4; 
    transform: scale(1.1); 
  }
  50% { 
    opacity: 0.2; 
    transform: scale(1.15); 
  }
}

/* Slow spinning animation */
@keyframes spin-slow {
  from { 
    transform: rotate(0deg); 
  }
  to { 
    transform: rotate(360deg); 
  }
}

/* Reverse spin animation */
@keyframes spin-reverse {
  from { 
    transform: rotate(360deg); 
  }
  to { 
    transform: rotate(0deg); 
  }
}

/* Ripple effect animation */
@keyframes ripple {
  0% {
    transform: scale(1) rotate(0deg);
    filter: blur(0px);
  }
  50% {
    transform: scale(1.05) rotate(0.5deg);
    filter: blur(1px);
  }
  100% {
    transform: scale(1) rotate(0deg);
    filter: blur(0px);
  }
}

/* Water ripple effect animation */
@keyframes water-ripple {
  0% {
    background-position: 0% 50%;
    filter: brightness(1) contrast(1);
  }
  50% {
    background-position: 100% 50%;
    filter: brightness(1.2) contrast(1.1);
  }
  100% {
    background-position: 0% 50%;
    filter: brightness(1) contrast(1);
  }
}

/* Glow animation */
@keyframes glow {
  0%, 100% {
    opacity: 0.5;
    transform: translateX(0);
  }
  50% {
    opacity: 0.8;
    transform: translateX(10px);
  }
}

/* Text fade in animation */
@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Glow effect */
@layer components {
  .glow-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    user-select: none;
    opacity: var(--glow-opacity, 0);
    mask: radial-gradient(
      var(--glow-size) var(--glow-size) at var(--glow-x, 50%) var(--glow-y, 50%),
      var(--glow-color) 0%,
      transparent 70%
    );
    background: var(--glow-color);
    transition: opacity 200ms ease;
    will-change: mask, opacity;
    mix-blend-mode: soft-light;
  }

  .glow-capture {
    position: relative;
    isolation: isolate;
    cursor: pointer;
  }

  .glow {
    @apply transition-all duration-200;
  }
}

/* Utility classes */
@layer utilities {
  .animate-grain {
    animation: grain 8s steps(10) infinite;
  }
  
  .animate-float {
    animation: float 6s ease-in-out infinite;
  }
  
  .animate-pulse-slow {
    animation: pulse-slow 4s ease-in-out infinite;
  }
  
  .animate-spin-slow {
    animation: spin-slow 20s linear infinite;
  }
  
  .animate-spin-reverse {
    animation: spin-reverse 25s linear infinite;
  }
  
  .animate-ripple {
    animation: ripple 8s ease-in-out infinite;
  }
  
  .animate-water-ripple {
    background: repeating-linear-gradient(
      45deg,
      rgba(23,139,241,0.1) 0%,
      transparent 10%,
      rgba(23,139,241,0.1) 20%
    );
    background-size: 200% 200%;
    animation: water-ripple 8s ease-in-out infinite;
  }
  
  .animate-glow {
    animation: glow 4s ease-in-out infinite;
  }
  
  .animate-fade-in {
    animation: fade-in-up 0.8s ease-out forwards;
  }
  
  .backdrop-blur-sm {
    backdrop-filter: blur(4px);
  }
  
  .perspective {
    perspective: 1000px;
  }
  
  .transform-gpu {
    transform: translate3d(0,0,0);
    backface-visibility: hidden;
    transform-style: preserve-3d;
  }

  .glow-hover {
    @apply hover:border-[var(--glow-color)]/20 hover:ring-1 hover:ring-[var(--glow-color)]/20;
  }

  .grid-cols-30 {
    grid-template-columns: repeat(30, minmax(0, 1fr));
  }
}

/* Add these animations to your existing globals.css */
@keyframes star-movement-bottom {
  from {
    transform: translateX(0%);
  }
  to {
    transform: translateX(-50%);
  }
}

@keyframes star-movement-top {
  from {
    transform: translateX(0%);
  }
  to {
    transform: translateX(50%);
  }
}
````

## File: apps/app/src/app/layout.tsx
````typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import { Providers } from "@/lib/providers";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "enso",
  description: "AI-native messaging",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
````

## File: apps/app/src/components/ai/ErrorBoundary.tsx
````typescript
import { Component, ErrorInfo, ReactNode } from 'react'

interface ErrorBoundaryProps {
  fallback: ReactNode
  children: ReactNode
}

export class ErrorBoundary extends Component<ErrorBoundaryProps> {
  state = { hasError: false }

  static getDerivedStateFromError() {
    return { hasError: true }
  }

  componentDidCatch(error: Error, info: ErrorInfo) {
    console.error('AI Error:', error, info)
  }

  render() {
    return this.state.hasError ? this.props.fallback : this.props.children
  }
}
````

## File: apps/app/src/components/chat/container/ChatContainer.tsx
````typescript
"use client"

import { useEffect, useRef, useState } from "react"
import { useParams, useRouter } from "next/navigation"
import { useGetChatByIdQuery } from "@/lib/redux/slices/apiSlice"
import { MessageList } from "../messages/MessageList"
import { MessageInput } from "../messages/MessageInput"
import { ReferencePanel } from "../references/ReferencePanel"
import { ContextPanel } from "../context/ContextPanel"
import { ChatHeader } from "../ChatHeader"
import { useChatContext } from "@/hooks/useChatContext"
import { cn } from "@/lib/utils"

export function ChatContainer() {
  const params = useParams()
  const router = useRouter()
  const chatId = params?.id as string
  const containerRef = useRef<HTMLDivElement>(null)
  const [isContextPanelOpen, setIsContextPanelOpen] = useState(true)

  const {
    data: chat,
    isLoading: isChatLoading,
    error: chatError,
  } = useGetChatByIdQuery(chatId, {
    skip: !chatId,
  })

  const {
    summary,
    topics,
    files,
    participants,
    isLoading: isContextLoading,
    error: contextError
  } = useChatContext(chatId)

  useEffect(() => {
    if (chatError || contextError) {
      router.push("/chat")
    }
  }, [chatError, contextError, router])

  if (isChatLoading || isContextLoading) {
    return (
      <div className="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div className="relative">
          <div className="w-12 h-12 rounded-full bg-gradient-to-r from-[var(--blue-primary)] to-[var(--purple-primary)] animate-spin" />
          <div className="absolute inset-0 animate-pulse flex items-center justify-center">
            <div className="w-8 h-8 rounded-full bg-black/80" />
          </div>
        </div>
      </div>
    )
  }

  if (!chat) {
    return null
  }

  return (
    <div className="flex h-full flex-col overflow-hidden bg-background">
      <div className="flex flex-1 overflow-hidden">
        <div className="flex-1 overflow-hidden">
          <div
            ref={containerRef}
            className={cn(
              "flex h-full flex-col overflow-hidden",
              "bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60"
            )}
          >
            <ChatHeader
              chatId={chatId}
              type={chat.type}
              title={chat.title}
              participants={chat.chat_participants}
            />

            <ContextPanel
              chatId={chatId}
              summary={summary}
              topics={topics}
              files={files}
              isOpen={isContextPanelOpen}
              onOpenChange={setIsContextPanelOpen}
              className="border-t bg-background px-4 py-2"
            />

            <div className="flex-1 flex flex-col min-h-0">
              <MessageList
                messages={chat.messages}
                className="flex-1 overflow-y-auto p-4"
              />
              <MessageInput
                chatId={chatId}
                className="border-t bg-background px-4 py-2"
              />
            </div>
          </div>
        </div>
        <div className="w-80 border-l border-white/5 flex flex-col">
          <ReferencePanel
            references={chat.messages[chat.messages.length - 1]?.references}
            className="h-80 border-t bg-muted/50 p-4"
          />
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/context/ContextBar.tsx
````typescript
"use client"

import React from "react"
import { motion, AnimatePresence } from "framer-motion"
import { ChevronDown, ChevronUp } from "lucide-react"
import { cn } from "@/lib/utils"
import { ContextPreview } from "./ContextPreview"
import type { Context, ContextType } from "@/types/ai/context"

interface ContextBarProps {
  contexts: Context[]
  onContextRemove?: (id: string) => void
  onContextClick?: (context: Context) => void
  variant?: 'global' | 'input' | 'inline'
  className?: string
}

export function ContextBar({ 
  contexts, 
  onContextRemove,
  onContextClick,
  variant = 'global',
  className 
}: ContextBarProps) {
  return (
    <div className={cn(
      "flex items-center gap-2 p-2 bg-black/20 backdrop-blur-sm",
      {
        'px-4 py-2': variant === 'global',
        'px-3 py-1.5': variant === 'input',
        'px-2 py-1': variant === 'inline'
      },
      className
    )}>
      <div className="flex items-center gap-2 flex-wrap">
        {contexts.map((context) => (
          <ContextPreview
            key={context.id}
            type={context.type}
            title={context.title}
            subtitle={context.subtitle}
            metadata={context.metadata}
            variant={variant}
            onRemove={onContextRemove ? () => onContextRemove(context.id) : undefined}
            onClick={onContextClick ? () => onContextClick(context) : undefined}
          />
        ))}
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/context/ContextPanel.tsx
````typescript
"use client"

import React, { useState, useEffect } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { cn } from "@/lib/utils"
import { ScrollArea } from "@/components/ui/scroll-area"
import { 
  MessageSquare, 
  FileText, 
  Users, 
  Activity,
  ChevronLeft,
  ChevronDown,
  ChevronUp
} from "lucide-react"
import { ContextPreview } from "./ContextPreview"
import { 
  Tooltip, 
  TooltipContent, 
  TooltipTrigger,
  TooltipProvider 
} from "@/components/ui/tooltip"
import { Button } from "@/components/ui/button"
import { getSupabaseClient } from "@/lib/supabase/client"
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from "@/components/ui/collapsible"
import { Slider } from "@/components/ui/slider"

interface ChatSummary {
  title: string
  description: string
  keyPhrases: string[]
}

interface Topic {
  id: string
  title: string
  count: number
  relevance: number
}

interface RelatedFile {
  id: string
  name: string
  type: string
  lastModified: string
  relevance: number
}

interface ActivityData {
  date: string
  topics: number
  messages: number
  files: number
  participants: number
}

type FilterType = 'activity' | 'topics' | 'files'

interface ContextPanelProps {
  chatId: string
  summary: any
  topics: any[]
  files: any[]
  className?: string
  isOpen: boolean
  onOpenChange: (open: boolean) => void
  onTopicClick?: (topic: any) => void
  onFileClick?: (file: any) => void
}

interface MessageData {
  id: string
  created_at: string
  content: string
}

interface FileData {
  id: string
  created_at: string
  name: string
  type: string
}

interface ActivityItem {
  id: string
  type: 'message' | 'file' | 'thread' | 'topic'
  title: string
  preview?: string
  metadata: {
    created_at: string
    [key: string]: any
  }
}

const filterOptions: { id: FilterType; label: string }[] = [
  { id: 'activity', label: 'activity' },
  { id: 'topics', label: 'topics' },
  { id: 'files', label: 'files' }
]

export function ContextPanel({
  chatId,
  summary,
  topics,
  files,
  className,
  isOpen,
  onOpenChange,
  onTopicClick,
  onFileClick
}: ContextPanelProps) {
  const [activeFilter, setActiveFilter] = useState<FilterType>('activity')
  const [selectedDate, setSelectedDate] = useState<string | null>(null)
  const [activityData, setActivityData] = useState<ActivityData[]>([])
  const [selectedDateItems, setSelectedDateItems] = useState<ActivityItem[]>([])
  const [timelinePosition, setTimelinePosition] = useState(100) // 100 = present, 0 = 30 days ago

  // Fetch real activity data
  useEffect(() => {
    const fetchActivity = async () => {
      const supabase = getSupabaseClient()
      const thirtyDaysAgo = new Date()
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

      // Get message counts
      const { data: messageCounts } = await supabase
        .from('messages')
        .select('created_at')
        .eq('chat_id', chatId)
        .gte('created_at', thirtyDaysAgo.toISOString()) as { data: MessageData[] | null }

      // Get file counts
      const { data: fileCounts } = await supabase
        .from('message_files')
        .select('created_at')
        .eq('chat_id', chatId)
        .gte('created_at', thirtyDaysAgo.toISOString()) as { data: FileData[] | null }

      // Initialize activity data array
      const activity: ActivityData[] = Array.from({ length: 30 }, (_, i) => {
        const date = new Date()
        date.setDate(date.getDate() - i)
        date.setHours(0, 0, 0, 0)
        return {
          date: date.toISOString(),
          topics: 0,
          messages: 0,
          files: 0,
          participants: 0
        }
      })

      // Populate message counts
      messageCounts?.forEach((msg: MessageData) => {
        const date = new Date(msg.created_at)
        date.setHours(0, 0, 0, 0)
        const index = activity.findIndex(a => new Date(a.date).getTime() === date.getTime())
        if (index !== -1) {
          activity[index].messages++
        }
      })

      // Populate file counts
      fileCounts?.forEach((file: FileData) => {
        const date = new Date(file.created_at)
        date.setHours(0, 0, 0, 0)
        const index = activity.findIndex(a => new Date(a.date).getTime() === date.getTime())
        if (index !== -1) {
          activity[index].files++
        }
      })

      setActivityData(activity)
    }

    if (chatId) {
      fetchActivity()
    }
  }, [chatId])

  // Fetch items for selected date
  useEffect(() => {
    const fetchDateItems = async () => {
      if (!selectedDate) return

      const supabase = getSupabaseClient()
      const startDate = new Date(selectedDate)
      const endDate = new Date(selectedDate)
      endDate.setDate(endDate.getDate() + 1)

      // Get messages for the date
      const { data: messages } = await supabase
        .from('messages')
        .select('id, content, created_at')
        .eq('chat_id', chatId)
        .gte('created_at', startDate.toISOString())
        .lt('created_at', endDate.toISOString()) as { data: MessageData[] | null }

      // Get files for the date
      const { data: dateFiles } = await supabase
        .from('message_files')
        .select('id, name, type, created_at')
        .eq('chat_id', chatId)
        .gte('created_at', startDate.toISOString())
        .lt('created_at', endDate.toISOString()) as { data: FileData[] | null }

      // Combine and format items
      const items: ActivityItem[] = [
        ...(messages || []).map((msg: MessageData) => ({
          id: msg.id,
          type: 'message' as const,
          title: msg.content.slice(0, 100),
          preview: msg.content.length > 100 ? msg.content.slice(100) : undefined,
          metadata: { created_at: msg.created_at }
        })),
        ...(dateFiles || []).map((file: FileData) => ({
          id: file.id,
          type: 'file' as const,
          title: file.name,
          preview: file.type,
          metadata: { created_at: file.created_at }
        }))
      ]

      setSelectedDateItems(items)
    }

    fetchDateItems()
  }, [selectedDate, chatId])

  const getActivityColor = (value: number, max: number) => {
    if (max === 0) return 'bg-white/[0.02]'
    const intensity = value / max
    if (intensity === 0) return 'bg-white/[0.02]'
    if (intensity < 0.25) return 'bg-[#178bf1]/20'
    if (intensity < 0.5) return 'bg-[#178bf1]/30'
    if (intensity < 0.75) return 'bg-[#178bf1]/40'
    return 'bg-[#178bf1]/50'
  }

  // Calculate activity data based on timeline position
  const visibleActivityData = React.useMemo(() => {
    const daysToShow = Math.floor((100 - timelinePosition) / (100 / 30))
    return activityData.slice(0, daysToShow + 1)
  }, [activityData, timelinePosition])

  const formatDate = (date: string) => {
    return new Date(date).toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric' 
    })
  }

  const getActivitySummary = (data: ActivityData) => {
    const type = activeFilter === 'activity' ? 'messages' : activeFilter
    const count = type === 'messages' ? data.messages :
                 type === 'topics' ? data.topics :
                 type === 'files' ? data.files : 0
    return `${count} ${type}`
  }

  return (
    <div className={cn("relative", className)}>
      <div className={cn(
        "absolute inset-0 bg-gradient-to-b from-black/20 to-transparent",
        "transition-opacity duration-300",
        isOpen ? "opacity-100" : "opacity-0"
      )} />
      
      {/* Content */}
      <div className={cn(
        "relative space-y-6 p-6",
        "transition-all duration-300",
        isOpen ? "opacity-100 translate-y-0" : "opacity-0 -translate-y-4"
      )}>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.3, delay: 0.1 }}
          className="relative bg-black/40 backdrop-blur-sm rounded-lg p-6 border border-white/5"
          style={{ minHeight: '280px' }}
        >
          <AnimatePresence mode="wait">
            {selectedDate ? (
              // Selected Date View
              <motion.div
                key="selected-view"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.2 }}
                className="h-full flex flex-col space-y-4"
              >
                <div className="flex items-center justify-between flex-shrink-0">
                  <button
                    onClick={() => setSelectedDate(null)}
                    className="flex items-center gap-2 text-white/40 hover:text-white/60 transition-colors"
                  >
                    <ChevronLeft className="h-4 w-4" />
                    <span className="text-sm font-light">back</span>
                  </button>
                  <span className="text-sm font-light text-white/40">
                    {formatDate(selectedDate)}
                  </span>
                </div>
                <ScrollArea className="w-full flex-1 min-h-0" orientation="horizontal">
                  <div className="flex gap-4 pb-4" style={{ width: 'max-content' }}>
                    {selectedDateItems.map((item, i) => (
                      <motion.div
                        key={item.id}
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        transition={{ duration: 0.2, delay: i * 0.05 }}
                      >
                        <ContextPreview
                          type={item.type === 'message' ? 'thread' : (item.type as 'file' | 'topic')}
                          title={item.title}
                          metadata={{ 
                            description: item.preview,
                            created_at: item.metadata.created_at 
                          }}
                        />
                      </motion.div>
                    ))}
                  </div>
                </ScrollArea>
              </motion.div>
            ) : (
              // Grid View
              <motion.div
                key="grid-view"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.2 }}
                className="h-full flex flex-col space-y-4"
              >
                {/* Filter options */}
                <div className="flex items-center gap-3 flex-shrink-0">
                  {filterOptions.map((filter, i) => (
                    <motion.button
                      key={filter.id}
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      transition={{ duration: 0.2, delay: i * 0.05 }}
                      onClick={() => setActiveFilter(filter.id)}
                      className={cn(
                        "text-sm font-light transition-colors",
                        activeFilter === filter.id 
                          ? "text-white/90" 
                          : "text-white/40 hover:text-white/60"
                      )}
                    >
                      {filter.label}
                    </motion.button>
                  ))}
                </div>

                {/* Heat Map Grid */}
                <TooltipProvider>
                  <div className="grid grid-cols-30 grid-rows-3 gap-1 flex-1">
                    {visibleActivityData.map((day, i) => (
                      <Tooltip key={day.date}>
                        <TooltipTrigger asChild>
                          <motion.button
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            transition={{ 
                              duration: 0.2,
                              delay: Math.min(0.3 + (i * 0.01), 0.8)
                            }}
                            className={cn(
                              "w-full aspect-square rounded-sm transition-all duration-200",
                              getActivityColor(
                                day[activeFilter === 'activity' ? 'messages' : activeFilter],
                                Math.max(...visibleActivityData.map(d => d[activeFilter === 'activity' ? 'messages' : activeFilter]))
                              ),
                              "hover:opacity-80",
                              selectedDate === day.date && "ring-2 ring-[#178bf1]/40"
                            )}
                            onClick={() => setSelectedDate(selectedDate === day.date ? null : day.date)}
                          />
                        </TooltipTrigger>
                        <TooltipContent>
                          <div className="text-xs space-y-1">
                            <p className="font-light">{formatDate(day.date)}</p>
                            <p className="text-white/60">{getActivitySummary(day)}</p>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    ))}
                  </div>
                </TooltipProvider>

                {/* Timeline Scrubber */}
                <div className="pt-4 px-2">
                  <Slider
                    value={[timelinePosition]}
                    onValueChange={([value]) => setTimelinePosition(value)}
                    min={0}
                    max={100}
                    step={1}
                    className="w-full"
                  />
                  <div className="flex justify-between mt-2 text-xs text-white/40 font-light">
                    <span>30 days ago</span>
                    <span>now</span>
                  </div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>

        {/* Horizontal Scrollable Context */}
        <AnimatePresence>
          {!selectedDate && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.3, delay: 0.2 }}
            >
              <ScrollArea className="w-full" orientation="horizontal">
                <div className="flex gap-4 pb-4" style={{ width: 'max-content' }}>
                  {activeFilter === 'topics' && topics.map((topic) => (
                    <ContextPreview
                      key={topic.id}
                      type="topic"
                      title={topic.title}
                      metadata={{
                        description: `${topic.count} messages`,
                        relevance: topic.relevance
                      }}
                      onClick={() => onTopicClick?.(topic)}
                    />
                  ))}
                  {activeFilter === 'files' && files.map((file) => (
                    <ContextPreview
                      key={file.id}
                      type="file"
                      title={file.name}
                      metadata={{
                        description: file.type,
                        lastModified: file.lastModified,
                        relevance: file.relevance
                      }}
                      onClick={() => onFileClick?.(file)}
                    />
                  ))}
                </div>
              </ScrollArea>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/context/ContextPreview.tsx
````typescript
"use client"

import React from "react"
import { User, Hash, Link2, FileText, MessageSquare, X } from "lucide-react"
import { cn } from "@/lib/utils"
import { motion } from "framer-motion"
import type { ContextType } from "@/types/ai/context"

interface ContextPreviewProps {
  type: ContextType
  title: string
  subtitle?: string
  metadata?: Record<string, any>
  isFloating?: boolean
  onClick?: () => void
  onRemove?: () => void
  className?: string
  variant?: 'global' | 'input' | 'inline'
}

export function ContextPreview({
  type,
  title,
  subtitle,
  metadata,
  isFloating = false,
  onClick,
  onRemove,
  className,
  variant = 'global'
}: ContextPreviewProps) {
  const icons = {
    user: User,
    thread: MessageSquare,
    topic: Hash,
    file: FileText,
    link: Link2
  } as const

  const Icon = icons[type as keyof typeof icons] || Hash

  return (
    <motion.div
      initial={isFloating ? { opacity: 0, y: 20 } : false}
      animate={isFloating ? { opacity: 1, y: 0 } : false}
      className={cn(
        "group relative p-4 rounded-lg transition-colors min-h-[100px]",
        "border border-white/5 bg-white/[0.02] backdrop-blur-sm",
        onClick && "cursor-pointer hover:bg-white/[0.04]",
        isFloating && "shadow-lg hover:shadow-xl",
        metadata?.relevance && metadata.relevance > 0.8 && "ring-2 ring-blue-500/20",
        metadata?.confidence && metadata.confidence > 0.8 && "ring-2 ring-green-500/20",
        className,
        {
          'px-3 py-1.5 text-sm': variant === 'global',
          'px-2 py-1 text-xs': variant === 'input',
          'px-1.5 py-0.5 text-xs': variant === 'inline'
        }
      )}
      onClick={onClick}
    >
      {onRemove && (
        <button
          onClick={(e) => {
            e.stopPropagation()
            onRemove()
          }}
          className={cn(
            "absolute top-2 right-2 p-1 rounded-md",
            "opacity-0 group-hover:opacity-100 transition-opacity",
            "text-white/40 hover:text-white/60 hover:bg-white/5"
          )}
        >
          <X className="w-3 h-3" />
        </button>
      )}
      <div className="flex items-start gap-3">
        <div className={cn(
          "p-2 rounded-md bg-white/5",
          type === 'user' && "text-blue-400/80",
          type === 'thread' && "text-purple-400/80",
          type === 'topic' && "text-green-400/80",
          type === 'file' && "text-orange-400/80",
          type === 'link' && "text-yellow-400/80",
          metadata?.relevance && metadata.relevance > 0.8 && "ring-1 ring-current"
        )}>
          <Icon className="w-4 h-4" />
        </div>
        <div className="flex-1 min-w-0 space-y-1">
          <div className="flex items-start justify-between gap-2">
            <div className="space-y-1">
              <h4 className="text-sm font-light text-white/90 truncate">
                {title}
              </h4>
              {metadata?.author && (
                <p className="text-xs font-extralight text-white/40">
                  {metadata.author}
                </p>
              )}
            </div>
            {metadata?.date && (
              <span className="text-xs font-extralight text-white/40 whitespace-nowrap">
                {metadata.date}
              </span>
            )}
          </div>
          {metadata?.description && (
            <p className="text-sm font-extralight text-white/60 line-clamp-2">
              {metadata.description}
            </p>
          )}
          {metadata?.size && (
            <p className="text-xs font-extralight text-white/40">
              {metadata.size}
            </p>
          )}
          {metadata?.relevance && (
            <div className="flex items-center gap-1 mt-2">
              <div 
                className="h-1 flex-1 rounded-full bg-white/5 overflow-hidden"
                title={`${Math.round(metadata.relevance * 100)}% relevant`}
              >
                <div 
                  className="h-full bg-current transition-all duration-500"
                  style={{ width: `${metadata.relevance * 100}%` }}
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </motion.div>
  )
}
````

## File: apps/app/src/components/chat/context/ContextSuggestions.tsx
````typescript
"use client"

import React from "react"
import { cn } from "@/lib/utils"
import { AnimatePresence, motion } from "framer-motion"
import { User, Hash, Link2, FileText } from "lucide-react"
import type { Context } from "@/types/ai/context"

interface ContextSuggestionsProps {
  suggestions: Context[]
  isLoading?: boolean
  onSelect?: (suggestion: Context) => void
  className?: string
}

export function ContextSuggestions({
  suggestions,
  isLoading,
  onSelect,
  className
}: ContextSuggestionsProps) {
  if (!suggestions.length && !isLoading) return null

  const icons = {
    user: User,
    thread: Link2,
    topic: Hash,
    file: FileText
  }

  return (
    <div 
      className={cn(
        "rounded-lg border border-white/5 bg-black/90 backdrop-blur-sm",
        "p-1.5 space-y-1 max-h-[300px] overflow-y-auto scrollbar-none",
        className
      )}
    >
      <AnimatePresence mode="popLayout">
        {isLoading ? (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="p-2 text-sm text-white/40 font-light"
          >
            thinking...
          </motion.div>
        ) : (
          suggestions.map((suggestion) => {
            const Icon = icons[suggestion.type]
            return (
              <motion.div
                key={suggestion.id}
                layout
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: 10 }}
                onClick={() => onSelect?.(suggestion)}
                className={cn(
                  "flex items-start gap-3 p-2 rounded-md",
                  "hover:bg-white/5 transition-colors cursor-pointer"
                )}
              >
                {/* Icon */}
                <div className={cn(
                  "p-2 rounded-md bg-white/5",
                  suggestion.type === 'user' && "text-blue-400/80",
                  suggestion.type === 'thread' && "text-purple-400/80",
                  suggestion.type === 'topic' && "text-green-400/80",
                  suggestion.type === 'file' && "text-orange-400/80"
                )}>
                  <Icon className="w-4 h-4" />
                </div>

                {/* Content */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between gap-2">
                    <h4 className="text-sm font-light text-white/90 truncate">
                      {suggestion.title}
                    </h4>
                    {suggestion.subtitle && (
                      <span className="text-xs font-extralight text-white/40 truncate">
                        {suggestion.subtitle}
                      </span>
                    )}
                  </div>
                  {suggestion.subtitle && (
                    <p className="text-sm font-extralight text-white/60 line-clamp-2 mt-1">
                      {suggestion.subtitle}
                    </p>
                  )}
                </div>
              </motion.div>
            )
          })
        )}
      </AnimatePresence>
    </div>
  )
}
````

## File: apps/app/src/components/chat/context/ContextTile.tsx
````typescript
"use client"

import React from "react"
import { User, Hash, Link2, FileText, X } from "lucide-react"
import { cn } from "@/lib/utils"
import { motion } from "framer-motion"
import type { ContextType } from "@/types/ai/context"

interface ContextTileProps {
  type: ContextType
  title: string
  subtitle?: string
  active?: boolean
  onRemove?: () => void
  onClick?: () => void
  className?: string
}

export function ContextTile({ 
  type, 
  title, 
  subtitle,
  active = false,
  onRemove,
  onClick,
  className 
}: ContextTileProps) {
  const icons = {
    user: User,
    thread: Link2,
    topic: Hash,
    file: FileText
  }

  const Icon = icons[type]

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      exit={{ opacity: 0, scale: 0.95 }}
      className={cn(
        "group relative flex items-center gap-2 px-3 py-1.5 rounded-lg transition-colors cursor-default",
        "border border-white/5 backdrop-blur-sm",
        active 
          ? "bg-white/10 text-white/90" 
          : "bg-white/5 text-white/60 hover:text-white/80",
        onClick && "cursor-pointer",
        className
      )}
      onClick={onClick}
    >
      <Icon className="w-3.5 h-3.5" />
      <div className="flex flex-col min-w-0">
        <span className="truncate text-sm font-light">
          {title}
        </span>
        {subtitle && (
          <span className="truncate text-xs font-extralight text-white/40">
            {subtitle}
          </span>
        )}
      </div>
      {onRemove && (
        <button
          onClick={(e) => {
            e.stopPropagation()
            onRemove()
          }}
          className={cn(
            "p-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity",
            "hover:bg-white/5 text-white/40 hover:text-white/60"
          )}
        >
          <X className="w-3 h-3" />
        </button>
      )}
    </motion.div>
  )
}
````

## File: apps/app/src/components/chat/messages/BaseMenu.tsx
````typescript
"use client"

import React, { useState } from "react"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"
import { Button } from "@/components/ui/button"
import { cn } from "@/lib/utils"
import { Search } from "lucide-react"

export interface BaseMenuItem {
  id: string
  type?: 'divider'
  label?: string
  icon?: React.ComponentType<{ className?: string }>
  onClick?: () => void
  danger?: boolean
  comingSoon?: boolean
}

export interface BaseMenuProps {
  className?: string
  align?: 'start' | 'center' | 'end'
  sideOffset?: number
  width?: string
  icon: React.ReactNode
  label: string
  shortcut?: string
  items: BaseMenuItem[]
  showSearch?: boolean
  searchPlaceholder?: string
  searchQuery?: string
  onSearchChange?: (e: React.ChangeEvent<HTMLInputElement>) => void
  loading?: boolean
  disabled?: boolean
  children?: React.ReactNode
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export function BaseMenu({
  className,
  align = 'start',
  sideOffset = 4,
  width = 'w-56',
  icon,
  label,
  shortcut,
  items,
  showSearch,
  searchPlaceholder = 'Search...',
  searchQuery = "",
  onSearchChange,
  loading,
  disabled,
  children,
  open,
  onOpenChange
}: BaseMenuProps) {
  const [internalOpen, setInternalOpen] = useState(false)
  
  const isControlled = open !== undefined
  const isOpen = isControlled ? open : internalOpen
  const handleOpenChange = (newOpen: boolean) => {
    if (!isControlled) {
      setInternalOpen(newOpen)
    }
    onOpenChange?.(newOpen)
  }

  const tooltipContent = shortcut ? (
    <div className="flex items-center gap-2">
      <span className="text-sm font-light">{label.toLowerCase()}</span>
      <kbd className="text-[10px] font-mono text-white/40 bg-white/5 px-1.5 py-0.5 rounded">
        {shortcut}
      </kbd>
    </div>
  ) : (
    <span className="text-sm font-light">{label.toLowerCase()}</span>
  )

  const menuButton = children || (
    <Button
      size="icon"
      variant="ghost"
      className={cn(
        "h-8 w-8 text-white/40 hover:text-white/60",
        className
      )}
      disabled={disabled}
    >
      {icon}
      <span className="sr-only">{label}</span>
    </Button>
  )

  return (
    <TooltipProvider>
      <Tooltip delayDuration={300}>
        <Popover open={isOpen} onOpenChange={handleOpenChange}>
          <TooltipTrigger asChild>
            <PopoverTrigger asChild>
              {menuButton}
            </PopoverTrigger>
          </TooltipTrigger>
          <PopoverContent
            align={align}
            className={cn(width, "p-1.5")}
            sideOffset={sideOffset}
          >
            <div className="space-y-0.5">
              {showSearch && (
                <div className="sticky top-0 mb-1">
                  <div className="relative">
                    <Search className="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-white/40" />
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={onSearchChange}
                      className={cn(
                        "w-full bg-white/5 rounded-md pl-8 pr-4 py-2 text-sm font-light",
                        "text-white/80 placeholder:text-white/40",
                        "focus:outline-none focus:ring-0"
                      )}
                      placeholder={searchPlaceholder}
                    />
                  </div>
                </div>
              )}

              {items.map((item) => {
                if (item.type === 'divider') {
                  return <div key={item.id} className="h-px bg-white/5 my-1" />
                }

                const Icon = item.icon
                return (
                  <button
                    key={item.id}
                    onClick={() => {
                      item.onClick?.()
                      handleOpenChange(false)
                    }}
                    disabled={item.comingSoon || loading}
                    className={cn(
                      "w-full flex items-center gap-3 px-2.5 h-7 rounded-md hover:bg-white/5 transition-colors group relative",
                      item.danger && "hover:bg-red-500/10 text-red-400/60 hover:text-red-400",
                      item.comingSoon && "opacity-50 cursor-not-allowed hover:bg-transparent",
                      loading && "opacity-50 cursor-wait"
                    )}
                  >
                    {Icon && <Icon className={cn(
                      "w-3.5 h-3.5 text-white/60 group-hover:text-white/80 transition-colors",
                      item.danger && "text-red-400/60 group-hover:text-red-400"
                    )} />}
                    <span className={cn(
                      "text-sm text-white/80 font-extralight text-left flex-1",
                      item.danger && "text-red-400/60 group-hover:text-red-400"
                    )}>
                      {item.label}
                    </span>
                    {item.comingSoon && (
                      <div className="ml-auto">
                        <span className="text-[10px] font-medium text-white/80 bg-white/10 px-1.5 py-0.5 rounded">
                          soon
                        </span>
                      </div>
                    )}
                  </button>
                )
              })}
            </div>
          </PopoverContent>
          <TooltipContent
            side="bottom"
            className="bg-zinc-900/95 border border-white/5 px-2 py-1"
          >
            {tooltipContent}
          </TooltipContent>
        </Popover>
      </Tooltip>
    </TooltipProvider>
  )
}
````

## File: apps/app/src/components/chat/messages/CommandMenu.tsx
````typescript
"use client"

import React, { useState } from "react"
import {
  ChevronRight,
  Bot,
  Search,
  Brain,
  Code,
  ListTree,
  LayoutList,
  MessageSquare,
  Wand2,
  Link2
} from "lucide-react"
import { BaseMenu, BaseMenuItem } from "./BaseMenu"

interface CommandMenuProps {
  onSelect: (type: string) => void
  className?: string
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export function CommandMenu({ onSelect, className, open, onOpenChange }: CommandMenuProps) {
  const [searchQuery, setSearchQuery] = useState("")

  const menuItems: BaseMenuItem[] = [
    // Development
    {
      id: 'code',
      label: 'code session',
      icon: Bot,
      onClick: () => onSelect('code')
    },
    {
      id: 'analyze',
      label: 'analyze code',
      icon: Code,
      onClick: () => onSelect('analyze'),
      comingSoon: true
    },
    {
      id: 'divider1',
      type: 'divider'
    },
    // Content
    {
      id: 'search',
      label: 'semantic search',
      icon: Search,
      onClick: () => onSelect('search')
    },
    {
      id: 'links',
      label: 'find links',
      icon: Link2,
      onClick: () => onSelect('links'),
      comingSoon: true
    },
    {
      id: 'divider2',
      type: 'divider'
    },
    // Organization
    {
      id: 'outline',
      label: 'show outline',
      icon: LayoutList,
      onClick: () => onSelect('outline'),
      comingSoon: true
    },
    {
      id: 'tree',
      label: 'view thread tree',
      icon: ListTree,
      onClick: () => onSelect('tree'),
      comingSoon: true
    },
    {
      id: 'context',
      label: 'get context',
      icon: Brain,
      onClick: () => onSelect('context'),
      comingSoon: true
    }
  ]

  return (
    <BaseMenu
      icon={<ChevronRight className="h-4 w-4" />}
      label="command"
      shortcut="ctrl+3"
      items={menuItems}
      showSearch
      searchPlaceholder="Search commands..."
      searchQuery={searchQuery}
      onSearchChange={(e) => setSearchQuery(e.target.value)}
      className={className}
      open={open}
      onOpenChange={onOpenChange}
    />
  )
}
````

## File: apps/app/src/components/chat/messages/ContextHandler.tsx
````typescript
import React from "react"
import { ContextBar } from "@/components/chat/context/ContextBar"
import { ContextSuggestions } from "@/components/chat/context/ContextSuggestions"
import { ReferencePreview } from "@/components/chat/references/ReferencePreview"
import type { Context, ContextType } from "@/types/ai/context"
import { Reference } from '@/types/ai/context'

interface ContextHandlerProps {
  contexts: Context[]
  onContextClick: (context: Context) => void
  onContextRemove: (id: string) => void
  references: Reference[]
  suggestions: any[]
  isLoadingSuggestions: boolean
  className?: string
}

export function ContextHandler({
  contexts,
  onContextClick,
  onContextRemove,
  references,
  suggestions,
  isLoadingSuggestions,
  className
}: ContextHandlerProps) {
  return (
    <div className={className}>
      {/* Context bar */}
      <ContextBar
        contexts={contexts}
        onContextClick={onContextClick}
        onContextRemove={onContextRemove}
        className="mb-4"
      />

      {/* Reference preview */}
      {references.length > 0 && (
        <div className="absolute bottom-full w-full mb-4 px-4">
          <div className="flex flex-wrap gap-2 p-2 rounded-lg bg-zinc-900/50 border border-white/5">
            {references.map((ref) => ({
              ...ref,
              type: ref.type as ContextType,
              content: ref.content || "",
              similarity: ref.similarity || 0
            })).map((ref, i) => (
              <ReferencePreview 
                key={i} 
                reference={{
                  ...ref,
                  id: String(ref.id),
                  type: ref.type as ContextType,
                  content: ref.content || "",
                  similarity: ref.similarity || 0
                }} 
              />
            ))}
          </div>
        </div>
      )}

      {/* Live Suggestions */}
      <ContextSuggestions
        suggestions={suggestions}
        isLoading={isLoadingSuggestions}
        className="absolute bottom-full mb-2 left-0 right-0 px-4"
      />
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/FileHandler.tsx
````typescript
import React, { useState, useRef } from "react"
import { toast } from "sonner"
import { FilePreview } from "./FilePreview"

interface FileHandlerProps {
  onFilesChange: (files: File[]) => void
  className?: string
}

export function FileHandler({ onFilesChange, className }: FileHandlerProps) {
  const [isDragging, setIsDragging] = useState(false)
  const [isUploading, setIsUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)
  const [pendingFiles, setPendingFiles] = useState<File[]>([])
  const dropzoneRef = useRef<HTMLDivElement>(null)

  const handleDrop = async (e: React.DragEvent) => {
    e.preventDefault()
    setIsDragging(false)

    const files = Array.from(e.dataTransfer.files)
    if (files.length === 0) return

    for (const file of files) {
      if (file.type.startsWith("image/")) {
        await handleImageUpload(file)
      } else {
        await handleFileUpload(file)
      }
    }
  }

  const handleImageUpload = async (file: File) => {
    setIsUploading(true)
    try {
      const newFiles = [...pendingFiles, file]
      setPendingFiles(newFiles)
      onFilesChange(newFiles)
      toast.success("Image ready to send")
    } catch (error) {
      toast.error("Failed to prepare image. Please try again.")
    } finally {
      setIsUploading(false)
      setUploadProgress(0)
    }
  }

  const handleFileUpload = async (file: File) => {
    setIsUploading(true)
    try {
      const newFiles = [...pendingFiles, file]
      setPendingFiles(newFiles)
      onFilesChange(newFiles)
      toast.success("File ready to send")
    } catch (error) {
      toast.error("Failed to prepare file. Please try again.")
    } finally {
      setIsUploading(false)
      setUploadProgress(0)
    }
  }

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || [])
    const newFiles = [...pendingFiles, ...files]
    setPendingFiles(newFiles)
    onFilesChange(newFiles)
  }

  const removeFile = (file: File) => {
    const newFiles = pendingFiles.filter(f => f !== file)
    setPendingFiles(newFiles)
    onFilesChange(newFiles)
  }

  return (
    <div className={className}>
      {pendingFiles.length > 0 && (
        <div className="mb-2">
          <FilePreview
            files={pendingFiles}
            onRemove={removeFile}
          />
        </div>
      )}

      <div
        ref={dropzoneRef}
        onDragEnter={(e) => {
          e.preventDefault()
          setIsDragging(true)
        }}
        onDragLeave={(e) => {
          e.preventDefault()
          if (dropzoneRef.current && !dropzoneRef.current.contains(e.relatedTarget as Node)) {
            setIsDragging(false)
          }
        }}
        onDragOver={(e) => e.preventDefault()}
        onDrop={handleDrop}
      >
        {/* Hidden file inputs */}
        <input
          type="file"
          id="file-input"
          className="hidden"
          onChange={handleFileChange}
        />
        <input
          type="file"
          id="image-input"
          className="hidden"
          accept="image/*"
          onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0])}
        />

        {/* Upload progress overlay */}
        {isUploading && (
          <div className="absolute inset-0 flex items-center justify-center rounded-lg bg-zinc-900/90 z-10">
            <div className="flex flex-col items-center gap-2">
              <div className="h-1 w-32 bg-white/10 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-white/40 transition-all duration-300" 
                  style={{ width: `${uploadProgress}%` }} 
                />
              </div>
              <span className="text-sm text-white/60">Uploading...</span>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/FilePreview.tsx
````typescript
"use client"

import React from "react"
import { X, FileText, Image as ImageIcon } from "lucide-react"
import { cn } from "@/lib/utils"

interface FilePreviewProps {
  files: File[]
  onRemove: (file: File) => void
  className?: string
}

export function FilePreview({ files, onRemove, className }: FilePreviewProps) {
  if (files.length === 0) return null

  return (
    <div className={cn("flex flex-wrap gap-2", className)}>
      {files.map((file, i) => (
        <div
          key={`${file.name}-${i}`}
          className="relative group flex items-center gap-2 px-2 py-1 rounded-md bg-white/5 border border-white/10"
        >
          {/* Icon */}
          <div className="text-white/40">
            {file.type.startsWith("image/") ? (
              <ImageIcon className="w-4 h-4" />
            ) : (
              <FileText className="w-4 h-4" />
            )}
          </div>

          {/* File name */}
          <span className="text-sm font-light text-white/60 truncate max-w-[120px]">
            {file.name}
          </span>

          {/* Remove button */}
          <button
            onClick={() => onRemove(file)}
            className="p-1 rounded-md text-white/40 hover:text-white/60 hover:bg-white/5 transition-colors"
          >
            <X className="w-3 h-3" />
          </button>
        </div>
      ))}
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/MarkdownPreview.tsx
````typescript
import React from "react"
import ReactMarkdown from "react-markdown"
import remarkGfm from "remark-gfm"
import remarkMath from "remark-math"
import rehypeKatex from "rehype-katex"
import { Prism as SyntaxHighlighter } from "react-syntax-highlighter"
import { cn } from "@/lib/utils"
import { User, Hash, Link2, FileText, Smile } from "lucide-react"
import { oneDark } from 'react-syntax-highlighter/dist/esm/styles/prism'

// Tag patterns for highlighting
const TAG_PATTERNS = {
  user: /@(\w+)/g,
  topic: /#(\w+)/g,
  thread: />(\w+)/g,
  file: /!(\w+)/g,
  emoji: /:(\w+):/g,
}

interface MarkdownPreviewProps {
  content: string
  className?: string
}

export function MarkdownPreview({ content, className }: MarkdownPreviewProps) {
  // Process tags in text
  const processText = (text: string) => {
    let result = text
    
    // Define special tags for highlighting
    const tags: { pattern: RegExp; type: string; icon: React.ReactNode }[] = [
      { pattern: TAG_PATTERNS.user, type: "user", icon: <User className="h-3 w-3" /> },
      { pattern: TAG_PATTERNS.topic, type: "topic", icon: <Hash className="h-3 w-3" /> },
      { pattern: TAG_PATTERNS.thread, type: "thread", icon: <Link2 className="h-3 w-3" /> },
      { pattern: TAG_PATTERNS.file, type: "file", icon: <FileText className="h-3 w-3" /> },
      { pattern: TAG_PATTERNS.emoji, type: "emoji", icon: <Smile className="h-3 w-3" /> },
    ]

    // Process special tags
    tags.forEach(({ pattern, type, icon }) => {
      result = result.replace(pattern, (match, name) => {
        return `<span class="inline-flex items-center gap-0.5 px-1 rounded bg-white/5 text-white/80">
          ${icon}
          <span>${name}</span>
        </span>`
      })
    })

    // Process HTML tags
    const htmlTags = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'ul', 'ol', 'li', 'blockquote', 'pre', 'code']
    htmlTags.forEach((tag) => {
      result = result.replace(new RegExp(`<${tag}>`, 'g'), (match) => {
        return `<span class="inline-flex items-center gap-0.5 px-1 rounded bg-white/5 text-white/80">
          ${match}
        </span>`
      })
    })

    return result
  }

  return (
    <div className={cn("prose prose-invert max-w-none", className)}>
      <ReactMarkdown
        remarkPlugins={[remarkGfm, remarkMath]}
        rehypePlugins={[rehypeKatex]}
        components={{
          // Custom code block renderer
          code({ node, className, children, ...props }) {
            const match = /language-(\w+)/.exec(className || '')
            const lang = match ? match[1] : ""
            
            if (!lang) {
              return (
                <code className={cn("bg-white/5 px-1.5 py-0.5 rounded", className)} {...props}>
                  {children}
                </code>
              )
            }

            return (
              <div className="relative group">
                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <span className="text-xs text-white/40 bg-white/5 px-1.5 py-0.5 rounded">
                    {lang}
                  </span>
                </div>
                <SyntaxHighlighter
                  language={lang}
                  PreTag="div"
                  customStyle={{
                    margin: 0,
                    background: "rgba(255,255,255,0.03)",
                    borderRadius: "0.375rem",
                  }}
                  style={oneDark as unknown as { [key: string]: React.CSSProperties }}
                >
                  {String(children).replace(/\n$/, "")}
                </SyntaxHighlighter>
              </div>
            )
          },

          // Custom paragraph renderer for tag highlighting
          p({ children }) {
            if (typeof children === "string") {
              return (
                <p dangerouslySetInnerHTML={{ __html: processText(children) }} />
              )
            }
            return <p>{children}</p>
          },

          // Custom link renderer
          a({ href, children }) {
            return (
              <a
                href={href}
                target="_blank"
                rel="noopener noreferrer"
                className="text-blue-400 hover:text-blue-300 transition-colors"
              >
                {children}
              </a>
            )
          },

          // Custom image renderer
          img({ src, alt }) {
            return (
              <div className="relative group">
                <img
                  src={src}
                  alt={alt}
                  className="rounded-lg max-h-[300px] object-contain bg-black/20"
                />
                {alt && (
                  <div className="absolute bottom-0 left-0 right-0 p-2 bg-black/50 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                    <span className="text-xs text-white/80">{alt}</span>
                  </div>
                )}
              </div>
            )
          },
        }}
      >
        {content}
      </ReactMarkdown>
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/MentionsMenu.tsx
````typescript
"use client"

import React, { useState } from "react"
import {
  User,
  Users,
  Clock,
  AtSign,
  Star,
  UserPlus,
  Search
} from "lucide-react"
import { BaseMenu, BaseMenuItem } from "./BaseMenu"

interface MentionsMenuProps {
  onSelect: (type: string, data: any) => void
  className?: string
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export function MentionsMenu({
  onSelect,
  className,
  open,
  onOpenChange
}: MentionsMenuProps) {
  const [searchQuery, setSearchQuery] = useState("")

  // Menu items for @ mentions
  const menuItems: BaseMenuItem[] = [
    {
      id: 'recent',
      label: 'recent users',
      icon: Clock,
      onClick: () => onSelect('recent', { id: '1', name: 'Recent User' })
    },
    {
      id: 'starred',
      label: 'starred contacts',
      icon: Star,
      onClick: () => onSelect('starred', { id: '2', name: 'Starred User' })
    },
    {
      id: 'divider1',
      type: 'divider'
    },
    {
      id: 'team',
      label: 'team members',
      icon: Users,
      onClick: () => onSelect('team', { id: '3', name: 'Team Member' })
    },
    {
      id: 'direct',
      label: 'direct contacts',
      icon: User,
      onClick: () => onSelect('direct', { id: '4', name: 'Direct Contact' })
    },
    {
      id: 'divider2',
      type: 'divider'
    },
    {
      id: 'invite',
      label: 'invite new user',
      icon: UserPlus,
      onClick: () => onSelect('invite', { id: '5', name: 'New User' }),
      comingSoon: true
    }
  ]

  return (
    <BaseMenu
      icon={<AtSign className="h-4 w-4" />}
      label="mention"
      shortcut="ctrl+1"
      items={menuItems}
      showSearch
      searchPlaceholder="Search users..."
      searchQuery={searchQuery}
      onSearchChange={(e) => setSearchQuery(e.target.value)}
      className={className}
      open={open}
      onOpenChange={onOpenChange}
    />
  )
}
````

## File: apps/app/src/components/chat/messages/MenuHandler.tsx
````typescript
"use client"

import React, { useState, useCallback } from "react"
import { useLeaderKey } from "@/hooks/useLeaderKey"
import { CommandHints } from "@/components/ui/command-hints"

// Import menus
import { PlusMenu } from "./PlusMenu"
import { CommandMenu } from "./CommandMenu"
import { ReferenceMenu } from "./ReferenceMenu"
import { MentionsMenu } from "./MentionsMenu"

interface MenuHandlerProps {
  onInsertText: (text: string, cursorOffset?: number) => void
}

export function MenuHandler({ onInsertText }: MenuHandlerProps) {
  const [activeMenu, setActiveMenu] = useState<string | null>(null)

  // Menu state handlers
  const openMenu = useCallback((menu: string) => {
    setActiveMenu(menu)
  }, [])

  const closeMenu = useCallback(() => {
    setActiveMenu(null)
  }, [])

  // Define commands for leader key system
  const commands = [
    { key: "0", action: () => openMenu('plus'), description: "attach" },
    { key: "1", action: () => openMenu('mentions'), description: "mention" },
    { key: "2", action: () => openMenu('reference'), description: "reference" },
    { key: "3", action: () => openMenu('command'), description: "command" }
  ]

  // Use leader key hook
  const { showHints } = useLeaderKey({
    leaderKey: 'Space',
    timeout: 2000,
    commands
  })

  return (
    <>
      <div className="flex items-center gap-1">
        <div className="flex items-center gap-2 border-r border-white/5 pr-2">
          <PlusMenu
            onSelect={(type) => {
              // Handle file upload or other content types
              console.log('Selected type:', type)
            }}
            open={activeMenu === 'plus'}
            onOpenChange={(open) => open ? openMenu('plus') : closeMenu()}
          />
        </div>
        
        <div className="flex items-center gap-2 pl-1">
          <MentionsMenu 
            onSelect={onInsertText}
            open={activeMenu === 'mentions'}
            onOpenChange={(open) => open ? openMenu('mentions') : closeMenu()}
          />
          <ReferenceMenu 
            onSelect={onInsertText}
            open={activeMenu === 'reference'}
            onOpenChange={(open) => open ? openMenu('reference') : closeMenu()}
          />
          <CommandMenu 
            onSelect={onInsertText}
            open={activeMenu === 'command'}
            onOpenChange={(open) => open ? openMenu('command') : closeMenu()}
          />
        </div>
      </div>

      <CommandHints
        show={showHints}
        commands={commands}
      />
    </>
  )
}
````

## File: apps/app/src/components/chat/messages/MessageBubble.tsx
````typescript
"use client"

import React, { useState } from "react"
import { motion } from "framer-motion"
import { cn } from "@/lib/utils"
import { formatDate } from "@/lib/utils"
import ReactMarkdown from "react-markdown"
import remarkGfm from "remark-gfm"
import { MoreHorizontal, Copy, Reply, Link2, MessageSquare, Trash2 } from "lucide-react"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"
import { toast } from "sonner"
import { useAppSelector } from "@/lib/redux/store"
import { selectMessageReferences } from "@/lib/redux/slices/chatSlice"
import { Message } from '@/types'
import { ContextBar } from "../context/ContextBar"
import type { Context } from "@/types/ai/context"

interface MessageBubbleProps {
  message: {
    id: string
    chat_id: string
    sender_id: string
    content: string
    created_at: string
    status?: 'processing' | 'sent' | 'error'
    sender?: {
      email?: string
      full_name?: string
      avatar_url?: string
    }
  }
  className?: string
  onDelete?: () => void
  onReply?: () => void
  onCopy?: () => void
  onLink?: () => void
  onThread?: () => void
  contexts?: Context[]
}

interface MenuItem {
  id: string
  label: string
  icon: React.ComponentType<{ className?: string }>
  onClick: () => void
  danger?: boolean
  comingSoon?: boolean
}

export function MessageBubble({ 
  message, 
  className,
  onDelete,
  onReply,
  onCopy,
  onLink,
  onThread,
  contexts = []
}: MessageBubbleProps) {
  const references = useAppSelector(state => selectMessageReferences(state, message.id))
  const [isHovered, setIsHovered] = useState(false)

  // Ensure we have a valid date before formatting
  const formattedDate = React.useMemo(() => {
    try {
      const date = new Date(message.created_at)
      // Check if date is valid
      if (isNaN(date.getTime())) {
        return ''
      }
      return formatDate(date)
    } catch (error) {
      console.error('Invalid date:', message.created_at)
      return ''
    }
  }, [message.created_at])

  const menuItems: MenuItem[] = [
    {
      id: 'reply',
      label: 'reply',
      icon: Reply,
      onClick: () => {
        if (onReply) {
          onReply();
        } else {
          toast.info('Reply coming soon');
        }
      }
    },
    {
      id: 'copy',
      label: 'copy text',
      icon: Copy,
      onClick: () => {
        if (onCopy) {
          onCopy()
        } else {
          navigator.clipboard.writeText(message.content)
          toast.success('Message copied to clipboard')
        }
      }
    },
    {
      id: 'link',
      label: 'copy link',
      icon: Link2,
      onClick: () => {
        if (onLink) {
          onLink();
        } else {
          toast.info('Link copying coming soon');
        }
      }
    },
    {
      id: 'thread',
      label: 'start thread',
      icon: MessageSquare,
      onClick: () => {
        if (onThread) {
          onThread();
        } else {
          toast.info('Threading coming soon');
        }
      }
    },
    {
      id: 'delete',
      label: 'delete',
      icon: Trash2,
      onClick: () => {
        if (onDelete) {
          onDelete();
        } else {
          toast.info('Delete coming soon');
        }
      },
      danger: true
    }
  ]

  return (
    <div className={cn("group relative", className)}>
      <div className="flex flex-col gap-3">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="text-sm font-light text-white/80">
              {message.sender?.full_name || message.sender?.email?.split('@')[0] || 'unknown'}
            </span>
            {formattedDate && (
              <span className="text-xs text-white/40 font-extralight">
                {formattedDate}
              </span>
            )}
            {message.status === 'processing' && (
              <motion.div
                initial={{ scale: 0.5 }}
                animate={{ scale: 1 }}
                className="relative ml-2"
              >
                <div className="absolute -inset-1 rounded-full bg-[var(--blue-primary)]/20 animate-pulse" />
                <div className="h-2 w-2 rounded-full bg-[var(--blue-primary)]" />
              </motion.div>
            )}
          </div>

          {/* Menu Button - Only visible on hover */}
          <Popover>
            <PopoverTrigger asChild>
              <button
                className={cn(
                  "p-1 rounded-md transition-all duration-200",
                  "text-white/40 hover:text-white/60 hover:bg-white/5",
                  !isHovered && "opacity-0"
                )}
              >
                <MoreHorizontal className="w-4 h-4" />
              </button>
            </PopoverTrigger>
            <PopoverContent 
              align="end" 
              className="w-56 p-1.5"
              sideOffset={4}
            >
              <div className="space-y-0.5">
                {menuItems.map((item) => (
                  <button
                    key={item.id}
                    onClick={item.onClick}
                    className={cn(
                      "w-full flex items-center gap-3 px-2.5 h-7 rounded-md hover:bg-white/5 transition-colors group relative",
                      item.danger && "hover:bg-red-500/10 text-red-400/60 hover:text-red-400",
                      item.comingSoon && "opacity-50 cursor-not-allowed hover:bg-transparent"
                    )}
                  >
                    <item.icon className={cn(
                      "w-3.5 h-3.5 text-white/60 group-hover:text-white/80 transition-colors",
                      item.danger && "text-red-400/60 group-hover:text-red-400"
                    )} />
                    <div className="flex items-center gap-2 flex-1">
                      <span className={cn(
                        "text-sm text-white/80 font-extralight text-left flex-1",
                        item.danger && "text-red-400/60 group-hover:text-red-400"
                      )}>
                        {item.label}
                      </span>
                      {item.comingSoon && (
                        <div className="ml-auto">
                          <span className="text-[10px] font-medium text-white/80 bg-white/10 px-1.5 py-0.5 rounded">
                            soon
                          </span>
                        </div>
                      )}
                    </div>
                  </button>
                ))}
              </div>
            </PopoverContent>
          </Popover>
        </div>

        <div className="text-sm text-white/80 font-light leading-relaxed">
          <ReactMarkdown 
            remarkPlugins={[remarkGfm]}
            components={{
              code({ className, children }) {
                return (
                  <code className={cn(
                    "rounded bg-white/5 px-1.5 py-0.5 text-[13px] font-mono",
                    className
                  )}>
                    {children}
                  </code>
                )
              },
              pre({ children }) {
                return (
                  <pre className="rounded-lg bg-white/5 p-4 font-mono text-[13px] leading-relaxed">
                    {children}
                  </pre>
                )
              }
            }}
          >
            {message.content}
          </ReactMarkdown>
        </div>

        {/* Context bar for message-specific contexts */}
        {contexts.length > 0 && (
          <ContextBar 
            contexts={contexts}
            variant="inline"
            className="mt-3 -mx-2 w-[calc(100%+16px)]"
          />
        )}
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/MessageInput.tsx
````typescript
"use client"

import { motion } from "framer-motion"
import { Send } from "lucide-react"
import React, { useState, useRef, useEffect, useCallback } from "react"
import TextareaAutosize from "react-textarea-autosize"
import { toast } from "sonner"

import { useReferences } from "@/hooks/useReferences"
import { useSuggestions } from "@/hooks/useSuggestions"
import { MessageProcessor } from "@/lib/ai/messageProcessor"
import { cn } from "@/lib/utils"

import { FileHandler } from "./FileHandler"
import { MenuHandler } from "./MenuHandler"
import { ContextHandler } from "./ContextHandler"

import type { Context } from "@/types/ai/context"

interface MessageInputProps {
  chatId: string
  className?: string
  demo?: boolean
}

export function MessageInput({ chatId, className, demo = false }: MessageInputProps) {
  // Core state
  const [content, setContent] = useState("")
  const [isComposing, setIsComposing] = useState(false)
  const [isSending, setIsSending] = useState(false)
  
  // File handling state
  const [isDragging, setIsDragging] = useState(false)
  const [isUploading, setIsUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)
  
  // Menu state
  const [activeMenu, setActiveMenu] = useState<'user' | 'reference' | 'command' | null>(null)
  const [searchQuery, setSearchQuery] = useState("")

  // Context state
  const [activeContexts, setActiveContexts] = useState<Context[]>([])
  const [showSuggestions, setShowSuggestions] = useState(false)
  
  // Refs
  const inputRef = useRef<HTMLTextAreaElement>(null)
  const dropzoneRef = useRef<HTMLDivElement>(null)

  // Use hooks
  const { references } = useReferences(content, chatId) as { 
    references: import('@/types/ai/context').Reference[] 
  }
  const { suggestions, isLoading: isLoadingSuggestions } = useSuggestions(content, chatId, {
    limit: 5,
    threshold: 0.7
  })

  const [pendingFiles, setPendingFiles] = useState<File[]>([])

  // Focus management - only on mount and if not demo
  useEffect(() => {
    if (!demo && inputRef.current) {
      inputRef.current.focus()
    }
  }, [demo]) // Empty dependency array since we only want this on mount

  const handleSubmit = useCallback(async (e: React.FormEvent) => {
    e.preventDefault()
    if (!content.trim() && pendingFiles.length === 0) return

    setIsSending(true)
    try {
      const processor = new MessageProcessor()
      const result = await processor.processMessage({
        chatId,
        content: content.trim(),
        files: pendingFiles,
        contexts: activeContexts.map(c => ({
          id: c.id,
          type: c.type
        })),
        references: references.map(ref => ({
          type: ref.type,
          id: ref.id,
          metadata: ref.metadata
        }))
      })

      // Clear input and state after successful send
      setContent("")
      setPendingFiles([])
      setActiveContexts([])
      if (inputRef.current) {
        inputRef.current.style.height = "auto"
      }
    } catch (error) {
      console.error('Failed to send message:', error)
      toast.error("Failed to send message. Please try again.")
    } finally {
      setIsSending(false)
    }
  }, [chatId, content, pendingFiles, activeContexts, references])

  // Handle keyboard triggers
  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    // Submit on Enter (unless shift or composing)
    if (e.key === "Enter" && !e.shiftKey && !isComposing) {
      e.preventDefault()
      handleSubmit(e)
      return
    }

    // Handle menu triggers with cmd/ctrl
    if (e.metaKey || e.ctrlKey) {
      switch (e.key) {
        case '@':
          e.preventDefault()
          setActiveMenu('user')
          break
        case '#':
          e.preventDefault()
          setActiveMenu('reference')
          break
        case '>':
          e.preventDefault()
          setActiveMenu('command')
          break
      }
    }
  }, [isComposing, handleSubmit])

  const handleInsertText = useCallback((text: string, cursorOffset: number = text.length) => {
    if (!inputRef.current) return

    const start = inputRef.current.selectionStart
    const end = inputRef.current.selectionEnd

    const newContent = content.slice(0, start) + text + content.slice(end)
    setContent(newContent)

    // Set cursor position after inserted text
    setTimeout(() => {
      if (!inputRef.current) return
      const newPosition = start + cursorOffset
      inputRef.current.selectionStart = newPosition
      inputRef.current.selectionEnd = newPosition
      inputRef.current.focus()
    }, 0)
  }, [content])

  return (
    <div className={cn("relative", className)}>
      {/* Context Handler */}
      <ContextHandler
        contexts={activeContexts}
        onContextClick={(context) => setActiveContexts(prev => [...prev, context])}
        onContextRemove={(id) => setActiveContexts(prev => prev.filter(c => c.id !== id))}
        references={references}
        suggestions={suggestions}
        isLoadingSuggestions={isLoadingSuggestions}
      />

      {/* File Handler */}
      <FileHandler
        onFilesChange={setPendingFiles}
      />

      {/* Main input container */}
      <div className="bg-zinc-900/50 border border-white/5 rounded-lg">
        {/* Input area */}
        <div className="flex flex-col">
          <div className="px-4 pt-4">
            <TextareaAutosize
              ref={inputRef}
              value={content}
              onChange={(e) => setContent(e.target.value)}
              onKeyDown={handleKeyDown}
              onCompositionStart={() => setIsComposing(true)}
              onCompositionEnd={() => setIsComposing(false)}
              placeholder="Message... (@ for users, # for references, > for commands)"
              className="block w-full bg-transparent text-sm text-white/80 
                      placeholder:text-white/20 font-light resize-none
                      focus:outline-none min-h-[20px] leading-tight"
              maxRows={12}
            />
          </div>

          {/* Action bar */}
          <div className="flex items-center justify-between px-2 py-1 border-t border-white/5 mt-2">
            <div className="flex items-center gap-1">
              {/* Menu Handler */}
              <MenuHandler onInsertText={handleInsertText} />
            </div>

            {/* Send Button */}
            <button
              onClick={handleSubmit}
              disabled={!content.trim() || isSending}
              className={cn(
                "h-8 w-8 flex items-center justify-center rounded-md",
                "hover:bg-white/5 text-white/40 hover:text-white/60 transition-colors",
                "disabled:opacity-50 disabled:cursor-not-allowed",
                isSending && "opacity-70"
              )}
            >
              <div className="relative">
                {isSending ? (
                  <motion.div
                    animate={{ rotate: 360 }}
                    transition={{ duration: 1.2, repeat: Infinity }}
                    className="h-3.5 w-3.5 border-2 border-white/20 border-t-transparent rounded-full"
                  />
                ) : (
                  <Send className="h-4 w-4" />
                )}
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/MessageList.tsx
````typescript
"use client"

import React, { useEffect, useRef } from "react"
import { cn } from "@/lib/utils"
import { MessageBubble } from "./MessageBubble"
import { AnimatePresence, motion } from "framer-motion"

interface MessageListProps {
  messages: {
    id: string
    content: string
    created_at: string
    sender?: {
      email?: string
      full_name?: string
    }
    chat_id?: string
    sender_id?: string
  }[]
  className?: string
}

export function MessageList({ messages, className }: MessageListProps) {
  const scrollRef = useRef<HTMLDivElement>(null)
  const lastMessageRef = useRef<string | null>(null)
  const isNearBottomRef = useRef(true)

  useEffect(() => {
    const scrollContainer = scrollRef.current
    if (!scrollContainer) return

    // Check if we're near the bottom before a new message comes in
    const checkIfNearBottom = () => {
      if (!scrollContainer) return
      const threshold = 100 // pixels from bottom
      const position = scrollContainer.scrollHeight - scrollContainer.scrollTop - scrollContainer.clientHeight
      isNearBottomRef.current = position < threshold
    }

    // Add scroll listener
    scrollContainer.addEventListener('scroll', checkIfNearBottom)
    return () => scrollContainer.removeEventListener('scroll', checkIfNearBottom)
  }, [])

  useEffect(() => {
    // If we have messages and either:
    // 1. This is the first load (no last message ref)
    // 2. We have a new message (last message id changed)
    // 3. We were near the bottom when the new message came in
    if (messages.length > 0 && 
      (!lastMessageRef.current || 
       lastMessageRef.current !== messages[messages.length - 1].id) &&
       isNearBottomRef.current) {
      // Update our ref
      lastMessageRef.current = messages[messages.length - 1].id
      
      // Scroll to bottom
      if (scrollRef.current) {
        scrollRef.current.scrollTop = scrollRef.current.scrollHeight
      }
    }
  }, [messages])

  return (
    <div className="flex-1 flex flex-col min-h-0">
      <div 
        ref={scrollRef}
        className={cn(
          "flex-1 overflow-y-auto",
          className
        )}
      >
        <div className="flex flex-col justify-end min-h-full">
          <AnimatePresence initial={false}>
            {messages.map((message) => (
              <motion.div
                key={message.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.2 }}
                className="px-4 py-2"
              >
                <MessageBubble message={{
                  ...message,
                  chat_id: message.chat_id || 'unknown',
                  sender_id: message.sender_id || 'unknown'
                }} />
              </motion.div>
            ))}
          </AnimatePresence>
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/messages/PlusMenu.tsx
````typescript
"use client"

import React from "react"
import {
  Plus,
  Image,
  FileText,
  Folder,
  Map,
  Link2,
  Code,
  Book,
  Video,
  FileIcon
} from "lucide-react"
import { BaseMenu, BaseMenuItem } from "./BaseMenu"
import { Button } from "@/components/ui/button"
import { cn } from "@/lib/utils"

interface PlusMenuProps {
  onSelect: (type: string) => void
  className?: string
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export function PlusMenu({
  onSelect,
  className,
  open,
  onOpenChange
}: PlusMenuProps) {
  const menuItems: BaseMenuItem[] = [
    // Media
    {
      id: 'image',
      label: 'add image',
      icon: Image,
      onClick: () => onSelect('image')
    },
    {
      id: 'video',
      label: 'add video',
      icon: Video,
      onClick: () => onSelect('video')
    },
    {
      id: 'divider1',
      type: 'divider'
    },
    // Files & Links
    {
      id: 'file',
      label: 'add file',
      icon: FileIcon,
      onClick: () => onSelect('file')
    },
    {
      id: 'link',
      label: 'paste link',
      icon: Link2,
      onClick: () => onSelect('link')
    },
    {
      id: 'divider2',
      type: 'divider'
    },
    // Code & Docs
    {
      id: 'code',
      label: 'code reference',
      icon: Code,
      onClick: () => onSelect('code')
    },
    {
      id: 'docs',
      label: 'documentation',
      icon: Book,
      onClick: () => onSelect('docs')
    },
    {
      id: 'divider3',
      type: 'divider'
    },
    // Organization
    {
      id: 'folder',
      label: 'add folder',
      icon: Folder,
      onClick: () => onSelect('folder')
    },
    {
      id: 'location',
      label: 'share location',
      icon: Map,
      onClick: () => onSelect('location')
    }
  ]

  return (
    <BaseMenu
      icon={<Plus className="h-4 w-4" />}
      label="add"
      shortcut="ctrl+0"
      items={menuItems}
      className={className}
      width="w-48"
      open={open}
      onOpenChange={onOpenChange}
    >
      <Button
        size="icon"
        variant="ghost"
        className={cn(
          "h-8 w-8 text-white/40 hover:text-white/60",
          className
        )}
      >
        <Plus className="h-4 w-4" />
      </Button>
    </BaseMenu>
  )
}
````

## File: apps/app/src/components/chat/messages/ReferenceMenu.tsx
````typescript
"use client"

import React, { useState } from "react"
import { Hash, MessageSquare, Clock, Star, MessagesSquare } from "lucide-react"
import { BaseMenu, BaseMenuItem } from "./BaseMenu"

interface ReferenceMenuProps {
  onSelect: (type: string, data: any) => void
  className?: string
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export function ReferenceMenu({
  onSelect,
  className,
  open,
  onOpenChange
}: ReferenceMenuProps) {
  const [searchQuery, setSearchQuery] = useState("")

  // Menu items for references
  const menuItems: BaseMenuItem[] = [
    {
      id: 'recent',
      label: 'recent',
      icon: Clock,
      onClick: () => onSelect('recent', { type: 'moment' })
    },
    {
      id: 'favorited',
      label: 'favorited',
      icon: Star,
      onClick: () => onSelect('favorited', { type: 'moment' })
    },
    {
      id: 'chat',
      label: 'this chat',
      icon: MessagesSquare,
      onClick: () => onSelect('chat', { type: 'chat' })
    },
    {
      id: 'divider1',
      type: 'divider'
    },
    {
      id: 'moment',
      label: 'reference moment',
      icon: MessageSquare,
      onClick: () => onSelect('moment', { type: 'moment' })
    },
    {
      id: 'topic',
      label: 'tag topic',
      icon: Hash,
      onClick: () => onSelect('topic', { type: 'topic' })
    }
  ]

  return (
    <BaseMenu
      icon={<Hash className="h-4 w-4" />}
      label="reference"
      shortcut="ctrl+2"
      items={menuItems}
      showSearch
      searchPlaceholder="search references..."
      searchQuery={searchQuery}
      onSearchChange={(e) => setSearchQuery(e.target.value)}
      className={className}
      open={open}
      onOpenChange={onOpenChange}
    />
  )
}
````

## File: apps/app/src/components/chat/messages/ReferencePanel.tsx
````typescript
import React from "react"
import { ScrollArea } from "@/components/ui/scroll-area"
import { cn } from "@/lib/utils"
import { MessageSquare, FileText, Link2, ExternalLink } from "lucide-react"
import { Button } from "@/components/ui/button"

interface ContentReference {
  id: string
  type: "message" | "file" | "thread" | "url"
  title: string
  preview?: string
  metadata?: any
  similarity: number
}

interface ReferencePanelProps {
  references: ContentReference[]
  onSelect: (ref: ContentReference) => void
  className?: string
}

export function ReferencePanel({ references, onSelect, className }: ReferencePanelProps) {
  if (!references.length) return null

  return (
    <div className={cn("w-full rounded-lg border border-white/5 bg-zinc-900/50", className)}>
      <ScrollArea className="h-[200px] px-4">
        <div className="space-y-4 py-4">
          {references.map((ref) => (
            <div
              key={ref.id}
              className="flex items-start gap-3 p-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer"
              onClick={() => onSelect(ref)}
            >
              {/* Icon */}
              <div className="mt-1">
                {ref.type === "message" && (
                  <MessageSquare className="h-4 w-4 text-white/40" />
                )}
                {ref.type === "file" && (
                  <FileText className="h-4 w-4 text-white/40" />
                )}
                {ref.type === "thread" && (
                  <Link2 className="h-4 w-4 text-white/40" />
                )}
                {ref.type === "url" && (
                  <ExternalLink className="h-4 w-4 text-white/40" />
                )}
              </div>

              {/* Content */}
              <div className="flex-1 min-w-0">
                <div className="flex items-center justify-between gap-2">
                  <h4 className="text-sm font-medium truncate">{ref.title}</h4>
                  <div className="text-xs text-white/40">
                    {Math.round(ref.similarity * 100)}% match
                  </div>
                </div>
                {ref.preview && (
                  <p className="text-sm text-white/60 line-clamp-2 mt-1">
                    {ref.preview}
                  </p>
                )}
              </div>
            </div>
          ))}
        </div>
      </ScrollArea>
    </div>
  )
}

interface ReferenceButtonProps {
  count: number
  onClick: () => void
  className?: string
}

export function ReferenceButton({ count, onClick, className }: ReferenceButtonProps) {
  if (!count) return null

  return (
    <Button
      variant="ghost"
      size="default"
      className={cn(
        "text-xs text-white/40 hover:text-white/60 transition-colors",
        className
      )}
      onClick={onClick}
    >
      <Link2 className="h-3 w-3 mr-1" />
      {count} reference{count !== 1 ? "s" : ""}
    </Button>
  )
}
````

## File: apps/app/src/components/chat/messages/TagInput.tsx
````typescript
import React, { useState, useRef, useCallback } from "react"
import TextareaAutosize from "react-textarea-autosize"
import { cn } from "@/lib/utils"
import { ScrollArea } from "@/components/ui/scroll-area"
import { User, Hash, Link2, FileText, Smile } from "lucide-react"
import { MarkdownPreview } from "./MarkdownPreview"

// Tag patterns
const TAG_PATTERNS = {
  user: /@(\w+|$)/g,
  topic: /#(\w+|$)/g,
  thread: />(\w+|$)/g,
  file: /!(\w+|$)/g,
  emoji: /:(\w+|$)/g,
} as const

type TagType = keyof typeof TAG_PATTERNS
type TagMatch = {
  type: TagType
  text: string
  index: number
  length: number
}

interface TagSuggestion {
  type: TagType
  id: string
  title: string
  preview?: string
  icon?: React.ReactNode
}

interface TagInputProps {
  value: string
  onChange: (value: string) => void
  onTagSelect?: (tag: TagSuggestion) => void
  suggestions?: TagSuggestion[]
  className?: string
  placeholder?: string
}

export function TagInput({ 
  value, 
  onChange, 
  onTagSelect, 
  suggestions = [], 
  className,
  placeholder = "message... (markdown supported)", 
}: TagInputProps) {
  const [cursorPosition, setCursorPosition] = useState(0)
  const [activeTag, setActiveTag] = useState<TagMatch | null>(null)
  const [activeSuggestions, setActiveSuggestions] = useState<TagSuggestion[]>([])
  const [selectedIndex, setSelectedIndex] = useState(0)
  const [isFocused, setIsFocused] = useState(false)
  const inputRef = useRef<HTMLTextAreaElement>(null)

  // Find all tag matches in text
  const findTags = useCallback((text: string): TagMatch[] => {
    const matches: TagMatch[] = []
    Object.entries(TAG_PATTERNS).forEach(([type, pattern]) => {
      let match
      while ((match = pattern.exec(text)) !== null) {
        matches.push({
          type: type as TagType,
          text: match[1] || "",
          index: match.index,
          length: match[0].length,
        })
      }
    })
    return matches.sort((a, b) => a.index - b.index)
  }, [])

  // Get the active tag at cursor position
  const getActiveTag = useCallback((text: string, position: number): TagMatch | null => {
    const matches = findTags(text)
    return matches.find(match => 
      position > match.index && 
      position <= match.index + match.length
    ) || null
  }, [findTags])

  // Filter suggestions based on active tag
  const filterSuggestions = useCallback((tag: TagMatch | null): TagSuggestion[] => {
    if (!tag) return []
    return suggestions
      .filter(s => s.type === tag.type && 
                  s.title.toLowerCase().includes(tag.text.toLowerCase()))
      .slice(0, 5)
  }, [suggestions])

  // Handle input changes
  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newValue = e.target.value
    const newPosition = e.target.selectionStart || 0
    
    setCursorPosition(newPosition)
    const tag = getActiveTag(newValue, newPosition)
    setActiveTag(tag)
    setActiveSuggestions(filterSuggestions(tag))
    setSelectedIndex(0)
    
    onChange(newValue)
  }

  // Handle keyboard navigation
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (activeSuggestions.length === 0) return

    if (e.key === "ArrowDown") {
      e.preventDefault()
      setSelectedIndex(i => (i + 1) % activeSuggestions.length)
    } else if (e.key === "ArrowUp") {
      e.preventDefault()
      setSelectedIndex(i => (i - 1 + activeSuggestions.length) % activeSuggestions.length)
    } else if (e.key === "Enter" && activeTag) {
      e.preventDefault()
      const suggestion = activeSuggestions[selectedIndex]
      if (suggestion) {
        const prefix = value.slice(0, activeTag.index)
        const suffix = value.slice(activeTag.index + activeTag.length)
        const tagText = getTagText(suggestion)
        onChange(prefix + tagText + suffix)
        onTagSelect?.(suggestion)
        setActiveSuggestions([])
      }
    } else if (e.key === "Escape") {
      setActiveSuggestions([])
    }
  }

  // Get display text for a tag
  const getTagText = (suggestion: TagSuggestion): string => {
    switch (suggestion.type) {
      case "user": return `@${suggestion.title}`
      case "topic": return `#${suggestion.title}`
      case "thread": return `>${suggestion.title}`
      case "file": return `!${suggestion.title}`
      case "emoji": return `:${suggestion.title}:`
    }
  }

  // Get icon for a tag type
  const getTagIcon = (type: TagType) => {
    switch (type) {
      case "user": return <User className="h-4 w-4" />
      case "topic": return <Hash className="h-4 w-4" />
      case "thread": return <Link2 className="h-4 w-4" />
      case "file": return <FileText className="h-4 w-4" />
      case "emoji": return <Smile className="h-4 w-4" />
    }
  }

  return (
    <div className={cn("relative", className)}>
      {/* Input */}
      <div className="relative">
        {/* Preview layer */}
        <div 
          className={cn(
            "absolute inset-0 pointer-events-none opacity-0 transition-opacity duration-200",
            !isFocused && value && "opacity-100"
          )}
        >
          <MarkdownPreview 
            content={value || placeholder} 
            className={cn(
              "text-sm",
              !value && "text-white/20"
            )}
          />
        </div>

        {/* Input layer */}
        <TextareaAutosize
          ref={inputRef}
          value={value}
          onChange={handleChange}
          onKeyDown={handleKeyDown}
          onFocus={() => setIsFocused(true)}
          onBlur={() => setIsFocused(false)}
          placeholder={placeholder}
          className="block w-full bg-transparent text-sm text-white/80 rounded-lg
                    placeholder:text-white/20 font-light resize-none
                    focus:outline-none"
          maxRows={12}
        />
      </div>

      {/* Suggestions */}
      {activeSuggestions.length > 0 && (
        <div className="absolute bottom-full left-0 w-64 mb-2">
          <div className="bg-zinc-900/95 border border-white/5 rounded-lg overflow-hidden">
            <ScrollArea className="max-h-[200px]">
              {activeSuggestions.map((suggestion, i) => (
                <button
                  key={suggestion.id}
                  className={cn(
                    "w-full flex items-start gap-2 p-2 text-left",
                    "hover:bg-white/5 transition-colors",
                    i === selectedIndex && "bg-white/5"
                  )}
                  onClick={() => {
                    if (activeTag) {
                      const prefix = value.slice(0, activeTag.index)
                      const suffix = value.slice(activeTag.index + activeTag.length)
                      const tagText = getTagText(suggestion)
                      onChange(prefix + tagText + suffix)
                      onTagSelect?.(suggestion)
                      setActiveSuggestions([])
                    }
                  }}
                >
                  <div className="mt-0.5 text-white/40">
                    {getTagIcon(suggestion.type)}
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="text-sm font-medium truncate">
                      {suggestion.title}
                    </div>
                    {suggestion.preview && (
                      <div className="text-xs text-white/40 truncate">
                        {suggestion.preview}
                      </div>
                    )}
                  </div>
                </button>
              ))}
            </ScrollArea>
          </div>
        </div>
      )}
    </div>
  )
}
````

## File: apps/app/src/components/chat/references/ReferencePanel.tsx
````typescript
"use client"

import { Message, Reference } from '@/types'
import { Card } from "@/components/ui/card"
import { ScrollArea } from "@/components/ui/scroll-area"
import { cn } from "@/lib/utils"
import { BookOpenIcon } from "lucide-react"

interface ReferencePanelProps {
  references?: Message["references"]
  className?: string
}

export function ReferencePanel({ references, className }: ReferencePanelProps) {
  if (!references?.length) {
    return (
      <div
        className={cn(
          "flex h-full flex-col items-center justify-center text-center",
          className
        )}
      >
        <BookOpenIcon className="mb-4 h-12 w-12 text-muted-foreground/50" />
        <h3 className="font-medium text-muted-foreground">No references</h3>
        <p className="text-sm text-muted-foreground/80">
          References will appear here when available
        </p>
      </div>
    )
  }

  return (
    <ScrollArea className={className}>
      <div className="space-y-4 pr-4">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-medium">References</h3>
          <span className="text-xs text-muted-foreground">
            {references.length} found
          </span>
        </div>
        {references.map((ref) => (
          <Card key={ref.id} className="p-4">
            <h4 className="mb-2 font-medium leading-none">{ref.title}</h4>
            <p className="mb-4 text-sm text-muted-foreground">{ref.content}</p>
            <a
              href={ref.url}
              target="_blank"
              rel="noopener noreferrer"
              className="text-xs text-primary underline-offset-4 hover:underline"
            >
              View source
            </a>
          </Card>
        ))}
      </div>
    </ScrollArea>
  )
}
````

## File: apps/app/src/components/chat/references/ReferencePreview.tsx
````typescript
"use client"

import React from "react"
import { Reference } from "@/types"
import { cn } from "@/lib/utils"
import { User, Hash, Link, File, Link2 } from "lucide-react"

interface ReferencePreviewProps {
  reference: Reference
  className?: string
  demo?: boolean
}

export function ReferencePreview({ reference, className, demo }: ReferencePreviewProps) {
  const { type, metadata } = reference

  const icons = {
    user: User,
    thread: Hash,
    link: Link,
    file: File,
    topic: Hash,
    message: Link2
  } as const

  const Icon = icons[type as keyof typeof icons] || Hash

  return (
    <div 
      className={cn(
        "flex items-center gap-2 px-2 py-1 rounded bg-zinc-800/50 border border-white/5",
        "text-sm text-white/60 hover:text-white/80 transition-colors",
        className
      )}
    >
      <Icon className="h-3.5 w-3.5" />
      <span className="truncate max-w-[200px]">
        {type === "user" && (metadata.full_name || metadata.email)}
        {type === "thread" && metadata.title}
        {type === "link" && (metadata.url ? new URL(metadata.url).hostname : metadata.title)}
        {type === "file" && metadata.name}
      </span>
    </div>
  )
}
````

## File: apps/app/src/components/chat/settings/ProfileSettings.tsx
````typescript
"use client"

import React from "react"
import { User } from "@supabase/supabase-js"
import { Upload } from "lucide-react"
import { toast } from "sonner"
import { getSupabaseClient } from "@/lib/supabase/client"

interface ProfileSettingsProps {
  user: User | null
  onSave: () => void
}

export function ProfileSettings({ user, onSave }: ProfileSettingsProps) {
  const [fullName, setFullName] = React.useState(user?.user_metadata?.full_name || "")

  const handleUploadAvatar = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file || !user) return

    try {
      const supabase = getSupabaseClient()
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from("avatars")
        .upload(`${user.id}/${Date.now()}`, file)

      if (uploadError) throw uploadError

      const { data: { publicUrl } } = supabase.storage
        .from("avatars")
        .getPublicUrl(uploadData.path)

      const { error: updateError } = await supabase.auth.updateUser({
        data: { avatar_url: publicUrl }
      })

      if (updateError) throw updateError
      toast.success("avatar updated")
      onSave()
    } catch (error) {
      console.error("Failed to upload avatar:", error)
      toast.error("failed to upload avatar")
    }
  }

  return (
    <div className="space-y-6">
      {/* Avatar */}
      <div className="flex flex-col items-center gap-4">
        <div className="relative h-20 w-20">
          <div className="absolute inset-0 rounded-full bg-zinc-800 flex items-center justify-center">
            {user?.user_metadata?.avatar_url ? (
              <img
                src={user.user_metadata.avatar_url}
                alt={user.email || ""}
                className="h-full w-full rounded-full object-cover"
              />
            ) : (
              <span className="text-2xl font-light text-white/40">
                {user?.email?.[0].toUpperCase()}
              </span>
            )}
          </div>
          <label className="absolute -right-2 -top-2 rounded-full bg-zinc-800 p-2 text-white/60 transition-colors hover:text-white/80 cursor-pointer">
            <input
              type="file"
              accept="image/*"
              onChange={handleUploadAvatar}
              className="hidden"
            />
            <Upload className="h-4 w-4" />
          </label>
        </div>
      </div>

      {/* Form */}
      <div className="space-y-4">
        <div>
          <label className="text-xs font-light text-white/40">
            email
          </label>
          <input
            type="email"
            value={user?.email || ""}
            disabled
            className="mt-1 w-full rounded-lg border border-white/5 bg-zinc-800/50 px-4 py-2 text-sm font-light text-white/60"
          />
        </div>
        <div>
          <label className="text-xs font-light text-white/40">
            full name
          </label>
          <input
            type="text"
            value={fullName}
            onChange={(e) => setFullName(e.target.value)}
            placeholder="enter your full name"
            className="mt-1 w-full rounded-lg border border-white/5 bg-zinc-800/50 px-4 py-2 text-sm font-light text-white/90 placeholder:text-white/20"
          />
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/settings/ShortcutSettings.tsx
````typescript
"use client"

import React from "react"
import { motion, AnimatePresence } from "framer-motion"
import { cn } from "@/lib/utils"

interface ShortcutSettingsProps {
  shortcuts: ShortcutSetting[]
  onShortcutChange: (id: string, keys: string[]) => void
  onReset: () => void
}

interface ShortcutSetting {
  id: string
  label: string
  keys: string[]
}

export function ShortcutSettings({ shortcuts, onShortcutChange, onReset }: ShortcutSettingsProps) {
  const [recordingId, setRecordingId] = React.useState<string | null>(null)
  const [recordedKeys, setRecordedKeys] = React.useState<string[]>([])
  const recordTimeoutRef = React.useRef<NodeJS.Timeout | null>(null)

  const handleKeyDown = React.useCallback((e: KeyboardEvent) => {
    if (!recordingId) return
    e.preventDefault()

    const keys: string[] = []
    if (e.metaKey) keys.push('‚åò')
    if (e.ctrlKey) keys.push('ctrl')
    if (e.altKey) keys.push('alt')
    if (e.shiftKey) keys.push('shift')
    
    // Add the main key if it's not a modifier
    if (!['Meta', 'Control', 'Alt', 'Shift'].includes(e.key)) {
      keys.push(e.key.toLowerCase())
    }

    if (keys.length > 0) {
      setRecordedKeys(keys)
      // Auto-save after a brief delay
      if (recordTimeoutRef.current) {
        clearTimeout(recordTimeoutRef.current)
      }
      recordTimeoutRef.current = setTimeout(() => {
        onShortcutChange(recordingId, keys)
        setRecordingId(null)
        setRecordedKeys([])
      }, 500)
    }
  }, [recordingId, onShortcutChange])

  React.useEffect(() => {
    if (recordingId) {
      window.addEventListener('keydown', handleKeyDown)
      return () => {
        window.removeEventListener('keydown', handleKeyDown)
        if (recordTimeoutRef.current) {
          clearTimeout(recordTimeoutRef.current)
        }
      }
    }
  }, [recordingId, handleKeyDown])

  return (
    <div className="space-y-1">
      {shortcuts.map((shortcut) => (
        <button
          key={shortcut.id}
          onClick={() => setRecordingId(shortcut.id)}
          className="w-full h-9 flex items-center justify-between gap-3 px-2.5 rounded-md hover:bg-white/5 transition-colors group"
        >
          <div className="text-sm font-light text-white/80 group-hover:text-white/90">
            {shortcut.label}
          </div>
          <AnimatePresence mode="wait">
            {recordingId === shortcut.id ? (
              <motion.div
                key="recording"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="text-sm font-light text-white/40"
              >
                <span className="animate-pulse">recording...</span>
              </motion.div>
            ) : (
              <motion.div
                key="shortcut"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="flex items-center gap-1"
              >
                {shortcut.keys.map((key, index) => (
                  <React.Fragment key={index}>
                    <kbd className="px-1.5 py-0.5 text-xs font-mono bg-white/5 rounded text-white/60">
                      {key}
                    </kbd>
                    {index < shortcut.keys.length - 1 && (
                      <span className="text-white/20">+</span>
                    )}
                  </React.Fragment>
                ))}
              </motion.div>
            )}
          </AnimatePresence>
        </button>
      ))}

      <div className="mt-4 px-2.5">
        <button
          onClick={onReset}
          className="text-xs font-light text-white/40 hover:text-white/60 transition-colors"
        >
          reset to defaults
        </button>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/sidebar/ChatFilters.tsx
````typescript
"use client"

import React from "react"
import { cn } from "@/lib/utils"

export type ChatFilterType = 'all' | 'personal' | 'direct' | 'group' | 'archived'

interface ChatFiltersProps {
  value: ChatFilterType
  onChange: (value: ChatFilterType) => void
}

export function ChatFilters({ value, onChange }: ChatFiltersProps) {
  const filters: { value: ChatFilterType; label: string }[] = [
    { value: 'all', label: 'all' },
    { value: 'personal', label: 'personal' },
    { value: 'direct', label: 'direct' },
    { value: 'group', label: 'group' },
    { value: 'archived', label: 'archive' }
  ]

  return (
    <div className="flex items-center justify-center gap-0 py-1">
      {filters.map((filter) => (
        <button
          key={filter.value}
          onClick={() => onChange(filter.value)}
          className={cn(
            "px-3 py-1 text-sm font-light rounded-lg transition-colors whitespace-nowrap",
            filter.value === value ? "text-white/90" : "text-white/40 hover:text-white/60"
          )}
        >
          {filter.label}
        </button>
      ))}
    </div>
  )
}
````

## File: apps/app/src/components/chat/sidebar/ChatItem.tsx
````typescript
"use client"

import React from "react"
import { useRouter, useParams } from "next/navigation"
import { cn } from "@/lib/utils"
import { Chat } from "@/lib/supabase/chats"
import { getChatGradient } from "@/lib/utils/colors"
import { motion } from "framer-motion"
import { useSelector } from "react-redux"
import { RootState } from "@/lib/redux/store"

interface ChatItemProps {
  chat: Chat
  className?: string
}

export function ChatItem({ chat, className }: ChatItemProps) {
  const router = useRouter()
  const params = useParams()
  const currentUser = useSelector((state: RootState) => state.auth.user)
  const currentChatId = params?.id as string

  const getChatTitle = () => {
    if (chat.type === 'personal') return 'personal chat'
    if (chat.type === 'direct') {
      // Get the other participant's name
      const otherParticipant = chat.chat_participants?.find(p => 
        p.profiles && p.profiles.id !== currentUser?.id
      )?.profiles
      return otherParticipant?.full_name || otherParticipant?.email?.split('@')[0] || 'new conversation'
    }
    return chat.title || 'group chat'
  }

  return (
    <button
      onClick={() => router.push(`/chat/${chat.id}`)}
      className={cn(
        "w-full px-3 py-2.5 rounded-lg transition-colors text-left group relative",
        "hover:bg-white/5",
        chat.id === currentChatId && "bg-white/5",
        className
      )}
    >
      <div className="space-y-1">
        <div className="flex items-center justify-between gap-3">
          <span className="text-sm font-light text-white/90 truncate">
            {getChatTitle()}
          </span>
          {chat.has_unread && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.2 }}
              className={cn(
                "w-1.5 h-1.5 rounded-full bg-gradient-to-br shadow-lg",
                getChatGradient(chat.id),
                "shadow-[0_0_8px_rgba(139,92,246,0.3)]"
              )}
            />
          )}
        </div>
        {chat.last_message && (
          <motion.p
            key={chat.last_message.content}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="text-sm text-white/60 font-extralight truncate text-left"
          >
            {chat.last_message.content}
          </motion.p>
        )}
      </div>
    </button>
  )
}
````

## File: apps/app/src/components/chat/sidebar/ChatSearch.tsx
````typescript
"use client"

import React from "react"
import { Search } from "lucide-react"
import { cn } from "@/lib/utils"
import { useHotkeys } from "react-hotkeys-hook"

interface ChatSearchProps {
  value: string
  onChange: (value: string) => void
  className?: string
}

export function ChatSearch({ value, onChange, className }: ChatSearchProps) {
  const inputRef = React.useRef<HTMLInputElement>(null)

  // Focus search with ‚åòK
  useHotkeys('mod+k', (e) => {
    e.preventDefault()
    inputRef.current?.focus()
  })

  return (
    <div className={cn("relative", className)}>
      <input
        ref={inputRef}
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder="search chats..."
        className={cn(
          "w-full h-9 px-9 bg-zinc-900/50 border border-white/5 rounded-lg",
          "text-sm text-white/80 font-extralight placeholder:text-white/20",
          "focus:outline-none focus:border-white/10 transition-colors"
        )}
      />
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/40" />
      {value && (
        <div className="absolute right-3 top-1/2 -translate-y-1/2">
          <kbd className="text-[10px] font-mono text-white/40 bg-white/5 px-1.5 py-0.5 rounded">
            esc
          </kbd>
        </div>
      )}
    </div>
  )
}
````

## File: apps/app/src/components/chat/sidebar/PinnedChats.tsx
````typescript
"use client"

import React from "react"
import { Chat } from "@/lib/supabase/chats"
import { ScrollArea } from "@/components/ui/scroll-area"
import { AvatarButton } from "@/components/ui/avatar-button"

interface PinnedChatsProps {
  chats: Chat[]
}

export function PinnedChats({ chats }: PinnedChatsProps) {
  if (chats.length === 0) return null

  return (
    <div className="px-4 py-2 border-b border-white/5">
      <ScrollArea className="w-full" orientation="horizontal">
        <div className="flex gap-4 pb-2">
          {chats.map((chat) => (
            <AvatarButton
              key={chat.id}
              id={chat.id}
              href={`/chat/${chat.id}`}
              size="lg"
              vertical
              label={chat.title}
            />
          ))}
        </div>
      </ScrollArea>
    </div>
  )
}
````

## File: apps/app/src/components/chat/ChatHeader.tsx
````typescript
"use client"

import React, { useState } from "react"
import { ChevronDown, Pencil, RotateCcw, Flower } from "lucide-react"
import { motion } from "framer-motion"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"
import { ChatMenu } from "./ChatMenu"
import { updateChatTitle } from "@/lib/supabase/chats"
import { toast } from "sonner"
import { generateChatName } from "@/lib/utils/chat-names"
import { useDispatch, useSelector } from 'react-redux'
import { updateChat } from '@/lib/redux/slices/chatSlice'
import { RootState } from '@/lib/redux/store'
import { AvatarButton } from "@/components/ui/avatar-button"
import { Button } from "@/components/ui/button"

interface ChatHeaderProps {
  chatId: string
  type: 'personal' | 'direct' | 'group'
  title?: string
  participants?: {
    user_id: string
    joined_at: string
    last_read_at: string
    profiles: {
      id: string
      email: string
      full_name?: string | null
      avatar_url?: string | null
    }
  }[]
  demo?: boolean
  isContextPanelOpen?: boolean
  onContextPanelToggle?: () => void
}

export function ChatHeader({ 
  chatId, 
  type, 
  title, 
  participants = [], 
  demo = false,
  isContextPanelOpen = false,
  onContextPanelToggle
}: ChatHeaderProps) {
  const dispatch = useDispatch()
  const chat = useSelector((state: RootState) => 
    state.chat.data.find(c => c.id === chatId)
  )
  const [isEditing, setIsEditing] = useState(false)
  const [editedTitle, setEditedTitle] = useState(title || '')
  const [isSaving, setIsSaving] = useState(false)

  const currentTitle = chat?.title || title

  const { displayTitle, subtitle } = React.useMemo(() => {
    if (type === 'personal') {
      return { 
        displayTitle: currentTitle,
        subtitle: null
      }
    }
    
    if (type === 'direct' && participants.length > 0) {
      const otherUser = participants[0].profiles
      return { 
        displayTitle: currentTitle || otherUser.email.split('@')[0],
        subtitle: otherUser.full_name ? otherUser.email : null
      }
    }
    
    if (type === 'group') {
      return { 
        displayTitle: currentTitle || 'group chat',
        subtitle: `${participants.length} participants`
      }
    }

    return { 
      displayTitle: 'new conversation',
      subtitle: null
    }
  }, [type, participants, currentTitle])

  const handleSave = async () => {
    if (!editedTitle.trim() || editedTitle === currentTitle) {
      setIsEditing(false)
      setEditedTitle(currentTitle || '')
      return
    }

    setIsSaving(true)
    try {
      await updateChatTitle(chatId, editedTitle.trim())
      dispatch(updateChat({ 
        id: chatId, 
        title: editedTitle.trim(),
        type,
        chat_participants: participants.map(p => ({
          ...p,
          chat_id: chatId
        }))
      }))
      toast.success('chat name updated')
    } catch (error) {
      console.error('Failed to update chat name:', error)
      toast.error('failed to update chat name')
      setEditedTitle(currentTitle || '')
    } finally {
      setIsSaving(false)
      setIsEditing(false)
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSave()
    } else if (e.key === 'Escape') {
      setIsEditing(false)
      setEditedTitle(currentTitle || '')
    }
  }

  const handleGenerateNewName = async () => {
    setIsSaving(true)
    try {
      const newName = generateChatName()
      await updateChatTitle(chatId, newName)
      dispatch(updateChat({
        id: chatId,
        title: newName,
        type,
        chat_participants: participants.map(p => ({
          ...p,
          chat_id: chatId
        }))
      }))
      setEditedTitle(newName)
      setIsEditing(false)
      toast.success('chat name updated')
    } catch (error) {
      console.error('Failed to generate new chat name:', error)
      toast.error('failed to update chat name')
    } finally {
      setIsSaving(false)
    }
  }

  return (
    <div className="h-14 flex items-center justify-between px-4 border-b border-white/5">
      <div className="flex items-center space-x-3">
        <AvatarButton
          id={chatId}
          size="sm"
          isInteractive={false}
        />
        <div className="flex flex-col min-w-0">
          <div className="flex items-center h-5 group">
            {isEditing ? (
              <div className="flex items-center gap-2 max-w-md">
                <input
                  type="text"
                  value={editedTitle}
                  onChange={(e) => setEditedTitle(e.target.value)}
                  onKeyDown={handleKeyDown}
                  onBlur={handleSave}
                  autoFocus
                  className="text-sm font-light text-white/90 bg-transparent focus:outline-none placeholder:text-white/40"
                  placeholder="enter chat name"
                />
                <button
                  onClick={handleGenerateNewName}
                  className="p-1 rounded hover:bg-white/5 text-white/40 hover:text-white/60 transition-colors"
                >
                  <RotateCcw className="w-3.5 h-3.5" />
                </button>
              </div>
            ) :
              <div className="flex items-center gap-2">
                <button
                  onClick={() => {
                    setIsEditing(true)
                    setEditedTitle(currentTitle || '')
                  }}
                  className="text-sm font-light text-white/90 truncate hover:text-white transition-colors text-left"
                >
                  {displayTitle}
                </button>
                <button
                  onClick={() => {
                    setIsEditing(true)
                    setEditedTitle(currentTitle || '')
                  }}
                  className="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-white/5 text-white/40 hover:text-white/60 transition-all"
                >
                  <Pencil className="w-3.5 h-3.5" />
                </button>
              </div>
            }
          </div>
          {subtitle && (
            <Popover>
              <PopoverTrigger asChild>
                <button className="flex items-center gap-1 text-xs text-white/40 font-extralight hover:text-white/60 transition-colors">
                  {subtitle}
                  {type === 'group' && <ChevronDown className="w-3 h-3" />}
                </button>
              </PopoverTrigger>
              {type === 'group' && (
                <PopoverContent 
                  className="w-56 p-1.5" 
                  align="start" 
                  sideOffset={8}
                  collisionPadding={16}
                >
                  <div className="space-y-0.5">
                    {participants.map((participant) => (
                      <button
                        key={participant.user_id}
                        className="w-full flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-white/5 transition-colors text-left group"
                      >
                        <AvatarButton
                          id={participant.user_id}
                          size="sm"
                          isInteractive={false}
                          imageSrc={participant.profiles.avatar_url}
                        />
                        <div className="flex-1 min-w-0">
                          <div className="text-sm text-white/80 font-extralight truncate">
                            {participant.profiles.full_name || participant.profiles.email.split('@')[0]}
                          </div>
                          {participant.profiles.full_name && (
                            <div className="text-xs text-white/40 font-extralight truncate">
                              {participant.profiles.email}
                            </div>
                          )}
                        </div>
                      </button>
                    ))}
                  </div>
                </PopoverContent>
              )}
            </Popover>
          )}
        </div>
      </div>

      {/* Actions */}
      <div className="flex items-center gap-2">
        {/* Context Panel Toggle */}
        <Button
          variant="ghost"
          size="icon"
          onClick={onContextPanelToggle}
          className="h-8 w-8 text-white/40 hover:text-white/60"
        >
          <motion.div
            initial={false}
            animate={{ rotate: isContextPanelOpen ? 180 : 0 }}
            transition={{ duration: 0.2, ease: "easeInOut" }}
          >
            <ChevronDown className="h-4 w-4" />
          </motion.div>
        </Button>

        {/* Menu */}
        <ChatMenu
          chat={{
            id: chatId,
            type,
            is_archived: false
          }}
        />
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/ChatList.tsx
````typescript
"use client"

import React, { useEffect, useState } from "react"
import { useRouter, useParams } from "next/navigation"
import { ChatService } from "@/lib/services/chat"
import { useDispatch, useSelector } from 'react-redux'
import { 
  setChats, 
  updateChat, 
  markChatAsRead,
  setSearchQuery,
  setFilterType,
  selectPinnedChats,
  selectRecentChats,
  removeChat
} from '@/lib/redux/slices/chatSlice'
import { cn } from "@/lib/utils"
import { RootState } from '@/lib/redux/store'
import { ChatSearch } from "./sidebar/ChatSearch"
import { ChatFilters, ChatFilterType } from "./sidebar/ChatFilters"
import { PinnedChats } from "./sidebar/PinnedChats"
import { ChatItem } from "./sidebar/ChatItem"
import { AnimatePresence, motion } from "framer-motion"
import { Skeleton } from "@/components/ui/skeleton"
import { useHotkeys } from "react-hotkeys-hook"
import { useUser } from "@clerk/nextjs"
import type { Chat } from '@/types/api/chat'

interface ChatListProps {
  className?: string
}

export function ChatList({ className }: ChatListProps) {
  const [isLoading, setIsLoading] = useState(true)
  const router = useRouter()
  const params = useParams()
  const dispatch = useDispatch()
  const currentChatId = params?.id as string

  // Get current user from Clerk
  const { user } = useUser()

  // Get filter state from Redux
  const searchQuery = useSelector((state: RootState) => state.chat.filters.search)
  const filterType = useSelector((state: RootState) => state.chat.filters.type)
  const pinnedChats = useSelector(selectPinnedChats)
  const recentChats = useSelector(selectRecentChats)

  // Load initial chats
  useEffect(() => {
    if (!user) return
    
    ChatService.getChats()
      .then(chats => {
        dispatch(setChats(chats))
        setIsLoading(false)
      })
      .catch(error => {
        console.error('Failed to load chats:', error)
        setIsLoading(false)
      })
  }, [dispatch, user])

  // TODO: Implement real-time chat updates
  // For now, we'll poll for updates or implement server-sent events
  useEffect(() => {
    if (!user) return

    // Refresh chats periodically to simulate real-time updates
    const refreshInterval = setInterval(() => {
      ChatService.getChats()
        .then(chats => dispatch(setChats(chats)))
        .catch(console.error)
    }, 30000) // Refresh every 30 seconds

    return () => clearInterval(refreshInterval)
  }, [dispatch, user])

  // Handle chat click
  const handleChatClick = async (chatId: string) => {
    try {
      // Update UI immediately
      dispatch(markChatAsRead(chatId))
      
      // Navigate and update server
      router.push(`/chat/${chatId}`)
      await ChatService.updateChatReadStatus(chatId)
    } catch (error) {
      console.error('Failed to mark chat as read:', error)
      // Revert the UI change if the API call failed
      dispatch(updateChat({ id: chatId, has_unread: true }))
    }
  }

  // Keyboard shortcuts
  useHotkeys('esc', () => {
    if (searchQuery) {
      dispatch(setSearchQuery(''))
    }
  })

  if (isLoading) {
    return (
      <div className="p-4 space-y-4">
        {[...Array(5)].map((_, i) => (
          <motion.div
            key={i}
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: i * 0.1 }}
            className="space-y-2"
          >
            <Skeleton className="h-5 w-[60%]" />
            <Skeleton className="h-4 w-[85%]" />
            <Skeleton className="h-4 w-[70%]" />
          </motion.div>
        ))}
      </div>
    )
  }

  return (
    <div className={cn("flex flex-col min-h-0", className)}>
      {/* Pinned chats - above search */}
      <PinnedChats chats={pinnedChats} />

      {/* Search */}
      <div className="px-4 pt-4 pb-2">
        <ChatSearch
          value={searchQuery}
          onChange={(value) => dispatch(setSearchQuery(value))}
        />
      </div>

      {/* Filters - edge to edge */}
      <div className="overflow-x-auto scrollbar-none">
        <div className="min-w-max">
          <ChatFilters
            value={filterType}
            onChange={(value) => dispatch(setFilterType(value))}
          />
        </div>
      </div>

      {/* Chat lists */}
      <div className="flex-1 overflow-y-auto py-2">
        {recentChats.length === 0 ? (
          <div className="p-4">
            <div className="text-sm text-white/40 font-extralight">
              {filterType === 'archived' ? 'no archived chats...' :
               filterType === 'direct' ? 'no direct chats...' :
               filterType === 'personal' ? 'no personal chats...' :
               filterType === 'group' ? 'no group chats...' :
               'no chats yet'}
            </div>
          </div>
        ) : (
          <div className="space-y-1">
            <AnimatePresence mode="popLayout">
              {recentChats.map((chat) => (
                <motion.div
                  key={chat.id}
                  layout
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -20 }}
                  transition={{ duration: 0.2 }}
                  className="px-2"
                >
                  <ChatItem chat={chat} />
                </motion.div>
              ))}
            </AnimatePresence>
          </div>
        )}
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/ChatMenu.tsx
````typescript
import { useRouter } from "next/navigation"
import * as React from "react"
import { toast } from "sonner"
import {
  MoreHorizontal,
  Share2,
  Trash2,
  Archive,
  MessagesSquare,
  Sparkles,
  Pin,
} from "lucide-react"

import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"
import { archiveChat, deleteChat, toggleChatPin } from "@/lib/supabase/chats"
import { cn } from "@/lib/utils"

interface ChatMenuProps {
  chat: {
    id: string
    type: 'personal' | 'direct' | 'group'
    is_archived?: boolean
    pinned?: boolean
  }
  align?: 'start' | 'center' | 'end'
  className?: string
  children?: React.ReactNode
}

interface MenuItem {
  id: string
  type?: 'divider'
  label?: string
  icon?: React.ComponentType<{ className?: string }>
  onClick?: () => void
  danger?: boolean
  comingSoon?: boolean
}

export function ChatMenu({ chat, align = 'end', className, children }: ChatMenuProps) {
  const router = useRouter()
  const [isDeleting, setIsDeleting] = React.useState(false)
  const [isArchiving, setIsArchiving] = React.useState(false)
  const [isPinning, setIsPinning] = React.useState(false)
  const [isContextPanelOpen, setIsContextPanelOpen] = React.useState(false)

  const handleArchive = React.useCallback(async () => {
    setIsArchiving(true)
    try {
      await archiveChat(chat.id)
      toast.success('chat archived')
    } catch (error) {
      console.error('Failed to archive chat:', error)
      toast.error('failed to archive chat')
    } finally {
      setIsArchiving(false)
    }
  }, [chat.id])

  const handleDelete = React.useCallback(async () => {
    setIsDeleting(true)
    try {
      await deleteChat(chat.id)
      toast.success('chat deleted')
      router.push('/chat')
    } catch (error) {
      console.error('Failed to delete chat:', error)
      toast.error('failed to delete chat')
    } finally {
      setIsDeleting(false)
    }
  }, [chat.id, router])

  const handlePin = React.useCallback(async () => {
    setIsPinning(true)
    try {
      await toggleChatPin(chat.id)
      toast.success(chat.pinned ? 'chat unpinned' : 'chat pinned')
    } catch (error) {
      console.error('Failed to toggle pin:', error)
      toast.error('failed to update chat')
    } finally {
      setIsPinning(false)
    }
  }, [chat.id, chat.pinned])

  const menuItems = React.useMemo(() => {
    const items: MenuItem[] = [
      {
        id: 'share-context',
        label: 'share context',
        icon: Share2,
        onClick: () => toast.info('coming soon'),
        comingSoon: true
      }
    ]

    if (chat.type === 'group') {
      items.push({
        id: 'pin',
        label: chat.pinned ? 'unpin conversation' : 'pin conversation',
        icon: Pin,
        onClick: handlePin,
        comingSoon: false
      })
    }

    items.push(
      { id: 'divider', type: 'divider' },
      {
        id: 'archive',
        label: 'archive chat',
        icon: Archive,
        onClick: handleArchive,
        comingSoon: false
      },
      {
        id: 'delete',
        label: 'delete chat',
        icon: Trash2,
        onClick: handleDelete,
        danger: true,
        comingSoon: false
      }
    )

    return items
  }, [chat.type, chat.pinned, handleArchive, handleDelete, handlePin])

  return (
    <Popover>
      <PopoverTrigger asChild>
        {children || (
          <button
          className={cn(
              "h-8 w-8 flex items-center justify-center rounded-md",
              "hover:bg-white/5 text-white/40 hover:text-white/60 transition-colors",
            className
          )}
        >
            <MoreHorizontal className="w-4 h-4" />
          </button>
        )}
      </PopoverTrigger>
      <PopoverContent 
        align={align}
        className="w-60 p-1.5"
        sideOffset={4}
      >
        <div className="space-y-0.5">
          {menuItems.map((item) => {
            if (item.type === 'divider') {
              return <div key={item.id} className="h-px bg-white/5 my-1" />
            }

            const Icon = item.icon!
            return (
              <button
                key={item.id}
                onClick={item.onClick}
                disabled={
                  item.comingSoon || 
                  (item.id === 'delete' && isDeleting) || 
                  (item.id === 'archive' && isArchiving) ||
                  (item.id === 'pin' && isPinning)
                }
                className={cn(
                  "w-full flex items-center gap-3 px-2.5 h-7 rounded-md hover:bg-white/5 transition-colors group relative",
                  item.danger && "hover:bg-red-500/10 text-red-400/60 hover:text-red-400",
                  item.comingSoon && "opacity-50 cursor-not-allowed hover:bg-transparent",
                  (item.id === 'delete' && isDeleting) && "opacity-50 cursor-wait",
                  (item.id === 'archive' && isArchiving) && "opacity-50 cursor-wait",
                  (item.id === 'pin' && isPinning) && "opacity-50 cursor-wait"
                )}
        >
                <Icon className={cn(
                  "w-3.5 h-3.5 text-white/60 group-hover:text-white/80 transition-colors",
                  item.danger && "text-red-400/60 group-hover:text-red-400"
                )} />
                <div className="flex items-center gap-2 flex-1">
                  <span className={cn(
                    "text-sm text-white/80 font-extralight text-left flex-1",
                    item.danger && "text-red-400/60 group-hover:text-red-400"
                  )}>
                    {item.label}
                  </span>
                  {item.comingSoon && (
                    <div className="ml-auto">
                      <span className="text-[10px] font-medium text-white/80 bg-white/10 px-1.5 py-0.5 rounded">
                        soon
          </span>
                    </div>
                  )}
                </div>
              </button>
            )
          })}
        </div>
      </PopoverContent>
    </Popover>
  )
}
````

## File: apps/app/src/components/chat/MessageList.tsx
````typescript
"use client"

import React, { useEffect, useRef, useMemo } from "react"
import { format } from "date-fns"
import ReactMarkdown from "react-markdown"
import remarkGfm from "remark-gfm"
import remarkMath from "remark-math"
import rehypeKatex from "rehype-katex"
import { Prism as SyntaxHighlighter } from "react-syntax-highlighter"
import { oneDark } from "react-syntax-highlighter/dist/cjs/styles/prism"

interface Message {
  id: string
  content: string
  sender: string
  timestamp: string
  chat_id: string
  sender_id: string
}

interface MessageListProps {
  messages: Message[]
}

export function MessageList({ messages }: MessageListProps) {
  const bottomRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" })
  }, [messages])

  const rawMessages = messages
  const processedMessages: Message[] = useMemo(() => 
    rawMessages.map(m => ({
      ...m,
      chat_id: "current",
      sender_id: m.sender_id || "unknown"
    })), [rawMessages])

  return (
    <div className="flex-1 overflow-y-auto p-4">
      <div className="space-y-4">
        {processedMessages.map((message) => (
          <div key={message.id} className="flex flex-col space-y-1">
            <div className="flex items-center space-x-2">
              <span className="text-sm font-light text-white/90">
                {message.sender}
              </span>
              <span className="text-xs text-white/40 font-extralight">
                {format(new Date(message.timestamp), "h:mm a")}
              </span>
            </div>
            <div className="pl-4">
              <div className="prose prose-invert max-w-none">
                <ReactMarkdown
                  remarkPlugins={[remarkGfm, remarkMath]}
                  rehypePlugins={[rehypeKatex]}
                  components={{
                    code({ node, className, children, ...props }) {
                      const match = /language-(\w+)/.exec(className || '')
                      return match ? (
                        <SyntaxHighlighter
                          style={oneDark}
                          language={match[1]}
                          PreTag="div"
                        >
                          {String(children).replace(/\n$/, '')}
                        </SyntaxHighlighter>
                      ) : (
                        <code className={className} {...props}>
                          {children}
                        </code>
                      )
                    },
                  }}
                >
                  {message.content}
                </ReactMarkdown>
              </div>
            </div>
          </div>
        ))}
        <div ref={bottomRef} />
        {processedMessages.length === 0 && (
          <div className="flex items-center justify-center h-full p-8">
            <div className="text-center space-y-3">
              <div className="mx-auto w-12 h-12 rounded-full bg-gradient-to-r from-[var(--blue-primary)] to-[var(--purple-primary)] animate-pulse" />
              <p className="text-sm text-white/40 font-light">Establishing secure channel...</p>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/chat/NewChatMenu.tsx
````typescript
"use client"

import React, { useState, useRef, useEffect } from "react"
import { AnimatePresence, motion } from "framer-motion"
import { Search, Plus, Users, X, ArrowRight } from "lucide-react"
import { getSupabaseClient } from "@/lib/supabase/client"
import { cn } from "@/lib/utils"
import { PlatformInviteMenu } from "./PlatformInviteMenu"
import { PendingInvite } from "./PendingInvite"
import { toast } from "sonner"

interface Profile {
  id: string
  email: string
  full_name?: string | null
  avatar_url?: string | null
}

interface PendingInvite {
  email: string
  status: 'pending' | 'sent' | 'error'
}

interface NewChatMenuProps {
  isOpen: boolean
  onClose: () => void
  onCreateChat: (userIds: string[]) => void
}

export function NewChatMenu({ 
  isOpen, 
  onClose,
  onCreateChat
}: NewChatMenuProps) {
  const [query, setQuery] = useState("")
  const [suggestions, setSuggestions] = useState<Profile[]>([])
  const [selectedUsers, setSelectedUsers] = useState<Profile[]>([])
  const [selectedIndex, setSelectedIndex] = useState(-1)
  const [isLoading, setIsLoading] = useState(false)
  const [isExiting, setIsExiting] = useState(false)
  const [isPlatformMenuOpen, setIsPlatformMenuOpen] = useState(false)
  const [isEmailMode, setIsEmailMode] = useState(false)
  const inputRef = useRef<HTMLInputElement>(null)
  const [pendingInvites, setPendingInvites] = useState<PendingInvite[]>([])

  const searchProfiles = async (searchQuery: string) => {
    const supabase = getSupabaseClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return []

    const { data: profiles, error } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .or(`email.ilike.%${searchQuery}%,full_name.ilike.%${searchQuery}%`)
      .neq('id', user.id)
      .limit(5)

    if (error) {
      console.error('Error searching profiles:', error)
      return []
    }

    return profiles as Profile[]
  }

  useEffect(() => {
    if (isOpen) {
      inputRef.current?.focus()
      setIsExiting(false)
      setSelectedUsers([])
      setQuery("")
      setIsEmailMode(false)
      setIsPlatformMenuOpen(false)
    }
  }, [isOpen])

  useEffect(() => {
    const search = async () => {
      if (!isEmailMode && query.startsWith("@") && query.length > 1) {
        setIsLoading(true)
        try {
          const searchQuery = query.slice(1).toLowerCase()
          const results = await searchProfiles(searchQuery)
          if (!isExiting) {
        setSuggestions(results)
            setSelectedIndex(-1)
          }
        } catch (error) {
          console.error('Error searching profiles:', error)
          setSuggestions([])
        } finally {
          setIsLoading(false)
        }
      } else {
        setSuggestions([])
        setSelectedIndex(-1)
      }
    }

    const timeoutId = setTimeout(search, 300)
    return () => clearTimeout(timeoutId)
  }, [query, isExiting, isEmailMode])

  useEffect(() => {
    if (suggestions.length > 0) {
      setIsPlatformMenuOpen(false)
    }
  }, [suggestions])

  const addUser = (profile: Profile) => {
    if (!selectedUsers.find(u => u.id === profile.id)) {
      setSuggestions([])
      setTimeout(() => {
        setSelectedUsers(prev => [...prev, profile])
      }, 150)
    }
    setQuery("")
    setTimeout(() => inputRef.current?.focus(), 300)
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (isEmailMode) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault()
        handleSendInvite()
      }
      return
    }

    if (suggestions.length > 0) {
      if (e.key === "ArrowUp") {
        e.preventDefault()
        setSelectedIndex(prev => 
          prev <= 0 ? suggestions.length - 1 : prev - 1
        )
      } else if (e.key === "ArrowDown") {
        e.preventDefault()
        setSelectedIndex(prev => 
          prev >= suggestions.length - 1 ? 0 : prev + 1
        )
      } else if (e.key === "Enter" && selectedIndex >= 0) {
        e.preventDefault()
        addUser(suggestions[selectedIndex])
      }
    } else if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      handleCreateChat()
    } else if (e.key === "Backspace" && query === "" && selectedUsers.length > 0) {
      setSelectedUsers(prev => prev.slice(0, -1))
    }
  }

  const removeUser = (userId: string) => {
    setSelectedUsers(prev => prev.filter(u => u.id !== userId))
  }

  const menuVariants = {
    hidden: { opacity: 0, y: 10 },
    visible: { opacity: 1, y: 0 },
    exit: { opacity: 0, y: 10, transition: { duration: 0.2 } }
  }

  const handleClose = () => {
    setIsExiting(true)
    setSuggestions([])
    setSelectedUsers([])
    setQuery("")
    onClose()
  }

  const handlePlatformSelect = (platform: string) => {
    if (platform === 'email') {
      setIsEmailMode(true)
      setQuery("")
      setIsPlatformMenuOpen(false)
      setTimeout(() => inputRef.current?.focus(), 0)
    }
  }

  const validateEmail = (email: string) => {
    return email
      .toLowerCase()
      .match(
        /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
      )
  }

  const checkExistingUser = async (email: string) => {
    const supabase = getSupabaseClient()
    const { data, error } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .ilike('email', email.toLowerCase())
      .maybeSingle()
    
    if (error) {
      console.error('Error checking existing user:', error)
      return null
    }
    
    if (!data) return null

    return {
      id: data.id,
      email: data.email,
      full_name: data.full_name || null,
      avatar_url: data.avatar_url || null
    } as Profile
  }

  const handleSendInvite = async () => {
    if (!query) return

    // Validate email
    if (!validateEmail(query)) {
      toast.error('Please enter a valid email address')
      return
    }

    // Check if already invited
    if (pendingInvites.some(invite => invite.email.toLowerCase() === query.toLowerCase())) {
      toast.error('Invite already sent to this email')
      return
    }

    // Check if user exists
    const existingUser = await checkExistingUser(query)
    if (existingUser) {
      const fullProfile: Profile = {
        id: existingUser.id as string,
        email: existingUser.email as string,
        full_name: existingUser.full_name || null,
        avatar_url: existingUser.avatar_url || null
      }
      addUser(fullProfile)
      setIsEmailMode(false)
      return
    }

    try {
      const res = await fetch('/api/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: query, chatId: 'temp-id' })
      })
      
      if (!res.ok) throw new Error('Failed to send invite')
      
      // Only add to pending invites after successful send
      setPendingInvites(prev => [...prev, { 
        email: query, 
        status: 'sent' 
      }])
      
      setQuery("")
      setIsEmailMode(false) // Return to base menu
      toast.success('Invite sent')
    } catch (error) {
      console.error('Error sending invite:', error)
      toast.error('Failed to send invite')
    }
  }

  const removePendingInvite = (email: string) => {
    setPendingInvites(prev => prev.filter(invite => invite.email !== email))
  }

  const exitEmailMode = () => {
    setIsEmailMode(false)
    setQuery("")
    setTimeout(() => inputRef.current?.focus(), 0)
  }

  const togglePlatformMenu = () => {
    if (isEmailMode) {
      handleSendInvite()
    } else {
      setSuggestions([])
      setTimeout(() => {
        setIsPlatformMenuOpen(prev => !prev)
      }, 150)
    }
  }

  const handleCreateChat = () => {
    if (selectedUsers.length > 0) {
      onCreateChat(selectedUsers.map(u => u.id))
    } else {
      // Create personal note if no users added
      onCreateChat([])
    }
    handleClose()
  }

  const getSelectedUserIds = () => {
    return selectedUsers.map(u => u.id)
  }

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={handleClose}
            className="fixed inset-0 z-40"
          />
          
          <motion.div 
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="absolute bottom-[68px] left-4 right-4 z-50"
          >
            <AnimatePresence mode="wait">
              {/* Show suggestions if they exist */}
              {!isEmailMode && suggestions.length > 0 ? (
                <motion.div
                  key="suggestions"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ duration: 0.15 }}
                  className="bg-zinc-900/95 backdrop-blur-sm rounded-lg border border-white/5 overflow-hidden p-1.5 mb-2"
                >
                  {suggestions.map((profile, index) => (
                    <button
                      key={profile.id}
                      onClick={() => addUser(profile)}
                      className={cn(
                        "w-full flex items-center gap-3 px-2.5 h-7 rounded-md transition-colors group",
                        index === selectedIndex ? "bg-white/10" : "hover:bg-white/5"
                      )}
                    >
                      <div className="w-5 h-5 rounded-full bg-zinc-800 flex items-center justify-center shrink-0">
                        {profile.avatar_url ? (
                          <img 
                            src={profile.avatar_url} 
                            alt={profile.full_name || profile.email}
                            className="w-5 h-5 rounded-full object-cover"
                          />
                        ) : (
                          <Users className="w-2.5 h-2.5 text-white/60" />
                        )}
                      </div>
                        <div className="text-sm text-white/80 font-extralight">
                        {profile.full_name || profile.email.split('@')[0]}
                      </div>
                    </button>
                  ))}
                </motion.div>
              ) : /* Show platform menu if it's open */
              !isEmailMode && isPlatformMenuOpen ? (
                <motion.div
                  key="platform-menu"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ 
                    duration: 0.15,
                    delay: 0.05
                  }}
                >
                  <PlatformInviteMenu 
                    isOpen={true}
                    onClose={() => setIsPlatformMenuOpen(false)}
                    onSelect={handlePlatformSelect}
                  />
                </motion.div>
              ) : /* Show tag carousel if there are tags */
              (selectedUsers.length > 0 || pendingInvites.length > 0) ? (
                <motion.div
                  key="tag-carousel"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ duration: 0.15 }}
                  className="mb-2"
                >
                  <div className="overflow-x-auto flex gap-1.5 scrollbar-none">
                    <AnimatePresence>
                      {selectedUsers.map((user) => (
                        <motion.div
                          key={user.id}
                          initial={{ opacity: 0, scale: 0.95 }}
                          animate={{ opacity: 1, scale: 1 }}
                          exit={{ opacity: 0, scale: 0.95 }}
                          transition={{ duration: 0.15 }}
                          className="flex items-center gap-1.5 px-1.5 py-0.5 rounded bg-white/5 text-sm text-white/60 shrink-0"
                        >
                          <div className="w-4 h-4 rounded-full bg-zinc-800 flex items-center justify-center shrink-0">
                            {user.avatar_url ? (
                              <img 
                                src={user.avatar_url} 
                                alt={user.full_name || user.email}
                                className="w-4 h-4 rounded-full object-cover"
                              />
                            ) : (
                              <Users className="w-2 h-2 text-white/60" />
                            )}
                          </div>
                          <span className="truncate max-w-[100px]">
                            {user.email.split('@')[0]}
                          </span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              removeUser(user.id)
                            }}
                            className="text-white/40 hover:text-white/60"
                          >
                            <X className="w-3 h-3" />
                          </button>
                        </motion.div>
                      ))}
                      {pendingInvites.map((invite) => (
                        <motion.div
                          key={invite.email}
                          initial={{ opacity: 0, scale: 0.95 }}
                          animate={{ opacity: 1, scale: 1 }}
                          exit={{ opacity: 0, scale: 0.95 }}
                          transition={{ duration: 0.15 }}
                        >
                          <PendingInvite
                            email={invite.email}
                            onRemove={() => removePendingInvite(invite.email)}
                          />
                        </motion.div>
                      ))}
                    </AnimatePresence>
                  </div>
                </motion.div>
              ) : null}
            </AnimatePresence>

            {/* Input field */}
            <div className="relative flex items-center bg-zinc-900/95 backdrop-blur-sm rounded-lg border border-white/5 h-[44px]">
              <div className="w-10 flex items-center justify-center border-r border-white/5">
                {isEmailMode ? (
                  <button
                    onClick={exitEmailMode}
                    className="text-white/40 hover:text-white/60 transition-colors"
                  >
                    <X className="w-4 h-4" />
                  </button>
                ) : (
                  <button 
                    onClick={(e) => {
                      e.stopPropagation()
                      togglePlatformMenu()
                    }}
                    className="text-white/40 hover:text-white/60 transition-colors"
                  >
                    <Plus className="w-4 h-4" />
                  </button>
                )}
              </div>
              <div className="flex-1 flex items-center px-3">
                <input
                  ref={inputRef}
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  onKeyDown={handleKeyDown}
                  onFocus={() => setIsPlatformMenuOpen(false)}
                  placeholder={isEmailMode ? "enter email address..." : "@ to add people..."}
                  className="flex-1 bg-transparent text-sm text-white/80 font-extralight placeholder:text-white/20 focus:outline-none"
                />
              </div>
              <div className="w-10 flex items-center justify-center border-l border-white/5">
                <button 
                  onClick={(e) => {
                    e.stopPropagation()
                    if (isEmailMode) {
                      handleSendInvite()
                    } else {
                      handleCreateChat()
                    }
                  }}
                  className="text-white/40 hover:text-white/60 transition-colors"
                >
                  <ArrowRight className="w-4 h-4" />
                </button>
              </div>
            </div>
            </motion.div>
        </>
      )}
    </AnimatePresence>
  )
}
````

## File: apps/app/src/components/chat/PendingInvite.tsx
````typescript
"use client"

import React from "react"
import { Mail, X } from "lucide-react"
import { cn } from "@/lib/utils"

interface PendingInviteProps {
  email: string
  onRemove?: () => void
  className?: string
}

export function PendingInvite({ email, onRemove, className }: PendingInviteProps) {
  return (
    <div
      className={cn(
        "flex items-center gap-1.5 px-1.5 py-0.5 rounded bg-white/5 text-sm text-white/60 shrink-0 group",
        className
      )}
    >
      <div className="relative w-4 h-4 rounded-full bg-zinc-800 flex items-center justify-center shrink-0">
        <Mail className="w-2 h-2 text-white/60" />
        <div className="absolute -top-0.5 -right-0.5 w-1.5 h-1.5 rounded-full bg-amber-500/80" />
      </div>
      <span className="truncate max-w-[150px]">
        {email}
      </span>
      {onRemove && (
        <button
          onClick={(e) => {
            e.stopPropagation()
            onRemove()
          }}
          className="text-white/40 hover:text-white/60 transition-colors"
        >
          <X className="w-3 h-3" />
        </button>
      )}
    </div>
  )
}
````

## File: apps/app/src/components/chat/PlatformInviteMenu.tsx
````typescript
"use client"

import React from "react"
import { Mail, MessageSquare, Smartphone, MessagesSquare } from "lucide-react"
import { cn } from "@/lib/utils"

interface PlatformInviteMenuProps {
  isOpen: boolean
  onClose: () => void
  onSelect: (platform: string) => void
}

export function PlatformInviteMenu({
  isOpen,
  onClose,
  onSelect
}: PlatformInviteMenuProps) {
  const platforms = [
    {
      id: 'email',
      name: 'email invite',
      icon: Mail
    },
    {
      id: 'sms',
      name: 'sms import',
      icon: Smartphone,
      comingSoon: true
    },
    {
      id: 'slack',
      name: 'slack connect',
      icon: MessageSquare,
      comingSoon: true
    },
    {
      id: 'discord',
      name: 'discord link',
      icon: MessagesSquare,
      comingSoon: true
    }
  ]

  const handleSelect = (platformId: string) => {
    if (!platforms.find(p => p.id === platformId)?.comingSoon) {
      onSelect(platformId)
      onClose()
    }
  }

  return (
    <div className="bg-zinc-900/95 backdrop-blur-sm rounded-lg border border-white/5 overflow-hidden p-1.5 mb-2">
      {platforms.map((platform) => {
        const Icon = platform.icon
        return (
          <button
            key={platform.id}
            onClick={() => handleSelect(platform.id)}
            className={cn(
              "w-full flex items-center gap-3 px-2.5 h-7 rounded-md hover:bg-white/5 transition-colors group relative",
              platform.comingSoon && "opacity-50 cursor-not-allowed hover:bg-transparent"
            )}
          >
            <Icon className="w-3.5 h-3.5 text-white/60 group-hover:text-white/80 transition-colors" />
            <div className="text-sm text-white/80 font-extralight">
              {platform.name}
            </div>
            {platform.comingSoon && (
              <div className="ml-auto">
                <span className="text-[10px] font-medium text-white/80 bg-white/10 px-1.5 py-0.5 rounded">
                  soon
                </span>
              </div>
            )}
          </button>
        )
      })}
    </div>
  )
}
````

## File: apps/app/src/components/chat/SettingsModal.tsx
````typescript
"use client"

import React, { useState } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { createBrowserClient } from "@supabase/ssr"
import { User } from "@supabase/supabase-js"
import { 
  X, UserIcon, Keyboard, ChevronRight,
  Settings as SettingsIcon, Bell, Shield,
  Monitor, Palette
} from "lucide-react"
import { toast } from "sonner"
import { cn } from "@/lib/utils"
import { ProfileSettings } from "./settings/ProfileSettings"
import { ShortcutSettings } from "./settings/ShortcutSettings"

interface SettingsModalProps {
  user: User | null
  isOpen: boolean
  onClose: () => void
}

interface SettingsOption {
  id: string
  label: string
  icon: React.ComponentType<{ className?: string }>
  comingSoon?: boolean
}

interface ShortcutSetting {
  id: string
  label: string
  keys: string[]
}

const settingsOptions: SettingsOption[] = [
  { 
    id: 'profile', 
    label: 'profile', 
    icon: UserIcon
  },
  { 
    id: 'shortcuts', 
    label: 'keyboard shortcuts', 
    icon: Keyboard
  },
  { 
    id: 'appearance', 
    label: 'appearance', 
    icon: Palette,
    comingSoon: true
  },
  { 
    id: 'notifications', 
    label: 'notifications', 
    icon: Bell,
    comingSoon: true
  },
  { 
    id: 'privacy', 
    label: 'privacy & security', 
    icon: Shield,
    comingSoon: true
  },
  { 
    id: 'display', 
    label: 'display', 
    icon: Monitor,
    comingSoon: true
  }
]

const defaultShortcuts: ShortcutSetting[] = [
  {
    id: 'attach',
    label: 'attach menu',
    keys: ['‚åò', '0']
  },
  {
    id: 'mention',
    label: 'mentions menu',
    keys: ['‚åò', '1']
  },
  {
    id: 'reference',
    label: 'references menu',
    keys: ['‚åò', '2']
  },
  {
    id: 'command',
    label: 'commands menu',
    keys: ['‚åò', '3']
  }
]

export function SettingsModal({ user, isOpen, onClose }: SettingsModalProps) {
  const [activeSection, setActiveSection] = useState<string | null>(null)
  const [shortcuts, setShortcuts] = useState<ShortcutSetting[]>(defaultShortcuts)
  const [isLoading, setIsLoading] = useState(false)
  const [direction, setDirection] = useState<'forwards' | 'backwards'>('forwards')
  
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const handleSectionChange = (sectionId: string | null) => {
    setDirection(sectionId === null ? 'backwards' : 'forwards')
    setActiveSection(sectionId)
  }

  const handleSave = async () => {
    if (!user) return
    setIsLoading(true)

    try {
      const { error } = await supabase.auth.updateUser({
        data: { shortcuts }
      })

      if (error) throw error
      toast.success("settings updated")
      onClose()
    } catch (error) {
      console.error("Failed to update settings:", error)
      toast.error("failed to update settings")
    } finally {
      setIsLoading(false)
    }
  }

  const renderContent = () => {
    if (!activeSection) {
      return (
        <div className="space-y-1 py-1">
          {settingsOptions.map((option) => (
            <button
              key={option.id}
              onClick={() => !option.comingSoon && handleSectionChange(option.id)}
              disabled={option.comingSoon}
              className={cn(
                "w-full h-9 flex items-center gap-3 px-2.5 rounded-md transition-colors group relative",
                option.comingSoon 
                  ? "opacity-50 cursor-not-allowed"
                  : "hover:bg-white/5"
              )}
            >
              <option.icon className="h-4 w-4 text-white/40 group-hover:text-white/60" />
              <div className="flex-1 text-left">
                <div className="text-sm font-light text-white/80 group-hover:text-white/90">
                  {option.label}
                </div>
              </div>
              {option.comingSoon ? (
                <span className="text-[10px] font-medium text-white/60 bg-white/5 px-1.5 py-0.5 rounded">
                  soon
                </span>
              ) : (
                <ChevronRight className="h-4 w-4 text-white/20 group-hover:text-white/40" />
              )}
            </button>
          ))}
        </div>
      )
    }

    switch (activeSection) {
      case 'profile':
        return (
          <ProfileSettings 
            user={user} 
            onSave={handleSave}
          />
        )
      case 'shortcuts':
        return (
          <ShortcutSettings
            shortcuts={shortcuts}
            onShortcutChange={(id, keys) => {
              setShortcuts(shortcuts.map(s => 
                s.id === id ? { ...s, keys } : s
              ))
            }}
            onReset={() => setShortcuts(defaultShortcuts)}
          />
        )
      default:
        return null
    }
  }

  return (
    <AnimatePresence>
      {isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="absolute inset-0 bg-black/40 backdrop-blur-sm"
          />

          {/* Modal */}
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            transition={{ type: "spring", duration: 0.3 }}
            className="relative w-full max-w-sm h-[420px] flex flex-col overflow-hidden rounded-lg border border-white/5 bg-zinc-900/95 backdrop-blur-sm"
          >
            {/* Header */}
            <div className="flex-none flex items-center justify-between px-4 h-12 border-b border-white/5">
              <div className="flex items-center gap-3">
                <AnimatePresence mode="wait">
                  {activeSection ? (
                    <motion.button
                      key="back"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.15 }}
                      onClick={() => handleSectionChange(null)}
                      className="p-1 -ml-1 rounded-md text-white/40 hover:text-white/60 hover:bg-white/5"
                    >
                      <ChevronRight className="h-4 w-4 rotate-180" />
                    </motion.button>
                  ) : (
                    <motion.div
                      key="icon"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.15 }}
                    >
                      <SettingsIcon className="h-4 w-4 text-white/40" />
                    </motion.div>
                  )}
                </AnimatePresence>
                <AnimatePresence mode="wait">
                  <motion.span 
                    key={activeSection || 'main'}
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    transition={{ duration: 0.15 }}
                    className="text-sm font-light text-white/80"
                  >
                    {activeSection ? settingsOptions.find(o => o.id === activeSection)?.label : 'settings'}
                  </motion.span>
                </AnimatePresence>
              </div>
              <button
                onClick={onClose}
                className="rounded-full p-1 text-white/40 transition-colors hover:bg-white/5 hover:text-white/60"
              >
                <X className="h-4 w-4" />
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-hidden">
              <AnimatePresence mode="wait">
                <motion.div
                  key={activeSection || 'main'}
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ 
                    duration: 0.15,
                    ease: "easeInOut"
                  }}
                  className="h-full overflow-y-auto px-4 py-2"
                >
                  {renderContent()}
                </motion.div>
              </AnimatePresence>
            </div>

            {/* Footer */}
            <AnimatePresence>
              {activeSection && (
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: 10 }}
                  className="flex-none flex justify-end gap-3 border-t border-white/5 px-4 h-14 items-center"
                >
                  <button
                    onClick={() => handleSectionChange(null)}
                    className="rounded-lg px-4 py-2 text-sm font-light text-white/60 transition-colors hover:text-white/80"
                  >
                    cancel
                  </button>
                  <button
                    onClick={handleSave}
                    disabled={isLoading}
                    className="rounded-lg bg-white/5 px-4 py-2 text-sm font-light text-white/90 transition-colors hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-50"
                  >
                    {isLoading ? "saving..." : "save changes"}
                  </button>
                </motion.div>
              )}
            </AnimatePresence>
          </motion.div>
        </div>
      )}
    </AnimatePresence>
  )
}
````

## File: apps/app/src/components/chat/UserMenu.tsx
````typescript
"use client"

import React, { useState } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { useRouter } from "next/navigation"
import { createBrowserClient } from "@supabase/ssr"
import { User } from "@supabase/supabase-js"
import { Settings, LogOut, User as UserIcon, Keyboard } from "lucide-react"
import { cn } from "@/lib/utils"

interface UserMenuProps {
  user: User | null
  isOpen: boolean
  onClose: () => void
  onOpenSettings: () => void
}

interface SettingsSection {
  id: string
  label: string
  icon: React.ComponentType<{ className?: string }>
}

const settingsSections: SettingsSection[] = [
  { id: 'profile', label: 'Profile', icon: UserIcon },
  { id: 'shortcuts', label: 'Keyboard Shortcuts', icon: Keyboard }
]

export function UserMenu({ user, isOpen, onClose, onOpenSettings }: UserMenuProps) {
  const router = useRouter()
  const [activeSection, setActiveSection] = useState<string>('profile')
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const handleSignOut = async () => {
    await supabase.auth.signOut()
    router.push("/login")
  }

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Invisible overlay to handle clicks outside */}
          <div
            onClick={onClose}
            className="fixed inset-0 z-40"
          />

          {/* Menu */}
          <motion.div
            initial={{ opacity: 0, y: -4 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -4 }}
            transition={{ duration: 0.15 }}
            className="absolute top-full right-0 mt-2 z-50 w-64 rounded-lg border border-white/5 bg-zinc-900/95 backdrop-blur-sm p-1.5"
          >
            {/* User info */}
            <div className="mb-1 p-3 rounded-md border border-white/5">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-full bg-zinc-800 flex items-center justify-center">
                  {user?.user_metadata?.avatar_url ? (
                    <img
                      src={user.user_metadata.avatar_url}
                      alt={user.email || ""}
                      className="h-full w-full rounded-full object-cover"
                    />
                  ) : (
                    <UserIcon className="h-5 w-5 text-white/40" />
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="truncate text-sm font-light text-white/90">
                    {user?.user_metadata?.full_name || user?.email}
                  </div>
                  {user?.user_metadata?.full_name && (
                    <div className="truncate text-xs font-extralight text-white/40">
                      {user.email}
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Menu items */}
            <div className="space-y-1">
              <button
                onClick={() => {
                  onClose()
                  onOpenSettings()
                }}
                className="w-full h-9 flex items-center gap-3 px-2.5 rounded-md text-sm font-light text-white/80 transition-colors hover:bg-white/5"
              >
                <Settings className="h-4 w-4 text-white/40" />
                settings
              </button>
              <button
                onClick={handleSignOut}
                className="w-full h-9 flex items-center gap-3 px-2.5 rounded-md text-sm font-light text-white/80 transition-colors hover:bg-white/5"
              >
                <LogOut className="h-4 w-4 text-white/40" />
                sign out
              </button>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  )
}
````

## File: apps/app/src/components/email/InviteEmail.tsx
````typescript
import { Logo } from "@/components/ui/logo"

interface InviteEmailProps {
  inviterName: string
  inviteLink: string
}

export function InviteEmail({ inviterName, inviteLink }: InviteEmailProps) {
  return (
    <div className="bg-black min-h-screen py-12 px-4">
      <div className="max-w-md mx-auto">
        <div className="flex justify-center mb-8">
          <Logo size="lg" />
        </div>
        
        <div className="space-y-6 text-center">
          <h1 className="text-2xl font-light text-white/90">
            {inviterName} invited you to chat on enso
          </h1>
          
          <p className="text-base text-white/60 font-extralight">
            Join the conversation in a minimal, intelligent chat experience.
          </p>

          <div className="relative">
            <div className="absolute inset-[-1px] rounded-lg bg-gradient-to-r from-[#178bf1]/20 via-transparent to-[#178bf1]/20 blur-lg" />
            <a
              href={inviteLink}
              className="relative block w-full py-3 px-4 bg-zinc-900/90 backdrop-blur-sm rounded-lg border border-white/10 text-white/80 font-light text-center hover:bg-zinc-900/70 transition-colors"
            >
              Join Chat
            </a>
          </div>

          <p className="text-sm text-white/40 font-extralight">
            or copy this link:
            <br />
            <span className="text-white/60">{inviteLink}</span>
          </p>
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/ui/avatar-button.tsx
````typescript
"use client"

import React from "react"
import { cn } from "@/lib/utils"
import { getChatGradient } from "@/lib/utils/colors"
import Link from "next/link"

interface AvatarButtonProps {
  // Core props
  id: string // Used for gradient and navigation
  href?: string // Optional - if provided, wraps in Link
  size?: 'sm' | 'md' | 'lg' // sm = 32px, md = 40px, lg = 64px
  className?: string
  onClick?: () => void
  // Optional image
  imageSrc?: string | null
  // Optional label (shown below avatar in vertical layout)
  label?: string
  // Visual options
  showRing?: boolean
  isInteractive?: boolean
  // Layout options
  vertical?: boolean
}

export function AvatarButton({
  id,
  href,
  size = 'md',
  className,
  onClick,
  imageSrc,
  label,
  showRing = true,
  isInteractive = true,
  vertical = false,
}: AvatarButtonProps) {
  // Size classes
  const sizeClasses = {
    sm: "w-8 h-8",
    md: "w-10 h-10",
    lg: "w-16 h-16"
  }

  // Label size classes
  const labelSizeClasses = {
    sm: "text-xs",
    md: "text-sm",
    lg: "text-xs"
  }

  const avatar = (
    <div className={cn(
      "rounded-full flex items-center justify-center",
      "bg-gradient-to-br shadow-lg",
      isInteractive && "transition-all duration-200",
      isInteractive && "group-hover:ring-2 ring-white/10",
      isInteractive && "group-hover:shadow-xl",
      sizeClasses[size],
      getChatGradient(id),
      className
    )}>
      {imageSrc && (
        <img 
          src={imageSrc} 
          alt="" 
          className="w-full h-full rounded-full object-cover"
        />
      )}
    </div>
  )

  const content = label ? (
    <div className={cn(
      "group flex items-center gap-3",
      vertical && "flex-col items-center gap-1.5"
    )}>
      {avatar}
      {label && (
        <span className={cn(
          "font-light text-white/80 truncate",
          labelSizeClasses[size],
          vertical && "max-w-[80px]"
        )}>
          {label}
        </span>
      )}
    </div>
  ) : avatar

  if (href) {
    return (
      <Link href={href} className="group">
        {content}
      </Link>
    )
  }

  if (onClick) {
    return (
      <button onClick={onClick} className="group">
        {content}
      </button>
    )
  }

  return content
}
````

## File: apps/app/src/components/ui/border-glow-button.tsx
````typescript
"use client"

import React from "react"
import { StarBorder } from "./star-border"
import { cn } from "@/lib/utils"

interface BorderGlowButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode
  glowColor?: string
  borderGlowColor?: string
  className?: string
  asChild?: boolean
}

export function BorderGlowButton({
  children,
  glowColor = "rgba(139, 92, 246, 0.25)",
  borderGlowColor = "rgba(255, 255, 255, 0.2)",
  className,
  asChild,
  ...props
}: BorderGlowButtonProps) {
  return (
    <StarBorder
      as={asChild ? "div" : "button"}
      color={glowColor}
      className={cn(
        "relative overflow-hidden rounded-lg",
        "transition-colors duration-200",
        className
      )}
      {...props}
    >
      {children}
    </StarBorder>
  )
}
````

## File: apps/app/src/components/ui/button.tsx
````typescript
import * as React from "react"
import { cn } from "@/lib/utils"

export interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: "default" | "ghost"
  size?: "default" | "icon"
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant = "default", size = "default", ...props }, ref) => {
    return (
      <button
        className={cn(
          "inline-flex items-center justify-center rounded-lg font-light transition-colors",
          "focus:outline-none focus:ring-0 disabled:pointer-events-none disabled:opacity-50",
          {
            "bg-zinc-900/50 border border-white/5 text-white/80 hover:bg-zinc-900/70":
              variant === "default",
            "text-white/60 hover:text-white/80 hover:bg-white/5": variant === "ghost",
            "h-10 px-4 py-2": size === "default",
            "h-10 w-10": size === "icon",
          },
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button }
````

## File: apps/app/src/components/ui/card.tsx
````typescript
import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border border-white/[0.02] bg-white/[0.01] text-white/90 backdrop-blur-[2px]",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

export { Card }
````

## File: apps/app/src/components/ui/collapsible.tsx
````typescript
"use client"

import * as React from "react"
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"
import { cn } from "@/lib/utils"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = React.forwardRef<
  React.ElementRef<typeof CollapsiblePrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof CollapsiblePrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <CollapsiblePrimitive.Content
    ref={ref}
    className={cn(
      "data-[state=closed]:animate-collapsible-up data-[state=open]:animate-collapsible-down",
      className
    )}
    {...props}
  >
    {children}
  </CollapsiblePrimitive.Content>
))
CollapsibleContent.displayName = CollapsiblePrimitive.Content.displayName

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
````

## File: apps/app/src/components/ui/command-hints.tsx
````typescript
"use client"

import { motion, AnimatePresence } from "framer-motion"
import { cn } from "@/lib/utils"

interface Command {
  key: string
  description: string
}

interface CommandHintsProps {
  show: boolean
  commands: Command[]
  className?: string
}

export function CommandHints({ show, commands, className }: CommandHintsProps) {
  return (
    <AnimatePresence>
      {show && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -10 }}
          transition={{ duration: 0.15 }}
          className={cn(
            "fixed bottom-8 left-1/2 -translate-x-1/2 z-50",
            "bg-zinc-900/95 border border-white/10 rounded-lg shadow-lg backdrop-blur-sm",
            "p-2 flex gap-3",
            className
          )}
        >
          {commands.map((cmd) => (
            <div key={cmd.key} className="flex items-center gap-2">
              <kbd className="px-1.5 py-0.5 text-xs font-mono bg-white/5 rounded text-white/60">
                {cmd.key}
              </kbd>
              <span className="text-sm font-light text-white/60">
                {cmd.description}
              </span>
            </div>
          ))}
        </motion.div>
      )}
    </AnimatePresence>
  )
}
````

## File: apps/app/src/components/ui/command.tsx
````typescript
"use client"

import * as React from "react"
import { DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"
import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-lg",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

interface CommandDialogProps {
  children: React.ReactNode
  open: boolean
  onOpenChange: (open: boolean) => void
}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-white/40">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b border-white/5 px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 text-white/40" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-white/40",
        "disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))
CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))
CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm text-white/40"
    {...props}
  />
))
CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5",
      "[&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-light [&_[cmdk-group-heading]]:text-white/40",
      className
    )}
    {...props}
  />
))
CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-white/5", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-md px-2 py-1.5 text-sm outline-none",
      "aria-selected:bg-white/5 aria-selected:text-white/90 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      "transition-colors",
      className
    )}
    {...props}
  />
))
CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-white/40",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
````

## File: apps/app/src/components/ui/dialog.tsx
````typescript
import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogPrimitive.Overlay className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0" />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 translate-x-[-50%] translate-y-[-50%]",
        "w-full max-w-lg rounded-lg border border-white/5 bg-zinc-900 shadow-lg",
        "data-[state=open]:animate-in data-[state=closed]:animate-out",
        "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
        "data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%]",
        "data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
        className
      )}
      {...props}
    >
      {children}
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

export {
  Dialog,
  DialogTrigger,
  DialogContent,
  DialogPortal,
}
````

## File: apps/app/src/components/ui/dropdown-menu.tsx
````typescript
import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border border-white/5 bg-zinc-900/95 p-1",
        "data-[state=open]:animate-in data-[state=closed]:animate-out",
        "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
        "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
        "data-[side=bottom]:slide-in-from-top-2",
        "data-[side=left]:slide-in-from-right-2",
        "data-[side=right]:slide-in-from-left-2",
        "data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none",
      "transition-colors focus:bg-white/5 focus:text-white data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-white/5", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
}
````

## File: apps/app/src/components/ui/follow-cursor.tsx
````typescript
"use client"

import { useRef } from "react"
import { motion, useMotionValue, useSpring } from "framer-motion"
import { cn } from "@/lib/utils"

interface FollowCursorProps {
  children: React.ReactNode
  className?: string
  springConfig?: { stiffness: number; damping: number }
}

export function FollowCursor({
  children,
  className,
  springConfig = { stiffness: 1000, damping: 50 },
}: FollowCursorProps) {
  const containerRef = useRef<HTMLDivElement>(null)

  // Motion values for cursor following
  const x = useMotionValue(0)
  const y = useMotionValue(0)
  
  // Smooth spring animations for position
  const springX = useSpring(x, springConfig)
  const springY = useSpring(y, springConfig)

  const handleMouseMove = (event: React.MouseEvent<HTMLDivElement>) => {
    if (!containerRef.current) return

    const rect = containerRef.current.getBoundingClientRect()
    
    // Calculate position relative to container with a slight offset correction
    const offsetX = event.clientX - rect.left - 70
    const offsetY = event.clientY - rect.top - 70
    
    x.set(offsetX)
    y.set(offsetY)
  }

  return (
    <div 
      ref={containerRef}
      className={cn("absolute inset-0", className)}
      onMouseMove={handleMouseMove}
      onMouseEnter={handleMouseMove}
    >
      <motion.div
        style={{
          position: "absolute",
          pointerEvents: "none",
          x: springX,
          y: springY,
          transform: "translate(-50%, -50%)",
          margin: 0,
          padding: 0,
        }}
      >
        {children}
      </motion.div>
    </div>
  )
}
````

## File: apps/app/src/components/ui/footer.tsx
````typescript
"use client"

import React from "react"
import Link from "next/link"
import { Logo } from "@/components/ui/logo"
import { cn } from "@/lib/utils"

interface FooterProps {
  className?: string
}

export function Footer({ className }: FooterProps) {
  return (
    <footer className={cn("border-t border-white/5 bg-black/20 backdrop-blur-sm", className)}>
      <div className="max-w-6xl mx-auto px-8 py-16">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 md:gap-8">
          {/* Brand */}
          <div className="space-y-4">
            <Logo size="sm" />
            <p className="text-sm font-extralight text-white/40">
              ambient intelligence for chat 
            </p>
          </div>

          {/* Links */}
          <div className="space-y-4">
            <h4 className="text-sm font-light text-white/60">product</h4>
            <ul className="space-y-2">
              <li>
                <Link href="/features" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  features
                </Link>
              </li>
              <li>
                <Link href="/pricing" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  pricing
                </Link>
              </li>
              <li>
                <Link href="/about" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  about
                </Link>
              </li>
              <li>
                <Link href="/blog" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  blog
                </Link>
              </li>
            </ul>
          </div>

          <div className="space-y-4">
            <h4 className="text-sm font-light text-white/60">legal</h4>
            <ul className="space-y-2">
              <li>
                <Link href="/privacy" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  privacy
                </Link>
              </li>
              <li>
                <Link href="/terms" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  terms
                </Link>
              </li>
            </ul>
          </div>

          <div className="space-y-4">
            <h4 className="text-sm font-light text-white/60">connect</h4>
            <ul className="space-y-2">
              <li>
                <a href="https://twitter.com/enso_chat" target="_blank" rel="noopener noreferrer" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  twitter
                </a>
              </li>
              <li>
                <a href="https://github.com/enso-org" target="_blank" rel="noopener noreferrer" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  github
                </a>
              </li>
              <li>
                <a href="mailto:hello@enso.chat" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  email
                </a>
              </li>
            </ul>
          </div>
        </div>

        {/* Copyright */}
        <div className="mt-16 pt-8 border-t border-white/5">
          <p className="text-sm font-extralight text-white/40">
            ¬© 2024 enso. all rights reserved.
          </p>
        </div>
      </div>
    </footer>
  )
}
````

## File: apps/app/src/components/ui/glow-button.tsx
````typescript
"use client"

import React from "react"
import { cn } from "@/lib/utils"
import { useGlowEffect } from "@/hooks/useGlowEffect"

interface GlowButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode
  className?: string
  glowColor?: string
}

export function GlowButton({ 
  children, 
  className,
  glowColor = "var(--blue-primary)",
  ...props 
}: GlowButtonProps) {
  const { containerRef, overlayRef } = useGlowEffect()

  const Comp = 'button'

  return (
    <div ref={containerRef} className="relative glow-capture">
      {/* Glow background */}
      <div className="absolute -inset-[1px] rounded-lg bg-gradient-to-r from-[var(--blue-primary)] to-transparent opacity-0 group-hover:opacity-100 blur transition-all duration-300" />
      
      {/* Button content */}
      <Comp
        className={cn(
          "relative rounded-lg border border-white/10 px-8 py-3",
          "text-lg font-extralight text-[var(--white-90)]",
          "bg-white/5 backdrop-blur-sm",
          "hover:bg-white/10 hover:border-[var(--blue-primary)]/50",
          "group transition-all duration-300",
          "glow glow:ring-1 glow:border-glow glow:ring-glow glow:bg-glow/[.15]",
          className
        )}
        style={{ "--glow-color": glowColor } as React.CSSProperties}
        type="button"
        {...props}
      >
        {children}
      </Comp>

      {/* Mouse tracking overlay */}
      <div 
        ref={overlayRef}
        className="glow-overlay"
        style={{ 
          "--glow-color": glowColor,
          "--glow-size": "20rem"
        } as React.CSSProperties}
      />
    </div>
  )
}
````

## File: apps/app/src/components/ui/header.tsx
````typescript
"use client"

import React from "react"
import Link from "next/link"
import { useRouter } from "next/navigation"
import { Logo } from "@/components/ui/logo"
import { MagneticGlowButton } from "@/components/ui/magnetic-glow-button"
import { cn } from "@/lib/utils"

interface HeaderProps {
  className?: string
}

export function Header({ className }: HeaderProps) {
  const router = useRouter()

  return (
    <header className={cn(
      "fixed top-0 left-0 right-0 z-50",
      "h-24 flex items-center",
      "border-b border-white/[0.08]",
      "bg-black/[0.65] backdrop-blur-[12px] backdrop-saturate-[1.8]",
      "supports-[backdrop-filter]:bg-black/[0.65]",
      "supports-[backdrop-filter]:backdrop-blur-[12px]",
      className
    )}>
      {/* Content container with max width */}
      <div className="w-full max-w-[1400px] mx-auto px-8 md:px-12 lg:px-16 flex items-center justify-between">
        {/* Brand */}
        <div className="flex items-center gap-12">
          <Link href="/" className="group">
            <h1 className="text-xl tracking-tight">
              <span className="font-extralight tracking-[-0.05em] text-white/40 group-hover:text-white/60 transition-colors">en</span>
              <span className="font-light text-white/60 group-hover:text-white/90 transition-colors">so</span>
            </h1>
          </Link>
          
          {/* Primary Nav - Hidden on mobile, fades in on lg breakpoint */}
          <nav className="hidden lg:flex items-center gap-8 opacity-0 lg:opacity-100 transition-opacity duration-300">
            <Link href="/features" className="text-lg text-white/40 hover:text-white/60 transition-colors font-extralight">
              features
            </Link>
            <Link href="/pricing" className="text-lg text-white/40 hover:text-white/60 transition-colors font-extralight">
              pricing
            </Link>
            <Link href="/about" className="text-lg text-white/40 hover:text-white/60 transition-colors font-extralight">
              about
            </Link>
            <Link href="/blog" className="text-lg text-white/40 hover:text-white/60 transition-colors font-extralight">
              blog
            </Link>
          </nav>
        </div>

        {/* Auth actions - Show on all screen sizes but adjust size for mobile */}
        <div className="flex items-center gap-2 lg:gap-4">
          <MagneticGlowButton
            onClick={() => router.push("/chat")}
            glowColor="rgba(23, 139, 241, 0.15)"
            magneticPull={0.15}
            glowSize={120}
            className={cn(
              "transition-all duration-300",
              "text-sm font-light text-white/80 hover:text-white/90",
              "bg-[#178bf1]/5 hover:bg-[#178bf1]/10",
              "border border-white/[0.08]",
              // Mobile styles
              "px-4 py-1.5 min-w-[90px]",
              // Desktop styles
              "lg:px-6 lg:py-2 lg:min-w-[120px]"
            )}
          >
            sign in
          </MagneticGlowButton>
        </div>
      </div>
    </header>
  )
}
````

## File: apps/app/src/components/ui/input.tsx
````typescript
import * as React from "react"
import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.InputHTMLAttributes<HTMLInputElement>>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-lg border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
````

## File: apps/app/src/components/ui/label.tsx
````typescript
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
````

## File: apps/app/src/components/ui/logo-card.tsx
````typescript
"use client"

import React, { useState, useEffect } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { cn } from "@/lib/utils"
import { FollowCursor } from "./follow-cursor"
import { Logo } from "./logo"

interface LogoCardProps {
  className?: string
}

export function LogoCard({ className }: LogoCardProps) {
  const [isHovered, setIsHovered] = useState(false)
  const [isTouchDevice, setIsTouchDevice] = useState(false)

  // Detect touch device on mount
  useEffect(() => {
    setIsTouchDevice('ontouchstart' in window || navigator.maxTouchPoints > 0)
  }, [])

  return (
    <div 
      className={cn(
        "relative w-full h-full rounded-lg",
        "transition-colors duration-200",
        "hover:bg-white/[0.07]",
        className
      )}
      onMouseEnter={() => !isTouchDevice && setIsHovered(true)}
      onMouseLeave={() => !isTouchDevice && setIsHovered(false)}
      onTouchStart={() => isTouchDevice && setIsHovered(true)}
      onTouchEnd={() => isTouchDevice && setIsHovered(false)}
    >
      {isTouchDevice ? (
        // For touch devices: centered logo with fade animation
        <AnimatePresence>
          {isHovered && (
            <motion.div
              initial={{ opacity: 0, scale: 0.8 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.8 }}
              transition={{ duration: 0.2 }}
              className="absolute inset-0 flex items-center justify-center"
            >
              <Logo className="w-10 h-10" />
            </motion.div>
          )}
        </AnimatePresence>
      ) : (
        // For mouse devices: cursor following behavior
        <FollowCursor>
          <AnimatePresence>
            {isHovered && (
              <motion.div
                initial={{ opacity: 0, scale: 0.8 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.8 }}
                transition={{ duration: 0.2 }}
                className="flex items-center justify-center"
              >
                <Logo className="w-10 h-10" />
              </motion.div>
            )}
          </AnimatePresence>
        </FollowCursor>
      )}
    </div>
  )
}
````

## File: apps/app/src/components/ui/logo.tsx
````typescript
"use client"

import React from "react"
import Image from "next/image"
import { cn } from "@/lib/utils"

interface LogoProps {
  size?: "sm" | "lg"
  className?: string
}

export function Logo({ size = "lg", className }: LogoProps) {
  const dimensions = {
    sm: 24,
    lg: 128
  }

  const dim = dimensions[size]

  return (
    <div className={cn("relative inline-block group", className)}>
      {/* Glow effects container */}
      <div className="absolute inset-0 rounded-full">
        <div className="absolute inset-[-2px] rounded-full bg-[#178bf1]/10 blur-xl group-hover:blur-2xl transition-all duration-500" />
      </div>

      {/* Logo container */}
      <div className={cn("relative transform-gpu", size === "sm" ? "w-6 h-6" : "w-32 h-32")}>
        {/* Background layer with ripple */}
        <div className="absolute inset-0 overflow-hidden rounded-full">
          <Image
            src="/logo.svg"
            alt="Enso Logo"
            width={dim}
            height={dim}
            className="transform-gpu opacity-50 group-hover:scale-105 transition-transform duration-500"
            style={{ 
              filter: "drop-shadow(0 0 20px rgba(23,139,241,0.4))",
              transform: "translate3d(0,0,0)",
              width: "auto",
              height: "auto"
            }}
          />
          <div className="absolute inset-0 bg-gradient-to-r from-[#178bf1]/10 via-transparent to-[#178bf1]/10 group-hover:opacity-100 opacity-0 transition-opacity duration-500 mix-blend-overlay" />
        </div>

        {/* Foreground layer */}
        <div className="relative w-full h-full overflow-hidden rounded-full">
          <Image
            src="/logo.svg"
            alt="Enso Logo"
            width={dim}
            height={dim}
            style={{
              width: "auto",
              height: "auto"
            }}
          />
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(23,139,241,0)_30%,rgba(23,139,241,0.15)_70%)] opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
        </div>
      </div>
    </div>
  )
}
````

## File: apps/app/src/components/ui/magnetic-button.tsx
````typescript
"use client"

import React from "react"
import { cn } from "@/lib/utils"

interface MagneticButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode
  className?: string
}

export function MagneticButton({ 
  children, 
  className = "",
  ...props 
}: MagneticButtonProps) {
  return (
    <button
      className={cn("group relative inline-flex items-center justify-center", className)}
      {...props}
    >
      <div className="absolute inset-0 rounded-lg bg-gradient-to-r from-white/10 to-white/5 backdrop-blur transform group-hover:scale-[1.02] transition-all duration-300 ease-out origin-center" />
      <div className="absolute -inset-0.5 rounded-lg opacity-0 group-hover:opacity-20 bg-gradient-to-r from-white to-transparent blur-md transition-all duration-300" />
      <span className="relative px-12 py-4 text-sm tracking-widest text-white/80 group-hover:text-white transition-colors uppercase font-extralight">
        {children}
      </span>
    </button>
  )
}
````

## File: apps/app/src/components/ui/magnetic-glow-button.tsx
````typescript
"use client"

import React, { useRef, useState } from "react"
import { motion } from "framer-motion"
import { cn } from "@/lib/utils"

interface MagneticGlowButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode
  glowColor?: string
  magneticPull?: number
  glowSize?: number
  className?: string
}

export function MagneticGlowButton({
  children,
  glowColor = "rgba(139, 92, 246, 0.25)", // Default violet glow
  magneticPull = 0.2,
  glowSize = 200,
  className,
  ...props
}: MagneticGlowButtonProps) {
  const buttonRef = useRef<HTMLButtonElement>(null)
  const [glowPosition, setGlowPosition] = useState({ x: 0, y: 0 })
  const [isHovered, setIsHovered] = useState(false)

  const handleMouseMove = (e: React.MouseEvent<HTMLButtonElement>) => {
    if (!buttonRef.current) return

    const rect = buttonRef.current.getBoundingClientRect()
    
    // Calculate glow position relative to button
    const glowX = ((e.clientX - rect.left) / rect.width) * 100
    const glowY = ((e.clientY - rect.top) / rect.height) * 100
    setGlowPosition({ x: glowX, y: glowY })
  }

  const handleMouseLeave = () => {
    setIsHovered(false)
  }

  const handleMouseEnter = () => {
    setIsHovered(true)
  }

  return (
    <button
      ref={buttonRef}
      className={cn(
        "relative overflow-hidden rounded-lg bg-black",
        "transition-colors duration-200",
        className
      )}
      onMouseMove={handleMouseMove}
      onMouseLeave={handleMouseLeave}
      onMouseEnter={handleMouseEnter}
      {...props}
    >
      {/* Glow effect */}
      <motion.div
        className="absolute pointer-events-none"
        animate={{
          opacity: isHovered ? 1 : 0,
          scale: isHovered ? 1 : 0.5,
        }}
        transition={{
          duration: 0.2
        }}
        style={{
          width: glowSize,
          height: glowSize,
          borderRadius: "50%",
          background: `radial-gradient(circle at center, ${glowColor} 0%, transparent 70%)`,
          left: `calc(${glowPosition.x}% - ${glowSize / 2}px)`,
          top: `calc(${glowPosition.y}% - ${glowSize / 2}px)`,
        }}
      />

      {/* Button content */}
      <div className="relative z-10">
        {children}
      </div>
    </button>
  )
}
````

## File: apps/app/src/components/ui/markdown.tsx
````typescript
"use client"

import { useMemo } from "react"
import ReactMarkdown from "react-markdown"
import { Prism as SyntaxHighlighter } from "react-syntax-highlighter"
import { oneDark } from "react-syntax-highlighter/dist/esm/styles/prism"
import remarkGfm from "remark-gfm"
import remarkMath from "remark-math"
import rehypeKatex from "rehype-katex"
import "katex/dist/katex.min.css"

interface MarkdownProps {
  content: string
}

export function Markdown({ content }: MarkdownProps) {
  const components = useMemo(
    () => ({
      code({ node, inline, className, children, ...props }: any) {
        const match = /language-(\w+)/.exec(className || "")
        const language = match ? match[1] : "typescript"

        return !inline ? (
          <div className="relative rounded-md">
            <div className="absolute right-2 top-2 z-10 text-xs text-muted-foreground">
              {language}
            </div>
            <SyntaxHighlighter
              {...props}
              style={oneDark}
              language={language}
              PreTag="div"
              customStyle={{
                margin: 0,
                borderRadius: "0.375rem",
                background: "hsl(var(--muted))",
              }}
            >
              {String(children).replace(/\n$/, "")}
            </SyntaxHighlighter>
          </div>
        ) : (
          <code className="rounded bg-muted px-1 py-0.5" {...props}>
            {children}
          </code>
        )
      },
      p({ children }: any) {
        return <p className="mb-4 last:mb-0">{children}</p>
      },
      a({ children, href }: any) {
        return (
          <a
            href={href}
            target="_blank"
            rel="noopener noreferrer"
            className="text-primary underline-offset-4 hover:underline"
          >
            {children}
          </a>
        )
      },
      ul({ children }: any) {
        return <ul className="mb-4 list-disc pl-6 last:mb-0">{children}</ul>
      },
      ol({ children }: any) {
        return <ol className="mb-4 list-decimal pl-6 last:mb-0">{children}</ol>
      },
      li({ children }: any) {
        return <li className="mb-2 last:mb-0">{children}</li>
      },
      h1({ children }: any) {
        return <h1 className="mb-4 text-2xl font-bold">{children}</h1>
      },
      h2({ children }: any) {
        return <h2 className="mb-4 text-xl font-bold">{children}</h2>
      },
      h3({ children }: any) {
        return <h3 className="mb-4 text-lg font-bold">{children}</h3>
      },
      blockquote({ children }: any) {
        return (
          <blockquote className="mb-4 border-l-2 pl-4 italic">
            {children}
          </blockquote>
        )
      },
      table({ children }: any) {
        return (
          <div className="mb-4 overflow-x-auto">
            <table className="w-full border-collapse">{children}</table>
          </div>
        )
      },
      th({ children }: any) {
        return (
          <th className="border border-border bg-muted p-2 text-left">
            {children}
          </th>
        )
      },
      td({ children }: any) {
        return <td className="border border-border p-2">{children}</td>
      },
    }),
    []
  )

  return (
    <ReactMarkdown
      remarkPlugins={[remarkGfm, remarkMath]}
      rehypePlugins={[rehypeKatex]}
      components={components}
      className="prose prose-sm dark:prose-invert max-w-none"
    >
      {content}
    </ReactMarkdown>
  )
}
````

## File: apps/app/src/components/ui/mobile-nav-dock.tsx
````typescript
"use client"

import Link from "next/link"
import { usePathname } from "next/navigation"
import { cn } from "@/lib/utils"

interface MobileNavDockProps {
  className?: string
}

export function MobileNavDock({ className }: MobileNavDockProps) {
  const pathname = usePathname()

  // Don't show the dock in the chat app
  if (pathname.startsWith('/chat')) {
    return null
  }

  const links = [
    { href: '/features', label: 'features' },
    { href: '/pricing', label: 'pricing' },
    { href: '/about', label: 'about' },
    { href: '/blog', label: 'blog' }
  ]

  return (
    <nav className={cn(
      "fixed bottom-0 left-0 right-0 z-50 px-4 pb-4",
      "lg:opacity-0 lg:pointer-events-none opacity-100 transition-opacity duration-300",
      className
    )}>
      <div className={cn(
        "flex items-center justify-center gap-1",
        "px-1.5 py-1.5 rounded-xl",
        "bg-black/[0.65] backdrop-blur-[12px] backdrop-saturate-[1.8]",
        "border border-white/[0.08]",
        "shadow-lg shadow-black/25",
        "max-w-[320px] mx-auto w-full",
        "transform transition-transform duration-300",
        "lg:translate-y-4 translate-y-0"
      )}>
        {links.map(({ href, label }) => (
          <Link
            key={href}
            href={href}
            className={cn(
              "px-2.5 py-1.5 rounded-lg text-sm font-extralight transition-colors flex-1 text-center",
              "hover:bg-white/5",
              pathname === href 
                ? "text-white/90 bg-white/5" 
                : "text-white/40 hover:text-white/60"
            )}
          >
            {label}
          </Link>
        ))}
      </div>
    </nav>
  )
}
````

## File: apps/app/src/components/ui/popover.tsx
````typescript
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"
import { cn } from "@/lib/utils"
import type { PopoverProps } from '@radix-ui/react-popover'

const Popover = React.forwardRef<HTMLDivElement, PopoverProps>(
  (props, _ref) => <PopoverPrimitive.Root {...props} />
)
Popover.displayName = PopoverPrimitive.Root.displayName

const PopoverTrigger = React.forwardRef<
  HTMLButtonElement,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Trigger>
>((props, ref) => <PopoverPrimitive.Trigger {...props} ref={ref} />)
PopoverTrigger.displayName = PopoverPrimitive.Trigger.displayName

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => {
  const [mounted, setMounted] = React.useState(false)

  React.useEffect(() => {
    setMounted(true)
    return () => setMounted(false)
  }, [])

  if (!mounted) return null

  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        ref={ref}
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "z-50 w-72 rounded-lg border border-white/5 bg-zinc-900/95 backdrop-blur-sm p-4 shadow-md outline-none",
          "data-[state=open]:animate-in data-[state=closed]:animate-out",
          "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
          "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2",
          "data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  )
})
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
````

## File: apps/app/src/components/ui/progress.tsx
````typescript
import * as ProgressPrimitive from "@radix-ui/react-progress"
import { cn } from "@/lib/utils"

export const Progress = ({
  value, 
  className,
  glowColor = 'rgba(255,255,255,0.2)'
}: {
  value: number
  className?: string
  glowColor?: string
}) => (
  <ProgressPrimitive.Root
    className={cn(
      "relative h-1 w-full overflow-hidden rounded-full bg-white/5",
      className
    )}
    style={{
      boxShadow: `0 0 8px ${glowColor}`
    }}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full bg-gradient-to-r from-[var(--blue-primary)] to-[var(--purple-primary)] transition-all duration-300"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
)
````

## File: apps/app/src/components/ui/scroll-area.tsx
````typescript
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root> & {
    orientation?: "vertical" | "horizontal"
  }
>(({ className, children, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar orientation={orientation} />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-white/10" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
````

## File: apps/app/src/components/ui/shared-footer.tsx
````typescript
"use client"

import React, { useState } from "react"
import Link from "next/link"
import { Logo } from "@/components/ui/logo"
import { cn } from "@/lib/utils"
import { ArrowRight } from "lucide-react"
import { toast } from "sonner"

interface SharedFooterProps {
  className?: string
  showNewsletter?: boolean
}

export function SharedFooter({ className, showNewsletter = true }: SharedFooterProps) {
  const [email, setEmail] = useState("")

  const handleSubscribe = async (e: React.FormEvent) => {
    e.preventDefault()
    
    try {
      // TODO: Implement newsletter subscription
      toast.success("Thanks for subscribing!")
      setEmail("")
    } catch (error) {
      toast.error("Failed to subscribe. Please try again.")
    }
  }

  return (
    <footer className={cn("border-t border-white/5 bg-black/20 backdrop-blur-sm", className)}>
      {showNewsletter && (
        <div className="w-full max-w-[1400px] mx-auto px-8 md:px-12 lg:px-16 py-8 flex flex-col md:flex-row items-center justify-between gap-12 border-t border-b border-white/5">
          {/* Newsletter */}
          <div className="flex-1 w-full">
            <h3 className="text-2xl font-light text-white/60 mb-4">join our newsletter</h3>
            <div className="flex gap-6 max-w-md">
              <input 
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="email address" 
                className="flex-1 bg-transparent border-b-2 border-white/20 py-3 text-xl text-white/60 placeholder:text-white/40 focus:outline-none focus:border-white/40"
              />
              <button 
                onClick={handleSubscribe}
                className="text-xl text-white/60 hover:text-white/80 transition-colors flex items-center gap-3"
              >
                join
                <ArrowRight className="w-5 h-5" />
              </button>
            </div>
          </div>

          {/* CTA */}
          <Link 
            href="/chat" 
            className="text-xl text-white/60 hover:text-white/80 transition-colors flex items-center gap-3 group"
          >
            chat now
            <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
          </Link>
        </div>
      )}

      <div className="max-w-6xl mx-auto px-8 py-16">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 md:gap-8">
          {/* Brand */}
          <div className="space-y-4">
            <Logo size="sm" />
            <p className="text-sm font-extralight text-white/40">
              ambient intelligence for chat 
            </p>
          </div>

          {/* Links */}
          <div className="space-y-4">
            <h4 className="text-sm font-light text-white/60">product</h4>
            <ul className="space-y-2">
              <li>
                <Link href="/features" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  features
                </Link>
              </li>
              <li>
                <Link href="/pricing" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  pricing
                </Link>
              </li>
              <li>
                <Link href="/about" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  about
                </Link>
              </li>
              <li>
                <Link href="/blog" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  blog
                </Link>
              </li>
            </ul>
          </div>

          <div className="space-y-4">
            <h4 className="text-sm font-light text-white/60">legal</h4>
            <ul className="space-y-2">
              <li>
                <Link href="/privacy" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  privacy
                </Link>
              </li>
              <li>
                <Link href="/terms" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  terms
                </Link>
              </li>
            </ul>
          </div>

          <div className="space-y-4">
            <h4 className="text-sm font-light text-white/60">connect</h4>
            <ul className="space-y-2">
              <li>
                <a href="https://twitter.com/enso_chat" target="_blank" rel="noopener noreferrer" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  twitter
                </a>
              </li>
              <li>
                <a href="https://github.com/enso-org" target="_blank" rel="noopener noreferrer" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  github
                </a>
              </li>
              <li>
                <a href="mailto:hello@enso.chat" className="text-sm font-extralight text-white/40 hover:text-white/60 transition-colors">
                  email
                </a>
              </li>
            </ul>
          </div>

          <div className="flex flex-col gap-2">
          <p className="text-sm font-extralight text-white/40">
            ¬© 2025 enso.
          </p>
          <p className="text-sm font-extralight text-white/40">
            all rights reserved.
          </p>
          </div>
        </div>
      </div>
    </footer>
  )
}
````

## File: apps/app/src/components/ui/shortcut-dialog.tsx
````typescript
"use client"

import * as React from "react"
import * as Dialog from "@radix-ui/react-dialog"
import { motion, AnimatePresence } from "framer-motion"
import { X } from "lucide-react"
import { cn } from "@/lib/utils"

interface ShortcutDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSave: (keys: string[]) => void
  currentKeys: string[]
}

export function ShortcutDialog({ 
  open, 
  onOpenChange,
  onSave,
  currentKeys 
}: ShortcutDialogProps) {
  const [recordedKeys, setRecordedKeys] = React.useState<string[]>(currentKeys)
  const [isRecording, setIsRecording] = React.useState(false)

  const handleKeyDown = React.useCallback((e: KeyboardEvent) => {
    if (!isRecording) return
    e.preventDefault()

    const keys: string[] = []
    if (e.metaKey) keys.push('‚åò')
    if (e.ctrlKey) keys.push('ctrl')
    if (e.altKey) keys.push('alt')
    if (e.shiftKey) keys.push('shift')
    
    // Add the main key if it's not a modifier
    if (!['Meta', 'Control', 'Alt', 'Shift'].includes(e.key)) {
      keys.push(e.key.toLowerCase())
    }

    if (keys.length > 0) {
      setRecordedKeys(keys)
      setIsRecording(false)
    }
  }, [isRecording])

  React.useEffect(() => {
    if (isRecording) {
      window.addEventListener('keydown', handleKeyDown)
      return () => window.removeEventListener('keydown', handleKeyDown)
    }
  }, [isRecording, handleKeyDown])

  return (
    <Dialog.Root open={open} onOpenChange={onOpenChange}>
      <AnimatePresence>
        {open && (
          <Dialog.Portal forceMount>
            <Dialog.Overlay asChild>
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm"
              />
            </Dialog.Overlay>
            <Dialog.Content asChild>
              <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.95 }}
                className="fixed left-1/2 top-1/2 z-50 w-full max-w-[280px] -translate-x-1/2 -translate-y-1/2 rounded-lg border border-white/5 bg-zinc-900/95 p-4 shadow-lg backdrop-blur-sm"
              >
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-light text-white/80">
                      record shortcut
                    </span>
                    <Dialog.Close className="rounded-full p-1 text-white/40 transition-colors hover:bg-white/5 hover:text-white/60">
                      <X className="h-4 w-4" />
                    </Dialog.Close>
                  </div>

                  <button
                    onClick={() => setIsRecording(true)}
                    className={cn(
                      "w-full rounded-md border border-white/5 bg-zinc-800/50 px-4 py-3 text-sm font-light",
                      "transition-colors focus:outline-none",
                      isRecording
                        ? "text-white/90 border-white/20"
                        : "text-white/40 hover:text-white/60"
                    )}
                  >
                    {isRecording ? (
                      "recording..."
                    ) : recordedKeys.length > 0 ? (
                      <div className="flex items-center justify-center gap-1">
                        {recordedKeys.map((key, i) => (
                          <React.Fragment key={i}>
                            <kbd className="px-1.5 py-0.5 text-xs font-mono bg-white/5 rounded">
                              {key}
                            </kbd>
                            {i < recordedKeys.length - 1 && (
                              <span className="text-white/20">+</span>
                            )}
                          </React.Fragment>
                        ))}
                      </div>
                    ) : (
                      "click to record"
                    )}
                  </button>

                  <div className="flex justify-end gap-2">
                    <button
                      onClick={() => onOpenChange(false)}
                      className="px-3 py-1.5 text-sm font-light text-white/60 hover:text-white/80 transition-colors"
                    >
                      cancel
                    </button>
                    <button
                      onClick={() => {
                        onSave(recordedKeys)
                        onOpenChange(false)
                      }}
                      className="px-3 py-1.5 text-sm font-light text-white/80 bg-white/5 rounded-md hover:bg-white/10 transition-colors"
                    >
                      save
                    </button>
                  </div>
                </div>
              </motion.div>
            </Dialog.Content>
          </Dialog.Portal>
        )}
      </AnimatePresence>
    </Dialog.Root>
  )
}
````

## File: apps/app/src/components/ui/skeleton.tsx
````typescript
import { motion } from "framer-motion"
import { cn } from "@/lib/utils"

export function Skeleton({ className }: { className?: string }) {
  return (
    <motion.div
      initial={{ opacity: 0.3 }}
      animate={{ opacity: 0.4 }}
      transition={{ duration: 1.2, repeat: Infinity }}
      className={cn(
        "rounded-md bg-white/5",
        className
      )}
    />
  )
}
````

## File: apps/app/src/components/ui/slider.tsx
````typescript
"use client"

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"
import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track
      className="relative h-1 w-full grow overflow-hidden rounded-full bg-white/5"
    >
      <SliderPrimitive.Range className="absolute h-full bg-[#178bf1]/40" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb
      className={cn(
        "block h-4 w-4 rounded-full border border-white/10",
        "bg-white/10 backdrop-blur-sm transition-colors",
        "focus:outline-none focus-visible:ring-1 focus-visible:ring-white/20",
        "disabled:pointer-events-none disabled:opacity-50",
        "hover:bg-white/20"
      )}
    />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }
````

## File: apps/app/src/components/ui/star-border.tsx
````typescript
"use client"

import React from "react"
import { cn } from "@/lib/utils"

interface StarBorderProps extends React.HTMLAttributes<HTMLElement> {
  as?: React.ElementType
  className?: string
  color?: string
  speed?: string
  children: React.ReactNode
}

export function StarBorder({
  as: Component = "button",
  className = "",
  color = "white",
  speed = "6s",
  children,
  ...props
}: StarBorderProps) {
  return (
    <Component 
      className={cn(
        "relative inline-block p-[1px] rounded-2xl overflow-hidden",
        className
      )} 
      {...props}
    >
      {/* Border gradient animations */}
      <div
        className="absolute w-[300%] h-1/2 opacity-70 -bottom-[11px] -right-[250%] rounded-[50%] z-0"
        style={{
          background: `radial-gradient(circle, ${color}, transparent 10%)`,
          animation: `star-movement-bottom ${speed} linear infinite alternate`
        }}
      />
      <div
        className="absolute opacity-70 w-[300%] -top-[11px] -left-[250%] h-1/2 rounded-[50%] z-0"
        style={{
          background: `radial-gradient(circle, ${color}, transparent 10%)`,
          animation: `star-movement-top ${speed} linear infinite alternate`
        }}
      />

      {/* Content */}
      <div className="relative z-10">
        {children}
      </div>
    </Component>
  )
}
````

## File: apps/app/src/components/ui/textarea.tsx
````typescript
import * as React from "react"
import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<HTMLTextAreaElement, React.TextareaHTMLAttributes<HTMLTextAreaElement>>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex w-full rounded-lg bg-zinc-900/50 border border-white/5 px-4 py-3",
          "text-sm text-white/80 placeholder:text-white/20 font-light",
          "focus:outline-none focus:ring-0 focus:border-white/10 transition-colors",
          "disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }
````

## File: apps/app/src/components/ui/tooltip.tsx
````typescript
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"
import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md bg-zinc-900/95 border border-white/5 px-2 py-1",
      "text-sm text-white/80 font-light",
      "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
      "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2",
      "data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
````

## File: apps/app/src/hooks/use-mouse-position.ts
````typescript
"use client"

import { useState, useEffect } from "react"

export function useMousePosition() {
  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 })

  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      setMousePosition({ x: e.clientX, y: e.clientY })
    }

    window.addEventListener("mousemove", handleMouseMove)

    return () => {
      window.removeEventListener("mousemove", handleMouseMove)
    }
  }, [])

  return mousePosition
}
````

## File: apps/app/src/hooks/useChatContext.ts
````typescript
"use client"

import { useState, useEffect } from "react"
import { getSupabaseClient } from "@/lib/supabase/client"
import { AIService } from "@/lib/ai/services"

interface ChatContext {
  summary: {
    title: string
    description: string
    keyPhrases: string[]
  }
  topics: Array<{
    id: string
    title: string
    count: number
    relevance: number
  }>
  files: Array<{
    id: string
    name: string
    type: string
    lastModified: string
    relevance: number
  }>
  participants: Array<{
    id: string
    name: string
    email: string
    avatar?: string
    lastActive?: string
    contributions?: number
  }>
  isLoading: boolean
  error: Error | null
}

export function useChatContext(chatId: string): ChatContext {
  const [context, setContext] = useState<ChatContext>({
    summary: {
      title: "",
      description: "",
      keyPhrases: []
    },
    topics: [],
    files: [],
    participants: [],
    isLoading: true,
    error: null
  })

  useEffect(() => {
    let isMounted = true

    const fetchContext = async () => {
      try {
        const supabase = getSupabaseClient()
        
        // Get chat data
        const { data: chat } = await supabase
          .from('chats')
          .select(`
            *,
            messages: messages (
              *
            ),
            chat_participants: chat_participants (
              *,
              profiles: profiles (
                *
              )
            )
          `)
          .eq('id', chatId)
          .single()

        // Get messages content for analysis
        const messagesContent = (chat?.messages as unknown as Array<{
          content: string
          created_at: string
          sender_id: string
          chat_id: string
          id: string
        }> || []).map(m => m.content).join('\n')

        // Analyze chat context
        const analysis = await AIService.analyzeMessage(messagesContent, {
          recentMessages: [],
          threadContext: chatId
        })

        // Get files
        const { data: files } = await supabase
          .from('files')
          .select('*')
          .eq('chat_id', chatId)

        if (isMounted) {
          setContext(prev => ({
            ...prev,
            summary: {
              title: chat?.title as string || '',
              description: analysis?.summary || '',
              keyPhrases: analysis?.topics || []
            },
            topics: analysis?.topics?.map((topic, i) => ({
              id: `topic-${i}`,
              title: topic,
              count: 0,
              relevance: 0.8
            })) || [],
            files: (files || []).map(file => ({
              id: String(file.id),
              name: String(file.name),
              type: String(file.type),
              lastModified: String(file.updated_at),
              relevance: Number(file.relevance) || 0
            })),
            participants: (chat?.chat_participants as unknown as Array<{
              user_id: string
              joined_at: string
              last_read_at: string
              profiles: {
                id: string
                email: string
                full_name?: string | null
                avatar_url?: string | null
              }
            }> || []).map(p => ({
              id: p.user_id,
              name: p.profiles?.full_name || p.profiles?.email?.split('@')[0] || 'Unknown',
              email: p.profiles?.email || '',
              avatar: p.profiles?.avatar_url,
              lastActive: p.last_read_at,
              contributions: 0
            })),
            isLoading: false,
            error: null
          }))
        }
      } catch (error) {
        console.error('Error fetching chat context:', error)
        if (isMounted) {
          setContext(prev => ({
            ...prev,
            isLoading: false,
            error: error as Error
          }))
        }
      }
    }

    fetchContext()

    return () => {
      isMounted = false
    }
  }, [chatId])

  return context
}
````

## File: apps/app/src/hooks/useGlowEffect.ts
````typescript
"use client"

import { useEffect, useRef } from "react"

export function useGlowEffect() {
  const containerRef = useRef<HTMLDivElement>(null)
  const overlayRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    const container = containerRef.current
    const overlay = overlayRef.current

    if (!container || !overlay) return

    const handleMouseMove = (event: MouseEvent) => {
      const rect = container.getBoundingClientRect()
      const x = event.clientX - rect.left
      const y = event.clientY - rect.top

      requestAnimationFrame(() => {
        overlay.style.setProperty("--glow-x", `${x}px`)
        overlay.style.setProperty("--glow-y", `${y}px`)
        overlay.style.setProperty("--glow-opacity", "1")
      })
    }

    const handleMouseLeave = () => {
      requestAnimationFrame(() => {
        overlay.style.setProperty("--glow-opacity", "0")
      })
    }

    container.addEventListener("mousemove", handleMouseMove)
    container.addEventListener("mouseleave", handleMouseLeave)

    return () => {
      container.removeEventListener("mousemove", handleMouseMove)
      container.removeEventListener("mouseleave", handleMouseLeave)
    }
  }, [])

  return { containerRef, overlayRef }
}
````

## File: apps/app/src/hooks/useLeaderKey.ts
````typescript
"use client"

import { useState, useEffect, useCallback } from 'react'

interface LeaderKeyOptions {
  leaderKey?: string // e.g., 'Space', 'Tab', etc.
  timeout?: number // How long to wait for the command after leader (ms)
  commands: {
    key: string
    action: () => void
    description: string
  }[]
}

export function useLeaderKey({ leaderKey = 'Space', timeout = 2000, commands }: LeaderKeyOptions) {
  const [isLeaderPressed, setIsLeaderPressed] = useState(false)
  const [showHints, setShowHints] = useState(false)
  const [timeoutId, setTimeoutId] = useState<NodeJS.Timeout | null>(null)

  // Reset leader mode
  const resetLeaderMode = useCallback(() => {
    setIsLeaderPressed(false)
    setShowHints(false)
    if (timeoutId) clearTimeout(timeoutId)
  }, [timeoutId])

  // Handle keydown events
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // If we're in an input/textarea, ignore leader key
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
        return
      }

      // Handle leader key press
      if (!isLeaderPressed && e.key === leaderKey) {
        e.preventDefault()
        setIsLeaderPressed(true)
        setShowHints(true)
        
        // Set timeout to reset leader mode
        const id = setTimeout(resetLeaderMode, timeout)
        setTimeoutId(id)
        return
      }

      // If leader is pressed, check for commands
      if (isLeaderPressed) {
        const command = commands.find(cmd => cmd.key === e.key)
        if (command) {
          e.preventDefault()
          command.action()
          resetLeaderMode()
        }
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [isLeaderPressed, leaderKey, commands, resetLeaderMode, timeout])

  return {
    isLeaderPressed,
    showHints,
    resetLeaderMode
  }
}
````

## File: apps/app/src/hooks/useReferences.ts
````typescript
"use client"

import { useState, useEffect } from "react"
import { getSupabaseClient } from "@/lib/supabase/client"

export interface Reference {
  id: string
  type: string
  title: string
  content: any
  metadata: any
  similarity: number
}

export function useReferences(text: string, chatId: string) {
  const [references, setReferences] = useState<Reference[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    let isCancelled = false

    async function detectReferences() {
      if (!text.trim()) {
      setReferences([])
      return
    }

    setIsLoading(true)
    setError(null)

    try {
        const supabase = getSupabaseClient()
        const { data: { session } } = await supabase.auth.getSession()
        
        const { data, error } = await supabase.functions.invoke("find-references", {
          body: { 
            query: text,
            chat_id: chatId 
          },
          headers: {
            Authorization: `Bearer ${session?.access_token}`
          }
        })

        if (!isCancelled) {
          if (error) throw error
          setReferences(data.matches || [])
        }
    } catch (err) {
        if (!isCancelled) {
          console.error("Error detecting references:", err)
          setError(err instanceof Error ? err : new Error("Failed to detect references"))
        }
    } finally {
        if (!isCancelled) {
      setIsLoading(false)
    }
      }
    }

    // Debounce reference detection to avoid too many API calls
    const timeoutId = setTimeout(detectReferences, 300)

    return () => {
      isCancelled = true
      clearTimeout(timeoutId)
    }
  }, [text, chatId])

  return { references, isLoading, error }
}
````

## File: apps/app/src/hooks/useSuggestions.ts
````typescript
"use client"

import { useState, useEffect, useRef } from "react"
import { getSupabaseClient } from "@/lib/supabase/client"
import Fuse from 'fuse.js'
import { ContextService } from "@/lib/ai/context"
import type { Context, ContextType } from "@/types/ai/context"

interface SuggestionOptions {
  type?: string
  limit?: number
  threshold?: number
}

interface ContextData {
  id: string
  type: string
  title: string
  description?: string
  embedding?: number[]
}

export function useSuggestions(query: string, chatId: string, options: SuggestionOptions = {}) {
  const [suggestions, setSuggestions] = useState<ContextData[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<Error | null>(null)
  
  // Use refs to store cache and prevent recreation on every render
  const contextCacheRef = useRef<{
    embeddings: number[][]
    contexts: ContextData[]
  }>({ embeddings: [], contexts: [] })
  
  const fuseRef = useRef<Fuse<ContextData>>(null)
  const timeoutRef = useRef<NodeJS.Timeout | null>(null)

  // Initialize cache and Fuse instance
  useEffect(() => {
    const initializeCache = async () => {
      try {
        setIsLoading(true)
        const contexts = await ContextService.findSimilarContexts(query, {
          type: options.type,
          limit: options.limit,
          threshold: options.threshold,
          chatId
        })

        if (!contexts) return

        // Format contexts
        const formattedContexts = contexts.map(c => ({
          id: c.id,
          type: c.type,
          title: c.metadata.title || c.metadata.name || 'Untitled',
          subtitle: c.metadata.description
        }))

        // Update cache
        contextCacheRef.current = {
          embeddings: contexts.map(d => d.embedding || []),
          contexts: formattedContexts
        }

        // Initialize Fuse
        fuseRef.current = new Fuse(formattedContexts, {
          keys: ['title', 'subtitle'],
          threshold: 0.3
        })

        setSuggestions(formattedContexts)
      } catch (err) {
        setError(err instanceof Error ? err : new Error('Failed to initialize suggestions'))
      } finally {
        setIsLoading(false)
      }
    }

    // Debounce initialization
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current)
    }

    if (query.length >= 2) {
      timeoutRef.current = setTimeout(initializeCache, 300)
    } else {
      setSuggestions([])
    }

    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
      }
    }
  }, [query, chatId, options.type, options.limit, options.threshold])

  // Function for triggering deep analysis
  const triggerDeepAnalysis = async () => {
    if (!query.trim()) return
    
    setIsLoading(true)
    try {
      const supabase = getSupabaseClient()
      const { data } = await supabase.functions.invoke('analyze-message', {
        body: {
          content: query,
          chatId,
          mode: 'deep'
        }
      })
      
      if (data?.suggestions) {
        setSuggestions(data.suggestions)
      }
    } catch (err) {
      console.error('Deep analysis error:', err)
      setError(err instanceof Error ? err : new Error('Failed to analyze'))
    } finally {
      setIsLoading(false)
    }
  }

  return {
    suggestions,
    isLoading,
    error,
    triggerDeepAnalysis // Expose for manual triggering
  }
}
````

## File: apps/app/src/lib/adapters/message.ts
````typescript
import type { Message as SupabaseMessage } from "@/lib/supabase/messages"
import type { Message as UIMessage } from '@/types'

export function adaptMessage(message: SupabaseMessage): UIMessage {
  return {
    ...message,
    references: []
  }
}

export function adaptMessages(messages: SupabaseMessage[]): UIMessage[] {
  return messages.map(adaptMessage)
}
````

## File: apps/app/src/lib/ai/context.ts
````typescript
import { getSupabaseClient } from "@/lib/supabase/client"
import { EmbeddingService } from "./embeddings"

export interface ContextMetadata {
  title?: string
  description?: string
  url?: string
  name?: string
  email?: string
  full_name?: string
  type?: string
  size?: string
  preview?: string
  [key: string]: any
}

export interface Context {
  id: string
  type: "thread" | "user" | "url" | "file"
  metadata: ContextMetadata
  embedding?: number[]
}

export class ContextService {
  static async findSimilarContexts(
    text: string,
    options: {
      type?: string
      limit?: number
      threshold?: number
      chatId?: string
    } = {}
  ) {
    const embedding = await EmbeddingService.generateEmbedding(text)
    const supabase = getSupabaseClient()

    const { data, error } = await supabase.rpc("match_contexts", {
      query_embedding: embedding,
      match_threshold: options.threshold || 0.7,
      match_count: options.limit || 5,
      context_type: options.type,
      chat_id: options.chatId
    })

    if (error) throw error
    return data as Context[]
  }

  static async createContext(
    content: string,
    type: Context["type"],
    metadata: ContextMetadata = {}
  ) {
    const supabase = getSupabaseClient()
    const embedding = await EmbeddingService.generateEmbedding(content)

    const { data, error } = await supabase
      .from("contexts")
      .insert([
        {
          type,
          metadata,
          embedding
        }
      ])
      .select()
      .single()

    if (error) throw error
    return data
  }

  static async linkContextToMessage(
    contextId: string,
    messageId: string,
    metadata: Record<string, any> = {}
  ) {
    const supabase = getSupabaseClient()

    const { error } = await supabase
      .from("message_contexts")
      .insert([
        {
          context_id: contextId,
          message_id: messageId,
          metadata
        }
      ])

    if (error) throw error
  }

  static async getMessageContexts(messageId: string) {
    const supabase = getSupabaseClient()

    const { data, error } = await supabase
      .from("message_contexts")
      .select(`
        context_id,
        metadata,
        contexts (
          id,
          type,
          metadata
        )
      `)
      .eq("message_id", messageId)

    if (error) throw error
    return data?.map((row: any) => ({
      ...(row.contexts as Context),
      linkMetadata: row.metadata
    })) || []
  }
}
````

## File: apps/app/src/lib/ai/contextSuggestions.ts
````typescript
import { AIService } from './services'
import { getSupabaseClient } from '../supabase/client'
import type { Context } from "@/types/ai/context"

export interface SuggestionResult {
  contexts: Context[]
  loading: boolean
  error: string | null
}

export class ContextSuggestionService {
  private static debounceTimeout: NodeJS.Timeout | null = null
  private static currentQuery: string | null = null

  static async getSuggestions(
    text: string,
    options: {
      types?: string[]
      limit?: number
      debounceMs?: number
    } = {}
  ): Promise<SuggestionResult> {
    // Don't search for very short queries
    if (text.length < 3) {
      return { contexts: [], loading: false, error: null }
    }

    // Debounce requests
    if (this.debounceTimeout) {
      clearTimeout(this.debounceTimeout)
    }

    return new Promise((resolve) => {
      this.debounceTimeout = setTimeout(async () => {
        try {
          // Generate embedding for search
          const embedding = await AIService.generateEmbedding(text)
          
          // Search for similar content
          const supabase = getSupabaseClient()
          const { data: contexts, error } = await supabase.rpc('match_contexts', {
            query_embedding: embedding,
            match_threshold: 0.7,
            match_count: options.limit || 5,
            filter_types: options.types
          })

          if (error) throw error

          // Fetch media suggestions (images, videos, etc)
          const { data: media } = await supabase.functions.invoke('find-references', {
            body: { query: text, type: 'media' }
          })

          // Combine and format results
          const contextsArray = Array.isArray(contexts) ? contexts : []
          const suggestions: Context[] = [
            ...contextsArray.map((ctx: any) => ({
              id: ctx.id,
              type: ctx.type,
              title: ctx.title,
              subtitle: ctx.description,
              preview: ctx.preview,
              metadata: {
                author: ctx.author,
                date: ctx.created_at,
                source: ctx.source
              }
            })),
            ...(media?.references || []).map((ref: any) => ({
              id: ref.id,
              type: 'media',
              title: ref.title,
              preview: ref.url,
              metadata: {
                type: ref.media_type,
                source: ref.source
              }
            }))
          ]

          resolve({
            contexts: suggestions,
            loading: false,
            error: null
          })

        } catch (error) {
          console.error('Error getting suggestions:', error)
          resolve({
            contexts: [],
            loading: false,
            error: error.message
          })
        }
      }, options.debounceMs || 300)
    })
  }

  static cancelPending() {
    if (this.debounceTimeout) {
      clearTimeout(this.debounceTimeout)
      this.debounceTimeout = null
    }
    this.currentQuery = null
  }
}
````

## File: apps/app/src/lib/ai/embeddings.ts
````typescript
import crypto from "crypto"

import { getSupabaseClient } from "@/lib/supabase/client"
import { VertexAI } from "@google-cloud/vertexai"

export interface EmbeddingResponse {
  embedding: number[]
  dimension: number
  model: string
}

export interface EmbeddingOptions {
  threshold?: number
  limit?: number
  type?: string
  chatId?: string
}

export interface SimilarityMatch {
  id: string
  type: string
  content: string
  metadata: any
  similarity: number
}

export class EmbeddingService {
  // Generate embedding for text content
  private static hashContent(text: string, imageUrl?: string): string {
    return crypto
      .createHash('sha256')
      .update(text + (imageUrl || ''))
      .digest('hex')
  }

  private static async cacheEmbedding(hash: string, embedding: number[]) {
    const supabase = getSupabaseClient()
    await supabase
      .from('embedding_cache')
      .upsert({ content_hash: hash, embedding })
  }

  static async generateEmbedding(text: string): Promise<number[]> {
    const supabase = getSupabaseClient()
    const { data } = await supabase.functions.invoke('generate-embedding', {
      body: { text }
    })
    return (data?.embedding as number[]) || []
  }

  // Get cached embedding if available
  static async getCachedEmbedding(
    contentHash: string
  ): Promise<number[] | null> {
    const supabase = getSupabaseClient()
    const { data } = await supabase
      .from('embedding_cache')
      .select('embedding')
      .eq('content_hash', contentHash)
      .maybeSingle()

    return data?.embedding as number[] || null
  }

  // Find similar content using vector similarity
  static async findSimilarContent(
    embedding: number[],
    options: EmbeddingOptions = {}
  ): Promise<SimilarityMatch[]> {
    const supabase = getSupabaseClient()
    const { data, error } = await supabase.rpc("match_contexts", {
      query_embedding: embedding,
      match_threshold: options.threshold || 0.7,
      match_count: options.limit || 10,
      context_type: options.type,
      chat_id: options.chatId
    })

    if (error) throw error
    return data as SimilarityMatch[]
  }

  // Batch process multiple texts
  static async batchGenerateEmbeddings(texts: string[]): Promise<number[][]> {
    const hashes = texts.map(t => this.hashContent(t))
    const { data: cached } = await getSupabaseClient()
      .from('embedding_cache')
      .select('embedding')
      .in('content_hash', hashes)

    const results = await Promise.all(texts.map(async (text, i) => {
      return (cached?.[i]?.embedding as number[]) || this.generateEmbedding(text)
    }))

    return results as number[][]
  }


  // Queue content for embedding generation
  static async queueForEmbedding(
    contentId: string,
    contentType: 'message' | 'file' | 'context'
  ): Promise<string> {
    const supabase = getSupabaseClient()
    const { data, error } = await supabase.rpc('queue_for_embedding', {
      content_id: contentId,
      content_type: contentType
    })

    if (error) throw error
    return data as string
  }

  // Check embedding queue status
  static async checkEmbeddingStatus(jobId: string): Promise<{
    status: 'pending' | 'processing' | 'completed' | 'failed'
    error?: string
  }> {
    const supabase = getSupabaseClient()
    const { data } = await supabase
      .from('embedding_queue')
      .select('status, last_error')
      .eq('id', jobId)
      .single()

    return {
      status: (data?.status as 'pending' | 'processing' | 'completed' | 'failed') || 'failed',
      error: data?.last_error as string | undefined
    }
  }

  static async generateAndStore(content: string, options: { messageId: string; chatId: string }) {
    const embedding = await this.generateEmbedding(content)
    const supabase = getSupabaseClient()
    
    const { error } = await supabase
      .from('messages')
      .update({ embedding })
      .eq('id', options.messageId)

    if (error) throw error
    return embedding
  }
}
````

## File: apps/app/src/lib/ai/messageProcessor.ts
````typescript
import { AIService } from "./services"
import { getSupabaseClient } from "../supabase/client"

interface ProcessOptions {
  chatId: string
  content: string
  files?: File[]
  references?: Array<{
    type: string
    id: string
    metadata?: any
  }>
  contexts?: Array<{
    id: string
    type: string
    metadata?: any
  }>
}

export class MessageProcessor {
  async processMessage(options: ProcessOptions) {
    const { chatId, content, files = [], references = [], contexts = [] } = options
    const supabase = getSupabaseClient()

    try {
      // 1. Process any attached files
      const fileResults = await Promise.all(
        files.map(async (file) => {
          const result = await AIService.processFile(file)
          return result
        })
      )

      // 2. Analyze message content
      const analysis = await AIService.analyzeMessage(content, {
        recentMessages: [], // TODO: Get from chat history
        attachedFiles: files,
        threadContext: contexts.map(c => c.id).join(",")
      })

      // 3. Find similar content
      const similar = await AIService.findSimilarContent(analysis.embedding, {
        includedChats: [chatId]
      })

      // 4. Store message with all metadata
      const { data: message, error } = await supabase
        .from('messages')
        .insert({
          chat_id: chatId,
          content,
          embedding: analysis.embedding,
          metadata: {
            analysis,
            files: fileResults,
            references,
            contexts,
            similar: similar.messages.map(m => m.id)
          }
        })
        .select()
        .single()

      if (error) throw error

      return {
        message,
        analysis,
        similar,
        files: fileResults
      }
    } catch (error) {
      console.error('Error processing message:', error)
      throw error
    }
  }
}
````

## File: apps/app/src/lib/ai/services.ts
````typescript
import { getSupabaseClient } from "../supabase/client"
import { ContextAnalysis } from '@/types'

interface MessageContext {
  recentMessages: string[]
  attachedFiles?: File[]
  threadContext?: string
  totalTokens?: number
}

interface ContentAnalysis {
  embedding: number[]
  topics: string[]
  entities: string[]
  sentiment: string
  references?: {
    threads: string[]
    files: string[]
    urls: string[]
  }
  summary?: string
}

export class AIService {
  static async analyzeMessage(content: string, context: MessageContext): Promise<ContentAnalysis> {
    const supabase = getSupabaseClient()
    
    // Call edge function for analysis
    const { data, error } = await supabase.functions.invoke("analyze-message", {
      body: {
        content,
        context: {
          ...context,
          attachedFiles: undefined // Don't send file data directly
        }
      }
    })

    if (error) throw error
    return data
  }

  static async findSimilarMessages(content: string, chatId: string) {
    const supabase = getSupabaseClient()
    const { data, error } = await supabase.functions.invoke("find-similar-messages", {
      body: { content, chatId }
    })
    if (error) throw error
    return data || []
  }

  static async generateResponse(content: string, context: string) {
    const supabase = getSupabaseClient()
    const { data, error } = await supabase.functions.invoke("generate-response", {
      body: { content, context }
    })
    if (error) throw error
    return data
  }

  static async findSimilarContent(embedding: number[], options: {
    threshold?: number
    limit?: number
    includeFiles?: boolean
    includedChats?: string[]
  } = {}) {
    const supabase = getSupabaseClient()
    
    // Call edge function for similarity search
    const { data, error } = await supabase.functions.invoke("find-similar", {
      body: {
        embedding,
        options
      }
    })

    if (error) throw error
    return data
  }

  static async getSmartSuggestions(content: string, context: MessageContext) {
    const supabase = getSupabaseClient()
    
    // Call edge function for suggestions
    const { data, error } = await supabase.functions.invoke("get-suggestions", {
      body: {
        content,
        context: {
          ...context,
          attachedFiles: undefined
        }
      }
    })

    if (error) throw error
    return data
  }

  static async processFile(file: File) {
    const supabase = getSupabaseClient()
    
    // Convert file to base64
    const base64 = await this.fileToBase64(file)
    
    // Call edge function for file processing
    const { data, error } = await supabase.functions.invoke("process-file", {
      body: {
        content: base64,
        type: file.type,
        name: file.name
      }
    })

    if (error) throw error
    return data
  }

  private static async fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = () => {
        const base64 = reader.result as string
        resolve(base64.split(",")[1])
      }
      reader.onerror = error => reject(error)
    })
  }

  static async generateEmbedding(text: string) {
    const supabase = getSupabaseClient()
    const { data, error } = await supabase.functions.invoke('generate-embedding', {
      body: { text }
    })
    if (error) throw error
    return data.embedding
  }
}
````

## File: apps/app/src/lib/ai/vertex.ts
````typescript
import { VertexAI } from '@google-cloud/vertexai'

export const vertexAI = new VertexAI({
  project: process.env.GOOGLE_PROJECT_ID!,
  location: 'us-central1'
})
````

## File: apps/app/src/lib/constants/demo-content.ts
````typescript
import { User, Hash, Link2, FileText, MessageSquare } from "lucide-react"

export type StoryType = 'social' | 'creator' | 'student' | 'gaming' | 'travel' | 'coding' | 'journal'
export type ContextType = 'user' | 'thread' | 'topic' | 'file' | 'link'

export const STORY_TYPES: { value: StoryType; label: string }[] = [
  { value: 'social', label: 'social' },
  { value: 'creator', label: 'creator' },
  { value: 'student', label: 'student' },
  { value: 'gaming', label: 'gaming' },
  { value: 'travel', label: 'travel' },
  { value: 'coding', label: 'coding' },
  { value: 'journal', label: 'journal' }
] as const

export const CONTEXT_TYPES: ContextType[] = ['user', 'thread', 'topic', 'file', 'link'] as const

export const CONTEXT_PREVIEWS = {
  social: {
    user: {
      title: "Kai Chen",
      preview: "Music Curator ¬∑ Festival Enthusiast",
      metadata: { 
        author: "kai@enso.chat",
        date: "Active now",
        avatar: "/avatars/kai.jpg",
        status: "online",
        bio: "living for the music üéµ"
      }
    },
    thread: {
      title: "festival-memories",
      preview: "coachella 2023 photo dump & highlights",
      metadata: { 
        author: "Started by Emma",
        date: "Last year",
        participants: 5,
        photos: 42,
        lastActive: "2 hours ago",
        pinned: true
      }
    },
    topic: {
      title: "festival-fits",
      preview: "outfit planning & style ideas",
      metadata: { 
        author: "15 contributors",
        date: "Active now",
        posts: 128,
        images: 56,
        lastUpdate: "5 min ago",
        trending: true
      }
    },
    file: {
      title: "packing-list.pdf",
      preview: "everything you need for the weekend",
      metadata: { 
        size: "1.2 MB",
        date: "Updated today",
        type: "PDF",
        pages: 3,
        author: "Emma",
        downloads: 8
      }
    },
    link: {
      title: "Set Times",
      preview: "Weekend 1 full schedule & map",
      metadata: { 
        url: "https://coachella.com/schedule",
        date: "Live updates",
        type: "Schedule",
        source: "Coachella Official",
        lastSync: "2 min ago",
        external: true
      }
    }
  },
  creator: {
    user: {
      title: "Mia Zhang",
      preview: "Art Director ¬∑ Visual Designer",
      metadata: { author: "mia@enso.chat", date: "In design review" }
    },
    thread: {
      title: "Brand Evolution",
      preview: "Visual identity and style exploration for 2024",
      metadata: { author: "Design Team", date: "Updated today" }
    },
    topic: {
      title: "visual-language",
      preview: "Our evolving design system and principles",
      metadata: { author: "8 contributors", date: "Active discussion" }
    },
    file: {
      title: "mood-board-v2.pdf",
      preview: "Visual direction and style guide",
      metadata: { size: "2.4 MB", date: "Added yesterday" }
    },
    link: {
      title: "Design System",
      preview: "Living documentation of our visual language",
      metadata: { url: "design.enso.chat", date: "Updated today" }
    }
  },
  student: {
    user: {
      title: "Jay Park",
      preview: "PhD Candidate ¬∑ Research Lead",
      metadata: { author: "jay@enso.chat", date: "Writing thesis" }
    },
    thread: {
      title: "Research Framework",
      preview: "Methodology development and literature review",
      metadata: { author: "Research Team", date: "Updated yesterday" }
    },
    topic: {
      title: "methodology",
      preview: "Research methods and approaches",
      metadata: { author: "6 contributors", date: "Active research" }
    },
    file: {
      title: "thesis-draft.pdf",
      preview: "Latest version of research thesis",
      metadata: { size: "3.8 MB", date: "Last edited 2h ago" }
    },
    link: {
      title: "Research Database",
      preview: "Collection of academic papers and references",
      metadata: { url: "papers.academia.edu", date: "Updated weekly" }
    }
  },
  gaming: {
    user: {
      title: "Nova Kim",
      preview: "Raid Leader ¬∑ Strategy Guide Author",
      metadata: { author: "nova@enso.chat", date: "In raid" }
    },
    thread: {
      title: "Boss Strategies",
      preview: "Detailed mechanics and team coordination",
      metadata: { author: "Raid Team", date: "Updated 3h ago" }
    },
    topic: {
      title: "team-comp",
      preview: "Optimal team compositions and roles",
      metadata: { author: "10 contributors", date: "Active planning" }
    },
    file: {
      title: "raid-guide.pdf",
      preview: "Complete walkthrough and strategies",
      metadata: { size: "5.2 MB", date: "Version 2.4" }
    },
    link: {
      title: "Team Stats",
      preview: "Real-time raid progress and analytics",
      metadata: { url: "stats.raid.gg", date: "Live tracking" }
    }
  },
  travel: {
    user: {
      title: "Rin Tanaka",
      preview: "Local Guide ¬∑ Food Explorer",
      metadata: { author: "rin@enso.chat", date: "Exploring" }
    },
    thread: {
      title: "Secret Spots",
      preview: "Off-the-beaten-path locations and experiences",
      metadata: { author: "Travel Team", date: "Updated today" }
    },
    topic: {
      title: "local-tips",
      preview: "Insider recommendations and tips",
      metadata: { author: "14 contributors", date: "Active sharing" }
    },
    file: {
      title: "city-guide.pdf",
      preview: "Curated guide to hidden gems and local favorites",
      metadata: { size: "4.1 MB", date: "Spring 2024" }
    },
    link: {
      title: "Local Events",
      preview: "What's happening this week in the city",
      metadata: { url: "events.local.guide", date: "Updated daily" }
    }
  },
  coding: {
    user: {
      title: "Zoe Chen",
      preview: "Senior Engineer ¬∑ OSS Contributor",
      metadata: { author: "zoe@enso.chat", date: "Coding" }
    },
    thread: {
      title: "Architecture Review",
      preview: "System design and technical decisions for the new API",
      metadata: { author: "Tech Lead", date: "In review" }
    },
    topic: {
      title: "performance",
      preview: "Performance optimizations and benchmarks",
      metadata: { author: "7 contributors", date: "Active discussion" }
    },
    file: {
      title: "system-design.excalidraw",
      preview: "High-level architecture diagrams and flows",
      metadata: { size: "842 KB", date: "Updated 1h ago" }
    },
    link: {
      title: "CI Dashboard",
      preview: "Build status and deployment metrics",
      metadata: { url: "ci.dev.team", date: "Last build: 5m ago" }
    }
  },
  journal: {
    user: {
      title: "Personal Journal",
      preview: "Private thoughts and reflections",
      metadata: { author: "you@enso.chat", date: "Writing" }
    },
    thread: {
      title: "Morning Pages",
      preview: "Daily stream of consciousness writing",
      metadata: { author: "Private", date: "Updated today" }
    },
    topic: {
      title: "gratitude",
      preview: "Collection of moments and appreciations",
      metadata: { author: "Personal", date: "Daily entries" }
    },
    file: {
      title: "reflection-2024.md",
      preview: "Annual review and future aspirations",
      metadata: { size: "156 KB", date: "Last edit: Mar 15" }
    },
    link: {
      title: "Meditation Timer",
      preview: "Mindfulness sessions and tracking",
      metadata: { url: "calm.mind", date: "Last session: 6h ago" }
    }
  }
} as const

export const DEMO_CONTENT = {
  social: {
    threadLinking: {
      title: "Festival Vibes",
      message: "@kai the playlist from >music-night was perfect! the sunset vibes were incredible üåÖ",
      reference: {
        title: "Music Night",
        content: "Shared playlists and memories"
      }
    }
  },
  creator: {
    threadLinking: {
      title: "Visual Design",
      message: "@mia the aesthetic from >mood-board is exactly what i was thinking for the #new-series ‚ú®",
      reference: {
        title: "Mood Board",
        content: "Visual inspiration and style ideas"
      }
    }
  },
  student: {
    threadLinking: {
      title: "Study Group",
      message: "@jay check out the examples from >lecture-notes! they connect perfectly with #thesis-ideas üìö",
      reference: {
        title: "Lecture Notes",
        content: "Research methodology and frameworks"
      }
    }
  },
  gaming: {
    threadLinking: {
      title: "Raid Team",
      message: "@nova your strats from >raid-guide are working perfectly for #boss-fights ‚öîÔ∏è",
      reference: {
        title: "Raid Guide",
        content: "Strategy guide and team compositions"
      }
    }
  },
  travel: {
    threadLinking: {
      title: "Travel Plans",
      message: "@rin those spots from >local-guide would be perfect for #hidden-gems üó∫Ô∏è",
      reference: {
        title: "Local Guide",
        content: "Hidden spots and local recommendations"
      }
    }
  },
  coding: {
    threadLinking: {
      title: "Code Review",
      message: "@zoe the patterns in >system-arch align perfectly with the #performance optimizations üöÄ",
      reference: {
        title: "System Architecture",
        content: "Core system design patterns"
      }
    }
  },
  journal: {
    threadLinking: {
      title: "Reflection",
      message: "reviewing my thoughts from >morning-pages and seeing patterns emerge in #gratitude ‚ú®",
      reference: {
        title: "Morning Pages",
        content: "Stream of consciousness writing"
      }
    }
  }
} as const
````

## File: apps/app/src/lib/redux/slices/apiSlice.ts
````typescript
import { createApi, fakeBaseQuery } from '@reduxjs/toolkit/query/react'
import { supabase } from '@/lib/supabase/client'
import type { Chat } from '@/types/api/chat'
import type { Message } from '@/types/api/message'
import { User } from '@supabase/supabase-js'

export const apiSlice = createApi({
  baseQuery: fakeBaseQuery(),
  tagTypes: ['Chat', 'User'],
  endpoints: (builder) => ({
    getChats: builder.query<Chat[], void>({
      queryFn: async () => {
        try {
          const { data, error } = await supabase
            .from('chats')
            .select('*')
            .order('updatedAt', { ascending: false })

          if (error) throw error
          return { data: data as unknown as Chat[] }
        } catch (error) {
          return { error: error as Error }
        }
      },
      providesTags: ['Chat'],
    }),

    getChatById: builder.query<Chat, string>({
      queryFn: async (chatId) => {
        try {
          const { data, error } = await supabase
            .from('chats')
            .select('*')
            .eq('id', chatId)
            .single()

          if (error) throw error
          return { data: data as unknown as Chat }
        } catch (error) {
          return { error: error as Error }
        }
      },
      providesTags: (_result, _error, id) => [{ type: 'Chat', id }],
    }),

    createChat: builder.mutation<Chat, Partial<Chat>>({
      queryFn: async (chat) => {
        try {
          const { data, error } = await supabase
            .from('chats')
            .insert([chat])
            .select()
            .single()

          if (error) throw error
          return { data: data as unknown as Chat }
        } catch (error) {
          return { error: error as Error }
        }
      },
      invalidatesTags: ['Chat'],
    }),

    updateChat: builder.mutation<Chat, { id: string; chat: Partial<Chat> }>({
      queryFn: async ({ id, chat }) => {
        try {
          const { data, error } = await supabase
            .from('chats')
            .update(chat)
            .eq('id', id)
            .select()
            .single()

          if (error) throw error
          return { data: data as unknown as Chat }
        } catch (error) {
          return { error: error as Error }
        }
      },
      invalidatesTags: (_result, _error, { id }) => [{ type: 'Chat', id }],
    }),

    deleteChat: builder.mutation<void, string>({
      queryFn: async (id) => {
        try {
          const { error } = await supabase
            .from('chats')
            .delete()
            .eq('id', id)

          if (error) throw error
          return { data: undefined }
        } catch (error) {
          return { error: error as Error }
        }
      },
      invalidatesTags: ['Chat'],
    }),

    getProfile: builder.query<User, void>({
      queryFn: async () => {
        try {
          const { data: { user }, error } = await supabase.auth.getUser()
          if (error) throw error
          return { data: user }
        } catch (error) {
          return { error: error as Error }
        }
      },
      providesTags: ['User'],
    }),

    generateResponse: builder.mutation<Message, { chatId: string; message: string }>({
      queryFn: async ({ chatId, message }) => {
        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId, message }),
          })
          
          if (!response.ok) throw new Error('Failed to generate response')
          const data = await response.json()
          return { data }
        } catch (error) {
          return { error: error as Error }
        }
      },
      invalidatesTags: (_result, _error, { chatId }) => [{ type: 'Chat', id: chatId }],
    }),
  }),
})

export const {
  useGetChatsQuery,
  useGetChatByIdQuery,
  useCreateChatMutation,
  useUpdateChatMutation,
  useDeleteChatMutation,
  useGetProfileQuery,
  useGenerateResponseMutation,
} = apiSlice
````

## File: apps/app/src/lib/redux/slices/authSlice.ts
````typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit'
import { User } from '@supabase/supabase-js'

interface AuthState {
  user: User | null
  isLoading: boolean
  error: string | null
}

const initialState: AuthState = {
  user: null,
  isLoading: true,
  error: null,
}

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    setUser: (state, action: PayloadAction<User | null>) => {
      state.user = action.payload
      state.isLoading = false
      state.error = null
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.isLoading = action.payload
    },
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload
      state.isLoading = false
    },
    clearError: (state) => {
      state.error = null
    },
    logout: (state) => {
      state.user = null
      state.error = null
      state.isLoading = false
    },
  },
})

export const { setUser, setLoading, setError, clearError, logout } = authSlice.actions

export default authSlice.reducer
````

## File: apps/app/src/lib/redux/slices/chatSlice.ts
````typescript
import { createSlice, PayloadAction, createSelector } from '@reduxjs/toolkit'
import { Chat, ChatType, ChatFilterType, Message, Context, ContextAnalysis, KnowledgeGraph, Suggestion } from '@/types'

export interface ChatState {
  data: (Chat & { has_unread?: boolean })[]
  loading: boolean
  error: string | null
  currentChat: Chat | null
  filters: {
    search: string
    type: ChatFilterType
    showArchived: boolean
  }
  context: {
    activeContexts: Context[]
    suggestions: Context[]
    currentAnalysis?: ContextAnalysis 
    knowledgeGraph?: KnowledgeGraph
  }
}

const initialState: ChatState = {
  data: [],
  loading: false,
  error: null,
  currentChat: null,
  filters: {
    search: '',
    type: 'all',
    showArchived: false
  },
  context: {
    activeContexts: [],
    suggestions: [],
    currentAnalysis: undefined,
    knowledgeGraph: undefined
  }
}

const chatSlice = createSlice({
  name: 'chat',
  initialState,
  reducers: {
    setChats: (state, action: PayloadAction<(Chat & { has_unread?: boolean })[]>) => {
      state.data = action.payload
      state.loading = false
      state.error = null
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload
    },
    setError: (state, action: PayloadAction<string>) => {
      state.error = action.payload
      state.loading = false
    },
    updateChat: (state, action: PayloadAction<Partial<Chat> & { id: string; has_unread?: boolean }>) => {
      const index = state.data.findIndex(chat => chat.id === action.payload.id)
      if (index !== -1) {
        state.data[index] = {
          ...state.data[index],
          ...action.payload,
          has_unread: action.payload.has_unread ?? state.data[index].has_unread
        }
      }
    },
    addChat: (state, action: PayloadAction<Chat>) => {
      state.data.unshift(action.payload)
    },
    removeChat: (state, action: PayloadAction<string>) => {
      state.data = state.data.filter(chat => chat.id !== action.payload)
    },
    setCurrentChat: (state, action: PayloadAction<string | null>) => {
      state.currentChat = action.payload ? state.data.find(chat => chat.id === action.payload) || null : null
    },
    markChatAsRead: (state, action: PayloadAction<string>) => {
      const index = state.data.findIndex(chat => chat.id === action.payload)
      if (index !== -1) {
        state.data[index].has_unread = false
      }
    },
    setSearchQuery: (state, action: PayloadAction<string>) => {
      state.filters.search = action.payload
    },
    setFilterType: (state, action: PayloadAction<ChatFilterType>) => {
      state.filters.type = action.payload
      // Reset archived view when switching types
      if (action.payload !== 'archived') {
        state.filters.showArchived = false
      }
    },
    toggleArchivedView: (state) => {
      state.filters.showArchived = !state.filters.showArchived
    },
    setActiveContexts: (state, action: PayloadAction<Context[]>) => {
      state.context.activeContexts = action.payload
    },
    updateKnowledgeGraph: (state, action: PayloadAction<KnowledgeGraph>) => {
      state.context.knowledgeGraph = action.payload
    },
    setContextSuggestions: (state, action: PayloadAction<Context[]>) => {
      state.context.suggestions = action.payload
    },
    setContextAnalysis: (state, action: PayloadAction<ContextAnalysis>) => {
      state.context.currentAnalysis = action.payload
    },
    removeContext: (state, action: PayloadAction<string>) => {
      state.context.activeContexts = state.context.activeContexts.filter(
        ctx => ctx.id !== action.payload
      )
    }
  }
})

// Memoized Base Selectors
const selectChatsData = (state: { chat: ChatState }) => state.chat.data
const selectFilters = (state: { chat: ChatState }) => state.chat.filters
const selectContextState = (state: { chat: ChatState }) => state.chat.context

// Memoized Derived Selectors
export const selectFilteredChats = createSelector(
  [selectChatsData, selectFilters],
  (data, filters) => {
    return data.filter(chat => {
      // Filter by type
      if (filters.type === 'archived') {
        return chat.is_archived
      }

      // Don't show archived chats in other views
      if (chat.is_archived) {
        return false
      }

      if (filters.type !== 'all') {
        // Special handling for direct messages
        if (filters.type === 'direct') {
          return chat.type === 'direct' || (chat.type === 'group' && chat.chat_participants?.length === 2)
        }
        if (chat.type !== filters.type) {
          return false
        }
      }

      // Filter by search
      if (filters.search) {
        const searchLower = filters.search.toLowerCase()
        const titleMatch = chat.title?.toLowerCase().includes(searchLower)
        const lastMessageMatch = chat.last_message?.content.toLowerCase().includes(searchLower)
        const participantMatch = chat.chat_participants?.some(p => 
          p.profiles?.full_name?.toLowerCase().includes(searchLower) ||
          p.profiles?.email?.toLowerCase().includes(searchLower)
        )
        return titleMatch || lastMessageMatch || participantMatch
      }

      return true
    })
  }
)

export const selectPinnedChats = createSelector(
  [selectChatsData, selectFilters],
  (data, filters) => {
    return data.filter(chat => 
      chat.pinned
    )
  }
)

export const selectRecentChats = createSelector(
  [selectFilteredChats],
  (filteredChats) => filteredChats.filter(chat => !chat.pinned)
)

export const selectMessageReferences = createSelector(
  [selectContextState, (state: any, messageId: string) => messageId],
  (context, messageId) => context.activeContexts.filter(ctx => ctx.id === messageId)
)

export const {
  setChats,
  setLoading,
  setError,
  updateChat,
  addChat,
  removeChat,
  setCurrentChat,
  markChatAsRead,
  setSearchQuery,
  setFilterType,
  toggleArchivedView,
  setActiveContexts,
  updateKnowledgeGraph,
  setContextSuggestions,
  setContextAnalysis,
  removeContext
} = chatSlice.actions

export default chatSlice.reducer
````

## File: apps/app/src/lib/redux/slices/themeSlice.ts
````typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit'

export type Theme = 'light' | 'dark' | 'system'

interface ThemeState {
  theme: Theme
  systemTheme: 'light' | 'dark'
}

const getInitialTheme = (): Theme => {
  if (typeof window !== 'undefined') {
    const savedTheme = localStorage.getItem('theme') as Theme
    if (savedTheme) return savedTheme
  }
  return 'system'
}

const initialState: ThemeState = {
  theme: getInitialTheme(),
  systemTheme: 'light',
}

const themeSlice = createSlice({
  name: 'theme',
  initialState,
  reducers: {
    setTheme: (state, action: PayloadAction<Theme>) => {
      state.theme = action.payload
      if (typeof window !== 'undefined') {
        localStorage.setItem('theme', action.payload)
      }
    },
    setSystemTheme: (state, action: PayloadAction<'light' | 'dark'>) => {
      state.systemTheme = action.payload
    },
  },
})

export const { setTheme, setSystemTheme } = themeSlice.actions

export const selectTheme = (state: { theme: ThemeState }) => {
  return state.theme.theme === 'system' ? state.theme.systemTheme : state.theme.theme
}

export default themeSlice.reducer
````

## File: apps/app/src/lib/redux/store.ts
````typescript
import { configureStore } from '@reduxjs/toolkit'
import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux'
import { setupListeners } from '@reduxjs/toolkit/query'
import authReducer from './slices/authSlice'
import chatReducer from './slices/chatSlice'
import themeReducer from './slices/themeSlice'
import { apiSlice } from './slices/apiSlice'

export const store = configureStore({
  reducer: {
    auth: authReducer,
    chat: chatReducer,
    theme: themeReducer,
    [apiSlice.reducerPath]: apiSlice.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: false,
    }).concat(apiSlice.middleware),
})

setupListeners(store.dispatch)

export type RootState = ReturnType<typeof store.getState>
export type AppDispatch = typeof store.dispatch

export const useAppDispatch: () => AppDispatch = useDispatch
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector
````

## File: apps/app/src/lib/references/index.ts
````typescript
import { getSupabaseClient } from "@/lib/supabase/client"
import { User, MessageSquare, Link, Hash } from "lucide-react"
import { truncate } from "@/lib/utils"

interface ReferenceDetection {
  type: Reference['type']
  confidence: number
  metadata: Record<string, any>
}

export interface Reference {
  id: string
  type: 'user' | 'message' | 'chat' | 'file' | 'link' | 'topic'
  title: string
  preview?: string
  metadata: {
    icon?: React.ComponentType
    source?: string
    timestamp?: string
    badge?: string
  }
}

export class ReferenceService {
  // Detect reference type from input
  static async detectReference(input: string): Promise<ReferenceDetection> {
    // Check for explicit triggers
    if (input.startsWith('@')) {
      return { 
        type: 'user', 
        confidence: 1,
        metadata: { query: input.slice(1) }
      }
    }
    
    if (input.startsWith('>')) {
      return { 
        type: 'message', 
        confidence: 1,
        metadata: { query: input.slice(1) }
      }
    }
    
    if (input.startsWith('#')) {
      return { 
        type: 'topic', 
        confidence: 1,
        metadata: { query: input.slice(1) }
      }
    }
    
    // URL detection
    if (this.isValidUrl(input)) {
      return { 
        type: 'link', 
        confidence: 1,
        metadata: { url: input }
      }
    }
    
    // Smart detection based on content
    return this.smartDetectReference(input)
  }

  // Find relevant references
  static async findReferences(
    detection: ReferenceDetection,
    context: { chatId: string }
  ): Promise<Reference[]> {
    const supabase = getSupabaseClient()
    const { type, metadata } = detection
    
    switch (type) {
      case 'user':
        const { data: users } = await supabase
          .from('profiles')
          .select('*')
          .ilike('full_name', `%${metadata.query}%`)
          .limit(5)
        return (users || []).map(this.formatUserReference)

      case 'message':
        const { data: messages } = await supabase
          .from('messages')
          .select(`
            *,
            sender:profiles(*)
          `)
          .eq('chat_id', context.chatId)
          .ilike('content', `%${metadata.query}%`)
          .limit(5)
        return (messages || []).map(this.formatMessageReference)

      case 'chat':
        const { data: chats } = await supabase
          .from('chats')
          .select('*')
          .ilike('title', `%${metadata.query}%`)
          .limit(5)
        return (chats || []).map(this.formatChatReference)

      case 'file':
        const { data: files } = await supabase
          .from('files')
          .select('*')
          .eq('chat_id', context.chatId)
          .ilike('name', `%${metadata.query}%`)
          .limit(5)
        return (files || []).map(this.formatFileReference)

      case 'link':
        return [{
          id: 'new-link',
          type: 'link',
          title: metadata.url,
          preview: 'Add new link',
          metadata: {
            icon: Link,
            source: 'web'
          }
        }]

      case 'topic':
        const { data: topics } = await supabase
          .from('topics')
          .select('*')
          .ilike('name', `%${metadata.query}%`)
          .limit(5)
        return (topics || []).map(this.formatTopicReference)

      default:
        return []
    }
  }

  // Reference formatting helpers
  private static formatUserReference(user: any): Reference {
    return {
      id: user.id,
      type: 'user',
      title: user.full_name,
      preview: user.email,
      metadata: {
        icon: User,
        badge: user.role,
        source: 'team'
      }
    }
  }

  private static formatMessageReference(message: any): Reference {
    return {
      id: message.id,
      type: 'message',
      title: truncate(message.content, 50),
      preview: `${message.sender?.full_name} ¬∑ ${formatRelativeTime(message.created_at)}`,
      metadata: {
        icon: MessageSquare,
        timestamp: formatRelativeTime(message.created_at)
      }
    }
  }

  private static formatChatReference(chat: any): Reference {
    return {
      id: chat.id,
      type: 'chat',
      title: chat.title,
      preview: `${chat.message_count || 0} messages`,
      metadata: {
        icon: MessageSquare,
        timestamp: formatRelativeTime(chat.updated_at)
      }
    }
  }

  private static formatFileReference(file: any): Reference {
    return {
      id: file.id,
      type: 'file',
      title: file.name,
      preview: `${file.size_formatted} ¬∑ ${file.type}`,
      metadata: {
        icon: Link,
        timestamp: formatRelativeTime(file.created_at)
      }
    }
  }

  private static formatTopicReference(topic: any): Reference {
    return {
      id: topic.id,
      type: 'topic',
      title: `#${topic.name}`,
      preview: `${topic.reference_count || 0} references`,
      metadata: {
        icon: Hash,
        badge: topic.category
      }
    }
  }

  // Utility functions
  private static isValidUrl(str: string): boolean {
    try {
      new URL(str)
      return true
    } catch {
      return false
    }
  }

  private static async smartDetectReference(input: string): Promise<ReferenceDetection> {
    // Default to searching all types
    return {
      type: 'message',
      confidence: 0.5,
      metadata: { query: input }
    }
  }
}

export function formatRelativeTime(date: Date | string): string {
  const now = new Date()
  const diff = now.getTime() - new Date(date).getTime()
  
  const minutes = Math.floor(diff / 60000)
  if (minutes < 1) return "just now"
  if (minutes < 60) return `${minutes}m ago`
  
  const hours = Math.floor(minutes / 60)
  if (hours < 24) return `${hours}h ago`
  
  const days = Math.floor(hours / 24)
  return `${days}d ago`
}
````

## File: apps/app/src/lib/services/chat.ts
````typescript
import { db, eq, and, desc, sql, chats, chatParticipants, messages, users } from '@repo/database'
import { currentUser } from '@clerk/nextjs/server'
import type { Chat, ChatType, ChatWithDetails } from '@/types'

export interface GetChatsOptions {
  archived?: boolean
  type?: ChatType
  search?: string
  labels?: string[]
}

export class ChatService {
  static async getChat(chatId: string): Promise<ChatWithDetails | null> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    const chat = await db.query.chats.findFirst({
      where: eq(chats.id, chatId),
      with: {
        participants: {
          with: {
            user: {
              columns: {
                id: true,
                name: true,
                username: true,
                pfpUrl: true,
              }
            }
          }
        }
      }
    })

    if (!chat) return null

    // Check if user is participant
    const isParticipant = chat.participants.some(p => p.user.clerkId === user.id)
    if (!isParticipant) throw new Error('Access denied')

    return chat as unknown as ChatWithDetails
  }

  static async createChat(
    userIds: string[] = [], 
    type: ChatType = 'personal'
  ): Promise<Chat> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Get current user's database record
    const currentDbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })
    if (!currentDbUser) throw new Error('User not found in database')

    let title = ''
    if (type === 'direct' && userIds.length === 1) {
      const otherUser = await db.query.users.findFirst({
        where: eq(users.clerkId, userIds[0]),
        columns: { name: true, username: true }
      })

      if (otherUser) {
        title = otherUser.name || otherUser.username || 'User'
      }
    }

    // Create chat
    const [newChat] = await db.insert(chats).values({
      type,
      title,
      createdBy: currentDbUser.id
    }).returning()

    // Add participants (convert Clerk IDs to database user IDs)
    const participantUsers = await db.query.users.findMany({
      where: eq(users.clerkId, userIds[0] || user.id),
      columns: { id: true, clerkId: true }
    })

    const participantInserts = [
      { chatId: newChat.id, userId: currentDbUser.id }, // Creator
      ...participantUsers.map(u => ({ chatId: newChat.id, userId: u.id }))
    ]

    await db.insert(chatParticipants).values(participantInserts)

    return newChat as unknown as Chat
  }

  static async getChats(options: GetChatsOptions = {}) {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Get current user's database record
    const currentDbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })
    if (!currentDbUser) throw new Error('User not found')

    let whereConditions = [
      eq(chatParticipants.userId, currentDbUser.id)
    ]

    // Apply filters
    if (typeof options.archived === 'boolean') {
      whereConditions.push(eq(chats.isArchived, options.archived))
    }
    if (options.type) {
      whereConditions.push(eq(chats.type, options.type))
    }
    if (options.search) {
      whereConditions.push(sql`${chats.title} ILIKE ${`%${options.search}%`}`)
    }
    if (options.labels?.length) {
      whereConditions.push(sql`${chats.labels} @> ${JSON.stringify(options.labels)}`)
    }

    const userChats = await db
      .select({
        chat: chats,
        participant: chatParticipants,
      })
      .from(chats)
      .innerJoin(chatParticipants, eq(chats.id, chatParticipants.chatId))
      .where(and(...whereConditions))
      .orderBy(desc(chats.pinned), desc(chats.createdAt))

    return userChats.map(({ chat, participant }) => {
      const hasUnread = chat.lastMessage && participant.lastReadAt 
        ? new Date(chat.lastMessage.created_at) > new Date(participant.lastReadAt)
        : false

      return {
        ...chat,
        has_unread: hasUnread
      }
    }) as ChatWithDetails[]
  }

  static async updateChatTitle(chatId: string, title: string) {
    await db.update(chats)
      .set({ title })
      .where(eq(chats.id, chatId))
  }

  static async updateChatReadStatus(chatId: string) {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Get current user's database record
    const currentDbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })
    if (!currentDbUser) throw new Error('User not found')

    await db.update(chatParticipants)
      .set({ lastReadAt: new Date() })
      .where(and(
        eq(chatParticipants.chatId, chatId),
        eq(chatParticipants.userId, currentDbUser.id)
      ))
  }

  static async archiveChat(chatId: string) {
    await db.update(chats)
      .set({ isArchived: true })
      .where(eq(chats.id, chatId))
  }

  static async unarchiveChat(chatId: string) {
    await db.update(chats)
      .set({ isArchived: false })
      .where(eq(chats.id, chatId))
  }

  static async toggleChatPin(chatId: string) {
    const chat = await db.query.chats.findFirst({
      where: eq(chats.id, chatId),
      columns: { pinned: true }
    })

    if (chat) {
      await db.update(chats)
        .set({ pinned: !chat.pinned })
        .where(eq(chats.id, chatId))
    }
  }

  static async updateChatLabels(chatId: string, labels: string[]) {
    await db.update(chats)
      .set({ labels })
      .where(eq(chats.id, chatId))
  }

  static async deleteChat(chatId: string) {
    await db.delete(chats)
      .where(eq(chats.id, chatId))
  }
}

// Export both class methods and individual functions for compatibility
export const { 
  getChat, 
  createChat, 
  getChats, 
  updateChatTitle, 
  updateChatReadStatus, 
  archiveChat, 
  unarchiveChat, 
  toggleChatPin, 
  updateChatLabels, 
  deleteChat 
} = ChatService
````

## File: apps/app/src/lib/services/message.ts
````typescript
import { db, eq, desc, asc, sql, messages, users } from '@repo/database'
import { currentUser } from '@clerk/nextjs/server'
import type { Message } from '@/types'
import { AIService } from '@/lib/ai/services'
import { EmbeddingService } from '@/lib/ai/embeddings'

export class MessageService {
  static async getMessages(chatId: string, limit = 50): Promise<Message[]> {
    const messageRecords = await db.query.messages.findMany({
      where: eq(messages.chatId, chatId),
      with: {
        sender: {
          columns: {
            name: true,
            username: true,
          }
        }
      },
      orderBy: asc(messages.createdAt),
      limit
    })

    return messageRecords.map(msg => ({
      id: msg.id,
      chat_id: msg.chatId,
      content: msg.content,
      sender_id: msg.senderId,
      created_at: msg.createdAt.toISOString(),
      sender: {
        email: msg.sender.username, // Use username as email proxy
        full_name: msg.sender.name
      },
      embedding: msg.embedding,
      references: msg.references
    })) as Message[]
  }

  static async sendMessage(
    chatId: string,
    content: string
  ): Promise<Message> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Get current user's database record
    const currentDbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })
    if (!currentDbUser) throw new Error('User not found in database')

    // Create message
    const [message] = await db.insert(messages).values({
      chatId,
      content,
      senderId: currentDbUser.id
    }).returning()

    // Process message in background
    Promise.all([
      // Generate and store embedding
      EmbeddingService.generateAndStore(content, {
        messageId: message.id,
        chatId
      }),

      // Find similar messages
      AIService.findSimilarMessages(content, chatId)
        .then(async (similarMessages) => {
          if (similarMessages.length > 0) {
            // Generate AI response if needed
            const response = await AIService.generateResponse(
              content,
              similarMessages.map(m => m.content).join('\n')
            )
            // Handle response...
          }
        })
    ]).catch(console.error) // Handle background processing errors

    // Return message with sender info
    const messageWithSender = await db.query.messages.findFirst({
      where: eq(messages.id, message.id),
      with: {
        sender: {
          columns: {
            name: true,
            username: true,
          }
        }
      }
    })

    return {
      id: messageWithSender!.id,
      chat_id: messageWithSender!.chatId,
      content: messageWithSender!.content,
      sender_id: messageWithSender!.senderId,
      created_at: messageWithSender!.createdAt.toISOString(),
      sender: {
        email: messageWithSender!.sender.username,
        full_name: messageWithSender!.sender.name
      },
      embedding: messageWithSender!.embedding,
      references: messageWithSender!.references
    } as Message
  }

  static async updateMessageEmbedding(
    messageId: string,
    embedding: number[]
  ) {
    return db.update(messages)
      .set({ embedding })
      .where(eq(messages.id, messageId))
  }

  static async findSimilarMessages(
    chatId: string,
    embedding: number[],
    limit = 5
  ): Promise<Message[]> {
    const similarMessages = await db.execute(sql`
      SELECT id, content, created_at, sender_id,
             1 - (embedding <=> ${embedding}::vector) as similarity
      FROM ${messages}
      WHERE chat_id = ${chatId}
        AND embedding IS NOT NULL
      ORDER BY similarity DESC
      LIMIT ${limit}
    `)

    return similarMessages.rows.map(row => ({
      id: row.id,
      chat_id: chatId,
      content: row.content,
      sender_id: row.sender_id,
      created_at: row.created_at,
      similarity: row.similarity
    })) as Message[]
  }
}

// Export both class methods and individual functions for compatibility
export const { 
  getMessages, 
  sendMessage, 
  updateMessageEmbedding, 
  findSimilarMessages 
} = MessageService
````

## File: apps/app/src/lib/services/storage.ts
````typescript
import { storage, fileProcessor } from '@repo/storage'
import { currentUser } from '@clerk/nextjs/server'
import type { UploadedFile, FileMetadata } from '@repo/storage'

const MAX_FILE_SIZE = 20 * 1024 * 1024 // 20MB
const ALLOWED_FILE_TYPES = {
  image: ["image/jpeg", "image/png", "image/gif", "image/webp"],
  document: ["application/pdf", "text/plain", "text/markdown"],
}

interface UploadOptions {
  onProgress?: (progress: number) => void
}

export class StorageService {
  static async uploadFile(
    file: File,
    folder: string = "attachments",
    options: UploadOptions = {}
  ): Promise<UploadedFile> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    if (file.size > MAX_FILE_SIZE) {
      throw new Error("File size exceeds 20MB limit")
    }

    // Check file type
    const isImage = ALLOWED_FILE_TYPES.image.includes(file.type)
    const isDocument = ALLOWED_FILE_TYPES.document.includes(file.type)
    
    if (!isImage && !isDocument) {
      throw new Error("File type not supported")
    }

    // Process file metadata
    const metadata = await fileProcessor.processFile(file)

    // Generate unique filename
    const timestamp = Date.now()
    const extension = file.name.split(".").pop()
    const filename = `${timestamp}-${Math.random().toString(36).substring(7)}.${extension}`
    const path = `${folder}/${user.id}/${filename}`

    // Upload file
    const uploadResult = await storage.upload({
      file,
      path,
      metadata: {
        ...metadata,
        originalName: file.name,
        uploadedBy: user.id,
        uploadedAt: new Date().toISOString()
      }
    })

    return {
      url: uploadResult.url,
      path: uploadResult.path,
      filename,
      type: file.type,
      size: file.size,
      metadata: uploadResult.metadata,
    }
  }

  static async deleteFile(path: string): Promise<void> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Check if user owns the file (basic security check)
    if (!path.includes(user.id)) {
      throw new Error('Access denied')
    }

    await storage.delete(path)
  }

  static getFileUrl(path: string): string {
    return storage.getPublicUrl(path)
  }

  static async getFileMetadata(path: string): Promise<FileMetadata | null> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Check if user owns the file (basic security check)
    if (!path.includes(user.id)) {
      throw new Error('Access denied')
    }

    return storage.getMetadata?.(path) || null
  }

  static async listUserFiles(folder: string = "attachments"): Promise<string[]> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    const userFolder = `${folder}/${user.id}/`
    return storage.list?.(userFolder) || []
  }
}

// Export both class methods and individual functions for compatibility
export const { 
  uploadFile, 
  deleteFile, 
  getFileUrl, 
  getFileMetadata, 
  listUserFiles 
} = StorageService
````

## File: apps/app/src/lib/services/user.ts
````typescript
import { db, eq, or, ilike, users, chatParticipants } from '@repo/database'
import { currentUser } from '@clerk/nextjs/server'
import type { User, UserProfile } from '@/types'

export class UserService {
  static async getProfile(): Promise<User | null> {
    const user = await currentUser()
    if (!user) return null

    const dbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })

    if (!dbUser) return null

    return {
      id: dbUser.clerkId,
      email: user.emailAddresses[0]?.emailAddress,
      full_name: dbUser.name,
      avatar_url: dbUser.pfpUrl
    } as User
  }

  static async updateProfile(
    data: Partial<User>
  ): Promise<User> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    const dbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })
    if (!dbUser) throw new Error('User not found')

    await db.update(users)
      .set({
        name: data.full_name,
        pfpUrl: data.avatar_url,
      })
      .where(eq(users.clerkId, user.id))

    return this.getProfile() as Promise<User>
  }

  static async searchUsers(query: string, limit = 5): Promise<User[]> {
    const user = await currentUser()
    if (!user) throw new Error('Not authenticated')

    // Get current user's database record to exclude from results
    const currentDbUser = await db.query.users.findFirst({
      where: eq(users.clerkId, user.id)
    })
    if (!currentDbUser) throw new Error('Current user not found')

    const foundUsers = await db.query.users.findMany({
      where: or(
        ilike(users.username, `%${query}%`),
        ilike(users.name, `%${query}%`)
      ),
      columns: {
        clerkId: true,
        username: true,
        name: true,
        pfpUrl: true,
      },
      limit
    })

    // Filter out current user
    return foundUsers
      .filter(u => u.clerkId !== user.id)
      .map(u => ({
        id: u.clerkId,
        email: u.username, // Use username as email proxy
        full_name: u.name,
        avatar_url: u.pfpUrl
      })) as User[]
  }

  static async getChatParticipants(chatId: string): Promise<UserProfile[]> {
    const participants = await db.query.chatParticipants.findMany({
      where: eq(chatParticipants.chatId, chatId),
      with: {
        user: {
          columns: {
            clerkId: true,
            username: true,
            name: true,
            pfpUrl: true,
          }
        }
      }
    })

    return participants.map(p => ({
      id: p.user.clerkId,
      email: p.user.username,
      full_name: p.user.name,
      avatar_url: p.user.pfpUrl,
      joined_at: p.joinedAt.toISOString()
    })) as UserProfile[]
  }

  static async createOrUpdateUser(clerkUser: any): Promise<User> {
    const existingUser = await db.query.users.findFirst({
      where: eq(users.clerkId, clerkUser.id)
    })

    if (existingUser) {
      // Update existing user
      await db.update(users)
        .set({
          name: clerkUser.fullName || clerkUser.firstName + ' ' + clerkUser.lastName,
          pfpUrl: clerkUser.imageUrl,
          updatedAt: new Date()
        })
        .where(eq(users.clerkId, clerkUser.id))
      
      return {
        id: clerkUser.id,
        email: clerkUser.emailAddresses[0]?.emailAddress,
        full_name: existingUser.name,
        avatar_url: existingUser.pfpUrl
      } as User
    } else {
      // Create new user
      const [newUser] = await db.insert(users).values({
        clerkId: clerkUser.id,
        username: clerkUser.username || clerkUser.emailAddresses[0]?.emailAddress?.split('@')[0] || 'user',
        name: clerkUser.fullName || (clerkUser.firstName + ' ' + clerkUser.lastName).trim(),
        pfpUrl: clerkUser.imageUrl,
        passwordHash: 'clerk_managed', // Placeholder since Clerk manages auth
        phoneNumber: clerkUser.phoneNumbers[0]?.phoneNumber || '',
        phoneVerified: clerkUser.phoneNumbers[0]?.verification?.status === 'verified'
      }).returning()

      return {
        id: newUser.clerkId,
        email: clerkUser.emailAddresses[0]?.emailAddress,
        full_name: newUser.name,
        avatar_url: newUser.pfpUrl
      } as User
    }
  }
}

// Export both class methods and individual functions for compatibility
export const { 
  getProfile, 
  updateProfile, 
  searchUsers,
  getChatParticipants,
  createOrUpdateUser
} = UserService

// Alias for backward compatibility
export const searchProfiles = searchUsers
export const createProfile = createOrUpdateUser
````

## File: apps/app/src/lib/utils/chat-names.ts
````typescript
import { friendlyWords } from 'friendlier-words'

export function generateChatName() {
  // Generate a 2-word name with a space separator
  return friendlyWords(2, ' ')
}
````

## File: apps/app/src/lib/utils/colors.ts
````typescript
// A set of balanced, zen-like gradients that complement our brand blue (#178bf1)
export const chatGradients = [
  // Calm blue to purple
  'from-[#178bf1] to-[#9f7aea]',
  // Soft teal to blue
  'from-[#0d9488] to-[#178bf1]',
  // Warm rose to purple
  'from-[#f43f5e] to-[#9f7aea]',
  // Ocean blue to emerald
  'from-[#178bf1] to-[#059669]',
  // Sunset orange to rose
  'from-[#f97316] to-[#f43f5e]',
  // Deep purple to blue
  'from-[#7c3aed] to-[#178bf1]',
  // Forest green to teal
  'from-[#059669] to-[#0d9488]',
  // Royal purple to indigo
  'from-[#9f7aea] to-[#6366f1]'
]

export function getChatGradient(chatId: string) {
  const index = chatId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % chatGradients.length
  return chatGradients[index]
}
````

## File: apps/app/src/lib/db.ts
````typescript
import { PrismaClient } from '@prisma/client'

declare global {
  var prisma: PrismaClient | undefined
}

export const prisma = globalThis.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') {
  globalThis.prisma = prisma
}

export * from '@prisma/client'
````

## File: apps/app/src/lib/providers.tsx
````typescript
"use client"

import { Provider } from "react-redux"
import { store } from "./redux/store"
import { Toaster } from "sonner"

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <Provider store={store}>
      {children}
      <Toaster
        position="top-center"
        toastOptions={{
          style: {
            background: "rgba(0, 0, 0, 0.8)",
            color: "rgba(255, 255, 255, 0.9)",
            border: "1px solid rgba(255, 255, 255, 0.1)",
            backdropFilter: "blur(8px)",
          },
        }}
      />
    </Provider>
  )
}
````

## File: apps/app/src/lib/utils.ts
````typescript
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"
import { format, isToday, isYesterday } from "date-fns"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function formatDate(date: Date | string | number) {
  try {
    const d = new Date(date)
    // Check if date is valid
    if (isNaN(d.getTime())) {
      return ''
    }
  
  // If the date is from today, show the time
    if (isToday(d)) {
    return format(d, "h:mm a")
  }
  
    // If the date is from yesterday, show "Yesterday"
    if (isYesterday(d)) {
      return "Yesterday"
    }

    // If the date is from this year, show the month and day
    if (d.getFullYear() === new Date().getFullYear()) {
      return format(d, "MMM d")
  }
  
  // Otherwise show the full date
  return format(d, "MMM d, yyyy")
  } catch (error) {
    console.error('Error formatting date:', error)
    return ''
  }
}

export function formatRelativeTime(date: Date | string) {
  const now = new Date()
  const diff = now.getTime() - new Date(date).getTime()
  // ... implementation
}

export function truncate(str: string, length: number) {
  return str.length > length ? str.slice(0, length) + '...' : str
}
````

## File: apps/app/src/styles/globals.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;
 
@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 240 10% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 240 10% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 240 10% 3.9%;
    --primary: 240 5.9% 10%;
    --primary-foreground: 0 0% 98%;
    --secondary: 240 4.8% 95.9%;
    --secondary-foreground: 240 5.9% 10%;
    --muted: 240 4.8% 95.9%;
    --muted-foreground: 240 3.8% 46.1%;
    --accent: 240 4.8% 95.9%;
    --accent-foreground: 240 5.9% 10%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 5.9% 90%;
    --input: 240 5.9% 90%;
    --ring: 240 5.9% 10%;
    --radius: 0.5rem;
  }
 
  .dark {
    --background: 240 10% 3.9%;
    --foreground: 0 0% 98%;
    --card: 240 10% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 240 10% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 240 5.9% 10%;
    --secondary: 240 3.7% 15.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 240 3.7% 15.9%;
    --muted-foreground: 240 5% 64.9%;
    --accent: 240 3.7% 15.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 3.7% 15.9%;
    --input: 240 3.7% 15.9%;
    --ring: 240 4.9% 83.9%;
  }
}
 
@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

@layer utilities {
  .scroll-margin-top-[96px] {
    scroll-margin-top: 96px;
  }
}
````

## File: apps/app/src/types/ai/context.ts
````typescript
export type ContextType = 'user' | 'thread' | 'topic' | 'file' | 'link'

export interface ContextMetadata {
  title?: string
  description?: string
  url?: string
  name?: string
  email?: string
  full_name?: string
  subtitle?: string
  [key: string]: any
}

export interface Context {
  id: string
  type: ContextType
  title: string
  subtitle?: string
  metadata: ContextMetadata
}

export interface Reference {
  id: string
  type: ContextType
  title: string
  content: string
  preview?: string
  metadata?: ContextMetadata
  similarity: number
  url?: string
}

export interface ContextAnalysis {
  embedding: number[]
  topics: string[]
  entities: string[]
  sentiment: string
  references?: {
    threads: string[]
    files: string[]
    urls: string[]
  }
  summary?: string
}

export interface KnowledgeGraph {
  nodes: Array<{
    id: string
    type: string
    label: string
    data: any
  }>
  edges: Array<{
    source: string
    target: string
    type: string
    weight: number
  }>
}

export interface Suggestion {
  id: string
  type: ContextType
  title: string
  preview?: string
  metadata?: ContextMetadata
  confidence: number
}
````

## File: apps/app/src/types/ai/embedding.ts
````typescript
export interface EmbeddingResponse {
  embedding: number[]
  dimension: number
  model: string
}

export interface EmbeddingOptions {
  threshold?: number
  limit?: number
  type?: string
  chatId?: string
}

export interface SimilarityMatch {
  id: string
  type: string
  content: string
  metadata: any
  similarity: number
}

export interface EmbeddingJob {
  id: string
  status: 'pending' | 'processing' | 'completed' | 'failed'
  error?: string
  result?: number[]
  metadata?: {
    model?: string
    dimension?: number
    processingTime?: number
  }
}
````

## File: apps/app/src/types/api/chat.ts
````typescript
import { Message } from './message'

export type ChatType = 'personal' | 'direct' | 'group'

export interface Chat {
  id: string
  created_at: string
  type: ChatType
  title?: string
  created_by: string
  last_message?: {
    content: string
    sender_id: string
    created_at: string
    sender?: {
      email?: string
      full_name?: string
    }
  }
  chat_participants?: ChatParticipant[]
  is_archived?: boolean
  pinned?: boolean
  last_viewed_at?: string
  labels?: string[]
  has_unread?: boolean
  messages?: Message[]
}

export interface ChatParticipant {
  chat_id: string
  user_id: string
  joined_at: string
  last_read_at: string
  profiles: {
    id: string
    email: string
    full_name?: string | null
    avatar_url?: string | null
  }
}

export type ChatWithDetails = Chat & {
  messages?: Message[]
  chat_participants?: ChatParticipant[]
}

export interface GetChatsOptions {
  archived?: boolean
  type?: ChatType
  search?: string
  labels?: string[]
}

export type ChatFilterType = 'all' | 'personal' | 'direct' | 'group' | 'archived'
````

## File: apps/app/src/types/api/message.ts
````typescript
import { Reference } from '../ai/context'

export interface Message {
  id: string
  chat_id: string
  content: string
  sender_id: string
  created_at: string
  embedding?: number[]
  references?: Reference[]
  sender?: {
    email: string
    full_name?: string
    avatar_url?: string
  }
  status?: 'sending' | 'processing' | 'sent' | 'error'
  metadata?: MessageMetadata
}

export interface MessageContext {
  recentMessages: string[]
  attachedFiles?: File[]
  threadContext?: string
  totalTokens?: number
}

export interface MessageMetadata {
  analysis?: any // Will be defined in AI types
  files?: any[] // Will be defined in file types
  references?: Reference[]
  contexts?: Reference[]
  similar?: string[]
}
````

## File: apps/app/src/types/api/user.ts
````typescript
export interface User {
  id: string
  email: string
  full_name?: string | null
  avatar_url?: string | null
  created_at?: string
  last_seen_at?: string
  settings?: UserSettings
}

export interface UserSettings {
  theme?: 'light' | 'dark' | 'system'
  notifications?: {
    email?: boolean
    push?: boolean
    mentions?: boolean
  }
  shortcuts?: {
    [key: string]: string[]
  }
}

export interface UserProfile extends User {
  joined_at?: string
  status?: 'online' | 'offline' | 'away'
  bio?: string
}
````

## File: apps/app/src/types/index.ts
````typescript
// API Types
export * from './api/chat'
export * from './api/message'
export * from './api/user'

// AI Types
export * from './ai/context'
export * from './ai/embedding' 

export type ChatType = 'personal' | 'direct' | 'group'

export interface Profile {
  id: string
  email: string
  full_name?: string | null
  avatar_url?: string | null
  created_at: Date
  updated_at: Date
}

export interface ChatParticipant {
  id: string
  chat_id: string
  user_id: string
  joined_at: Date
  last_read_at: Date
  profile: Profile
}

export interface Message {
  id: string
  chat_id: string
  content: string
  sender_id: string
  created_at: Date
  sender: Pick<Profile, 'email' | 'full_name'>
  embedding?: number[] | null
  references?: any | null
}

export interface Chat {
  id: string
  title: string | null
  type: ChatType
  created_at: Date
  updated_at: Date
  created_by: string
  pinned: boolean
  is_archived: boolean
  labels: string[]
}

export interface ChatWithDetails extends Chat {
  chat_participants: ChatParticipant[]
  last_message?: Message
  has_unread?: boolean
}
````

## File: apps/app/src/middleware.ts
````typescript
import { authMiddleware } from '@repo/auth'
import { NextResponse } from 'next/server'

export default authMiddleware({
  // Routes that don't require authentication
  publicRoutes: [
    '/',
    '/about',
    '/blog',
    '/features', 
    '/pricing',
    '/login',
    '/signup',
    '/verify'
  ],
  // Routes that should be ignored by the middleware
  ignoredRoutes: [
    '/api/webhooks(.*)',
  ],
  afterAuth(auth, request) {
    // If user is not authenticated and trying to access protected route
    if (!auth.userId && !auth.isPublicRoute) {
      return NextResponse.redirect(new URL('/login', request.url))
    }

    // If user is authenticated and trying to access auth pages, redirect to app
    if (auth.userId && (
      request.nextUrl.pathname === '/login' || 
      request.nextUrl.pathname === '/signup' ||
      request.nextUrl.pathname === '/verify'
    )) {
      return NextResponse.redirect(new URL('/chat', request.url))
    }

    return NextResponse.next()
  }
})

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * Feel free to modify this pattern to include more paths.
     */
    "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
  ],
}
````

## File: apps/app/eslint.config.mjs
````
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    rules: {
      "@typescript-eslint/no-unused-vars": "off",
      "@typescript-eslint/no-explicit-any": "off",
      "react/no-unescaped-entities": "off",
      "@next/next/no-img-element": "warn"
    }
  }
];

export default eslintConfig;
````

## File: apps/app/next.config.ts
````typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
````

## File: apps/app/package.json
````json
{
  "name": "@repo/app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@repo/ai": "workspace:*",
    "@repo/auth": "workspace:*",
    "@repo/database": "workspace:*",
    "@repo/design": "workspace:*",
    "@repo/email": "workspace:*",
    "@repo/orpc": "workspace:*",
    "@repo/services": "workspace:*",
    "@repo/storage": "workspace:*",
    "@repo/analytics": "workspace:*",
    "@google-cloud/vertexai": "^1.9.3",
    "@headlessui/react": "^2.2.0",
    "@heroicons/react": "^2.2.0",
    "@radix-ui/react-avatar": "^1.1.2",
    "@radix-ui/react-collapsible": "^1.1.3",
    "@radix-ui/react-dialog": "^1.0.5",
    "@radix-ui/react-dropdown-menu": "^2.1.5",
    "@radix-ui/react-label": "^2.1.1",
    "@radix-ui/react-popover": "^1.1.5",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-scroll-area": "^1.2.2",
    "@radix-ui/react-separator": "^1.1.1",
    "@radix-ui/react-slider": "^1.2.3",
    "@radix-ui/react-slot": "^1.1.1",
    "@radix-ui/react-tabs": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.5",
    "@radix-ui/react-tooltip": "^1.1.7",
    "@react-spring/web": "^9.7.5",
    "@reduxjs/toolkit": "^2.5.1",
    "browser-image-compression": "^2.0.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^0.2.1",
    "date-fns": "^4.1.0",
    "framer-motion": "^12.0.6",
    "friendlier-words": "^1.1.3",
    "fuse.js": "^7.1.0",
    "jotai": "^2.10.3",
    "katex": "^0.16.21",
    "lucide-react": "^0.474.0",
    "next": "15.1.6",
    "ogl": "^1.0.11",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-hotkeys-hook": "^4.6.1",
    "react-markdown": "^9.0.3",
    "react-redux": "^9.2.0",
    "react-syntax-highlighter": "^15.6.1",
    "react-textarea-autosize": "^8.5.7",
    "rehype-katex": "^7.0.1",
    "remark-gfm": "^4.0.0",
    "remark-math": "^6.0.0",
    "sonner": "^1.7.4",
    "swr": "^2.2.5",
    "tailwind-merge": "^3.0.1",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.173.0",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@tailwindcss/typography": "^0.5.16",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/react-syntax-highlighter": "^15.5.11",
    "eslint": "^9",
    "eslint-config-next": "15.1.6",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
````

## File: apps/app/postcss.config.mjs
````
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
  },
};

export default config;
````

## File: apps/app/tailwind.config.ts
````typescript
import type { Config } from "tailwindcss";
import plugin from "tailwindcss/plugin";

export default {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx}',
    './src/**/*.{ts,tsx}',
  ],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      borderRadius: {
        none: '0',
        sm: '0.125rem',
        DEFAULT: '0.25rem',
        md: '0.375rem',
        lg: '0.5rem',
        xl: '0.75rem',
        '2xl': '1rem',
        '3xl': '1.5rem',
        full: '9999px',
      },
      colors: {
        background: "var(--background)",
        foreground: "var(--foreground)",
        primary: {
          DEFAULT: "var(--primary)",
          foreground: "var(--primary-foreground)",
        },
        secondary: {
          DEFAULT: "var(--secondary)",
          foreground: "var(--secondary-foreground)",
        },
        destructive: {
          DEFAULT: "var(--destructive)",
          foreground: "var(--destructive-foreground)",
        },
        muted: {
          DEFAULT: "var(--muted)",
          foreground: "var(--muted-foreground)",
        },
        accent: {
          DEFAULT: "var(--accent)",
          foreground: "var(--accent-foreground)",
        },
        popover: {
          DEFAULT: "var(--popover)",
          foreground: "var(--popover-foreground)",
        },
        card: {
          DEFAULT: "var(--card)",
          foreground: "var(--card-foreground)",
        },
        glow: "color-mix(in srgb, var(--glow-color) calc(<alpha-value> * 100%), transparent)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
      typography: {
        DEFAULT: {
          css: {
            color: 'rgb(255 255 255 / 0.8)',
            a: {
              color: 'rgb(96 165 250)',
              '&:hover': {
                color: 'rgb(147 197 253)',
              },
            },
            strong: {
              color: 'rgb(255 255 255 / 0.9)',
            },
            'ol > li::marker': {
              color: 'rgb(255 255 255 / 0.4)',
            },
            'ul > li::marker': {
              color: 'rgb(255 255 255 / 0.4)',
            },
            hr: {
              borderColor: 'rgb(255 255 255 / 0.1)',
            },
            blockquote: {
              borderLeftColor: 'rgb(255 255 255 / 0.1)',
              color: 'rgb(255 255 255 / 0.6)',
            },
            h1: {
              color: 'rgb(255 255 255 / 0.9)',
            },
            h2: {
              color: 'rgb(255 255 255 / 0.9)',
            },
            h3: {
              color: 'rgb(255 255 255 / 0.9)',
            },
            h4: {
              color: 'rgb(255 255 255 / 0.9)',
            },
            'figure figcaption': {
              color: 'rgb(255 255 255 / 0.6)',
            },
            code: {
              color: 'rgb(255 255 255 / 0.8)',
            },
            'a code': {
              color: 'rgb(96 165 250)',
            },
            pre: {
              backgroundColor: 'rgb(255 255 255 / 0.03)',
              color: 'rgb(255 255 255 / 0.8)',
            },
            thead: {
              borderBottomColor: 'rgb(255 255 255 / 0.1)',
            },
            'tbody tr': {
              borderBottomColor: 'rgb(255 255 255 / 0.05)',
            },
          },
        },
      },
    },
  },
  plugins: [
    require("tailwindcss-animate"),
    require('@tailwindcss/typography'),
    plugin(function({ addUtilities, matchUtilities, theme }) {
      addUtilities({
        ".glow-sm": {
          "--glow-size": "15rem",
        },
        ".glow-md": {
          "--glow-size": "25rem",
        },
        ".glow-lg": {
          "--glow-size": "35rem",
        },
      })

      // Add glow variants
      matchUtilities(
        {
          glow: (value) => ({
            "--glow-opacity": value,
          }),
        },
        { values: theme("opacity") }
      )
    }),
  ],
} satisfies Config;
````

## File: apps/app/tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
````

## File: docs/alden-docs/ai/ai_glossary.md
````markdown
# AI System Glossary

## Core Systems

### Reference System
The internal linking and relationship engine.

Components:
- Embedding Generation: Vertex AI multimodal embeddings
- Vector Search: Similarity matching in Supabase
- Link Management: Reference tracking and updates
- Cache System: Embedding and relationship caching

Use Cases:
- Direct mentions (@user)
- Content references (#message)
- File linking
- Space connections
- Topic tracking

### Suggestion System
The smart discovery and ambient intelligence engine.

Components:
- Real-time Analysis: Content and context understanding
- Multi-source Search: Internal and external discovery
- Relevance Ranking: Smart prioritization
- Timing Engine: Contextual delivery

Sources:
- Internal content (vector search)
- Web content (API integrations)
- Environmental data (time, location)
- Cultural context (trending, zeitgeist)
- User patterns (historical analysis)

### Context Engine
The brain coordinating references and suggestions.

Components:
- State Management: Active context tracking
- Pattern Recognition: Usage and interaction patterns
- Emotional Intelligence: Mood and tone analysis
- Environmental Awareness: Situational understanding
- Privacy Guardian: Context boundary management

Functions:
- Reference Coordination: Managing active links
- Suggestion Orchestration: Timing and relevance
- Ambient Intelligence: Environmental adaptation
- Experience Flow: Conversation guidance
- Privacy Control: Context isolation

## Technical Implementation

### Embedding Pipeline
How we understand content:

1. Content Processing:
   - Text analysis
   - Image understanding
   - Voice processing
   - File parsing

2. Embedding Generation:
   - Vertex AI multimodal model
   - Text embeddings
   - Image embeddings
   - Combined representations

3. Storage and Indexing:
   - Supabase vector storage
   - Embedding cache
   - Fast retrieval indexes

### Reference Resolution
How we handle internal links:

1. Detection:
   - Syntax parsing (@, #)
   - Content analysis
   - Pattern matching
   - Context awareness

2. Resolution:
   - Entity lookup
   - Permission checking
   - Cache management
   - Update propagation

3. Presentation:
   - Rich previews
   - Inline display
   - Context preservation
   - State management

### Suggestion Generation
How we create smart suggestions:

1. Analysis:
   - Content understanding
   - Context evaluation
   - Pattern recognition
   - Relevance scoring

2. Discovery:
   - Internal search
   - External APIs
   - Environmental data
   - Cultural context

3. Delivery:
   - Timing optimization
   - UI integration
   - State management
   - User feedback

### Context Management
How we handle ambient intelligence:

1. State Tracking:
   - Active references
   - Current suggestions
   - Environmental state
   - User state

2. Pattern Recognition:
   - Usage patterns
   - Interaction flows
   - Emotional patterns
   - Temporal patterns

3. Intelligence Application:
   - Smart suggestions
   - UI adaptation
   - Flow optimization
   - Privacy management

## Privacy & Security

### Context Isolation
How we maintain privacy boundaries:

1. Boundary Detection:
   - Context analysis
   - Privacy patterns
   - User preferences
   - Sensitivity levels

2. Information Flow:
   - Context filtering
   - Reference isolation
   - Suggestion boundaries
   - Data segregation

3. User Control:
   - Privacy settings
   - Context management
   - Data visibility
   - Flow control

### Data Protection
How we secure user information:

1. Storage:
   - Encrypted vectors
   - Secure caching
   - Access control
   - Data lifecycle

2. Processing:
   - Secure computation
   - Privacy preserving ML
   - Anonymization
   - Audit trails

3. Transmission:
   - Secure channels
   - Context headers
   - Privacy markers
   - Flow control
````

## File: docs/alden-docs/ai/core_features.md
````markdown
# AI Core Features & Implementation

## Overview

This document serves as the central reference for enso's AI features and implementation details. For specific aspects, see:

- [User Stories](../features/ai_stories.md) - Real-world usage scenarios
- [Technical Flow](../architecture/ai_flow.md) - Data and processing pipelines
- [Architecture](../architecture/ai_architecture.md) - System design and components
- [Translation](../features/ai_translation.md) - Language features
- [Inline IDE](../features/inline_ide.md) - Development features
- [Cost Optimization](../operations/cost_optimization.md) - AI resource management

See also our [Manifesto](../vision/manifesto.md) for the philosophy behind our AI implementation.

## Core Features

### 1. Message Intelligence
- **Voice Messages**: Emotional and contextual voice processing
- **Smart References**: Intelligent content linking
- **Thread Intelligence**: Ambient context awareness

### 2. Chat Intelligence
- **Share Context**: Intelligent context preservation
- **Merge Threads**: Smart thread unification
- **Enhance Context**: Ambient intelligence enhancement

### 3. Platform Intelligence
- **Cross-Platform Context**: Unified conversation memory
- **Identity Unification**: Seamless identity management
- **Knowledge Graph**: Universal understanding

## Implementation Details

### Core Services

```typescript
interface AIServices {
  // Message enhancement
  enhanceMessage(content: string): Promise<EnhancedMessage>
  generateSuggestions(context: MessageContext): Promise<Suggestion[]>
  
  // Reference handling
  detectReferences(content: string): Promise<Reference[]>
  generatePreview(reference: Reference): Promise<Preview>
  
  // Context management
  analyzeContext(messages: Message[]): Promise<Context>
  findRelatedContexts(context: Context): Promise<Context[]>
}
```

### Data Flow

1. **Message Processing**
```typescript
async function processMessage(content: string) {
  // 1. Initial analysis
  const analysis = await ai.messageProcessor.analyze(content)
  
  // 2. Enhancement
  const enhanced = await ai.messageProcessor.enhance({
    content,
    analysis
  })
  
  // 3. Suggestions
  const suggestions = await ai.messageProcessor.suggest({
    message: enhanced,
    thread: currentThread
  })

  return { enhanced, suggestions }
}
```

2. **Context Management**
```typescript
async function manageContext(chatId: string) {
  // 1. Get current context
  const context = await getContext(chatId)
  
  // 2. Process context
  const enhanced = await ai.chatProcessor.enhanceContext(context)
  
  // 3. Generate suggestions
  const suggestions = await ai.messageProcessor.suggest(enhanced)

  return { enhanced, suggestions }
}
```

3. **Platform Integration**
```typescript
async function integratePlatform(platform: Platform) {
  // 1. Identity management
  const identities = await ai.platformProcessor.unifyIdentities(
    platform.users
  )
  
  // 2. Context bridging
  const bridge = await ai.platformProcessor.bridgeContext(
    platform.context,
    localContext
  )
  
  // 3. Knowledge sync
  const knowledge = await ai.platformProcessor.syncKnowledge([
    platform,
    localPlatform
  ])

  return { identities, bridge, knowledge }
}
```

## Implementation Status

### Phase 1: Foundation (Current)
- [x] Basic context detection
- [x] Embedding pipeline
- [x] Initial UI components
- [x] Message-level features

### Phase 2: Intelligence (Next)
- [ ] Enhanced context detection
- [ ] Knowledge graph integration
- [ ] Smart suggestions
- [ ] Thread merging

### Phase 3: Ambient Features (Future)
- [ ] Real-time enhancements
- [ ] Predictive suggestions
- [ ] Advanced visualization
- [ ] Context sharing

### Phase 4: Platform Scale (Future)
- [ ] Cross-platform context
- [ ] Universal knowledge graph
- [ ] Community features
- [ ] Enterprise capabilities

## Related Documentation
- [AI Architecture](../architecture/ai_architecture.md): System design details
- [AI Flow](../architecture/ai_flow.md): Data and processing flows
- [AI Stories](../features/ai_stories.md): User scenarios and flows
- [AI Translation](../features/ai_translation.md): Language features
````

## File: docs/alden-docs/ai/index.md
````markdown
# AI Features Overview

> For detailed implementation information, see [Core Features & Implementation](./ai/core_features.md)

## Why Ambient Intelligence?

Our AI implementation focuses on making digital conversations feel more natural and meaningful. For detailed scenarios, see [AI Stories](./features/ai_stories.md).

### The Problem
- Modern communication is fragmented across platforms and contexts
- Important information gets lost in the noise
- Switching contexts is mentally taxing
- Relationships between conversations are hard to track
- Gen Z and Millennials expect fluid, intuitive experiences

### Our Solution
- **Natural Memory**: AI acts like a second brain, naturally surfacing relevant context
- **Fluid Context**: Seamlessly connect conversations across platforms and time
- **Emotional Intelligence**: Understand and preserve the emotional context of interactions
- **Ambient Understanding**: Intelligence that's felt rather than seen
- **Platform Agnostic**: Unified experience across SMS, Slack, Discord, and more

### Target Impact
- **For Social Users**: Make group chats more meaningful and organized
- **For Creators**: Keep track of ideas and inspirations effortlessly
- **For Students**: Connect learning across conversations and resources
- **For Teams**: Preserve and share knowledge naturally
- **For Everyone**: Reduce cognitive load in digital communications

## Implementation

For technical details, see:
- [Core Features & Implementation](./ai/core_features.md)
- [AI Architecture](./architecture/ai_architecture.md)
- [AI Flow](./architecture/ai_flow.md)

## Core Philosophy

enso combines ambient intelligence with natural chat interactions to create a fluid, context-aware messaging experience. Our approach is inspired by:

- **Co-Star's Dramatic Minimalism**: Emotional intelligence in a sophisticated interface
- **ChatGPT's Analytical Power**: Deep understanding and smart suggestions
- **iMessage's Natural Flow**: Intuitive, chat-first experience

## Feature Overview

### 1. Message-Level Intelligence

#### Voice Messages
- Real-time transcription with emotion/tone detection
- Background context awareness
- Smart timestamps and key point extraction
- Voice-specific context linking

#### Smart References
- Multi-format content understanding
- Semantic relationship mapping
- Rich preview generation
- Context-aware suggestions

#### Thread Intelligence
- Real-time context detection
- Semantic relationship mapping
- Smart suggestion system
- Timeline awareness

### 2. Chat-Level Intelligence

#### Share Context
- Smart context detection
- Semantic relationship mapping
- Privacy-aware sharing
- Rich preview generation

#### Merge Threads
- Semantic overlap detection
- Timeline preservation
- Context mapping
- Smart conflict resolution

#### Enhance Context
- Real-time context detection
- Knowledge graph integration
- Smart suggestions
- Resource linking

## Technical Implementation

### 1. Core Services

```typescript
interface ContextEngine {
  // Message-level context
  detectContext(content: string, messageContext: MessageContext): Promise<ContentAnalysis>
  findSimilarContent(embedding: number[], options: SearchOptions): Promise<Reference[]>
  generateSuggestions(content: string, context: MessageContext): Promise<Suggestion[]>
  
  // Chat-level context
  mergeContexts(contexts: Context[]): Promise<Context>
  shareContext(chatId: string, options: ShareOptions): Promise<SharedContext>
  enhanceContext(chatId: string, options: EnhanceOptions): Promise<EnhancedContext>
  
  // Integration methods
  importExternalContext(source: PlatformSource, content: any): Promise<Context>
  bridgeContext(sourceId: string, targetId: string): Promise<ContextBridge>
  unifyIdentities(identities: UnifiedIdentity[]): Promise<UnifiedIdentity>
}

interface EmbeddingService {
  generateEmbedding(text: string): Promise<number[]>
  findSimilar(embedding: number[], options: SimilarityOptions): Promise<SimilarityMatch[]>
  batchProcess(texts: string[]): Promise<number[][]>
  
  // Cross-platform methods
  generatePlatformEmbedding(platform: string, content: any): Promise<number[]>
  findCrossplatformSimilar(embedding: number[], platforms: string[]): Promise<SimilarityMatch[]>
}

interface KnowledgeService {
  // Graph operations
  addNode(type: string, data: any): Promise<string>
  addEdge(from: string, to: string, type: string): Promise<void>
  findConnections(nodeId: string, depth: number): Promise<Connection[]>
  
  // Context operations
  extractKnowledge(content: string): Promise<Knowledge>
  suggestConnections(context: Context): Promise<Suggestion[]>
  generateSummary(nodes: string[]): Promise<Summary>
  
  // Integration methods
  mergePlatformKnowledge(source: PlatformSource, knowledge: Knowledge): Promise<void>
  findCrossplatformConnections(nodeId: string): Promise<Connection[]>
}
```

### 2. Data Models

```typescript
interface MessageContext {
  recentMessages: string[]
  attachedFiles?: File[]
  threadContext?: string
  totalTokens?: number
}

interface ContentAnalysis {
  embedding: number[]
  topics: string[]
  entities: string[]
  sentiment: string
  references?: {
    threads: string[]
    files: string[]
    urls: string[]
  }
  summary?: string
}

interface Reference {
  id: string
  type: 'thread' | 'file' | 'url' | 'user'
  title: string
  preview?: string
  similarity?: number
  metadata?: any
}

interface Context {
  id: string
  type: string
  content: any
  metadata?: any
  embedding?: number[]
  references?: Reference[]
  connections?: Connection[]
}
```

### 3. Integration Points

```typescript
// Message Processing
async function processMessage(content: string, context: MessageContext) {
  // 1. Initial processing
  const analysis = await contextEngine.detectContext(content, context)
  
  // 2. Generate embedding
  const embedding = await embeddingService.generateEmbedding(content)
  
  // 3. Find similar content
  const similar = await embeddingService.findSimilar(embedding, {
    threshold: 0.7,
    limit: 5
  })
  
  // 4. Extract knowledge
  const knowledge = await knowledgeService.extractKnowledge(content)
  
  // 5. Generate suggestions
  const suggestions = await contextEngine.generateSuggestions(content, {
    ...context,
    similar,
    knowledge
  })
  
  return {
    analysis,
    embedding,
    similar,
    knowledge,
    suggestions
  }
}

// Context Management
async function manageContext(chatId: string) {
  // 1. Get current context
  const context = await getContext(chatId)
  
  // 2. Find connections
  const connections = await knowledgeService.findConnections(context.id, 2)
  
  // 3. Generate suggestions
  const suggestions = await knowledgeService.suggestConnections(context)
  
  // 4. Update context
  await contextEngine.enhanceContext(chatId, {
    connections,
    suggestions
  })
}
```

## Implementation Phases

### Phase 1: Foundation (Current)
- Core context detection
- Basic embedding pipeline
- Initial UI components
- Message-level features
- Platform integration foundations
- Identity unification system

### Phase 2: Intelligence
- Enhanced context detection
- Knowledge graph integration
- Smart suggestions
- Thread merging
- Cross-platform context bridging
- Unified knowledge graph

### Phase 3: Ambient Features
- Real-time enhancements
- Predictive suggestions
- Advanced visualization
- Context sharing
- Seamless platform switching
- Universal context awareness

## Next Steps

1. Core Context System
   - Implement ContextEngine
   - Set up embedding pipeline
   - Create detection system

2. UI Development
   - Build context components
   - Enhance message input
   - Create knowledge views

3. Data Integration
   - Set up database schema
   - Implement edge functions
   - Create service layer

4. Testing & Optimization
   - End-to-end testing
   - Performance tuning
   - User feedback loop

5. Integration Layer
   - Implement platform bridges
   - Build identity unification
   - Create context translation layer
````

## File: docs/alden-docs/ai/langchain.md
````markdown
# LangChain Integration

## Overview

LangChain integration provides sophisticated document processing, embedding management, and AI workflow orchestration for Enso's file handling system.

## Core Components

### Document Processing
```typescript
import { 
  PDFLoader, 
  CSVLoader,
  TextLoader 
} from "langchain/document_loaders"

// Document loading pipeline
const processor = new DocumentProcessor({
  chunkSize: 1000,
  chunkOverlap: 200,
  embeddings: vertexAIEmbeddings
})
```

### Vector Store Integration
```typescript
import { SupabaseVectorStore } from "langchain/vectorstores/supabase"

// Supabase vector store setup
const vectorStore = new SupabaseVectorStore(embeddings, {
  client: supabase,
  tableName: "embeddings",
  queryName: "match_documents"
})
```

### Chat Models & Agents
```typescript
import { ChatOpenRouter } from "langchain/chat_models"
import { initializeAgentExecutorWithOptions } from "langchain/agents"

// Chat model setup
const model = new ChatOpenRouter({
  baseURL: "https://openrouter.ai/api/v1",
  apiKey: process.env.OPENROUTER_API_KEY,
  modelName: "deepseek/deepseek-chat"
})
```

## Implementation

### 1. Document Loading
- Smart loader selection based on file type
- Proper chunking strategies
- Metadata extraction
- Error handling

### 2. Embedding Generation
- Vertex AI multimodal embeddings
- Caching and deduplication
- Batch processing
- Cost optimization

### 3. Vector Search
- Approximate nearest neighbors
- Hybrid search (keyword + semantic)
- Context-aware retrieval
- Privacy boundaries

### 4. Chat Integration
- Context injection
- Reference tracking
- Knowledge graph updates
- Suggestion generation

## Usage Examples

### Document Processing
```typescript
// Load and process a document
const docs = await processor.loadDocument(file)
const chunks = await processor.chunkDocument(docs)
await processor.storeEmbeddings(chunks)
```

### Semantic Search
```typescript
// Search for similar content
const results = await vectorStore.similaritySearch(query, {
  k: 5,
  filter: { chatId }
})
```

### Chat Workflows
```typescript
// Generate response with context
const response = await model.generateResponse(
  messages,
  await vectorStore.relevantContext(query)
)
```

## Cost Optimization

### Caching Strategy
- Cache embeddings for frequent content
- Implement LRU eviction
- Use tiered storage

### Batch Processing
- Group similar operations
- Use background workers
- Implement rate limiting

### Smart Routing
- Route to appropriate models
- Optimize context windows
- Use cached results when possible

## Security & Privacy

### Data Access
- Respect user permissions
- Implement context boundaries
- Sanitize sensitive information

### Content Filtering
- Implement content moderation
- Handle restricted content
- Maintain audit logs

## Error Handling

### Graceful Degradation
- Fallback strategies
- Partial results handling
- User feedback

### Monitoring
- Error tracking
- Performance metrics
- Usage analytics

## Next Steps

1. **Core Implementation**
   - [ ] Set up document loaders
   - [ ] Configure vector store
   - [ ] Implement chat models

2. **Integration**
   - [ ] Connect to file upload flow
   - [ ] Add context processing
   - [ ] Enable chat features

3. **Optimization**
   - [ ] Implement caching
   - [ ] Add batch processing
   - [ ] Monitor costs

4. **Security**
   - [ ] Add access controls
   - [ ] Implement filtering
   - [ ] Set up monitoring
````

## File: docs/alden-docs/architecture/ai_architecture.md
````markdown
# AI Architecture & Implementation Guide

## Overview

This document details the technical implementation of enso's AI features. For related documentation, see:

### Feature Documentation
- [Core Features & Implementation](../ai/core_features.md) - Feature specifications
- [User Stories](../features/ai_stories.md) - Usage scenarios
- [Technical Flow](./ai_flow.md) - Data pipelines
- [Inline IDE](../features/inline_ide.md) - Development features

### Technical Details
- [Cost Optimization](../operations/cost_optimization.md) - Resource management
- [Schema](../implementation/backend/schema.md) - Database design
- [Functions](../implementation/backend/functions.md) - Edge functions

### Vision & Strategy
- [Manifesto](../vision/manifesto.md) - Core principles
- [Marketing](../vision/marketing.md) - Go-to-market strategy

## Vision & Philosophy

Our AI implementation is guided by the principles outlined in [@manifesto.md](../vision/manifesto.md):

1. **Ambient Intelligence**: Intelligence that's felt, not seen
2. **Fluid Context**: Interconnected webs of meaning
3. **Spatial Memory**: Digital conversations with a sense of place
4. **Predictive Intelligence**: Anticipating needs naturally
5. **Emotional Intelligence**: Preserving human connection
6. **Seamless Learning**: Growing through natural interaction

## Core Features & Implementation

For detailed feature specifications, see [Core Features & Implementation](../ai/core_features.md).

### 1. Message-Level Intelligence (PlusMenu)

See [Message Intelligence Stories](../features/ai_stories.md#message-level-intelligence-plusmenu) for user scenarios.

#### Code Generation & Analysis
```typescript
interface CodeFeature {
  // Real-time code generation
  generateCode(prompt: string, context: CodeContext): Promise<string>
  
  // Repository analysis
  analyzeRepo(url: string): Promise<RepoAnalysis>
  
  // Autonomous coding mode
  runAgent(task: string, context: CodeContext): Promise<AgentResult>
}

interface CodeContext {
  repoUrl?: string
  language?: string
  framework?: string
  previousCode?: string
  relatedSnippets?: CodeReference[]
}
```

#### Voice Messages
```typescript
interface VoiceFeature {
  // Real-time processing
  transcribe(audio: Blob): Promise<Transcription>
  detectEmotion(audio: Blob): Promise<EmotionAnalysis>
  enhanceAudio(audio: Blob): Promise<Blob>
  
  // Context integration
  linkVoiceContext(transcription: string): Promise<VoiceContext>
}
```

#### Smart References
```typescript
interface ReferenceFeature {
  // Content understanding
  detectReferences(content: string): Promise<Reference[]>
  generatePreview(ref: Reference): Promise<Preview>
  findSimilar(ref: Reference): Promise<Reference[]>
  
  // Context mapping
  mapRelationships(refs: Reference[]): Promise<RelationshipGraph>
}
```

### 2. Chat-Level Intelligence (ChatMenu)

#### Share Context
```typescript
interface ShareFeature {
  // Context management
  detectShareableContext(chatId: string): Promise<ShareableContext>
  generatePreview(context: Context): Promise<ContextPreview>
  
  // Privacy controls
  filterSensitiveInfo(context: Context): Promise<Context>
  generateAccessControls(context: Context): Promise<AccessPolicy>
}
```

#### Merge Threads
```typescript
interface MergeFeature {
  // Thread operations
  findMergeableCandidates(threadId: string): Promise<Thread[]>
  analyzeMergeConflicts(threads: Thread[]): Promise<ConflictAnalysis>
  mergeThreads(threads: Thread[]): Promise<MergedThread>
  
  // Timeline management
  preserveTimeline(threads: Thread[]): Promise<Timeline>
}
```

#### Enhance Context
```typescript
interface EnhanceFeature {
  // Context enhancement
  analyzeContext(chatId: string): Promise<ContextAnalysis>
  generateSuggestions(context: Context): Promise<Suggestion[]>
  buildKnowledgeGraph(context: Context): Promise<KnowledgeGraph>
}
```

## UI Integration

### 1. Component Architecture

```typescript
// Core AI components
interface AIComponents {
  ContextBar: React.FC<ContextBarProps>
  CodePanel: React.FC<CodePanelProps>
  VoicePanel: React.FC<VoicePanelProps>
  ReferencePanel: React.FC<ReferencePanelProps>
  KnowledgeGraph: React.FC<GraphProps>
}

// Enhanced existing components
interface EnhancedComponents {
  MessageInput: React.FC<MessageInputProps & AIFeatures>
  MessageBubble: React.FC<MessageBubbleProps & AIContext>
  ChatHeader: React.FC<ChatHeaderProps & AIControls>
}
```

### 2. Visual Design

Following our [Context & Development Guidelines](./context.md):

```typescript
// Design system integration
interface AIDesignSystem {
  // Base styles
  colors: {
    accent: string[]
    semantic: Record<string, string>
    gradients: Record<string, string>
  }
  
  // Animation presets
  animations: {
    contextReveal: MotionProps
    intelligentTransition: MotionProps
    ambientPulse: MotionProps
  }
  
  // Layout patterns
  layouts: {
    contextBar: StyleProps
    codePanel: StyleProps
    knowledgeGraph: StyleProps
  }
}
```

## Integration Points

As detailed in [@integrations.md](./integrations.md), our AI features seamlessly integrate with external platforms:

```typescript
interface PlatformBridge {
  // Platform connections
  importContext(source: PlatformSource): Promise<Context>
  exportContext(context: Context, target: Platform): Promise<void>
  
  // Identity management
  unifyIdentities(identities: Identity[]): Promise<UnifiedIdentity>
  
  // Context translation
  translateContext(context: Context, platform: Platform): Promise<Context>
}
```

## Implementation Flow

See [@ai_flow.md](./ai_flow.md) for detailed flow diagrams and sequence charts.

### 1. Message Processing
```typescript
async function processMessage(content: string, context: MessageContext) {
  // 1. Initial analysis
  const analysis = await contextEngine.detectContext(content, context)
  
  // 2. Generate embeddings
  const embedding = await embeddingService.generateEmbedding(content)
  
  // 3. Find similar content
  const similar = await embeddingService.findSimilar(embedding)
  
  // 4. Extract knowledge
  const knowledge = await knowledgeService.extractKnowledge(content)
  
  // 5. Generate suggestions
  return await contextEngine.generateSuggestions(content, {
    analysis,
    similar,
    knowledge
  })
}
```

### 2. Context Management
```typescript
async function manageContext(chatId: string) {
  // 1. Analyze current context
  const context = await contextEngine.analyzeContext(chatId)
  
  // 2. Build knowledge graph
  const graph = await knowledgeService.buildKnowledgeGraph(context)
  
  // 3. Generate enhancements
  const enhancements = await contextEngine.generateEnhancements(context)
  
  // 4. Update UI
  return {
    context,
    graph,
    enhancements
  }
}
```

## User Stories

See [@ai_stories.md](./ai_stories.md) for detailed user stories covering:
- Social interactions
- Professional collaboration
- Creative workflows
- Knowledge management
- Code discussions
- Sports conversations
- Educational contexts

## Implementation Phases

### Phase 1: Foundation (Current)
- Basic context detection
- Code generation in PlusMenu
- Voice message recording
- Reference detection

### Phase 2: Intelligence
- Enhanced code generation
- Emotion detection
- Context sharing
- Thread merging

### Phase 3: Ambient Features
- Autonomous coding
- Cross-chat context
- Ambient suggestions
- Knowledge visualization

## Next Steps

1. Core Implementation
   - Set up AI services
   - Implement context engine
   - Build embedding pipeline

2. UI Development
   - Create AI components
   - Enhance existing components
   - Implement animations

3. Platform Integration
   - Build platform bridges
   - Implement identity system
   - Create context translation

4. Testing & Optimization
   - End-to-end testing
   - Performance tuning
   - User feedback loop

## Related Documentation
- [@manifesto.md](./manifesto.md) - Core principles and vision
- [@context.md](./context.md) - Development guidelines
- [@ai_flow.md](./ai_flow.md) - Technical flows and diagrams
- [@ai_stories.md](./ai_stories.md) - User stories and scenarios
- [@integrations.md](./integrations.md) - Platform integration details
- [@sidebar.md](./sidebar.md) - UI component documentation
````

## File: docs/alden-docs/architecture/ai_flow.md
````markdown
# AI Flow & Implementation

## Core Services

### 1. Context Engine
```typescript
interface ContextEngine {
  // Message-level context
  detectContext(content: string, messageContext: MessageContext): Promise<ContentAnalysis>
  findSimilarContent(embedding: number[], options: SearchOptions): Promise<Reference[]>
  generateSuggestions(content: string, context: MessageContext): Promise<Suggestion[]>

  // Chat-level context
  mergeContexts(contexts: Context[]): Promise<Context>
  shareContext(chatId: string, options: ShareOptions): Promise<SharedContext>
  enhanceContext(chatId: string, options: EnhanceOptions): Promise<EnhancedContext>

  // Integration methods
  importContext(source: PlatformSource, content: any): Promise<Context>
  bridgeContexts(sourceId: string, targetId: string): Promise<ContextBridge>
  unifyIdentities(identities: UnifiedIdentity[]): Promise<UnifiedIdentity>
}

interface MessageContext {
  recentMessages: string[]
  attachedFiles?: File[]
  threadContext?: string
  totalTokens?: number
}

interface ContentAnalysis {
  embedding: number[]
  topics: string[]
  entities: string[]
  sentiment: string
  references?: {
    threads: string[]
    files: string[]
    urls: string[]
  }
  summary?: string
}

interface PlatformSource {
  type: 'slack' | 'discord' | 'sms' | 'native'
  id: string
  metadata: {
    workspace?: string
    server?: string
    channel?: string
    thread?: string
  }
}

interface ContextBridge {
  sourceContext: Context
  targetContext: Context
  mapping: {
    identities: Map<string, string>
    references: Map<string, string>
    timeline: TimelineMapping
  }
}
```

### 2. Embedding Service
```typescript
interface EmbeddingService {
  generateEmbedding(text: string): Promise<number[]>
  findSimilar(embedding: number[], options: {
    threshold?: number
    limit?: number
    includeFiles?: boolean
    includedChats?: string[]
  }): Promise<SimilarityMatch[]>
  batchProcess(texts: string[]): Promise<number[][]>
  generatePlatformEmbedding(type: string, content: string): Promise<number[]>
  findCrossplatformSimilar(embedding: number[], options: {
    platforms: string[]
    threshold?: number
    limit?: number
  }): Promise<SimilarityMatch[]>
}
```

### 3. Knowledge Service
```typescript
interface KnowledgeService {
  // Graph operations
  addNode(type: string, data: any): Promise<string>
  addEdge(from: string, to: string, type: string): Promise<void>
  findConnections(nodeId: string, depth: number): Promise<Connection[]>
  
  // Context operations
  extractKnowledge(content: string): Promise<Knowledge>
  suggestConnections(context: Context): Promise<Suggestion[]>
  generateSummary(nodes: string[]): Promise<Summary>
  mergePlatformKnowledge(source: PlatformSource, knowledge: Knowledge): Promise<void>
}
```

## Message Flow

### 1. Cross-Platform Message Processing
```typescript
async function processCrossplatformMessage(
  content: string,
  source: PlatformSource,
  context: MessageContext
) {
  // 1. Import external context
  const externalContext = await contextEngine.importContext(source, content)

  // 2. Generate platform-specific embedding
  const embedding = await embeddingService.generatePlatformEmbedding(
    source.type,
    content
  )
  
  // 3. Find similar content across platforms
  const similar = await embeddingService.findCrossplatformSimilar(embedding, {
    platforms: ['slack', 'discord', 'sms', 'native'],
    threshold: 0.7,
    limit: 5
  })
  
  // 4. Extract and merge knowledge
  const knowledge = await knowledgeService.extractKnowledge(content)
  await knowledgeService.mergePlatformKnowledge(source, knowledge)
  
  // 5. Generate unified suggestions
  const suggestions = await contextEngine.generateSuggestions(content, {
    ...context,
    externalContext,
    similar,
    knowledge
  })
  
  return {
    externalContext,
    embedding,
    similar,
    knowledge,
    suggestions
  }
}
```

### 2. Context Bridging
```typescript
async function bridgePlatformContexts(sourceId: string, targetId: string) {
  // 1. Create context bridge
  const bridge = await contextEngine.bridgeContexts(sourceId, targetId)

  // 2. Unify identities
  const unifiedIdentities = await contextEngine.unifyIdentities(
    bridge.mapping.identities
  )
  
  // 3. Map references
  await Promise.all(
    Array.from(bridge.mapping.references).map(([source, target]) =>
      knowledgeService.addEdge(source, target, 'cross_platform_reference')
    )
  )
  
  // 4. Sync timeline
  await syncTimeline(bridge.mapping.timeline)
  
  return {
    bridge,
    unifiedIdentities
  }
}
```

## UI Components

### 1. Context Components
```typescript
interface ContextBarProps {
  chatId: string
  suggestions: Suggestion[]
  onEnhance: () => void
  }
  
interface ContextPreviewProps {
  context: Context
  similar: SimilarityMatch[]
  onNavigate: (id: string) => void
  }
  
interface ContextTileProps {
  type: ContextType
  data: any
  similarity?: number
}
```

### 2. Enhanced Chat
```typescript
interface EnhancedChatProps {
  chat: Chat
  context: Context
  suggestions: Suggestion[]
  onShare: () => void
  onMerge: (ids: string[]) => void
  }
```
  
### 3. Knowledge UI
```typescript
interface KnowledgeGraphProps {
  nodes: Node[]
  edges: Edge[]
  onNodeSelect: (id: string) => void
  }
  
interface ConnectionListProps {
  connections: Connection[]
  onNavigate: (id: string) => void
}
```

## Implementation Phases

### Phase 1: Foundation (Current)
- Core context detection
- Basic embedding pipeline
- Initial UI components
- Message-level intelligence
- Basic platform integration
- Identity mapping

### Phase 2: Intelligence
- Enhanced context detection
- Knowledge graph integration
- Smart suggestions
- Thread merging
- Cross-platform context
- Unified knowledge base

### Phase 3: Ambient Features
- Real-time enhancements
- Predictive suggestions
- Advanced visualization
- Context sharing
- Seamless platform switching
- Universal context awareness

## Next Steps

1. Implement core context service
   - Set up Vertex AI integration
   - Build embedding pipeline
   - Create context detection system

2. Develop UI components
   - Context bar
   - Enhanced message input
   - Knowledge visualization

3. Build knowledge service
   - Graph database setup
   - Connection detection
   - Suggestion generation

4. Integration & testing
   - End-to-end testing
   - Performance optimization
   - User feedback loop

5. Integration Layer
   - Platform bridges
   - Identity unification
   - Context translation
````

## File: docs/alden-docs/architecture/integrations.md
````markdown
# Platform Integrations Strategy

## Core Philosophy

Our approach to platform integrations must align with our AI-native vision, where intelligence is felt rather than seen. Integrations should feel like natural extensions of conversation memory rather than bolted-on features.

## Design Principles

### 1. Seamless Memory Transfer
- Conversations from external platforms should feel like memories being recalled
- Import process should feel like remembering rather than copying
- Context and relationships should be preserved and enhanced
- Historical context should be immediately available and naturally surfaced

### 2. Fluid Identity Management
- Users should exist in a unified identity space
- External platform identities should be treated as facets of the same person
- Missing participants should be handled gracefully with placeholder identities
- Identity merging should happen naturally as users join
  
### 3. Contextual Intelligence
- AI should understand context across platform boundaries
- References should work seamlessly across imported and native conversations
- Platform-specific features should be translated into enso's universal context
- Historical context should inform current conversations
  
## Platform-Specific Approaches

### SMS/Phone Integration
- **Import Process**: 
  - One-click import from phone backup
  - Real-time processing and embedding of messages
  - Automatic thread organization and context building
- **Identity Handling**:
  - Phone numbers treated as identity anchors
  - Automatic contact info enrichment
  - Graceful handling of unknown participants
- **Continuity**:
  - Seamless transition between SMS and enso
  - Bidirectional sync where possible
  - Context preservation across platforms
  
### Slack Integration
- **Enso Bot**:
  - Minimal, elegant presence in Slack
  - Intelligent thread selection and import
  - Context-aware responses and suggestions
- **Thread Bridging**:
  - Selected threads appear as native enso conversations
  - Automatic context preservation and enhancement
  - Smart participant mapping between platforms
- **Identity Management**:
  - Workspace-aware identity handling
  - Automatic workspace context preservation
  - Smart handling of multi-workspace identities
  
### Discord Integration
- **Community Bridge**:
  - Channel-specific integration
  - Role-aware access control
  - Context-preserving thread imports
- **Identity Handling**:
  - Server-specific identity management
  - Role-based permission mapping
  - Graceful handling of anonymous users

## Technical Implementation

### Core Components
- **Identity Service**:
```typescript
  interface UnifiedIdentity {
    id: string
    platforms: {
      enso?: { id: string, email: string }
      slack?: { workspaceId: string, userId: string }
      discord?: { serverId: string, userId: string }
      sms?: { phoneNumber: string }
}
    displayName: string
    avatarUrl?: string
}
```

- **Context Bridge**:
```typescript
  interface ContextBridge {
    sourceType: 'slack' | 'discord' | 'sms'
    sourceId: string
    ensoThreadId: string
    participants: UnifiedIdentity[]
    contextualMetadata: {
      platform_specific_data: any
      embeddings: number[]
      references: Reference[]
  }
}
```

### Integration Flow
1. **Platform Connection**:
   - OAuth-based authentication where applicable
   - Secure credential storage
   - Platform-specific API initialization
  
2. **Import Process**:
   - Chunked data retrieval
   - Real-time processing and embedding
   - Context graph building
   - Identity mapping and placeholder creation
  
3. **Sync Management**:
   - Event-based updates
   - Bidirectional state management
   - Conflict resolution
   - Context preservation
    
## User Experience Considerations
  
### 1. Onboarding
- Gentle introduction to integration capabilities
- Progressive disclosure of advanced features
- Clear privacy and data handling explanations
- Immediate value demonstration

### 2. Identity Merging
- Natural discovery of identity connections
- Smooth handling of multiple platform identities
- Clear user control over identity merging
- Privacy-respecting identity management
  
### 3. Context Surfacing
- Intelligent surfacing of cross-platform context
- Natural integration of imported conversations
- Seamless reference handling across platforms
- Intuitive navigation between contexts

## Privacy and Security

### 1. Data Handling
- Clear user control over imported data
- Secure storage of platform credentials
- Privacy-preserving identity management
- Regular data sync and cleanup

### 2. Permission Management
- Granular control over platform access
- Clear visibility of cross-platform sharing
- Role-based access control
- Regular permission auditing

## Future Considerations
    
### 1. Platform Expansion
- Evaluate additional platforms based on user needs
- Maintain consistent integration philosophy
- Ensure scalable identity management
- Preserve seamless user experience

### 2. AI Enhancement
- Continuous improvement of context understanding
- Enhanced cross-platform reference detection
- Smarter identity merging
- More natural platform bridging

### 3. User Experience Evolution
- Monitor and adapt to usage patterns
- Enhance discovery of integrated content
- Improve cross-platform navigation
- Maintain consistent feel across platforms
````

## File: docs/alden-docs/design/influences.md
````markdown
# Design Influences & Implementation

## Core Influences

### Co-Star's Dramatic Minimalism
- **Typography**: Dramatic size contrasts and sophisticated font choices
- **Spacing**: Expansive whitespace and considered layout rhythm
- **States**: Bold, clear state transitions with personality
- **Content**: Direct, impactful messaging

### Teenage Engineering's Utilitarian Elegance
- **Grid**: Precise, functional layout systems
- **Interaction**: Focused, mechanical feedback
- **Density**: High information density when needed
- **Details**: Precise, intentional micro-interactions

### Rabbit R1's Fluid Intelligence
- **Context**: Seamless contextual awareness
- **Transitions**: Smooth, intelligent state changes
- **Assistance**: Natural, helpful suggestions
- **Learning**: Adaptive user patterns

### Cursor's Development Flow
- **Prompting**: Natural language code generation
- **Context**: Intelligent code understanding
- **Preview**: Real-time code visualization
- **Iteration**: Fluid development cycle

### WhatsApp's Universal Access
- **Reliability**: Rock-solid message delivery
- **Simplicity**: Clear, focused interactions
- **Media**: Rich media handling
- **Groups**: Seamless group dynamics

### iMessage's Native Feel
- **Polish**: Buttery smooth animations
- **Threading**: Natural conversation flow
- **Integration**: Deep system integration
- **Reactions**: Expressive micro-interactions

## Implementation Guidelines

### Typography System
```typescript
interface TypographySystem {
  // Co-Star inspired scale
  scale: {
    display: '4rem'      // Dramatic headlines
    title: '2.5rem'      // Section titles
    subtitle: '1.5rem'   // Supporting text
    body: '1rem'         // Main content
    detail: '0.875rem'   // Supporting details
    micro: '0.75rem'     // Micro text
  }

  // Weight distribution
  weights: {
    dramatic: 700    // Key moments
    medium: 500     // Interactive elements
    normal: 400     // Body text
    subtle: 300     // Supporting text
  }

  // Sophisticated spacing
  spacing: {
    dramatic: '3rem'     // Section breaks
    comfortable: '2rem'  // Content blocks
    default: '1rem'     // Standard spacing
    tight: '0.5rem'     // Compact elements
  }
}
```

### Grid System
```typescript
interface GridSystem {
  // TE-inspired precision
  grid: {
    base: 8,           // Base unit
    columns: 12,       // Standard grid
    gutters: '1rem',   // Column spacing
    margins: '2rem'    // Edge spacing
  }

  // Layout patterns
  patterns: {
    focused: 'single-column'   // Content focus
    split: 'two-column'        // Side-by-side
    dashboard: 'grid'          // Information display
  }

  // Density modes
  density: {
    spacious: 1.5,    // Default mode
    compact: 1,       // Dense information
    minimal: 0.75     // Maximum density
  }
}
```

### Interaction Model
```typescript
interface InteractionModel {
  // R1 & Cursor inspired intelligence
  intelligence: {
    awareness: 'ambient'    // Background intelligence
    suggestions: 'timely'   // Contextual help
    learning: 'adaptive'    // Pattern recognition
    coding: 'natural'      // Code generation
  }

  // WhatsApp & iMessage inspired messaging
  messaging: {
    delivery: 'reliable'    // Message handling
    threading: 'natural'    // Conversation flow
    media: 'rich'          // Media support
    reactions: 'expressive' // Quick responses
  }

  // TE-inspired feedback
  feedback: {
    visual: 'precise'     // Clear indicators
    haptic: 'mechanical'  // Tactile response
    audio: 'minimal'      // Subtle sounds
  }

  // Co-Star inspired states
  states: {
    emphasis: 'dramatic'    // Bold transitions
    timing: 'considered'    // Thoughtful pacing
    messaging: 'direct'     // Clear communication
  }
}
```

### Development Experience
```typescript
interface DevelopmentFlow {
  // Cursor inspired coding
  coding: {
    prompt: 'natural'      // Language-based coding
    preview: 'immediate'   // Real-time results
    context: 'intelligent' // Code understanding
    iteration: 'fluid'     // Quick refinement
  }

  // WhatsApp inspired reliability
  reliability: {
    sync: 'robust'        // Data synchronization
    offline: 'graceful'   // Offline handling
    recovery: 'automatic' // Error recovery
  }

  // iMessage inspired polish
  polish: {
    animations: 'smooth'   // Fluid transitions
    feedback: 'immediate'  // Quick responses
    integration: 'deep'    // System features
  }
}
```

## Component Examples

### Message System
```typescript
interface MessageSystem {
  // WhatsApp inspired delivery
  delivery: {
    status: 'sent' | 'delivered' | 'read'
    retry: 'automatic'
    sync: 'multi-device'
  }

  // iMessage inspired interactions
  interactions: {
    reactions: string[]
    replies: ThreadStyle
    effects: AnimationStyle
  }

  // Cursor inspired code handling
  code: {
    preview: PreviewStyle
    execution: ExecutionStyle
    context: ContextStyle
  }
}
```

### Development Panel
```typescript
interface DevelopmentPanel {
  // Cursor inspired features
  features: {
    prompting: PromptStyle
    preview: PreviewStyle
    context: ContextStyle
  }

  // TE inspired layout
  layout: {
    grid: GridSystem
    density: DensityMode
  }

  // Co-Star inspired typography
  typography: TypographySystem
}
```

## Usage Guidelines

### Message Handling
1. **Delivery (WhatsApp)**
   - Reliable message delivery
   - Offline support
   - Multi-device sync

2. **Interaction (iMessage)**
   - Smooth animations
   - Rich reactions
   - Deep integration

3. **Development (Cursor)**
   - Natural prompting
   - Instant preview
   - Context awareness

### Visual Language
1. **Typography (Co-Star)**
   - Dramatic contrast
   - Clear hierarchy
   - Sophisticated scale

2. **Layout (TE)**
   - Precise grid
   - Focused density
   - Mechanical rhythm

3. **Intelligence (R1)**
   - Contextual awareness
   - Smart assistance
   - Adaptive learning

## Implementation Checklist

### Core Features
- [ ] Message delivery system
- [ ] Development environment
- [ ] Intelligence layer
- [ ] Visual system

### Polish & Integration
- [ ] Animation system
- [ ] Reaction system
- [ ] Preview system
- [ ] Context system

### Intelligence Layer
- [ ] Context awareness
- [ ] Code generation
- [ ] Smart suggestions
- [ ] Learning system
````

## File: docs/alden-docs/design/system.md
````markdown
# enso Design System

## Core Influences & Philosophy

Our design system is primarily influenced by:
- **Stable Audio's Async UX**: Elegant handling of background tasks and credit consumption
- **ChatGPT's Intelligence**: Subtle indicators of AI processing
- **Cursor's Reference System**: Seamless code and context integration

## Async UI/UX Patterns

### Credit System
```typescript
interface CreditUI {
  // Visual representation
  indicators: {
    balance: string
    cost: string
    pending: string
  }
  
  // States
  states: {
    available: 'Ready to use'
    consuming: 'Using credit...'
    consumed: 'Credit used'
    refunded: 'Credit refunded'
    error: 'Failed - credit returned'
  }
  
  // Animations
  animations: {
    consume: 'fade-scale'
    refund: 'slide-fade'
    error: 'shake'
  }
}
```

### Background Tasks
```typescript
interface TaskUI {
  // Task states
  states: {
    queued: 'Starting soon...'
    running: 'Processing in background'
    paused: 'Paused - resume?'
    completed: 'Ready for review'
    failed: 'Task failed'
  }
  
  // Progress indicators
  progress: {
    type: 'determinate' | 'indeterminate'
    position: 'inline' | 'floating'
    showPercentage: boolean
  }
  
  // Controls
  controls: {
    pause: boolean
    cancel: boolean
    background: boolean
  }
}
```

### Notification System
```typescript
interface NotificationUI {
  // Types
  types: {
    credit: 'Credit update'
    task: 'Task status'
    result: 'Result ready'
    error: 'Task failed'
  }
  
  // Positions
  positions: {
    task: 'inline'
    credit: 'top-right'
    result: 'bottom-right'
  }
  
  // Persistence
  persistence: {
    credit: '3s'
    task: 'until-dismissed'
    result: '5s'
  }
}
```

## Design Tokens

### Typography
```typescript
interface Typography {
  fonts: {
    sans: 'Inter var'
    mono: 'JetBrains Mono'
  }
  weights: {
    normal: 400
    medium: 500
    semibold: 600
  }
  sizes: {
    xs: '0.75rem'
    sm: '0.875rem'
    base: '1rem'
    lg: '1.125rem'
  }
}
```

### Colors
```typescript
interface Colors {
  // Brand colors
  brand: {
    blue: '#178bf1'
    indigo: '#4f46e5'
  }
  
  // Task states
  task: {
    queued: '#9ca3af'
    running: '#3b82f6'
    completed: '#10b981'
    failed: '#ef4444'
  }
  
  // Credit states
  credit: {
    available: '#10b981'
    consuming: '#3b82f6'
    consumed: '#6b7280'
    refunded: '#f59e0b'
  }
  
  // UI colors
  ui: {
    background: '#000000'
    foreground: '#ffffff'
    muted: 'rgba(255, 255, 255, 0.1)'
    border: 'rgba(255, 255, 255, 0.05)'
  }
}
```

### Animation
```typescript
interface Animation {
  durations: {
    instant: '100ms'
    fast: '200ms'
    normal: '300ms'
    slow: '500ms'
  }
  
  easings: {
    default: 'cubic-bezier(0.4, 0, 0.2, 1)'
    in: 'cubic-bezier(0.4, 0, 1, 1)'
    out: 'cubic-bezier(0, 0, 0.2, 1)'
  }
  
  patterns: {
    taskStart: {
      opacity: [0, 1],
      scale: [0.95, 1]
    },
    creditConsume: {
      opacity: [1, 0],
      translateY: [0, -10]
    },
    resultAppear: {
      opacity: [0, 1],
      translateY: [10, 0]
    }
  }
}
```

## Components

### TaskCard
```typescript
interface TaskCard {
  // Visual properties
  variant: 'inline' | 'floating'
  size: 'sm' | 'md' | 'lg'
  
  // Content
  title: string
  description: string
  progress: number
  
  // Interaction
  onBackground: () => void
  onCancel: () => void
  onResume: () => void
}
```

### CreditBadge
```typescript
interface CreditBadge {
  // Display
  value: number
  size: 'sm' | 'md'
  variant: 'balance' | 'cost'
  
  // States
  loading: boolean
  error: boolean
  
  // Animation
  animate: boolean
  onComplete: () => void
}
```

### TaskProgress
```typescript
interface TaskProgress {
  // Progress
  value: number
  indeterminate: boolean
  
  // Display
  showLabel: boolean
  size: 'sm' | 'md' | 'lg'
  
  // States
  state: TaskState
  error?: string
}
```

## Implementation

### Task Container
```typescript
function TaskContainer({ task, onBackground }: TaskContainerProps) {
  return (
    <div className="task-card">
      <div className="task-header">
        <TaskTitle>{task.title}</TaskTitle>
        <CreditBadge value={task.creditCost} />
      </div>
      
      <TaskProgress
        value={task.progress}
        state={task.state}
      />
      
      <TaskControls
        onBackground={onBackground}
        onCancel={task.cancel}
      />
    </div>
  )
}
```

### Credit System
```typescript
function CreditSystem() {
  return (
    <div className="credit-container">
      <CreditBalance value={balance} />
      <CreditHistory items={history} />
      <PendingCredits tasks={pendingTasks} />
    </div>
  )
}
```

## Usage Guidelines

### Task Management
- Show clear progress indicators
- Allow immediate backgrounding
- Provide cancel option
- Show credit cost upfront

### Credit Handling
- Abstract complexity
- Show clear feedback
- Handle errors gracefully
- Provide usage history

### Notifications
- Keep non-intrusive
- Show important updates
- Allow quick actions
- Clear automatically

### Animation
- Keep subtle
- Indicate state changes
- Show progress clearly
- Maintain smoothness
````

## File: docs/alden-docs/development/llm_driven.md
````markdown
# LLM-Driven Development Guidelines

## Design Philosophy

Our development process combines:
1. Co-Star's dramatic minimalism and sophisticated typography
2. Teenage Engineering's utilitarian elegance and focused interactions
3. Rabbit R1's fluid intelligence and contextual awareness
4. Natural language development through chat

## Interaction Patterns

### Quick Actions & Shortcuts
```typescript
interface QuickActions {
  // Message composition shortcuts
  messageShortcuts: {
    ':': 'emoji picker',      // Slack-like emoji picker
    '@': 'user mention',      // User mentions
    '#': 'thread reference',  // Thread references
    '>': 'quote/reply',       // Quote or reply to message
    '/': 'commands',          // Slash commands
    '!': 'file reference'     // File references
  }

  // Global keyboard shortcuts
  globalShortcuts: {
    'cmd+k': 'search',          // Global search
    'cmd+/': 'command palette', // Command palette
    'cmd+.': 'quick settings',  // Quick settings
    'cmd+p': 'plus menu',       // Open plus menu
    'cmd+e': 'emoji picker'     // Global emoji picker
  }

  // Context-aware actions
  contextActions: {
    type: 'message' | 'thread' | 'file' | 'user'
    triggers: string[]
    suggestions: Suggestion[]
    handler: (context: Context) => void
  }
}

interface EmojiPickerContext {
  // Recent and frequently used
  recentEmojis: string[]
  frequentEmojis: string[]
  
  // Smart suggestions
  contextualSuggestions: {
    messageContext?: string    // Based on message content
    threadContext?: string     // Based on thread topic
    userContext?: string      // Based on user preferences
  }
  
  // Custom emoji support
  workspaceEmojis?: {
    name: string
    url: string
    tags: string[]
  }[]
}
```

### Implementation Priority

1. **Core Message Input Enhancements**
   - Implement basic trigger detection (`:`, `@`, `#`, etc.)
   - Add inline suggestion UI
   - Set up keyboard shortcut system
   - Create base suggestion components

2. **Plus Menu & Chat Menu Integration**
   - Enable core menu items
   - Add keyboard shortcuts
   - Implement hover states
   - Add basic animations

3. **Emoji Picker Enhancement**
   - Build base emoji picker
   - Add recent/frequent tracking
   - Implement contextual suggestions
   - Add custom emoji support

4. **Context-Aware Suggestions**
   - Implement suggestion engine
   - Add real-time filtering
   - Create preview components
   - Enable keyboard navigation

### Smart Suggestions

```typescript
interface SuggestionEngine {
  // Content analysis
  analyzeContext(content: string): Promise<{
    intent: string
    entities: string[]
    sentiment: string
    suggestions: Suggestion[]
  }>

  // Emoji suggestions
  suggestEmojis(context: {
    message?: string
    thread?: string
    recent?: string[]
  }): Promise<{
    contextual: string[]
    frequent: string[]
    trending: string[]
  }>

  // Command suggestions
  suggestCommands(input: string): Promise<{
    exact: Command[]
    fuzzy: Command[]
    contextual: Command[]
  }>
}
```

## Chat-Based Development

### Natural Language Coding
```typescript
interface ChatDevelopment {
  // Development modes
  modes: {
    create: 'natural language project creation'
    modify: 'conversational code changes'
    debug: 'interactive debugging'
    explain: 'code understanding'
  }

  // Context awareness
  context: {
    codebase: string[]      // Referenced repositories
    dependencies: string[]   // Project dependencies
    history: CodeAction[]   // Previous code changes
    environment: string     // Runtime context
  }

  // Real-time feedback
  feedback: {
    preview: 'instant'     // Show changes immediately
    validation: 'real-time' // Syntax and logic checks
    suggestions: 'inline'   // Contextual help
    execution: 'immediate'  // Run code snippets
  }
}
```

### Documentation Organization
```typescript
interface DocumentStyle {
  // Co-Star inspired typography
  typography: {
    scale: 'dramatic'     // Dramatic size contrasts
    spacing: 'expansive'  // Generous whitespace
    weight: 'considered'  // Thoughtful weight variation
  }
  
  // TE-inspired layout
  layout: {
    grid: 'utilitarian'   // Clear, functional grid
    rhythm: 'mechanical'  // Precise spacing rhythm
    density: 'focused'    // High information density when needed
  }
  
  // R1-inspired interaction
  interaction: {
    intelligence: 'fluid' // Smooth, contextual transitions
    context: 'ambient'    // Background awareness
    feedback: 'immediate' // Quick, clear responses
  }
}
```

### Development Flow
```typescript
interface DevelopmentFlow {
  // Natural language inputs
  inputs: {
    type: 'text' | 'voice'
    mode: 'conversation' | 'command'
    context: 'project' | 'file' | 'function'
  }

  // Intelligent processing
  processing: {
    parse: 'intent detection'
    plan: 'action planning'
    execute: 'code generation'
    validate: 'testing & validation'
  }

  // Real-time output
  output: {
    code: 'inline preview'
    docs: 'auto-generated'
    tests: 'continuous'
    deployment: 'automatic'
  }
}
```

## Best Practices

### For Development
1. **Clear Intent**
   - Use natural language
   - Specify context clearly
   - Describe desired outcome
   - Provide relevant examples

2. **Context Management**
   - Reference specific files
   - Mention dependencies
   - Include error messages
   - Share relevant logs

3. **Iterative Refinement**
   - Start with high-level goals
   - Refine through conversation
   - Test incrementally
   - Document learnings

### For Documentation
1. **Clear Structure**
   - Co-Star's dramatic spacing
   - TE's precise organization
   - R1's contextual grouping

2. **Rich Metadata**
   - Sophisticated type information
   - Clear relationship mapping
   - Contextual usage patterns

3. **Semantic Structure**
   - Dramatic typography
   - Utilitarian organization
   - Fluid context relationships

## Implementation Examples

### Project Creation
```typescript
// User: "Create a new Next.js app with Tailwind and TypeScript"

async function handleProjectCreation(message: string) {
  // 1. Parse intent
  const intent = await parseIntent(message)
  
  // 2. Generate project structure
  const structure = await generateProjectStructure(intent)
  
  // 3. Create files
  const files = await generateFiles(structure)
  
  // 4. Set up dependencies
  const deps = await setupDependencies(structure)
  
  // 5. Show preview
  return {
    files,
    deps,
    preview: generatePreview(files)
  }
}
```

### Code Modification
```typescript
// User: "Add dark mode support to the app"

async function handleCodeModification(message: string) {
  // 1. Understand context
  const context = await extractContext(message)
  
  // 2. Plan changes
  const changes = await planChanges(context)
  
  // 3. Generate modifications
  const modifications = await generateModifications(changes)
  
  // 4. Preview changes
  return {
    modifications,
    preview: generateDiff(modifications)
  }
}
```

## Quality Standards

### Development Quality
- Natural conversation flow
- Clear intent understanding
- Precise code generation
- Thorough validation

### Documentation Quality
- Sophisticated structure
- Clear visual hierarchy
- Rich contextual information
- Practical examples

### User Experience
- Immediate responsiveness
- Dramatic state transitions
- Efficient handling
- Graceful error recovery

## Next Steps

1. Core Implementation
   - [ ] Intent parsing system
   - [ ] Context extraction
   - [ ] Code generation pipeline
   - [ ] Preview system

2. UI Development
   - [ ] Chat interface
   - [ ] Preview panels
   - [ ] Context panels
   - [ ] Navigation system

3. Intelligence Layer
   - [ ] Suggestion system
   - [ ] Validation pipeline
   - [ ] Documentation generator
   - [ ] Test generator

4. Integration
   - [ ] Version control
   - [ ] Package management
   - [ ] Deployment pipeline
   - [ ] Collaboration tools

## Core AI Features

### Feature Implementation Matrix
```typescript
interface CoreFeatures {
  // Core AI features available in both PlusMenu and inline
  features: {
    code: {
      plusMenu: 'code block with syntax highlighting',
      inline: '```language',
      shortcut: 'cmd+shift+c',
      ai: 'code completion, explanation, and refactoring'
    },
    voice: {
      plusMenu: 'record voice message',
      inline: '/voice',
      shortcut: 'cmd+shift+v',
      ai: 'voice-to-text, sentiment analysis, translation'
    },
    thread: {
      plusMenu: 'link thread',
      inline: '#thread-id',
      shortcut: 'cmd+shift+t',
      ai: 'thread summarization and context linking'
    },
    reference: {
      plusMenu: 'add reference',
      inline: '!file-path or >message-id',
      shortcut: 'cmd+shift+r',
      ai: 'semantic search and context retrieval'
    },
    file: {
      plusMenu: 'attach file',
      inline: '!upload',
      shortcut: 'cmd+shift+f',
      ai: 'file analysis, OCR, and content extraction'
    },
    image: {
      plusMenu: 'attach image',
      inline: '!image',
      shortcut: 'cmd+shift+i',
      ai: 'image analysis, generation, and editing'
    }
  }

  // Implementation priority
  priority: [
    'code',      // Code understanding and generation
    'reference', // Knowledge linking
    'thread',    // Context management
    'file',      // File handling
    'image',     // Image processing
    'voice'      // Voice processing
  ]

  // Shared AI context
  aiContext: {
    messageHistory: Message[]
    threadContext: Thread
    userPreferences: UserSettings
    workspaceContext: WorkspaceMetadata
  }
}

interface MessageInput {
  // Trigger detection for inline features
  triggers: {
    code: ['```', '`'],
    voice: ['/voice'],
    thread: ['#'],
    reference: ['!', '>'],
    file: ['!upload'],
    image: ['!image']
  }

  // Shortcut handling
  shortcuts: {
    'cmd+shift+c': 'code',
    'cmd+shift+v': 'voice',
    'cmd+shift+t': 'thread',
    'cmd+shift+r': 'reference',
    'cmd+shift+f': 'file',
    'cmd+shift+i': 'image'
  }

  // AI enhancement
  enhancement: {
    type: CoreFeatures['features'][keyof CoreFeatures['features']]
    context: CoreFeatures['aiContext']
    processor: (input: string, context: Context) => Promise<EnhancedOutput>
  }
}
```

### Implementation Flow
1. **Core Components**
   - `PlusMenu.tsx`: Primary interface for feature access
   - `MessageInput.tsx`: Handles inline triggers and shortcuts
   - `AIProcessor.tsx`: Manages AI processing for all features

2. **Feature Integration**
   - Each feature is available through both PlusMenu and inline shortcuts
   - Consistent AI processing regardless of entry point
   - Shared context and enhancement pipeline

3. **Context Management**
   - Unified context tracking across all features
   - Persistent thread and workspace awareness
   - Real-time context updates

4. **AI Enhancement Pipeline**
   - Input preprocessing based on feature type
   - Context-aware processing
   - Real-time enhancement and suggestions
````

## File: docs/alden-docs/features/ai_stories.md
````markdown
# enso AI Features & User Stories

*Where ambient intelligence meets human connection*

For technical implementation details, see:
- [AI Architecture](../architecture/ai_architecture.md)
- [Core Features](../ai/core_features.md)
- [Technical Flow](../architecture/ai_flow.md)

For specific feature implementations, see:
- [Translation](../features/ai_translation.md)
- [Inline IDE](../features/inline_ide.md)
- [Cost Optimization](../operations/cost_optimization.md)

## Why These Features Matter

### For Gen Z & Millennials
- **Information Overload**: Managing multiple group chats, DMs, and platforms is overwhelming
- **Context Switching**: Moving between friend groups, school, and interests is mentally taxing
- **Memory Management**: Important conversations get lost in the noise
- **Platform Fragmentation**: Different friend groups use different platforms
- **Expression Needs**: Need for rich, contextual ways to share thoughts and feelings

### For Creators & Communities
- **Inspiration Tracking**: Ideas come from everywhere and need to be connected
- **Community Management**: Keeping track of conversations across platforms
- **Content Organization**: Linking references and inspirations naturally
- **Audience Engagement**: Managing interactions across multiple channels

### For Everyone
- **Relationship Management**: Keeping track of conversations and contexts with different people
- **Knowledge Organization**: Naturally building personal knowledge bases
- **Platform Flexibility**: Freedom to use preferred platforms without losing context
- **Reduced Cognitive Load**: Less mental energy spent on organizing digital life

## Message-Level Intelligence (PlusMenu)

### 1. Voice Message (`voice`)
Emotional and contextual voice messages that understand and enhance the human elements of voice communication.

#### Core Functionality
- Real-time transcription with emotion/tone detection
- Background context awareness (music, location, etc.)
- Smart timestamps and key point extraction
- Voice-specific context linking

#### User Stories

1. **The Friend Group Chat**
```typescript
scenario: "Sharing excitement about festival lineup"
user: College student
context: Group planning festival attendance
interaction: {
  input: "Voice message reacting to lineup announcement",
  ambient_detection: {
    - Excitement levels in voice
    - Music playing in background
    - Artist names mentioned
  },
  enhancement: {
    - Links to shared playlists
    - Connects to past festival discussions
    - Tags friends based on music preferences
  }
}
```

2. **The Creative Process**
```typescript
scenario: "Capturing song idea at 3am"
user: Musician
context: Solo creative workspace
interaction: {
  input: "Hummed melody with scattered thoughts",
  ambient_detection: {
    - Musical key and tempo
    - Emotional tone
    - Referenced influences
  },
  enhancement: {
    - Converts hum to musical notation
    - Links to similar progressions
    - Tags time of day/mood for pattern recognition
  }
}
```

3. **The Code Review**
```typescript
scenario: "Quick feedback on PR"
user: Senior developer
context: Remote team collaboration
interaction: {
  input: "Voice notes while reviewing code",
  ambient_detection: {
    - Technical terms used
    - Code file references
    - Suggestion patterns
  },
  enhancement: {
    - Links to specific code lines
    - Formats as structured review
    - Extracts action items
  }
}
```

4. **The Personal Journal**
```typescript
scenario: "Late night reflection"
user: Writer
context: Personal thought space
interaction: {
  input: "Stream of consciousness recording",
  ambient_detection: {
    - Emotional patterns
    - Recurring themes
    - Time-based patterns
  },
  enhancement: {
    - Generates writing prompts
    - Links to related entries
    - Suggests patterns over time
  }
}
```

5. **The Design Feedback**
```typescript
scenario: "Reviewing visual work"
user: Art director
context: Remote design review
interaction: {
  input: "Walking through design feedback",
  ambient_detection: {
    - Visual references
    - Design terminology
    - Spatial descriptions
  },
  enhancement: {
    - Maps feedback to design areas
    - Creates visual annotation layer
    - Links to style guide
  }
}
```

6. **The Language Practice**
```typescript
scenario: "Practicing pronunciation"
user: Language learner
context: Self-study session
interaction: {
  input: "Pronunciation practice attempts",
  ambient_detection: {
    - Accent patterns
    - Common mistakes
    - Improvement over time
  },
  enhancement: {
    - Provides IPA notation
    - Suggests specific exercises
    - Tracks progress patterns
  }
}
```

7. **The Teaching Moment**
```typescript
scenario: "Explaining complex concept"
user: Teacher
context: Online tutoring
interaction: {
  input: "Verbal explanation of concept",
  ambient_detection: {
    - Key terms used
    - Explanation patterns
    - Student engagement cues
  },
  enhancement: {
    - Generates visual aids
    - Links to related concepts
    - Suggests alternative explanations
  }
}
```

8. **The Mood Share**
```typescript
scenario: "Sharing feelings with friends"
user: College student
context: Group chat
interaction: {
  input: "Voice message about exciting news",
  ambient_detection: {
    - Emotional tone
    - Key life events
    - Friend references
  },
  enhancement: {
    - Highlights excitement peaks
    - Tags relevant friends
    - Links to previous celebrations
  }
}
```

9. **The Creative Spark**
```typescript
scenario: "Song idea capture"
user: Aspiring musician
context: Personal notes
interaction: {
  input: "Hummed melody with lyrics",
  ambient_detection: {
    - Musical elements
    - Lyrical themes
    - Mood patterns
  },
  enhancement: {
    - Creates melody transcript
    - Links similar inspirations
    - Suggests collaborators
  }
}
```

### 2. Smart Reference (`reference`)
Intelligent content linking that understands context and creates meaningful connections.

#### Core Functionality
- Multi-format content understanding
- Semantic relationship mapping
- Rich preview generation
- Context-aware suggestions

#### User Stories

1. **The Research Deep Dive**
```typescript
scenario: "Academic paper research"
user: PhD student
context: Literature review
interaction: {
  input: "PDF drag-and-drop of paper",
  ambient_detection: {
    - Key findings
    - Methodology
    - Citation network
  },
  enhancement: {
    - Extracts key quotes
    - Maps to research questions
    - Suggests related papers
  }
}
```

2. **The Design System**
```typescript
scenario: "Component documentation"
user: UI designer
context: Design system maintenance
interaction: {
  input: "Figma component link",
  ambient_detection: {
    - Usage patterns
    - Style properties
    - Component relationships
  },
  enhancement: {
    - Generates code snippets
    - Links to implementations
    - Tracks version history
  }
}
```

3. **The Mood Board**
```typescript
scenario: "Project inspiration"
user: Interior designer
context: Client project
interaction: {
  input: "Pinterest board link",
  ambient_detection: {
    - Color schemes
    - Style patterns
    - Material preferences
  },
  enhancement: {
    - Creates color palette
    - Suggests materials
    - Estimates budget
  }
}
```

4. **The Code Review**
```typescript
scenario: "PR discussion"
user: Developer
context: Team code review
interaction: {
  input: "GitHub PR link",
  ambient_detection: {
    - Change patterns
    - Related issues
    - Test coverage
  },
  enhancement: {
    - Summarizes changes
    - Suggests reviewers
    - Links documentation
  }
}
```

5. **The Recipe Share**
```typescript
scenario: "Sharing family recipe"
user: Home cook
context: Family chat
interaction: {
  input: "Photo of handwritten recipe",
  ambient_detection: {
    - Ingredients
    - Instructions
    - Special notes
  },
  enhancement: {
    - Converts to digital format
    - Suggests substitutions
    - Scales portions
  }
}
```

6. **The Art Reference**
```typescript
scenario: "Technique study"
user: Digital artist
context: Skill development
interaction: {
  input: "Art tutorial video",
  ambient_detection: {
    - Techniques used
    - Tool settings
    - Style elements
  },
  enhancement: {
    - Extracts key steps
    - Creates practice guide
    - Suggests related tutorials
  }
}
```

7. **The Workout Plan**
```typescript
scenario: "Fitness tracking"
user: Personal trainer
context: Client coaching
interaction: {
  input: "Workout video clip",
  ambient_detection: {
    - Exercise form
    - Movement patterns
    - Intensity levels
  },
  enhancement: {
    - Form analysis
    - Progression tracking
    - Modification suggestions
  }
}
```

### 3. Thread Intelligence (`thread`)
Ambient awareness of conversation context and meaningful connections.

#### Core Functionality
- Real-time context detection
- Semantic relationship mapping
- Smart suggestion system
- Timeline awareness

#### User Stories

1. **The Project Evolution**
```typescript
scenario: "Long-term project development"
user: Product manager
context: Feature development
interaction: {
  input: "Ongoing discussion threads",
  ambient_detection: {
    - Decision points
    - Stakeholder input
    - Timeline patterns
  },
  enhancement: {
    - Creates decision log
    - Maps dependencies
    - Suggests next steps
  }
}
```

2. **The Learning Journey**
```typescript
scenario: "Study group discussions"
user: Student
context: Course collaboration
interaction: {
  input: "Class discussion threads",
  ambient_detection: {
    - Topic relationships
    - Understanding gaps
    - Question patterns
  },
  enhancement: {
    - Generates study guides
    - Links course materials
    - Suggests practice areas
  }
}
```

3. **The Creative Collaboration**
```typescript
scenario: "Band songwriting"
user: Musician
context: Remote collaboration
interaction: {
  input: "Song development threads",
  ambient_detection: {
    - Version evolution
    - Member contributions
    - Style patterns
  },
  enhancement: {
    - Tracks iterations
    - Suggests combinations
    - Maps influences
  }
}
```

4. **The Event Planning**
```typescript
scenario: "Wedding planning"
user: Event planner
context: Client communication
interaction: {
  input: "Vendor discussion threads",
  ambient_detection: {
    - Decisions made
    - Budget items
    - Timeline elements
  },
  enhancement: {
    - Creates timeline
    - Tracks budget
    - Suggests vendors
  }
}
```

5. **The Writing Workshop**
```typescript
scenario: "Story development"
user: Writer
context: Writing group
interaction: {
  input: "Feedback threads",
  ambient_detection: {
    - Character arcs
    - Plot elements
    - Style patterns
  },
  enhancement: {
    - Maps story elements
    - Tracks revisions
    - Suggests improvements
  }
}
```

6. **The Home Renovation**
```typescript
scenario: "DIY project"
user: Homeowner
context: Contractor discussions
interaction: {
  input: "Project threads",
  ambient_detection: {
    - Material choices
    - Timeline changes
    - Budget updates
  },
  enhancement: {
    - Tracks expenses
    - Maps dependencies
    - Suggests alternatives
  }
}
```

7. **The Support Thread**
```typescript
scenario: "Customer support"
user: Support agent
context: Issue resolution
interaction: {
  input: "Support conversation",
  ambient_detection: {
    - Issue patterns
    - Resolution steps
    - Customer sentiment
  },
  enhancement: {
    - Suggests solutions
    - Links documentation
    - Tracks satisfaction
  }
}
```

## Chat-Level Intelligence (ChatMenu)

### 1. Share Context (`share`)
Intelligent context sharing that preserves conversation history and relationships.

#### Core Functionality
- Smart context detection
- Semantic relationship mapping
- Privacy-aware sharing
- Rich preview generation

#### User Stories

1. **The Design Review**
```typescript
scenario: "Sharing project context"
user: Design lead
context: Design system discussion
interaction: {
  input: "Share context with new team member",
  ambient_detection: {
    - Key decisions
    - Component relationships
    - Reference materials
  },
  enhancement: {
    - Creates summary cards
    - Preserves file links
    - Maps dependencies
  }
}
```

2. **The Knowledge Transfer**
```typescript
scenario: "Documentation handoff"
user: Senior developer
context: Codebase walkthrough
interaction: {
  input: "Share architecture context",
  ambient_detection: {
    - System components
    - Key patterns
    - Recent changes
  },
  enhancement: {
    - Generates architecture map
    - Links documentation
    - Highlights patterns
  }
}
```

3. **The Research Share**
```typescript
scenario: "Academic collaboration"
user: PhD researcher
context: Literature review
interaction: {
  input: "Share research context",
  ambient_detection: {
    - Key findings
    - Methodology notes
    - Citation network
  },
  enhancement: {
    - Creates citation graph
    - Extracts methodology
    - Links related papers
  }
}
```

4. **The Client Brief**
```typescript
scenario: "Project handover"
user: Project manager
context: Client requirements
interaction: {
  input: "Share project context",
  ambient_detection: {
    - Requirements
    - Timeline
    - Stakeholders
  },
  enhancement: {
    - Creates timeline view
    - Maps stakeholders
    - Highlights priorities
  }
}
```

5. **The Study Group**
```typescript
scenario: "Course material sharing"
user: Student
context: Group study
interaction: {
  input: "Share study materials",
  ambient_detection: {
    - Key concepts
    - Practice problems
    - Resource links
  },
  enhancement: {
    - Creates study guide
    - Groups by topic
    - Suggests practice
  }
}
```

### 2. Merge Threads (`merge`)
Intelligent thread merging that preserves context and relationships.

#### Core Functionality
- Semantic overlap detection
- Timeline preservation
- Context mapping
- Smart conflict resolution

#### User Stories

1. **The Feature Discussion**
```typescript
scenario: "Merging implementation threads"
user: Tech lead
context: Feature development
interaction: {
  input: "Merge related feature discussions",
  ambient_detection: {
    - Implementation details
    - Decision points
    - Dependencies
  },
  enhancement: {
    - Creates decision log
    - Maps feature scope
    - Preserves timeline
  }
}
```

2. **The Event Planning**
```typescript
scenario: "Merging vendor discussions"
user: Event planner
context: Wedding planning
interaction: {
  input: "Merge catering threads",
  ambient_detection: {
    - Menu items
    - Pricing details
    - Timeline points
  },
  enhancement: {
    - Consolidates quotes
    - Creates menu matrix
    - Maps timeline
  }
}
```

3. **The Bug Hunt**
```typescript
scenario: "Merging issue reports"
user: QA engineer
context: Bug tracking
interaction: {
  input: "Merge related bug reports",
  ambient_detection: {
    - Error patterns
    - Reproduction steps
    - Environment details
  },
  enhancement: {
    - Creates issue map
    - Links related fixes
    - Tracks status
  }
}
```

4. **The Art Direction**
```typescript
scenario: "Merging feedback threads"
user: Art director
context: Design review
interaction: {
  input: "Merge design feedback",
  ambient_detection: {
    - Visual elements
    - Revision history
    - Style notes
  },
  enhancement: {
    - Creates revision timeline
    - Maps style changes
    - Preserves references
  }
}
```

5. **The Writing Process**
```typescript
scenario: "Merging draft discussions"
user: Author
context: Book editing
interaction: {
  input: "Merge chapter feedback",
  ambient_detection: {
    - Character arcs
    - Plot points
    - Style notes
  },
  enhancement: {
    - Maps narrative flow
    - Tracks revisions
    - Links references
  }
}
```

### 3. Enhance Context (`enhance`)
Ambient intelligence that enriches conversation context.

#### Core Functionality
- Real-time context detection
- Knowledge graph integration
- Smart suggestions
- Resource linking

#### User Stories

1. **The Code Review**
```typescript
scenario: "Enhancing PR discussion"
user: Developer
context: Code review
interaction: {
  input: "Enhance with documentation",
  ambient_detection: {
    - Code patterns
    - API usage
    - Best practices
  },
  enhancement: {
    - Links documentation
    - Suggests patterns
    - Highlights issues
  }
}
```

2. **The Design Critique**
```typescript
scenario: "Enhancing design feedback"
user: UX designer
context: Design review
interaction: {
  input: "Enhance with principles",
  ambient_detection: {
    - Design patterns
    - Usability issues
    - Brand guidelines
  },
  enhancement: {
    - Links guidelines
    - Suggests improvements
    - Maps patterns
  }
}
```

3. **The Research Discussion**
```typescript
scenario: "Enhancing methodology"
user: Researcher
context: Method development
interaction: {
  input: "Enhance with references",
  ambient_detection: {
    - Methods used
    - Similar studies
    - Key variables
  },
  enhancement: {
    - Links papers
    - Suggests methods
    - Maps variables
  }
}
```

4. **The Legal Review**
```typescript
scenario: "Enhancing contract discussion"
user: Lawyer
context: Contract review
interaction: {
  input: "Enhance with precedents",
  ambient_detection: {
    - Legal terms
    - Case references
    - Risk factors
  },
  enhancement: {
    - Links cases
    - Highlights risks
    - Suggests clauses
  }
}
```

5. **The Medical Consultation**
```typescript
scenario: "Enhancing patient discussion"
user: Doctor
context: Treatment planning
interaction: {
  input: "Enhance with guidelines",
  ambient_detection: {
    - Symptoms
    - Treatment options
    - Risk factors
  },
  enhancement: {
    - Links protocols
    - Suggests tests
    - Maps outcomes
  }
}
```

## Integration Stories

### Cross-Platform Context

1. **The Friend Group**
```typescript
scenario: "Managing multiple platform conversations"
user: High school student
context: Friend group coordination
interaction: {
  input: "Planning weekend hangout",
  ambient_detection: {
    - Conversations across Discord/SMS
    - Availability patterns
    - Previous plans
  },
  enhancement: {
    - Unifies chat threads
    - Syncs decisions
    - Preserves context
  }
}
```

2. **The Content Creator**
```typescript
scenario: "Managing community engagement"
user: Twitch streamer
context: Multi-platform community
interaction: {
  input: "Responding to fan discussions",
  ambient_detection: {
    - Cross-platform mentions
    - Community sentiment
    - Content references
  },
  enhancement: {
    - Unifies fan interactions
    - Tracks engagement patterns
    - Suggests response strategies
  }
}
```

## Implementation Approach

### Phase 1: Foundation
- Core context detection system
- Basic semantic search
- Initial UI components

### Phase 2: Intelligence
- Enhanced context detection
- Smart suggestions
- Knowledge graph integration

### Phase 3: Ambient Features
- Real-time enhancements
- Predictive suggestions
- Advanced visualization

### Phase 4: Integration
- Cross-platform context management
- Community engagement management
- Resource linking

## Next Steps
1. Implement core context service
2. Build embedding pipeline
3. Create UI components
4. Integrate with chat flow

# Translation & Language Learning Stories

## Cross-Cultural Communication

### 1. Family Dinner Planning
```typescript
scenario: "Multi-generational Family Chat"
context: {
  participants: {
    grandmother: { native: 'Japanese', learning: null }
    parents: { native: ['English', 'Japanese'], learning: null }
    children: { native: 'English', learning: 'Japanese' }
  },
  
  situation: {
    type: 'dinner_planning'
    formality: 'casual'
    cultural_context: {
      japanese_customs: true
      dietary_preferences: true
      traditional_dishes: true
    }
  },
  
  features: {
    translation: {
      mode: 'real-time'
      style: 'natural'
      cultural_notes: true
      pronunciation_help: true
    },
    learning: {
      vocabulary: 'food_related'
      customs: 'dining_etiquette'
      context: 'family_dynamics'
    }
  }
}
```

### 2. Cultural Festival Organization
```typescript
scenario: "Community Event Planning"
context: {
  participants: {
    organizers: [
      { native: 'Japanese', role: 'cultural_advisor' },
      { native: 'English', role: 'logistics' },
      { native: 'Spanish', role: 'entertainment' }
    ],
    volunteers: {
      languages: ['Japanese', 'English', 'Spanish', 'Mandarin']
      proficiency: 'mixed'
    }
  },
  
  features: {
    translation: {
      mode: 'group_chat'
      cultural_context: true
      terminology: 'event_specific'
    },
    coordination: {
      task_management: true
      role_based_access: true
      cultural_sensitivity: true
    }
  }
}
```

## Language Learning

### 1. Immersive Gaming
```typescript
scenario: "Gaming with Japanese Friends"
context: {
  activity: 'multiplayer_gaming'
  participants: {
    learner: {
      native: 'English'
      learning: 'Japanese'
      interests: ['gaming', 'anime', 'technology']
      level: 'intermediate'
    },
    native_speakers: {
      count: 3
      language: 'Japanese'
      gaming_experience: 'advanced'
    }
  },
  
  features: {
    translation: {
      mode: 'gaming_context'
      gaming_terminology: true
      casual_speech: true
      slang_explanation: true
    },
    learning: {
      vocabulary: 'gaming_focused'
      grammar: 'casual_forms'
      culture: 'gaming_etiquette'
      achievements: {
        new_phrases: true
        cultural_points: true
        interaction_goals: true
      }
    }
  }
}
```

### 2. Professional Mentorship
```typescript
scenario: "Tech Mentorship Program"
context: {
  relationship: {
    mentor: { native: 'Japanese', role: 'senior_developer' }
    mentee: { native: 'English', role: 'junior_developer' }
  },
  
  domain: {
    technical: ['programming', 'architecture', 'best_practices']
    professional: ['workplace_culture', 'communication', 'etiquette']
    industry: 'software_development'
  },
  
  features: {
    translation: {
      mode: 'professional'
      technical_accuracy: true
      formality_levels: true
      context_preservation: true
    },
    learning: {
      technical_vocabulary: true
      business_japanese: true
      cultural_practices: true
      career_development: true
    }
  }
}
```

### 3. Creative Collaboration
```typescript
scenario: "Manga Translation Project"
context: {
  project: {
    type: 'manga_localization'
    roles: ['translator', 'editor', 'cultural_advisor']
    target_audience: 'international_readers'
  },
  
  participants: {
    japanese_team: {
      native: 'Japanese'
      expertise: ['manga_industry', 'storytelling']
    },
    localization_team: {
      native: 'English'
      expertise: ['translation', 'cultural_adaptation']
    }
  },
  
  features: {
    translation: {
      mode: 'creative'
      style_preservation: true
      cultural_adaptation: true
      visual_context: true
    },
    collaboration: {
      real_time_feedback: true
      visual_annotations: true
      version_control: true
      style_guides: true
    }
  }
}
```

## Daily Life Scenarios

### 1. Restaurant Experience
```typescript
scenario: "Dining Out in Japan"
context: {
  setting: 'traditional_restaurant'
  participants: {
    customers: { native: 'English', japanese_level: 'beginner' }
    staff: { native: 'Japanese', english_level: 'basic' }
  },
  
  features: {
    translation: {
      mode: 'real_time_conversation'
      menu_translation: true
      dietary_requirements: true
      cultural_etiquette: true
    },
    assistance: {
      pronunciation_guide: true
      ordering_help: true
      cultural_tips: true
      payment_guidance: true
    }
  }
}
```

### 2. Healthcare Communication
```typescript
scenario: "Doctor's Appointment"
context: {
  setting: 'medical_clinic'
  participants: {
    patient: { native: 'English', medical_history: true }
    doctor: { native: 'Japanese', specialization: 'general_practice' }
    nurse: { native: 'Japanese', role: 'interpreter_assist' }
  },
  
  features: {
    translation: {
      mode: 'high_accuracy'
      medical_terminology: true
      symptom_description: true
      treatment_instructions: true
    },
    safety: {
      verification_required: true
      medical_context_aware: true
      documentation: true
      follow_up_care: true
    }
  }
}
```

## Implementation Notes

### Translation Quality
```typescript
interface TranslationQuality {
  accuracy: {
    technical_terms: 'high_precision'
    cultural_context: 'preserved'
    emotional_nuance: 'maintained'
    formality_levels: 'appropriate'
  }
  
  verification: {
    critical_content: 'double_checked'
    medical_terms: 'expert_verified'
    legal_terms: 'professional_reviewed'
  }
  
  feedback: {
    user_corrections: true
    learning_patterns: true
    quality_metrics: true
  }
}
```

### Learning Integration
```typescript
interface LearningIntegration {
  methods: {
    immersion: 'natural_context'
    structured: 'guided_lessons'
    social: 'peer_practice'
    gamified: 'achievement_based'
  }
  
  tracking: {
    progress: 'personalized'
    milestones: 'achievable'
    feedback: 'constructive'
    adaptation: 'dynamic'
  }
  
  resources: {
    contextual: 'situation_based'
    cultural: 'deep_insights'
    practical: 'real_world'
    technical: 'domain_specific'
  }
}
````

## File: docs/alden-docs/features/ai_translation.md
````markdown
# AI Translation & Language Learning

## Vision

For real-world usage scenarios, see [Translation Stories](../features/ai_stories.md#translation--language-learning-stories).

For technical implementation details, see:
- [Translation Functions](../implementation/backend/functions.md#translation)
- [AI Architecture](../architecture/ai_architecture.md)
- [Cost Optimization](../operations/cost_optimization.md)

Create a seamless multilingual chat experience that:
- Enables natural conversation across language barriers
- Facilitates language learning through immersion
- Preserves cultural context and nuance
- Adapts to user proficiency levels

## Core Features

### Real-Time Translation
```typescript
interface TranslationEngine {
  // Core translation
  modes: {
    realtime: 'instant translation'
    delayed: 'learning mode'
    hybrid: 'mixed proficiency'
  }

  // Language handling
  languages: {
    source: Language
    target: Language
    proficiency: ProficiencyLevel
    preferences: TranslationPreferences
  }

  // Cultural context
  context: {
    cultural: CulturalContext
    situational: SituationalContext
    relationship: RelationshipContext
  }
}
```

### Language Learning
```typescript
interface LanguageLearning {
  // Learning modes
  modes: {
    immersion: 'natural learning'
    structured: 'guided practice'
    mixed: 'hybrid approach'
  }

  // Progress tracking
  progress: {
    vocabulary: VocabProgress
    grammar: GrammarProgress
    pronunciation: PronunciationProgress
    fluency: FluencyMetrics
  }

  // Adaptive features
  adaptation: {
    difficulty: 'auto-adjusting'
    reinforcement: 'spaced repetition'
    feedback: 'contextual hints'
  }
}
```

### Multimodal Understanding
```typescript
interface MultimodalTranslation {
  // Input types
  inputs: {
    text: TextContent
    voice: VoiceContent
    images: ImageContent
    emoji: EmojiContent
  }

  // Cultural elements
  cultural: {
    idioms: IdiomMapping
    references: CulturalReference
    context: SocialContext
  }

  // Expression mapping
  expression: {
    tone: ToneMapping
    formality: FormalityLevel
    emotion: EmotionMapping
  }
}
```

## Implementation

### Translation Pipeline
```typescript
interface TranslationPipeline {
  // Message processing
  async processMessage(content: Content, context: TranslationContext): Promise<TranslatedContent>
  
  // Cultural adaptation
  async adaptContext(content: Content, culture: Culture): Promise<AdaptedContent>
  
  // Learning integration
  async integrateLearningSuggestions(content: Content, level: Level): Promise<EnhancedContent>
}
```

### Learning System
```typescript
interface LearningSystem {
  // Progress tracking
  async trackProgress(userId: string, interaction: Interaction): Promise<Progress>
  
  // Suggestion generation
  async generateExercises(level: Level, context: Context): Promise<Exercise[]>
  
  // Feedback system
  async provideFeedback(attempt: Attempt, target: Target): Promise<Feedback>
}
```

## User Stories

### Bilingual Families
```typescript
scenario: "Japanese-English Family Chat"
context: {
  participants: {
    parent1: { native: 'Japanese', learning: 'English' }
    parent2: { native: 'English', learning: 'Japanese' }
    child: { native: ['Japanese', 'English'] }
  }
  
  features: {
    translation: {
      mode: 'hybrid'
      showBoth: true
      learningHints: true
    }
    learning: {
      trackProgress: true
      suggestPractice: true
    }
  }
}
```

### Business Communication
```typescript
scenario: "International Team Meeting"
context: {
  languages: ['English', 'Japanese', 'Spanish']
  formality: 'business'
  features: {
    translation: {
      mode: 'realtime'
      preserveFormality: true
      culturalNotes: true
    }
  }
}
```

### Language Exchange
```typescript
scenario: "Language Learning Partners"
context: {
  pair: {
    user1: { native: 'English', learning: 'Japanese' }
    user2: { native: 'Japanese', learning: 'English' }
  }
  
  mode: {
    type: 'structured'
    correction: true
    explanation: true
    exercises: true
  }
}
```

## Technical Implementation

### Embedding-Based Translation
```typescript
interface EmbeddingTranslation {
  // Generate cross-lingual embeddings
  async generateEmbedding(
    content: string,
    language: Language
  ): Promise<CrossLingualEmbedding>
  
  // Find semantic equivalents
  async findTranslation(
    embedding: CrossLingualEmbedding,
    targetLanguage: Language
  ): Promise<Translation[]>
  
  // Preserve context
  async preserveContext(
    source: Content,
    translation: Translation,
    context: Context
  ): Promise<EnhancedTranslation>
}
```

### Learning Analytics
```typescript
interface LearningAnalytics {
  // Track user progress
  async trackUserProgress(
    userId: string,
    interactions: Interaction[]
  ): Promise<ProgressReport>
  
  // Generate insights
  async generateInsights(
    progress: Progress,
    goals: LearningGoals
  ): Promise<LearningInsights>
  
  // Recommend next steps
  async recommendActivities(
    insights: LearningInsights,
    context: Context
  ): Promise<Recommendation[]>
}
```

## UI Components

### Translation Display
```typescript
interface TranslationUI {
  // Display modes
  modes: {
    inline: 'side-by-side'
    overlay: 'hover translation'
    dual: 'both languages'
  }

  // Learning features
  learning: {
    highlights: 'vocabulary'
    annotations: 'grammar'
    pronunciation: 'audio guides'
  }

  // Interaction
  interaction: {
    correction: 'suggest edits'
    explanation: 'request context'
    save: 'vocabulary list'
  }
}
```

## Next Steps

1. Core Translation
   - [ ] Implement embedding-based translation
   - [ ] Build cultural context system
   - [ ] Create real-time processing pipeline

2. Learning Features
   - [ ] Develop progress tracking
   - [ ] Create exercise generation
   - [ ] Build feedback system

3. UI Development
   - [ ] Design translation interfaces
   - [ ] Implement learning components
   - [ ] Create progress visualizations

4. Analytics & Optimization
   - [ ] Build analytics pipeline
   - [ ] Implement recommendation system
   - [ ] Create optimization feedback loop
````

## File: docs/alden-docs/features/contexts.md
````markdown
# enso: Context & Development Guidelines

## Project Overview
enso is an AI-native messaging app built with React Native and Expo. Targeting developers and knowledge workers, enso delivers a minimal, utilitarian interface that combines Cursor's intelligent reference system, Co-Star's dramatic minimalism, and iMessage's intuitive chat experience. The app leverages embeddings and async LLM pipelines for intelligent context linking, thread management, and semantic search. The focus is on making contextual intelligence feel natural and helpful rather than intrusive.

## UI/UX Philosophy
- **Cursor-Inspired Intelligence:**  
  Implement a smart reference system that detects and links mentions of threads, users, places, and resources in real-time, similar to Cursor's code reference UI.
- **Co-Star Minimalism:**
  Embrace dramatic typography, ample white space, and subtle animations that create a sophisticated, editorial feel.
- **iMessage Fluidity:**
  Ensure chat interactions are smooth and intuitive, with seamless thread management and context switching.
- **Custom & Authentic:**  
  Build a unique component system that captures enso's identity‚Äîdistinct from off-the-shelf libraries.
- **Invisible AI:**  
  Focus on contextual intelligence and semantic linking that enhances conversations naturally.

## Tech Stack & Tooling
- **Frontend:**  
  - **React Native / Expo:** For cross-platform mobile development.
  - **pnpm:** For efficient package management.
- **Backend:**  
  - **Supabase:** For authentication, real-time data, and storage.
- **AI Integrations:**  
  - **Vertex AI & DeepSeek APIs:** For powering contextual search, translation, and smart tagging.
- **Animations:**  
  - **Moti:** For declarative, Framer Motion‚Äìinspired animations.
- **Styling:**  
  - **Nativewind:** For utility-first styling using Tailwind CSS‚Äìinspired classes.
- **State Management:**  
  - **Redux & RTK Toolkit (with RTK Query):** For robust state management and data fetching.
- **Quality & Testing Tools:**  
  - **ESLint & Prettier:** To enforce code quality.
  - **Jest & Detox:** For unit and end-to-end testing.
  - **Storybook:** For documenting and testing our custom component system.
  - **GitHub Actions & Sentry:** For CI/CD and error monitoring.

## AI Features
- **Contextual Threading:**
  Use embeddings to automatically detect and link related conversation threads
- **Smart References:**
  Detect and link mentions of users, threads, places, and resources in real-time
- **Semantic Search:**
  Enable natural language search across conversations using embedding-based retrieval
- **Async Summaries:**
  Generate thread summaries and context cards asynchronously using LLM pipelines
- **Intelligent Grouping:**
  Automatically group related messages and surface relevant context

## AI & Backend Integration Details
- **Contextual Search & Smart Tagging:**  
  Leverage multimodal embeddings from Vertex AI and efficient search from DeepSeek to index and retrieve messages, images, and voice clips.
- **Real-Time Translation:**  
  Automatically translate messages on the fly, preserving tone and context.
- **Supabase Integration:**  
  Use a singleton Supabase client (in `supabase/supabaseClient.js`) and encapsulate API interactions within dedicated service files.

## Development Guidelines
- **Custom Component System:**  
  Build and maintain a bespoke component library under `src/components` to capture our unique minimal/Co‚ÄìStar aesthetic.
- **Modular Architecture:**  
  Follow the directory structure to separate UI components, state management, services, and utilities.
- **Performance & Scalability:**  
  Optimize animations, API calls, and state updates for a smooth, responsive mobile experience.
- **Code Quality & Testing:**  
  Enforce standards using ESLint, Prettier, Jest, and Detox; document components with Storybook.
- **Accessibility:**  
  Ensure that all interactive elements are properly labeled and accessible.
- **Iteration & Feedback:**  
  Emphasize early testing and regular feedback to refine AI functionalities and UI/UX.

## Roadmap
1. **Foundational Setup:**  
   Set up core navigation, authentication (via Supabase), and basic chat functionality.
2. **Custom Component System:**  
   Develop the core UI components (buttons, inputs, cards, etc.) that embody the enso design aesthetic.
3. **AI Feature Integration:**  
   Implement Vertex AI and DeepSeek for contextual search, translation, and smart tagging.
4. **UI/UX Polish:**  
   Refine the minimal, edgy design and ensure responsiveness.
5. **Tooling & Quality Assurance:**  
   Integrate Storybook, ESLint/Prettier, CI/CD pipelines, and error monitoring.
6. **User Testing & Iteration:**  
   Continuously refine based on user feedback.
7. **Launch & Scale:**  
   Roll out a freemium model with premium AI-powered features.

Use this document as your North Star to ensure every development decision aligns with enso's vision.
````

## File: docs/alden-docs/features/inline_ide.md
````markdown
# Inline AI-Native IDE

## Vision

For real-world usage scenarios, see [Development Stories](../features/ai_stories.md#chat-based-development).

For technical implementation details, see:
- [LLM Development](../development/llm_driven.md)
- [AI Architecture](../architecture/ai_architecture.md)
- [Implementation Details](../implementation/web/implementation_web.md)

Rather than integrating with external IDEs, we bring the full power of AI-driven development directly into the chat experience. Users can:
- Write code through natural conversation
- Get instant context-aware suggestions
- See real-time previews and results
- Collaborate on code seamlessly

## Core Concepts

### Conversational Development
```typescript
interface ConversationalIDE {
  // Natural language code generation
  intentions: {
    create: 'I want to build...'
    modify: 'Can you change...'
    debug: 'Why isn\'t this working...'
    explain: 'How does this work...'
  }

  // Context awareness
  context: {
    codebase: string[]      // Referenced repositories
    dependencies: string[]   // Project dependencies
    history: CodeAction[]   // Previous code changes
    environment: string     // Runtime context
  }

  // Real-time feedback
  feedback: {
    preview: 'instant'     // Show changes immediately
    validation: 'real-time' // Syntax and logic checks
    suggestions: 'inline'   // Contextual help
    execution: 'immediate'  // Run code snippets
  }
}
```

### Code Representation
```typescript
interface CodeDisplay {
  // Co-Star inspired typography
  typography: {
    code: 'JetBrains Mono'
    scale: {
      normal: '14px'
      large: '16px'
      small: '12px'
    }
    weights: {
      normal: 400
      bold: 600
    }
  }

  // TE-inspired layout
  layout: {
    grid: '8px'
    indent: '2ch'
    lineHeight: 1.5
    padding: '16px'
  }

  // R1-inspired intelligence
  intelligence: {
    highlighting: 'semantic'
    folding: 'smart'
    suggestions: 'contextual'
    references: 'inline'
  }
}
```

### Development Flow
```typescript
interface DevelopmentFlow {
  // Natural language inputs
  inputs: {
    type: 'text' | 'voice'
    mode: 'conversation' | 'command'
    context: 'project' | 'file' | 'function'
  }

  // Intelligent processing
  processing: {
    parse: 'intent detection'
    plan: 'action planning'
    execute: 'code generation'
    validate: 'testing & validation'
  }

  // Real-time output
  output: {
    code: 'inline preview'
    docs: 'auto-generated'
    tests: 'continuous'
    deployment: 'automatic'
  }
}
```

## Implementation

### Message Processing
```typescript
interface CodeMessage {
  // Message content
  content: {
    text: string
    codeBlocks?: CodeBlock[]
    references?: CodeReference[]
  }

  // Code context
  context: {
    repository?: string
    branch?: string
    files?: string[]
    dependencies?: string[]
  }

  // Action type
  action: {
    type: 'create' | 'modify' | 'explain' | 'debug'
    target?: string
    scope?: string
  }
}
```

### Code Generation
```typescript
interface CodeGeneration {
  // Input processing
  async parseIntent(message: string): Promise<CodeIntent>
  async extractContext(message: string): Promise<CodeContext>
  
  // Code generation
  async generateCode(intent: CodeIntent, context: CodeContext): Promise<CodeResult>
  async validateCode(code: string, context: CodeContext): Promise<ValidationResult>
  
  // Preview & execution
  async generatePreview(code: string): Promise<Preview>
  async executeCode(code: string, env: Environment): Promise<ExecutionResult>
}
```

### UI Components

#### Code Editor
```typescript
interface InlineEditor {
  // Display options
  display: {
    theme: 'dark' | 'light'
    fontSize: number
    lineNumbers: boolean
    minimap: boolean
  }

  // Edit capabilities
  editing: {
    completion: boolean
    formatting: boolean
    refactoring: boolean
    navigation: boolean
  }

  // Intelligence features
  intelligence: {
    suggestions: boolean
    documentation: boolean
    debugging: boolean
    testing: boolean
  }
}
```

#### Preview Panel
```typescript
interface PreviewPanel {
  // Preview types
  types: {
    code: CodePreview
    output: OutputPreview
    tests: TestPreview
    docs: DocsPreview
  }

  // Update behavior
  updates: {
    mode: 'real-time' | 'on-demand'
    debounce: number
    throttle: number
  }

  // Interaction
  interaction: {
    zoom: boolean
    pan: boolean
    edit: boolean
    share: boolean
  }
}
```

## Usage Examples

### Creating a New Project
```typescript
// User message: "Create a new Next.js app with Tailwind and TypeScript"

async function handleProjectCreation(message: string) {
  // 1. Parse intent
  const intent = await parseIntent(message)
  
  // 2. Generate project structure
  const structure = await generateProjectStructure(intent)
  
  // 3. Create files
  const files = await generateFiles(structure)
  
  // 4. Set up dependencies
  const deps = await setupDependencies(structure)
  
  // 5. Show preview
  return {
    files,
    deps,
    preview: generatePreview(files)
  }
}
```

### Modifying Code
```typescript
// User message: "Add dark mode support to the app"

async function handleCodeModification(message: string) {
  // 1. Understand context
  const context = await extractContext(message)
  
  // 2. Plan changes
  const changes = await planChanges(context)
  
  // 3. Generate modifications
  const modifications = await generateModifications(changes)
  
  // 4. Preview changes
  return {
    modifications,
    preview: generateDiff(modifications)
  }
}
```

## Next Steps

1. Core Implementation
   - [ ] Intent parsing system
   - [ ] Context extraction
   - [ ] Code generation pipeline
   - [ ] Preview system

2. UI Development
   - [ ] Inline code editor
   - [ ] Preview panels
   - [ ] Context panels
   - [ ] Navigation system

3. Intelligence Layer
   - [ ] Suggestion system
   - [ ] Validation pipeline
   - [ ] Documentation generator
   - [ ] Test generator

4. Integration
   - [ ] Version control
   - [ ] Package management
   - [ ] Deployment pipeline
   - [ ] Collaboration tools
````

## File: docs/alden-docs/implementation/backend/functions.md
````markdown
# Edge Functions Documentation

## Overview
Enso uses Supabase Edge Functions to handle AI operations and real-time processing. These functions are deployed to the edge for low-latency responses and efficient scaling.

## Functions

### find-references
**Purpose:** Detects and extracts references from message text.
```typescript
POST /functions/find-references
{
  "message_text": string,
  "chat_id": string
}
```
- Uses Vertex AI embeddings to find semantically similar content
- Returns references to users, threads, URLs, and files
- Supports real-time reference detection during typing

### generate-embedding
**Purpose:** Generates embeddings for text content using Vertex AI.
```typescript
POST /functions/generate-embedding
{
  "text": string,
  "imageUrl"?: string
}
```
- Supports both text and multimodal content
- Uses `multimodalembedding@001` model
- Returns 1408-dimensional embeddings

### generate-response
**Purpose:** Generates AI responses using DeepSeek's model.
```typescript
POST /functions/generate-response
{
  "prompt": string,
  "context"?: string
}
```
- Uses DeepSeek Chat model for high-quality responses
- Supports contextual prompting
- Returns structured response content

### generate-tags
**Purpose:** Automatically generates relevant tags for content.
```typescript
POST /functions/generate-tags
{
  "content": string
}
```
- Uses Gemini Pro for tag generation
- Returns array of relevant tags
- Supports content categorization

### get-reference-suggestions
**Purpose:** Provides contextual suggestions based on input.
```typescript
POST /functions/get-reference-suggestions
{
  "query": string,
  "chat_id"?: string,
  "type"?: string,
  "limit"?: number,
  "threshold"?: number
}
```
- Combines vector similarity search with AI suggestions
- Returns structured suggestions with metadata
- Supports filtering by type and chat context

### process-embedding-queue
**Purpose:** Background processor for embedding generation queue.
```typescript
POST /functions/process-embedding-queue
```
- Processes pending embedding generation jobs
- Updates job status and stores results
- Handles retries and error logging

### translate
**Purpose:** Provides message translation services.
```typescript
POST /functions/translate
{
  "text": string,
  "targetLang": string
}
```
- Uses Gemini Pro for high-quality translation
- Preserves message context and tone
- Supports multiple target languages

## Common Features

### Error Handling
All functions implement consistent error handling:
- Structured error responses
- Detailed error logging
- Appropriate HTTP status codes

### CORS Support
All functions include CORS headers for cross-origin requests:
- Access-Control-Allow-Origin: *
- Support for required headers and methods
- Pre-flight request handling

### Authentication
Functions requiring authentication use Supabase auth:
- JWT validation
- Role-based access control
- Service role operations where needed

## Development Guidelines

### Local Testing
Use the provided test script:
```bash
pnpm test-fn <function-name>
```

### Deployment
Deploy functions using Supabase CLI:
```bash
supabase functions deploy
```

### Environment Variables
Required variables:
- `GOOGLE_PROJECT_ID`: Google Cloud project ID
- `GOOGLE_CREDENTIALS`: Service account credentials
- `DEEPSEEK_KEY`: DeepSeek API key
- `SUPABASE_URL`: Project URL
- `SUPABASE_SERVICE_ROLE_KEY`: Service role key

## Core Functions

### 1. Embedding Generation
`functions/generate-embedding/index.ts`

```typescript
// Generate embeddings for text content using Vertex AI
async function generateEmbedding(req: Request) {
  const vertexAI = new VertexAI({
    project: Deno.env.get('GOOGLE_PROJECT_ID'),
    location: 'us-central1',
  });

  const model = vertexAI.preview.getGenerativeModel({
    model: 'multimodalembedding@001',
  });

  const { text, imageUrl } = await req.json();
  
  let content;
  if (imageUrl) {
    // Handle multimodal content (text + image)
    content = {
      parts: [
        { text: text || '' },
        { inlineData: { data: imageUrl, mimeType: 'image/jpeg' } }
      ]
    };
  } else {
    // Handle text-only content
    content = { parts: [{ text }] };
  }

  const result = await model.embedContent({ content });

  return new Response(JSON.stringify({
    embedding: result.embedding.values,
    dimension: result.embedding.values.length,
  }));
}
```

### 2. Reference Detection
`functions/find-references/index.ts`

```typescript
// Detect references in messages using regex and database lookups
async function findReferences(req: Request) {
  const { message_text, chat_id } = await req.json();
  const supabase = createClient(/* config */);

  // Find database references (users and threads)
  const { data: dbRefs } = await supabase.rpc(
    "find_references",
    { message_text, chat_id }
  );

  // Find URLs
  const urlRefs = [...message_text.matchAll(urlRegex)]
    .map(match => ({
      type: "url",
      target_id: null,
      context: { url: match[0] }
    }));

  // Find file references
  const fileRefs = [...message_text.matchAll(fileRegex)]
    .map(match => ({
      type: "file",
      target_id: null,
      context: {
        name: match[1],
        url: match[2]
      }
    }));

  return new Response(JSON.stringify({
    references: [...dbRefs, ...urlRefs, ...fileRefs]
  }));
}
```

### 3. Response Generation
`functions/generate-response/index.ts`

```typescript
// Generate AI responses using DeepSeek
async function generateResponse(req: Request) {
  const { prompt, context } = await req.json();
  
  const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${Deno.env.get('DEEPSEEK_KEY')}`,
      'HTTP-Referer': 'https://ddkmozzdyzakphgabdzq.supabase.co',
    },
    body: JSON.stringify({
      model: 'deepseek/deepseek-chat',
      messages: [
        {
          role: 'user',
          content: context ? `${context}\n\n${prompt}` : prompt,
        },
      ],
      temperature: 0.7,
      max_tokens: 1000,
    }),
  });

  const result = await response.json();
  return new Response(JSON.stringify({
    response: result.choices[0].message.content,
  }));
}
```

### 4. Translation
`functions/translate/index.ts`

```typescript
// Translate messages using Vertex AI
async function translate(req: Request) {
  const vertexAI = new VertexAI({
    project: Deno.env.get('GOOGLE_PROJECT_ID'),
    location: 'us-central1',
  });

  const model = vertexAI.preview.getGenerativeModel({
    model: 'gemini-pro',
  });

  const { text, targetLang } = await req.json();
  
  const result = await model.generateContent({
    contents: [{ 
      role: 'user', 
      parts: [{ 
        text: `Translate to ${targetLang}:\n\n${text}` 
      }] 
    }],
  });

  return new Response(JSON.stringify({
    translation: result.response.candidates[0].content.parts[0].text,
  }));
}
```

### 5. Reference Suggestions
`functions/get-reference-suggestions/index.ts`

```typescript
// Get context-aware reference suggestions
async function getReferencesSuggestions(req: Request) {
  const vertexAI = new VertexAI({
    project: Deno.env.get('GOOGLE_PROJECT_ID'),
    location: 'us-central1',
  });

  const { query, type, limit = 5 } = await req.json();
  const supabase = createClient(/* config */);

  // Generate embedding
  const model = vertexAI.preview.getGenerativeModel({
    model: 'embedding-001',
  });
  
  const embedding = await model.embedContent({
    content: { parts: [{ text: query }] },
  });

  // Find similar content
  const { data: semanticResults } = await supabase.rpc(
    'search_references',
    {
      query_embedding: embedding.embedding.values,
      similarity_threshold: 0.6,
      match_count: limit,
      ref_type: type,
    }
  );

  // Get contextual suggestions
  const geminiModel = vertexAI.preview.getGenerativeModel({
    model: 'gemini-pro',
  });

  const contextualResults = await geminiModel.generateContent({
    contents: [{ 
      role: 'user', 
      parts: [{ 
        text: `Suggest ${limit} relevant ${type}s for: ${query}` 
      }] 
    }],
  });

  // Combine and deduplicate
  const combined = [...semanticResults, ...contextualResults];
  const unique = Array.from(
    new Map(combined.map(item => [item.id, item])).values()
  );

  return new Response(JSON.stringify({
    suggestions: unique.slice(0, limit),
  }));
}
```

## Shared Utilities

### CORS Headers
`functions/_shared/cors.ts`

```typescript
export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
};
```

## Deployment & Configuration

### Environment Variables
Required environment variables for the Edge Functions:
```bash
GOOGLE_PROJECT_ID="your-project-id"
GOOGLE_CREDENTIALS="your-credentials-json"
DEEPSEEK_KEY="your-api-key"
SUPABASE_URL="your-project-url"
SUPABASE_SERVICE_ROLE_KEY="your-service-key"
```

### Function Configuration
Each function should have a `deno.json` configuration:
```json
{
  "imports": {
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.38.4"
  }
}
```

## Testing

### Local Testing
Use the Supabase CLI to test functions locally:
```bash
supabase functions serve
```

Test with curl:
```bash
curl -i --location --request POST \
  'http://localhost:54321/functions/v1/generate-embedding' \
  --header 'Authorization: Bearer eyJ...' \
  --header 'Content-Type: application/json' \
  --data '{"text":"Test content"}'
```

### Production Testing
Test deployed functions:
```bash
curl -i --location --request POST \
  'https://[PROJECT_REF].supabase.co/functions/v1/generate-embedding' \
  --header 'Authorization: Bearer eyJ...' \
  --header 'Content-Type: application/json' \
  --data '{"text":"Test content"}'
```

## Error Handling

All functions implement consistent error handling:
```typescript
try {
  // Function logic
} catch (error) {
  console.error('Error:', error);
  return new Response(
    JSON.stringify({ 
      error: error instanceof Error ? error.message : "Unexpected error" 
    }),
    { 
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    }
  );
}
```

## Performance Considerations

1. **Caching**
   - Cache embeddings in Redis
   - Use edge caching for frequent requests
   - Implement request deduplication

2. **Rate Limiting**
   - Implement token bucket algorithm
   - Add retry logic with backoff
   - Use quota management

3. **Optimization**
   - Batch similar requests
   - Use connection pooling
   - Implement request pipelining

## Related Documentation
- [@schema.md](./schema.md): Database schema details
- [@ai_architecture.md](../../architecture/ai_architecture.md): AI system design
- [@ai_flow.md](../../architecture/ai_flow.md): Data flow diagrams
````

## File: docs/alden-docs/implementation/backend/schema.md
````markdown
# Database Schema & Implementation

## Overview

The enso backend uses Supabase PostgreSQL with the following key features:
- Vector embeddings (pgvector) for semantic search
- Real-time subscriptions for live updates
- Row Level Security (RLS) for fine-grained access control
- Edge Functions for AI processing

## Core Tables (Matching DB schema in supabase/scripts/)

### Profiles
```sql
create table public.profiles (
  id uuid references auth.users on delete cascade primary key,
  email text unique not null,
  full_name text,
  avatar_url text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

### Chats
```sql
create table public.chats (
  id uuid primary key default uuid_generate_v4(),
  type text not null check (type in ('personal', 'direct', 'group')),
  title text,
  created_by uuid references public.profiles(id) not null,
  is_archived boolean default false,
  pinned boolean default false,
  last_viewed_at timestamptz,
  labels text[] default array[]::text[],
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

### Chat Participants
```sql
create table public.chat_participants (
  chat_id uuid references public.chats(id) on delete cascade not null,
  user_id uuid references public.profiles(id) on delete cascade not null,
  joined_at timestamptz default now(),
  last_read_at timestamptz default now(),
  primary key (chat_id, user_id)
);
```

### Messages
```sql
create table public.messages (
  id uuid primary key default uuid_generate_v4(),
  chat_id uuid references public.chats(id) on delete cascade not null,
  sender_id uuid references public.profiles(id) on delete cascade not null,
  content text not null,
  embedding vector(1536),
  metadata jsonb default '{}'::jsonb,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

### Files
```sql
create table public.files (
  id uuid primary key default uuid_generate_v4(),
  chat_id uuid references public.chats(id) on delete cascade not null,
  user_id uuid references public.profiles(id) on delete cascade not null,
  path text not null,
  type text not null,
  embedding vector(1536),
  metadata jsonb default '{}'::jsonb,
  created_at timestamptz default now()
);
```

### Contexts
```sql
create table public.contexts (
  id uuid primary key default uuid_generate_v4(),
  type text not null,
  content jsonb not null,
  metadata jsonb default '{}'::jsonb,
  embedding vector(1536),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

### Message Contexts
```sql
create table public.message_contexts (
  message_id uuid references public.messages(id) on delete cascade,
  context_id uuid references public.contexts(id) on delete cascade,
  similarity float,
  metadata jsonb default '{}'::jsonb,
  created_at timestamptz default now(),
  primary key (message_id, context_id)
);
```

### Embedding Queue
```sql
create table public.embedding_queue (
  id uuid primary key default uuid_generate_v4(),
  content_id uuid not null,
  content_type text not null,
  status text not null default 'pending',
  attempts int not null default 0,
  last_error text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

## Indexes

### Performance Indexes
```sql
-- Message lookups
create index idx_messages_chat_id on public.messages(chat_id);

-- Chat organization
create index idx_chats_archived on public.chats(is_archived) where is_archived = true;
create index idx_chats_pinned on public.chats(pinned) where pinned = true;
create index idx_chats_labels on public.chats using gin(labels);

-- Context lookups
create index idx_contexts_type on public.contexts(type);
create index idx_message_contexts_message_id on public.message_contexts(message_id);
create index idx_message_contexts_context_id on public.message_contexts(context_id);

-- Queue management
create index idx_embedding_queue_status on public.embedding_queue(status, created_at);
```

### Vector Indexes
```sql
-- Message embeddings
create index idx_messages_embedding on public.messages 
using ivfflat (embedding vector_cosine_ops)
with (lists = 100);

-- File embeddings
create index idx_files_embedding on public.files 
using ivfflat (embedding vector_cosine_ops)
with (lists = 100);

-- Context embeddings
create index idx_contexts_embedding on public.contexts 
using ivfflat (embedding vector_cosine_ops)
with (lists = 100);
```

## Functions

### Similarity Search
```sql
create or replace function match_messages (
  query_embedding vector(1536),
  match_threshold float,
  match_count int,
  included_chats uuid[] default null
)
returns table (
  id uuid,
  chat_id uuid,
  content text,
  metadata jsonb,
  similarity float
)
language sql stable
as $$
  select
    messages.id,
    messages.chat_id,
    messages.content,
    messages.metadata,
    1 - (messages.embedding <=> query_embedding) as similarity
  from messages
  where 1 - (messages.embedding <=> query_embedding) > match_threshold
    and (included_chats is null or messages.chat_id = any(included_chats))
  order by messages.embedding <=> query_embedding
  limit match_count;
$$;

create or replace function match_files (
  query_embedding vector(1536),
  match_threshold float,
  match_count int,
  included_chats uuid[] default null
)
returns table (
  id uuid,
  chat_id uuid,
  path text,
  type text,
  metadata jsonb,
  similarity float
)
language sql stable
as $$
  select
    files.id,
    files.chat_id,
    files.path,
    files.type,
    files.metadata,
    1 - (files.embedding <=> query_embedding) as similarity
  from files
  where 1 - (files.embedding <=> query_embedding) > match_threshold
    and (included_chats is null or files.chat_id = any(included_chats))
  order by files.embedding <=> query_embedding
  limit match_count;
$$;
```

## Row Level Security (RLS)

### Chat Access
```sql
-- View access
create policy "Users can view their chats"
  on public.chats for select
  using (
    exists (
      select 1 from public.chat_participants
      where chat_id = id and user_id = auth.uid()
    )
  );

-- Creation access
create policy "Users can create chats"
  on public.chats for insert
  with check (auth.uid() = created_by);
```

### Message Access
```sql
-- View access
create policy "Users can view messages in their chats"
  on public.messages for select
  using (
    exists (
      select 1 from public.chat_participants
      where chat_id = messages.chat_id 
      and user_id = auth.uid()
    )
  );

-- Send access
create policy "Users can send messages to their chats"
  on public.messages for insert
  with check (
    exists (
      select 1 from public.chat_participants
      where chat_id = messages.chat_id 
      and user_id = auth.uid()
    )
  );
```

### Context Access
```sql
-- View access
create policy "Users can view contexts in their chats"
  on public.contexts for select
  using (
    exists (
      select 1 from public.message_contexts mc
      join public.messages m on m.id = mc.message_id
      join public.chat_participants cp on cp.chat_id = m.chat_id
      where mc.context_id = contexts.id
      and cp.user_id = auth.uid()
    )
  );

create policy "Users can view message contexts in their chats"
  on public.message_contexts for select
  using (
    exists (
      select 1 from public.messages m
      join public.chat_participants cp on cp.chat_id = m.chat_id
      where m.id = message_contexts.message_id
      and cp.user_id = auth.uid()
    )
  );

create policy "System can manage embedding queue"
  on public.embedding_queue for all
  using (auth.uid() is not null)
  with check (auth.uid() is not null);
```

## Real-time Subscriptions

### Messages
```sql
begin;
  drop publication if exists supabase_realtime;
  create publication supabase_realtime;
commit;

alter publication supabase_realtime 
add table public.chats, public.messages;
```

## Edge Functions

### Embedding Generation
- `generate-embedding/`: Text embedding generation using Vertex AI
- Input: Text content
- Output: 1536-dimensional vector

### Context Detection
- `detect-context/`: Real-time context detection in messages
- Input: Message text and chat ID
- Output: List of detected contexts with metadata

### Knowledge Extraction
- `extract-knowledge/`: Extract structured knowledge from messages
- Input: Message content
- Output: Extracted knowledge in JSON format

## Migrations

See the full migration files in `migrations/` for detailed schema evolution:
- `20240202_init.sql`: Initial schema setup
- `20240203_fix_chat_policies.sql`: Enhanced RLS policies
- `20240204_references.sql`: Reference system
- `20240205_chat_organization.sql`: Chat organization features

## Related Documentation
- [@ai_architecture.md](../architecture/ai_architecture.md): AI system design
- [@ai_flow.md](../architecture/ai_flow.md): Data flow diagrams
- [@implementation_web.md](../implementation/web/implementation_web.md): Web integration
````

## File: docs/alden-docs/implementation/web/components.md
````markdown
# Sidebar Enhancement Plan

## Design Philosophy

The sidebar should embody our core principles from the manifesto:
- Ambient intelligence through smart organization
- Fluid context through natural grouping and filtering
- Spatial memory through consistent layout and visual hierarchy

## Visual Structure

```
‚îå‚îÄ enso ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [user] ‚îÄ‚îê
‚îÇ                                    ‚îÇ
‚îÇ [search chats...]                  ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ ‚îå‚îÄ filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ all ‚Ä¢ personal ‚Ä¢ direct ‚Ä¢ group‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ pinned                             ‚îÇ
‚îÇ ‚îú‚îÄ project planning               ‚îÇ
‚îÇ ‚îî‚îÄ team updates                   ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ recent                             ‚îÇ
‚îÇ ‚îú‚îÄ personal note                  ‚îÇ
‚îÇ ‚îú‚îÄ design feedback                ‚îÇ
‚îÇ ‚îî‚îÄ weekly sync                    ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ [new chat]                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Components

1. **Search Bar**
   - Minimal, full-width design
   - Real-time filtering as you type
   - Searches across titles and recent messages
   - Keyboard shortcut: `‚åòK` / `Ctrl+K`

2. **Filter Tabs**
   - Horizontal scrollable list
   - Pills for easy selection
   - Shows active filter with subtle highlight
   - Categories: all, personal, direct, group
   - Optional: archived view

3. **Pinned Section**
   - Collapsible section
   - Shows pinned chats with distinct styling
   - Drag-and-drop reordering (future)
   - Maximum of 5 pinned items

4. **Recent Chats**
   - Dynamic list based on last activity
   - Shows unread indicators
   - Contextual hover actions
   - Smooth animations for updates

## Interactions

1. **Search Experience**
   ```typescript
   // Debounced search with highlighting
   const handleSearch = debounce((query: string) => {
     dispatch(setChats({
       search: query,
       type: activeFilter
     }))
   }, 150)
   ```

2. **Filter Switching**
   - Instant visual feedback
   - Maintains scroll position when possible
   - Preserves expanded/collapsed states
   - Smooth transitions between views

3. **Chat Organization**
   - Pin/unpin with animation
   - Archive with undo option
   - Quick actions on hover
   - Keyboard navigation support

## Performance Considerations

1. **Data Management**
   - Cache filtered results
   - Paginate large chat lists
   - Preload visible content
   - Background load archived chats

2. **Animation Strategy**
   ```typescript
   // Efficient list updates
   <AnimatePresence mode="popLayout">
     {chats.map(chat => (
       <motion.div
         layout
         initial={{ opacity: 0, y: 20 }}
         animate={{ opacity: 1, y: 0 }}
         exit={{ opacity: 0, y: -20 }}
       >
         <ChatItem chat={chat} />
       </motion.div>
     ))}
   </AnimatePresence>
   ```

3. **State Management**
   - Local state for UI interactions
   - Redux for chat data
   - Optimistic updates
   - Background syncing

## Implementation Phases

### Phase 1: Core Structure
1. Add search bar component
2. Implement filter tabs
3. Split chat list into pinned/recent
4. Add basic animations

### Phase 2: Enhanced Features
1. Enable pin functionality
2. Add archive support
3. Implement search highlighting
4. Add keyboard shortcuts

### Phase 3: Polish
1. Add drag-and-drop
2. Enhance animations
3. Add gesture support
4. Optimize performance

## Integration with AI Features

The sidebar enhancements work in conjunction with our AI capabilities:

1. **Smart Filtering**
   - AI-powered search relevance
   - Context-aware suggestions
   - Semantic grouping

2. **Ambient Organization**
   - Auto-categorization of chats
   - Smart pinning suggestions
   - Context preservation

3. **Predictive Features**
   - Suggest relevant chats
   - Surface related content
   - Anticipate user needs

## Success Metrics

1. **Performance**
   - < 100ms filter switching
   - < 50ms search updates
   - 60fps animations

2. **Usability**
   - Reduced time to find chats
   - Increased use of organization features
   - Positive user feedback

3. **Technical**
   - No jank during animations
   - Efficient memory usage
   - Clean code structure
````

## File: docs/alden-docs/implementation/web/implementation_web.md
````markdown
# Enso Web Implementation Guide

## Tech Stack

- **Framework**: Next.js 15 with App Router and React Server Components
- **Language**: TypeScript
- **Styling**: Tailwind CSS v4 with CSS Variables for theming
- **State Management**: 
  - Redux Toolkit for client-side state
  - RTK Query for server state and data fetching
  - Local storage for persistence
- **Authentication**: Supabase Auth with server-side helpers
- **Database**: Supabase PostgreSQL with Edge Functions
- **AI Features** (see [Core Features](../ai/core_features.md)):
  - Vertex AI for embeddings and chat
  - OpenRouter for model selection
  - Edge functions for AI processing
  - Redis for embedding cache
  - pgvector for similarity search
- **UI Components**: 
  - Radix UI for accessible primitives
  - Headless UI for complex interactions
  - Framer Motion for animations
  - Lucide icons
  - Sonner for toast notifications
- **Development Tools**:
  - ESLint for code quality
  - Prettier for code formatting
  - TypeScript for type safety

## Project Structure

```
enso-web/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                 # Next.js App Router pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/         # Authentication routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/      # Login page
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ signup/     # Signup page
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (app)/          # Protected app routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/       # Chat interface
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/   # User settings
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx      # Root layout
‚îÇ   ‚îú‚îÄ‚îÄ components/         # React components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/            # Base UI components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/          # Auth components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/          # Chat components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ container/ # Chat containers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages/  # Message components
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ references/# Reference components
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shared/        # Shared components
‚îÇ   ‚îú‚îÄ‚îÄ lib/               # Core functionality
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase/      # Supabase client
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redux/         # State management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store.ts   # Redux store
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ slices/    # Feature slices
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/           # AI services
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.ts    # Chat generation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ embedding.ts# Text embedding
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reference.ts# Reference finding
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/         # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ hooks/             # Custom hooks
‚îÇ   ‚îú‚îÄ‚îÄ styles/            # Global styles
‚îÇ   ‚îî‚îÄ‚îÄ types/             # TypeScript types
```

## Key Features

1. **Authentication Flow** ‚úÖ
   - Server-side auth with Supabase
   - Protected routes and middleware
   - Persistent sessions

2. **Chat Interface**
   - Real-time messaging with Supabase üîÑ
   - Message history and context ‚úÖ
   - Markdown support üîÑ
   - Code syntax highlighting üîÑ

3. **AI Features**
   - Text embeddings with Vertex AI ‚úÖ
   - Chat completion with OpenRouter ‚úÖ
   - Reference finding with embeddings ‚úÖ
   - Content translation support ‚úÖ

4. **Theme System** ‚úÖ
   - Dark/Light mode support
   - CSS variables for theming
   - Tailwind CSS styling

5. **State Management** ‚úÖ
   - Redux Toolkit for UI state
   - RTK Query for server state
   - Optimistic updates
   - Local storage persistence

## Implementation Steps

1. **Project Setup** ‚úÖ
   - Initialize Next.js project
   - Configure Tailwind CSS
   - Set up Supabase client
   - Configure Redux store

2. **Authentication** üîÑ
   - Login/signup pages
   - Auth middleware
   - Protected routes
   - Session management

3. **Chat Interface** üîÑ
   - Port chat components from mobile
   - Adapt for web layout
   - Add keyboard shortcuts
   - Implement drag-and-drop

4. **AI Integration** üîÑ
   - Port AI services from mobile
   - Add RTK Query endpoints
   - Implement streaming responses
   - Add progress indicators

5. **Polish & Optimization**
   - Add loading states
   - Implement error handling
   - Add animations
   - Optimize performance

## Development Guidelines

1. **Component Structure**
   - Use TypeScript for all components
   - Follow atomic design
   - Add proper documentation
   - Include unit tests

2. **State Management**
   - Use RTK Query for API calls
   - Implement optimistic updates
   - Handle loading states
   - Manage error states

3. **AI Features**
   - Use streaming for responses
   - Implement retry logic
   - Add fallback models
   - Cache embeddings

4. **Security**
   - Validate all inputs
   - Implement rate limiting
   - Secure API endpoints
   - Handle sensitive data

## Next Steps

1. Port Chat Components from Mobile
   - [ ] ChatContainer
   - [ ] MessageList
   - [ ] MessageInput
   - [ ] ReferencePanel

2. Add AI Endpoints to RTK Query
   - [ ] generateEmbedding
   - [ ] generateResponse
   - [ ] findReferences
   - [ ] translateContent

3. Implement Authentication Flow
   - [ ] Login page
   - [ ] Signup page
   - [ ] Auth middleware
   - [ ] Protected routes

4. Polish User Experience
   - [ ] Loading states
   - [ ] Error handling
   - [ ] Animations
   - [ ] Keyboard shortcuts 

# Web Implementation Details

## System Architecture

### Core Services

1. **Context Engine** (`src/lib/ai/context.ts`)
```typescript
class ContextEngine {
  async detectContext(content: string, context: MessageContext): Promise<ContentAnalysis>
  async findSimilarContent(embedding: number[], options: SearchOptions): Promise<Reference[]>
  async generateSuggestions(content: string, context: MessageContext): Promise<Suggestion[]>
  async mergeContexts(contexts: Context[]): Promise<Context>
  async shareContext(chatId: string, options: ShareOptions): Promise<SharedContext>
  async enhanceContext(chatId: string, options: EnhanceOptions): Promise<EnhancedContext>
}
```

2. **Embedding Service** (`src/lib/ai/embeddings.ts`)
```typescript
class EmbeddingService {
  async generateEmbedding(text: string): Promise<number[]>
  async findSimilar(embedding: number[], options: SimilarityOptions): Promise<SimilarityMatch[]>
  async batchProcess(texts: string[]): Promise<number[][]>
}
```

3. **Knowledge Service** (`src/lib/ai/knowledge.ts`)
```typescript
class KnowledgeService {
  async addNode(type: string, data: any): Promise<string>
  async addEdge(from: string, to: string, type: string): Promise<void>
  async findConnections(nodeId: string, depth: number): Promise<Connection[]>
  async extractKnowledge(content: string): Promise<Knowledge>
  async suggestConnections(context: Context): Promise<Suggestion[]>
  async generateSummary(nodes: string[]): Promise<Summary>
}
```

## UI Components

### Context Components

1. **ContextBar** (`src/components/chat/context/ContextBar.tsx`)
```typescript
interface ContextBarProps {
  chatId: string
  suggestions: Suggestion[]
  onEnhance: () => void
}
```

2. **ContextPreview** (`src/components/chat/context/ContextPreview.tsx`)
```typescript
interface ContextPreviewProps {
  context: Context
  similar: SimilarityMatch[]
  onNavigate: (id: string) => void
}
```

3. **ContextTile** (`src/components/chat/context/ContextTile.tsx`)
```typescript
interface ContextTileProps {
  type: ContextType
  data: any
  similarity?: number
}
```

### Enhanced Chat

1. **MessageInput** (`src/components/chat/messages/MessageInput.tsx`)
```typescript
interface MessageInputProps {
  chatId: string
  onSend: (content: string) => void
  onAttach: (files: File[]) => void
  suggestions: Suggestion[]
}
```

2. **MessageBubble** (`src/components/chat/messages/MessageBubble.tsx`)
```typescript
interface MessageBubbleProps {
  message: Message
  context?: MessageContext
  references?: Reference[]
  onReferenceClick: (ref: Reference) => void
}
```

3. **ReferencePanel** (`src/components/chat/references/ReferencePanel.tsx`)
```typescript
interface ReferencePanelProps {
  references: Reference[]
  onSelect: (ref: Reference) => void
  className?: string
}
```

### Knowledge UI

1. **GraphView** (`src/components/knowledge/GraphView.tsx`)
```typescript
interface GraphViewProps {
  nodes: Node[]
  edges: Edge[]
  onNodeSelect: (id: string) => void
  onEdgeSelect: (id: string) => void
}
```

2. **ConnectionList** (`src/components/knowledge/ConnectionList.tsx`)
```typescript
interface ConnectionListProps {
  connections: Connection[]
  onNavigate: (id: string) => void
}
```

## Data Layer

### Database Schema

1. **Contexts Table**
```sql
create table public.contexts (
  id uuid primary key default uuid_generate_v4(),
  type text not null,
  content jsonb not null,
  metadata jsonb,
  embedding vector(1536),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

2. **Message Contexts Table**
```sql
create table public.message_contexts (
  message_id uuid references public.messages(id),
  context_id uuid references public.contexts(id),
  similarity float,
  metadata jsonb,
  created_at timestamptz default now(),
  primary key (message_id, context_id)
);
```

3. **Context Relationships Table**
```sql
create table public.context_relationships (
  from_id uuid references public.contexts(id),
  to_id uuid references public.contexts(id),
  type text not null,
  metadata jsonb,
  created_at timestamptz default now(),
  primary key (from_id, to_id, type)
);
```

### Edge Functions

1. **Context Detection** (`functions/detect-context/index.ts`)
```typescript
async function detectContext(req: Request) {
  const { content, messageContext } = await req.json()
  const analysis = await contextEngine.detectContext(content, messageContext)
  return new Response(JSON.stringify(analysis))
}
```

2. **Embedding Generation** (`functions/generate-embedding/index.ts`)
```typescript
async function generateEmbedding(req: Request) {
  const { text } = await req.json()
  const embedding = await embeddingService.generateEmbedding(text)
  return new Response(JSON.stringify({ embedding }))
}
```

3. **Knowledge Extraction** (`functions/extract-knowledge/index.ts`)
```typescript
async function extractKnowledge(req: Request) {
  const { content } = await req.json()
  const knowledge = await knowledgeService.extractKnowledge(content)
  return new Response(JSON.stringify(knowledge))
}
```

## Integration Flow

### Message Creation
```typescript
async function createMessage(content: string, chatId: string) {
  // 1. Process message
  const result = await processMessage(content, {
    recentMessages: await getRecentMessages(chatId),
    threadContext: await getThreadContext(chatId)
  })

  // 2. Store message
  const messageId = await storeMessage({
    content,
    chatId,
    embedding: result.embedding
  })

  // 3. Create context links
  await createContextLinks(messageId, result.analysis.references)

  // 4. Update knowledge graph
  await updateKnowledgeGraph(messageId, result.knowledge)

  return {
    messageId,
    suggestions: result.suggestions
  }
}
```

### Context Management
```typescript
async function manageContext(chatId: string) {
  // 1. Get current context
  const context = await getContext(chatId)

  // 2. Find connections
  const connections = await findConnections(context)

  // 3. Generate suggestions
  const suggestions = await generateSuggestions(context)

  // 4. Update UI
  updateContextBar(suggestions)
  updateReferencePanel(connections)
}
```

### Search & Discovery
```typescript
async function searchContent(query: string, options: SearchOptions) {
  // 1. Generate embedding
  const embedding = await generateEmbedding(query)

  // 2. Find similar content
  const similar = await findSimilarContent(embedding, options)

  // 3. Extract context
  const context = await extractContext(similar)

  // 4. Generate preview
  return generatePreview(context)
}
```

## Implementation Phases

### Phase 1: Foundation (Current)
- Basic context detection
- Embedding pipeline setup
- Initial UI components
- Message-level features

### Phase 2: Intelligence
- Enhanced context detection
- Knowledge graph integration
- Smart suggestions
- Thread merging

### Phase 3: Ambient Features
- Real-time enhancements
- Predictive suggestions
- Advanced visualization
- Context sharing

## Next Steps

1. Core Context System
   - Implement ContextEngine
   - Set up embedding pipeline
   - Create detection system

2. UI Development
   - Build context components
   - Enhance message input
   - Create knowledge views

3. Data Integration
   - Set up database schema
   - Implement edge functions
   - Create service layer

4. Testing & Optimization
   - End-to-end testing
   - Performance tuning
   - User feedback loop 

## Core AI Features

### PlusMenu Features
```typescript
interface PlusMenuFeatures {
  // Voice Messages
  voice: {
    recording: VoiceRecorder
    transcription: TranscriptionService
    playback: AudioPlayer
    enhancement: AudioEnhancer
  }

  // Smart References
  references: {
    detection: ReferenceDetector
    preview: PreviewGenerator
    linking: ReferenceLinking
    suggestions: SuggestionEngine
  }

  // Thread Intelligence
  thread: {
    context: ThreadContext
    relationships: ThreadRelationships
    suggestions: ThreadSuggestions
    organization: ThreadOrganizer
  }
}
```

### ChatMenu Features
```typescript
interface ChatMenuFeatures {
  // Share Context
  share: {
    contextDetection: ContextDetector
    privacyFilter: PrivacyManager
    preview: ContextPreview
    export: ContextExporter
  }

  // Merge Threads
  merge: {
    candidates: ThreadMatcher
    conflict: ConflictResolver
    timeline: TimelineManager
    unification: ThreadUnifier
  }

  // Enhance Context
  enhance: {
    analysis: ContextAnalyzer
    suggestions: EnhancementEngine
    knowledge: KnowledgeGraph
    visualization: ContextVisualizer
  }
}
```

## Implementation Status

### 1. Core Services (üîÑ In Progress)
```typescript
// Currently implementing
interface CoreServices {
  // Message Processing
  messageProcessor: {
    parse: MessageParser       // ‚úÖ Done
    embed: MessageEmbedder    // üîÑ In Progress
    analyze: MessageAnalyzer  // ‚è≥ Pending
  }

  // Context Engine
  contextEngine: {
    detect: ContextDetector   // üîÑ In Progress
    relate: ContextLinker     // ‚è≥ Pending
    enhance: ContextEnhancer  // ‚è≥ Pending
  }

  // Knowledge System
  knowledgeSystem: {
    graph: KnowledgeGraph    // ‚è≥ Pending
    search: SemanticSearch   // üîÑ In Progress
    suggest: SuggestionEngine // ‚è≥ Pending
  }
}
```

### 2. UI Components (‚è≥ Pending)
```typescript
// Next to implement
interface UIComponents {
  // Message Components
  messages: {
    input: MessageInput       // Enhanced with AI
    bubble: MessageBubble    // With references
    list: MessageList        // With context
  }

  // Menu Components
  menus: {
    plus: PlusMenu          // AI feature triggers
    chat: ChatMenu         // Context operations
    context: ContextBar    // Context display
  }

  // Preview Components
  previews: {
    reference: ReferencePreview
    context: ContextPreview
    thread: ThreadPreview
  }
}
```

## Implementation Priorities

### Phase 1: Core Message Features
1. **Message Processing** üîÑ
   - [x] Basic message handling
   - [x] Real-time validation
   - [ ] Embedding generation
   - [ ] Context detection

2. **PlusMenu Features** ‚è≥
   - [ ] Voice message recording
   - [ ] Reference detection
   - [ ] Thread intelligence
   - [ ] Preview generation

3. **UI Components** ‚è≥
   - [ ] Enhanced MessageInput
   - [ ] Reference previews
   - [ ] Context indicators
   - [ ] Feature menus

### Phase 2: Context Features
1. **Context Engine** ‚è≥
   - [ ] Context detection
   - [ ] Relationship mapping
   - [ ] Enhancement suggestions
   - [ ] Knowledge graph

2. **ChatMenu Features** ‚è≥
   - [ ] Context sharing
   - [ ] Thread merging
   - [ ] Context enhancement
   - [ ] Visualization

3. **UI Integration** ‚è≥
   - [ ] Context bar
   - [ ] Thread visualization
   - [ ] Knowledge explorer
   - [ ] Enhancement UI

## Next Steps

### Immediate Tasks
1. **Complete Core Services**
   - Finish embedding pipeline
   - Implement context detection
   - Set up knowledge system

2. **Build UI Components**
   - Create PlusMenu
   - Implement MessageInput
   - Add preview components

3. **Add Feature Logic**
   - Voice message handling
   - Reference detection
   - Thread intelligence

### Technical Debt
1. **Performance**
   - Optimize embedding generation
   - Cache common operations
   - Lazy load components

2. **Testing**
   - Unit tests for services
   - Integration tests for features
   - E2E tests for flows

3. **Documentation**
   - API documentation
   - Component storybook
   - Usage examples

## Development Guidelines

### Feature Implementation
1. **Start with Core Logic**
   - Implement service
   - Add state management
   - Create hooks

2. **Add UI Components**
   - Build base component
   - Add interactions
   - Integrate with services

3. **Polish & Test**
   - Add loading states
   - Handle errors
   - Write tests

### Code Organization
```typescript
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlusMenu.tsx       // AI feature triggers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatMenu.tsx      // Context operations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ContextBar.tsx    // Context display
‚îÇ   ‚îî‚îÄ‚îÄ messages/
‚îÇ       ‚îú‚îÄ‚îÄ MessageInput.tsx   // Enhanced input
‚îÇ       ‚îî‚îÄ‚îÄ MessageBubble.tsx // With references
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context.ts        // Context engine
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge.ts      // Knowledge system
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ embedding.ts      // Embedding service
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ voice.ts          // Voice processing
‚îÇ       ‚îú‚îÄ‚îÄ reference.ts      // Reference detection
‚îÇ   ‚îî‚îÄ‚îÄ thread.ts         // Thread intelligence
‚îî‚îÄ‚îÄ hooks/
    ‚îú‚îÄ‚îÄ useAI.ts             // AI feature hooks
    ‚îú‚îÄ‚îÄ useContext.ts        // Context hooks
    ‚îî‚îÄ‚îÄ useVoice.ts         // Voice hooks
```

### State Management
```typescript
interface AIState {
  // Feature states
  features: {
    voice: VoiceState
    reference: ReferenceState
    thread: ThreadState
  }

  // Context state
  context: {
    current: Context
    related: Relationship[]
    suggestions: Suggestion[]
  }

  // UI state
  ui: {
    loading: LoadingState
    previews: PreviewState
    menus: MenuState
  }
} 
```

# Web Implementation Status & Tracking

## Overview
This document serves as the central work tracker for the enso web implementation. For detailed information, see:
- Architecture: [@ai_architecture.md](../../architecture/ai_architecture.md)
- AI Features: [@ai_features.md](../ai_features.md)
- User Stories: [@ai_stories.md](../../features/ai_stories.md)
- Technical Flow: [@ai_flow.md](../../architecture/ai_flow.md)

## Current Status

### Core Infrastructure
- **Project Setup** ‚úÖ
  - Next.js 13 App Router
  - Tailwind CSS
  - Supabase Integration
  - Redux + RTK Query

- **Authentication** ‚úÖ
  - Login/Signup Flow
  - Session Management
  - Protected Routes
  - Middleware

### AI Features Implementation

#### Message Intelligence (üîÑ In Progress)
See [@ai_features.md](../ai_features.md) for detailed specs
- **Embedding Pipeline** üîÑ
  ```typescript
  // lib/ai/embeddings.ts
  - [x] Basic embedding generation
  - [ ] Caching layer
  - [ ] Similarity search
  ```

- **Context Engine** üîÑ
  ```typescript
  // lib/ai/context.ts
  - [x] Basic context detection
  - [ ] Context relationships
  - [ ] Knowledge graph
  ```

- **Reference System** ‚è≥
  ```typescript
  // lib/ai/references.ts
  - [ ] Detection service
  - [ ] Preview generation
  - [ ] Link management
  ```

#### UI Components

- **PlusMenu** üîÑ
  ```typescript
  // components/chat/messages/PlusMenu.tsx
  - [x] Base component
  - [ ] Voice messages
  - [ ] Smart references
  - [ ] Thread intelligence
  ```

- **ChatMenu** üîÑ
  ```typescript
  // components/chat/ChatMenu.tsx
  - [x] Base component
  - [ ] Context sharing
  - [ ] Thread merging
  - [ ] Context enhancement
  ```

- **MessageInput** üîÑ
  ```typescript
  // components/chat/messages/MessageInput.tsx
  - [x] Base functionality
  - [ ] AI suggestions
  - [ ] Reference detection
  - [ ] Context awareness
  ```

### Database Schema (üîÑ In Progress)
See [@ai_flow.md](../../architecture/ai_flow.md) for detailed data flow
```sql
-- Status of required tables
- [x] messages
- [x] chats
- [ ] embeddings
- [ ] references
- [ ] contexts
```

### Edge Functions (‚è≥ Pending)
```typescript
// Required functions
- [ ] generate-embedding
- [ ] detect-references
- [ ] analyze-context
- [ ] enhance-message
```

## Implementation Priorities

### Week of [Current Date]

1. **Embedding Pipeline**
   - [ ] Complete `generateEmbedding` implementation
   - [ ] Add Redis caching layer
   - [ ] Implement similarity search
   - [ ] Add edge function

2. **Reference System**
   - [ ] Implement detection service
   - [ ] Create preview components
   - [ ] Add UI in PlusMenu
   - [ ] Set up edge function

3. **Context Engine**
   - [ ] Finish context detection
   - [ ] Add relationship mapping
   - [ ] Create visualization components
   - [ ] Implement edge function

### Next Week

1. **Message Enhancement**
   - [ ] Smart suggestions
   - [ ] Context awareness
   - [ ] Thread intelligence

2. **UI Polish**
   - [ ] Loading states
   - [ ] Error handling
   - [ ] Animations
   - [ ] Keyboard shortcuts

## Testing Strategy

### Unit Tests
```typescript
// Priority order
1. AI Services
   - [ ] Embedding generation
   - [ ] Context detection
   - [ ] Reference handling

2. UI Components
   - [ ] PlusMenu features
   - [ ] ChatMenu operations
   - [ ] MessageInput enhancements
```

### Integration Tests
```typescript
// Key flows to test
1. Message Flow
   - [ ] Embedding generation
   - [ ] Context detection
   - [ ] Reference handling

2. Context Flow
   - [ ] Context sharing
   - [ ] Thread merging
   - [ ] Enhancement
```

### E2E Tests
```typescript
// Complete user flows
1. Chat Experience
   - [ ] Message sending with AI
   - [ ] Reference handling
   - [ ] Context operations

2. Feature Usage
   - [ ] Voice messages
   - [ ] Smart references
   - [ ] Thread management
```

## Development Guidelines

### Code Organization
```typescript
src/
‚îú‚îÄ‚îÄ components/          // UI Components
‚îÇ   ‚îú‚îÄ‚îÄ chat/           // Chat interface
‚îÇ   ‚îî‚îÄ‚îÄ ui/             // Base components
‚îú‚îÄ‚îÄ lib/                // Core functionality
‚îÇ   ‚îú‚îÄ‚îÄ ai/             // AI services
‚îÇ   ‚îî‚îÄ‚îÄ supabase/       // Database
‚îî‚îÄ‚îÄ hooks/              // Custom hooks
```

### State Management
```typescript
// RTK Query endpoints needed
- [ ] embeddings
- [ ] references
- [ ] contexts
- [ ] suggestions
```

### Performance Optimization
```typescript
// Key areas
- [ ] Embedding caching
- [ ] Context prefetching
- [ ] Component lazy loading
- [ ] API response caching
```

## Next Steps

See [@ai_features.md](../ai_features.md) for detailed feature specs and [@ai_flow.md](../../architecture/ai_flow.md) for technical flows.

1. **Complete Core Services**
   - Finish embedding pipeline
   - Implement reference system
   - Set up context engine

2. **Enhance UI Components**
   - Add AI features to PlusMenu
   - Implement context operations in ChatMenu
   - Enhance MessageInput with AI capabilities

3. **Polish & Launch**
   - Add loading states
   - Implement error handling
   - Add animations
   - Test all flows
````

## File: docs/alden-docs/implementation/web/layout.md
````markdown
# Directory Layout

## Core Structure
```
enso-web/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                    # Next.js App Router pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/            # Authentication routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (app)/             # Protected app routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat/          # Chat interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ about/             # Marketing pages
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ features/          # Feature showcase
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/               # Base UI components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar-button.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ glow-button.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat/             # Chat components
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ container/    # Layout containers
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ChatContainer.tsx
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ChatLayout.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ context/      # Context-aware components
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ContextBar.tsx        # Context tags above input
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ContextPreview.tsx    # Preview for context items
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ContextSuggestions.tsx # Live suggestions
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ContextTile.tsx       # Individual context items
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ messages/     # Message components
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ MessageBubble.tsx
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ MessageInput.tsx      # Enhanced with context
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ MessageList.tsx
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ MessageActions.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ search/       # Search components
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SearchBar.tsx         # Semantic search
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SearchResults.tsx
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ SearchSuggestions.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sidebar/      # Sidebar components
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ ChatList.tsx
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ ChatFilters.tsx
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ PinnedChats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ hooks/               # Custom hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useContext.ts    # Context management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useSearch.ts     # Semantic search
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useReferences.ts # Reference handling
‚îÇ   ‚îî‚îÄ‚îÄ lib/                # Core utilities
‚îÇ       ‚îú‚îÄ‚îÄ ai/             # AI services
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ context.ts   # Context detection
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ search.ts    # Semantic search
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ suggest.ts   # Smart suggestions
‚îÇ       ‚îî‚îÄ‚îÄ utils/          # Utilities
‚îî‚îÄ‚îÄ docs/                   # Documentation
    ‚îú‚îÄ‚îÄ ai.md              # AI features
    ‚îú‚îÄ‚îÄ context.md         # Project context
    ‚îú‚îÄ‚îÄ implementation.md  # Implementation details
    ‚îî‚îÄ‚îÄ manifesto.md       # Vision and philosophy
```

## Key Component Updates Needed

### Context System
- `ContextBar`: Scrollable row of context tags above input
- `ContextPreview`: Rich preview of context items
- `ContextSuggestions`: Live suggestions as you type
- `ContextTile`: Individual context items in messages

### Enhanced Message Input
- Integrate context detection
- Live suggestions
- Reference linking
- Smart completions

### Semantic Search
- Global search with semantic understanding
- Context-aware results
- Live suggestions

## Implementation Priority

1. Context Components
   - Build base context system
   - Implement context detection
   - Add visual components

2. Enhanced Input
   - Upgrade MessageInput
   - Add context integration
   - Implement suggestions

3. Search System
   - Build semantic search
   - Add live results
   - Integrate with context

4. Polish & Integration
   - Unify design system
   - Add animations
   - Optimize performance

## Getting the Layout
To get an up-to-date view of the project structure, run:

```bash
tree . -L 3 -I 'node_modules|.next|.git'
```

## Current Layout (as of Feb 3, 2024)

```
.
‚îú‚îÄ‚îÄ docs/                          # Project documentation
‚îÇ   ‚îú‚îÄ‚îÄ context.md                 # Project overview and guidelines
‚îÇ   ‚îú‚îÄ‚îÄ dir_layout.md             # This file - directory structure
‚îÇ   ‚îú‚îÄ‚îÄ implementation.md         # Implementation details
‚îÇ   ‚îú‚îÄ‚îÄ implementation_web.md     # Web-specific implementation
‚îÇ   ‚îú‚îÄ‚îÄ manifesto.md             # Project vision and goals
‚îÇ   ‚îî‚îÄ‚îÄ structure_init.md        # Initial setup documentation
‚îú‚îÄ‚îÄ enso-supabase/                # Supabase backend
‚îÇ   ‚îú‚îÄ‚îÄ functions/               # Edge functions for AI features
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ find-references     # Real-time reference detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate-embedding  # Text embedding generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate-response   # AI response generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate-tags      # Automatic tag generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-reference-suggestions # Reference suggestions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ translate          # Real-time translation
‚îÇ   ‚îú‚îÄ‚îÄ migrations/            # Database migrations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20240202_init.sql
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20240202_init_fixed.sql
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20240203_fix_chat_policies.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20240203_fix_profile_policy.sql
‚îÇ   ‚îî‚îÄ‚îÄ scripts/              # Utility scripts
‚îÇ       ‚îî‚îÄ‚îÄ test-functions.js # Edge function testing
‚îî‚îÄ‚îÄ enso-web/                    # Next.js web application
    ‚îú‚îÄ‚îÄ public/                 # Static assets
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îú‚îÄ‚îÄ app/               # Next.js app router pages
    ‚îÇ   ‚îú‚îÄ‚îÄ components/        # React components
    ‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # Custom React hooks
    ‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Core utilities
    ‚îÇ   ‚îú‚îÄ‚îÄ middleware.ts     # Next.js middleware
    ‚îÇ   ‚îú‚îÄ‚îÄ styles/           # Global styles
    ‚îÇ   ‚îî‚îÄ‚îÄ types/            # TypeScript types
    ‚îî‚îÄ‚îÄ tailwind.config.ts    # Tailwind configuration
```

## Key Directories for AI Features

### Web Application (`enso-web/`)
- `src/components/chat/`: Chat interface with AI-powered features
  - Message components with real-time reference detection
  - Smart tag input with suggestions
  - Thread management UI
- `src/lib/ai/`: AI-related utilities and hooks
  - Embedding generation and caching
  - Reference detection and linking
  - Translation management
- `src/hooks/`: Custom hooks for AI features
  - `useReferences`: Real-time reference detection
  - `useTranslation`: Message translation
  - `useThreadSuggestions`: Smart thread suggestions

### Supabase Backend (`enso-supabase/`)
- `functions/`: Edge functions for AI processing
  - `find-references/`: Real-time reference detection in messages
  - `generate-embedding/`: Text embedding generation using Vertex AI
  - `generate-response/`: AI response generation with DeepSeek
  - `generate-tags/`: Automatic tag generation for messages
  - `get-reference-suggestions/`: Context-aware reference suggestions
  - `translate/`: Real-time message translation
- `migrations/`: Database schema for AI features
  - Message embeddings storage
  - Reference and tag relationships
  - Thread context management

## Documentation (`docs/`)
- `context.md`: Project overview and AI integration guidelines
- `implementation_web.md`: Web-specific AI feature implementation
- `implementation.md`: General implementation details
- `manifesto.md`: Project vision and AI philosophy
- `structure_init.md`: Initial setup and configuration

## Tags for LLM Sessions

When discussing specific parts of the codebase, use these tags:
- `@components` - UI and feature components
- `@pages` - Next.js pages and routes
- `@lib` - Utilities and core functionality
- `@functions` - Supabase edge functions
- `@docs` - Documentation files
- `@ai` - AI-related features and utilities
- `@hooks` - Custom React hooks
- `@types` - TypeScript type definitions
````

## File: docs/alden-docs/implementation/ai_features.md
````markdown
# AI Features Implementation Tracking

## Existing Components

### Message Components
- `components/chat/messages/MessageInput.tsx` ‚úÖ
- `components/chat/messages/PlusMenu.tsx` ‚úÖ
- `components/chat/ChatMenu.tsx` ‚úÖ
- `components/chat/context/ContextBar.tsx` ‚úÖ

### AI Services
- `lib/ai/embeddings.ts` üîÑ
- `lib/ai/services.ts` üîÑ

## Implementation Plan

### 1. Core AI Services (üîÑ In Progress)

#### Embedding Pipeline
```typescript
// lib/ai/embeddings.ts
interface EmbeddingService {
  generateEmbedding(text: string): Promise<number[]>
  findSimilar(embedding: number[]): Promise<SimilarityMatch[]>
  cacheEmbedding(key: string, embedding: number[]): Promise<void>
}

// Status: üîÑ In Progress
// Next Steps:
// 1. Complete generateEmbedding implementation
// 2. Add caching layer
// 3. Implement similarity search
```

#### AI Services
```typescript
// lib/ai/services.ts
interface AIServices {
  // Message enhancement
  enhanceMessage(content: string): Promise<EnhancedMessage>
  generateSuggestions(context: MessageContext): Promise<Suggestion[]>
  
  // Reference handling
  detectReferences(content: string): Promise<Reference[]>
  generatePreview(reference: Reference): Promise<Preview>
  
  // Context management
  analyzeContext(messages: Message[]): Promise<Context>
  findRelatedContexts(context: Context): Promise<Context[]>
}

// Status: üîÑ In Progress
// Next Steps:
// 1. Implement message enhancement
// 2. Add reference detection
// 3. Set up context analysis
```

### 2. Feature Implementation

#### PlusMenu Features (‚è≥ Pending)
```typescript
// components/chat/messages/PlusMenu.tsx
interface PlusMenuFeatures {
  voice: VoiceFeature        // ‚è≥ Not Started
  references: RefFeature     // üîÑ In Progress
  thread: ThreadFeature      // ‚è≥ Not Started
}

// Next Steps:
// 1. Add reference detection UI
// 2. Implement preview generation
// 3. Add voice message handling
```

#### ChatMenu Features (‚è≥ Pending)
```typescript
// components/chat/ChatMenu.tsx
interface ChatMenuFeatures {
  share: ShareFeature       // ‚è≥ Not Started
  merge: MergeFeature      // ‚è≥ Not Started
  enhance: EnhanceFeature  // üîÑ In Progress
}

// Next Steps:
// 1. Implement context enhancement
// 2. Add sharing functionality
// 3. Set up thread merging
```

#### Context Features (üîÑ In Progress)
```typescript
// components/chat/context/ContextBar.tsx
interface ContextFeatures {
  detection: DetectionFeature    // üîÑ In Progress
  suggestions: SuggestionFeature // ‚è≥ Not Started
  preview: PreviewFeature       // ‚è≥ Not Started
}

// Next Steps:
// 1. Complete context detection
// 2. Add suggestion generation
// 3. Implement preview system
```

### 3. Database Integration

#### Supabase Schema Updates
```sql
-- Status: üîÑ In Progress
-- Next Steps:
-- 1. Add embeddings table
-- 2. Create references table
-- 3. Set up context tables

-- Embeddings Table
create table public.embeddings (
  id uuid primary key default uuid_generate_v4(),
  content_hash text unique not null,
  vector vector(1536) not null,
  metadata jsonb,
  created_at timestamptz default now()
);

-- References Table
create table public.references (
  id uuid primary key default uuid_generate_v4(),
  message_id uuid references messages(id),
  type text not null,
  content jsonb not null,
  embedding_id uuid references embeddings(id),
  created_at timestamptz default now()
);
```

#### Edge Functions
```typescript
// Status: ‚è≥ Pending
// Next Steps:
// 1. Set up embedding generation
// 2. Add reference detection
// 3. Implement context analysis

interface EdgeFunctions {
  generateEmbedding: Function
  detectReferences: Function
  analyzeContext: Function
}
```

## Current Focus

### This Week
1. Complete embedding pipeline
   - [ ] Finish generateEmbedding implementation
   - [ ] Add caching layer
   - [ ] Test with real messages

2. Reference Detection
   - [ ] Implement detection service
   - [ ] Add UI in PlusMenu
   - [ ] Create preview system

3. Context Enhancement
   - [ ] Set up context analysis
   - [ ] Implement suggestion generation
   - [ ] Add UI indicators

### Next Week
1. Voice Messages
   - [ ] Set up recording system
   - [ ] Add transcription service
   - [ ] Implement playback UI

2. Thread Intelligence
   - [ ] Implement relationship detection
   - [ ] Add merging capability
   - [ ] Create visualization system

## Testing Plan

### Unit Tests
- [ ] AI services
- [ ] Embedding functions
- [ ] Context analysis

### Integration Tests
- [ ] Message flow
- [ ] Reference system
- [ ] Context engine

### E2E Tests
- [ ] Complete message flow
- [ ] Reference handling
- [ ] Context management
````

## File: docs/alden-docs/operations/cost_optimization.md
````markdown
# LLM Cost Optimization Strategy

## Model Selection & Routing

### Primary Models
- **DeepSeek**: Primary chat model for standard tasks
  - Cost: ~1/3 of GPT-4
  - Use for: Message analysis, suggestions, basic context
  - Context window: Up to 128k tokens
  
- **Vertex AI**: Specialized tasks and large context
  - Use for: Embeddings, multimodal, file analysis
  - Leverage spot pricing when available
  - Batch processing for cost efficiency

### Optimization Rules

1. **Smart Model Routing**
   ```typescript
   async function routeToOptimalModel(task: AITask): Promise<Model> {
     if (task.contextLength > 128000) return VertexAI
     if (task.requiresMultimodal) return VertexAI
     return DeepSeek
   }
   ```

2. **Context Window Management**
   - Truncate historical context intelligently
   - Use sliding windows for long conversations
   - Compress context using embeddings summaries

3. **Batch Processing**
   ```typescript
   // Batch embeddings generation
   async function batchEmbeddings(messages: Message[]): Promise<Embedding[]> {
     const batchSize = 50
     const batches = chunk(messages, batchSize)
     return Promise.all(batches.map(generateEmbeddings))
   }
   ```

## Caching Strategy

### Embedding Cache
- Cache embeddings for frequently accessed content
- Use tiered caching (Redis + Postgres)
- Implement LRU eviction for optimal memory use

```typescript
class EmbeddingCache {
  private redis: Redis
  private postgres: Pool

  async get(key: string): Promise<Embedding | null> {
    // Try Redis first
    const cached = await this.redis.get(key)
    if (cached) return cached

    // Fall back to Postgres
    return this.postgres.query(
      'SELECT embedding FROM embeddings WHERE key = $1',
      [key]
    )
  }
}
```

### Response Cache
- Cache common AI responses
- Implement semantic caching for similar queries
- Use cache warming for popular content

## Rate Limiting & Quotas

### Free Tier Controls
- Daily limits on AI operations
- Token quotas per user/conversation
- Degraded service over aggressive cutoff

```typescript
class AIQuotaManager {
  async checkQuota(userId: string): Promise<boolean> {
    const dailyUsage = await getDailyUsage(userId)
    const tier = await getUserTier(userId)
    return dailyUsage < tier.dailyLimit
  }
}
```

### Paid Tier Optimization
- Prioritize paid user requests
- Higher quotas but still with reasonable limits
- Optimize for user experience vs cost

## Context Optimization

### Smart Truncation
```typescript
function optimizeContext(
  messages: Message[],
  maxTokens: number
): Message[] {
  return messages
    .sort(byRelevance)
    .slice(0, estimateTokenFit(maxTokens))
}
```

### Embedding Optimization
- Use dimensionality reduction when appropriate
- Implement progressive loading
- Optimize storage format

## Cost Monitoring

### Real-time Metrics
- Track token usage per request
- Monitor cache hit rates
- Alert on unusual patterns

```typescript
interface CostMetrics {
  tokensUsed: number
  cacheHitRate: number
  averageLatency: number
  costPerRequest: number
}
```

### Cost Attribution
- Track costs by feature
- Monitor user-specific usage
- Identify optimization opportunities

## Implementation Priorities

### Phase 1: Foundation
- Basic caching infrastructure
- Simple rate limiting
- Cost monitoring setup

### Phase 2: Optimization
- Smart model routing
- Advanced caching
- Context optimization

### Phase 3: Advanced Features
- Predictive caching
- Dynamic quota adjustment
- ML-based optimization

## Specific Optimizations

### Message Analysis
```typescript
async function analyzeMessage(content: string): Promise<Analysis> {
  // Use cached analysis if available
  const cached = await cache.get(hash(content))
  if (cached) return cached

  // Route to appropriate model
  const model = await routeToOptimalModel({
    type: 'analysis',
    content,
    contextLength: estimateTokens(content)
  })

  return model.analyze(content)
}
```

### Thread Linking
```typescript
async function linkThreads(
  message: Message,
  threshold: number
): Promise<Thread[]> {
  // Use cached embeddings
  const embedding = await getCachedEmbedding(message)
  
  // Efficient similarity search
  return searchSimilarThreads(embedding, {
    limit: 5,
    threshold
  })
}
```

### Semantic Search
- Implement approximate nearest neighbors
- Use tiered search strategy
- Cache frequent searches

## Cost Targets

### Per-User Targets
- Free tier: < $0.50/month
- Plus: < $2.00/month
- Space: < $5.00/month
- Hub: < $15.00/month

### Optimization Goals
- 70% cache hit rate
- 90% efficient model routing
- < 1% overage on quotas

## Monitoring & Adjustment

### Daily Monitoring
- Token usage trends
- Cache performance
- Cost per user
- Model distribution

### Weekly Review
- Usage patterns
- Cost optimization opportunities
- Cache effectiveness
- Quota adjustments

### Monthly Analysis
- Cost per feature
- User behavior impact
- Optimization success
- Strategy adjustment

---

*This is a living document that will be updated based on real-world usage patterns and cost data. The goal is to maintain high-quality AI features while optimizing costs to ensure sustainable service delivery.*
````

## File: docs/alden-docs/vision/manifesto.md
````markdown
# AI-Native Messaging Manifesto

## Beyond Features, Toward Feeling

Traditional messaging apps have become stagnant, trapped in a paradigm of linear conversations and explicit features. AI shouldn't be just another button to press‚Äîit should be the fabric that makes digital conversations feel more naturally human.

## Core Principles

### 1. Ambient Intelligence
- Intelligence should be felt, not seen
- Context should surface naturally, like human memory
- AI should enhance conversation flow, not interrupt it
- The system should understand intent before it's explicitly stated

### 2. Fluid Context
- Conversations are not linear‚Äîthey're interconnected webs of meaning
- Context flows naturally between discussions like streams of thought
- References emerge organically from conversation patterns
- Every message exists within a rich tapestry of related context

### 3. Spatial Memory
- Digital conversations should have a sense of place
- Context should be discoverable through intuitive spatial relationships
- Navigation should feel like moving through spaces of meaning
- Visual design should reinforce cognitive mapping

### 4. Predictive Intelligence
- Anticipate needs before they're expressed
- Surface relevant context at the right moment
- Connect conversations across time and topic
- Make helpful connections without being intrusive

### 5. Emotional Intelligence
- Preserve and understand emotional context
- Adapt interaction patterns to conversation tone
- Maintain emotional continuity across threads
- Respect the human elements of communication

### 6. Seamless Learning
- Grow more helpful through natural interaction
- Learn individual and group communication patterns
- Adapt to each chat's unique culture and dynamics
- Improve without explicit training or feedback

## Implementation Philosophy

### Intelligence as Experience
- Embeddings aren't just for search‚Äîthey're for understanding
- LLMs should enhance natural flow, not generate content
- Every UI element should have contextual awareness
- Features should feel like natural extensions of thought

### Design for Discovery
- Information should be findable through multiple natural paths
- Context should be persistent but not overwhelming
- Navigation should feel like remembering, not searching
- Interfaces should reward exploration and association

### Human-Centered AI
- Technology serves human connection, not the reverse
- Intelligence amplifies human intent and memory
- Privacy and trust are foundational, not optional
- Every feature must enhance genuine communication

## The Future of Conversation

AI-native messaging isn't about adding AI features to existing chat apps. It's about reimagining digital conversation from the ground up, with intelligence woven into its very nature. The goal isn't to make messaging smarter‚Äîit's to make it feel more naturally human.

When we succeed, users won't marvel at the AI. They'll simply feel more understood, more connected, and more empowered in their conversations. That's the true measure of AI-native design: not that it impresses, but that it feels like it should have always been this way.
````

## File: docs/alden-docs/vision/marketing.md
````markdown
# enso Marketing Vision

*Ambient intelligence meets human connection.*

## Core Philosophy

In a world of noise, enso is silence.
In a space of features, enso is feeling.
In a market of products, enso is presence.

We don't sell a chat app.
We craft spaces for thought to flow.
We build rooms where context lives and breathes.
We enable conversations that remember.

## Brand Essence

### Voice
- Clear as mountain air
- Quiet as morning snow
- Sharp as zen insight
- Warm as shared understanding

### Visual Language
- Minimal yet profound
- Space as a medium
- Light as material
- Motion as thought

### Sound Design
- Ambient textures
- Natural resonance
- Digital warmth
- Intentional silence

## The Message

We don't talk about features.
We demonstrate presence.

We don't list capabilities.
We show understanding.

We don't market AI.
We reveal intelligence.

## Marketing Principles

1. **Show, Never Tell**
   - Every interaction is a demonstration
   - Every surface holds meaning
   - Every animation carries intent
   - Every transition tells our story

2. **Space Over Noise**
   - Embrace emptiness
   - Let content breathe
   - Trust in whitespace
   - Find power in pause

3. **Flow Over Force**
   - Guide, don't push
   - Suggest, don't sell
   - Reveal, don't explain
   - Connect, don't convert

4. **Depth Over Surface**
   - Build layers of meaning
   - Reward exploration
   - Hide complexity in simplicity
   - Make every detail matter

## Touchpoints

### Website
- Two sections, infinite depth
- Motion as narrative
- Interaction as demonstration
- Space as invitation

### Social Presence
- Curated moments of clarity
- Thoughtful technological discourse
- Visual poetry in pixels
- Community over promotion

### Content Strategy
- Deep dives into digital mindfulness
- Explorations of ambient computing
- Essays on the future of thought
- Case studies in digital calm

### Community
- Spaces for shared discovery
- Platforms for collective insight
- Forums for mindful innovation
- Gardens for growing ideas

## Growth Strategy

We don't grow through aggression.
We expand through resonance.

1. **Organic Reach**
   - Thought leadership in AI ethics
   - Design philosophy sharing
   - Open-source contributions
   - Community cultivation

2. **Strategic Partnerships**
   - Digital wellness platforms
   - Mindful technology advocates
   - Creative tool makers
   - Knowledge work innovators

3. **Content Ecosystems**
   - Technical blog posts
   - Design process insights
   - Philosophy explorations
   - User experience stories

4. **Community Building**
   - Developer relations
   - Design community engagement
   - AI ethics discussions
   - Digital wellness advocacy

## Pricing Philosophy

Value aligned with values.

- **Personal** (Free)
  *For individual clarity*
  - Core ambient features
  - Personal context building
  - Basic intelligence integration

- **Pro** ($10/mo)
  *For deeper understanding*
  - Enhanced context depth
  - Advanced AI capabilities
  - Expanded history

- **Team** ($20/user/mo)
  *For collective insight*
  - Shared intelligence
  - Team context building
  - Collaborative spaces

## Launch Strategy

### Phase 1: Resonance
- Private beta with thought leaders
- Design community engagement
- Technical blog launch
- Philosophy pieces

### Phase 2: Ripples
- Public beta
- Community building
- Content ecosystem growth
- Partnership development

### Phase 3: Waves
- Full launch
- Marketplace presence
- Enterprise readiness
- Scale with intention

## Metrics That Matter

We measure what matters:
- Depth of engagement over time spent
- Quality of connections over quantity
- Understanding gained over features used
- Community value over viral growth

## The Future

enso isn't just a product to be marketed.
It's a vision of digital life to be realized.
A way of being in the digital age.
A path toward mindful computing.

We don't chase the market.
We create space for something new.
We don't follow trends.
We reveal what's possible.

---

*In the space between thoughts,
in the pause between messages,
in the silence between notifications,
there is enso.*

A new kind of conversation.
Ambient intelligence that grows with you.
````

## File: docs/alden-docs/vision/pricing.md
````markdown
# enso pricing strategy

*ambient intelligence for modern messaging.*

## core philosophy

our pricing reflects our product: elegant, focused, and personal. we believe in delivering real value through AI-enhanced conversations, while keeping things simple and sustainable.

## pricing tiers

### solo ($2/month)
*personal messaging with ambient intelligence.*

- unlimited 1:1 conversations
- basic thread linking & context
- 30-day message history
- 100 AI operations per day
- semantic search
- web & mobile access
- basic integrations (read-only)

### plus ($10/month)
*enhanced intelligence for power users.*

- everything in solo, plus:
- unlimited message history
- 1000 AI operations per day
- advanced semantic search
- voice messages with transcription
- advanced thread linking & context maps
- custom themes
- priority AI queue access
- full integration capabilities
- offline access

### space ($20/month)
*private spaces with shared intelligence.*

- everything in plus, plus:
- private spaces (up to 12 people)
- shared context building
- group semantic search
- space-wide thread linking
- custom space themes
- advanced media sharing
- space-specific AI tuning
- enhanced privacy features
- priority support

## trial program

- 14-day full access trial
- experience all plus features
- no credit card required
- smooth transition to paid plan

## frequently asked questions

### why do all plans require payment?
we use advanced AI models that are costly to run. rather than compromise the experience with a limited free tier, we offer a fair trial and accessible pricing for sustained quality.

### how do AI operations work?
AI operations include message analysis, thread linking, semantic search, and other intelligent features. solo users get 100 operations daily, plus users get 1000, and space users get priority access.

### what happens if i hit my AI operation limit?
you'll still be able to send messages and use basic features. AI features will resume the next day, or you can upgrade your plan for immediate access to more operations.

### do you store my messages?
messages are stored securely and encrypted. solo tier keeps 30 days of history, while plus and space get unlimited history. you can export your data anytime.

### can i switch between plans?
yes, you can upgrade or downgrade at any time. we'll prorate any changes to your subscription.

### what about data privacy?
we take privacy seriously. your messages are encrypted, and you can enable enhanced privacy mode to ensure your data is never used for model training.

### do you offer student discounts?
yes, students with a valid .edu email get 50% off any plan.

### what payment methods do you accept?
we accept all major credit cards and apple pay.

### can i try before subscribing?
yes, new users get a 14-day trial with full plus features. no credit card required to start.

### what's your refund policy?
if you're not satisfied, we offer full refunds within the first 30 days of any paid plan.

## implementation guidelines

### technical requirements
- usage tracking for AI operations
- clear feature gating
- smooth tier transitions
- real-time usage indicators

### user experience
- transparent limit displays
- seamless upgrades
- clear feature comparison
- easy plan switching

## success metrics

### key indicators
- trial to paid conversion rate
- tier progression velocity
- user retention by tier
- feature usage patterns
- group space adoption

## launch strategy

### phase 1: foundation
- launch with solo and plus tiers
- focus on individual value
- build waiting list for space tier

### phase 2: spaces
- introduce space tier
- launch collaborative features
- begin power user program

---

*this pricing strategy is designed to grow with our community while maintaining the simplicity and elegance that defines enso. it will be reviewed and adjusted based on real-world usage data and community feedback.*
````

## File: docs/alden-docs/glossary.md
````markdown
# Glossary

## Core Concepts

### Chat
The primary space for connection and expression. Every chat has its own energy, participants, and evolving story.

Types:
- Personal: Your private space for thoughts, reflections, and self-discovery
- Direct: Intimate 1:1 connections with depth and context
- Group: Shared spaces where stories and experiences interweave

### Message
A moment of expression within a chat's story.
- Content: text, voice notes, visuals, files
- References: internal links to people, moments, and spaces
- Suggestions: smart discoveries and ambient assistance
- Context: the living energy and meaning around the message

### References
Internal links that weave your digital world together:

Types:
- People: Friends and connections you can mention (@)
- Moments: Important messages and shared experiences
- Spaces: Chats and digital hangouts
- Media: Your photos, music, art, files
- Topics: Themes and ideas you've discussed

Properties:
- Unique identity
- Type and essence
- Rich preview
- Metadata (when, where, who)
- Direct linking

### Suggestions
Smart discoveries that enrich your conversations:

Types:
- Related content (both internal and external)
- Web discoveries
- Ambient information (time, location, mood)
- Cultural moments
- Smart assistance

Properties:
- Contextual relevance
- Source (internal/external)
- Rich preview
- Ambient awareness
- Intelligent timing

### Context
The living, breathing environment that drives ambient intelligence:

Components:
- Active references (what's being linked)
- Current suggestions (what's relevant)
- Emotional states and energy
- Environmental awareness (time, place, culture)
- Conversation flow and meaning

## UI Components

### Message Input
Your creative canvas:
- Text and voice expression
- Reference menus (@, #)
- Inline suggestions
- Ambient awareness
- Emotional intelligence

### Reference Menu
Your portal to internal connections:
- User mentions (@)
- Content references (#)
- Space linking
- Rich previews
- Direct linking

### Context Bar
Your ambient awareness display:
- Active references
- Current suggestions
- Shared energy
- Emotional context
- Cultural moments

### Chat Menu
Your space for deeper connection:
- Share: Transfer vibes and context
- Connect: Discover related energies
- Guide: Context-aware suggestions
- Enhance: Enrich the experience

## AI Features

### Smart Suggestions
Intelligent discoveries that respect the vibe:
- Related content detection
- Web enrichment
- Ambient awareness
- Cultural context
- Timing intelligence

### Context Engine
The brain behind ambient intelligence:
- Reference management
- Suggestion generation
- Emotional awareness
- Environmental understanding
- Privacy consciousness

### Knowledge Graph
Your personal web of meaning:
- Reference connections
- Suggestion patterns
- Context relationships
- Emotional mapping
- Experience flows
````

## File: docs/alden-docs/index.md
````markdown
# enso Documentation

## Vision & Philosophy
- [Manifesto](./vision/manifesto.md) - Core principles of ambient intelligence
- [Marketing](./vision/marketing.md) - Brand and growth strategy
- [Pricing](./vision/pricing.md) - Value-aligned pricing model

## Architecture
- [AI Architecture](./architecture/ai_architecture.md) - AI system design
- [AI Flow](./architecture/ai_flow.md) - Data and processing flows
- [Integrations](./architecture/integrations.md) - Platform integration strategy

## Features
- [AI Features](./features/ai_features.md) - Core AI capabilities
- [AI Stories](./features/ai_stories.md) - User scenarios and flows
- [Contexts](./features/contexts.md) - Context system design
- [AI Translation](./features/ai_translation.md) - Language features
- [Inline IDE](./features/inline_ide.md) - Development features

## Implementation
- [Web Components](./implementation/web/components.md) - Component system
- [Web Layout](./implementation/web/layout.md) - Project structure
- [Web Implementation](./implementation/web/implementation_web.md) - Technical details
- [Backend Schema](./implementation/backend/schema.md) - Database design
- [Backend Functions](./implementation/backend/functions.md) - Edge functions

## Design
- [System](./design/system.md) - Design system overview
- [Influences](./design/influences.md) - Design inspiration

## Development
- [LLM Development](./development/llm_driven.md) - AI-driven development

## Operations
- [Cost Optimization](./operations/cost_optimization.md) - AI cost management

## Key Concepts

### Ambient Intelligence
Our core philosophy is that AI should be felt rather than seen. Intelligence is woven into the fabric of conversations, surfacing relevant context and connections naturally.

### Context System
The context engine understands:
- Message-level context (content, references, emotion)
- Thread-level context (topics, relationships, timeline)
- User-level context (preferences, history, relationships)
- Workspace context (projects, teams, knowledge)

### Platform Integration
Seamless integration across:
- Native chat experience
- External platforms (Slack, Discord, etc)
- Development tools
- Knowledge bases

### Implementation Approach
1. **Foundation** (Current)
   - Core context detection
   - Basic embedding pipeline
   - Initial UI components
   - Message-level features

2. **Intelligence** (Next)
   - Enhanced context detection
   - Knowledge graph integration
   - Smart suggestions
   - Thread merging

3. **Ambient Features** (Future)
   - Real-time enhancements
   - Predictive suggestions
   - Advanced visualization
   - Context sharing

4. **Platform Scale** (Future)
   - Cross-platform context
   - Universal knowledge graph
   - Community features
   - Enterprise capabilities

## Getting Started

1. **For New Team Members**
   - Start with the [Manifesto](./vision/manifesto.md)
   - Review the [Design System](./design/system.md)
   - Read [LLM Development](./development/llm_driven.md)

2. **For Developers**
   - See [Web Implementation](./implementation/web/implementation_web.md)
   - Review [AI Architecture](./architecture/ai_architecture.md)
   - Check [Backend Schema](./implementation/backend/schema.md)

3. **For Designers**
   - Start with [Design System](./design/system.md)
   - Review [Influences](./design/influences.md)
   - See [AI Stories](./features/ai_stories.md)
````

## File: docs/alden-docs/MIGRATION_PLAN.md
````markdown
# Alden Migration Plan

## Current State Analysis

### What Exists
- **alden-web**: Single Next.js app with Supabase dependencies
- **Legacy naming**: Package.json still shows "enso-web"
- **AI routes**: Embedded in `/app/api/ai/` directory
- **Auth**: Using Supabase Auth
- **State**: Redux Toolkit for state management
- **Database**: Prisma with Supabase
- **Good UI/UX**: Existing chat components, glass morphism effects

### What's Missing
- **No turborepo structure**: Just a standalone Next.js app
- **No alden-xyz directory**: Need to create proper monorepo
- **No alden-ai**: AI functionality embedded in main app
- **No packages/**: Missing modular architecture
- **Wrong auth**: Using Supabase instead of Clerk

## Migration Steps

### Phase 1: Turborepo Setup (Day 1)
1. **Create alden-xyz turborepo**
   ```bash
   mkdir alden-xyz
   cd alden-xyz
   pnpm init
   ```

2. **Set up workspace structure**
   ```yaml
   # pnpm-workspace.yaml
   packages:
     - 'apps/*'
     - 'packages/*'
   ```

3. **Move alden-web to apps/app**
   ```bash
   mv ../alden-web apps/app
   ```

4. **Update naming from "enso" to "alden"**
   - Update package.json names
   - Search/replace any "enso" references

### Phase 2: Extract AI Functionality (Day 1-2)
1. **Create alden-ai**
   ```bash
   cd .. # Back to alden root
   pnpm create mastra@latest alden-ai
   ```

2. **Migrate AI logic from app/api/ai/**
   - Extract to agents:
     - Message analysis agent
     - Response generation agent
     - Translation agent
     - Tag generation agent
   - Create workflows for multi-step processes
   - Set up tools for embeddings, file processing

3. **Remove AI routes from apps/app**

### Phase 3: Create Core Packages (Day 2-3)

#### packages/mastra
```typescript
// Same pattern as other projects
import { MastraClient } from '@mastra/client-js'

export const mastra = new MastraClient({
  baseUrl: process.env.NEXT_PUBLIC_AI_URL!,
  headers: { 'x-mastra-key': process.env.MASTRA_KEY! }
})

// Export everything
export const agents = mastra.agents
export const workflows = mastra.workflows
export const tools = mastra.tools
export const memory = mastra.memory
export const vectors = mastra.vectors
```

#### packages/api
Migrate services from lib/services/ and add Mastra integration:
- **chatService.ts**: Chat CRUD with AI enhancements
- **messageService.ts**: Message handling with AI processing
- **referenceService.ts**: Context/reference management
- **userService.ts**: User management

#### packages/database
- Move Prisma schema
- Remove Supabase-specific configurations
- Add proper migrations

#### packages/ui
Extract reusable components:
- All glass morphism components
- Command menu
- Chat UI components
- Mobile-responsive elements

### Phase 4: Authentication Migration (Day 3-4)
1. **Remove Supabase Auth**
   - Remove all @supabase packages
   - Delete supabase client files

2. **Implement Clerk**
   - Add Clerk dependencies
   - Set up middleware
   - Update all auth checks
   - Migrate user components

3. **Update Redux slices**
   - Remove Supabase references
   - Add Clerk user management

### Phase 5: State Management Update (Day 4)
1. **Add Jotai for UI state**
   - Modal/sheet management
   - Menu states
   - UI preferences

2. **Keep Redux for complex state**
   - Chat state
   - Message state
   - But consider migration to Zustand

### Phase 6: API Routes Refactor (Day 5)
1. **Update all routes to use packages/api**
2. **Remove direct Mastra calls**
3. **Implement proper error handling**
4. **Add rate limiting**

### Phase 7: Testing & Cleanup (Day 5-6)
1. **Remove all Supabase code**
2. **Fix TypeScript errors**
3. **Update environment variables**
4. **Test core flows**:
   - Authentication
   - Chat creation
   - Message sending with AI
   - File uploads
   - Real-time features

## Priority Features to Preserve

### Core Chat Features
- **Real-time messaging**: Implement with Pusher/Ably
- **File handling**: Migrate to Vercel Blob or R2
- **Message threading**: Keep existing UI
- **@ mentions**: Preserve functionality
- **Context references**: Key differentiator

### AI Features
- **Smart suggestions**: Context-aware responses
- **Message analysis**: Sentiment, topics
- **Translation**: Multi-language support
- **Embeddings**: For search/similarity

### UI/UX Excellence
- **Glass morphism**: Already implemented well
- **Command palette**: Enhance with cmdk
- **Mobile experience**: Already responsive
- **Keyboard shortcuts**: Leader key system

## Environment Variables

### Remove
```
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY
```

### Add
```
# Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
CLERK_SECRET_KEY

# Mastra
NEXT_PUBLIC_AI_URL=http://localhost:4111
MASTRA_KEY=your-key

# Database
DATABASE_URL=postgresql://...

# Real-time (choose one)
PUSHER_APP_ID
ABLY_API_KEY

# Storage
BLOB_READ_WRITE_TOKEN
```

## Risk Mitigation

### Data Migration
- Export all data from Supabase before starting
- Set up local PostgreSQL for testing
- Create migration scripts for users, chats, messages

### Feature Parity
- Document all current features before starting
- Create feature tests
- Ensure no functionality is lost

### Rollback Plan
- Keep alden-web operational until migration complete
- Test thoroughly in staging
- Have database backups

## Success Criteria
- [ ] All "enso" references removed
- [ ] Turborepo structure matches other projects
- [ ] AI functionality in standalone service
- [ ] Clerk authentication working
- [ ] No Supabase dependencies
- [ ] All tests passing
- [ ] Performance equal or better
- [ ] Mobile experience preserved

## Timeline Estimate
- **Total**: 5-6 days of focused development
- **Critical Path**: Auth migration (blocks everything else)
- **Parallel Work**: AI extraction can happen alongside package creation

## Next Steps
1. Set up alden-xyz turborepo structure
2. Create alden-ai with Mastra
3. Begin extracting packages
4. Start auth migration in parallel
````

## File: docs/alden-docs/README.md
````markdown
# enso Documentation

Welcome to the enso documentation. This documentation covers our AI-native messaging platform's vision, architecture, implementation, and development practices.

For full documentation, see [Documentation Index](./index.md).

## Quick Links

### Vision & Philosophy
- [Manifesto](./vision/manifesto.md) - Core principles
- [Marketing](./vision/marketing.md) - Strategy
- [Pricing](./vision/pricing.md) - Model

### Technical
- [AI Architecture](./architecture/ai_architecture.md)
- [Implementation](./implementation/web/implementation_web.md)
- [Schema](./implementation/backend/schema.md)

### Development
- [LLM Development](./development/llm_driven.md)
- [Components](./implementation/web/components.md)
- [Layout](./implementation/web/layout.md)

## Contributing

See our [Documentation Index](./index.md) for complete contribution guidelines.
````

## File: packages/ai/hooks/agents/index.ts
````typescript
// Agent-specific hook exports

export * from '../use-squish-chat';
````

## File: packages/ai/hooks/index.ts
````typescript
// Main hooks exports

// export * from './use-agent'; // Commented out until AI SDK v5 compatibility is resolved
export * from './use-workflow';
export * from './use-tool';
export * from './use-streaming';
export * from './use-squish-chat';
````

## File: packages/ai/hooks/use-agent.ts
````typescript
import { useChat } from '@ai-sdk/react';
import type { Message } from '@ai-sdk/ui-utils';
import { useCallback } from 'react';
import { mastra } from '../mastra';

export interface UseAgentOptions {
  agentId: string;
  api?: string;
  initialMessages?: Message[];
  onFinish?: (message: Message) => void;
  onError?: (error: Error) => void;
  body?: Record<string, any>;
}

/**
 * Generic hook for interacting with Mastra agents
 * Wraps useChat with agent-specific functionality
 */
export function useAgent({
  agentId,
  api = '/api/chat',
  body = {},
  ...options
}: UseAgentOptions) {
  const chat = useChat({
    api,
    ...options,
    body: {
      ...body,
      agentId,
    },
  });

  // Execute a workflow through this agent
  const executeWorkflow = useCallback(
    async (workflowId: string, input: any) => {
      try {
        const result = await mastra.workflows.execute({
          id: workflowId,
          input,
          agentId,
        });
        return result;
      } catch (error) {
        options.onError?.(error as Error);
        throw error;
      }
    },
    [agentId, options.onError]
  );

  // Use a tool through this agent
  const useTool = useCallback(
    async (toolName: string, input: any) => {
      try {
        const result = await mastra.tools.execute({
          name: toolName,
          input,
          agentId,
        });
        return result;
      } catch (error) {
        options.onError?.(error as Error);
        throw error;
      }
    },
    [agentId, options.onError]
  );

  return {
    ...chat,
    agentId,
    executeWorkflow,
    useTool,
  };
}
````

## File: packages/ai/hooks/use-squish-chat.ts
````typescript
'use client';

import { useChat as useAIChat } from '@ai-sdk/react';
import * as React from 'react';
import type { SquishUIMessage } from '../types/squish-chat';

interface SquishChatOptions {
  api?: string;
  userId?: string;
  boardId?: string;
  assetIds?: string[];
  initialMessages?: SquishUIMessage[];
  onFinish?: (message: SquishUIMessage) => void;
  onError?: (error: Error) => void;
}

export function useSquishChat(options: SquishChatOptions = {}) {
  const {
    api = '/api/ai/chat',
    userId,
    boardId,
    assetIds,
    initialMessages,
    onFinish,
    onError,
  } = options;

  const [isOpen, setIsOpen] = React.useState(false);

  // Use the AI SDK v5 useChat hook
  const chatHelpers = useAIChat({
    api,
    initialMessages: initialMessages as any,
    onFinish: onFinish as any,
    onError,
    body: {
      data: {
        userId,
        boardId,
        assetIds,
      },
    },
  } as any);

  const toggleChat = React.useCallback(() => {
    setIsOpen((prev) => !prev);
  }, []);

  const setOpen = React.useCallback((open: boolean) => {
    setIsOpen(open);
  }, []);

  const clearMessages = React.useCallback(() => {
    chatHelpers.setMessages([]);
  }, [chatHelpers]);

  // Return all AI SDK properties plus our custom ones
  return {
    // Spread all the chat helpers from AI SDK
    ...(chatHelpers as any),

    // Add Squish-specific functionality
    isOpen,
    toggleChat,
    setOpen,
    clearMessages,
    // Context data
    data: {
      userId,
      boardId,
      assetIds,
    },
  };
}
````

## File: packages/ai/hooks/use-streaming.ts
````typescript
import { useCallback, useRef, useState } from 'react';

export interface UseStreamingOptions {
  onData?: (data: any) => void;
  onError?: (error: Error) => void;
  onComplete?: () => void;
}

export interface StreamingState {
  isStreaming: boolean;
  error: Error | null;
}

/**
 * Hook for handling streaming responses from Mastra
 */
export function useStreaming({
  onData,
  onError,
  onComplete,
}: UseStreamingOptions = {}) {
  const [state, setState] = useState<StreamingState>({
    isStreaming: false,
    error: null,
  });

  const abortControllerRef = useRef<AbortController | null>(null);

  const stream = useCallback(
    async (url: string, body: any, options?: RequestInit) => {
      // Cancel any existing stream
      if (abortControllerRef.current) {
        abortControllerRef.current.abort();
      }

      // Create new abort controller
      abortControllerRef.current = new AbortController();

      setState({
        isStreaming: true,
        error: null,
      });

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...options?.headers,
          },
          body: JSON.stringify(body),
          signal: abortControllerRef.current.signal,
          ...options,
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body?.getReader();
        const decoder = new TextDecoder();

        if (!reader) {
          throw new Error('No response body');
        }

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            break;
          }

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                onData?.(data);
              } catch (_e) {
                // Ignore parse errors
              }
            }
          }
        }

        onComplete?.();
      } catch (err) {
        if (err instanceof Error && err.name !== 'AbortError') {
          setState((prev) => ({ ...prev, error: err }));
          onError?.(err);
        }
      } finally {
        setState((prev) => ({ ...prev, isStreaming: false }));
        abortControllerRef.current = null;
      }
    },
    [onData, onError, onComplete]
  );

  const cancel = useCallback(() => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
      abortControllerRef.current = null;
      setState((prev) => ({ ...prev, isStreaming: false }));
    }
  }, []);

  return {
    stream,
    cancel,
    ...state,
  };
}
````

## File: packages/ai/hooks/use-tool.ts
````typescript
import { useCallback, useState } from 'react';
import { mastra } from '../mastra';

export interface UseToolOptions {
  toolName: string;
  onSuccess?: (result: any) => void;
  onError?: (error: Error) => void;
}

export interface ToolState {
  isLoading: boolean;
  data: any;
  error: Error | null;
}

/**
 * Hook for executing Mastra tools
 */
export function useTool({ toolName, onSuccess, onError }: UseToolOptions) {
  const [state, setState] = useState<ToolState>({
    isLoading: false,
    data: null,
    error: null,
  });

  const execute = useCallback(
    async (input: any) => {
      setState((prev) => ({
        ...prev,
        isLoading: true,
        error: null,
      }));

      try {
        // Get the tool instance and execute it
        const tool = mastra.getTool(toolName);
        const result = await tool.execute({
          data: input,
        });

        setState((prev) => ({
          ...prev,
          data: result,
          isLoading: false,
        }));

        onSuccess?.(result);
        return result;
      } catch (err) {
        const error = err as Error;
        setState((prev) => ({
          ...prev,
          error,
          isLoading: false,
        }));
        onError?.(error);
        throw error;
      }
    },
    [toolName, onSuccess, onError]
  );

  const reset = useCallback(() => {
    setState({
      isLoading: false,
      data: null,
      error: null,
    });
  }, []);

  return {
    execute,
    reset,
    ...state,
  };
}
````

## File: packages/ai/hooks/use-workflow.ts
````typescript
import { useCallback, useState } from 'react';
import { mastra } from '../mastra';

export interface UseWorkflowOptions {
  workflowId: string;
  onSuccess?: (result: any) => void;
  onError?: (error: Error) => void;
  onProgress?: (progress: any) => void;
}

export interface WorkflowState {
  isLoading: boolean;
  data: any;
  error: Error | null;
  progress: any;
}

/**
 * Hook for executing Mastra workflows with progress tracking
 */
export function useWorkflow({
  workflowId,
  onSuccess,
  onError,
  onProgress,
}: UseWorkflowOptions) {
  const [state, setState] = useState<WorkflowState>({
    isLoading: false,
    data: null,
    error: null,
    progress: null,
  });

  const execute = useCallback(
    async (input: any) => {
      setState((prev) => ({
        ...prev,
        isLoading: true,
        error: null,
      }));

      try {
        // Get the workflow instance
        const workflow = mastra.getWorkflow(workflowId);

        // Create a run
        const run = await workflow.createRun();

        // Watch the workflow for updates
        workflow.watch({ runId: run.runId }, (record) => {
          // Update progress state
          setState((prev) => ({ ...prev, progress: record }));
          onProgress?.(record);
        });

        // Start the workflow
        const result = await workflow.startAsync({
          runId: run.runId,
          inputData: input,
        });

        setState((prev) => ({
          ...prev,
          data: result,
          isLoading: false,
        }));
        onSuccess?.(result);
      } catch (err) {
        const error = err as Error;
        setState((prev) => ({
          ...prev,
          error,
          isLoading: false,
        }));
        onError?.(error);
      }
    },
    [workflowId, onSuccess, onError, onProgress]
  );

  const reset = useCallback(() => {
    setState({
      isLoading: false,
      data: null,
      error: null,
      progress: null,
    });
  }, []);

  return {
    execute,
    reset,
    ...state,
  };
}
````

## File: packages/ai/types/agents.ts
````typescript
import type { UIMessage } from 'ai';

/**
 * Agent response with metadata
 */
export interface AgentResponse {
  message: UIMessage;
  usage?: TokenUsage;
  metadata?: Record<string, any>;
}

/**
 * Token usage information
 */
export interface TokenUsage {
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
}

/**
 * Agent streaming response
 */
export interface AgentStreamResponse {
  stream: ReadableStream;
  toDataStreamResponse: () => Response;
  toTextStreamResponse: () => Response;
  toUIMessageStreamResponse: () => Response;
}

/**
 * Agent configuration
 */
export interface AgentConfig {
  id: string;
  name: string;
  description?: string;
  model?: string;
  temperature?: number;
  maxTokens?: number;
  tools?: string[];
  systemPrompt?: string;
}

/**
 * Agent execution options
 */
export interface AgentExecutionOptions {
  runtimeContext?: Record<string, any>;
  stream?: boolean;
  temperature?: number;
  maxTokens?: number;
  tools?: string[];
}
````

## File: packages/ai/types/index.ts
````typescript
// Main type exports

export * from './agents';
export * from './workflows';
export * from './tools';
export * from './streaming';
export * from './runtime';
export * from './squish-chat';
````

## File: packages/ai/types/runtime.ts
````typescript
/**
 * Runtime context for passing data to agents/workflows/tools
 */
export interface RuntimeContext {
  userId?: string;
  sessionId?: string;
  requestId?: string;
  metadata?: Record<string, any>;
  [key: string]: any;
}

/**
 * Runtime options
 */
export interface RuntimeOptions {
  timeout?: number;
  retries?: number;
  cache?: boolean;
  debug?: boolean;
}
````

## File: packages/ai/types/squish-chat.ts
````typescript
// Squish-specific AI chat types for AI SDK v5
import type { UIDataTypes, UIMessage, UITools } from 'ai';

// Define metadata for Squish messages
export interface SquishMessageMetadata {
  // Model information
  model?: string;
  totalTokens?: number;

  // Squish-specific context
  boardId?: string;
  assetIds?: string[];
  userId?: string;

  // Timing information
  duration?: number;
  timestamp?: string;
}

// Define custom data parts for Squish
export interface SquishDataParts extends UIDataTypes {
  // Board-related data parts
  'data-board-update': {
    boardId: string;
    action: 'created' | 'updated' | 'deleted';
    board?: {
      id: string;
      name: string;
      emoji?: string;
    };
  };

  // Asset-related data parts
  'data-asset-update': {
    assetId: string;
    boardId?: string;
    action: 'added' | 'removed' | 'updated' | 'analyzed';
    asset?: {
      id: string;
      name: string;
      type: string;
      url?: string;
    };
  };

  // Status updates
  'data-status': {
    status: 'searching' | 'analyzing' | 'organizing' | 'completed' | 'error';
    message?: string;
    progress?: number;
  };

  // Search results
  'data-search-results': {
    query: string;
    results: Array<{
      id: string;
      type: 'board' | 'asset' | 'user';
      name: string;
      relevance: number;
    }>;
    totalCount: number;
  };
}

// Define Squish tools
export interface SquishTools extends UITools {
  // Board management tools
  'tool-searchBoards': {
    input: {
      query: string;
      limit?: number;
      includeCollaborated?: boolean;
    };
    output: {
      boards: Array<{
        id: string;
        name: string;
        emoji?: string;
        assetCount: number;
        createdAt: string;
      }>;
    };
  };

  'tool-createBoard': {
    input: {
      name: string;
      emoji?: string;
      description?: string;
    };
    output: {
      board: {
        id: string;
        name: string;
        emoji?: string;
        url: string;
      };
    };
  };

  // Asset management tools
  'tool-searchAssets': {
    input: {
      query?: string;
      boardId?: string;
      type?: 'image' | 'video' | 'audio' | 'text';
      limit?: number;
    };
    output: {
      assets: Array<{
        id: string;
        name: string;
        type: string;
        boardId: string;
        boardName: string;
        url: string;
      }>;
    };
  };

  'tool-analyzeAssets': {
    input: {
      assetIds: string[];
      analysisType: 'themes' | 'colors' | 'content' | 'similarity';
    };
    output: {
      analysis: {
        type: string;
        results: Record<string, any>;
        suggestions: string[];
      };
    };
  };

  'tool-organizeAssets': {
    input: {
      assetIds: string[];
      strategy: 'by-theme' | 'by-color' | 'by-date' | 'by-type';
      targetBoardId?: string;
    };
    output: {
      organized: Array<{
        groupName: string;
        assetIds: string[];
        reason: string;
      }>;
      boardsCreated?: string[];
    };
  };
}

// Custom UIMessage type for Squish
export type SquishUIMessage = UIMessage<
  SquishMessageMetadata,
  SquishDataParts,
  SquishTools
>;

// Helper type for tool names
export type SquishToolName = keyof SquishTools;

// Helper type for data part types
export type SquishDataPartType = keyof SquishDataParts;

// Type guard for Squish messages
export function isSquishUIMessage(message: any): message is SquishUIMessage {
  return message && typeof message === 'object' && 'role' in message;
}

// Type guard for specific tool parts
export function isSquishToolPart<T extends SquishToolName>(
  part: any,
  toolName: T
): part is Extract<SquishUIMessage['parts'][number], { type: T }> {
  return part && part.type === toolName;
}
````

## File: packages/ai/types/streaming.ts
````typescript
/**
 * Stream data types
 */
export type StreamDataType =
  | 'text'
  | 'function_call'
  | 'tool_call'
  | 'data'
  | 'error'
  | 'finish';

/**
 * Stream chunk
 */
export interface StreamChunk {
  type: StreamDataType;
  data: any;
  id?: string;
  timestamp?: string;
}

/**
 * Stream options
 */
export interface StreamOptions {
  onStart?: () => void;
  onToken?: (token: string) => void;
  onText?: (text: string) => void;
  onFunctionCall?: (functionCall: any) => void;
  onToolCall?: (toolCall: any) => void;
  onFinish?: (result: any) => void;
  onError?: (error: Error) => void;
}

/**
 * Stream response
 */
export interface StreamResponse {
  stream: ReadableStream;
  headers?: Headers;
  status?: number;
}
````

## File: packages/ai/types/tools.ts
````typescript
/**
 * Tool execution input
 */
export interface ToolInput {
  name: string;
  input: any;
  agentId?: string;
  runtimeContext?: Record<string, any>;
}

/**
 * Tool execution result
 */
export interface ToolResult {
  name: string;
  output: any;
  metadata?: ToolMetadata;
}

/**
 * Tool metadata
 */
export interface ToolMetadata {
  executionTime: number;
  version?: string;
  [key: string]: any;
}

/**
 * Tool definition
 */
export interface ToolDefinition {
  name: string;
  description: string;
  inputSchema?: any;
  outputSchema?: any;
  parameters?: ToolParameter[];
}

/**
 * Tool parameter
 */
export interface ToolParameter {
  name: string;
  type: 'string' | 'number' | 'boolean' | 'object' | 'array';
  description?: string;
  required?: boolean;
  default?: any;
}
````

## File: packages/ai/types/workflows.ts
````typescript
/**
 * Workflow execution input
 */
export interface WorkflowInput {
  id: string;
  input: any;
  agentId?: string;
  runtimeContext?: Record<string, any>;
}

/**
 * Workflow execution result
 */
export interface WorkflowResult {
  id: string;
  status: 'success' | 'error' | 'cancelled';
  output?: any;
  error?: Error;
  metadata?: WorkflowMetadata;
}

/**
 * Workflow metadata
 */
export interface WorkflowMetadata {
  startTime: string;
  endTime: string;
  duration: number;
  steps: WorkflowStep[];
}

/**
 * Workflow step information
 */
export interface WorkflowStep {
  id: string;
  name: string;
  status: 'pending' | 'running' | 'completed' | 'failed';
  startTime?: string;
  endTime?: string;
  output?: any;
  error?: Error;
}

/**
 * Workflow stream chunk
 */
export interface WorkflowStreamChunk {
  type: 'progress' | 'result' | 'error';
  data: any;
  timestamp: string;
}
````

## File: packages/ai/utils/errors.ts
````typescript
/**
 * Custom error class for AI operations
 */
export class AIError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode?: number,
    public details?: any
  ) {
    super(message);
    this.name = 'AIError';
  }
}

/**
 * Create an error from an API response
 */
export async function createErrorFromResponse(
  response: Response
): Promise<AIError> {
  let message = `HTTP error! status: ${response.status}`;
  let details: any;

  try {
    const data = await response.json();
    message = data.error?.message || data.message || message;
    details = data;
  } catch {
    // If response is not JSON, use status text
    message = response.statusText || message;
  }

  return new AIError(
    message,
    `HTTP_${response.status}`,
    response.status,
    details
  );
}

/**
 * Check if an error is retryable
 */
export function isRetryableError(error: Error): boolean {
  if (error instanceof AIError && error.statusCode) {
    // Retry on rate limits and server errors
    return (
      error.statusCode === 429 ||
      (error.statusCode >= 500 && error.statusCode < 600)
    );
  }

  // Retry on network errors
  return (
    error.message.includes('fetch failed') ||
    error.message.includes('network') ||
    error.message.includes('ECONNREFUSED')
  );
}

/**
 * Wrap an async function with error handling
 */
export function withErrorHandling<T extends (...args: any[]) => Promise<any>>(
  fn: T,
  errorHandler?: (error: Error) => void
): T {
  return (async (...args: Parameters<T>) => {
    try {
      return await fn(...args);
    } catch (error) {
      const aiError =
        error instanceof AIError
          ? error
          : new AIError(
              error instanceof Error ? error.message : 'Unknown error',
              'UNKNOWN_ERROR'
            );

      errorHandler?.(aiError);
      throw aiError;
    }
  }) as T;
}
````

## File: packages/ai/utils/extract-text-content.ts
````typescript
/**
 * Extract text content from AI SDK v5 message content
 * Handles different content formats: string, parts array, or complex objects
 */
export function extractTextContent(content: unknown): string {
  if (typeof content === 'string') {
    return content;
  }

  if (Array.isArray(content)) {
    return content
      .filter(
        (part): part is { type: 'text'; text: string } =>
          part && typeof part === 'object' && part.type === 'text'
      )
      .map((part) => part.text)
      .join(' ');
  }

  if (content && typeof content === 'object' && 'text' in content) {
    return (content as { text: string }).text;
  }

  return '';
}
````

## File: packages/ai/utils/format.ts
````typescript
import type { UIMessage } from 'ai';

/**
 * Format messages for display
 */
export function formatMessages(messages: UIMessage[]): string {
  return messages
    .map((m) => {
      // Extract text content from parts
      const textParts = m.parts?.filter((p) => p.type === 'text') || [];
      const content = textParts.map((p) => p.text).join('');
      return `${m.role}: ${content}`;
    })
    .join('\n');
}

/**
 * Extract text content from a message
 * Re-export from existing file
 */
export { extractTextContent } from './extract-text-content';

/**
 * Truncate text to a maximum length
 */
export function truncateText(text: string, maxLength: number): string {
  if (text.length <= maxLength) {
    return text;
  }
  return `${text.slice(0, maxLength - 3)}...`;
}

/**
 * Format timestamp for display
 */
export function formatTimestamp(timestamp: string | Date): string {
  const date = new Date(timestamp);
  return new Intl.DateTimeFormat('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
  }).format(date);
}

/**
 * Format bytes to human readable size
 */
export function formatBytes(bytes: number): string {
  const units = ['B', 'KB', 'MB', 'GB'];
  let size = bytes;
  let unitIndex = 0;

  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024;
    unitIndex++;
  }

  return `${size.toFixed(2)} ${units[unitIndex]}`;
}
````

## File: packages/ai/utils/index.ts
````typescript
// Main utility exports

export * from './runtime-context';
export * from './stream';
export * from './format';
export * from './errors';
export * from './extract-text-content';
````

## File: packages/ai/utils/runtime-context.ts
````typescript
import type { RuntimeContext } from '../types/runtime';

/**
 * Create a runtime context from request data
 */
export function createRuntimeContext(
  data: Record<string, any>
): RuntimeContext {
  return {
    requestId: crypto.randomUUID(),
    timestamp: new Date().toISOString(),
    ...data,
  };
}

/**
 * Extract runtime context from a request
 */
export async function extractRuntimeContext(
  request: Request
): Promise<RuntimeContext> {
  try {
    const body = await request.json();
    const { data = {}, ...rest } = body;

    // Extract headers that might be useful
    const headers: Record<string, string> = {};
    request.headers.forEach((value, key) => {
      if (key.startsWith('x-') || key === 'user-agent') {
        headers[key] = value;
      }
    });

    return createRuntimeContext({
      ...data,
      headers,
      method: request.method,
      url: request.url,
    });
  } catch (_error) {
    return createRuntimeContext({});
  }
}

/**
 * Merge multiple runtime contexts
 */
export function mergeRuntimeContexts(
  ...contexts: RuntimeContext[]
): RuntimeContext {
  return contexts.reduce(
    (merged, context) => ({
      ...merged,
      ...context,
      metadata: {
        ...merged.metadata,
        ...context.metadata,
      },
    }),
    {} as RuntimeContext
  );
}
````

## File: packages/ai/utils/stream.ts
````typescript
/**
 * Convert a ReadableStream to an async iterator
 */
export async function* streamToAsyncIterator(
  stream: ReadableStream
): AsyncIterableIterator<Uint8Array> {
  const reader = stream.getReader();

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) {
        break;
      }
      yield value;
    }
  } finally {
    reader.releaseLock();
  }
}

/**
 * Parse SSE (Server-Sent Events) from a stream
 */
export async function* parseSSEStream(
  stream: ReadableStream
): AsyncIterableIterator<any> {
  const decoder = new TextDecoder();
  let buffer = '';

  for await (const chunk of streamToAsyncIterator(stream)) {
    buffer += decoder.decode(chunk, { stream: true });
    const lines = buffer.split('\n');

    // Keep the last incomplete line in the buffer
    buffer = lines.at(-1) || '';

    for (let i = 0; i < lines.length - 1; i++) {
      const line = lines[i].trim();

      if (line.startsWith('data: ')) {
        const data = line.slice(6);
        if (data === '[DONE]') {
          return;
        }

        try {
          yield JSON.parse(data);
        } catch (_e) {}
      }
    }
  }
}

/**
 * Create a TransformStream for SSE formatting
 */
export function createSSETransformStream(): TransformStream {
  const encoder = new TextEncoder();

  return new TransformStream({
    transform(chunk: any, controller) {
      const data = typeof chunk === 'string' ? chunk : JSON.stringify(chunk);
      controller.enqueue(encoder.encode(`data: ${data}\n\n`));
    },

    flush(controller) {
      controller.enqueue(encoder.encode('data: [DONE]\n\n'));
    },
  });
}

/**
 * Merge multiple streams into one
 */
export function mergeStreams(...streams: ReadableStream[]): ReadableStream {
  return new ReadableStream({
    async start(controller) {
      const readers = streams.map((s) => s.getReader());

      await Promise.all(
        readers.map(async (reader) => {
          try {
            while (true) {
              const { done, value } = await reader.read();
              if (done) {
                break;
              }
              controller.enqueue(value);
            }
          } finally {
            reader.releaseLock();
          }
        })
      );

      controller.close();
    },
  });
}
````

## File: packages/ai/CLAUDE.md
````markdown
# @repo/ai Package Context

## Development Standards

### Package Context
This package provides AI SDK v5 integration utilities and hooks for the Squish ecosystem. It bridges the frontend applications with the AI service, offering typed APIs, streaming responses, and AI-powered features throughout the application.

### Technology Stack
- **AI SDK**: v5 with streaming support
- **React**: 19+ compatibility
- **TypeScript**: 5.7+ strict configuration
- **Mastra Integration**: Latest API client
- ** Streaming**: Real-time AI responses

### Key Dependencies
```json
{
  "dependencies": {
    "ai": "^3.4.33",
    "@ai-sdk/openai": "^1.0.13",
    "@ai-sdk/google": "^1.0.13",
    "@repo/analytics": "workspace:*",
    "@repo/auth": "workspace:*",
    "react": "^19.1.0",
    "zod": "^3.25.28"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@types/react": "^18.3.17"
  }
}
```

## Package Structure

### Directory Layout
```
src/
‚îú‚îÄ‚îÄ index.ts              # Main package exports
‚îú‚îÄ‚îÄ client/               # AI client configurations
‚îÇ   ‚îú‚îÄ‚îÄ ai-client.ts      # Mastra AI client
‚îÇ   ‚îú‚îÄ‚îÄ openai-client.ts  # OpenAI client wrapper
‚îÇ   ‚îú‚îÄ‚îÄ google-client.ts  # Google AI client
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Client exports
‚îú‚îÄ‚îÄ hooks/                # React hooks for AI features
‚îÇ   ‚îú‚îÄ‚îÄ useChat.ts        # Chat completion hook
‚îÇ   ‚îú‚îÄ‚îÄ useCompletion.ts  # Single completion hook
‚îÇ   ‚îú‚îÄ‚îÄ useStream.ts      # Stream response hook
‚îÇ   ‚îú‚îÄ‚îÄ useSearch.ts      # AI search hook
‚îÇ   ‚îú‚îÄ‚îÄ useAnalysis.ts    # Content analysis hook
‚îÇ   ‚îú‚îÄ‚îÄ useEmbedding.ts   # Embedding generation hook
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Hook exports
‚îú‚îÄ‚îÄ types/                # AI-specific type definitions
‚îÇ   ‚îú‚îÄ‚îÄ chat.ts           # Chat-related types
‚îÇ   ‚îú‚îÄ‚îÄ completion.ts     # Completion types
‚îÇ   ‚îú‚îÄ‚îÄ streaming.ts      # Streaming types
‚îÇ   ‚îú‚îÄ‚îÄ search.ts         # Search types
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Type exports
‚îú‚îÄ‚îÄ utils/                # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ prompts.ts        # Prompt builders
‚îÇ   ‚îú‚îÄ‚îÄ formatting.ts     # Response formatting
‚îÇ   ‚îú‚îÄ‚îÄ validation.ts     # Input validation
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Utility exports
‚îú‚îÄ‚îÄ prompts/              # AI prompt templates
‚îÇ   ‚îú‚îÄ‚îÄ chat.ts           # Chat prompt templates
‚îÇ   ‚îú‚îÄ‚îÄ search.ts         # Search prompt templates
‚îÇ   ‚îú‚îÄ‚îÄ analysis.ts       # Analysis prompt templates
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Template exports
‚îî‚îÄ‚îÄ constants/            # AI constants and configurations
    ‚îú‚îÄ‚îÄ models.ts         # Model configurations
    ‚îú‚îÄ‚îÄ providers.ts      # Provider settings
    ‚îî‚îÄ‚îÄ index.ts          # Constant exports
```

## AI Client Patterns

### Mastra AI Client
```typescript
// src/client/ai-client.ts
import { createMastraClient } from '@mastra/client';

export const aiClient = createMastraClient({
  baseUrl: process.env.AI_SERVICE_URL || 'http://localhost:9998',
  headers: async () => {
    const token = await getToken(); // Get auth token from @repo/auth
    return {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    };
  },
});

// Typed API methods
export const ai = {
  async chat(messages: Message[], options?: ChatOptions) {
    const response = await aiClient.post('/chat', {
      messages,
      stream: options?.stream || false,
      model: options?.model || 'gemini-1.5-pro',
    });
    return response.data;
  },
  
  async search(query: string, filters?: SearchFilters) {
    const response = await aiClient.post('/search', {
      query,
      filters,
    });
    return response.data;
  },
  
  streamChat(messages: Message[]) {
    return aiClient.stream('/chat/stream', {
      messages,
    });
  },
};
```

### Provider-Specific Clients
```typescript
// src/client/google-client.ts
import { google } from '@ai-sdk/google';

export const googleAI = google({
  apiKey: process.env.GOOGLE_AI_API_KEY,
});

// Usage in components
const { text, finishReason } = await generateText({
  model: googleAI('gemini-1.5-pro'),
  prompt: 'Write a haiku about programming',
});
```

## React Hooks Patterns

### Chat Hook
```typescript
// src/hooks/useChat.ts
import { useCompletion } from 'ai/react';

interface UseChatOptions {
  api?: string;
  initialMessages?: Message[];
  onFinish?: (message: Message) => void;
  onError?: (error: Error) => void;
}

export function useChat(options: UseChatOptions = {}) {
  const {
    messages,
    input,
    setInput,
    handleSubmit,
    isLoading,
    error,
  } = useCompletion({
    api: options.api || '/api/chat',
    initialMessages: options.initialMessages,
    onFinish: options.onFinish,
    onError: options.onError,
  });
  
  // Custom functionality
  const sendMessage = useCallback(async (content: string) => {
    const message = { role: 'user', content };
    handleSubmit({
      preventDefault: () => {},
    } as any);
  }, [handleSubmit]);
  
  return {
    messages,
    input,
    setInput,
    sendMessage,
    isLoading,
    error,
  };
}
```

### Streaming Hook
```typescript
// src/hooks/useStream.ts
export function useStream(
  endpoint: string,
  onData: (data: any) => void,
  onError?: (error: Error) => void
) {
  const [isStreaming, setIsStreaming] = useState(false);
  const [error, setError] = useState<Error | null>(null);
  
  const stream = useCallback(async (payload: any) => {
    setIsStreaming(true);
    setError(null);
    
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      
      while (reader) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));
            onData(data);
          }
        }
      }
    } catch (err) {
      setError(err as Error);
      onError?.(err as Error);
    } finally {
      setIsStreaming(false);
    }
  }, [endpoint, onData, onError]);
  
  return { stream, isStreaming, error };
}
```

## Type Safety Patterns

### AI Response Types
```typescript
// src/types/chat.ts
export interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp?: string;
  metadata?: Record<string, any>;
}

export interface ChatOptions {
  model?: string;
  temperature?: number;
  maxTokens?: number;
  stream?: boolean;
  tools?: Tool[];
}

export interface Tool {
  name: string;
  description: string;
  parameters: Record<string, any>;
}

export interface ChatResponse {
  message: Message;
  usage: TokenUsage;
  finishReason: string;
  timestamp: string;
}

export interface TokenUsage {
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
}
```

## Prompt Engineering Patterns

### Template System
```typescript
// src/prompts/templates.ts
export const promptTemplates = {
  codeReview: `
    You are a senior software engineer reviewing code.
    
    Context:
    - Language: {language}
    - Framework: {framework}
    - Purpose: {purpose}
    
    Code to review:
    ```
    {code}
    ```
    
    Provide:
    1. Overall assessment
    2. Specific issues found
    3. Improvement suggestions
    4. Security considerations
  `,
  
  contentAnalysis: `
    Analyze the following content and extract key insights:
    
    Content: {content}
    Focus areas: {focusAreas}
    
    Return JSON with:
    - summary: string
    - keyPoints: string[]
    - sentiment: 'positive' | 'neutral' | 'negative'
    - topics: string[]
    - confidence: number
  `,
};
```

### Prompt Builder
```typescript
// src/utils/prompts.ts
export class PromptBuilder {
  private variables: Record<string, string> = {};
  private context: string[] = [];
  
  addVariable(key: string, value: string) {
    this.variables[key] = value;
    return this;
  }
  
  addContext(context: string) {
    this.context.push(context);
    return this;
  }
  
  build(template: string): string {
    let result = template;
    
    // Replace variables
    for (const [key, value] of Object.entries(this.variables)) {
      result = result.replace(new RegExp(`{${key}}`, 'g'), value);
    }
    
    // Add context at the beginning
    if (this.context.length > 0) {
      result = `Context:\n${this.context.join('\n')}\n\n${result}`;
    }
    
    return result;
  }
  
  reset() {
    this.variables = {};
    this.context = [];
    return this;
  }
}
```

## Integration Patterns

### AI Feature Component
```typescript
// Example usage in apps/app
import { useChat, useStream } from '@repo/ai';
import { ai } from '@repo/ai/client';

function AIAssistant() {
  const { messages, input, setInput, sendMessage, isLoading } = useChat({
    api: '/api/ai/chat',
    onFinish: (message) => {
      // Track completion
      trackEvent('ai_chat_completed', {
        messageCount: messages.length + 1,
      });
    },
  });
  
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (input.trim()) {
      sendMessage(input);
    }
  };
  
  return (
    <div className="ai-assistant">
      <div className="messages">
        {messages.map((msg, i) => (
          <Message key={i} message={msg} />
        ))}
      </div>
      
      <form onSubmit={handleSubmit}>
        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="Ask AI anything..."
          disabled={isLoading}
        />
        <button type="submit" disabled={isLoading}>
          {isLoading ? 'Thinking...' : 'Send'}
        </button>
      </form>
    </div>
  );
}
```

## Testing Patterns

### Mock AI Responses
```typescript
// tests/__mocks__/ai.ts
export const mockAI = {
  chat: vi.fn().mockResolvedValue({
    message: { role: 'assistant', content: 'Mock response' },
    usage: { promptTokens: 10, completionTokens: 5, totalTokens: 15 },
    finishReason: 'stop',
  }),
  
  search: vi.fn().mockResolvedValue({
    results: [
      { id: '1', score: 0.9, content: 'Result 1' },
      { id: '2', score: 0.8, content: 'Result 2' },
    ],
  }),
};

// Test hook usage
test('useChat should send and receive messages', () => {
  const { result } = renderHook(() => useChat(), {
    wrapper: ({ children }) => (
      <AIProvider mockClient={mockAI}>
        {children}
      </AIProvider>
    ),
  });
  
  const { sendMessage } = result.current;
  
  await act(async () => {
    sendMessage('Hello');
  });
  
  expect(mockAI.chat).toHaveBeenCalledWith(
    expect.arrayContaining([
      expect.objectContaining({ content: 'Hello' })
    ])
  );
});
```

## Common Tasks

### Adding a New AI Hook
1. Create hook in `src/hooks/[feature].ts`
2. Add TypeScript types in `src/types/`
3. Export from `src/hooks/index.ts`
4. Write tests for the hook
5. Update documentation

### Adding a New AI Provider
1. Create client in `src/client/[provider].ts`
2. Add provider types to corresponding types
3. Update client exports in `src/client/index.ts`
4. Add configuration constants
5. Test integration

### Creating New Prompt Templates
1. Add template to appropriate file in `src/prompts/`
2. Define variables using `{variable}` syntax
3. Add type safety with TypeScript interfaces
4. Test template with various inputs
5. Document usage patterns

## Files to Know

- `src/client/ai-client.ts` - Main AI client configuration
- `src/hooks/useChat.ts` - Chat completion hook
- `src/hooks/useStream.ts` - Streaming response hook
- `src/types/chat.ts` - Chat-related TypeScript types
- `src/prompts/templates.ts` - Prompt template library

## Quality Checklist

Before committing changes to this package:
- [ ] All hooks properly typed with TypeScript
- [ ] AI client calls have error handling
- [ ] Streaming implementations support cancellation
- [ ] Prompt templates are properly escaped
- [ ] Tests pass with mock AI responses
- [ ] No sensitive data in prompts or logs
- [ ] Analytics events tracked appropriately
- [ ] Performance considered for streaming
- [ ] Documentation updated for new features
- [ ] Hook dependencies optimized

---

*This context ensures Claude Code understands the AI package structure and patterns when working on AI integrations.*
````

## File: packages/ai/client.ts
````typescript
// Client-side exports
export * from '@ai-sdk/react';
````

## File: packages/ai/index.ts
````typescript
// Main exports - following auth package pattern
// Main barrel export for @repo/ai package
// Re-export everything for convenience

export * from './client';
export * from './mastra';
export * from './hooks';
export * from './types';
export * from './utils';
export * from './keys';

// Specific hook export
export * from './hooks/use-squish-chat';
````

## File: packages/ai/keys.ts
````typescript
import { createEnv } from '@t3-oss/env-nextjs';
import { z } from 'zod';

export const keys = () =>
  createEnv({
    server: {
      OPENAI_API_KEY: z.string().min(1).startsWith('sk-'),
      OPENROUTER_API_KEY: z.string().min(1).startsWith('sk-or-'),
    },
    client: {
      NEXT_PUBLIC_AI_URL: z.string().url().default('http://localhost:3999'),
    },
    runtimeEnv: {
      OPENAI_API_KEY: process.env.OPENAI_API_KEY,
      OPENROUTER_API_KEY: process.env.OPENROUTER_API_KEY,
      NEXT_PUBLIC_AI_URL: process.env.NEXT_PUBLIC_AI_URL,
    },
  });
````

## File: packages/ai/mastra.ts
````typescript
import { MastraClient } from '@mastra/client-js';

// Simple factory function - no business logic
export function createMastraClient(config?: {
  baseUrl?: string;
  apiKey?: string;
}) {
  const headers: Record<string, string> = {};

  if (config?.apiKey || process.env.MASTRA_KEY) {
    headers['x-mastra-key'] = config?.apiKey || process.env.MASTRA_KEY!;
  }

  return new MastraClient({
    baseUrl:
      config?.baseUrl ||
      process.env.NEXT_PUBLIC_AI_URL ||
      'http://localhost:3999',
    headers,
  });
}

// Default singleton instance for convenience
export const mastra = createMastraClient();
````

## File: packages/ai/package.json
````json
{
  "name": "@repo/ai",
  "version": "0.0.0",
  "private": true,
  "exports": {
    ".": "./index.ts",
    "./client": "./client.ts",
    "./server": "./server.ts",
    "./react": "./react.ts",
    "./mastra": "./mastra.ts",
    "./hooks": "./hooks/index.ts",
    "./hooks/agents": "./hooks/agents/index.ts",
    "./types": "./types/index.ts",
    "./utils": "./utils/index.ts",
    "./keys": "./keys.ts"
  },
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  },
  "dependencies": {
    "@ai-sdk/anthropic": "^2.0.0",
    "@ai-sdk/google": "^2.0.0",
    "@ai-sdk/openai": "^2.0.0",
    "@ai-sdk/react": "^2.0.0",
    "@ai-sdk/ui-utils": "^1.2.11",
    "@mastra/client-js": "latest",
    "@openrouter/ai-sdk-provider": "^0.7.3",
    "@t3-oss/env-nextjs": "^0.13.4",
    "ai": "^5.0.0",
    "react": "^19.1.0",
    "zod": "^3.24.3"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@types/node": "22.15.3",
    "@types/react": "19.1.2",
    "@types/react-dom": "^19.1.3",
    "typescript": "^5.8.3"
  }
}
````

## File: packages/ai/react.ts
````typescript
// AI SDK v5 React exports for Squish
export {
  useChat,
  useCompletion,
  experimental_useObject as useObject,
} from '@ai-sdk/react';
export { DefaultChatTransport } from 'ai';

// Type exports
export type {
  UIMessage,
  ModelMessage,
} from 'ai';

// Squish Chat specific hooks using v5 patterns
export { useSquishChat } from './hooks/use-squish-chat';

// Utilities
export { extractTextContent } from './utils/extract-text-content';
````

## File: packages/ai/README.md
````markdown
# @repo/ai

Project-agnostic AI package following the auth package pattern. Direct re-exports from AI SDK v5 with optional Mastra utilities.

## Installation

```bash
bun add @repo/ai
```

## Usage

### Client-side (React)
```typescript
import { useChat } from '@repo/ai/client';

const { messages, input, handleSubmit } = useChat({
  api: '/api/chat', // Your app defines the endpoint
});
```

### Server-side (API Routes)
```typescript
import { streamText } from '@repo/ai/server';
import { openai } from '@ai-sdk/openai';

const result = streamText({
  model: openai('gpt-4'),
  messages,
});

return result.toDataStreamResponse();
```

### With Mastra (Optional)
```typescript
import { mastra } from '@repo/ai';

const agent = mastra.getAgent('chat');
const stream = agent.stream(messages);
```

## Structure

Following the auth package pattern:
- `client.ts` - Re-exports from `@ai-sdk/react`
- `server.ts` - Re-exports from `ai`
- `mastra.ts` - Optional Mastra utilities
- No business logic, completely project-agnostic

## Environment Variables

```bash
# For Mastra integration (optional)
NEXT_PUBLIC_AI_URL=http://localhost:3999
MASTRA_KEY=your-api-key # Production only

# For OpenRouter (optional)
OPENROUTER_API_KEY=sk-or-...

# For OpenAI (optional)
OPENAI_API_KEY=sk-...
```

## Examples

See the [examples](./examples/) directory for usage patterns.
````

## File: packages/ai/server.ts
````typescript
// Server-side exports
export * from 'ai';
````

## File: packages/ai/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "baseUrl": "."
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules", "examples.bak"]
}
````

## File: packages/analytics/src/posthog/client.tsx
````typescript
'use client';

import posthog from 'posthog-js';
import { PostHogProvider as Provider } from 'posthog-js/react';
import { type ReactNode, useEffect, useState } from 'react';
import { keys } from '../keys';

type PostHogProviderProps = {
  children: ReactNode;
};

const { NEXT_PUBLIC_POSTHOG_KEY, NEXT_PUBLIC_POSTHOG_HOST } = keys();
const enabled = Boolean(NEXT_PUBLIC_POSTHOG_KEY && NEXT_PUBLIC_POSTHOG_HOST);

// Generate a temporary anonymous ID
const generateAnonymousId = () => {
  return `anon_${Math.random().toString(36).substr(2, 9)}`;
};

export const PostHogProvider = ({ children }: PostHogProviderProps) => {
  const [isInitialized, setIsInitialized] = useState(false);

  useEffect(() => {
    if (!isInitialized && typeof window !== 'undefined') {
      const isDev = process.env.NODE_ENV === 'development';

      if (!enabled) {
        setIsInitialized(true);
        return;
      }

      if (isDev) {
        // Provide mock implementation for development
        (window as any).posthog = {
          capture: (..._args: any[]) => {},
          identify: (..._args: any[]) => {},
        };
      }

      const initPostHog = () => {
        try {
          const distinctId =
            localStorage.getItem('ph_anonymous_id') || generateAnonymousId();

          if (!localStorage.getItem('ph_anonymous_id')) {
            localStorage.setItem('ph_anonymous_id', distinctId);
          }

          posthog.init(NEXT_PUBLIC_POSTHOG_KEY!, {
            api_host: NEXT_PUBLIC_POSTHOG_HOST!,
            loaded: (posthog) => {
              if (process.env.NODE_ENV === 'development') {
                posthog.debug();
              }
              posthog.identify(distinctId);
              setIsInitialized(true);
            },
            bootstrap: {
              distinctID: distinctId,
              isIdentifiedID: false,
              featureFlags: {},
            },
            persistence: 'localStorage+cookie',
            autocapture: { dom_event_allowlist: ['click', 'submit'] },
            capture_pageview: true,
            capture_pageleave: true,
            disable_session_recording: isDev,
          });
        } catch (_error) {
          setIsInitialized(true);
          return false;
        }
        return true;
      };

      initPostHog();
    }
  }, [isInitialized, enabled]);

  // Only render provider once initialized
  if (!isInitialized || !enabled) {
    return children;
  }

  return <Provider client={posthog}>{children}</Provider>;
};
````

## File: packages/analytics/src/events.ts
````typescript
'use client';

import posthog from 'posthog-js';

// Page view events
export const trackPageView = (path: string, props?: Record<string, any>) => {
  posthog.capture('$pageview', {
    path,
    ...props,
  });
};

// Authentication events
export const trackAuthEvent = (
  event: 'sign_in' | 'sign_up' | 'sign_out' | 'password_reset',
  props?: Record<string, any>
) => {
  posthog.capture(`auth_${event}`, {
    ...props,
  });
};

// User interaction events
export const trackInteraction = (
  element: string,
  action: 'click' | 'hover' | 'submit',
  props?: Record<string, any>
) => {
  posthog.capture('user_interaction', {
    element,
    action,
    ...props,
  });
};

// Feature usage events
export const trackFeatureUsage = (
  feature: string,
  action: 'view' | 'start' | 'complete' | 'error',
  props?: Record<string, any>
) => {
  posthog.capture('feature_usage', {
    feature,
    action,
    ...props,
  });
};

// Error events
export const trackError = (
  error: Error,
  context: string,
  props?: Record<string, any>
) => {
  posthog.capture('error_occurred', {
    error_name: error.name,
    error_message: error.message,
    error_stack: error.stack,
    context,
    ...props,
  });
};
````

## File: packages/analytics/src/google.tsx
````typescript
import Script from 'next/script';

type GoogleAnalyticsProps = {
  gaId: string;
};

export const GoogleAnalytics = ({ gaId }: GoogleAnalyticsProps) => (
  <>
    <Script
      src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}
      strategy="afterInteractive"
    />
    <Script id="google-analytics" strategy="afterInteractive">
      {`
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '${gaId}');
      `}
    </Script>
  </>
);
````

## File: packages/analytics/src/hooks.ts
````typescript
'use client';

import { usePathname, useSearchParams } from 'next/navigation';
import { useEffect } from 'react';
import { trackPageView } from './events';

export const usePageView = () => {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (pathname) {
      const url = searchParams?.size
        ? `${pathname}?${searchParams.toString()}`
        : pathname;

      trackPageView(url, {
        referrer: document.referrer,
        title: document.title,
      });
    }
  }, [pathname, searchParams]);
};

export const useTrackMounted = (
  componentName: string,
  props?: Record<string, any>
) => {
  useEffect(() => {
    trackPageView(`component_mounted_${componentName}`, props);
  }, [componentName, props]);
};
````

## File: packages/analytics/src/index.tsx
````typescript
import type { ReactNode } from 'react';
import { GoogleAnalytics } from './google';
import { keys } from './keys';
import { PostHogProvider } from './posthog/client';
import { VercelAnalytics } from './vercel';

type AnalyticsProviderProps = {
  children: ReactNode;
};

const { NEXT_PUBLIC_GA_MEASUREMENT_ID } = keys();

export const AnalyticsProvider = ({ children }: AnalyticsProviderProps) => (
  <PostHogProvider>
    {children}
    <VercelAnalytics />
    {NEXT_PUBLIC_GA_MEASUREMENT_ID && (
      <GoogleAnalytics gaId={NEXT_PUBLIC_GA_MEASUREMENT_ID} />
    )}
  </PostHogProvider>
);

// Re-export analytics utilities
export * from './events';
export * from './hooks';
export { posthog } from 'posthog-js';
````

## File: packages/analytics/src/keys.ts
````typescript
import { createEnv } from '@t3-oss/env-nextjs';
import { z } from 'zod';

export const keys = () =>
  createEnv({
    client: {
      NEXT_PUBLIC_POSTHOG_KEY: z.string().min(1).startsWith('phc_').optional(),
      NEXT_PUBLIC_POSTHOG_HOST: z.string().min(1).url().optional(),
      NEXT_PUBLIC_GA_MEASUREMENT_ID: z
        .string()
        .min(1)
        .startsWith('G-')
        .optional(),
    },
    runtimeEnv: {
      NEXT_PUBLIC_POSTHOG_KEY: process.env.NEXT_PUBLIC_POSTHOG_KEY,
      NEXT_PUBLIC_POSTHOG_HOST: process.env.NEXT_PUBLIC_POSTHOG_HOST,
      NEXT_PUBLIC_GA_MEASUREMENT_ID: process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID,
    },
  });
````

## File: packages/analytics/src/vercel.ts
````typescript
export { Analytics as VercelAnalytics } from '@vercel/analytics/react';
````

## File: packages/analytics/src/vercel.tsx
````typescript
import { Analytics } from '@vercel/analytics/react';

export const VercelAnalytics = () => <Analytics />;
````

## File: packages/analytics/CLAUDE.md
````markdown
# @repo/analytics Package Context

## Development Standards

### Package Context
This package provides analytics tracking capabilities for the Squish ecosystem, integrating with PostHog and Vercel Analytics. It offers a unified API for tracking user events, page views, and custom metrics across all applications.

### Technology Stack
- **PostHog**: 1.205.0 - Product analytics and event tracking
- **Vercel Analytics**: Web vitals and performance metrics
- **React**: 19+ compatibility
- **TypeScript**: 5.7+ strict configuration

### Key Dependencies
```json
{
  "dependencies": {
    "posthog-js": "^1.205.0",
    "@vercel/analytics": "^1.5.0",
    "@repo/auth": "workspace:*",
    "react": "^19.1.0"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*"
  }
}
```

## Package Structure

### Directory Layout
```
src/
‚îú‚îÄ‚îÄ index.ts              # Main package exports
‚îú‚îÄ‚îÄ providers/            # Analytics provider configurations
‚îÇ   ‚îú‚îÄ‚îÄ posthog.ts       # PostHog provider setup
‚îÇ   ‚îú‚îÄ‚îÄ vercel.ts        # Vercel Analytics setup
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Provider exports
‚îú‚îÄ‚îÄ hooks/                # React hooks for analytics
‚îÇ   ‚îú‚îÄ‚îÄ useAnalytics.ts  # Main analytics hook
‚îÇ   ‚îú‚îÄ‚îÄ useEventTracking.ts # Event tracking hook
‚îÇ   ‚îú‚îÄ‚îÄ usePageView.ts   # Page view tracking
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Hook exports
‚îú‚îÄ‚îÄ events/               # Event definitions and types
‚îÇ   ‚îú‚îÄ‚îÄ user.ts          # User-related events
‚îÇ   ‚îú‚îÄ‚îÄ board.ts         # Board-related events
‚îÇ   ‚îú‚îÄ‚îÄ asset.ts         # Asset-related events
‚îÇ   ‚îú‚îÄ‚îÄ search.ts        # Search-related events
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Event exports
‚îú‚îÄ‚îÄ utils/                # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ identifiers.ts   # User session identification
‚îÇ   ‚îú‚îÄ‚îÄ properties.ts    # Event properties
‚îÇ   ‚îú‚îÄ‚îÄ filtering.ts     # Data filtering for privacy
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Utility exports
‚îî‚îÄ‚îÄ types/                # TypeScript type definitions
    ‚îú‚îÄ‚îÄ events.ts        # Event types
    ‚îú‚îÄ‚îÄ providers.ts     # Provider types
    ‚îú‚îÄ‚îÄ properties.ts    # Property types
    ‚îî‚îÄ‚îÄ index.ts         # Type exports
```

## Analytics Provider Patterns

### PostHog Integration
```typescript
// src/providers/posthog.ts
import posthog from 'posthog-js';

export class PostHogProvider {
  private initialized = false;
  
  init(apiKey: string, options?: {
    apiHost?: string;
    autocapture?: boolean;
    capturePageview?: boolean;
    capturePageleave?: boolean;
  }) {
    if (this.initialized) return;
    
    posthog.init(apiKey, {
      apiHost: options?.apiHost || 'https://app.posthog.com',
      autocapture: options?.autocapture ?? false,
      capture_pageview: options?.capturePageview ?? false,
      capture_pageleave: options?.capturePageleave ?? true,
      loaded: (posthog) => {
        // Custom initialization logic
        console.log('PostHog loaded successfully');
      },
    });
    
    this.initialized = true;
  }
  
  capture(event: string, properties?: Record<string, any>) {
    if (!this.initialized) {
      console.warn('PostHog not initialized');
      return;
    }
    
    posthog.capture(event, {
      ...properties,
      timestamp: new Date().toISOString(),
    });
  }
  
  identify(userId: string, properties?: Record<string, any>) {
    if (!this.initialized) return;
    
    posthog.identify(userId, {
      ...properties,
      $created: new Date().toISOString(),
    });
  }
  
  reset() {
    posthog.reset();
  }
  
  optOut() {
    posthog.opt_out_capturing();
  }
  
  optIn() {
    posthog.opt_in_capturing();
  }
}
```

### Vercel Analytics Integration
```typescript
// src/providers/vercel.ts
import { Analytics } from '@vercel/analytics/react';

export class VercelAnalyticsProvider {
  private enabled = process.env.NODE_ENV === 'production';
  
  getAnalyticsComponent() {
    if (!this.enabled) return null;
    
    return <Analytics
      beforeSend={(event) => {
        // Filter sensitive URLs
        if (event.url.includes('/api/')) {
          return null;
        }
        return event;
      }}
    />;
  }
  
  trackWebVitals(metric: any) {
    if (!this.enabled) return;
    
    // Send web vitals to custom analytics
    this.capture('web_vital', {
      name: metric.name,
      value: metric.value,
      id: metric.id,
    });
  }
}
```

## React Hooks Patterns

### Main Analytics Hook
```typescript
// src/hooks/useAnalytics.ts
interface UseAnalyticsOptions {
  enabled?: boolean;
  debug?: boolean;
}

export function useAnalytics(options: UseAnalyticsOptions = {}) {
  const { enabled = true, debug = false } = options;
  const { user } = useAuth();
  
  useEffect(() => {
    if (!enabled || !user) return;
    
    // Identify user in analytics
    analytics.identify(user.id, {
      email: user.email,
      name: user.name,
      created_at: user.createdAt,
    });
  }, [user, enabled]);
  
  const capture = useCallback((event: string, properties?: Record<string, any>) => {
    if (!enabled) {
      if (debug) {
        console.log('[Analytics Debug]', event, properties);
      }
      return;
    }
    
    analytics.capture(event, {
      ...properties,
      user_id: user?.id,
      timestamp: new Date().toISOString(),
    });
  }, [enabled, user, debug]);
  
  const pageView = useCallback((path: string, properties?: Record<string, any>) => {
    capture('page_view', {
      path,
      referrer: document.referrer,
      ...properties,
    });
  }, [capture]);
  
  return {
    capture,
    pageView,
    identify: analytics.identify.bind(analytics),
    reset: analytics.reset.bind(analytics),
  };
}
```

### Event-Specific Hooks
```typescript
// src/hooks/useEventTracking.ts
export function useBoardEvents() {
  const analytics = useAnalytics();
  
  const trackBoardCreated = useCallback((boardId: string, boardName: string) => {
    analytics.capture('board_created', {
      board_id: boardId,
      board_name: boardName,
    });
  }, [analytics]);
  
  const trackBoardUpdated = useCallback((boardId: string, changes: Record<string, any>) => {
    analytics.capture('board_updated', {
      board_id: boardId,
      changed_fields: Object.keys(changes),
    });
  }, [analytics]);
  
  const trackBoardDeleted = useCallback((boardId: string) => {
    analytics.capture('board_deleted', {
      board_id: boardId,
    });
  }, [analytics]);
  
  return {
    trackBoardCreated,
    trackBoardUpdated,
    trackBoardDeleted,
  };
}
```

## Event Definitions

### Event Type System
```typescript
// src/events/index.ts
type UserEvent = 
  | { type: 'user_signed_up'; properties: UserSignupProperties }
  | { type: 'user_signed_in'; properties: UserSignInProperties }
  | { type: 'user_signed_out'; properties: {} };

type BoardEvent = 
  | { type: 'board_created'; properties: BoardCreatedProperties }
  | { type: 'board_viewed'; properties: BoardViewedProperties }
  | { type: 'board_updated'; properties: BoardUpdatedProperties }
  | { type: 'board_deleted'; properties: BoardDeletedProperties };

type AssetEvent = 
  | { type: 'asset_uploaded'; properties: AssetUploadedProperties }
  | { type: 'asset_viewed'; properties: AssetViewedProperties }
  | { type: 'asset_deleted'; properties: AssetDeletedProperties };

type AnalyticsEvent = UserEvent | BoardEvent | AssetEvent;
```

### Event Properties
```typescript
// src/events/user.ts
export interface UserSignupProperties {
  method: 'email' | 'google' | 'github';
  referral_code?: string;
  utm_source?: string;
  utm_medium?: string;
  utm_campaign?: string;
}

export interface UserSignInProperties {
  method: 'email' | 'google' | 'github' | 'sso';
  session_duration?: number; // in seconds
}
```

## Privacy and Filtering

### Data Filtering
```typescript
// src/utils/filtering.ts
export function filterSensitiveData(properties: Record<string, any>): Record<string, any> {
  const sensitiveFields = [
    'password',
    'token',
    'secret',
    'key',
    'authorization',
    'cookie',
  ];
  
  const filtered = { ...properties };
  
  // Remove sensitive fields
  for (const field of sensitiveFields) {
    if (filtered[field]) {
      filtered[field] = '[REDACTED]';
    }
  }
  
  // Filter email domains for privacy
  if (filtered.email) {
    const [, domain] = filtered.email.split('@');
    filtered.email_domain = domain;
    delete filtered.email;
  }
  
  return filtered;
}
```

## Integration Patterns

### App Integration
```typescript
// In apps/app/src/app/layout.tsx
import { AnalyticsProvider } from '@repo/analytics';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <AnalyticsProvider
      posthogApiKey={process.env.NEXT_PUBLIC_POSTHOG_KEY}
      vercelEnabled={true}
    >
      {children}
    </AnalyticsProvider>
  );
}
```

### Component Usage
```typescript
// In a component
import { useAnalytics } from '@repo/analytics';
import { useBoardEvents } from '@repo/analytics/hooks';

function CreateBoardModal() {
  const analytics = useAnalytics();
  const { trackBoardCreated } = useBoardEvents();
  
  const handleCreateBoard = async (name: string) => {
    const board = await createBoard(name);
    
    // Track generic event
    analytics.capture('modal_submitted', {
      modal_type: 'create_board',
      success: true,
    });
    
    // Track specific board event
    trackBoardCreated(board.id, board.name);
    
    // Track page view
    analytics.pageView(`/board/${board.id}`);
  };
  
  return (
    <Modal>
      {/* Modal content */}
    </Modal>
  );
}
```

## Common Tasks

### Adding a New Event Type
1. Define event in appropriate file in `src/events/`
2. Add TypeScript interface for properties
3. Create hook in `src/hooks/` if needed
4. Export from index files
5. Update documentation

### Adding Analytics to a Component
1. Import appropriate hooks
2. Call tracking functions at key moments
3. Add relevant properties
4. Test events fire correctly
5. Verify in analytics dashboard

### Setting Up New Analytics Provider
1. Create provider class in `src/providers/`
2. Implement required methods (init, capture, etc.)
3. Add provider to main analytics class
4. Export from provider index
5. Update integration documentation

## Files to Know
- `src/providers/posthog.ts` - PostHog integration
- `src/hooks/useAnalytics.ts` - Main analytics hook
- `src/events/index.ts` - Event type definitions
- `src/utils/filtering.ts` - Privacy filtering

## Quality Checklist

Before committing changes to this package:
- [ ] All events have proper TypeScript definitions
- [ ] Sensitive data is properly filtered
- [ ] Event names follow consistent naming convention
- [ ] Hook dependencies are optimized
- [ ] Privacy preferences are respected
- [ ] Debug mode works for development
- [ ] Events fire at appropriate times
- [ ] No PII in event properties
- [ ] Analytics providers initialized correctly
- [ ] Documentation updated for new events

---

*This context ensures Claude Code understands the analytics package structure and patterns when working on tracking features.*
````

## File: packages/analytics/package.json
````json
{
  "name": "@repo/analytics",
  "version": "0.1.0",
  "private": true,
  "main": "./src/index.tsx",
  "types": "./src/index.tsx",
  "dependencies": {
    "@t3-oss/env-nextjs": "^0.11.1",
    "@vercel/analytics": "^1.4.1",
    "next": "^15.3.0",
    "posthog-js": "^1.205.0",
    "react": "^19.1.0",
    "zod": "^3.24.1"
  },
  "devDependencies": {
    "@types/react": "^19.0.6",
    "typescript": "^5.7.3",
    "@repo/typescript-config": "workspace:*"
  }
}
````

## File: packages/analytics/tsconfig.json
````json
{
  "extends": "@squish-xyz/typescript-config/react-library.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"],
      "@squish-xyz/*": ["../../packages/*"]
    }
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
````

## File: packages/auth/components/sign-in.tsx
````typescript
import { SignIn as ClerkSignIn } from '@clerk/nextjs';

export function SignIn() {
  return <ClerkSignIn />;
}
````

## File: packages/auth/components/sign-up.tsx
````typescript
import { SignUp as ClerkSignUp } from '@clerk/nextjs';

export function SignUp() {
  return <ClerkSignUp />;
}
````

## File: packages/auth/utils/index.ts
````typescript
// Auth utility functions have been moved to @repo/api/src/utils/user.ts
// to avoid circular dependencies

// Re-export utility functions that don't depend on ApiError
export function generateUsername(email: string): string {
  const [localPart] = email.split('@');
  const cleanUsername = localPart
    .toLowerCase()
    .replace(/[^a-z0-9]/g, '')
    .slice(0, 20);

  return cleanUsername || 'user';
}

export function isValidEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}
````

## File: packages/auth/webhooks/clerk.ts
````typescript
import type { WebhookEvent } from '@clerk/nextjs/server';
import { db } from '@repo/database';
import { apiLogger } from '@repo/logger';
import { headers } from 'next/headers';
import { Webhook } from 'svix';
import { generateUsername } from '../utils';

export async function handleClerkWebhook(request: Request) {
  const WEBHOOK_SECRET = process.env.CLERK_WEBHOOK_SECRET;

  if (!WEBHOOK_SECRET) {
    throw new Error(
      'Please add CLERK_WEBHOOK_SECRET from Clerk Dashboard to .env'
    );
  }

  const headerPayload = headers();
  const svix_id = headerPayload.get('svix-id');
  const svix_timestamp = headerPayload.get('svix-timestamp');
  const svix_signature = headerPayload.get('svix-signature');

  if (!svix_id || !svix_timestamp || !svix_signature) {
    return new Response('Error occurred -- no svix headers', {
      status: 400,
    });
  }

  const payload = await request.json();
  const body = JSON.stringify(payload);

  const wh = new Webhook(WEBHOOK_SECRET);

  let evt: WebhookEvent;

  try {
    evt = wh.verify(body, {
      'svix-id': svix_id,
      'svix-timestamp': svix_timestamp,
      'svix-signature': svix_signature,
    }) as WebhookEvent;
  } catch (err) {
    apiLogger.error('Webhook verification failed', err);
    return new Response('Error occurred', {
      status: 400,
    });
  }

  const eventType = evt.type;

  apiLogger.info('Webhook received', { type: eventType });

  try {
    switch (eventType) {
      case 'user.created': {
        const {
          id,
          email_addresses,
          first_name,
          last_name,
          username,
          image_url,
        } = evt.data;
        const primaryEmail = email_addresses.find(
          (email) => email.primary
        )?.email_address;

        if (!primaryEmail) {
          throw new Error('No primary email found');
        }

        await db.user.create({
          data: {
            clerkId: id,
            email: primaryEmail,
            username: username || generateUsername(primaryEmail),
            displayName:
              [first_name, last_name].filter(Boolean).join(' ') || null,
            avatarUrl: image_url || null,
          },
        });

        apiLogger.info('User created', { clerkId: id, email: primaryEmail });
        break;
      }

      case 'user.updated': {
        const {
          id,
          email_addresses,
          first_name,
          last_name,
          username,
          image_url,
        } = evt.data;
        const primaryEmail = email_addresses.find(
          (email) => email.primary
        )?.email_address;

        if (!primaryEmail) {
          throw new Error('No primary email found');
        }

        await db.user.update({
          where: { clerkId: id },
          data: {
            email: primaryEmail,
            username: username || undefined,
            displayName:
              [first_name, last_name].filter(Boolean).join(' ') || null,
            avatarUrl: image_url || null,
          },
        });

        apiLogger.info('User updated', { clerkId: id });
        break;
      }

      case 'user.deleted': {
        const { id } = evt.data;

        await db.user.delete({
          where: { clerkId: id },
        });

        apiLogger.info('User deleted', { clerkId: id });
        break;
      }

      case 'organizationMembership.created':
      case 'organizationMembership.updated': {
        const { organization, public_user_data } = evt.data;
        const userId = public_user_data.user_id;

        const user = await db.user.findUnique({
          where: { clerkId: userId },
        });

        if (user) {
          await db.user.update({
            where: { id: user.id },
            data: {
              organizationId: organization.id,
              organizationName: organization.name,
            },
          });

          apiLogger.info('Organization membership updated', {
            userId: user.id,
            orgId: organization.id,
          });
        }
        break;
      }

      case 'organizationMembership.deleted': {
        const { public_user_data } = evt.data;
        const userId = public_user_data.user_id;

        const user = await db.user.findUnique({
          where: { clerkId: userId },
        });

        if (user) {
          await db.user.update({
            where: { id: user.id },
            data: {
              organizationId: null,
              organizationName: null,
            },
          });

          apiLogger.info('Organization membership removed', {
            userId: user.id,
          });
        }
        break;
      }

      default:
        apiLogger.warn('Unhandled webhook event', { type: eventType });
    }

    return new Response('Webhook processed', { status: 200 });
  } catch (error) {
    apiLogger.error('Webhook processing failed', error);
    return new Response('Error processing webhook', { status: 500 });
  }
}
````

## File: packages/auth/billing.tsx
````typescript
// Billing-related exports
export const BILLING_PLANS = {
  FREE: 'free',
  PRO: 'pro',
  ENTERPRISE: 'enterprise',
} as const;

export type BillingPlan = (typeof BILLING_PLANS)[keyof typeof BILLING_PLANS];

export interface BillingFeatures {
  maxUsers: number;
  maxProjects: number;
  supportLevel: 'community' | 'email' | 'priority';
  customBranding: boolean;
}

export const PLAN_FEATURES: Record<BillingPlan, BillingFeatures> = {
  [BILLING_PLANS.FREE]: {
    maxUsers: 1,
    maxProjects: 3,
    supportLevel: 'community',
    customBranding: false,
  },
  [BILLING_PLANS.PRO]: {
    maxUsers: 10,
    maxProjects: -1, // unlimited
    supportLevel: 'email',
    customBranding: true,
  },
  [BILLING_PLANS.ENTERPRISE]: {
    maxUsers: -1, // unlimited
    maxProjects: -1, // unlimited
    supportLevel: 'priority',
    customBranding: true,
  },
};
````

## File: packages/auth/CLAUDE.md
````markdown
# @repo/auth Package Context

## Development Standards

### Package Context
This package provides authentication utilities and Clerk integration for the Squish ecosystem. It handles user authentication, session management, role-based access control, and authentication flows across all applications.

### Technology Stack
- **Clerk**: 6.18.4 - Authentication provider
- **React**: 19+ compatibility
- **TypeScript**: 5.7+ strict configuration
- **JWT**: JSON Web Token handling

### Key Dependencies
```json
{
  "dependencies": {
    "@clerk/backend": "^1.20.1",
    "@clerk/nextjs": "^6.18.4",
    "@clerk/react": "^5.9.0",
    "jose": "^5.9.6",
    "react": "^19.1.0"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*"
  }
}
```

## Package Structure

### Directory Layout
```
src/
‚îú‚îÄ‚îÄ index.ts              # Main package exports
‚îú‚îÄ‚îÄ client/               # Client-side authentication
‚îÇ   ‚îú‚îÄ‚îÄ clerk-client.ts   # Clerk client configuration
‚îÇ   ‚îú‚îÄ‚îÄ hooks.ts          # React authentication hooks
‚îÇ   ‚îú‚îÄ‚îÄ context.ts        # Authentication context
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Client exports
‚îú‚îÄ‚îÄ server/               # Server-side authentication
‚îÇ   ‚îú‚îÄ‚îÄ middleware.ts     # Authentication middleware
‚îÇ   ‚îú‚îÄ‚îÄ jwt.ts           # JWT handling utilities
‚îÇ   ‚îú‚îÄ‚îÄ session.ts       # Session management
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Server exports
‚îú‚îÄ‚îÄ types/                # TypeScript type definitions
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts          # Authentication types
‚îÇ   ‚îú‚îÄ‚îÄ clerk.ts         # Clerk-specific types
‚îÇ   ‚îú‚îÄ‚îÄ user.ts          # User and role types
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Type exports
‚îú‚îÄ‚îÄ utils/                # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ permissions.ts   # Permission checking
‚îÇ   ‚îú‚îÄ‚îÄ roles.ts         # Role utilities
‚îÇ   ‚îú‚îÄ‚îÄ tokens.ts        # Token utilities
‚îÇ   ‚îî‚îÄ‚îÄ index.ts         # Utility exports
‚îî‚îÄ‚îÄ config/               # Configuration constants
    ‚îú‚îÄ‚îÄ constants.ts     # Auth constants
    ‚îú‚îÄ‚îÄ defaults.ts      # Default configurations
    ‚îî‚îÄ‚îÄ index.ts         # Config exports
```

## Client-Side Authentication

### Clerk Client Configuration
```typescript
// src/client/clerk-client.ts
import { ClerkProvider } from '@clerk/nextjs';
import { dark } from '@clerk/themes';

export function createClerkProvider({ children }: { children: React.ReactNode }) {
  return (
    <ClerkProvider
      appearance={{
        baseTheme: undefined,
        variables: {
          colorPrimary: '#3b82f6',
        },
        elements: {
          card: {
            boxShadow: 'none',
          },
        },
      }}
      afterSignInUrl="/dashboard"
      afterSignUpUrl="/onboarding"
      signInUrl="/sign-in"
      signUpUrl="/sign-up"
    >
      {children}
    </ClerkProvider>
  );
}
```

### Authentication Hooks
```typescript
// src/client/hooks.ts
export function useAuth() {
  const { isLoaded, isSignedIn, user } = useUser();
  const { userId } = useAuth();
  
  return {
    isLoaded,
    isSignedIn,
    user: user ? {
      id: user.id,
      email: user.emailAddresses[0]?.emailAddress,
      name: `${user.firstName} ${user.lastName}`,
      avatar: user.imageUrl,
      createdAt: user.createdAt,
    } : null,
    userId,
  };
}

export function useRequireAuth() {
  const { isLoaded, isSignedIn, user } = useAuth();
  
  if (!isLoaded) {
    return { isLoading: true, user: null };
  }
  
  if (!isSignedIn) {
    redirectToSignIn();
    return { isLoading: false, user: null };
  }
  
  return { isLoading: false, user };
}

export function usePermission(permission: string) {
  const { user } = useAuth();
  
  const hasPermission = user?.roles?.some(role => 
    role.permissions.includes(permission)
  ) ?? false;
  
  return hasPermission;
}
```

## Server-Side Authentication

### Authentication Middleware
```typescript
// src/server/middleware.ts
import { auth } from '@clerk/nextjs/server';
import { NextResponse } from 'next/server';

export function authMiddleware(handler: (req: Request, auth: { userId: string }) => Promise<Response>) {
  return async (req: Request) => {
    try {
      const { userId } = auth();
      
      if (!userId) {
        return NextResponse.json(
          { error: 'Unauthorized' },
          { status: 401 }
        );
      }
      
      return handler(req, { userId });
    } catch (error) {
      console.error('Auth middleware error:', error);
      return NextResponse.json(
        { error: 'Internal server error' },
        { status: 500 }
      );
    }
  };
}
```

### JWT Handling
```typescript
// src/server/jwt.ts
import { SignJWT, jwtVerify } from 'jose';

const secret = new TextEncoder().encode(process.env.CLERK_JWT_KEY!);

export async function signJWT(payload: any, expiresIn = '1h') {
  return await new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime(expiresIn)
    .sign(secret);
}

export async function verifyJWT(token: string) {
  try {
    const { payload } = await jwtVerify(token, secret);
    return payload;
  } catch (error) {
    throw new Error('Invalid token');
  }
}
```

## Role-Based Access Control

### Permission System
```typescript
// src/utils/permissions.ts
export const Permissions = {
  // Board permissions
  BOARD_CREATE: 'board:create',
  BOARD_READ: 'board:read',
  BOARD_UPDATE: 'board:update',
  BOARD_DELETE: 'board:delete',
  
  // Asset permissions
  ASSET_UPLOAD: 'asset:upload',
  ASSET_READ: 'asset:read',
  ASSET_UPDATE: 'asset:update',
  ASSET_DELETE: 'asset:delete',
  
  // User permissions
  USER_READ: 'user:read',
  USER_UPDATE: 'user:update',
  USER_DELETE: 'user:delete',
  
  // Admin permissions
  ADMIN_DASHBOARD: 'admin:dashboard',
  ADMIN_USERS: 'admin:users',
  ADMIN_SETTINGS: 'admin:settings',
} as const;

type Permission = typeof Permissions[keyof typeof Permissions];

export function hasPermission(
  userRoles: Role[] | undefined,
  requiredPermission: Permission
): boolean {
  if (!userRoles) return false;
  
  return userRoles.some(role => 
    role.permissions.includes(requiredPermission)
  );
}
```

### Role Definitions
```typescript
// src/utils/roles.ts
export interface Role {
  id: string;
  name: string;
  description: string;
  permissions: Permission[];
  isDefault?: boolean;
}

export const Roles: Record<string, Role> = {
  ADMIN: {
    id: 'admin',
    name: 'Administrator',
    description: 'Full system access',
    permissions: Object.values(Permissions),
  },
  
  MEMBER: {
    id: 'member',
    name: 'Member',
    description: 'Standard workspace member',
    permissions: [
      Permissions.BOARD_READ,
      Permissions.ASSET_READ,
      Permissions.ASSET_UPLOAD,
    ],
    isDefault: true,
  },
  
  GUEST: {
    id: 'guest',
    name: 'Guest',
    description: 'Limited access',
    permissions: [
      Permissions.BOARD_READ,
      Permissions.ASSET_READ,
    ],
  },
};
```

## Integration Patterns

### Protected Component
```typescript
// Example protected component
import { useRequireAuth, usePermission } from '@repo/auth';

function AdminDashboard() {
  const { user, isLoading } = useRequireAuth();
  const hasAdminAccess = usePermission('admin:dashboard');
  
  if (isLoading) return <Spinner />;
  if (!user || !hasAdminAccess) return <Navigate to="/dashboard" />;
  
  return (
    <div>
      <h1>Admin Dashboard</h1>
      {/* Admin content */}
    </div>
  );
}
```

### Protected API Route
```typescript
// Example protected API route
import { authMiddleware } from '@repo/auth/server';

export const GET = authMiddleware(async (req, { userId }) => {
  const boards = await getBoardsForUser(userId);
  
  return NextResponse.json({ success: true, data: boards });
});
```

## Common Tasks

### Adding a New Permission
1. Add permission to Permissions enum
2. Update roles that should have this permission
3. Update documentation
4. Update tests

### Creating a New Role
1. Define role in Roles object
2. Assign appropriate permissions
3. Add database migration if storing roles
4. Update user management UI

### Adding Auth to a New Route
1. Add authMiddleware wrapper
2. Extract userId from auth context
3. Implement route logic
4. Add appropriate error handling

## Files to Know
- `src/client/clerk-client.ts` - Clerk provider setup
- `src/client/hooks.ts` - Authentication hooks
- `src/server/middleware.ts` - Authentication middleware
- `src/utils/permissions.ts` - Permission definitions
- `src/utils/roles.ts` - Role definitions

## Quality Checklist

Before committing changes to this package:
- [ ] All authentication flows tested
- [ ] Permission checking logic correct
- [ ] TypeScript types complete and accurate
- [ ] Error handling comprehensive
- [ ] JWT tokens properly secured
- [ ] Role-based access control working
- [ ] Authentication state properly managed
- [ ] No auth credentials in logs
- [ ] Sessions properly invalidated on sign out
- [ ] Documentation updated

---

*This context ensures Claude Code understands the auth package structure and patterns when working on authentication features.*
````

## File: packages/auth/client.ts
````typescript
export * from '@clerk/nextjs';
````

## File: packages/auth/index.ts
````typescript
export { AuthProvider } from './provider';
export type { AuthUser } from './types';
````

## File: packages/auth/keys.ts
````typescript
import { createEnv } from '@t3-oss/env-nextjs';
import { z } from 'zod';

export const keys = () =>
  createEnv({
    server: {
      CLERK_SECRET_KEY: z.string().min(1).startsWith('sk_'),
      CLERK_WEBHOOK_SECRET: z.string().min(1).startsWith('whsec_').optional(),
    },
    client: {
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: z.string().min(1).startsWith('pk_'),
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: z.string().min(1).startsWith('/'),
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: z.string().min(1).startsWith('/'),
      NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: z.string().min(1).startsWith('/'),
      NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: z.string().min(1).startsWith('/'),
    },
    runtimeEnv: {
      CLERK_SECRET_KEY: process.env.CLERK_SECRET_KEY,
      CLERK_WEBHOOK_SECRET: process.env.CLERK_WEBHOOK_SECRET,
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY:
        process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: process.env.NEXT_PUBLIC_CLERK_SIGN_IN_URL,
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: process.env.NEXT_PUBLIC_CLERK_SIGN_UP_URL,
      NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL:
        process.env.NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL,
      NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL:
        process.env.NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL,
    },
  });
````

## File: packages/auth/middleware.ts
````typescript
export { clerkMiddleware as authMiddleware } from '@clerk/nextjs/server';
````

## File: packages/auth/package.json
````json
{
  "name": "@repo/auth",
  "version": "0.0.0",
  "private": true,
  "exports": {
    ".": "./index.ts",
    "./client": "./client.ts",
    "./server": "./server.ts",
    "./server-types": "./server-types.ts",
    "./middleware": "./middleware.ts",
    "./provider": "./provider.tsx",
    "./keys": "./keys.ts",
    "./utils": "./utils/index.ts",
    "./webhooks/clerk": "./webhooks/clerk.ts",
    "./components/*": "./components/*"
  },
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  },
  "dependencies": {
    "@clerk/elements": "^0.23.21",
    "@clerk/nextjs": "^6.18.4",
    "@clerk/themes": "^2.2.39",
    "next-themes": "^0.4.6",
    "react": "^19.1.0"
  },
  "devDependencies": {
    "@clerk/types": "^4.53.0",
    "@types/node": "22.14.1",
    "@types/react": "19.0.6",
    "@types/react-dom": "^19.0.3",
    "svix": "^1.44.0",
    "typescript": "^5.8.3",
    "@repo/database": "workspace:*",
    "@repo/logger": "workspace:*",
    "@repo/typescript-config": "workspace:*"
  }
}
````

## File: packages/auth/provider.tsx
````typescript
'use client';

import { ClerkProvider } from '@clerk/nextjs';
import { dark } from '@clerk/themes';
import type { Theme } from '@clerk/types';
import { useTheme } from 'next-themes';
import type { ComponentProps } from 'react';

export const AuthProvider = (
  properties: ComponentProps<typeof ClerkProvider>
) => {
  const { resolvedTheme } = useTheme();

  const isDark = resolvedTheme === 'dark';
  const baseTheme = isDark ? dark : undefined;

  const elements: Theme['elements'] = {
    formButtonPrimary: 'bg-primary text-primary-foreground hover:bg-primary/90',
    rootBox: 'w-full mx-auto',
    card: 'bg-card hover:bg-card/80 border-border',
    socialButtonsIconButton: 'bg-muted hover:bg-muted/80',
    dividerRow: 'text-white',
    dividerText: 'text-white',
    formFieldInput: 'bg-card border-border',
    footerActionLink: 'text-primary hover:text-primary/80',
    identityPreview: 'bg-card',
    formFieldLabel: 'text-white',
    formButtonReset: 'text-white hover:text-white/80',
    navbar: 'hidden',
    socialButtonsBlockButton: 'text-white',
    formFieldLabelRow: 'text-white',
    headerTitle: 'text-white',
    headerSubtitle: 'text-white',
    profileSectionTitle: 'text-white',
    otpCodeFieldInput: 'text-white',
    dividerLine: 'bg-border',
    navbarButton: 'text-foreground',
    organizationSwitcherTrigger__open: 'bg-background',
    organizationPreviewMainIdentifier: 'text-foreground',
    organizationSwitcherTriggerIcon: 'text-muted-foreground',
    organizationPreview__organizationSwitcherTrigger: 'gap-2',
    organizationPreviewAvatarContainer: 'shrink-0',
  };

  const variables: Theme['variables'] = {
    colorPrimary: 'var(--primary)',
    colorText: '#ffffff',
    colorTextSecondary: '#ffffff',
    colorBackground: 'var(--background)',
    colorInputBackground: 'var(--card)',
    colorInputText: '#ffffff',
    colorTextOnPrimaryBackground: '#000000',
  };

  return (
    <ClerkProvider
      {...properties}
      appearance={{ baseTheme, elements, variables }}
      signInUrl="/sign-in"
      signUpUrl="/sign-up"
      signInFallbackRedirectUrl="/"
      afterSignInUrl="/"
      afterSignUpUrl="/"
    />
  );
};
````

## File: packages/auth/server-types.ts
````typescript
// Type-only exports for server-side usage (no React dependencies)
export type { AuthUser } from './types';
````

## File: packages/auth/server.ts
````typescript
export * from '@clerk/nextjs/server';
export * from './middleware';
````

## File: packages/auth/token.ts
````typescript
import jwt from 'jsonwebtoken';

/**
 * Create a signed JWT for the given user id.
 * This token mirrors the FastAPI token used by the legacy service
 * but is generated locally using the `JWT_SECRET` environment variable.
 */
export function createToken(userId: string, expiresIn = '7d'): string {
  const secret = process.env.JWT_SECRET;
  if (!secret) {
    throw new Error('JWT_SECRET environment variable not set');
  }
  return jwt.sign({ sub: userId }, secret, { algorithm: 'HS256', expiresIn });
}
````

## File: packages/auth/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "baseUrl": "."
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
````

## File: packages/auth/types.ts
````typescript
export interface AuthUser {
  userId: string;
  sessionId: string;
  email?: string;
  orgId?: string;
  orgRole?: string;
  orgSlug?: string;
}
````

## File: packages/database/drizzle/meta/_journal.json
````json
{
  "version": "7",
  "dialect": "postgresql",
  "entries": [
    {
      "idx": 0,
      "version": "7",
      "when": 1753500387864,
      "tag": "0000_brief_madame_hydra",
      "breakpoints": true
    }
  ]
}
````

## File: packages/database/drizzle/meta/0000_snapshot.json
````json
{
  "id": "74a04fa2-9691-4cf1-bdd1-a013805eb45d",
  "prevId": "00000000-0000-0000-0000-000000000000",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.Asset": {
      "name": "Asset",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "type": {
          "name": "type",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "url": {
          "name": "url",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "thumbnail_url": {
          "name": "thumbnail_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "storage_key": {
          "name": "storage_key",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "width": {
          "name": "width",
          "type": "real",
          "primaryKey": false,
          "notNull": false
        },
        "height": {
          "name": "height",
          "type": "real",
          "primaryKey": false,
          "notNull": false
        },
        "duration": {
          "name": "duration",
          "type": "real",
          "primaryKey": false,
          "notNull": false
        },
        "size": {
          "name": "size",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "mime_type": {
          "name": "mime_type",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "metadata": {
          "name": "metadata",
          "type": "json",
          "primaryKey": false,
          "notNull": false
        },
        "embedding": {
          "name": "embedding",
          "type": "vector(1408)",
          "primaryKey": false,
          "notNull": false
        },
        "embedding_metadata": {
          "name": "embedding_metadata",
          "type": "json",
          "primaryKey": false,
          "notNull": false
        },
        "creator_id": {
          "name": "creator_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "created": {
          "name": "created",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated": {
          "name": "updated",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "Asset_creatorId_idx": {
          "name": "Asset_creatorId_idx",
          "columns": [
            {
              "expression": "creator_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "Asset_type_idx": {
          "name": "Asset_type_idx",
          "columns": [
            {
              "expression": "type",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "Asset_name_idx": {
          "name": "Asset_name_idx",
          "columns": [
            {
              "expression": "name",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "Asset_creator_id_User_id_fk": {
          "name": "Asset_creator_id_User_id_fk",
          "tableFrom": "Asset",
          "tableTo": "User",
          "columnsFrom": ["creator_id"],
          "columnsTo": ["id"],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.BoardAsset": {
      "name": "BoardAsset",
      "schema": "",
      "columns": {
        "board_id": {
          "name": "board_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "asset_id": {
          "name": "asset_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "order": {
          "name": "order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "BoardAsset_pk": {
          "name": "BoardAsset_pk",
          "columns": [
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "asset_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "BoardAsset_boardId_idx": {
          "name": "BoardAsset_boardId_idx",
          "columns": [
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "BoardAsset_assetId_idx": {
          "name": "BoardAsset_assetId_idx",
          "columns": [
            {
              "expression": "asset_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "BoardAsset_board_id_Board_id_fk": {
          "name": "BoardAsset_board_id_Board_id_fk",
          "tableFrom": "BoardAsset",
          "tableTo": "Board",
          "columnsFrom": ["board_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "BoardAsset_asset_id_Asset_id_fk": {
          "name": "BoardAsset_asset_id_Asset_id_fk",
          "tableFrom": "BoardAsset",
          "tableTo": "Asset",
          "columnsFrom": ["asset_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.BoardCollaborator": {
      "name": "BoardCollaborator",
      "schema": "",
      "columns": {
        "board_id": {
          "name": "board_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "access_level": {
          "name": "access_level",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "default": "'view'"
        },
        "created": {
          "name": "created",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "BoardCollaborator_pk": {
          "name": "BoardCollaborator_pk",
          "columns": [
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "BoardCollaborator_userId_idx": {
          "name": "BoardCollaborator_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "BoardCollaborator_boardId_idx": {
          "name": "BoardCollaborator_boardId_idx",
          "columns": [
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "BoardCollaborator_board_id_Board_id_fk": {
          "name": "BoardCollaborator_board_id_Board_id_fk",
          "tableFrom": "BoardCollaborator",
          "tableTo": "Board",
          "columnsFrom": ["board_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "BoardCollaborator_user_id_User_id_fk": {
          "name": "BoardCollaborator_user_id_User_id_fk",
          "tableFrom": "BoardCollaborator",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.Board": {
      "name": "Board",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "name": {
          "name": "name",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "visibility": {
          "name": "visibility",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "default": "'public'"
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "instructions": {
          "name": "instructions",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "sources": {
          "name": "sources",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "icon": {
          "name": "icon",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "default": "'üñºÔ∏è'"
        },
        "embedding": {
          "name": "embedding",
          "type": "vector(1408)",
          "primaryKey": false,
          "notNull": false
        },
        "embedding_metadata": {
          "name": "embedding_metadata",
          "type": "json",
          "primaryKey": false,
          "notNull": false
        },
        "creator_id": {
          "name": "creator_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "created": {
          "name": "created",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated": {
          "name": "updated",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "Board_creatorId_idx": {
          "name": "Board_creatorId_idx",
          "columns": [
            {
              "expression": "creator_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "Board_visibility_idx": {
          "name": "Board_visibility_idx",
          "columns": [
            {
              "expression": "visibility",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "Board_name_idx": {
          "name": "Board_name_idx",
          "columns": [
            {
              "expression": "name",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "Board_creator_id_User_id_fk": {
          "name": "Board_creator_id_User_id_fk",
          "tableFrom": "Board",
          "tableTo": "User",
          "columnsFrom": ["creator_id"],
          "columnsTo": ["id"],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.LikedAsset": {
      "name": "LikedAsset",
      "schema": "",
      "columns": {
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "asset_id": {
          "name": "asset_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "LikedAsset_pk": {
          "name": "LikedAsset_pk",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "asset_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "LikedAsset_userId_idx": {
          "name": "LikedAsset_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "LikedAsset_assetId_idx": {
          "name": "LikedAsset_assetId_idx",
          "columns": [
            {
              "expression": "asset_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "LikedAsset_user_id_User_id_fk": {
          "name": "LikedAsset_user_id_User_id_fk",
          "tableFrom": "LikedAsset",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "LikedAsset_asset_id_Asset_id_fk": {
          "name": "LikedAsset_asset_id_Asset_id_fk",
          "tableFrom": "LikedAsset",
          "tableTo": "Asset",
          "columnsFrom": ["asset_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.LikedBoard": {
      "name": "LikedBoard",
      "schema": "",
      "columns": {
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "board_id": {
          "name": "board_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "LikedBoard_pk": {
          "name": "LikedBoard_pk",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "LikedBoard_userId_idx": {
          "name": "LikedBoard_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "LikedBoard_boardId_idx": {
          "name": "LikedBoard_boardId_idx",
          "columns": [
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "LikedBoard_user_id_User_id_fk": {
          "name": "LikedBoard_user_id_User_id_fk",
          "tableFrom": "LikedBoard",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "LikedBoard_board_id_Board_id_fk": {
          "name": "LikedBoard_board_id_Board_id_fk",
          "tableFrom": "LikedBoard",
          "tableTo": "Board",
          "columnsFrom": ["board_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.RecentAsset": {
      "name": "RecentAsset",
      "schema": "",
      "columns": {
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "asset_id": {
          "name": "asset_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "used_at": {
          "name": "used_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "RecentAsset_pk": {
          "name": "RecentAsset_pk",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "asset_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "RecentAsset_userId_usedAt_idx": {
          "name": "RecentAsset_userId_usedAt_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "used_at",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "RecentAsset_user_id_User_id_fk": {
          "name": "RecentAsset_user_id_User_id_fk",
          "tableFrom": "RecentAsset",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "RecentAsset_asset_id_Asset_id_fk": {
          "name": "RecentAsset_asset_id_Asset_id_fk",
          "tableFrom": "RecentAsset",
          "tableTo": "Asset",
          "columnsFrom": ["asset_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.RecentBoard": {
      "name": "RecentBoard",
      "schema": "",
      "columns": {
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "board_id": {
          "name": "board_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "used_at": {
          "name": "used_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "RecentBoard_pk": {
          "name": "RecentBoard_pk",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "RecentBoard_userId_usedAt_idx": {
          "name": "RecentBoard_userId_usedAt_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "used_at",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "RecentBoard_user_id_User_id_fk": {
          "name": "RecentBoard_user_id_User_id_fk",
          "tableFrom": "RecentBoard",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "RecentBoard_board_id_Board_id_fk": {
          "name": "RecentBoard_board_id_Board_id_fk",
          "tableFrom": "RecentBoard",
          "tableTo": "Board",
          "columnsFrom": ["board_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.Report": {
      "name": "Report",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "content": {
          "name": "content",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "attachment_url": {
          "name": "attachment_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "category": {
          "name": "category",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "status": {
          "name": "status",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "default": "'pending'"
        },
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "created": {
          "name": "created",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "Report_status_idx": {
          "name": "Report_status_idx",
          "columns": [
            {
              "expression": "status",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "Report_userId_idx": {
          "name": "Report_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "Report_user_id_User_id_fk": {
          "name": "Report_user_id_User_id_fk",
          "tableFrom": "Report",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.Search": {
      "name": "Search",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "query": {
          "name": "query",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "expanded_context": {
          "name": "expanded_context",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "embedding": {
          "name": "embedding",
          "type": "vector(1408)",
          "primaryKey": false,
          "notNull": false
        },
        "results_snapshot": {
          "name": "results_snapshot",
          "type": "json",
          "primaryKey": false,
          "notNull": false
        },
        "new_results_count": {
          "name": "new_results_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 0
        },
        "last_checked": {
          "name": "last_checked",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "created": {
          "name": "created",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "Search_userId_idx": {
          "name": "Search_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "Search_createdAt_idx": {
          "name": "Search_createdAt_idx",
          "columns": [
            {
              "expression": "created",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "Search_user_id_User_id_fk": {
          "name": "Search_user_id_User_id_fk",
          "tableFrom": "Search",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.User": {
      "name": "User",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "clerk_id": {
          "name": "clerk_id",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "username": {
          "name": "username",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "passwordHash": {
          "name": "passwordHash",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "phoneNumber": {
          "name": "phoneNumber",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "phone_verified": {
          "name": "phone_verified",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "pfp_url": {
          "name": "pfp_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "bio": {
          "name": "bio",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "gender": {
          "name": "gender",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "name": {
          "name": "name",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "interests": {
          "name": "interests",
          "type": "json",
          "primaryKey": false,
          "notNull": false
        },
        "pronouns": {
          "name": "pronouns",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "profile_completion": {
          "name": "profile_completion",
          "type": "real",
          "primaryKey": false,
          "notNull": true,
          "default": 0
        },
        "pinned_columns": {
          "name": "pinned_columns",
          "type": "json",
          "primaryKey": false,
          "notNull": false
        },
        "selected_profile_stat": {
          "name": "selected_profile_stat",
          "type": "text",
          "primaryKey": false,
          "notNull": false,
          "default": "'boards'"
        },
        "created": {
          "name": "created",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated": {
          "name": "updated",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "User_phoneNumber_idx": {
          "name": "User_phoneNumber_idx",
          "columns": [
            {
              "expression": "phoneNumber",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "User_username_idx": {
          "name": "User_username_idx",
          "columns": [
            {
              "expression": "username",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "User_clerk_id_unique": {
          "name": "User_clerk_id_unique",
          "nullsNotDistinct": false,
          "columns": ["clerk_id"]
        },
        "User_username_unique": {
          "name": "User_username_unique",
          "nullsNotDistinct": false,
          "columns": ["username"]
        },
        "User_phoneNumber_unique": {
          "name": "User_phoneNumber_unique",
          "nullsNotDistinct": false,
          "columns": ["phoneNumber"]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.ViewedAsset": {
      "name": "ViewedAsset",
      "schema": "",
      "columns": {
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "asset_id": {
          "name": "asset_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "view_count": {
          "name": "view_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 1
        },
        "last_viewed": {
          "name": "last_viewed",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "ViewedAsset_pk": {
          "name": "ViewedAsset_pk",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "asset_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "ViewedAsset_userId_idx": {
          "name": "ViewedAsset_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "ViewedAsset_lastViewed_idx": {
          "name": "ViewedAsset_lastViewed_idx",
          "columns": [
            {
              "expression": "last_viewed",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "ViewedAsset_user_id_User_id_fk": {
          "name": "ViewedAsset_user_id_User_id_fk",
          "tableFrom": "ViewedAsset",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "ViewedAsset_asset_id_Asset_id_fk": {
          "name": "ViewedAsset_asset_id_Asset_id_fk",
          "tableFrom": "ViewedAsset",
          "tableTo": "Asset",
          "columnsFrom": ["asset_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.ViewedBoard": {
      "name": "ViewedBoard",
      "schema": "",
      "columns": {
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "board_id": {
          "name": "board_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "view_count": {
          "name": "view_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 1
        },
        "last_viewed": {
          "name": "last_viewed",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "ViewedBoard_pk": {
          "name": "ViewedBoard_pk",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "ViewedBoard_userId_idx": {
          "name": "ViewedBoard_userId_idx",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "ViewedBoard_boardId_idx": {
          "name": "ViewedBoard_boardId_idx",
          "columns": [
            {
              "expression": "board_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "ViewedBoard_user_id_User_id_fk": {
          "name": "ViewedBoard_user_id_User_id_fk",
          "tableFrom": "ViewedBoard",
          "tableTo": "User",
          "columnsFrom": ["user_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "ViewedBoard_board_id_Board_id_fk": {
          "name": "ViewedBoard_board_id_Board_id_fk",
          "tableFrom": "ViewedBoard",
          "tableTo": "Board",
          "columnsFrom": ["board_id"],
          "columnsTo": ["id"],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}
````

## File: packages/database/drizzle/0000_brief_madame_hydra.sql
````sql
CREATE TABLE "Asset" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"type" text NOT NULL,
	"name" text NOT NULL,
	"url" text NOT NULL,
	"thumbnail_url" text,
	"storage_key" text,
	"width" real,
	"height" real,
	"duration" real,
	"size" integer,
	"mime_type" text,
	"metadata" json,
	"embedding" vector(1408),
	"embedding_metadata" json,
	"creator_id" text NOT NULL,
	"created" timestamp DEFAULT now() NOT NULL,
	"updated" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "BoardAsset" (
	"board_id" text NOT NULL,
	"asset_id" text NOT NULL,
	"order" integer,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "BoardCollaborator" (
	"board_id" text NOT NULL,
	"user_id" text NOT NULL,
	"access_level" text DEFAULT 'view' NOT NULL,
	"created" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "Board" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"visibility" text DEFAULT 'public' NOT NULL,
	"description" text,
	"instructions" text,
	"sources" text,
	"icon" text DEFAULT 'üñºÔ∏è' NOT NULL,
	"embedding" vector(1408),
	"embedding_metadata" json,
	"creator_id" text NOT NULL,
	"created" timestamp DEFAULT now() NOT NULL,
	"updated" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "LikedAsset" (
	"user_id" text NOT NULL,
	"asset_id" text NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "LikedBoard" (
	"user_id" text NOT NULL,
	"board_id" text NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "RecentAsset" (
	"user_id" text NOT NULL,
	"asset_id" text NOT NULL,
	"used_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "RecentBoard" (
	"user_id" text NOT NULL,
	"board_id" text NOT NULL,
	"used_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "Report" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"content" text NOT NULL,
	"attachment_url" text,
	"category" text,
	"status" text DEFAULT 'pending' NOT NULL,
	"user_id" text,
	"created" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "Search" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"query" text NOT NULL,
	"expanded_context" text,
	"embedding" vector(1408),
	"results_snapshot" json,
	"new_results_count" integer DEFAULT 0 NOT NULL,
	"last_checked" timestamp,
	"user_id" text NOT NULL,
	"created" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "User" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"clerk_id" text,
	"username" text NOT NULL,
	"passwordHash" text NOT NULL,
	"phoneNumber" text NOT NULL,
	"phone_verified" boolean DEFAULT false NOT NULL,
	"pfp_url" text,
	"bio" text,
	"gender" text,
	"name" text,
	"interests" json,
	"pronouns" text,
	"profile_completion" real DEFAULT 0 NOT NULL,
	"pinned_columns" json,
	"selected_profile_stat" text DEFAULT 'boards',
	"created" timestamp DEFAULT now() NOT NULL,
	"updated" timestamp DEFAULT now() NOT NULL,
	CONSTRAINT "User_clerk_id_unique" UNIQUE("clerk_id"),
	CONSTRAINT "User_username_unique" UNIQUE("username"),
	CONSTRAINT "User_phoneNumber_unique" UNIQUE("phoneNumber")
);
--> statement-breakpoint
CREATE TABLE "ViewedAsset" (
	"user_id" text NOT NULL,
	"asset_id" text NOT NULL,
	"view_count" integer DEFAULT 1 NOT NULL,
	"last_viewed" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "ViewedBoard" (
	"user_id" text NOT NULL,
	"board_id" text NOT NULL,
	"view_count" integer DEFAULT 1 NOT NULL,
	"last_viewed" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
ALTER TABLE "Asset" ADD CONSTRAINT "Asset_creator_id_User_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."User"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "BoardAsset" ADD CONSTRAINT "BoardAsset_board_id_Board_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."Board"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "BoardAsset" ADD CONSTRAINT "BoardAsset_asset_id_Asset_id_fk" FOREIGN KEY ("asset_id") REFERENCES "public"."Asset"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "BoardCollaborator" ADD CONSTRAINT "BoardCollaborator_board_id_Board_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."Board"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "BoardCollaborator" ADD CONSTRAINT "BoardCollaborator_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "Board" ADD CONSTRAINT "Board_creator_id_User_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."User"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "LikedAsset" ADD CONSTRAINT "LikedAsset_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "LikedAsset" ADD CONSTRAINT "LikedAsset_asset_id_Asset_id_fk" FOREIGN KEY ("asset_id") REFERENCES "public"."Asset"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "LikedBoard" ADD CONSTRAINT "LikedBoard_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "LikedBoard" ADD CONSTRAINT "LikedBoard_board_id_Board_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."Board"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "RecentAsset" ADD CONSTRAINT "RecentAsset_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "RecentAsset" ADD CONSTRAINT "RecentAsset_asset_id_Asset_id_fk" FOREIGN KEY ("asset_id") REFERENCES "public"."Asset"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "RecentBoard" ADD CONSTRAINT "RecentBoard_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "RecentBoard" ADD CONSTRAINT "RecentBoard_board_id_Board_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."Board"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "Report" ADD CONSTRAINT "Report_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "Search" ADD CONSTRAINT "Search_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ViewedAsset" ADD CONSTRAINT "ViewedAsset_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ViewedAsset" ADD CONSTRAINT "ViewedAsset_asset_id_Asset_id_fk" FOREIGN KEY ("asset_id") REFERENCES "public"."Asset"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ViewedBoard" ADD CONSTRAINT "ViewedBoard_user_id_User_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."User"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ViewedBoard" ADD CONSTRAINT "ViewedBoard_board_id_Board_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."Board"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "Asset_creatorId_idx" ON "Asset" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "Asset_type_idx" ON "Asset" USING btree ("type");--> statement-breakpoint
CREATE INDEX "Asset_name_idx" ON "Asset" USING btree ("name");--> statement-breakpoint
CREATE INDEX "BoardAsset_pk" ON "BoardAsset" USING btree ("board_id","asset_id");--> statement-breakpoint
CREATE INDEX "BoardAsset_boardId_idx" ON "BoardAsset" USING btree ("board_id");--> statement-breakpoint
CREATE INDEX "BoardAsset_assetId_idx" ON "BoardAsset" USING btree ("asset_id");--> statement-breakpoint
CREATE INDEX "BoardCollaborator_pk" ON "BoardCollaborator" USING btree ("board_id","user_id");--> statement-breakpoint
CREATE INDEX "BoardCollaborator_userId_idx" ON "BoardCollaborator" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "BoardCollaborator_boardId_idx" ON "BoardCollaborator" USING btree ("board_id");--> statement-breakpoint
CREATE INDEX "Board_creatorId_idx" ON "Board" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "Board_visibility_idx" ON "Board" USING btree ("visibility");--> statement-breakpoint
CREATE INDEX "Board_name_idx" ON "Board" USING btree ("name");--> statement-breakpoint
CREATE INDEX "LikedAsset_pk" ON "LikedAsset" USING btree ("user_id","asset_id");--> statement-breakpoint
CREATE INDEX "LikedAsset_userId_idx" ON "LikedAsset" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "LikedAsset_assetId_idx" ON "LikedAsset" USING btree ("asset_id");--> statement-breakpoint
CREATE INDEX "LikedBoard_pk" ON "LikedBoard" USING btree ("user_id","board_id");--> statement-breakpoint
CREATE INDEX "LikedBoard_userId_idx" ON "LikedBoard" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "LikedBoard_boardId_idx" ON "LikedBoard" USING btree ("board_id");--> statement-breakpoint
CREATE INDEX "RecentAsset_pk" ON "RecentAsset" USING btree ("user_id","asset_id");--> statement-breakpoint
CREATE INDEX "RecentAsset_userId_usedAt_idx" ON "RecentAsset" USING btree ("user_id","used_at");--> statement-breakpoint
CREATE INDEX "RecentBoard_pk" ON "RecentBoard" USING btree ("user_id","board_id");--> statement-breakpoint
CREATE INDEX "RecentBoard_userId_usedAt_idx" ON "RecentBoard" USING btree ("user_id","used_at");--> statement-breakpoint
CREATE INDEX "Report_status_idx" ON "Report" USING btree ("status");--> statement-breakpoint
CREATE INDEX "Report_userId_idx" ON "Report" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "Search_userId_idx" ON "Search" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "Search_createdAt_idx" ON "Search" USING btree ("created");--> statement-breakpoint
CREATE INDEX "User_phoneNumber_idx" ON "User" USING btree ("phoneNumber");--> statement-breakpoint
CREATE INDEX "User_username_idx" ON "User" USING btree ("username");--> statement-breakpoint
CREATE INDEX "ViewedAsset_pk" ON "ViewedAsset" USING btree ("user_id","asset_id");--> statement-breakpoint
CREATE INDEX "ViewedAsset_userId_idx" ON "ViewedAsset" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "ViewedAsset_lastViewed_idx" ON "ViewedAsset" USING btree ("last_viewed");--> statement-breakpoint
CREATE INDEX "ViewedBoard_pk" ON "ViewedBoard" USING btree ("user_id","board_id");--> statement-breakpoint
CREATE INDEX "ViewedBoard_userId_idx" ON "ViewedBoard" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "ViewedBoard_boardId_idx" ON "ViewedBoard" USING btree ("board_id");
````

## File: packages/database/migrations/01_enable_pgvector.sql
````sql
-- Enable pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Add vector columns to existing tables (if they don't exist)
DO $$ 
BEGIN
    -- Board table
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'Board' AND column_name = 'embedding') THEN
        ALTER TABLE "Board" ADD COLUMN embedding vector(1408);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'Board' AND column_name = 'embedding_metadata') THEN
        ALTER TABLE "Board" ADD COLUMN embedding_metadata JSONB;
    END IF;
    
    -- Asset table
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'Asset' AND column_name = 'embedding') THEN
        ALTER TABLE "Asset" ADD COLUMN embedding vector(1408);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'Asset' AND column_name = 'embedding_metadata') THEN
        ALTER TABLE "Asset" ADD COLUMN embedding_metadata JSONB;
    END IF;
    
    -- Search table
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'Search' AND column_name = 'embedding') THEN
        ALTER TABLE "Search" ADD COLUMN embedding vector(1408);
    END IF;
END $$;

-- Create indexes for vector similarity search (using ivfflat)
CREATE INDEX IF NOT EXISTS board_embedding_idx ON "Board" USING ivfflat (embedding vector_cosine_ops) WITH (lists = 50);
CREATE INDEX IF NOT EXISTS asset_embedding_idx ON "Asset" USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
CREATE INDEX IF NOT EXISTS search_embedding_idx ON "Search" USING ivfflat (embedding vector_cosine_ops) WITH (lists = 200);

-- Create full-text search indexes
CREATE INDEX IF NOT EXISTS board_search_idx ON "Board" USING gin(to_tsvector('english', name || ' ' || COALESCE(description, '')));
CREATE INDEX IF NOT EXISTS asset_search_idx ON "Asset" USING gin(to_tsvector('english', name));
````

## File: packages/database/src/client.ts
````typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

// Factory function to create database connection
export function createDatabaseClient(databaseUrl: string) {
  const sql = postgres(databaseUrl, {
    max: 1, // Minimal connections for edge runtime
    idle_timeout: 20,
    connect_timeout: 10,
  });

  return drizzle(sql, { schema });
}

// Export types for the database client
export type DatabaseClient = ReturnType<typeof createDatabaseClient>;
````

## File: packages/database/src/env.ts
````typescript
import { createEnv } from '@t3-oss/env-nextjs';
import { z } from 'zod';

export const database = () =>
  createEnv({
    server: {
      DATABASE_URL: z.string().url(),
      DATABASE_POOL_URL: z.string().url().optional(),
    },
    runtimeEnv: {
      DATABASE_URL: process.env.DATABASE_URL,
      DATABASE_POOL_URL: process.env.DATABASE_POOL_URL,
    },
  });
````

## File: packages/database/src/generated-zod.ts
````typescript
// This file is auto-generated by drizzle-zod
// Do not edit this file directly

import type { InferInsertModel, InferSelectModel } from 'drizzle-orm';
import { createInsertSchema, createSelectSchema } from 'drizzle-zod';
import * as schema from './schema';

// User schemas
export const userSchema = createSelectSchema(schema.users);
export const insertUserSchema = createInsertSchema(schema.users);
export type User = InferSelectModel<typeof schema.users>;
export type InsertUser = InferInsertModel<typeof schema.users>;

// Board schemas
export const boardSchema = createSelectSchema(schema.boards);
export const insertBoardSchema = createInsertSchema(schema.boards);
export type Board = InferSelectModel<typeof schema.boards>;
export type InsertBoard = InferInsertModel<typeof schema.boards>;

// Asset schemas
export const assetSchema = createSelectSchema(schema.assets);
export const insertAssetSchema = createInsertSchema(schema.assets);
export type Asset = InferSelectModel<typeof schema.assets>;
export type InsertAsset = InferInsertModel<typeof schema.assets>;

// Search schemas
export const searchSchema = createSelectSchema(schema.searches);
export const insertSearchSchema = createInsertSchema(schema.searches);
export type Search = InferSelectModel<typeof schema.searches>;
export type InsertSearch = InferInsertModel<typeof schema.searches>;

// BoardAsset schemas
export const boardAssetSchema = createSelectSchema(schema.boardAssets);
export const insertBoardAssetSchema = createInsertSchema(schema.boardAssets);
export type BoardAsset = InferSelectModel<typeof schema.boardAssets>;
export type InsertBoardAsset = InferInsertModel<typeof schema.boardAssets>;

// BoardCollaborator schemas
export const boardCollaboratorSchema = createSelectSchema(
  schema.boardCollaborators
);
export const insertBoardCollaboratorSchema = createInsertSchema(
  schema.boardCollaborators
);
export type BoardCollaborator = InferSelectModel<
  typeof schema.boardCollaborators
>;
export type InsertBoardCollaborator = InferInsertModel<
  typeof schema.boardCollaborators
>;

// LikedAsset schemas
export const likedAssetSchema = createSelectSchema(schema.likedAssets);
export const insertLikedAssetSchema = createInsertSchema(schema.likedAssets);
export type LikedAsset = InferSelectModel<typeof schema.likedAssets>;
export type InsertLikedAsset = InferInsertModel<typeof schema.likedAssets>;

// ViewedAsset schemas
export const viewedAssetSchema = createSelectSchema(schema.viewedAssets);
export const insertViewedAssetSchema = createInsertSchema(schema.viewedAssets);
export type ViewedAsset = InferSelectModel<typeof schema.viewedAssets>;
export type InsertViewedAsset = InferInsertModel<typeof schema.viewedAssets>;

// LikedBoard schemas
export const likedBoardSchema = createSelectSchema(schema.likedBoards);
export const insertLikedBoardSchema = createInsertSchema(schema.likedBoards);
export type LikedBoard = InferSelectModel<typeof schema.likedBoards>;
export type InsertLikedBoard = InferInsertModel<typeof schema.likedBoards>;

// ViewedBoard schemas
export const viewedBoardSchema = createSelectSchema(schema.viewedBoards);
export const insertViewedBoardSchema = createInsertSchema(schema.viewedBoards);
export type ViewedBoard = InferSelectModel<typeof schema.viewedBoards>;
export type InsertViewedBoard = InferInsertModel<typeof schema.viewedBoards>;

// RecentAsset schemas
export const recentAssetSchema = createSelectSchema(schema.recentAssets);
export const insertRecentAssetSchema = createInsertSchema(schema.recentAssets);
export type RecentAsset = InferSelectModel<typeof schema.recentAssets>;
export type InsertRecentAsset = InferInsertModel<typeof schema.recentAssets>;

// RecentBoard schemas
export const recentBoardSchema = createSelectSchema(schema.recentBoards);
export const insertRecentBoardSchema = createInsertSchema(schema.recentBoards);
export type RecentBoard = InferSelectModel<typeof schema.recentBoards>;
export type InsertRecentBoard = InferInsertModel<typeof schema.recentBoards>;

// Report schemas
export const reportSchema = createSelectSchema(schema.reports);
export const insertReportSchema = createInsertSchema(schema.reports);
export type Report = InferSelectModel<typeof schema.reports>;
export type InsertReport = InferInsertModel<typeof schema.reports>;
````

## File: packages/database/src/health.ts
````typescript
import { postgresClient } from './index';

export async function checkDatabaseHealth() {
  if (!postgresClient) {
    return { healthy: false, error: 'Database client not initialized' };
  }
  
  try {
    // Test basic connectivity
    await postgresClient`SELECT 1`;

    // Test vector extension
    const vectorTest = await postgresClient<Array<{ vector_enabled: boolean }>>`
      SELECT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'vector'
      ) as vector_enabled
    `;

    if (!vectorTest[0]?.vector_enabled) {
      throw new Error('pgvector extension not enabled');
    }

    return { healthy: true };
  } catch (error) {
    return { healthy: false, error: (error as Error).message };
  }
}

// Connection pool monitoring
export async function getPoolStats() {
  if (!postgresClient) {
    return {
      connected: false,
      error: 'Database client not initialized',
    };
  }
  
  // Note: Prisma doesn't expose pool metrics directly
  // This would need to be implemented using the database provider's metrics
  try {
    // Simple connectivity check
    const start = Date.now();
    await postgresClient`SELECT 1`;
    const latency = Date.now() - start;

    return {
      connected: true,
      latency,
    };
  } catch (error) {
    return {
      connected: false,
      error: (error as Error).message,
    };
  }
}
````

## File: packages/database/src/index.ts
````typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

// Legacy export for backward compatibility - will be undefined in Workers
const databaseUrl = typeof process !== 'undefined' ? process.env?.DATABASE_URL : undefined;

// Create the connection only if we have a URL (Node.js environments)
const sql = databaseUrl ? postgres(databaseUrl, {
  max: 1, // Minimal connections for edge runtime
  idle_timeout: 20,
  connect_timeout: 10,
}) : null;

// Create the Drizzle instance - will be null in Workers
export const db = sql ? drizzle(sql, { schema }) : null as any;

// Export the factory function for Workers
export { createDatabaseClient } from './client';
export type { DatabaseClient } from './client';

// Export schema and all types
export * from './schema';
export { schema };

// Export Drizzle operators
export {
  eq,
  and,
  or,
  not,
  inArray,
  notInArray,
  isNull,
  isNotNull,
  sql,
  desc,
  asc,
  count,
  gte,
  lte,
  gt,
  lt,
  ne,
  like,
  ilike,
  notLike,
  between,
  notBetween,
  exists,
  notExists,
} from 'drizzle-orm';

// Export generated types and schemas from drizzle-zod
export * from './generated-zod';
export { checkDatabaseHealth } from './health';

// Export postgres instance for raw queries if needed
export { sql as postgresClient };

// Hyperdrive support for Cloudflare Workers
export function getDb(hyperdrive?: any) {
  if (hyperdrive) {
    const sql = postgres(hyperdrive.connectionString);
    return drizzle(sql, { schema });
  }
  return db;
}
````

## File: packages/database/src/schema.ts
````typescript
import { relations, sql } from 'drizzle-orm';
import {
  boolean,
  index,
  integer,
  json,
  pgTable,
  real,
  text,
  timestamp,
  uuid,
  vector,
} from 'drizzle-orm/pg-core';

// Users table
export const users = pgTable(
  'User',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    clerkId: text('clerk_id').unique(),
    username: text('username').notNull().unique(),
    passwordHash: text('passwordHash').notNull(),
    phoneNumber: text('phoneNumber').notNull().unique(),
    phoneVerified: boolean('phone_verified').default(false).notNull(),
    pfpUrl: text('pfp_url'),
    bio: text('bio'),
    gender: text('gender'),
    name: text('name'),

    // Profile stats
    interests: json('interests').$type<string[]>(),
    pronouns: text('pronouns'),
    profileCompletion: real('profile_completion').default(0).notNull(),

    // Settings
    pinnedColumns: json('pinned_columns').$type<string[]>(),
    selectedProfileStat: text('selected_profile_stat').default('boards'),

    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      phoneNumberIdx: index('User_phoneNumber_idx').on(table.phoneNumber),
      usernameIdx: index('User_username_idx').on(table.username),
    };
  }
);

// Chat types
export const chatTypes = ['personal', 'direct', 'group'] as const;

// Chats table
export const chats = pgTable(
  'Chat',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    type: text('type').notNull(), // personal, direct, group
    title: text('title'),
    isArchived: boolean('is_archived').default(false).notNull(),
    pinned: boolean('pinned').default(false).notNull(),
    labels: json('labels').$type<string[]>(),
    lastMessage: json('last_message').$type<{
      content: string;
      sender_id: string;
      created_at: string;
    }>(),
    createdBy: text('created_by')
      .notNull()
      .references(() => users.id),
    createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      createdByIdx: index('Chat_createdBy_idx').on(table.createdBy),
      typeIdx: index('Chat_type_idx').on(table.type),
      createdAtIdx: index('Chat_createdAt_idx').on(table.createdAt),
    };
  }
);

// Chat participants table
export const chatParticipants = pgTable(
  'ChatParticipant',
  {
    chatId: text('chat_id')
      .notNull()
      .references(() => chats.id, { onDelete: 'cascade' }),
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    joinedAt: timestamp('joined_at', { mode: 'date' }).defaultNow().notNull(),
    lastReadAt: timestamp('last_read_at', { mode: 'date' }),
  },
  (table) => {
    return {
      pk: index('ChatParticipant_pk').on(table.chatId, table.userId),
      chatIdIdx: index('ChatParticipant_chatId_idx').on(table.chatId),
      userIdIdx: index('ChatParticipant_userId_idx').on(table.userId),
    };
  }
);

// Messages table
export const messages = pgTable(
  'Message',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    chatId: text('chat_id')
      .notNull()
      .references(() => chats.id, { onDelete: 'cascade' }),
    senderId: text('sender_id')
      .notNull()
      .references(() => users.id),
    content: text('content').notNull(),
    
    // AI features
    embedding: vector('embedding', { dimensions: 1408 }),
    references: json('references').$type<any[]>(),
    
    createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      chatIdIdx: index('Message_chatId_idx').on(table.chatId),
      senderIdIdx: index('Message_senderId_idx').on(table.senderId),
      createdAtIdx: index('Message_createdAt_idx').on(table.createdAt),
    };
  }
);

// Boards table
export const boards = pgTable(
  'Board',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    name: text('name').notNull(),
    visibility: text('visibility').default('public').notNull(),
    description: text('description'),
    instructions: text('instructions'),
    sources: text('sources'),
    icon: text('icon').default('üñºÔ∏è').notNull(),

    // Vector embedding for semantic search
    embedding: vector('embedding', { dimensions: 1408 }),
    embeddingMetadata: json('embedding_metadata').$type<Record<string, any>>(),

    creatorId: text('creator_id')
      .notNull()
      .references(() => users.id),
    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      creatorIdIdx: index('Board_creatorId_idx').on(table.creatorId),
      visibilityIdx: index('Board_visibility_idx').on(table.visibility),
      nameIdx: index('Board_name_idx').on(table.name),
    };
  }
);

// Assets table
export const assets = pgTable(
  'Asset',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    type: text('type').notNull(), // image, video, audio, gif, text, file
    name: text('name').notNull(),
    url: text('url').notNull(),
    thumbnailUrl: text('thumbnail_url'),
    storageKey: text('storage_key'),

    // Metadata
    width: real('width'),
    height: real('height'),
    duration: real('duration'), // For audio/video
    size: integer('size'), // File size in bytes
    mimeType: text('mime_type'),
    metadata: json('metadata').$type<Record<string, any>>(),

    // Vector embedding for multimodal search
    embedding: vector('embedding', { dimensions: 1408 }),
    embeddingMetadata: json('embedding_metadata').$type<Record<string, any>>(),

    creatorId: text('creator_id')
      .notNull()
      .references(() => users.id),
    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      creatorIdIdx: index('Asset_creatorId_idx').on(table.creatorId),
      typeIdx: index('Asset_type_idx').on(table.type),
      nameIdx: index('Asset_name_idx').on(table.name),
    };
  }
);

// Search table
export const searches = pgTable(
  'Search',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    query: text('query').notNull(),
    expandedContext: text('expanded_context'),

    // Vector embedding for search query
    embedding: vector('embedding', { dimensions: 1408 }),

    // Results tracking
    resultsSnapshot: json('results_snapshot').$type<any>(),
    newResultsCount: integer('new_results_count').default(0).notNull(),
    lastChecked: timestamp('last_checked', { mode: 'date' }),

    userId: text('user_id')
      .notNull()
      .references(() => users.id),
    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      userIdIdx: index('Search_userId_idx').on(table.userId),
      createdAtIdx: index('Search_createdAt_idx').on(table.createdAt),
    };
  }
);

// BoardAsset junction table
export const boardAssets = pgTable(
  'BoardAsset',
  {
    boardId: text('board_id')
      .notNull()
      .references(() => boards.id, { onDelete: 'cascade' }),
    assetId: text('asset_id')
      .notNull()
      .references(() => assets.id, { onDelete: 'cascade' }),
    order: integer('order'),
    createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      pk: index('BoardAsset_pk').on(table.boardId, table.assetId),
      boardIdIdx: index('BoardAsset_boardId_idx').on(table.boardId),
      assetIdIdx: index('BoardAsset_assetId_idx').on(table.assetId),
    };
  }
);

// BoardCollaborator table
export const boardCollaborators = pgTable(
  'BoardCollaborator',
  {
    boardId: text('board_id')
      .notNull()
      .references(() => boards.id, { onDelete: 'cascade' }),
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    accessLevel: text('access_level').default('view').notNull(), // view, edit, admin
    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      pk: index('BoardCollaborator_pk').on(table.boardId, table.userId),
      userIdIdx: index('BoardCollaborator_userId_idx').on(table.userId),
      boardIdIdx: index('BoardCollaborator_boardId_idx').on(table.boardId),
    };
  }
);

// LikedAsset table
export const likedAssets = pgTable(
  'LikedAsset',
  {
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    assetId: text('asset_id')
      .notNull()
      .references(() => assets.id, { onDelete: 'cascade' }),
    createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      pk: index('LikedAsset_pk').on(table.userId, table.assetId),
      userIdIdx: index('LikedAsset_userId_idx').on(table.userId),
      assetIdIdx: index('LikedAsset_assetId_idx').on(table.assetId),
    };
  }
);

// ViewedAsset table
export const viewedAssets = pgTable(
  'ViewedAsset',
  {
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    assetId: text('asset_id')
      .notNull()
      .references(() => assets.id, { onDelete: 'cascade' }),
    viewCount: integer('view_count').default(1).notNull(),
    lastViewed: timestamp('last_viewed', { mode: 'date' })
      .defaultNow()
      .notNull(),
  },
  (table) => {
    return {
      pk: index('ViewedAsset_pk').on(table.userId, table.assetId),
      userIdIdx: index('ViewedAsset_userId_idx').on(table.userId),
      lastViewedIdx: index('ViewedAsset_lastViewed_idx').on(table.lastViewed),
    };
  }
);

// LikedBoard table
export const likedBoards = pgTable(
  'LikedBoard',
  {
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    boardId: text('board_id')
      .notNull()
      .references(() => boards.id, { onDelete: 'cascade' }),
    createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      pk: index('LikedBoard_pk').on(table.userId, table.boardId),
      userIdIdx: index('LikedBoard_userId_idx').on(table.userId),
      boardIdIdx: index('LikedBoard_boardId_idx').on(table.boardId),
    };
  }
);

// ViewedBoard table
export const viewedBoards = pgTable(
  'ViewedBoard',
  {
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    boardId: text('board_id')
      .notNull()
      .references(() => boards.id, { onDelete: 'cascade' }),
    viewCount: integer('view_count').default(1).notNull(),
    lastViewed: timestamp('last_viewed', { mode: 'date' })
      .defaultNow()
      .notNull(),
  },
  (table) => {
    return {
      pk: index('ViewedBoard_pk').on(table.userId, table.boardId),
      userIdIdx: index('ViewedBoard_userId_idx').on(table.userId),
      boardIdIdx: index('ViewedBoard_boardId_idx').on(table.boardId),
    };
  }
);

// RecentAsset table
export const recentAssets = pgTable(
  'RecentAsset',
  {
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    assetId: text('asset_id')
      .notNull()
      .references(() => assets.id, { onDelete: 'cascade' }),
    usedAt: timestamp('used_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      pk: index('RecentAsset_pk').on(table.userId, table.assetId),
      userIdUsedAtIdx: index('RecentAsset_userId_usedAt_idx').on(
        table.userId,
        table.usedAt
      ),
    };
  }
);

// RecentBoard table
export const recentBoards = pgTable(
  'RecentBoard',
  {
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    boardId: text('board_id')
      .notNull()
      .references(() => boards.id, { onDelete: 'cascade' }),
    usedAt: timestamp('used_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      pk: index('RecentBoard_pk').on(table.userId, table.boardId),
      userIdUsedAtIdx: index('RecentBoard_userId_usedAt_idx').on(
        table.userId,
        table.usedAt
      ),
    };
  }
);

// Report table
export const reports = pgTable(
  'Report',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    content: text('content').notNull(),
    attachmentUrl: text('attachment_url'),
    category: text('category'), // bug, feature, content, other
    status: text('status').default('pending').notNull(), // pending, reviewed, resolved

    userId: text('user_id').references(() => users.id),
    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      statusIdx: index('Report_status_idx').on(table.status),
      userIdIdx: index('Report_userId_idx').on(table.userId),
    };
  }
);

// Define relations
export const usersRelations = relations(users, ({ one, many }) => ({
  boards: many(boards),
  assets: many(assets),
  collaborations: many(boardCollaborators),
  reports: many(reports),
  searches: many(searches),
  likedAssets: many(likedAssets),
  likedBoards: many(likedBoards),
  viewedAssets: many(viewedAssets),
  viewedBoards: many(viewedBoards),
  recentAssets: many(recentAssets),
  recentBoards: many(recentBoards),
  settings: one(userSettings),
  socialLinks: many(userSocialLinks),
  stats: one(userProfileStats),
  uploads: many(uploads),
  // Chat relations
  createdChats: many(chats),
  chatParticipants: many(chatParticipants),
  sentMessages: many(messages),
}));

export const boardsRelations = relations(boards, ({ one, many }) => ({
  creator: one(users, {
    fields: [boards.creatorId],
    references: [users.id],
  }),
  assets: many(boardAssets),
  collaborators: many(boardCollaborators),
  likes: many(likedBoards),
  views: many(viewedBoards),
  recentUses: many(recentBoards),
}));

export const assetsRelations = relations(assets, ({ one, many }) => ({
  creator: one(users, {
    fields: [assets.creatorId],
    references: [users.id],
  }),
  boards: many(boardAssets),
  likes: many(likedAssets),
  views: many(viewedAssets),
  recentUses: many(recentAssets),
}));

export const searchesRelations = relations(searches, ({ one }) => ({
  user: one(users, {
    fields: [searches.userId],
    references: [users.id],
  }),
}));

export const boardAssetsRelations = relations(boardAssets, ({ one }) => ({
  board: one(boards, {
    fields: [boardAssets.boardId],
    references: [boards.id],
  }),
  asset: one(assets, {
    fields: [boardAssets.assetId],
    references: [assets.id],
  }),
}));

export const boardCollaboratorsRelations = relations(
  boardCollaborators,
  ({ one }) => ({
    board: one(boards, {
      fields: [boardCollaborators.boardId],
      references: [boards.id],
    }),
    user: one(users, {
      fields: [boardCollaborators.userId],
      references: [users.id],
    }),
  })
);

export const likedAssetsRelations = relations(likedAssets, ({ one }) => ({
  user: one(users, {
    fields: [likedAssets.userId],
    references: [users.id],
  }),
  asset: one(assets, {
    fields: [likedAssets.assetId],
    references: [assets.id],
  }),
}));

export const viewedAssetsRelations = relations(viewedAssets, ({ one }) => ({
  user: one(users, {
    fields: [viewedAssets.userId],
    references: [users.id],
  }),
  asset: one(assets, {
    fields: [viewedAssets.assetId],
    references: [assets.id],
  }),
}));

export const likedBoardsRelations = relations(likedBoards, ({ one }) => ({
  user: one(users, {
    fields: [likedBoards.userId],
    references: [users.id],
  }),
  board: one(boards, {
    fields: [likedBoards.boardId],
    references: [boards.id],
  }),
}));

export const viewedBoardsRelations = relations(viewedBoards, ({ one }) => ({
  user: one(users, {
    fields: [viewedBoards.userId],
    references: [users.id],
  }),
  board: one(boards, {
    fields: [viewedBoards.boardId],
    references: [boards.id],
  }),
}));

export const recentAssetsRelations = relations(recentAssets, ({ one }) => ({
  user: one(users, {
    fields: [recentAssets.userId],
    references: [users.id],
  }),
  asset: one(assets, {
    fields: [recentAssets.assetId],
    references: [assets.id],
  }),
}));

export const recentBoardsRelations = relations(recentBoards, ({ one }) => ({
  user: one(users, {
    fields: [recentBoards.userId],
    references: [users.id],
  }),
  board: one(boards, {
    fields: [recentBoards.boardId],
    references: [boards.id],
  }),
}));

// User Profile Settings table
export const userSettings = pgTable(
  'UserSettings',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: text('user_id').references(() => users.id, { onDelete: 'cascade' }),

    // UI Preferences
    pinnedColumns: json('pinned_columns').$type<string[]>(),
    selectedProfileStat: text('selected_profile_stat').default('boards'),
    theme: text('theme').default('system'), // light, dark, system

    // Notification Preferences
    emailNotifications: json('email_notifications')
      .$type<{
        newCollaborators: boolean;
        newComments: boolean;
        mentions: boolean;
        boardUpdates: boolean;
      }>()
      .default({
        newCollaborators: true,
        newComments: true,
        mentions: true,
        boardUpdates: false,
      }),

    // Privacy Settings
    profileVisibility: text('profile_visibility').default('public'), // public, private, unlisted
    showEmail: boolean('show_email').default(false),
    showActivity: boolean('show_activity').default(true),

    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      userIdIdx: index('UserSettings_userId_idx').on(table.userId),
      pk: index('UserSettings_pk').on(table.userId),
    };
  }
);

// User Social Links table
export const userSocialLinks = pgTable(
  'UserSocialLink',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),

    platform: text('platform').notNull(), // twitter, github, linkedin, instagram, website, custom
    url: text('url').notNull(),
    username: text('username'), // platform-specific username
    order: integer('order').default(0).notNull(),
    isVerified: boolean('is_verified').default(false).notNull(),

    createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated_at', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      userIdIdx: index('UserSocialLink_userId_idx').on(table.userId),
      platformIdx: index('UserSocialLink_platform_idx').on(table.platform),
      userIdPlatformIdx: index('UserSocialLink_userId_platform_idx').on(
        table.userId,
        table.platform
      ),
    };
  }
);

// User Profile Stats table
export const userProfileStats = pgTable(
  'UserProfileStats',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),

    // Counts
    boardCount: integer('board_count').default(0).notNull(),
    assetCount: integer('asset_count').default(0).notNull(),
    likeCount: integer('like_count').default(0).notNull(),
    viewCount: integer('view_count').default(0).notNull(),
    collaboratorCount: integer('collaborator_count').default(0).notNull(),

    // Analytics
    followersCount: integer('followers_count').default(0).notNull(),
    followingCount: integer('following_count').default(0).notNull(),

    // Time-based stats
    lastActive: timestamp('last_active', { mode: 'date' })
      .defaultNow()
      .notNull(),
    totalViews: integer('total_views').default(0).notNull(),
    totalLikes: integer('total_likes').default(0).notNull(),

    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      userIdIdx: index('UserProfileStats_userId_idx').on(table.userId),
      pk: index('UserProfileStats_pk').on(table.userId),
    };
  }
);

export const reportsRelations = relations(reports, ({ one }) => ({
  user: one(users, {
    fields: [reports.userId],
    references: [users.id],
  }),
}));

export const userSettingsRelations = relations(userSettings, ({ one }) => ({
  user: one(users, {
    fields: [userSettings.userId],
    references: [users.id],
  }),
}));

export const userSocialLinksRelations = relations(
  userSocialLinks,
  ({ one }) => ({
    user: one(users, {
      fields: [userSocialLinks.userId],
      references: [users.id],
    }),
  })
);

export const userProfileStatsRelations = relations(
  userProfileStats,
  ({ one }) => ({
    user: one(users, {
      fields: [userProfileStats.userId],
      references: [users.id],
    }),
  })
);

// Uploads table for tracking staged uploads
export const uploads = pgTable(
  'Upload',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: text('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),

    storageKey: text('storage_key').notNull(),
    type: text('type').notNull(), // image, video, audio, gif, text, file
    name: text('name').notNull(),
    size: integer('size').notNull(),
    mimeType: text('mime_type').notNull(),

    status: text('status').notNull().default('pending'), // pending, uploading, completed, failed, cancelled

    metadata: json('metadata').$type<Record<string, any>>(),
    thumbnailUrl: text('thumbnail_url'),

    expiresAt: timestamp('expires_at')
      .notNull()
      .default(sql`NOW() + INTERVAL '24 hours'`),

    createdAt: timestamp('created', { mode: 'date' }).defaultNow().notNull(),
    updatedAt: timestamp('updated', { mode: 'date' }).defaultNow().notNull(),
  },
  (table) => {
    return {
      userIdIdx: index('Upload_userId_idx').on(table.userId),
      storageKeyIdx: index('Upload_storageKey_idx').on(table.storageKey),
      statusIdx: index('Upload_status_idx').on(table.status),
      expiresAtIdx: index('Upload_expiresAt_idx').on(table.expiresAt),
    };
  }
);

export const uploadsRelations = relations(uploads, ({ one }) => ({
  user: one(users, {
    fields: [uploads.userId],
    references: [users.id],
  }),
}));

// Chat relations
export const chatsRelations = relations(chats, ({ one, many }) => ({
  creator: one(users, {
    fields: [chats.createdBy],
    references: [users.id],
  }),
  participants: many(chatParticipants),
  messages: many(messages),
}));

export const chatParticipantsRelations = relations(chatParticipants, ({ one }) => ({
  chat: one(chats, {
    fields: [chatParticipants.chatId],
    references: [chats.id],
  }),
  user: one(users, {
    fields: [chatParticipants.userId],
    references: [users.id],
  }),
}));

export const messagesRelations = relations(messages, ({ one }) => ({
  chat: one(chats, {
    fields: [messages.chatId],
    references: [chats.id],
  }),
  sender: one(users, {
    fields: [messages.senderId],
    references: [users.id],
  }),
}));
````

## File: packages/database/.env.example
````
DATABASE_URL=""
````

## File: packages/database/.gitignore
````
node_modules
# Keep environment variables out of version control
.env

# Generated client
generated
````

## File: packages/database/CLAUDE.md
````markdown
# @repo/database Package Context

## Development Standards

### Package Context
This package provides database utilities and schema definitions for the Squish ecosystem. It uses Drizzle ORM with PostgreSQL, offering type-safe database access, migrations, and connection management.

### Technology Stack
- **Drizzle ORM**: 0.38.2 - Type-safe ORM
- **PostgreSQL**: Latest - Primary database
- **postgres.js**: 3.4.5 - PostgreSQL client
- **TypeScript**: 5.7+ strict configuration

### Key Dependencies
```json
{
  "dependencies": {
    "drizzle-orm": "^0.38.2",
    "postgres": "^3.4.5",
    "drizzle-kit": "^0.27.0"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@types/node": "^22.15.21"
  }
}
```

## Package Structure

### Directory Layout
```
src/
   index.ts              # Main package exports
   schema/               # Database schema definitions
      index.ts         # Schema exports
      auth.ts          # Authentication-related tables
      boards.ts        # Board management tables
      assets.ts        # Asset management tables
      users.ts         # User management tables
      collaborations.ts # Collaboration tables
      analytics.ts     # Analytics tables
   queries/              # Pre-built queries
      auth.ts          # Auth queries
      boards.ts        # Board queries
      assets.ts        # Asset queries
      index.ts         # Query exports
   utils/                # Database utilities
      connection.ts    # Connection management
      health.ts        # Health checks
      migrations.ts    # Migration utilities
      index.ts         # Utility exports
   types/                # TypeScript type definitions
       schema.ts         # Schema-generated types
       queries.ts        # Query result types
       index.ts         # Type exports
```

## Schema Definitions

### Table Schema Pattern
```typescript
// src/schema/boards.ts
import { pgTable, text, timestamp, uuid, jsonb } from 'drizzle-orm/pg-core';

export const boards = pgTable('boards', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: text('name').notNull(),
  description: text('description'),
  workspaceId: uuid('workspace_id').notNull(),
  ownerId: uuid('owner_id').notNull(),
  settings: jsonb('settings').default('{}'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
});

// Relations
export const boardsRelations = {
  owner: relation(boards, ({ ownerId }) => ownerId),
  workspace: relation(boards, ({ workspaceId }) => workspaceId),
  assets: relation(boards, assetBoards, ({ boardId }) => boardId),
};

// Type generation
export type Board = typeof boards.$inferSelect;
export type NewBoard = typeof boards.$inferInsert;
```

### Schema Export
```typescript
// src/schema/index.ts
export * from './auth';
export * from './boards';
export * from './assets';
export * from './users';
export * from './collaborations';
export * from './analytics';

// Complete schema
export const schema = {
  users,
  boards,
  assets,
  boardMembers,
  comments,
  // ... other tables
};
```

## Database Connection

### Connection Management
```typescript
// src/utils/connection.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

// Connection cache
let connection: postgres.Sql | null = null;
let db: ReturnType<typeof drizzle> | null = null;

export function createDatabase(connectionString: string) {
  if (db) return db;
  
  connection = postgres(connectionString, {
    prepare: false,
    max: 10, // connection pool size
    idle_timeout: 20,
    connect_timeout: 10,
  });
  
  db = drizzle(connection, {
    schema,
    logger: process.env.NODE_ENV === 'development',
  });
  
  return db;
}

export function getDatabase() {
  if (!db) {
    throw new Error('Database not initialized');
  }
  return db;
}

export async function closeDatabase() {
  if (connection) {
    await connection.end();
    connection = null;
    db = null;
  }
}
```

### Health Check
```typescript
// src/utils/health.ts
export async function checkDatabaseHealth(db: ReturnType<typeof drizzle>) {
  try {
    const result = await db.select({ count: sql`count(*)` }).from(users).limit(1);
    return {
      healthy: true,
      responseTime: result[0].count,
    };
  } catch (error) {
    return {
      healthy: false,
      error: error.message,
    };
  }
}
```

## Query Patterns

### Basic CRUD Operations
```typescript
// src/queries/boards.ts
import { eq, and, desc, ilike } from 'drizzle-orm';
import type { Board, NewBoard } from '../schema';

export class BoardQueries {
  constructor(private db: ReturnType<typeof drizzle>) {}
  
  async create(data: NewBoard): Promise<Board> {
    const result = await this.db
      .insert(boards)
      .values(data)
      .returning();
    return result[0];
  }
  
  async findById(id: string): Promise<Board | null> {
    const result = await this.db
      .select()
      .from(boards)
      .where(eq(boards.id, id))
      .limit(1);
    return result[0] || null;
  }
  
  async findByWorkspace(workspaceId: string, search?: string) {
    let query = this.db
      .select()
      .from(boards)
      .where(eq(boards.workspaceId, workspaceId));
    
    if (search) {
      query = query.where(
        and(
          eq(boards.workspaceId, workspaceId),
          ilike(boards.name, `%${search}%`)
        )
      );
    }
    
    return query.orderBy(desc(boards.updatedAt));
  }
  
  async update(id: string, data: Partial<NewBoard>): Promise<Board> {
    const result = await this.db
      .update(boards)
      .set({ ...data, updatedAt: new Date() })
      .where(eq(boards.id, id))
      .returning();
    return result[0];
  }
  
  async delete(id: string): Promise<void> {
    await this.db
      .delete(boards)
      .where(eq(boards.id, id));
  }
}
```

### Complex Queries with Joins
```typescript
// src/queries/assets.ts
export async function getAssetsWithDetails(db: ReturnType<typeof drizzle>, boardId?: string) {
  const baseQuery = db
    .select({
      id: assets.id,
      name: assets.name,
      type: assets.type,
      url: assets.url,
      boardId: assetBoards.boardId,
      boardName: boards.name,
      ownerName: users.name,
      createdAt: assets.createdAt,
    })
    .from(assets)
    .leftJoin(assetBoards, eq(assets.id, assetBoards.assetId))
    .leftJoin(boards, eq(assetBoards.boardId, boards.id))
    .leftJoin(users, eq(assets.ownerId, users.id));
  
  if (boardId) {
    baseQuery.where(eq(assetBoards.boardId, boardId));
  }
  
  return baseQuery.orderBy(desc(assets.createdAt));
}
```

## Migration System

### Migration Generation
```typescript
// Use drizzle-kit CLI to generate migrations
// In package.json:
,{
  "scripts": {
    "db:generate": "drizzle-kit generate:pg",
    "db:migrate": "drizzle-kit migrate",
    "db:push": "drizzle-kit push:pg",
    "db:studio": "drizzle-kit studio"
  }
}
```

### Custom Migration
```typescript
// migrations/0001_add_board_settings.ts
import { sql } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

export async function up(db: ReturnType<typeof drizzle>) {
  // Add settings column to boards table
  await db.execute(sql`
    ALTER TABLE boards 
    ADD COLUMN settings jsonb DEFAULT '{}'::jsonb
  `);
  
  // Add index for better performance
  await db.execute(sql`
    CREATE INDEX IF NOT EXISTS idx_boards_workspace_id 
    ON boards(workspace_id)
  `);
}

export async function down(db: ReturnType<typeof drizzle>) {
  await db.execute(sql`
    ALTER TABLE boards 
    DROP COLUMN settings
  `);
  
  await db.execute(sql`
    DROP INDEX IF EXISTS idx_boards_workspace_id
  `);
}
```

## Integration Patterns

### Using in API Service
```typescript
// In apps/api/src/lib/database.ts
import { createDatabase } from '@repo/database';
import * as schema from '@repo/database/schema';

const db = createDatabase(process.env.DATABASE_URL);

export { db, schema };
```

### Using in Client Applications
```typescript
// In apps/app/src/lib/db.ts
import { createDatabase, BoardQueries } from '@repo/database';

const db = createDatabase(process.env.NEXT_PUBLIC_DATABASE_URL);
const boardQueries = new BoardQueries(db);

// In component
export function useBoards() {
  const [boards, setBoards] = useState<Board[]>([]);
  
  useEffect(() => {
    boardQueries.findByWorkspace(currentWorkspaceId).then(setBoards);
  }, [currentWorkspaceId]);
  
  return { boards };
}
```

## Common Tasks

### Adding a New Table
1. Define schema in appropriate file
2. Add to schema exports
3. Generate types with `pnpm db:generate`
4. Create migration if needed
5. Add queries for the table

### Adding Indexes
1. Add index to schema definition
2. Create migration for existing tables
3. Test query performance

### Running Migrations
```bash
# Generate migration from schema changes
pnpm db:generate

# Run migrations
pnpm db:migrate

# Push schema changes (dev only)
pnpm db:push

# Open database browser
pnpm db:studio
```

## Files to Know
- `src/schema/index.ts` - Complete schema definitions
- `src/utils/connection.ts` - Database connection management
- `src/queries/boards.ts` - Board query examples
- `migrations/` - Database migration files

## Quality Checklist

Before committing changes to this package:
- [ ] Schema changes tested
- [ ] Queries optimized with proper indexes
- [ ] TypeScript types generated
- [ ] Migrations reversible
- [ ] Connection pooling configured
- [ ] No SQL injection vulnerabilities
- [ ] Database constraints applied
- [ ] Performance tested with large datasets
- [ ] Documentation updated

---

*This context ensures Claude Code understands the database package structure and patterns when working with data layers.*
````

## File: packages/database/drizzle.config.ts
````typescript
import * as path from 'node:path';
import * as dotenv from 'dotenv';
import { defineConfig } from 'drizzle-kit';

// Load environment variables
dotenv.config({ path: path.resolve(process.cwd(), '../../.env') });
dotenv.config({ path: path.resolve(process.cwd(), '../../.env.local') });

export default defineConfig({
  schema: './src/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  verbose: true,
  strict: true,
});
````

## File: packages/database/index.ts
````typescript
// Re-export everything from src/index.ts
export * from './src';

// Export health check functions
export { checkDatabaseHealth, getPoolStats } from './src/health';
````

## File: packages/database/keys.ts
````typescript
import { createEnv } from '@t3-oss/env-nextjs';
import { z } from 'zod';

export const keys = () =>
  createEnv({
    server: {
      DATABASE_URL: z.string().min(1).url(),
    },
    runtimeEnv: {
      DATABASE_URL: process.env.DATABASE_URL,
    },
  });
````

## File: packages/database/package.json
````json
{
  "name": "@repo/database",
  "version": "0.0.0",
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": {
      "types": "./src/index.ts",
      "import": "./src/index.ts",
      "require": "./src/index.ts"
    },
    "./schema": "./src/schema.ts",
    "./keys": "./keys.ts"
  },
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false",
    "db:generate": "drizzle-kit generate",
    "db:push": "drizzle-kit push",
    "db:migrate": "drizzle-kit migrate",
    "db:studio": "drizzle-kit studio",
    "db:seed": "tsx src/seed.ts",
    "generate-zod": "tsx src/generate-zod.ts"
  },
  "dependencies": {
    "@neondatabase/serverless": "^1.0.0",
    "@repo/logger": "workspace:*",
    "@t3-oss/env-core": "^0.13.8",
    "@t3-oss/env-nextjs": "^0.12.0",
    "drizzle-orm": "^0.44.3",
    "drizzle-zod": "^0.8.2",
    "postgres": "^3.4.7",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@types/node": "22.14.1",
    "dotenv": "^16.3.1",
    "drizzle-kit": "^0.31.4",
    "tsx": "^4.6.0",
    "typescript": "^5.8.3"
  }
}
````

## File: packages/database/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "baseUrl": "."
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
````

## File: packages/design/components/ui/accordion.tsx
````typescript
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDownIcon } from "@radix-ui/react-icons"

import { cn } from "../../lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDownIcon className="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))
AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
````

## File: packages/design/components/ui/button.tsx
````typescript
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "../../lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
````

## File: packages/design/components/ui/card.tsx
````typescript
import * as React from "react"

import { cn } from "../../lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
````

## File: packages/design/components/ui/dialog.tsx
````typescript
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "../../lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-none border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
````

## File: packages/design/components/ui/dropdown-menu.tsx
````typescript
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "../../lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
````

## File: packages/design/components/ui/index.ts
````typescript
export * from './accordion';
export * from './button';
export * from './card';
export * from './dialog';
export * from './dropdown-menu';
export * from './input';
export * from './select';
export * from './sonner';
export * from './tabs';
export * from './toast';
// export * from './toaster'; // Commented out - using sonner's Toaster instead
export * from './tooltip';
export * from './use-toast';
````

## File: packages/design/components/ui/input.tsx
````typescript
import * as React from "react"

import { cn } from "../../lib/utils"

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
````

## File: packages/design/components/ui/select.tsx
````typescript
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "../../lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
````

## File: packages/design/components/ui/sonner.tsx
````typescript
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner } from "sonner"

type ToasterProps = React.ComponentProps<typeof Sonner>

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  )
}

export { Toaster }
````

## File: packages/design/components/ui/tabs.tsx
````typescript
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "../../lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
````

## File: packages/design/components/ui/toast.tsx
````typescript
'use client';

import * as React from 'react';
import { Cross2Icon } from '@radix-ui/react-icons';
import * as ToastPrimitives from '@radix-ui/react-toast';
import { cva, type VariantProps } from 'class-variance-authority';

import { cn } from '../../lib/utils';

const ToastProvider = ToastPrimitives.Provider;

const ToastViewport = React.forwardRef<
  React.ComponentRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      'fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]',
      className
    )}
    {...props}
  />
));
ToastViewport.displayName = ToastPrimitives.Viewport.displayName;

const toastVariants = cva(
  'group pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full',
  {
    variants: {
      variant: {
        default: 'border bg-background text-foreground',
        destructive:
          'destructive group border-destructive bg-destructive text-destructive-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  }
);

const Toast = React.forwardRef<
  React.ComponentRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  );
});
Toast.displayName = ToastPrimitives.Root.displayName;

const ToastAction = React.forwardRef<
  React.ComponentRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      'inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium transition-colors hover:bg-secondary focus:outline-none focus:ring-1 focus:ring-ring disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive',
      className
    )}
    {...props}
  />
));
ToastAction.displayName = ToastPrimitives.Action.displayName;

const ToastClose = React.forwardRef<
  React.ComponentRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      'absolute right-1 top-1 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-1 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600',
      className
    )}
    toast-close=""
    {...props}
  >
    <Cross2Icon className="h-4 w-4" />
  </ToastPrimitives.Close>
));
ToastClose.displayName = ToastPrimitives.Close.displayName;

const ToastTitle = React.forwardRef<
  React.ComponentRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn('text-sm font-semibold [&+div]:text-xs', className)}
    {...props}
  />
));
ToastTitle.displayName = ToastPrimitives.Title.displayName;

const ToastDescription = React.forwardRef<
  React.ComponentRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn('text-sm opacity-90', className)}
    {...props}
  />
));
ToastDescription.displayName = ToastPrimitives.Description.displayName;

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>;

type ToastActionElement = React.ReactElement<typeof ToastAction>;

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
};
````

## File: packages/design/components/ui/toaster.tsx
````typescript
'use client';

import { useToast } from './use-toast';
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from './toast';

export function Toaster() {
  const { toasts } = useToast();

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        );
      })}
      <ToastViewport />
    </ToastProvider>
  );
}
````

## File: packages/design/components/ui/tooltip.tsx
````typescript
'use client';

import * as React from 'react';
import * as TooltipPrimitive from '@radix-ui/react-tooltip';

import { cn } from '../../lib/utils';

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      delayDuration={delayDuration}
      {...props}
    />
  );
}

const Tooltip = TooltipPrimitive.Root;

const TooltipTrigger = TooltipPrimitive.Trigger;

const TooltipContent = React.forwardRef<
  React.ComponentRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      'z-50 overflow-hidden rounded-md bg-black px-3 py-1.5 text-xs text-white animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2',
      className
    )}
    {...props}
  />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };
````

## File: packages/design/components/ui/use-toast.ts
````typescript
'use client';

import * as React from 'react';

import type { ToastActionElement, ToastProps } from './toast';

const TOAST_LIMIT = 1;
const TOAST_REMOVE_DELAY = 1000000;

type ToasterToast = ToastProps & {
  id: string;
  title?: React.ReactNode;
  description?: React.ReactNode;
  action?: ToastActionElement;
};

const actionTypes = {
  ADD_TOAST: 'ADD_TOAST',
  UPDATE_TOAST: 'UPDATE_TOAST',
  DISMISS_TOAST: 'DISMISS_TOAST',
  REMOVE_TOAST: 'REMOVE_TOAST',
} as const;

let count = 0;

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER;
  return count.toString();
}

type ActionType = typeof actionTypes;

type Action =
  | {
      type: ActionType['ADD_TOAST'];
      toast: ToasterToast;
    }
  | {
      type: ActionType['UPDATE_TOAST'];
      toast: Partial<ToasterToast>;
    }
  | {
      type: ActionType['DISMISS_TOAST'];
      toastId?: ToasterToast['id'];
    }
  | {
      type: ActionType['REMOVE_TOAST'];
      toastId?: ToasterToast['id'];
    };

interface State {
  toasts: ToasterToast[];
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>();

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return;
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId);
    dispatch({
      type: 'REMOVE_TOAST',
      toastId: toastId,
    });
  }, TOAST_REMOVE_DELAY);

  toastTimeouts.set(toastId, timeout);
};

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case 'ADD_TOAST':
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      };

    case 'UPDATE_TOAST':
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      };

    case 'DISMISS_TOAST': {
      const { toastId } = action;

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId);
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id);
        });
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      };
    }
    case 'REMOVE_TOAST':
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        };
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      };
  }
};

const listeners: Array<(state: State) => void> = [];

let memoryState: State = { toasts: [] };

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action);
  listeners.forEach((listener) => {
    listener(memoryState);
  });
}

type Toast = Omit<ToasterToast, 'id'>;

function toast({ ...props }: Toast) {
  const id = genId();

  const update = (props: ToasterToast) =>
    dispatch({
      type: 'UPDATE_TOAST',
      toast: { ...props, id },
    });
  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id });

  dispatch({
    type: 'ADD_TOAST',
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss();
      },
    },
  });

  return {
    id: id,
    dismiss,
    update,
  };
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState);

  React.useEffect(() => {
    listeners.push(setState);
    return () => {
      const index = listeners.indexOf(setState);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    };
  }, [state]);

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: 'DISMISS_TOAST', toastId }),
  };
}

export { useToast, toast };
````

## File: packages/design/components/index.ts
````typescript
// Export all UI components
export * from './ui';
````

## File: packages/design/hooks/index.ts
````typescript
export * from './usePicker';
export * from './useColumnDrag';
export * from './useColumnLayout';
````

## File: packages/design/hooks/use-streaming-text.ts
````typescript
'use client';

import { useCallback, useRef, useState } from 'react';

export interface UseStreamingTextOptions {
  onComplete?: () => void;
  streamSpeed?: number;
}

export function useStreamingText({
  onComplete,
  streamSpeed = 0,
}: UseStreamingTextOptions = {}) {
  const [displayedText, setDisplayedText] = useState('');
  const [isStreaming, setIsStreaming] = useState(false);
  const abortControllerRef = useRef<AbortController | null>(null);

  const streamText = useCallback(
    async (text: string) => {
      // Cancel any ongoing streaming
      if (abortControllerRef.current) {
        abortControllerRef.current.abort();
      }

      // Create a new AbortController for this stream
      abortControllerRef.current = new AbortController();
      const { signal } = abortControllerRef.current;

      setDisplayedText('');
      setIsStreaming(true);

      if (streamSpeed === 0) {
        // Instant display
        setDisplayedText(text);
        setIsStreaming(false);
        onComplete?.();
        return;
      }

      // Stream the text character by character
      for (let i = 0; i <= text.length; i++) {
        if (signal.aborted) break;

        setDisplayedText(text.slice(0, i));

        if (i < text.length) {
          await new Promise(resolve => setTimeout(resolve, streamSpeed));
        }
      }

      if (!signal.aborted) {
        setIsStreaming(false);
        onComplete?.();
      }
    },
    [streamSpeed, onComplete]
  );

  const stopStreaming = useCallback(() => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
      abortControllerRef.current = null;
    }
    setIsStreaming(false);
  }, []);

  return {
    displayedText,
    isStreaming,
    streamText,
    stopStreaming,
  };
}
````

## File: packages/design/lib/colors.ts
````typescript
// Color palette organized by color families
export const PALETTE = {
  NEUTRALS: {
    WARM: [
      '#D7CEC7', // Warm Gray 1
      '#C8C1BB', // Moon Rock
      '#B7B1A9', // Ash
      '#A69F98', // Atmosphere
      '#958B84', // Timber Wolf
    ],
    COOL: [
      '#D3DBCE', // Lily White
      '#C5D5CB', // Glacier Gray
      '#B5C7CC', // Harbor Mist
      '#98B4D4', // Serenity
      '#89A7C2', // Celestial
    ]
  },
  EARTH: {
    SAND: [
      '#E8E3D9', // Cloud Cream
      '#E6D3C5', // Toasted Almond
      '#E4D5C5', // Sand Dollar
      '#D1BAA3', // Hazelnut
      '#C5A992', // Warm Sand
    ],
    STONE: [
      '#DAD7CB', // Tidal Foam
      '#D4CDC1', // Peyote
      '#C2BAB1', // Feather Gray
      '#B6ADA5', // Atmosphere
      '#A89D94', // Desert Taupe
    ]
  },
  NATURE: {
    SAGE: [
      '#D2D5C9', // Desert Sage
      '#C3C6BA', // Laurel Oak
      '#B4B7AB', // Rock Ridge
      '#A5A89C', // Dried Herb
      '#96998D', // Vetiver
    ],
    MOSS: [
      '#CCD4C8', // Mineral Gray
      '#BDC5B9', // Shadow Green
      '#AEB6AA', // Alfalfa
      '#9FA79B', // Oil Green
      '#90988C', // Moss Gray
    ]
  },
  WATER: {
    MIST: [
      '#E4E6E8', // Morning Mist
      '#D5D7D9', // Dawn Gray
      '#C6C8CA', // Vapor
      '#B7B9BB', // Silver Cloud
      '#A8AAAC', // Ghost Gray
    ],
    FOG: [
      '#DCE2E5', // Sea Salt
      '#CDD3D6', // Foggy Dew
      '#BEC4C7', // Sterling Blue
      '#AFB5B8', // Blue Fog
      '#A0A6A9', // Storm Gray
    ]
  }
} as const;

// Flattened array of all colors for the random generator
const ALL_COLORS = Object.values(PALETTE)
  .flatMap(family => Object.values(family))
  .flat();

type ColorFamily = keyof typeof PALETTE;
type ColorSubFamily = {
  [K in ColorFamily]: keyof typeof PALETTE[K];
}[ColorFamily];

interface ColorInfo {
  hex: string;
  family: ColorFamily;
  subFamily: ColorSubFamily;
  index: number;
}

/**
 * Generates a consistent color based on an input string
 * @param input - String to generate color from (e.g. user ID, asset ID)
 * @returns Hex color code from the predefined palette
 */
export function generateColor(input: string): string {
  const hash = Array.from(input).reduce(
    (acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0
  );
  return ALL_COLORS[Math.abs(hash) % ALL_COLORS.length];
}

/**
 * Gets detailed information about a color including its family
 * @param hex - The hex color code to look up
 * @returns ColorInfo object or undefined if not found
 */
export function getColorInfo(hex: string): ColorInfo | undefined {
  for (const [family, subFamilies] of Object.entries(PALETTE)) {
    for (const [subFamily, colors] of Object.entries(subFamilies)) {
      const index = colors.indexOf(hex);
      if (index !== -1) {
        return {
          hex,
          family: family as ColorFamily,
          subFamily: subFamily as ColorSubFamily,
          index
        };
      }
    }
  }
  return undefined;
}

/**
 * Gets a complementary color from the opposite family
 * @param hex - The hex color code to find complement for
 * @returns Complementary hex color code
 */
export function getComplementaryColor(hex: string): string {
  const info = getColorInfo(hex);
  if (!info) return hex;

  // Get opposite family
  const families = Object.keys(PALETTE) as ColorFamily[];
  const currentFamilyIndex = families.indexOf(info.family);
  const oppositeFamily = families[(currentFamilyIndex + 2) % families.length];

  // Get first subfamily from opposite family
  const subFamilies = Object.keys(PALETTE[oppositeFamily]) as Array<keyof typeof PALETTE[typeof oppositeFamily]>;
  const oppositeSubFamily = subFamilies[0];

  // Get color at same intensity level
  return PALETTE[oppositeFamily][oppositeSubFamily][info.index];
}

/**
 * Gets a harmonious color from the same family
 * @param hex - The hex color code to find harmony for
 * @returns Harmonious hex color code
 */
export function getHarmoniousColor(hex: string): string {
  const info = getColorInfo(hex);
  if (!info) return hex;

  // Get other subfamily from same family
  const subFamilies = Object.keys(PALETTE[info.family]) as Array<keyof typeof PALETTE[typeof info.family]>;
  const currentSubFamilyIndex = subFamilies.indexOf(info.subFamily as keyof typeof PALETTE[typeof info.family]);
  const harmoniousSubFamily = subFamilies[(currentSubFamilyIndex + 1) % subFamilies.length];

  // Get color at same intensity level
  return PALETTE[info.family][harmoniousSubFamily][info.index];
}

/**
 * Determines if white or black text should be used on a given background color
 * @param bgColor - The background color in hex format
 * @returns '#000000' for dark text or '#ffffff' for light text
 */
export function getContrastingTextColor(bgColor: string): string {
  const r = parseInt(bgColor.slice(1, 3), 16);
  const g = parseInt(bgColor.slice(3, 5), 16);
  const b = parseInt(bgColor.slice(5, 7), 16);
  
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.5 ? '#000000' : '#ffffff';
}

/**
 * Adjusts the opacity of a hex color
 * @param hex - The hex color code
 * @param opacity - Opacity value (0-100)
 * @returns Hex color with opacity
 */
export function withOpacity(hex: string, opacity: number): string {
  const alpha = Math.round((opacity / 100) * 255).toString(16);
  return `${hex}${alpha.padStart(2, '0')}`;
}
````

## File: packages/design/lib/safari-utils.ts
````typescript
'use client';

import { useEffect, useState } from 'react';

/**
 * Detect if the browser is Safari on iOS
 */
export function useIsIOSSafari() {
  const [isIOSSafari, setIsIOSSafari] = useState(false);

  useEffect(() => {
    const userAgent = window.navigator.userAgent;
    const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !(window as any).MSStream;
    const isSafari = /^((?!chrome|android).)*safari/i.test(userAgent);
    
    setIsIOSSafari(isIOS && isSafari);
  }, []);

  return isIOSSafari;
}

/**
 * CSS transform for GPU acceleration on Safari
 * Helps with performance issues on iOS Safari
 */
export const safariGPUAcceleration = {
  transform: 'translateZ(0)',
  willChange: 'transform',
  '-webkit-transform': 'translateZ(0)',
  '-webkit-backface-visibility': 'hidden',
  'backface-visibility': 'hidden',
} as const;
````

## File: packages/design/lib/utils.ts
````typescript
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
````

## File: packages/design/providers/theme.tsx
````typescript
'use client';

import type { ThemeProviderProps } from 'next-themes';
import { ThemeProvider as NextThemeProvider, useTheme } from 'next-themes';
import { useEffect } from 'react';

// Theme color updater component that updates mobile browser chrome
function ThemeColorUpdater() {
  const { theme, systemTheme } = useTheme();

  useEffect(() => {
    // Theme colors that match globals.css CSS variables
    const lightBg = '#faf9f7'; // oklch(0.98 0.005 85)
    const darkBg = '#0a0a0a'; // proper dark gray

    const updateMetaThemeColor = (color: string) => {
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) {
        meta.setAttribute('content', color);
      }
    };

    const updateDocumentBackground = (color: string) => {
      // Update document background immediately to prevent flash
      document.documentElement.style.backgroundColor = color;

      // Force background on mobile by also updating body
      if (document.body) {
        document.body.style.backgroundColor = color;
      }
    };

    // Determine the actual theme being used
    let resolvedTheme: 'light' | 'dark';
    if (theme === 'system') {
      resolvedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light';
    } else {
      resolvedTheme = (theme as 'light' | 'dark') || 'light';
    }

    // Update theme color for mobile browser chrome
    const themeColor = resolvedTheme === 'dark' ? darkBg : lightBg;
    updateMetaThemeColor(themeColor);
    updateDocumentBackground(themeColor);
  }, [theme, systemTheme]);

  return null;
}

export const ThemeProvider = ({
  children,
  ...properties
}: ThemeProviderProps) => {
  return (
    <NextThemeProvider
      attribute="class"
      defaultTheme="system"
      enableSystem={true}
      disableTransitionOnChange
      storageKey="next-themes-theme"
      enableColorScheme={false}
      {...properties}
    >
      {children}
      <ThemeColorUpdater />
    </NextThemeProvider>
  );
};
````

## File: packages/design/styles/cmdk.css
````css
/* Command menu (cmdk) styles */
[cmdk-root] {
  max-width: 640px;
  width: 100%;
  max-height: 400px;
  overflow: hidden;
  transition: opacity 100ms ease;
  position: relative;
  z-index: 50;
}

[cmdk-input] {
  font-size: 0.875rem;
  width: 100%;
  box-sizing: border-box;
  outline: none;
  border: none;
  background: var(--color-background);
  color: var(--color-foreground);
  border-radius: 0;
  caret-color: var(--color-primary);
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--color-border);
}

[cmdk-input]::placeholder {
  color: var(--color-muted-foreground);
}

[cmdk-list] {
  max-height: 300px;
  overflow: auto;
  padding: 0;
  transition: 100ms ease;
  transition-property: height;
}

[cmdk-list] [cmdk-empty] {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 64px;
  white-space: pre-wrap;
  color: var(--color-muted-foreground);
}

[cmdk-group] {
  padding: 0.5rem 0;
}

[cmdk-group]:not(:first-child) {
  border-top: 1px solid var(--color-border);
}

[cmdk-group-heading] {
  text-transform: uppercase;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--color-muted-foreground);
  padding: 0.5rem 1rem;
  margin-bottom: 0.25rem;
}

[cmdk-item] {
  cursor: pointer;
  height: 48px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0 1rem;
  color: var(--color-foreground);
  font-size: 0.875rem;
  position: relative;
  transition: all 100ms ease;
  transition-property: background-color, color;
}

[cmdk-item]:hover {
  background-color: var(--color-accent);
}

[cmdk-item][data-selected="true"] {
  background-color: var(--color-accent);
  color: var(--color-accent-foreground);
}

[cmdk-item][data-disabled="true"] {
  color: var(--color-muted-foreground);
  cursor: not-allowed;
  opacity: 0.5;
}

[cmdk-item] svg {
  width: 1rem;
  height: 1rem;
  flex-shrink: 0;
}

[cmdk-separator] {
  height: 1px;
  width: 100%;
  background: var(--color-border);
  margin: 0.25rem 0;
}

[cmdk-loading] {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 64px;
  color: var(--color-muted-foreground);
}
````

## File: packages/design/styles/globals.css
````css
@import "tailwindcss";
@import "./cmdk.css";

@custom-variant dark (&:is(.dark *));

@font-face {
  font-family: "IosevkaTerm-Regular";
  src: url("https://intdev-global.s3.us-west-2.amazonaws.com/public/internet-dev/6397be61-3ea4-459d-8a3e-fd95168cb214.woff2")
    format("woff2");
}

:root {
  --foreground-rgb: 0, 0, 0;
  --background-start-rgb: 255, 255, 255;
  --background-end-rgb: 255, 255, 255;
  --footer-height: 4rem; /* Defines footer height for consistent positioning */
  --background: #faf9f7; /* Warm paper-like off-white - oklch(0.98 0.005 85) */
  --foreground: oklch(0.2 0.01 85); /* Slightly warmer black */
  --card: oklch(1 0.005 85); /* Slightly lighter paper */
  --card-foreground: oklch(0.2 0.01 85);
  --popover: oklch(1 0.005 85);
  --popover-foreground: oklch(0.2 0.01 85);
  --primary: oklch(0.22 0.01 85);
  --primary-foreground: oklch(0.97 0.005 85);
  --secondary: oklch(0.94 0.01 85); /* Slightly darker secondary for accents */
  --secondary-foreground: oklch(0.22 0.01 85);
  --muted: oklch(0.94 0.01 85);
  --muted-foreground: oklch(0.5 0.01 85);
  --accent: oklch(0.9 0.02 85); /* Subtle accent color */
  --accent-foreground: oklch(0.22 0.01 85);
  --destructive: oklch(0.577 0.08 27.325); /* Muted red - less saturated */
  --destructive-foreground: oklch(0.97 0.005 85);
  --border: oklch(0.9 0.01 85); /* Subtle border color */
  --input: oklch(0.9 0.01 85);
  --ring: oklch(0.7 0.01 85);
  /* Subtle, coordinated chart colors in Rams style */
  --chart-1: oklch(0.646 0.09 41.116);
  --chart-2: oklch(0.6 0.06 184.704);
  --chart-3: oklch(0.55 0.05 227.392);
  --chart-4: oklch(0.7 0.08 84.429);
  --chart-5: oklch(0.75 0.07 70.08);
  --radius: 0.5rem; /* Slightly reduced radius for cleaner lines */
  --sidebar: var(--background); /* Slightly darker sidebar */
  --sidebar-foreground: oklch(0.2 0.01 85);
  --sidebar-primary: oklch(0.22 0.01 85);
  --sidebar-primary-foreground: oklch(0.97 0.005 85);
  --sidebar-accent: oklch(0.94 0.01 85);
  --sidebar-accent-foreground: oklch(0.22 0.01 85);
  --sidebar-border: oklch(0.9 0.01 85);
  --sidebar-ring: oklch(0.7 0.01 85);
  --title-font: "IosevkaTerm-Regular", monospace;

  /* Layout variables */
  --header-height: 72px;
  --column-header-height: 56px;
  --mobile-dock-height: 72px;
  --mobile-dock-spacing: 90px;
}

.dark {
  /* Dark Bauhaus-inspired palette with material quality */
  --background: #0a0a0a; /* Dark background - proper dark gray */
  --foreground: oklch(0.94 0.01 60); /* Slightly warm white text */
  --card: oklch(0.22 0.02 240); /* Slightly lighter than background */
  --card-foreground: oklch(0.94 0.01 60);
  --popover: oklch(0.22 0.02 240);
  --popover-foreground: oklch(0.94 0.01 60);
  --primary: oklch(0.9 0.01 60);
  --primary-foreground: oklch(0.2 0.02 240);
  --secondary: oklch(0.26 0.03 240); /* Slightly lighter secondary */
  --secondary-foreground: oklch(0.94 0.01 60);
  --muted: oklch(0.26 0.03 240);
  --muted-foreground: oklch(0.72 0.02 60);
  --accent: oklch(0.3 0.04 240); /* Subtle accent with material quality */
  --accent-foreground: oklch(0.94 0.01 60);
  --destructive: oklch(0.5 0.12 25); /* Muted red - like in Rams' FM radio buttons */
  --destructive-foreground: oklch(0.9 0.01 60);
  --border: oklch(0.28 0.02 240); /* Border with subtle coolness */
  --input: oklch(0.24 0.03 240);
  --ring: oklch(0.35 0.04 240);
  /* Coordinated chart colors inspired by Rams' selective color approach */
  --chart-1: oklch(0.5 0.12 30); /* Blood orange (FM radio reference) */
  --chart-2: oklch(0.6 0.1 80); /* Honey yellow (phono reference) */
  --chart-3: oklch(0.5 0.09 130); /* Leaf green (power button reference) */
  --chart-4: oklch(0.55 0.08 260); /* Blue-grey like the T52 variant */
  --chart-5: oklch(0.65 0.07 300); /* Subtle purple, complementary to system */
  --sidebar: var(--background); /* Darker sidebar with material quality */
  --sidebar-foreground: oklch(0.92 0.01 60);
  --sidebar-primary: oklch(0.5 0.12 30); /* Blood orange accent */
  --sidebar-primary-foreground: oklch(0.92 0.01 60);
  --sidebar-accent: oklch(0.26 0.03 240);
  --sidebar-accent-foreground: oklch(0.92 0.01 60);
  --sidebar-border: oklch(0.25 0.02 240);
  --sidebar-ring: oklch(0.35 0.04 240);
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
  --animate-accordion-down: accordion-down 0.2s ease-out;
  --animate-accordion-up: accordion-up 0.2s ease-out;

  @keyframes accordion-down {
    from {
      height: 0;
    }
    to {
      height: var(--radix-accordion-content-height);
    }
  }

  @keyframes accordion-up {
    from {
      height: var(--radix-accordion-content-height);
    }
    to {
      height: 0;
    }
  }
}

/* This layer is added by shadcn/ui */
@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }

  /* Ensure smooth theme transitions on mobile Chrome */
  html {
    transition: background-color 0.2s ease;
  }

  /* Prevent FOUC (Flash of Unstyled Content) on theme changes */
  html:not(.dark):not(.light) {
    background-color: #0a0a0a !important; /* Default to dark background during loading */
  }

  /* Ensure browser chrome matches theme immediately */
  html {
    background-color: var(--background) !important;
  }

  html.light {
    background-color: #faf9f7 !important; /* oklch(0.98 0.005 85) */
  }

  html.dark {
    background-color: #0a0a0a !important; /* Dark background */
  }

  /* Additional mobile-specific background enforcement */
  html.dark body,
  html.dark #__next,
  html.dark [data-radix-portal] {
    background-color: #0a0a0a !important;
  }

  html.light body,
  html.light #__next,
  html.light [data-radix-portal] {
    background-color: #faf9f7 !important;
  }

  /* Mobile-specific optimizations */
  @media (max-width: 768px) {
    /* Improve scrolling on mobile devices */
    * {
      -webkit-overflow-scrolling: touch;
    }

    /* Ensure no body scrolling on mobile */
    body:not(.allow-scroll),
    html:not(.allow-scroll) {
      overflow: hidden;
      overscroll-behavior: none;
      height: 100vh;
      height: 100dvh;
    }

    /* Ensure theme switcher doesn't interfere with mobile navigation */
    .fixed {
      transform: translateZ(0); /* Force hardware acceleration */
    }

    /* Better touch targets for mobile */
    button,
    [role="button"],
    input,
    select,
    textarea {
      touch-action: manipulation;
    }

    /* Force background color on mobile Safari */
    html,
    body {
      min-height: 100vh;
      min-height: 100dvh;
    }

    html.dark,
    html.dark body,
    html.dark main,
    html.dark div[data-wrapper] {
      background-color: #0a0a0a !important;
    }

    html.light,
    html.light body,
    html.light main,
    html.light div[data-wrapper] {
      background-color: #faf9f7 !important;
    }
  }
}

/* This layer is by next-forge */
@layer base {
  ::after,
  ::before,
  ::backdrop,
  ::file-selector-button {
    @apply border-border;
  }
  * {
    @apply min-w-0;
  }
  html {
    text-rendering: optimizelegibility;
  }
  body {
    @apply min-h-[100dvh];
  }
  input::placeholder,
  textarea::placeholder {
    @apply text-muted-foreground;
  }
  button:not(:disabled),
  [role="button"]:not(:disabled) {
    @apply cursor-pointer;
  }
}

/* Typography plugin */
@utility prose {
  --tw-prose-body: var(--color-foreground);
  --tw-prose-headings: var(--color-foreground);
  --tw-prose-lead: var(--color-muted-foreground);
  --tw-prose-links: var(--color-primary);
  --tw-prose-bold: var(--color-foreground);
  --tw-prose-counters: var(--color-foreground);
  --tw-prose-bullets: var(--color-muted-foreground);
  --tw-prose-hr: var(--color-muted-foreground);
  --tw-prose-quotes: var(--color-muted-foreground);
  --tw-prose-quote-borders: var(--color-border);
  --tw-prose-captions: var(--color-muted-foreground);
  --tw-prose-code: var(--color-foreground);
  --tw-prose-pre-code: var(--color-foreground);
  --tw-prose-pre-bg: var(--color-background);
  --tw-prose-th-borders: var(--color-border);
  --tw-prose-td-borders: var(--color-border);
  --tw-prose-invert-body: var(--color-foreground);
  --tw-prose-invert-headings: var(--color-foreground);
  --tw-prose-invert-lead: var(--color-muted-foreground);
  --tw-prose-invert-links: var(--color-primary);
  --tw-prose-invert-bold: var(--color-foreground);
  --tw-prose-invert-counters: var(--color-foreground);
  --tw-prose-invert-bullets: var(--color-foreground);
  --tw-prose-invert-hr: var(--color-muted-foreground);
  --tw-prose-invert-quotes: var(--color-muted-foreground);
  --tw-prose-invert-quote-borders: var(--color-border);
  --tw-prose-invert-captions: var(--color-muted-foreground);
  --tw-prose-invert-code: var(--color-foreground);
  --tw-prose-invert-pre-code: var(--color-foreground);
  --tw-prose-invert-pre-bg: var(--color-background);
  --tw-prose-invert-th-borders: var(--color-border);
  --tw-prose-invert-td-borders: var(--color-border);
}

html,
body {
  height: 100vh;
  width: 100vw;
  margin: 0;
  padding: 0;
}

/* Prevent scrolling on main app pages but allow it on unauthenticated pages */
body:not(.allow-scroll) {
  overflow: hidden;
  overscroll-behavior: none;
}

/* Ensure html also prevents scrolling */
html:not(.allow-scroll) {
  overflow: hidden;
  overscroll-behavior: none;
}

body {
  color: rgb(var(--foreground-rgb));
  background: var(--background);
  font-family: "IosevkaTerm-Regular", monospace, "Apple Color Emoji",
    "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Add utility classes for fonts */
.font-title {
  font-family: var(--title-font);
  letter-spacing: 0.01em;
  font-weight: 400;
}

/* Hide scrollbar utility classes */
.hide-scrollbar {
  /* Hide scrollbar for Chrome, Safari and Opera */
  &::-webkit-scrollbar {
    display: none;
  }

  /* Hide scrollbar for Firefox */
  scrollbar-width: none;

  /* Hide scrollbar for IE and Edge */
  -ms-overflow-style: none;
}

@layer components {
  .font-highway {
    font-family: var(--title-font);
    letter-spacing: 0.01em;
  }
}
````

## File: packages/design/styles/index.css
````css
/* Main design system styles entry point */
@import "./globals.css";
````

## File: packages/design/styles/tailwind.css
````css
@import "tailwindcss/preflight" layer(base);
@import "tailwindcss/utilities" layer(utilities);

@theme {
  /* Animation keyframes */
  --animate-float: float 6s ease-in-out infinite;
  --animate-border-pulse: borderPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  --animate-bounce-in: bounceIn 0.3s ease-out;
  --animate-blur-fade: blurFade 0.8s ease-in-out;
  --animate-card-press: cardPress 100ms ease-in-out forwards;
  --animate-fade-in: fadeIn 0.2s ease-in-out;
  --animate-fade-in-up: fadeInUp 0.3s ease-out;
  --animate-fade-in-down: fadeInDown 0.3s ease-out;
  --animate-fade-out-down: fadeOutDown 0.3s ease-out;
  --animate-fade-in-scale: fadeInScale 0.3s ease-in-out;
  --animate-fade-out: fadeOut 0.2s ease-in-out;
  --animate-glow-pulse: glowPulse 2s ease-in-out infinite;
  --animate-gradient-flow: gradientFlow 3s ease infinite;
  --animate-glass-menu-in: glassMenuIn 0.3s cubic-bezier(0.32, 0.72, 0, 1)
    forwards;
  --animate-glass-menu-out: glassMenuOut 0.3s cubic-bezier(0.32, 0.72, 0, 1)
    forwards;
  --animate-emoji-float: emojiFloat 30s ease-in-out infinite;
  --animate-emoji-wobble: emojiWobble 12s linear infinite;
  --animate-menu-in: menuIn 0.2s ease-out;
  --animate-menu-out: menuOut 0.2s ease-in;
  --animate-mist-flow-1: mistFlow1 4s ease-in-out infinite;
  --animate-mist-flow-2: mistFlow2 6s ease-in-out infinite;
  --animate-modal-in: modalIn 0.3s cubic-bezier(0.19, 1, 0.22, 1);
  --animate-modal-out: modalOut 0.2s cubic-bezier(0.19, 1, 0.22, 1);
  --animate-shimmer: shimmer 5s infinite linear;
  --animate-scale-down: scaleDown 0.2s ease-out forwards;
  --animate-scale-hover: scaleHover 0.2s ease-out forwards;
  --animate-scale-up: scaleUp 0.2s ease-out forwards;
  --animate-shake: shake 0.3s ease-in-out;
  --animate-slide-in-down: slideInDown 0.3s cubic-bezier(0.32, 0.72, 0, 1)
    forwards;
  --animate-slide-in-left: slideInLeft 0.2s ease-in-out;
  --animate-slide-in-right: slideInRight 0.2s ease-in-out;
  --animate-slide-in-up: slideInUp 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
  --animate-slide-out-left: slideOutLeft 0.2s ease-in-out;
  --animate-slide-out-right: slideOutRight 0.2s ease-in-out;
  --animate-slide-out-up: slideOutUp 0.3s cubic-bezier(0.32, 0.72, 0, 1)
    forwards;
  --animate-spin: spin 1s linear infinite;
  --animate-toast-enter: toastEnter 400ms cubic-bezier(0.32, 0.72, 0, 1)
    forwards;
  --animate-toast-exit: toastExit 400ms cubic-bezier(0.32, 0.72, 0, 1) forwards;
  --animate-fade-in-out: fadeInOut 0.4s ease-in-out;
  --animate-interest-pill-in: interestPillIn 0.6s
    cubic-bezier(0.34, 1.56, 0.64, 1);
  --animate-marquee: marquee 15s linear infinite;
  --animate-scroll: scroll 15s linear infinite;
  --animate-spin-slow: mistSpin1 3s linear infinite;
  --animate-spin-slower: mistSpin2 4s linear infinite;
  --animate-spin-slowest: mistSpin3 5s linear infinite;
  --animate-spin-reverse-slower: mistSpin2 4s linear infinite reverse;
  --animate-pulse-slow: mistPulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  --animate-in: in 0.2s ease-out;
  --animate-in-reverse: in 0.2s ease-out reverse;
  --animate-out: out 0.2s ease-in;
  --animate-out-reverse: out 0.2s ease-in reverse;

  /* Colors */
  --color-background: var(--background);
  --color-foreground: var(--foreground);

  /* Font family */
  --font-mono: ServerMono, monospace;

  /* Timing functions */
  --ease-custom: cubic-bezier(0.32, 0, 0.67, 0);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --ease-theme: cubic-bezier(0.32, 0.72, 0, 1);

  /* Durations */
  --duration-theme: 400ms;
}

/* Keyframes */
@keyframes float {
  0%,
  100% {
    transform: translate(0, 0);
  }
  25% {
    transform: translate(10px, 10px);
  }
  50% {
    transform: translate(-5px, 15px);
  }
  75% {
    transform: translate(-15px, -5px);
  }
}

@keyframes interestPillIn {
  0% {
    opacity: 0;
    transform: scale(0.7) translateY(20px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes glowPulse {
  0%,
  100% {
    opacity: 0.3;
  }
  50% {
    opacity: 0.6;
  }
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(5px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInDown {
  0% {
    opacity: 0;
    transform: translateY(-5px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes marquee {
  0% {
    transform: translateX(0);
  }
  100% {
    transform: translateX(-50%);
  }
}

@keyframes slideOutUp {
  0% {
    transform: translate(-50%, 0);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -100%);
    opacity: 0;
  }
}

@keyframes scroll {
  0% {
    transform: translateX(0);
  }
  100% {
    transform: translateX(-50%);
  }
}

@keyframes slideInDown {
  0% {
    transform: translateY(-100%);
  }
  100% {
    transform: translateY(0);
  }
}

@keyframes slideInUp {
  0% {
    transform: translateY(100%);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes in {
  0% {
    opacity: 0;
    transform: translateY(-4px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes out {
  0% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(4px);
  }
}

@keyframes bounceIn {
  0% {
    transform: scale(0.3);
    opacity: 0;
  }
  50% {
    transform: scale(1.05);
    opacity: 0.8;
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes shake {
  0%,
  100% {
    transform: translateX(0);
  }
  25% {
    transform: translateX(-4px);
  }
  50% {
    transform: translateX(4px);
  }
  75% {
    transform: translateX(-4px);
  }
}

@keyframes fadeOutDown {
  0% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(4px);
  }
}

@keyframes gradientFlow {
  0%,
  100% {
    background-position: 0% 50%;
    filter: saturate(120%) brightness(110%);
  }
  50% {
    background-position: 400% 50%;
    filter: saturate(150%) brightness(120%);
  }
}

@keyframes borderPulse {
  0%,
  100% {
    transform: scale(1.02);
    filter: saturate(100%) brightness(100%);
    opacity: 0.5;
  }
  50% {
    transform: scale(1.05);
    filter: saturate(150%) brightness(120%);
    opacity: 0.7;
  }
}

@keyframes fadeInScale {
  0% {
    transform: scale(0.9);
    opacity: 0;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes shimmer {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

@keyframes fadeOut {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}

@keyframes cardPress {
  0% {
    transform: scale(1);
  }
  100% {
    transform: scale(0.98);
  }
}

@keyframes blurFade {
  0% {
    opacity: 0;
    filter: blur(4px);
  }
  100% {
    opacity: 1;
    filter: blur(0);
  }
}

@keyframes emojiFloat {
  0%,
  100% {
    transform: translate(0, 0) rotate(0deg);
  }
  25% {
    transform: translate(20px, -30px) rotate(5deg);
  }
  50% {
    transform: translate(-10px, -50px) rotate(-5deg);
  }
  75% {
    transform: translate(-30px, -20px) rotate(3deg);
  }
}

@keyframes emojiWobble {
  0%,
  100% {
    transform: rotate(-5deg);
  }
  50% {
    transform: rotate(5deg);
  }
}

@keyframes menuIn {
  0% {
    opacity: 0;
    transform: scale(0.95);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes menuOut {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(0.95);
  }
}

@keyframes mistFlow1 {
  0%,
  100% {
    transform: translate(0, 0) scale(1);
    opacity: 0.3;
  }
  50% {
    transform: translate(30px, -20px) scale(1.1);
    opacity: 0.5;
  }
}

@keyframes mistFlow2 {
  0%,
  100% {
    transform: translate(0, 0) scale(1);
    opacity: 0.2;
  }
  50% {
    transform: translate(-40px, 30px) scale(1.2);
    opacity: 0.4;
  }
}

@keyframes modalIn {
  0% {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  50% {
    transform: scale(1.02) translateY(-5px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes modalOut {
  0% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
  100% {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
}

@keyframes scaleDown {
  0% {
    transform: scale(1);
  }
  100% {
    transform: scale(0.95);
  }
}

@keyframes scaleHover {
  0% {
    transform: scale(1);
  }
  100% {
    transform: scale(1.05);
  }
}

@keyframes scaleUp {
  0% {
    transform: scale(1);
  }
  100% {
    transform: scale(1.05);
  }
}

@keyframes slideInLeft {
  0% {
    transform: translateX(-100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideInRight {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutLeft {
  0% {
    transform: translateX(0);
    opacity: 1;
  }
  100% {
    transform: translateX(-100%);
    opacity: 0;
  }
}

@keyframes slideOutRight {
  0% {
    transform: translateX(0);
    opacity: 1;
  }
  100% {
    transform: translateX(100%);
    opacity: 0;
  }
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes toastEnter {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes toastExit {
  0% {
    transform: translateX(0);
    opacity: 1;
  }
  100% {
    transform: translateX(100%);
    opacity: 0;
  }
}

@keyframes fadeInOut {
  0%,
  100% {
    opacity: 0;
  }
  50% {
    opacity: 1;
  }
}

@keyframes glassMenuIn {
  0% {
    opacity: 0;
    transform: scale(0.95) translateY(-10px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes glassMenuOut {
  0% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
  100% {
    opacity: 0;
    transform: scale(0.95) translateY(-10px);
  }
}

@keyframes mistSpin1 {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes mistSpin2 {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes mistSpin3 {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes mistPulse {
  0%,
  100% {
    opacity: 0.3;
    transform: scale(1);
  }
  50% {
    opacity: 0.6;
    transform: scale(1.1);
  }
}
````

## File: packages/design/CLAUDE.md
````markdown
# @repo/design Package Context

## Development Standards

### Package Context
This package provides the design system and UI components for the Squish ecosystem. It includes shadcn/ui components, custom components, theme management, and design tokens built with Tailwind CSS v4.

### Technology Stack
- **shadcn/ui**: Latest - Component library foundation
- **Tailwind CSS**: v4.1.11 - Utility-first CSS framework
- **React**: 19+ compatibility
- **TypeScript**: 5.7+ strict configuration

### Key Dependencies
```json
{
  "dependencies": {
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-dialog": "^1.1.2",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "tailwind-merge": "^2.5.4",
    "react": "^19.1.0"
  }
}
```

## Package Structure
```
src/
‚îú‚îÄ‚îÄ components/           # UI Components
‚îÇ   ‚îú‚îÄ‚îÄ ui/              # Base shadcn/ui components
‚îÇ   ‚îú‚îÄ‚îÄ common/          # Shared app components
‚îÇ   ‚îî‚îÄ‚îÄ modules/         # Feature-specific components
‚îú‚îÄ‚îÄ hooks/               # Custom React hooks
‚îú‚îÄ‚îÄ lib/                 # Utility libraries
‚îî‚îÄ‚îÄ styles/              # Style definitions
```

## Component Patterns
- Use shadcn/ui as base
- Follow consistent naming
- Implement with accessibility
- Support theme variants
- Export clean interfaces

## Files to Know
- `src/components/ui/index.ts` - UI component exports
- `src/lib/utils.ts` - Core utility functions
- `src/styles/theme.css` - Theme configuration

## Quality Checklist
- [ ] Components accessible
- [ ] Responsive design
- [ ] Theme variants work
- [ ] TypeScript complete
- [ ] No hardcoded styles

---
EOF < /dev/null
````

## File: packages/design/components.json
````json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "styles/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  }
}
````

## File: packages/design/index.tsx
````typescript
import type { ThemeProviderProps } from 'next-themes';

import { AuthProvider } from '@repo/auth/provider';
import { Toaster } from './components/ui/sonner';
import { TooltipProvider } from './components/ui/tooltip';
import { ThemeProvider } from './providers/theme';

type DesignSystemProviderProperties = ThemeProviderProps;

export const DesignSystemProvider = ({
  children,
  ...properties
}: DesignSystemProviderProperties) => {
  return (
    <ThemeProvider {...properties}>
      <AuthProvider
        publishableKey={process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      >
        <TooltipProvider>{children}</TooltipProvider>
        <Toaster />
      </AuthProvider>
    </ThemeProvider>
  );
};

// Export all components
export * from './components';

// Export hooks that are needed by components
export { useStreamingText } from './hooks/use-streaming-text';
export type { UseStreamingTextOptions } from './hooks/use-streaming-text';

// Export utilities that might be needed
export { useIsIOSSafari, safariGPUAcceleration } from './lib/safari-utils';
export { cn } from './lib/utils';
export * from './lib/colors';
````

## File: packages/design/package.json
````json
{
  "name": "@repo/design",
  "version": "0.0.1",
  "private": true,
  "main": "./index.tsx",
  "exports": {
    ".": {
      "import": "./index.tsx",
      "require": "./index.tsx"
    },
    "./components/ui": "./components/ui/index.ts",
    "./lib/utils": "./lib/utils.ts",
    "./styles/globals.css": "./styles/globals.css",
    "./styles/tailwind.css": "./styles/tailwind.css",
    "./styles": "./styles/index.css",
    "./postcss.config.mjs": "./postcss.config.mjs"
  },
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  },
  "types": "./index.tsx",
  "dependencies": {
    "@hookform/resolvers": "^5.0.1",
    "@phosphor-icons/react": "^2.1.7",
    "@radix-ui/react-accordion": "^1.2.8",
    "@radix-ui/react-alert-dialog": "^1.1.11",
    "@radix-ui/react-aspect-ratio": "^1.1.4",
    "@radix-ui/react-avatar": "^1.1.7",
    "@radix-ui/react-checkbox": "^1.2.3",
    "@radix-ui/react-collapsible": "^1.1.8",
    "@radix-ui/react-context-menu": "^2.2.12",
    "@radix-ui/react-dialog": "^1.1.11",
    "@radix-ui/react-dropdown-menu": "^2.1.12",
    "@radix-ui/react-hover-card": "^1.1.11",
    "@radix-ui/react-icons": "^1.3.2",
    "@radix-ui/react-label": "^2.1.4",
    "@radix-ui/react-menubar": "^1.1.12",
    "@radix-ui/react-navigation-menu": "^1.2.10",
    "@radix-ui/react-popover": "^1.1.11",
    "@radix-ui/react-progress": "^1.1.4",
    "@radix-ui/react-radio-group": "^1.3.4",
    "@radix-ui/react-scroll-area": "^1.2.6",
    "@radix-ui/react-select": "^2.2.2",
    "@radix-ui/react-separator": "^1.1.4",
    "@radix-ui/react-slider": "^1.3.2",
    "@radix-ui/react-slot": "^1.2.0",
    "@radix-ui/react-switch": "^1.2.2",
    "@radix-ui/react-tabs": "^1.1.9",
    "@radix-ui/react-toast": "^1.2.11",
    "@radix-ui/react-toggle": "^1.1.6",
    "@radix-ui/react-toggle-group": "^1.1.7",
    "@radix-ui/react-tooltip": "^1.2.4",
    "@types/uuid": "^10.0.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "embla-carousel-react": "^8.6.0",
    "framer-motion": "^12.12.2",
    "geist": "^1.3.1",
    "input-otp": "^1.4.2",
    "jotai": "^2.12.3",
    "lucide-react": "^0.503.0",
    "markdown-to-jsx": "^7.7.8",
    "next-themes": "^0.4.6",
    "react": "19.1.0",
    "react-day-picker": "^8.10.1",
    "react-dom": "19.1.0",
    "react-hook-form": "^7.56.1",
    "react-moveable": "^0.56.0",
    "react-resizable-panels": "^2.1.9",
    "recharts": "^2.15.3",
    "sonner": "^2.0.3",
    "tailwind-merge": "^3.2.0",
    "uuid": "^11.1.0",
    "vaul": "^1.1.2",
    "zod": "^3.24.3",
    "@repo/auth": "workspace:*"
  },
  "peerDependencies": {
    "react": "^18.2.0 || ^19.0.0",
    "react-dom": "^18.2.0 || ^19.0.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.4",
    "@tailwindcss/typography": "^0.5.16",
    "@types/node": "^22.15.3",
    "@types/react": "^19.1.2",
    "postcss": "^8.5.3",
    "tailwindcss": "^4.1.4",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5.8.3",
    "@repo/typescript-config": "workspace:*"
  }
}
````

## File: packages/design/postcss.config.mjs
````
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    '@tailwindcss/postcss': {},
  },
};

export default config;
````

## File: packages/design/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "baseUrl": ".",
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@repo/*": ["../*"],
      "@repo/design/*": ["./*"]
    }
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
````

## File: packages/email/templates/contact.tsx
````typescript
import {
  Body,
  Container,
  Head,
  Hr,
  Html,
  Preview,
  Section,
  Tailwind,
  Text,
} from '@react-email/components';

type ContactTemplateProps = {
  readonly name: string;
  readonly email: string;
  readonly message: string;
};

export const ContactTemplate = ({
  name,
  email,
  message,
}: ContactTemplateProps) => (
  <Tailwind>
    <Html>
      <Head />
      <Preview>New email from {name}</Preview>
      <Body className="bg-zinc-50 font-sans">
        <Container className="mx-auto py-12">
          <Section className="mt-8 rounded-md bg-zinc-200 p-px">
            <Section className="rounded-[5px] bg-white p-8">
              <Text className="mt-0 mb-4 font-semibold text-2xl text-zinc-950">
                New email from {name}
              </Text>
              <Text className="m-0 text-zinc-500">
                {name} ({email}) has sent you a message:
              </Text>
              <Hr className="my-4" />
              <Text className="m-0 text-zinc-500">{message}</Text>
            </Section>
          </Section>
        </Container>
      </Body>
    </Html>
  </Tailwind>
);
````

## File: packages/email/templates/invite.tsx
````typescript
import {
  Body,
  Container,
  Head,
  Html,
  Preview,
  Section,
  Tailwind,
  Text,
} from '@react-email/components';

type InviteTemplateProps = {
  readonly inviterUsername: string;
  readonly message?: string;
};

export const InviteTemplate = ({
  inviterUsername,
  message,
}: InviteTemplateProps) => (
  <Tailwind>
    <Html>
      <Head />
      <Preview>{inviterUsername} invited you to join Squish!</Preview>
      <Body className="bg-white font-sans">
        <Container className="mx-auto py-20">
          <Section className="text-center">
            {/* Logo */}
            <span className="text-[96px]">üêô</span>

            {/* Title */}
            <Text className="mb-7 font-semibold text-2xl text-slate-900">
              @{inviterUsername} invited you to join Squish!
            </Text>

            {/* Optional Message */}
            {message && (
              <Text className="text-slate-500 italic">"{message}"</Text>
            )}

            {/* Join Button */}
            <Section className="mt-7">
              <a
                href="https://squish.app/join"
                className="inline-block rounded-lg bg-slate-100 px-6 py-3 font-medium text-slate-600 no-underline"
              >
                Join now!
              </a>
            </Section>

            {/* Terms and Privacy */}
            <Text className="mt-8 text-center text-slate-500 text-xs">
              By joining, you agree to our{' '}
              <a href="https://squish.app/terms" className="text-[#3291FF]">
                Terms
              </a>{' '}
              and have read our{' '}
              <a href="https://squish.app/privacy" className="text-[#3291FF]">
                Privacy Policy
              </a>
              .
            </Text>
          </Section>
        </Container>
      </Body>
    </Html>
  </Tailwind>
);
````

## File: packages/email/CLAUDE.md
````markdown
# @repo/email Package Context

## Development Standards

### Package Context
This package provides email templates and utilities for the Squish ecosystem. Built with React Email, it offers reusable email components, transactional email templates, and email sending utilities.

### Technology Stack
- **React Email**: Latest - Email template builder
- **Resend**: 4.0.1 - Email delivery API
- **Tailwind CSS**: Email styling support
- **TypeScript**: 5.7+ strict configuration

### Key Dependencies
```json
{
  "dependencies": {
    "@react-email/components": "^0.0.26",
    "@react-email/render": "^1.0.2",
    "@react-email/tailwind": "^0.0.19",
    "resend": "^4.0.1"
  }
}
```

## Package Structure
```
src/
‚îú‚îÄ‚îÄ emails/              # Email templates
‚îÇ   ‚îú‚îÄ‚îÄ welcome/        # Welcome emails
‚îÇ   ‚îú‚îÄ‚îÄ notifications/   # Notification emails
‚îÇ   ‚îî‚îÄ‚îÄ auth/           # Authentication emails
‚îú‚îÄ‚îÄ components/          # Reusable email components
‚îú‚îÄ‚îÄ layouts/            # Email layouts
‚îî‚îÄ‚îÄ lib/                # Email utilities
```

## Email Template Patterns
- Use React Email components
- Support mobile responsive design
- Implement fallback styles
- Use semantic HTML
- Test across email clients

## Files to Know
- `src/emails/layouts/BaseLayout.tsx` - Base email layout
- `src/lib/email-client.ts` - Email sending client

## Quality Checklist
- [ ] Mobile responsive
- [ ] Client compatibility
- [ ] No inline styles
- [ ] Accessibility compliant
- [ ] Test with sample data

---
EOF < /dev/null
````

## File: packages/email/index.ts
````typescript
import { Resend } from 'resend';
import { keys } from './keys';

export const resend = new Resend(keys().RESEND_TOKEN);

// Export email templates
export { InviteTemplate } from './templates/invite';
export { ContactTemplate } from './templates/contact';
````

## File: packages/email/keys.ts
````typescript
import { createEnv } from '@t3-oss/env-nextjs';
import { z } from 'zod';

export const keys = () =>
  createEnv({
    server: {
      RESEND_FROM: z.string().min(1).email(),
      RESEND_TOKEN: z.string().min(1).startsWith('re_'),
    },
    runtimeEnv: {
      RESEND_FROM: process.env.RESEND_FROM,
      RESEND_TOKEN: process.env.RESEND_TOKEN,
    },
  });
````

## File: packages/email/package.json
````json
{
  "name": "@repo/email",
  "private": true,
  "version": "0.0.0",
  "main": "./index.ts",
  "types": "./index.ts",
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  },
  "dependencies": {
    "@react-email/components": "^0.0.32",
    "@t3-oss/env-nextjs": "^0.11.1",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "resend": "^4.0.1",
    "zod": "^3.24.1"
  },
  "devDependencies": {
    "@types/node": "22.10.5",
    "@types/react": "^19.0.6",
    "@types/react-dom": "^19.0.3",
    "typescript": "^5.7.3",
    "@repo/typescript-config": "workspace:*"
  }
}
````

## File: packages/email/tsconfig.json
````json
{
  "extends": "@squish-xyz/typescript-config/react-library.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"],
      "@squish-xyz/*": ["../../packages/*"]
    },
    "types": ["node"],
    "typeRoots": ["./node_modules/@types", "../../node_modules/@types"]
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
````

## File: packages/orpc/adapters/hono.ts
````typescript
import { RPCHandler } from '@orpc/server/fetch';
import type { AppRouter } from '../router';

export function createORPCHonoHandler(router: AppRouter) {
  // Use RPCHandler for Hono compatibility
  return new RPCHandler(router);
}

// Body parser proxy to prevent "Body Already Used" error
export const BODY_PARSER_METHODS = new Set([
  'arrayBuffer',
  'blob',
  'formData',
  'json',
  'text',
] as const);
export type BodyParserMethod = typeof BODY_PARSER_METHODS extends Set<infer T>
  ? T
  : never;

export function createBodyParserProxy(request: Request, context: any) {
  return new Proxy(request, {
    get(target, prop) {
      if (BODY_PARSER_METHODS.has(prop as BodyParserMethod)) {
        return () => context.req[prop as BodyParserMethod]();
      }
      return Reflect.get(target, prop, target);
    },
  });
}
````

## File: packages/orpc/adapters/next.ts
````typescript
import { appRouter } from '../router';

// Direct exports of router procedures - following Arbor pattern
// The procedures already have .actionable() called in the router definition

// Board server actions
export const createBoardAction = appRouter.board.create;
export const updateBoardAction = appRouter.board.update;
export const deleteBoardAction = appRouter.board.delete;
export const addBoardCollaboratorAction = appRouter.board.addCollaborator;
export const removeBoardCollaboratorAction = appRouter.board.removeCollaborator;
export const addAssetToBoardAction = appRouter.board.addAssetToBoard;
export const removeAssetFromBoardAction = appRouter.board.removeAssetFromBoard;

// Asset server actions
export const createAssetAction = appRouter.asset.create;
export const updateAssetAction = appRouter.asset.update;
export const deleteAssetAction = appRouter.asset.delete;
export const likeAssetAction = appRouter.asset.like;
export const trackAssetViewAction = appRouter.asset.trackView;
export const trackAssetUseAction = appRouter.asset.trackUse;

// User server actions
export const updateUserAction = appRouter.user.update;
export const deleteUserAction = appRouter.user.delete;
````

## File: packages/orpc/adapters/openapi.ts
````typescript
import { OpenAPIGenerator } from '@orpc/openapi';
import { ZodToJsonSchemaConverter } from '@orpc/zod';
import type { AppRouter } from '../router';

export async function getOpenAPIDocument(router: AppRouter) {
  const generator = new OpenAPIGenerator({
    schemaConverters: [new ZodToJsonSchemaConverter()],
  });

  return generator.generate(router, {
    info: {
      title: 'Squish API',
      version: '1.0.0',
      description:
        'API for Squish - collaborative workspace with AI-enhanced search',
    },
    servers: [
      {
        url: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8787',
        description:
          process.env.NODE_ENV === 'production'
            ? 'Production server'
            : 'Development server',
      },
    ],
  });
}
````

## File: packages/orpc/hooks/swr.ts
````typescript
/// <reference path="../types/swr-shim.d.ts" />
// Mark as client-only to avoid server compilation requiring 'swr' types in non-app packages
// During build, consumers are expected to transpile this file within Next.js app context
// eslint-disable-next-line @typescript-eslint/consistent-type-imports
import useSWR, { type SWRConfiguration, mutate } from 'swr';
import type { AppRouter } from '../router';

// Type helpers for router paths
type RouterPaths<T> = {
  [K in keyof T]: T[K] extends { input: any; output: any }
    ? K extends string
      ? K
      : never
    : T[K] extends object
      ? K extends string
        ? `${K}.${RouterPaths<T[K]>}` | K
        : never
      : never;
}[keyof T];

type RouterInput<T, P extends string> = P extends `${infer First}.${infer Rest}`
  ? First extends keyof T
    ? T[First] extends object
      ? RouterInput<T[First], Rest>
      : never
    : never
  : P extends keyof T
    ? T[P] extends { input: infer I }
      ? I
      : never
    : never;

type RouterOutput<
  T,
  P extends string,
> = P extends `${infer First}.${infer Rest}`
  ? First extends keyof T
    ? T[First] extends object
      ? RouterOutput<T[First], Rest>
      : never
    : never
  : P extends keyof T
    ? T[P] extends { output: infer O }
      ? O
      : never
    : never;

// Custom hook for ORPC queries with SWR
export function useORPCQuery<
  TPath extends RouterPaths<AppRouter>,
  TData = RouterOutput<AppRouter, TPath>,
>(
  path: TPath,
  input: RouterInput<AppRouter, TPath>,
  config?: SWRConfiguration<TData, Error> & {
    enabled?: boolean;
  }
) {
  const key = config?.enabled !== false ? [path, input] : null;

  const swr: any = useSWR;
  return swr(
    key,
    async (_tuple: [string, any]) => {
      // This will be replaced with actual client call in the provider
      throw new Error('useORPCQuery must be used within ORPCProvider');
    },
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: false,
      ...(config as any),
    }
  );
}

// Custom hook for ORPC mutations
export function useORPCMutation<
  TPath extends RouterPaths<AppRouter>,
  TData = RouterOutput<AppRouter, TPath>,
  TInput = RouterInput<AppRouter, TPath>,
>(_path: TPath) {
  const mutateAsync = async (_input: TInput): Promise<TData> => {
    // This will be replaced with actual client call in the provider
    throw new Error('useORPCMutation must be used within ORPCProvider');
  };

  const invalidate = (keys?: string[]) => {
    if (keys) {
      keys.forEach((key) => mutate(key));
    } else {
      // Invalidate all SWR cache
      mutate(() => true);
    }
  };

  return {
    mutateAsync,
    invalidate,
  };
}

// Factory function to create ORPC hooks with client
export function createORPCHooks(client: any): {
  useQuery: <TPath extends RouterPaths<AppRouter>>(
    path: TPath,
    input: RouterInput<AppRouter, TPath>,
    config?: SWRConfiguration & { enabled?: boolean }
  ) => ReturnType<typeof useSWR>;
  useMutation: <TPath extends RouterPaths<AppRouter>>(
    path: TPath
  ) => {
    mutateAsync: (input: RouterInput<AppRouter, TPath>) => Promise<any>;
    invalidate: (keys?: string[]) => void;
  };
} {
  return {
    useQuery: <TPath extends RouterPaths<AppRouter>>(
      path: TPath,
      input: RouterInput<AppRouter, TPath>,
      config?: SWRConfiguration & { enabled?: boolean }
    ) => {
      const key = config?.enabled !== false ? [path, input] : null;

      const swr: any = useSWR;
      return swr(
        key,
        async ([path, input]: [string, any]) => {
          const segments = path.split('.');
          let procedure: any = client;

          for (const segment of segments) {
            procedure = procedure?.[segment];
          }

          if (!procedure || typeof procedure !== 'function') {
            throw new Error(`Procedure not found: ${path}`);
          }

          return procedure(input);
        },
        {
          revalidateOnFocus: false,
          revalidateOnReconnect: false,
          ...(config as any),
        }
      );
    },

    useMutation: <TPath extends RouterPaths<AppRouter>>(path: TPath) => {
      const mutateAsync = async (input: RouterInput<AppRouter, TPath>) => {
        const segments = path.split('.');
        let procedure: any = client;

        for (const segment of segments) {
          procedure = procedure?.[segment];
        }

        if (!procedure || typeof procedure !== 'function') {
          throw new Error(`Procedure not found: ${path}`);
        }

        return procedure(input);
      };

      const invalidate = (keys?: string[]) => {
        if (keys) {
          keys.forEach((key) => mutate(key));
        } else {
          mutate(() => true);
        }
      };

      return {
        mutateAsync,
        invalidate,
      };
    },
  };
}
````

## File: packages/orpc/actions.ts
````typescript
// @deprecated - Server actions moved to apps/app/src/lib/actions.ts
// This file is deprecated and should not be used

// Stub exports to prevent build errors during migration
export {};
````

## File: packages/orpc/ai-router.ts
````typescript
import { os, ORPCError } from '@orpc/server';
import { z } from 'zod';
import type { AuthenticatedContext, Context } from './context';

/**
 * AI-optimized ORPC router
 * Provides optimized endpoints for AI service operations
 * with batch support, caching hints, and reduced payloads
 */

// Protected procedure with auth for AI service
const aiProtectedProcedure = os
  .$context<Context>()
  .use(async ({ context, next }) => {
    // Allow service-to-service auth or user auth
    const isServiceAuth = context.headers?.get('x-service-token') === process.env.AI_SERVICE_TOKEN;
    const hasUserAuth = !!context.user?.userId;
    
    if (!isServiceAuth && !hasUserAuth) {
      throw new ORPCError('UNAUTHORIZED', {
        message: 'Authentication required',
      });
    }
    
    return next({
      context: {
        ...context,
        isAIService: isServiceAuth,
      } as AuthenticatedContext & { isAIService: boolean },
    });
  });

// Batch operations router
export const aiBatchRouter = os.$context<Context>().router({
  // Batch fetch boards with minimal data
  getBoards: aiProtectedProcedure
    .input(
      z.object({
        boardIds: z.array(z.string()).max(50),
        fields: z.array(z.enum([
          'id', 'name', 'description', 'icon', 'visibility', 
          'assetCount', 'ownerId', 'createdAt', 'updatedAt'
        ])).optional(),
      })
    )
    .handler(async ({ input }) => {
      // Optimized batch fetch with field selection
      const boards = await Promise.all(
        input.boardIds.map(async (id) => {
          // In production, this would use a single batch query
          const board = await boardService.getBoardById(id);
          
          // Return only requested fields for efficiency
          if (input.fields) {
            return Object.fromEntries(
              input.fields.map(field => [field, board[field]])
            );
          }
          return board;
        })
      );
      
      return { boards };
    }),

  // Batch fetch assets with minimal data
  getAssets: aiProtectedProcedure
    .input(
      z.object({
        assetIds: z.array(z.string()).max(100),
        includeMetadata: z.boolean().default(false),
        includeThumbnails: z.boolean().default(true),
      })
    )
    .handler(async ({ input }) => {
      const assets = await Promise.all(
        input.assetIds.map(async (id) => {
          const asset = await assetService.getAssetById(id);
          
          // Strip heavy metadata if not needed
          if (!input.includeMetadata) {
            delete asset.metadata;
          }
          
          return asset;
        })
      );
      
      return { assets };
    }),

  // Batch user lookup
  getUsers: aiProtectedProcedure
    .input(
      z.object({
        userIds: z.array(z.string()).max(50),
        includeStats: z.boolean().default(false),
      })
    )
    .handler(async ({ input }) => {
      const users = await Promise.all(
        input.userIds.map(async (id) => {
          const user = await userService.getUserById(id);
          
          if (input.includeStats) {
            const stats = await userService.getUserStats(id);
            return { ...user, stats };
          }
          
          return user;
        })
      );
      
      return { users };
    }),
});

// Semantic search router with AI enhancements
export const aiSearchRouter = os.$context<Context>().router({
  // Enhanced semantic search
  semanticSearch: aiProtectedProcedure
    .input(
      z.object({
        query: z.string(),
        embeddings: z.array(z.number()).optional(),
        searchType: z.enum(['boards', 'assets', 'users', 'all']).default('all'),
        filters: z.object({
          boardIds: z.array(z.string()).optional(),
          assetTypes: z.array(z.string()).optional(),
          dateRange: z.object({
            start: z.string().optional(),
            end: z.string().optional(),
          }).optional(),
        }).optional(),
        limit: z.number().min(1).max(100).default(20),
        threshold: z.number().min(0).max(1).default(0.7),
      })
    )
    .handler(async ({ input }) => {
      // If embeddings provided, use them directly (saves computation)
      const queryEmbeddings = input.embeddings || await generateEmbeddings(input.query);
      
      // Perform vector similarity search
      const results = await vectorSearch({
        embeddings: queryEmbeddings,
        type: input.searchType,
        filters: input.filters,
        limit: input.limit,
        threshold: input.threshold,
      });
      
      return {
        results,
        metadata: {
          totalResults: results.length,
          searchType: input.searchType,
          threshold: input.threshold,
        },
      };
    }),

  // Find similar content
  findSimilar: aiProtectedProcedure
    .input(
      z.object({
        sourceId: z.string(),
        sourceType: z.enum(['board', 'asset']),
        limit: z.number().min(1).max(50).default(10),
        diversityFactor: z.number().min(0).max(1).default(0.3),
      })
    )
    .handler(async ({ input }) => {
      // Get source embeddings
      const sourceEmbeddings = await getEmbeddings(input.sourceId, input.sourceType);
      
      // Find similar items with diversity
      const similar = await findSimilarWithDiversity({
        embeddings: sourceEmbeddings,
        excludeId: input.sourceId,
        limit: input.limit,
        diversityFactor: input.diversityFactor,
      });
      
      return { similar };
    }),
});

// Analytics and insights router
export const aiAnalyticsRouter = os.$context<Context>().router({
  // Get aggregated insights for AI analysis
  getInsights: aiProtectedProcedure
    .input(
      z.object({
        entityType: z.enum(['board', 'user', 'asset']),
        entityId: z.string(),
        metrics: z.array(z.enum([
          'engagement', 'growth', 'quality', 'collaboration', 'trends'
        ])).default(['engagement', 'quality']),
        timeframe: z.enum(['1d', '7d', '30d', '90d']).default('30d'),
      })
    )
    .handler(async ({ input }) => {
      const insights = await analyticsService.getInsights({
        type: input.entityType,
        id: input.entityId,
        metrics: input.metrics,
        timeframe: input.timeframe,
      });
      
      return {
        insights,
        summary: generateInsightSummary(insights),
      };
    }),

  // Get trending content for AI recommendations
  getTrending: aiProtectedProcedure
    .input(
      z.object({
        category: z.enum(['boards', 'assets', 'topics']).optional(),
        timeframe: z.enum(['1h', '24h', '7d']).default('24h'),
        limit: z.number().min(1).max(50).default(20),
      })
    )
    .handler(async ({ input }) => {
      const trending = await analyticsService.getTrending({
        category: input.category,
        timeframe: input.timeframe,
        limit: input.limit,
      });
      
      return { trending };
    }),
});

// Recommendation router
export const aiRecommendationRouter = os.$context<Context>().router({
  // Get personalized recommendations
  getRecommendations: aiProtectedProcedure
    .input(
      z.object({
        userId: z.string(),
        recommendationType: z.enum([
          'boards', 'assets', 'collaborators', 'topics'
        ]),
        context: z.object({
          currentBoardId: z.string().optional(),
          recentInteractions: z.array(z.string()).optional(),
          preferences: z.record(z.any()).optional(),
        }).optional(),
        limit: z.number().min(1).max(50).default(10),
      })
    )
    .handler(async ({ input }) => {
      const recommendations = await recommendationService.getPersonalized({
        userId: input.userId,
        type: input.recommendationType,
        context: input.context,
        limit: input.limit,
      });
      
      return {
        recommendations,
        reasoning: generateRecommendationReasoning(recommendations),
      };
    }),

  // Get collaborative filtering suggestions
  getCollaborativeFiltering: aiProtectedProcedure
    .input(
      z.object({
        userId: z.string(),
        itemType: z.enum(['boards', 'assets']),
        method: z.enum(['user_based', 'item_based', 'hybrid']).default('hybrid'),
        limit: z.number().min(1).max(30).default(10),
      })
    )
    .handler(async ({ input }) => {
      const suggestions = await recommendationService.collaborativeFilter({
        userId: input.userId,
        itemType: input.itemType,
        method: input.method,
        limit: input.limit,
      });
      
      return { suggestions };
    }),
});

// Main AI router combining all sub-routers
export const aiRouter = os.$context<Context>().router({
  batch: aiBatchRouter,
  search: aiSearchRouter,
  analytics: aiAnalyticsRouter,
  recommendations: aiRecommendationRouter,
  
  // Health check for AI service
  health: os
    .$context<Context>()
    .handler(async () => {
      return {
        status: 'healthy',
        timestamp: new Date().toISOString(),
        version: '1.0.0',
      };
    }),
});

// Helper functions (these would be implemented with actual services)
async function generateEmbeddings(text: string): Promise<number[]> {
  // Generate embeddings using your embedding service
  return Array(768).fill(0).map(() => Math.random());
}

async function getEmbeddings(id: string, type: string): Promise<number[]> {
  // Fetch cached embeddings from database
  return Array(768).fill(0).map(() => Math.random());
}

async function vectorSearch(params: any): Promise<any[]> {
  // Perform vector similarity search
  return [];
}

async function findSimilarWithDiversity(params: any): Promise<any[]> {
  // Find similar items with diversity factor
  return [];
}

function generateInsightSummary(insights: any): string {
  // Generate human-readable summary of insights
  return 'Summary of insights';
}

function generateRecommendationReasoning(recommendations: any[]): string[] {
  // Generate reasoning for recommendations
  return ['Based on your recent activity', 'Similar users also liked'];
}

// Import services (these would come from your services package)
const boardService = {} as any;
const assetService = {} as any;
const userService = {} as any;
const analyticsService = {} as any;
const recommendationService = {} as any;

// Type export for AI router
export type AIRouter = typeof aiRouter;
````

## File: packages/orpc/CLAUDE.md
````markdown
# @repo/orpc Package Context

## Development Standards

### Package Context
This package provides RPC (Remote Procedure Call) client and server utilities for the Squish ecosystem. Built on ORPC, it offers type-safe API communication, real-time data sync, and efficient request handling.

### Technology Stack
- **ORPC**: 1.7.5 - Type-safe RPC framework
- **TypeScript**: 5.7+ strict configuration
- **Zod**: Request/response validation
- **Hono**: Server integration

### Key Dependencies
```json
{
  "dependencies": {
    "@orpc/server": "^1.7.5",
    "@orpc/client": "^1.7.5",
    "@orpc/react": "^1.7.5",
    "zod": "^3.25.28"
  }
}
```

## Package Structure
```
src/
‚îú‚îÄ‚îÄ index.ts            # Main exports
‚îú‚îÄ‚îÄ client/             # ORPC client setup
‚îú‚îÄ‚îÄ server/             # ORPC server setup
‚îú‚îÄ‚îÄ procedures/         # RPC procedures
‚îú‚îÄ‚îÄ types/              # Type definitions
‚îî‚îÄ‚îÄ utils/              # RPC utilities
```

## RPC Patterns
- Type-safe endpoints
- Request/response validation
- Error handling
- Streaming support
- Client reconnection

## Files to Know
- `src/client/index.ts` - Client configuration
- `src/server/index.ts` - Server configuration

## Quality Checklist
- [ ] Type safety guaranteed
- [ ] Error handling complete
- [ ] Validation schemas
- [ ] Performance optimized

---
EOF < /dev/null
````

## File: packages/orpc/client.ts
````typescript
import { createORPCClient } from '@orpc/client';
import { RPCLink } from '@orpc/client/fetch';

interface ClientConfig {
  baseUrl?: string;
  accessToken?: string | (() => Promise<string | null>);
}

export function createClient(config?: ClientConfig) {
  const link = new RPCLink({
    url: () => {
      const baseUrl =
        config?.baseUrl ||
        (typeof window !== 'undefined'
          ? window.location.origin
          : process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8787');
      return `${baseUrl}/api/orpc`;
    },
    headers: async () => {
      const headers: Record<string, string> = {
        'Content-Type': 'application/json',
      };

      // Handle access token
      if (config?.accessToken) {
        const token =
          typeof config.accessToken === 'function'
            ? await config.accessToken()
            : config.accessToken;

        if (token) {
          headers.Authorization = `Bearer ${token}`;
        }
      }

      return headers;
    },
  });

  return createORPCClient<any>(link);
}
````

## File: packages/orpc/context.ts
````typescript
import type { AuthUser } from '@repo/auth/server-types';
import type { Services } from '@repo/services';

// Avoid cross-package import of API Env; keep generic here
export type Env = unknown;

export interface Context {
  user: AuthUser | null;
  env?: Env;
  requestId?: string;
  headers?: Headers;
  services?: Services;
}

export interface AuthenticatedContext extends Context {
  user: AuthUser;
}

export function createContext(options: {
  user: AuthUser | null;
  env?: Env;
  requestId?: string;
  headers?: Headers;
  services?: Services;
}): Context {
  return {
    user: options.user,
    env: options.env,
    requestId: options.requestId || crypto.randomUUID(),
    headers: options.headers,
    services: options.services,
  };
}

export function isAuthenticated(ctx: Context): ctx is AuthenticatedContext {
  return ctx.user !== null;
}
````

## File: packages/orpc/index.ts
````typescript
// Client-safe exports only
export type { AppRouter } from './router';
export type { Context, AuthenticatedContext } from './context';
export { createContext } from './context';
export { appRouter } from './router';
````

## File: packages/orpc/openapi.ts
````typescript
import { OpenAPIHandler as ORPCOpenAPIHandler } from '@orpc/openapi/fetch';
import type { AppRouter } from './router';

export function createOpenAPIHandler(options: {
  router: AppRouter;
  path?: string;
}) {
  return new ORPCOpenAPIHandler(options.router, {
    // basePath is not available in this version
  } as any);
}

export type OpenAPIHandler = ReturnType<typeof createOpenAPIHandler>;
````

## File: packages/orpc/package.json
````json
{
  "name": "@repo/orpc",
  "version": "0.0.0",
  "private": true,
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": "./dist/index.js",
    "./server": "./dist/server.js",
    "./client": "./dist/client.js",
    "./context": "./dist/context.js",
    "./router": "./dist/router.js",
    "./openapi": "./dist/openapi.js",
    "./adapters/next": "./dist/adapters/next.js",
    "./adapters/hono": "./dist/adapters/hono.js",
    "./adapters/openapi": "./dist/adapters/openapi.js",
    "./hooks/swr": "./dist/hooks/swr.js",
    "./actions": "./dist/actions.js"
  },
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "build": "tsc -p tsconfig.build.json",
    "typecheck": "tsc --noEmit",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage"
  },
  "dependencies": {
    "@clerk/nextjs": "^6.19.5",
    "@orpc/client": "^1.7.6",
    "@orpc/openapi": "^1.7.6",
    "@orpc/react": "^1.7.6",
    "@orpc/server": "^1.7.6",
    "@orpc/zod": "^1.7.6",
    "@repo/auth": "workspace:*",
    "@repo/database": "workspace:*",
    "@repo/services": "workspace:*",
    "swr": "^2.2.5",
    "zod": "^3.25.28"
  },
  "devDependencies": {
    "@repo/testing": "workspace:*",
    "@repo/typescript-config": "workspace:*",
    "@vitest/ui": "^3.1.4",
    "typescript": "^5.8.3",
    "vitest": "^3.1.4"
  }
}
````

## File: packages/orpc/router.ts
````typescript
import { os, ORPCError } from '@orpc/server';
import { z } from 'zod';
import type { AuthenticatedContext, Context } from './context';

// Protected procedure with auth
const protectedProcedure = os
  .$context<Context>()
  .use(async ({ context, next }) => {
    if (!context.user?.userId) {
      throw new ORPCError('UNAUTHORIZED', {
        message: 'Authentication required',
      });
    }
    return next({
      context: context as AuthenticatedContext,
    });
  });

// Public procedure
const publicProcedure = os.$context<Context>();

// User router
export const userRouter = os.$context<Context>().router({
  get: protectedProcedure
    .input(
      z.object({
        userId: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      const targetUserId = input.userId || context.user.userId;
      const user = await context.services!.userService.getUserById(targetUserId);
      
      // Ensure pinnedColumns is included in the response
      return {
        ...user,
        pinnedColumns: user.pinnedColumns || [],
      };
    }),

  getByUsername: publicProcedure
    .input(
      z.object({
        username: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.userService.getUserByUsername(input.username);
    }),

  update: protectedProcedure
    .input(
      z.object({
        username: z.string().optional(),
        name: z.string().optional(),
        bio: z.string().optional(),
        location: z.string().optional(),
        website: z.string().optional(),
        pfpUrl: z.string().optional(),
        pinned_columns: z.array(z.any()).optional(),
        pronouns: z.array(z.string()).optional(),
        show_pronouns: z.boolean().optional(),
        gender: z.string().optional(),
        country: z.string().optional(),
        selected_profile_stat: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.userService.updateUser(context.user.userId, input);
    })
,

  getStats: protectedProcedure
    .input(
      z.object({
        userId: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      const targetUserId = input.userId || context.user.userId;
      return context.services!.userService.getUserStats(targetUserId);
    }),

  delete: protectedProcedure
    .handler(async ({ context }) => {
      return context.services!.userService.deleteUser(context.user.userId);
    })
,
});

// Board router
export const boardRouter = os.$context<Context>().router({
  list: protectedProcedure
    .input(
      z.object({
        includeCollaborated: z.boolean().default(false),
        limit: z.number().int().min(1).max(100).default(20),
        offset: z.number().int().min(0).default(0),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.getUserBoards({
        userId: context.user.userId,
        ...input,
      });
    }),

  get: protectedProcedure
    .input(
      z.object({
        identifier: z.string(),
        userId: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.getBoardById(
        input.identifier,
        input.userId || context.user.userId
      );
    }),

  create: protectedProcedure
    .input(
      z.object({
        name: z.string().min(1).max(100),
        description: z.string().optional(),
        visibility: z.enum(['public', 'private']).default('public'),
        emoji: z.string().optional(),
        instructions: z.string().optional(),
        sources: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.createBoard(context.user.userId, {
        ...input,
        icon: input.emoji,
      });
    })
,

  update: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
        name: z.string().min(1).max(100).optional(),
        description: z.string().optional(),
        visibility: z.enum(['public', 'private']).optional(),
        emoji: z.string().optional(),
        instructions: z.string().optional(),
        sources: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      const { boardId, emoji, ...data } = input;
      return context.services!.boardService.updateBoard(boardId, context.user.userId, {
        ...data,
        icon: emoji,
      });
    })
,

  delete: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.deleteBoard(input.boardId, context.user.userId);
    })
,

  // Collaborator management
  addCollaborator: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
        userId: z.string(),
        accessLevel: z.enum(['view', 'edit', 'admin']).default('view'),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.addCollaborator(input.boardId, context.user.userId, {
        userId: input.userId,
        accessLevel: input.accessLevel,
      });
    })
,

  removeCollaborator: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
        userId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.removeCollaborator(
        input.boardId,
        context.user.userId,
        input.userId
      );
    })
,

  // Board asset management
  getBoardAssets: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.getBoardAssets(input.boardId, context.user.userId);
    }),

  addAssetToBoard: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.addAssetToBoard(
        input.boardId,
        context.user.userId,
        input.assetId
      );
    })
,

  removeAssetFromBoard: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.boardService.removeAssetFromBoard(
        input.boardId,
        context.user.userId,
        input.assetId
      );
    })
,
});

// Asset router
export const assetRouter = os.$context<Context>().router({
  list: protectedProcedure
    .input(
      z.object({
        boardId: z.string().optional(),
        limit: z.number().int().min(1).max(100).default(20),
        offset: z.number().int().min(0).default(0),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.listAssets({
        ...input,
        userId: context.user.userId,
      });
    }),

  get: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.getAssetById(input.assetId);
    }),

  create: protectedProcedure
    .input(
      z.object({
        boardId: z.string(),
        name: z.string().min(1).max(255),
        type: z.enum(['image', 'video', 'audio', 'gif', 'text']),
        url: z.string().url(),
        size: z.number().positive(),
        mimeType: z.string(),
        metadata: z.record(z.any()).optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.createAsset(context.user.userId, input);
    })
,

  update: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
        name: z.string().min(1).max(255).optional(),
        metadata: z.record(z.any()).optional(),
      })
    )
    .handler(async ({ input, context }) => {
      const { assetId, ...data } = input;
      return context.services!.assetService.updateAsset(assetId, context.user.userId, data);
    })
,

  delete: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.deleteAsset(input.assetId, context.user.userId);
    })
,

  // Asset interactions
  like: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.likeAsset(context.user.userId, input.assetId);
    })
,

  trackView: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.trackAssetView(context.user.userId, input.assetId);
    })
,

  trackUse: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.trackAssetUse(context.user.userId, input.assetId);
    })
,

  getStats: protectedProcedure
    .input(
      z.object({
        assetId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.getAssetStats(input.assetId);
    }),

  getUserRecentAssets: protectedProcedure
    .input(
      z.object({
        limit: z.number().int().min(1).max(100).default(20),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.assetService.getUserRecentAssets(context.user.userId, input.limit);
    }),
});

// Upload router
export const uploadRouter = os.$context<Context>().router({
  stage: protectedProcedure
    .input(
      z.object({
        name: z.string().min(1).max(255),
        type: z.enum(['image', 'video', 'audio', 'gif', 'text', 'file']),
        size: z.number().positive(),
        mimeType: z.string(),
        metadata: z.record(z.any()).optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.uploadService.stageUpload(context.user.userId, input);
    }),

  confirm: protectedProcedure
    .input(
      z.object({
        stageId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.uploadService.confirmUpload(input.stageId, context.user.userId);
    }),

  cancel: protectedProcedure
    .input(
      z.object({
        stageId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      await context.services!.uploadService.cancelUpload(input.stageId, context.user.userId);
      return { success: true };
    }),

  getProgress: protectedProcedure
    .input(
      z.object({
        stageId: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.uploadService.getUploadProgress(
        context.user.userId,
        input.stageId
      );
    }),

  // Direct file upload
  uploadFile: protectedProcedure
    .input(
      z.object({
        file: z.instanceof(File),
        boardId: z.string().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.uploadService.handleFileUpload(
        context.user.userId,
        input.file,
        input.boardId
      );
    })
,
});

// Search router
export const searchRouter = os.$context<Context>().router({
  query: protectedProcedure
    .input(
      z.object({
        query: z.string().optional(),
        type: z.enum(['board', 'asset', 'user', 'all']).default('all'),
        userId: z.string().optional(),
        boardId: z.string().optional(),
        limit: z.number().int().min(1).max(100).default(20),
        offset: z.number().int().min(0).default(0),
        useAI: z.boolean().default(false).optional(),
        includeSimilar: z.boolean().default(false).optional(),
        filters: z
          .object({
            assetType: z
              .array(z.enum(['image', 'video', 'audio', 'gif', 'text', 'file']))
              .optional(),
            boardVisibility: z
              .array(z.enum(['public', 'private', 'shared']))
              .optional(),
          })
          .optional(),
      })
    )
    .handler(async ({ input, context }) => {
      if (input.useAI) {
        return context.services!.searchService.enhancedSearch({
          ...input,
          userId: context.user.userId,
        });
      }
      return context.services!.searchService.search({
        ...input,
        userId: context.user.userId,
      });
    }),

  history: protectedProcedure
    .input(
      z.object({
        limit: z.number().int().min(1).max(100).default(20),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.searchService.getSearchHistory(context.user.userId, input.limit);
    }),

  save: protectedProcedure
    .input(
      z.object({
        query: z.string(),
        expandedContext: z.string().optional(),
        resultsSnapshot: z.any().optional(),
      })
    )
    .handler(async ({ input, context }) => {
      const searchId = await context.services!.searchService.saveSearchHistory(
        context.user.userId,
        input.query,
        input.expandedContext,
        input.resultsSnapshot
      );
      return { searchId };
    }),

  check: protectedProcedure
    .input(
      z.object({
        searchId: z.string(),
      })
    )
    .handler(async ({ input, context }) => {
      return context.services!.searchService.checkSearchResults(
        input.searchId,
        context.user.userId
      );
    }),

  // Public search (no auth required)
  public: publicProcedure
    .input(
      z.object({
        query: z.string(),
        type: z.enum(['board', 'user']).default('board'), // Only boards and users publicly
        limit: z.number().int().min(1).max(100).default(20),
        offset: z.number().int().min(0).default(0),
      })
    )
    .handler(async ({ input, context }) => {
      // Only search public content for public search
      return context.services!.searchService.search({
        ...input,
        // No userId for public search
      });
    }),
});

// Import AI router
import { aiRouter } from './ai-router';

// Main app router
export const appRouter = os.$context<Context>().router({
  user: userRouter,
  board: boardRouter,
  asset: assetRouter,
  upload: uploadRouter,
  search: searchRouter,
  ai: aiRouter, // AI-optimized endpoints
});

// Type exports
export type AppRouter = typeof appRouter;
````

## File: packages/orpc/server.ts
````typescript
// Server-only exports - DO NOT import this file in client code
export { appRouter } from './router';
export type { AppRouter } from './router';
export { createContext } from './context';
export type { Context, AuthenticatedContext } from './context';
````

## File: packages/orpc/tsconfig.build.json
````json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "declaration": true,
    "declarationMap": true,
    "emitDeclarationOnly": false,
    "rootDir": "./",
    "module": "ES2022",
    "target": "ES2022",
    "moduleResolution": "bundler",
    "stripInternal": false
  },
  "include": ["./**/*.ts", "./**/*.tsx"],
  "exclude": [
    "node_modules",
    "dist",
    "**/*.test.ts",
    "**/*.test.tsx",
    "**/*.spec.ts",
    "**/*.spec.tsx",
    "__tests__/**",
    "__tests__.bak/**",
    "tests/**",
    "tests.bak/**"
  ]
}
````

## File: packages/orpc/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./",
    "tsBuildInfoFile": "./tsconfig.tsbuildinfo"
  },
  "include": ["./**/*.ts", "./**/*.tsx"],
  "exclude": ["node_modules", "dist"]
}
````

## File: packages/orpc/vitest.config.ts
````typescript
import path from 'node:path';
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'node',
    globals: true,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        '*.config.ts',
        '**/*.d.ts',
        '**/__tests__/**',
        '**/types/**',
      ],
    },
    include: [
      '__tests__/**/*.test.ts',
      'src/**/__tests__/**/*.test.ts',
      'src/**/*.test.ts',
    ],
    exclude: ['node_modules', 'dist'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
      '@repo': path.resolve(__dirname, '../../packages'),
    },
  },
});
````

## File: packages/services/src/lib/errors.ts
````typescript
export class ServiceError extends Error {
  constructor(
    message: string,
    public statusCode: number,
    public code?: string
  ) {
    super(message);
    this.name = 'ServiceError';
  }
}

export const notFound = (message = 'Resource not found') =>
  new ServiceError(message, 404, 'NOT_FOUND');

export const unauthorized = (message = 'Unauthorized') =>
  new ServiceError(message, 401, 'UNAUTHORIZED');

export const badRequest = (message = 'Bad request') =>
  new ServiceError(message, 400, 'BAD_REQUEST');

export const conflict = (message = 'Resource conflict') =>
  new ServiceError(message, 409, 'CONFLICT');

export const internalError = (message = 'Internal server error') =>
  new ServiceError(message, 500, 'INTERNAL_ERROR');
````

## File: packages/services/src/lib/types.ts
````typescript
export enum ResourceType {
  USER = 'user',
  PROJECT = 'project',
  PAGE = 'page',
  ELEMENT = 'element',
  ASSET = 'asset',
  COMMENT = 'comment',
  VERSION = 'version',
}
````

## File: packages/services/src/types/api.ts
````typescript
// API Response and Request types
export type BoardAccessLevel = 'read' | 'write' | 'admin';

export interface CreateAssetBody {
  boardId: string;
  name: string;
  type: string;
  url: string;
  size: number;
  mimeType: string;
  width?: number;
  height?: number;
  blurhash?: string;
  metadata?: Record<string, unknown>;
}

export interface StageAssetBody {
  boardId: string;
  filename: string;
  contentType: string;
  size: number;
}

export interface AddBoardCollaboratorRequest {
  access_level?: BoardAccessLevel;
  board_id: string;
  user_id: string;
}

export interface AssetListResponse {
  items: any[]; // Will be replaced with database Asset type
  limit: number;
  offset: number;
  sort_by: string;
  sort_order: string;
}

export interface AssetResponse {
  id: string;
  type: string;
  created: string;
  updated: string;
  created_by?: any;
  name: string;
  url: string;
  height?: any;
  thumbnail_url?: any;
  width?: any;
  boards?: any[];
  asset_metadata?: any;
}

export interface BoardCollaboratorsResponse {
  collaborators: Record<string, any>[];
}

export interface BoardListResponse {
  boards: any[]; // Will be replaced with database Board type
  total: number;
  limit: number;
  offset: number;
  sort_by: string;
  sort_order: string;
}

export interface BoardResponse {
  id: string;
  created: string;
  updated: string;
  name: string;
  emoji: string;
  color: string;
  created_by: string;
  collaborators?: any[];
  assets?: AssetResponse[];
  description?: string;
  visibility?: string;
}

export interface CreateBoardRequest {
  name: string;
  description?: string;
  emoji?: string;
  color?: string;
  is_private?: boolean;
}

export interface UpdateBoardRequest {
  name?: string;
  description?: string;
  emoji?: string;
  color?: string;
  is_private?: boolean;
}

export interface UpdateBoardIconRequest {
  emoji: string;
}

export interface UserProfileResponse {
  id: string;
  username: string;
  name?: string;
  pfp?: string;
  bio?: string;
  pronouns?: string[];
  show_pronouns?: boolean;
  gender?: string;
  email?: string;
  phone?: string;
  country?: string;
  created: string;
  updated: string;
  pinned_columns?: any[];
  selected_profile_stat?: string;
}

export interface UserProfileUpdateRequest {
  username?: string;
  name?: string;
  bio?: string;
  pfp?: string;
  pronouns?: string[];
  show_pronouns?: boolean;
  gender?: string;
  country?: string;
  pinned_columns?: any[];
  selected_profile_stat?: string;
}

export interface SearchBody {
  query: string;
  filters?: {
    type?: string[];
    board_id?: string[];
    user_id?: string[];
    date_range?: {
      start?: string;
      end?: string;
    };
  };
  limit?: number;
  offset?: number;
}
````

## File: packages/services/src/asset.ts
````typescript
import { type DatabaseClient } from '@repo/database';
import {
  and,
  count,
  desc,
  eq,
  inArray,
  like,
  schema,
  sql,
} from '@repo/database';
import {
  ServiceError,
  internalError,
  notFound,
  unauthorized,
} from './lib/errors';

export class AssetService {
  constructor(private db: DatabaseClient) {}
  async createAsset(
    userId: string,
    data: {
      name: string;
      url: string;
      type: string; // image, video, audio, gif, text, file
      thumbnailUrl?: string;
      storageKey?: string;
      width?: number;
      height?: number;
      duration?: number;
      size?: number;
      mimeType?: string;
      metadata?: Record<string, any>;
    }
  ) {
    try {
      const [asset] = await this.db
        .insert(schema.assets)
        .values({
          ...data,
          creatorId: userId,
        })
        .returning();

      return asset;
    } catch (_error) {
      throw internalError('Failed to create asset');
    }
  }

  async getAssetById(assetId: string) {
    try {
      const [asset] = await this.db
        .select({
          asset: schema.assets,
          creator: {
            id: schema.users.id,
            username: schema.users.username,
            name: schema.users.name,
            pfpUrl: schema.users.pfpUrl,
          },
        })
        .from(schema.assets)
        .innerJoin(schema.users, eq(schema.assets.creatorId, schema.users.id))
        .where(eq(schema.assets.id, assetId))
        .limit(1);

      if (!asset) {
        throw notFound('Asset not found');
      }

      return {
        ...asset.asset,
        creator: asset.creator,
      };
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to fetch asset');
    }
  }

  async updateAsset(
    assetId: string,
    userId: string,
    data: Partial<{
      name: string;
      thumbnailUrl: string;
      metadata: Record<string, any>;
    }>
  ) {
    try {
      // Check ownership
      const [asset] = await this.db
        .select()
        .from(schema.assets)
        .where(eq(schema.assets.id, assetId))
        .limit(1);

      if (!asset) {
        throw notFound('Asset not found');
      }

      if (asset.creatorId !== userId) {
        throw unauthorized('You can only update your own assets');
      }

      const [updatedAsset] = await this.db
        .update(schema.assets)
        .set({
          ...data,
          updatedAt: new Date(),
        })
        .where(eq(schema.assets.id, assetId))
        .returning();

      return updatedAsset;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to update asset');
    }
  }

  async deleteAsset(assetId: string, userId: string) {
    try {
      // Check ownership
      const [asset] = await this.db
        .select()
        .from(schema.assets)
        .where(eq(schema.assets.id, assetId))
        .limit(1);

      if (!asset) {
        throw notFound('Asset not found');
      }

      if (asset.creatorId !== userId) {
        throw unauthorized('You can only delete your own assets');
      }

      // Delete the asset (cascade will handle related records)
      await this.db.delete(schema.assets).where(eq(schema.assets.id, assetId));

      // TODO: Delete from storage provider if storageKey exists
      if (asset.storageKey) {
      }
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to delete asset');
    }
  }

  async listAssets(options: {
    userId?: string;
    type?: string;
    search?: string;
    limit?: number;
    offset?: number;
    orderBy?: 'createdAt' | 'updatedAt' | 'name';
    order?: 'asc' | 'desc';
  }) {
    try {
      const conditions = [];

      // Filter by creator
      if (options.userId) {
        conditions.push(eq(schema.assets.creatorId, options.userId));
      }

      // Filter by type
      if (options.type) {
        conditions.push(eq(schema.assets.type, options.type));
      }

      // Search by name
      if (options.search) {
        conditions.push(like(schema.assets.name, `%${options.search}%`));
      }

      // Build query
      const whereClause =
        conditions.length > 0 ? and(...conditions) : undefined;

      // Apply ordering
      const _orderColumn = options.orderBy || 'createdAt';
      const orderDirection = options.order || 'desc';

      // Apply pagination
      const limit = options.limit || 20;
      const offset = options.offset || 0;

      const results = await this.db
        .select({
          asset: schema.assets,
          creator: {
            id: schema.users.id,
            username: schema.users.username,
            name: schema.users.name,
            pfpUrl: schema.users.pfpUrl,
          },
          boardCount: count(schema.boardAssets.boardId),
        })
        .from(schema.assets)
        .innerJoin(schema.users, eq(schema.assets.creatorId, schema.users.id))
        .leftJoin(
          schema.boardAssets,
          eq(schema.boardAssets.assetId, schema.assets.id)
        )
        .where(whereClause)
        .groupBy(schema.assets.id, schema.users.id)
        .orderBy(
          orderDirection === 'desc'
            ? desc(schema.assets.createdAt)
            : schema.assets.createdAt
        )
        .limit(limit)
        .offset(offset);

      return results.map((r) => ({
        ...r.asset,
        creator: r.creator,
        boardCount: Number(r.boardCount),
      }));
    } catch (_error) {
      throw internalError('Failed to list assets');
    }
  }

  async getAssetsByIds(assetIds: string[]) {
    try {
      const assets = await this.db
        .select({
          asset: schema.assets,
          creator: {
            id: schema.users.id,
            username: schema.users.username,
            name: schema.users.name,
            pfpUrl: schema.users.pfpUrl,
          },
        })
        .from(schema.assets)
        .innerJoin(schema.users, eq(schema.assets.creatorId, schema.users.id))
        .where(inArray(schema.assets.id, assetIds));

      return assets.map((a) => ({
        ...a.asset,
        creator: a.creator,
      }));
    } catch (_error) {
      throw internalError('Failed to fetch assets');
    }
  }

  async getUserRecentAssets(userId: string, limit = 20) {
    try {
      const recentAssets = await this.db
        .select({
          asset: schema.assets,
          usedAt: schema.recentAssets.usedAt,
        })
        .from(schema.recentAssets)
        .innerJoin(
          schema.assets,
          eq(schema.recentAssets.assetId, schema.assets.id)
        )
        .where(eq(schema.recentAssets.userId, userId))
        .orderBy(desc(schema.recentAssets.usedAt))
        .limit(limit);

      return recentAssets;
    } catch (_error) {
      throw internalError('Failed to fetch recent assets');
    }
  }

  async trackAssetUse(userId: string, assetId: string) {
    try {
      // Check if record exists
      const [existing] = await this.db
        .select()
        .from(schema.recentAssets)
        .where(
          and(
            eq(schema.recentAssets.userId, userId),
            eq(schema.recentAssets.assetId, assetId)
          )
        )
        .limit(1);

      if (existing) {
        // Update timestamp
        await this.db
          .update(schema.recentAssets)
          .set({ usedAt: new Date() })
          .where(
            and(
              eq(schema.recentAssets.userId, userId),
              eq(schema.recentAssets.assetId, assetId)
            )
          );
      } else {
        // Create new record
        await this.db.insert(schema.recentAssets).values({
          userId,
          assetId,
        });
      }
    } catch (_error) {
      // Don't throw, just log error
    }
  }

  async likeAsset(userId: string, assetId: string) {
    try {
      // Check if asset exists
      const [asset] = await this.db
        .select()
        .from(schema.assets)
        .where(eq(schema.assets.id, assetId))
        .limit(1);

      if (!asset) {
        throw notFound('Asset not found');
      }

      // Check if already liked
      const [existing] = await this.db
        .select()
        .from(schema.likedAssets)
        .where(
          and(
            eq(schema.likedAssets.userId, userId),
            eq(schema.likedAssets.assetId, assetId)
          )
        )
        .limit(1);

      if (existing) {
        // Unlike
        await this.db
          .delete(schema.likedAssets)
          .where(
            and(
              eq(schema.likedAssets.userId, userId),
              eq(schema.likedAssets.assetId, assetId)
            )
          );

        return { liked: false };
      }
      // Like
      await this.db.insert(schema.likedAssets).values({
        userId,
        assetId,
      });

      return { liked: true };
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to like/unlike asset');
    }
  }

  async trackAssetView(userId: string, assetId: string) {
    try {
      // Check if record exists
      const [existing] = await this.db
        .select()
        .from(schema.viewedAssets)
        .where(
          and(
            eq(schema.viewedAssets.userId, userId),
            eq(schema.viewedAssets.assetId, assetId)
          )
        )
        .limit(1);

      if (existing) {
        // Increment view count
        await this.db
          .update(schema.viewedAssets)
          .set({
            viewCount: existing.viewCount + 1,
            lastViewed: new Date(),
          })
          .where(
            and(
              eq(schema.viewedAssets.userId, userId),
              eq(schema.viewedAssets.assetId, assetId)
            )
          );
      } else {
        // Create new record
        await this.db.insert(schema.viewedAssets).values({
          userId,
          assetId,
        });
      }
    } catch (_error) {
      // Don't throw, just log error
    }
  }

  async getAssetStats(assetId: string) {
    try {
      const [likes, views, boards] = await Promise.all([
        // Count likes
        this.db
          .select({ count: count() })
          .from(schema.likedAssets)
          .where(eq(schema.likedAssets.assetId, assetId)),

        // Sum views
        this.db
          .select({
            totalViews: sql<number>`SUM(${schema.viewedAssets.viewCount})`,
            uniqueViews: count(),
          })
          .from(schema.viewedAssets)
          .where(eq(schema.viewedAssets.assetId, assetId)),

        // Count boards using this asset
        this.db
          .select({ count: count() })
          .from(schema.boardAssets)
          .where(eq(schema.boardAssets.assetId, assetId)),
      ]);

      return {
        likes: Number(likes[0]?.count || 0),
        totalViews: Number(views[0]?.totalViews || 0),
        uniqueViews: Number(views[0]?.uniqueViews || 0),
        boardsUsing: Number(boards[0]?.count || 0),
      };
    } catch (_error) {
      throw internalError('Failed to fetch asset stats');
    }
  }
}
````

## File: packages/services/src/board.ts
````typescript
import { type DatabaseClient } from '@repo/database';
import {
  and,
  count,
  desc,
  eq,
  like,
  or,
  schema,
  sql,
} from '@repo/database';
import {
  ServiceError,
  internalError,
  notFound,
  unauthorized,
} from './lib/errors';

export class BoardService {
  constructor(private db: DatabaseClient) {}
  async createBoard(
    userId: string,
    data: {
      name: string;
      visibility?: string;
      description?: string;
      instructions?: string;
      sources?: string;
      icon?: string;
    }
  ) {
    try {
      const [board] = await this.db
        .insert(schema.boards)
        .values({
          ...data,
          creatorId: userId,
          visibility: data.visibility || 'public',
          icon: data.icon || 'üñºÔ∏è',
        })
        .returning();

      return board;
    } catch (_error) {
      throw internalError('Failed to create board');
    }
  }

  async getBoardById(boardId: string, userId?: string) {
    try {
      const [board] = await this.db
        .select({
          board: schema.boards,
          creator: {
            id: schema.users.id,
            username: schema.users.username,
            name: schema.users.name,
            pfpUrl: schema.users.pfpUrl,
          },
        })
        .from(schema.boards)
        .innerJoin(schema.users, eq(schema.boards.creatorId, schema.users.id))
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      // Check visibility permissions
      if (board.board.visibility === 'private' && board.creator.id !== userId) {
        // Check if user is a collaborator
        if (userId) {
          const [collaboration] = await this.db
            .select()
            .from(schema.boardCollaborators)
            .where(
              and(
                eq(schema.boardCollaborators.boardId, boardId),
                eq(schema.boardCollaborators.userId, userId)
              )
            )
            .limit(1);

          if (!collaboration) {
            throw unauthorized('You do not have access to this board');
          }
        } else {
          throw unauthorized('You do not have access to this board');
        }
      }

      // Get assets count
      const [assetCount] = await this.db
        .select({ count: count() })
        .from(schema.boardAssets)
        .where(eq(schema.boardAssets.boardId, boardId));

      // Get collaborators count
      const [collaboratorCount] = await this.db
        .select({ count: count() })
        .from(schema.boardCollaborators)
        .where(eq(schema.boardCollaborators.boardId, boardId));

      return {
        ...board.board,
        creator: board.creator,
        assetCount: Number(assetCount?.count || 0),
        collaboratorCount: Number(collaboratorCount?.count || 0),
      };
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to fetch board');
    }
  }

  async updateBoard(
    boardId: string,
    userId: string,
    data: Partial<{
      name: string;
      visibility: string;
      description: string;
      instructions: string;
      sources: string;
      icon: string;
    }>
  ) {
    try {
      // Check ownership
      const [board] = await this.db
        .select()
        .from(schema.boards)
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      if (board.creatorId !== userId) {
        // Check if user has edit permissions
        const [collaboration] = await this.db
          .select()
          .from(schema.boardCollaborators)
          .where(
            and(
              eq(schema.boardCollaborators.boardId, boardId),
              eq(schema.boardCollaborators.userId, userId),
              or(
                eq(schema.boardCollaborators.accessLevel, 'edit'),
                eq(schema.boardCollaborators.accessLevel, 'admin')
              )
            )
          )
          .limit(1);

        if (!collaboration) {
          throw unauthorized('You do not have permission to edit this board');
        }
      }

      const [updatedBoard] = await this.db
        .update(schema.boards)
        .set({
          ...data,
          updatedAt: new Date(),
        })
        .where(eq(schema.boards.id, boardId))
        .returning();

      return updatedBoard;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to update board');
    }
  }

  async deleteBoard(boardId: string, userId: string) {
    try {
      // Check ownership
      const [board] = await this.db
        .select()
        .from(schema.boards)
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      if (board.creatorId !== userId) {
        throw unauthorized('You can only delete your own boards');
      }

      await this.db.delete(schema.boards).where(eq(schema.boards.id, boardId));
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to delete board');
    }
  }

  async listBoards(options: {
    userId?: string;
    visibility?: 'public' | 'private';
    search?: string;
    limit?: number;
    offset?: number;
    orderBy?: 'createdAt' | 'updatedAt' | 'name';
    order?: 'asc' | 'desc';
  }) {
    try {
      const conditions = [];

      // Filter by visibility
      if (options.visibility) {
        conditions.push(eq(schema.boards.visibility, options.visibility));
      } else if (!options.userId) {
        // If not filtering by user, only show public boards
        conditions.push(eq(schema.boards.visibility, 'public'));
      }

      // Filter by user (their boards or boards they collaborate on)
      if (options.userId) {
        const _userBoardsSubquery = this.db
          .select({ boardId: schema.boards.id })
          .from(schema.boards)
          .where(eq(schema.boards.creatorId, options.userId));

        const collaborationSubquery = this.db
          .select({ boardId: schema.boardCollaborators.boardId })
          .from(schema.boardCollaborators)
          .where(eq(schema.boardCollaborators.userId, options.userId));

        conditions.push(
          or(
            eq(schema.boards.creatorId, options.userId),
            sql`${schema.boards.id} IN (${collaborationSubquery})`
          )
        );
      }

      // Search by name or description
      if (options.search) {
        conditions.push(
          or(
            like(schema.boards.name, `%${options.search}%`),
            like(schema.boards.description, `%${options.search}%`)
          )
        );
      }

      // Build query
      const whereClause =
        conditions.length > 0 ? and(...conditions) : undefined;

      // Apply ordering
      const _orderColumn = options.orderBy || 'createdAt';
      const orderDirection = options.order || 'desc';

      // Apply pagination
      const limit = options.limit || 20;
      const offset = options.offset || 0;

      const results = await this.db
        .select({
          board: schema.boards,
          creator: {
            id: schema.users.id,
            username: schema.users.username,
            name: schema.users.name,
            pfpUrl: schema.users.pfpUrl,
          },
          assetCount: count(schema.boardAssets.assetId),
        })
        .from(schema.boards)
        .innerJoin(schema.users, eq(schema.boards.creatorId, schema.users.id))
        .leftJoin(
          schema.boardAssets,
          eq(schema.boardAssets.boardId, schema.boards.id)
        )
        .where(whereClause)
        .groupBy(schema.boards.id, schema.users.id)
        .orderBy(
          orderDirection === 'desc'
            ? desc(schema.boards.createdAt)
            : schema.boards.createdAt
        )
        .limit(limit)
        .offset(offset);

      return results.map((r) => ({
        ...r.board,
        creator: r.creator,
        assetCount: Number(r.assetCount),
      }));
    } catch (_error) {
      throw internalError('Failed to list boards');
    }
  }

  async addCollaborator(
    boardId: string,
    ownerId: string,
    data: {
      userId: string;
      accessLevel?: 'view' | 'edit' | 'admin';
    }
  ) {
    try {
      // Check ownership
      const [board] = await this.db
        .select()
        .from(schema.boards)
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      if (board.creatorId !== ownerId) {
        throw unauthorized('Only the board owner can add collaborators');
      }

      // Check if collaboration already exists
      const [existing] = await this.db
        .select()
        .from(schema.boardCollaborators)
        .where(
          and(
            eq(schema.boardCollaborators.boardId, boardId),
            eq(schema.boardCollaborators.userId, data.userId)
          )
        )
        .limit(1);

      if (existing) {
        // Update access level
        const [updated] = await this.db
          .update(schema.boardCollaborators)
          .set({
            accessLevel: data.accessLevel || 'view',
          })
          .where(
            and(
              eq(schema.boardCollaborators.boardId, boardId),
              eq(schema.boardCollaborators.userId, data.userId)
            )
          )
          .returning();

        return updated;
      }

      // Create new collaboration
      const [collaboration] = await this.db
        .insert(schema.boardCollaborators)
        .values({
          boardId,
          userId: data.userId,
          accessLevel: data.accessLevel || 'view',
        })
        .returning();

      return collaboration;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to add collaborator');
    }
  }

  async removeCollaborator(boardId: string, ownerId: string, userId: string) {
    try {
      // Check ownership
      const [board] = await this.db
        .select()
        .from(schema.boards)
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      if (board.creatorId !== ownerId) {
        throw unauthorized('Only the board owner can remove collaborators');
      }

      await this.db
        .delete(schema.boardCollaborators)
        .where(
          and(
            eq(schema.boardCollaborators.boardId, boardId),
            eq(schema.boardCollaborators.userId, userId)
          )
        );
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to remove collaborator');
    }
  }

  async getBoardAssets(boardId: string, userId?: string) {
    try {
      // Check access permissions
      await this.getBoardById(boardId, userId);

      const assets = await this.db
        .select({
          asset: schema.assets,
          order: schema.boardAssets.order,
          addedAt: schema.boardAssets.createdAt,
        })
        .from(schema.boardAssets)
        .innerJoin(
          schema.assets,
          eq(schema.boardAssets.assetId, schema.assets.id)
        )
        .where(eq(schema.boardAssets.boardId, boardId))
        .orderBy(schema.boardAssets.order);

      return assets;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to fetch board assets');
    }
  }

  async addAssetToBoard(
    boardId: string,
    userId: string,
    assetId: string,
    order?: number
  ) {
    try {
      // Check permissions
      const [board] = await this.db
        .select()
        .from(schema.boards)
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      if (board.creatorId !== userId) {
        // Check if user has edit permissions
        const [collaboration] = await this.db
          .select()
          .from(schema.boardCollaborators)
          .where(
            and(
              eq(schema.boardCollaborators.boardId, boardId),
              eq(schema.boardCollaborators.userId, userId),
              or(
                eq(schema.boardCollaborators.accessLevel, 'edit'),
                eq(schema.boardCollaborators.accessLevel, 'admin')
              )
            )
          )
          .limit(1);

        if (!collaboration) {
          throw unauthorized('You do not have permission to edit this board');
        }
      }

      // Check if asset exists
      const [asset] = await this.db
        .select()
        .from(schema.assets)
        .where(eq(schema.assets.id, assetId))
        .limit(1);

      if (!asset) {
        throw notFound('Asset not found');
      }

      // Get max order if not provided
      if (order === undefined) {
        const [maxOrder] = await this.db
          .select({ max: sql<number>`MAX(${schema.boardAssets.order})` })
          .from(schema.boardAssets)
          .where(eq(schema.boardAssets.boardId, boardId));

        order = (maxOrder?.max || 0) + 1;
      }

      // Add asset to board
      const [boardAsset] = await this.db
        .insert(schema.boardAssets)
        .values({
          boardId,
          assetId,
          order,
        })
        .returning();

      // Update board's updatedAt
      await this.db
        .update(schema.boards)
        .set({ updatedAt: new Date() })
        .where(eq(schema.boards.id, boardId));

      return boardAsset;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to add asset to board');
    }
  }

  async removeAssetFromBoard(boardId: string, userId: string, assetId: string) {
    try {
      // Check permissions (same as addAssetToBoard)
      const [board] = await this.db
        .select()
        .from(schema.boards)
        .where(eq(schema.boards.id, boardId))
        .limit(1);

      if (!board) {
        throw notFound('Board not found');
      }

      if (board.creatorId !== userId) {
        const [collaboration] = await this.db
          .select()
          .from(schema.boardCollaborators)
          .where(
            and(
              eq(schema.boardCollaborators.boardId, boardId),
              eq(schema.boardCollaborators.userId, userId),
              or(
                eq(schema.boardCollaborators.accessLevel, 'edit'),
                eq(schema.boardCollaborators.accessLevel, 'admin')
              )
            )
          )
          .limit(1);

        if (!collaboration) {
          throw unauthorized('You do not have permission to edit this board');
        }
      }

      await this.db
        .delete(schema.boardAssets)
        .where(
          and(
            eq(schema.boardAssets.boardId, boardId),
            eq(schema.boardAssets.assetId, assetId)
          )
        );

      // Update board's updatedAt
      await this.db
        .update(schema.boards)
        .set({ updatedAt: new Date() })
        .where(eq(schema.boards.id, boardId));
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to remove asset from board');
    }
  }

  async getUserBoards({
    userId,
    includeCollaborated = false,
    limit = 20,
    offset = 0,
  }: {
    userId: string;
    includeCollaborated?: boolean;
    limit?: number;
    offset?: number;
  }) {
    try {
      const whereClause = includeCollaborated
        ? or(
            eq(schema.boards.creatorId, userId),
            sql`${schema.boards.id} IN (
              SELECT ${schema.boardCollaborators.boardId}
              FROM ${schema.boardCollaborators}
              WHERE ${schema.boardCollaborators.userId} = ${userId}
            )`
          )
        : eq(schema.boards.creatorId, userId);

      const boards = await this.db
        .select({
          board: schema.boards,
          creator: {
            id: schema.users.id,
            username: schema.users.username,
            name: schema.users.name,
            pfpUrl: schema.users.pfpUrl,
          },
          assetCount: count(schema.boardAssets.assetId),
        })
        .from(schema.boards)
        .innerJoin(schema.users, eq(schema.boards.creatorId, schema.users.id))
        .leftJoin(
          schema.boardAssets,
          eq(schema.boards.id, schema.boardAssets.boardId)
        )
        .where(whereClause)
        .groupBy(schema.boards.id, schema.users.id)
        .orderBy(desc(schema.boards.updatedAt))
        .limit(limit)
        .offset(offset);

      return {
        boards: boards.map(({ board, creator, assetCount }) => ({
          ...board,
          creator,
          assetCount,
        })),
        limit,
        offset,
      };
    } catch (_error) {
      throw internalError('Failed to get user boards');
    }
  }
}
````

## File: packages/services/src/factory.ts
````typescript
import type { DatabaseClient } from '@repo/database';
import { UserService } from './user';
import { BoardService } from './board';
import { AssetService } from './asset';
import { UploadService } from './uploads';
import { SearchService } from './search';

export interface ServiceConfig {
  db: DatabaseClient;
  env: {
    AI_SERVICE_URL?: string;
    STORAGE_PROVIDER?: string;
    R2_BUCKET_NAME?: string;
    [key: string]: any;
  };
}

export function createServices(config: ServiceConfig) {
  return {
    userService: new UserService(config.db),
    boardService: new BoardService(config.db),
    assetService: new AssetService(config.db),
    uploadService: new UploadService(config.db, config.env),
    searchService: new SearchService(config.db, config.env),
  };
}

export type Services = ReturnType<typeof createServices>;
````

## File: packages/services/src/index.ts
````typescript
// Export service classes
export { UserService } from './user';
export { BoardService } from './board';
export { AssetService } from './asset';
export { UploadService } from './uploads';
export { SearchService } from './search';

// Export factory - this is the primary way to use services
export { createServices, type Services, type ServiceConfig } from './factory';

export {
  ServiceError,
  notFound,
  unauthorized,
  badRequest,
  conflict,
  internalError,
} from './lib/errors';
export type { ResourceType } from './lib/types';

// API type exports
export * from './types/api';

// Upload type exports
export type { StagedUpload } from './uploads';

// Search type exports
export type {
  SearchResult,
  SearchOptions,
  EnhancedSearchOptions,
} from './search';
````

## File: packages/services/src/search.ts
````typescript
import { and, desc, eq, ilike, or, schema, sql, type DatabaseClient } from '@repo/database';
import { ServiceError, internalError, notFound } from './lib/errors';

export interface SearchResult {
  id: string;
  type: 'board' | 'asset' | 'user';
  title: string;
  description?: string;
  url?: string;
  score: number;
  metadata?: Record<string, any>;
}

export interface SearchOptions {
  query?: string;
  type?: 'board' | 'asset' | 'user' | 'all';
  userId?: string;
  boardId?: string;
  limit?: number;
  offset?: number;
}

export interface EnhancedSearchOptions extends SearchOptions {
  useAI?: boolean;
  includeSimilar?: boolean;
  filters?: {
    assetType?: ('image' | 'video' | 'audio' | 'gif' | 'text' | 'file')[];
    boardVisibility?: ('public' | 'private' | 'shared')[];
  };
}

export class SearchService {
  private aiServiceUrl: string;

  constructor(
    private db: DatabaseClient,
    env: { AI_SERVICE_URL?: string } = {}
  ) {
    // Default to local Mastra dev server, production uses Mastra Cloud
    this.aiServiceUrl = env.AI_SERVICE_URL || 'http://localhost:9998';
  }

  async search(options: SearchOptions): Promise<{
    results: SearchResult[];
    total: number;
    query: string;
    filters: Record<string, any>;
  }> {
    const {
      query = '',
      type = 'all',
      userId,
      limit = 20,
      offset = 0,
    } = options;

    try {
      const results: SearchResult[] = [];

      // Search based on type
      if (type === 'board' || type === 'all') {
        const boardResults = await this.searchBoards({
          query,
          userId,
          limit,
          offset,
        });
        results.push(...boardResults);
      }

      if (type === 'asset' || type === 'all') {
        const assetResults = await this.searchAssets({
          query,
          userId,
          boardId: options.boardId,
          limit,
          offset,
        });
        results.push(...assetResults);
      }

      if (type === 'user' || type === 'all') {
        const userResults = await this.searchUsers({
          query,
          limit,
          offset,
        });
        results.push(...userResults);
      }

      // Sort by score and apply pagination
      const sortedResults = results
        .sort((a, b) => b.score - a.score)
        .slice(offset, offset + limit);

      return {
        results: sortedResults,
        total: results.length,
        query,
        filters: { type, userId },
      };
    } catch (_error) {
      throw internalError('Failed to perform search');
    }
  }

  async enhancedSearch(options: EnhancedSearchOptions): Promise<{
    results: SearchResult[];
    total: number;
    query: string;
    expanded: string[];
    aiInsights?: {
      relevantTopics: string[];
      searchIntent: string;
      suggestedFilters: string[];
    };
  }> {
    let expandedQuery = options.query || '';
    let aiInsights;

    // Use AI to enhance search if enabled
    if (options.useAI && options.query) {
      const enhanced = await this.enhanceQuery(options.query);
      expandedQuery = enhanced.expanded;
      aiInsights = enhanced.insights;
    }

    // Perform the search with expanded query
    const results = await this.search({
      ...options,
      query: expandedQuery,
    });

    // If similarity search is enabled, fetch similar items
    let similarResults: SearchResult[] = [];
    if (options.includeSimilar && aiInsights) {
      similarResults = await this.findSimilarContent(results.results);
    }

    // Combine and deduplicate results
    const combinedResults = [...results.results, ...similarResults]
      .filter(
        (item, index, self) => index === self.findIndex((t) => t.id === item.id)
      )
      .sort((a, b) => b.score - a.score)
      .slice(0, options.limit || 20);

    return {
      results: combinedResults,
      total: combinedResults.length,
      query: options.query || '',
      expanded: aiInsights ? [expandedQuery] : [],
      aiInsights,
    };
  }

  private async searchBoards(options: {
    query: string;
    userId?: string;
    limit: number;
    offset: number;
  }): Promise<SearchResult[]> {
    const { query, userId, limit, offset } = options;

    const conditions = [];

    if (query) {
      conditions.push(
        or(
          ilike(schema.boards.name, `%${query}%`),
          ilike(schema.boards.description, `%${query}%`),
          ilike(schema.boards.instructions, `%${query}%`)
        )
      );
    }

    // Visibility filter for non-user searches
    if (!userId) {
      conditions.push(eq(schema.boards.visibility, 'public'));
    }

    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;

    const results = await this.db
      .select({
        id: schema.boards.id,
        title: schema.boards.name,
        description: schema.boards.description,
        visibility: schema.boards.visibility,
        creatorId: schema.boards.creatorId,
        createdAt: schema.boards.createdAt,
        score: sql`0.8`,
      })
      .from(schema.boards)
      .where(whereClause)
      .orderBy(desc(schema.boards.updatedAt))
      .limit(limit)
      .offset(offset);

    return results.map((board) => ({
      ...board,
      description: board.description || undefined,
      type: 'board' as const,
      score: this.calculateScore(
        [board.title, board.description || ''].join(' '),
        query
      ),
      url: `/board/${board.id}`,
      metadata: {
        visibility: board.visibility,
        creatorId: board.creatorId,
      },
    }));
  }

  private async searchAssets(options: {
    query: string;
    userId?: string;
    boardId?: string;
    limit: number;
    offset: number;
  }): Promise<SearchResult[]> {
    const { query, userId, boardId, limit, offset } = options;

    const conditions = [];

    if (query) {
      conditions.push(
        or(
          ilike(schema.assets.name, `%${query}%`),
          ilike(schema.assets.metadata, `%${query}%`)
        )
      );
    }

    // Filter by specific board
    if (boardId) {
      conditions.push(eq(schema.boardAssets.boardId, boardId));
    }

    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;

    let queryBuilder = this.db
      .select({
        id: schema.assets.id,
        title: schema.assets.name,
        type: schema.assets.type,
        url: schema.assets.url,
        metadata: schema.assets.metadata,
        creatorId: schema.assets.creatorId,
        createdAt: schema.assets.createdAt,
        score: sql`0.9`,
      })
      .from(schema.assets)
      .where(whereClause);

    // Join with boardAssets if boardId is specified
    if (boardId) {
      queryBuilder = queryBuilder.innerJoin(
        schema.boardAssets,
        eq(schema.assets.id, schema.boardAssets.assetId)
      );
    }

    const results = await queryBuilder
      .orderBy(desc(schema.assets.createdAt))
      .limit(limit)
      .offset(offset);

    return results.map((asset) => ({
      ...asset,
      type: 'asset' as const,
      title: asset.title,
      description: asset.metadata?.description as string | undefined,
      score: this.calculateScore([asset.title].join(' '), query),
      url: asset.url,
      metadata: {
        assetType: asset.type,
        creatorId: asset.creatorId,
      },
    }));
  }

  private async searchUsers(options: {
    query: string;
    limit: number;
    offset: number;
  }): Promise<SearchResult[]> {
    const { query, limit, offset } = options;

    const results = await this.db
      .select({
        id: schema.users.id,
        title: sql`${schema.users.name} || ' (' || ${schema.users.username} || ')'`,
        username: schema.users.username,
        name: schema.users.name,
        bio: schema.users.bio,
        pfpUrl: schema.users.pfpUrl,
        score: sql`0.7`,
      })
      .from(schema.users)
      .where(
        or(
          ilike(schema.users.username, `%${query}%`),
          ilike(schema.users.name, `%${query}%`),
          ilike(schema.users.bio, `%${query}%`)
        )
      )
      .limit(limit)
      .offset(offset);

    return results.map((user) => ({
      ...user,
      title: user.name || user.username,
      type: 'user' as const,
      description: user.bio || undefined,
      score: this.calculateScore(
        [user.name || '', user.username, user.bio || ''].join(' '),
        query
      ),
      url: `/user/${user.username}`,
      metadata: {
        username: user.username,
        pfpUrl: user.pfpUrl,
      },
    }));
  }

  private async enhanceQuery(originalQuery: string): Promise<{
    expanded: string;
    insights: {
      relevantTopics: string[];
      searchIntent: string;
      suggestedFilters: string[];
    };
  }> {
    try {
      // Call Mastra AI service agent endpoint
      const response = await fetch(`${this.aiServiceUrl}/api/agents/search-enhancer/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [
            {
              role: 'user',
              content: `Enhance this search query: ${originalQuery}`
            }
          ],
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to enhance query');
      }

      const data = await response.json() as any;
      
      // Parse Mastra agent response format
      const responseText = data.text || '';
      let parsedResponse: any = {};
      
      try {
        // Try to extract JSON from the response if the agent returned structured data
        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          parsedResponse = JSON.parse(jsonMatch[0]);
        }
      } catch {
        // Fallback to basic parsing
        parsedResponse = {
          expandedQuery: responseText || originalQuery,
          insights: {
            relevantTopics: [],
            searchIntent: responseText.slice(0, 100),
            suggestedFilters: [],
          }
        };
      }
      
      return {
        expanded: parsedResponse.expandedQuery || originalQuery,
        insights: parsedResponse.insights || {
          relevantTopics: [],
          searchIntent: '',
          suggestedFilters: [],
        },
      };
    } catch (_error) {
      return {
        expanded: originalQuery,
        insights: {
          relevantTopics: [],
          searchIntent: '',
          suggestedFilters: [],
        },
      };
    }
  }

  private async findSimilarContent(
    _results: SearchResult[]
  ): Promise<SearchResult[]> {
    // This would use embeddings to find similar content
    // For now, return empty as this requires the AI service integration
    return [];
  }

  private calculateScore(content: string, query: string): number {
    if (!query) {
      return 0.5;
    }

    const contentLower = content.toLowerCase();
    const queryLower = query.toLowerCase();
    const queryWords = queryLower.split(' ').filter((w) => w.length > 2);

    let score = 0;
    let _matchCount = 0;

    // Calculate score based on word matches
    for (const word of queryWords) {
      if (contentLower.includes(word)) {
        _matchCount++;
        score += 1 / queryWords.length;
      }
    }

    // Bonus for exact phrase match
    if (contentLower.includes(queryLower)) {
      score += 0.5;
    }

    // Bonus for starting with the query
    if (contentLower.startsWith(queryLower)) {
      score += 0.3;
    }

    return Math.min(score, 1.0);
  }

  async saveSearchHistory(
    userId: string,
    query: string,
    expandedContext?: string,
    resultsSnapshot?: any
  ): Promise<string> {
    try {
      const [search] = await this.db
        .insert(schema.searches)
        .values({
          query,
          expandedContext,
          resultsSnapshot,
          newResultsCount: resultsSnapshot?.length || 0,
          userId,
        })
        .returning();

      return search.id;
    } catch (_error) {
      // Don't throw error as search history is not critical
      return '';
    }
  }

  async getSearchHistory(userId: string, limit = 20): Promise<any[]> {
    try {
      return await this.db
        .select({
          id: schema.searches.id,
          query: schema.searches.query,
          expandedContext: schema.searches.expandedContext,
          newResultsCount: schema.searches.newResultsCount,
          lastChecked: schema.searches.lastChecked,
          createdAt: schema.searches.createdAt,
        })
        .from(schema.searches)
        .where(eq(schema.searches.userId, userId))
        .orderBy(desc(schema.searches.createdAt))
        .limit(limit);
    } catch (_error) {
      return [];
    }
  }

  async checkSearchResults(
    searchId: string,
    userId: string
  ): Promise<{
    hasNewResults: boolean;
    newResultsCount: number;
    results: SearchResult[];
  }> {
    try {
      const search = await this.db
        .select()
        .from(schema.searches)
        .where(
          and(
            eq(schema.searches.id, searchId),
            eq(schema.searches.userId, userId)
          )
        )
        .limit(1);

      if (!search[0]) {
        throw notFound('Search not found');
      }

      // Re-run the search with the original query
      const results = await this.search({
        query: search[0].query,
        userId,
        limit: 50,
      });

      const newResultsCount =
        results.results.length - (search[0].newResultsCount || 0);

      // Update search record if new results found
      if (newResultsCount > 0) {
        await this.db
          .update(schema.searches)
          .set({
            newResultsCount: results.results.length,
            lastChecked: new Date(),
          })
          .where(eq(schema.searches.id, searchId));
      }

      return {
        hasNewResults: newResultsCount > 0,
        newResultsCount: Math.max(newResultsCount, 0),
        results: results.results.slice(0, 10), // Return top 10 new results
      };
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to check search results');
    }
  }
}
````

## File: packages/services/src/uploads.ts
````typescript
import { type DatabaseClient, eq, schema } from '@repo/database';
import { storage } from '@repo/storage';
import { ServiceError, notFound } from './lib/errors';

export interface StagedUpload {
  id: string;
  userId: string;
  type: 'image' | 'video' | 'audio' | 'gif' | 'text' | 'file';
  name: string;
  size: number;
  mimeType: string;
  storageKey?: string;
  presignedUrl?: string;
  status: 'pending' | 'uploading' | 'completed' | 'failed';
  metadata?: Record<string, any>;
  thumbnailUrl?: string;
  createdAt: Date;
  expiresAt: Date;
}

export class UploadService {
  constructor(private db: DatabaseClient, private env: any = {}) {}
  private stages = new Map<string, StagedUpload>();

  async stageUpload(
    userId: string,
    data: {
      name: string;
      type: 'image' | 'video' | 'audio' | 'gif' | 'text' | 'file';
      size: number;
      mimeType: string;
      metadata?: Record<string, any>;
    }
  ): Promise<StagedUpload> {
    const id = crypto.randomUUID();
    const now = new Date();
    const expiresAt = new Date(now.getTime() + 24 * 60 * 60 * 1000); // 24 hours

    // Create presigned upload URL
    const { url: presignedUrl, key: storageKey } =
      await storage.getPresignedUploadUrl(
        `uploads/${userId}/${data.type}`,
        data.mimeType
      );

    const staged: StagedUpload = {
      id,
      userId,
      ...data,
      storageKey,
      presignedUrl,
      status: 'pending',
      createdAt: now,
      expiresAt,
    };

    // Store in memory for now (can be moved to database for production)
    this.stages.set(id, staged);

    // Create database record
    await this.db.insert(schema.uploads).values({
      id,
      userId,
      storageKey,
      type: data.type,
      name: data.name,
      size: data.size,
      mimeType: data.mimeType,
      status: 'pending',
      metadata: data.metadata || {},
      expiresAt,
    });

    return staged;
  }

  async confirmUpload(
    stageId: string,
    userId: string
  ): Promise<{ key: string; url: string; thumbnailUrl?: string }> {
    const staged = this.stages.get(stageId);

    if (!staged || staged.userId !== userId) {
      throw notFound('Upload stage not found');
    }

    if (staged.status !== 'pending') {
      throw new ServiceError(
        'Upload already confirmed',
        400,
        'UPLOAD_ALREADY_CONFIRMED'
      );
    }

    if (new Date() > staged.expiresAt) {
      throw new ServiceError('Upload stage expired', 400, 'UPLOAD_EXPIRED');
    }

    try {
      // Verify the file exists in storage
      const file = await storage.get(staged.storageKey!);

      if (!file) {
        throw new ServiceError('File not found in storage', 404, 'UPLOAD_FAILED');
      }

      staged.status = 'completed';
      this.stages.delete(stageId);

      // Update database
      await this.db
        .update(schema.uploads)
        .set({ status: 'completed' })
        .where(eq(schema.uploads.id, stageId));

      // Generate thumbnail for images
      let thumbnailUrl;
      if (staged.type === 'image') {
        thumbnailUrl = await this.generateThumbnail(
          staged.storageKey!,
          staged.mimeType
        );
      }

      return {
        key: staged.storageKey!,
        url: file.url,
        thumbnailUrl,
      };
    } catch (_error) {
      staged.status = 'failed';
      throw new ServiceError('Failed to confirm upload', 500, 'UPLOAD_FAILED');
    }
  }

  async cancelUpload(stageId: string, userId: string): Promise<void> {
    const staged = this.stages.get(stageId);

    if (!staged || staged.userId !== userId) {
      throw notFound('Upload stage not found');
    }

    // Clean up storage if file exists
    if (staged.storageKey && staged.status === 'completed') {
      try {
        await storage.deleteFile(staged.storageKey);
      } catch (_error) {}
    }

    this.stages.delete(stageId);

    // Update database
    await this.db
      .update(schema.uploads)
      .set({ status: 'cancelled' })
      .where(eq(schema.uploads.id, stageId));
  }

  async getUploadProgress(
    userId: string,
    stageId?: string
  ): Promise<StagedUpload[]> {
    if (stageId) {
      const staged = this.stages.get(stageId);
      if (!staged || staged.userId !== userId) {
        throw notFound('Upload stage not found');
      }
      return [staged];
    }

    return Array.from(this.stages.values()).filter((s) => s.userId === userId);
  }

  async handleFileUpload(
    userId: string,
    file: File,
    _boardId?: string,
    onProgress?: (progress: {
      loaded: number;
      total: number;
      percentage: number;
    }) => void
  ): Promise<{
    id: string;
    type: 'image' | 'video' | 'audio' | 'gif' | 'text' | 'file';
    name: string;
    url: string;
    thumbnailUrl?: string;
    metadata: Record<string, any>;
  }> {
    // Validate file type
    const assetType = this.determineAssetType(file.type);

    // Stage the upload
    const staged = await this.stageUpload(userId, {
      name: file.name,
      type: assetType,
      size: file.size,
      mimeType: file.type,
      metadata: {
        originalName: file.name,
        lastModified: file.lastModified,
      },
    });

    // Upload the file
    staged.status = 'uploading';

    const _uploadedFile = await storage.uploadFile(
      `uploads/${userId}/${assetType}`,
      file,
      {
        onProgress,
        metadata: {
          userId,
          originalName: file.name,
          uploadId: staged.id,
        },
      }
    );

    // Confirm the upload
    const result = await this.confirmUpload(staged.id, userId);

    const assetData = {
      id: crypto.randomUUID(),
      type: assetType,
      name: file.name,
      url: result.url,
      thumbnailUrl: result.thumbnailUrl,
      storageKey: result.key,
      size: file.size,
      mimeType: file.type,
      metadata: staged.metadata || {},
    };

    return assetData;
  }

  private determineAssetType(
    mimeType: string
  ): 'image' | 'video' | 'audio' | 'gif' | 'text' | 'file' {
    if (mimeType.startsWith('image/')) {
      return mimeType === 'image/gif' ? 'gif' : 'image';
    }
    if (mimeType.startsWith('video/')) {
      return 'video';
    }
    if (mimeType.startsWith('audio/')) {
      return 'audio';
    }
    if (mimeType.startsWith('text/')) {
      return 'text';
    }
    return 'file';
  }

  private async generateThumbnail(
    key: string,
    _mimeType: string
  ): Promise<string> {
    // In a real implementation, this would use a service like Cloudinary or
    // generate thumbnails using a Lambda function/Edge function
    // For now, return theÂéüÂõæ URL
    const file = await storage.get(key);
    return file?.url || '';
  }
}
````

## File: packages/services/src/user.ts
````typescript
import { and, count, desc, eq, schema, type DatabaseClient } from '@repo/database';
import { ServiceError, internalError, notFound } from './lib/errors';

export class UserService {
  constructor(private db: DatabaseClient) {}

  async getUserById(userId: string) {
    try {
      const [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.id, userId))
        .limit(1);

      if (!user) {
        throw notFound('User not found');
      }

      // Get user's boards count
      const [boardCount] = await this.db
        .select({ count: count() })
        .from(schema.boards)
        .where(eq(schema.boards.creatorId, userId));

      // Get recent boards
      const recentBoards = await this.db
        .select({
          board: schema.boards,
        })
        .from(schema.boards)
        .where(eq(schema.boards.creatorId, userId))
        .orderBy(desc(schema.boards.updatedAt))
        .limit(10);

      // Get collaborations
      const collaborations = await this.db
        .select({
          board: schema.boards,
          accessLevel: schema.boardCollaborators.accessLevel,
          joinedAt: schema.boardCollaborators.createdAt,
        })
        .from(schema.boardCollaborators)
        .innerJoin(
          schema.boards,
          eq(schema.boardCollaborators.boardId, schema.boards.id)
        )
        .where(eq(schema.boardCollaborators.userId, userId))
        .orderBy(desc(schema.boardCollaborators.createdAt))
        .limit(10);

      return {
        ...user,
        stats: {
          boardsCreated: Number(boardCount?.count || 0),
          collaborations: collaborations.length,
        },
        recentBoards: recentBoards.map((r) => r.board),
        collaborations: collaborations.map((c) => ({
          ...c.board,
          accessLevel: c.accessLevel,
          joinedAt: c.joinedAt,
        })),
      };
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to get user');
    }
  }

  async getUserByUsername(username: string) {
    try {
      const [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.username, username))
        .limit(1);

      if (!user) {
        throw notFound('User not found');
      }

      return user;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to get user by username');
    }
  }

  async updateUser(
    userId: string,
    data: {
      username?: string;
      name?: string;
      bio?: string;
      location?: string;
      website?: string;
      pfpUrl?: string;
      pinned_columns?: any[];
      pronouns?: string[];
      show_pronouns?: boolean;
      gender?: string;
      country?: string;
      selected_profile_stat?: string;
    }
  ) {
    try {
      // Prepare update data, handling special fields
      const updateData: any = {
        updatedAt: new Date(),
      };

      // Map incoming field names to database column names
      if (data.username !== undefined) updateData.username = data.username;
      if (data.name !== undefined) updateData.name = data.name;
      if (data.bio !== undefined) updateData.bio = data.bio;
      if (data.location !== undefined) updateData.location = data.location;
      if (data.website !== undefined) updateData.website = data.website;
      if (data.pfpUrl !== undefined) updateData.pfpUrl = data.pfpUrl;
      if (data.pinned_columns !== undefined) updateData.pinnedColumns = data.pinned_columns;
      if (data.pronouns !== undefined) updateData.pronouns = data.pronouns;
      if (data.show_pronouns !== undefined) updateData.showPronouns = data.show_pronouns;
      if (data.gender !== undefined) updateData.gender = data.gender;
      if (data.country !== undefined) updateData.country = data.country;
      if (data.selected_profile_stat !== undefined) updateData.selectedProfileStat = data.selected_profile_stat;

      const [updatedUser] = await this.db
        .update(schema.users)
        .set(updateData)
        .where(eq(schema.users.id, userId))
        .returning();

      if (!updatedUser) {
        throw notFound('User not found');
      }

      return updatedUser;
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to update user');
    }
  }

  async deleteUser(userId: string) {
    try {
      // Delete user's boards
      await this.db
        .delete(schema.boards)
        .where(eq(schema.boards.creatorId, userId));

      // Delete user's assets
      await this.db
        .delete(schema.assets)
        .where(eq(schema.assets.creatorId, userId));

      // Delete user
      const [deletedUser] = await this.db
        .delete(schema.users)
        .where(eq(schema.users.id, userId))
        .returning();

      if (!deletedUser) {
        throw notFound('User not found');
      }

      return { success: true };
    } catch (error) {
      if (error instanceof ServiceError) {
        throw error;
      }
      throw internalError('Failed to delete user');
    }
  }

  async getUserStats(userId: string) {
    try {
      const [boardStats] = await this.db
        .select({ count: count() })
        .from(schema.boards)
        .where(eq(schema.boards.creatorId, userId));

      const [assetStats] = await this.db
        .select({ count: count() })
        .from(schema.assets)
        .where(eq(schema.assets.creatorId, userId));

      const [collaborationStats] = await this.db
        .select({ count: count() })
        .from(schema.boardCollaborators)
        .where(eq(schema.boardCollaborators.userId, userId));

      return {
        boardsCreated: Number(boardStats?.count || 0),
        assetsCreated: Number(assetStats?.count || 0),
        collaborations: Number(collaborationStats?.count || 0),
        joinedAt: new Date(), // Would need to fetch from user record
      };
    } catch (error) {
      throw internalError('Failed to get user stats');
    }
  }
}
````

## File: packages/services/CLAUDE.md
````markdown
# @repo/services Package Context

## Development Standards

### Package Context
This package provides business logic services for the Squish ecosystem. It includes domain services for assets, boards, users, and other core features, maintaining separation between business logic and presentation layers.

### Technology Stack
- **TypeScript**: 5.7+ strict configuration
- **Zod**: Input validation
- **Drizzle ORM**: Data access
- Custom service architecture

### Package Structure
```
src/
‚îú‚îÄ‚îÄ index.ts            # Main exports
‚îú‚îÄ‚îÄ asset/              # Asset business logic
‚îú‚îÄ‚îÄ board/              # Board business logic
‚îú‚îÄ‚îÄ user/               # User business logic
‚îú‚îÄ‚îÄ search/             # Search business logic
‚îî‚îÄ‚îÄ common/             # Common service utilities
```

## Service Patterns
- Domain-driven design
- Input validation
- Error handling patterns
- Data transformation
- Business rule enforcement

## Files to Know
- `src/asset/index.ts` - Asset service
- `src/board/index.ts` - Board service

## Quality Checklist
- [ ] Business logic isolated
- [ ] Validation complete
- [ ] Error handling proper
- [ ] No circular dependencies

---
EOF < /dev/null
````

## File: packages/services/package.json
````json
{
  "name": "@repo/services",
  "version": "0.0.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:unit": "VITEST_MODE=unit vitest run src/__tests__/*.test.ts src/__tests__/factories/*.test.ts",
    "test:integration": "VITEST_MODE=integration vitest run src/__tests__/integration/*.test.ts",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest watch"
  },
  "dependencies": {
    "@repo/database": "workspace:*",
    "@repo/storage": "workspace:*",
    "@repo/auth": "workspace:*",
    "@repo/notifications": "workspace:*",
    "@repo/collaboration": "workspace:*",
    "@orpc/server": "^1.7.5",
    "zod": "^3.25.28"
  },
  "devDependencies": {
    "@faker-js/faker": "^9.3.0",
    "@repo/testing": "workspace:*",
    "@repo/typescript-config": "workspace:*",
    "@types/node": "^22.14.1",
    "@vitest/coverage-v8": "^3.1.4",
    "@vitest/ui": "^3.1.4",
    "typescript": "^5.8.3",
    "vitest": "^3.1.4"
  }
}
````

## File: packages/services/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "lib": ["ES2021"],
    "target": "ES2021",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src"],
  "exclude": ["node_modules"]
}
````

## File: packages/services/vitest.config.ts
````typescript
import path from 'node:path';
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'node',
    globals: true,
    setupFiles: ['./src/__tests__/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        '*.config.ts',
        '**/*.d.ts',
        '**/__tests__/**',
        '**/types/**',
      ],
    },
    include: ['src/**/__tests__/**/*.test.ts', 'src/**/*.test.ts'],
    exclude: ['node_modules', 'dist'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@repo': path.resolve(__dirname, '../../packages'),
    },
  },
});
````

## File: packages/storage/.cache/tsbuildinfo.json
````json
{
  "fileNames": [
    "../node_modules/typescript/lib/lib.es5.d.ts",
    "../node_modules/typescript/lib/lib.es2015.d.ts",
    "../node_modules/typescript/lib/lib.es2016.d.ts",
    "../node_modules/typescript/lib/lib.es2017.d.ts",
    "../node_modules/typescript/lib/lib.es2018.d.ts",
    "../node_modules/typescript/lib/lib.es2019.d.ts",
    "../node_modules/typescript/lib/lib.es2020.d.ts",
    "../node_modules/typescript/lib/lib.es2021.d.ts",
    "../node_modules/typescript/lib/lib.es2022.d.ts",
    "../node_modules/typescript/lib/lib.dom.d.ts",
    "../node_modules/typescript/lib/lib.dom.iterable.d.ts",
    "../node_modules/typescript/lib/lib.es2015.core.d.ts",
    "../node_modules/typescript/lib/lib.es2015.collection.d.ts",
    "../node_modules/typescript/lib/lib.es2015.generator.d.ts",
    "../node_modules/typescript/lib/lib.es2015.iterable.d.ts",
    "../node_modules/typescript/lib/lib.es2015.promise.d.ts",
    "../node_modules/typescript/lib/lib.es2015.proxy.d.ts",
    "../node_modules/typescript/lib/lib.es2015.reflect.d.ts",
    "../node_modules/typescript/lib/lib.es2015.symbol.d.ts",
    "../node_modules/typescript/lib/lib.es2015.symbol.wellknown.d.ts",
    "../node_modules/typescript/lib/lib.es2016.array.include.d.ts",
    "../node_modules/typescript/lib/lib.es2016.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2017.arraybuffer.d.ts",
    "../node_modules/typescript/lib/lib.es2017.date.d.ts",
    "../node_modules/typescript/lib/lib.es2017.object.d.ts",
    "../node_modules/typescript/lib/lib.es2017.sharedmemory.d.ts",
    "../node_modules/typescript/lib/lib.es2017.string.d.ts",
    "../node_modules/typescript/lib/lib.es2017.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2017.typedarrays.d.ts",
    "../node_modules/typescript/lib/lib.es2018.asyncgenerator.d.ts",
    "../node_modules/typescript/lib/lib.es2018.asynciterable.d.ts",
    "../node_modules/typescript/lib/lib.es2018.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2018.promise.d.ts",
    "../node_modules/typescript/lib/lib.es2018.regexp.d.ts",
    "../node_modules/typescript/lib/lib.es2019.array.d.ts",
    "../node_modules/typescript/lib/lib.es2019.object.d.ts",
    "../node_modules/typescript/lib/lib.es2019.string.d.ts",
    "../node_modules/typescript/lib/lib.es2019.symbol.d.ts",
    "../node_modules/typescript/lib/lib.es2019.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2020.bigint.d.ts",
    "../node_modules/typescript/lib/lib.es2020.date.d.ts",
    "../node_modules/typescript/lib/lib.es2020.promise.d.ts",
    "../node_modules/typescript/lib/lib.es2020.sharedmemory.d.ts",
    "../node_modules/typescript/lib/lib.es2020.string.d.ts",
    "../node_modules/typescript/lib/lib.es2020.symbol.wellknown.d.ts",
    "../node_modules/typescript/lib/lib.es2020.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2020.number.d.ts",
    "../node_modules/typescript/lib/lib.es2021.promise.d.ts",
    "../node_modules/typescript/lib/lib.es2021.string.d.ts",
    "../node_modules/typescript/lib/lib.es2021.weakref.d.ts",
    "../node_modules/typescript/lib/lib.es2021.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2022.array.d.ts",
    "../node_modules/typescript/lib/lib.es2022.error.d.ts",
    "../node_modules/typescript/lib/lib.es2022.intl.d.ts",
    "../node_modules/typescript/lib/lib.es2022.object.d.ts",
    "../node_modules/typescript/lib/lib.es2022.string.d.ts",
    "../node_modules/typescript/lib/lib.es2022.regexp.d.ts",
    "../node_modules/typescript/lib/lib.decorators.d.ts",
    "../node_modules/typescript/lib/lib.decorators.legacy.d.ts",
    "../../../node_modules/@smithy/types/dist-types/abort-handler.d.ts",
    "../../../node_modules/@smithy/types/dist-types/abort.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/auth.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/httpapikeyauth.d.ts",
    "../../../node_modules/@smithy/types/dist-types/identity/identity.d.ts",
    "../../../node_modules/@smithy/types/dist-types/response.d.ts",
    "../../../node_modules/@smithy/types/dist-types/command.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoint.d.ts",
    "../../../node_modules/@smithy/types/dist-types/feature-ids.d.ts",
    "../../../node_modules/@smithy/types/dist-types/logger.d.ts",
    "../../../node_modules/@smithy/types/dist-types/uri.d.ts",
    "../../../node_modules/@smithy/types/dist-types/http.d.ts",
    "../../../node_modules/@smithy/types/dist-types/util.d.ts",
    "../../../node_modules/@smithy/types/dist-types/middleware.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/httpsigner.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/identityproviderconfig.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/httpauthscheme.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/httpauthschemeprovider.d.ts",
    "../../../node_modules/@smithy/types/dist-types/auth/index.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transform/exact.d.ts",
    "../../../node_modules/@smithy/types/dist-types/externals-check/browser-externals-check.d.ts",
    "../../../node_modules/@smithy/types/dist-types/blob/blob-payload-input-types.d.ts",
    "../../../node_modules/@smithy/types/dist-types/crypto.d.ts",
    "../../../node_modules/@smithy/types/dist-types/checksum.d.ts",
    "../../../node_modules/@smithy/types/dist-types/client.d.ts",
    "../../../node_modules/@smithy/types/dist-types/connection/config.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transfer.d.ts",
    "../../../node_modules/@smithy/types/dist-types/connection/manager.d.ts",
    "../../../node_modules/@smithy/types/dist-types/connection/pool.d.ts",
    "../../../node_modules/@smithy/types/dist-types/connection/index.d.ts",
    "../../../node_modules/@smithy/types/dist-types/eventstream.d.ts",
    "../../../node_modules/@smithy/types/dist-types/encode.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoints/shared.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoints/endpointruleobject.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoints/errorruleobject.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoints/treeruleobject.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoints/rulesetobject.d.ts",
    "../../../node_modules/@smithy/types/dist-types/endpoints/index.d.ts",
    "../../../node_modules/@smithy/types/dist-types/extensions/checksum.d.ts",
    "../../../node_modules/@smithy/types/dist-types/extensions/defaultclientconfiguration.d.ts",
    "../../../node_modules/@smithy/types/dist-types/shapes.d.ts",
    "../../../node_modules/@smithy/types/dist-types/retry.d.ts",
    "../../../node_modules/@smithy/types/dist-types/extensions/retry.d.ts",
    "../../../node_modules/@smithy/types/dist-types/extensions/defaultextensionconfiguration.d.ts",
    "../../../node_modules/@smithy/types/dist-types/extensions/index.d.ts",
    "../../../node_modules/@smithy/types/dist-types/http/httphandlerinitialization.d.ts",
    "../../../node_modules/@smithy/types/dist-types/identity/apikeyidentity.d.ts",
    "../../../node_modules/@smithy/types/dist-types/identity/awscredentialidentity.d.ts",
    "../../../node_modules/@smithy/types/dist-types/identity/tokenidentity.d.ts",
    "../../../node_modules/@smithy/types/dist-types/identity/index.d.ts",
    "../../../node_modules/@smithy/types/dist-types/pagination.d.ts",
    "../../../node_modules/@smithy/types/dist-types/profile.d.ts",
    "../../../node_modules/@smithy/types/dist-types/serde.d.ts",
    "../../../node_modules/@smithy/types/dist-types/schema/sentinels.d.ts",
    "../../../node_modules/@smithy/types/dist-types/schema/traits.d.ts",
    "../../../node_modules/@smithy/types/dist-types/schema/schema.d.ts",
    "../../../node_modules/@smithy/types/dist-types/signature.d.ts",
    "../../../node_modules/@smithy/types/dist-types/stream.d.ts",
    "../../../node_modules/@smithy/types/dist-types/streaming-payload/streaming-blob-common-types.d.ts",
    "../../../node_modules/@smithy/types/dist-types/streaming-payload/streaming-blob-payload-input-types.d.ts",
    "../../../node_modules/@smithy/types/dist-types/streaming-payload/streaming-blob-payload-output-types.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transform/type-transform.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transform/client-method-transforms.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transform/client-payload-blob-type-narrow.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transform/mutable.d.ts",
    "../../../node_modules/@smithy/types/dist-types/transform/no-undefined.d.ts",
    "../../../node_modules/@smithy/types/dist-types/waiter.d.ts",
    "../../../node_modules/@smithy/types/dist-types/index.d.ts",
    "../../../node_modules/@smithy/node-config-provider/dist-types/fromenv.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/gethomedir.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/getprofilename.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/getssotokenfilepath.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/getssotokenfromfile.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/loadsharedconfigfiles.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/loadssosessiondata.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/parseknownfiles.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/types.d.ts",
    "../../../node_modules/@smithy/shared-ini-file-loader/dist-types/index.d.ts",
    "../../../node_modules/@smithy/node-config-provider/dist-types/fromsharedconfigfiles.d.ts",
    "../../../node_modules/@smithy/node-config-provider/dist-types/fromstatic.d.ts",
    "../../../node_modules/@smithy/node-config-provider/dist-types/configloader.d.ts",
    "../../../node_modules/@smithy/node-config-provider/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/constants.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/node_request_checksum_calculation_config_options.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/node_response_checksum_validation_config_options.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/crc64-nvme-crt-container.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/configuration.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/flexiblechecksumsmiddleware.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/flexiblechecksumsinputmiddleware.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/flexiblechecksumsresponsemiddleware.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/getflexiblechecksumsplugin.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/resolveflexiblechecksumsconfig.d.ts",
    "../../../node_modules/@aws-sdk/middleware-flexible-checksums/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/middleware-host-header/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/check-content-length-header.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/region-redirect-middleware.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/region-redirect-endpoint-middleware.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-expires-middleware.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/abort.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/auth.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/blob/blob-types.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/checksum.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/client.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/command.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/connection.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/identity/identity.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/identity/anonymousidentity.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/feature-ids.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/identity/awscredentialidentity.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/identity/loginidentity.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/identity/tokenidentity.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/identity/index.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/util.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/credentials.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/crypto.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/dns.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/encode.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/endpoint.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/eventstream.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/extensions/index.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/function.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/http.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/logger.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/middleware.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/pagination.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/profile.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/request.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/response.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/retry.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/serde.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/shapes.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/signature.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/stream.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/token.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/transfer.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/uri.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/waiter.d.ts",
    "../../../node_modules/@aws-sdk/types/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/interfaces/s3expressidentity.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/classes/s3expressidentitycacheentry.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/classes/s3expressidentitycache.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/interfaces/s3expressidentityprovider.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/classes/s3expressidentityproviderimpl.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/signaturev4base.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/signaturev4.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/constants.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/getcanonicalheaders.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/getcanonicalquery.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/getpayloadhash.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/moveheaderstoquery.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/preparerequest.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/credentialderivation.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/headerutil.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/signature-v4a-container.d.ts",
    "../../../node_modules/@smithy/signature-v4/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/classes/signaturev4s3express.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/constants.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/functions/s3expressmiddleware.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/httprequest.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/httpresponse.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/httphandler.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/extensions/httpextensionconfiguration.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/extensions/index.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/field.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/fields.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/isvalidhostname.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/types.d.ts",
    "../../../node_modules/@smithy/protocol-http/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/functions/s3expresshttpsigningmiddleware.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3-express/index.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/s3configuration.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/throw-200-exceptions.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/validate-bucket-name.d.ts",
    "../../../node_modules/@aws-sdk/middleware-sdk-s3/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/middleware-user-agent/dist-types/configurations.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/middleware-user-agent/dist-types/user-agent-middleware.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/middleware-user-agent/dist-types/index.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/endpointsconfig/nodeusedualstackendpointconfigoptions.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/endpointsconfig/nodeusefipsendpointconfigoptions.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/endpointsconfig/resolveendpointsconfig.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/endpointsconfig/resolvecustomendpointsconfig.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/endpointsconfig/index.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regionconfig/config.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regionconfig/resolveregionconfig.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regionconfig/index.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regioninfo/endpointvarianttag.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regioninfo/endpointvariant.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regioninfo/partitionhash.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regioninfo/regionhash.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regioninfo/getregioninfo.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/regioninfo/index.d.ts",
    "../../../node_modules/@smithy/config-resolver/dist-types/index.d.ts",
    "../../../node_modules/@smithy/eventstream-serde-config-resolver/dist-types/eventstreamserdeconfig.d.ts",
    "../../../node_modules/@smithy/eventstream-serde-config-resolver/dist-types/index.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/resolveendpointconfig.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/types.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/adaptors/getendpointfrominstructions.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/adaptors/toendpointv1.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/adaptors/index.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/endpointmiddleware.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/getendpointplugin.d.ts",
    "../../../node_modules/@smithy/middleware-endpoint/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/types.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/adaptiveretrystrategy.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/standardretrystrategy.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/configuredretrystrategy.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/defaultratelimiter.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/config.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/constants.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-retry/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/types.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/standardretrystrategy.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/adaptiveretrystrategy.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/configurations.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/delaydecider.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/omitretryheadersmiddleware.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/retrydecider.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/retrymiddleware.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/middleware-retry/dist-types/index.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/client.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/blob/uint8arrayblobadapter.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/checksum/checksumstream.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/checksum/checksumstream.browser.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/checksum/createchecksumstream.browser.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/checksum/createchecksumstream.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/createbufferedreadable.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/getawschunkedencodingstream.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/headstream.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/sdk-stream-mixin.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/splitstream.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/stream-type-check.d.ts",
    "../../../node_modules/@smithy/util-stream/dist-types/index.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/collect-stream-body.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/extended-encode-uri-component.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/deref.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/middleware/schema-middleware-types.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/middleware/getschemaserdeplugin.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/schema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/listschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/mapschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/operationschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/structureschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/errorschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/normalizedschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/simpleschema.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/schemas/sentinels.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/typeregistry.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/schema/index.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/httpprotocol.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/httpbindingprotocol.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/rpcprotocol.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/requestbuilder.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/resolve-path.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/serde/fromstringshapedeserializer.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/serde/httpinterceptingshapedeserializer.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/serde/tostringshapeserializer.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/serde/httpinterceptingshapeserializer.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/serde/determinetimestampformat.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/protocols/index.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/collect-stream-body.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/command.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/constants.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/create-aggregated-client.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/default-error-handler.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/defaults-mode.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/emitwarningifunsupportedversion.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/exceptions.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/extended-encode-uri-component.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/extensions/checksum.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/extensions/retry.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/extensions/defaultextensionconfiguration.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/extensions/index.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/get-array-if-single-item.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/get-value-from-text-node.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/is-serializable-header-value.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/nooplogger.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/object-mapping.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/resolve-path.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/ser-utils.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/serde-json.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/copydocumentwithtransform.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/date-utils.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/lazy-json.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/parse-utils.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/quote-header.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/split-every.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/split-header.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/value/numericvalue.d.ts",
    "../../../node_modules/@smithy/smithy-client/node_modules/@smithy/core/dist-types/submodules/serde/index.d.ts",
    "../../../node_modules/@smithy/smithy-client/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/client/emitwarningifunsupportedversion.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/client/setcredentialfeature.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/client/setfeature.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/client/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/aws_sdk/resolveawssdksigv4aconfig.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/aws_sdk/awssdksigv4signer.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/aws_sdk/awssdksigv4asigner.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/aws_sdk/node_auth_scheme_preference_options.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/aws_sdk/resolveawssdksigv4config.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/aws_sdk/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/utils/getbearertokenenvkey.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/httpauthschemes/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/coercing-serializers.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/core/dist-types/submodules/protocols/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/configurableserdecontext.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/jsonshapedeserializer.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/jsonshapeserializer.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/jsoncodec.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/awsjsonrpcprotocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/awsjson1_0protocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/awsjson1_1protocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/awsrestjsonprotocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/awsexpectunion.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/json/parsejsonbody.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/xml/xmlshapeserializer.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/xml/xmlcodec.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/xml/xmlshapedeserializer.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/query/queryserializersettings.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/query/queryshapeserializer.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/query/awsqueryprotocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/query/awsec2queryprotocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/core/dist-types/submodules/schema/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/xml/awsrestxmlprotocol.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/xml/parsexmlbody.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/submodules/protocols/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@aws-sdk/core/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/endpoint/endpointparameters.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/auth/httpauthschemeprovider.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/models/s3serviceexception.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/models/models_0.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/abortmultipartuploadcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/completemultipartuploadcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/copyobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/createbucketcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/createbucketmetadatatableconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/createmultipartuploadcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/createsessioncommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketanalyticsconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketcorscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketencryptioncommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketintelligenttieringconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketinventoryconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketlifecyclecommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketmetadatatableconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketmetricsconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketownershipcontrolscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketpolicycommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketreplicationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebuckettaggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletebucketwebsitecommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deleteobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deleteobjectscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deleteobjecttaggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/deletepublicaccessblockcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketaccelerateconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketaclcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketanalyticsconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketcorscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketencryptioncommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketintelligenttieringconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketinventoryconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketlifecycleconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketlocationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketloggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketmetadatatableconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketmetricsconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketnotificationconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketownershipcontrolscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketpolicycommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketpolicystatuscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketreplicationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketrequestpaymentcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbuckettaggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketversioningcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getbucketwebsitecommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjectaclcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjectattributescommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjectlegalholdcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjectlockconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjectretentioncommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjecttaggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getobjecttorrentcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/getpublicaccessblockcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/headbucketcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/headobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listbucketanalyticsconfigurationscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listbucketintelligenttieringconfigurationscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listbucketinventoryconfigurationscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listbucketmetricsconfigurationscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listbucketscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listdirectorybucketscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listmultipartuploadscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listobjectscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listobjectsv2command.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listobjectversionscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/listpartscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketaccelerateconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketaclcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketanalyticsconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/models/models_1.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketcorscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketencryptioncommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketintelligenttieringconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketinventoryconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketlifecycleconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketloggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketmetricsconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketnotificationconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketownershipcontrolscommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketpolicycommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketreplicationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketrequestpaymentcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbuckettaggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketversioningcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putbucketwebsitecommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putobjectaclcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putobjectlegalholdcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putobjectlockconfigurationcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putobjectretentioncommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putobjecttaggingcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/putpublicaccessblockcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/renameobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/restoreobjectcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/selectobjectcontentcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/uploadpartcommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/uploadpartcopycommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/writegetobjectresponsecommand.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/auth/httpauthextensionconfiguration.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/extensionconfiguration.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/runtimeextensions.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/s3client.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/s3.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/commands/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/pagination/interfaces.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/pagination/listbucketspaginator.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/pagination/listdirectorybucketspaginator.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/pagination/listobjectsv2paginator.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/pagination/listpartspaginator.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/pagination/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-waiter/dist-types/waiter.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-waiter/dist-types/createwaiter.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/node_modules/@smithy/util-waiter/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/waiters/waitforbucketexists.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/waiters/waitforbucketnotexists.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/waiters/waitforobjectexists.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/waiters/waitforobjectnotexists.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/waiters/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/models/index.d.ts",
    "../../../node_modules/@aws-sdk/client-s3/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/s3-request-presigner/dist-types/getsignedurl.d.ts",
    "../../../node_modules/@aws-sdk/signature-v4-multi-region/dist-types/signaturev4multiregion.d.ts",
    "../../../node_modules/@aws-sdk/signature-v4-multi-region/dist-types/signature-v4-crt-container.d.ts",
    "../../../node_modules/@aws-sdk/signature-v4-multi-region/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/s3-request-presigner/dist-types/presigner.d.ts",
    "../../../node_modules/@aws-sdk/s3-request-presigner/dist-types/index.d.ts",
    "../../../node_modules/@aws-sdk/lib-storage/dist-types/types.d.ts",
    "../../../node_modules/@aws-sdk/lib-storage/dist-types/upload.d.ts",
    "../../../node_modules/@aws-sdk/lib-storage/dist-types/index.d.ts",
    "../src/types.ts",
    "../../logger/index.ts",
    "../src/providers/s3.ts",
    "../src/providers/r2.ts",
    "../../../node_modules/buffer/index.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/header.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/readable.d.ts",
    "../node_modules/@types/node/compatibility/disposable.d.ts",
    "../node_modules/@types/node/compatibility/indexable.d.ts",
    "../node_modules/@types/node/compatibility/iterators.d.ts",
    "../node_modules/@types/node/compatibility/index.d.ts",
    "../node_modules/@types/node/globals.typedarray.d.ts",
    "../node_modules/@types/node/buffer.buffer.d.ts",
    "../../../node_modules/undici-types/header.d.ts",
    "../../../node_modules/undici-types/readable.d.ts",
    "../../../node_modules/undici-types/file.d.ts",
    "../../../node_modules/undici-types/fetch.d.ts",
    "../../../node_modules/undici-types/formdata.d.ts",
    "../../../node_modules/undici-types/connector.d.ts",
    "../../../node_modules/undici-types/client.d.ts",
    "../../../node_modules/undici-types/errors.d.ts",
    "../../../node_modules/undici-types/dispatcher.d.ts",
    "../../../node_modules/undici-types/global-dispatcher.d.ts",
    "../../../node_modules/undici-types/global-origin.d.ts",
    "../../../node_modules/undici-types/pool-stats.d.ts",
    "../../../node_modules/undici-types/pool.d.ts",
    "../../../node_modules/undici-types/handlers.d.ts",
    "../../../node_modules/undici-types/balanced-pool.d.ts",
    "../../../node_modules/undici-types/agent.d.ts",
    "../../../node_modules/undici-types/mock-interceptor.d.ts",
    "../../../node_modules/undici-types/mock-agent.d.ts",
    "../../../node_modules/undici-types/mock-client.d.ts",
    "../../../node_modules/undici-types/mock-pool.d.ts",
    "../../../node_modules/undici-types/mock-errors.d.ts",
    "../../../node_modules/undici-types/proxy-agent.d.ts",
    "../../../node_modules/undici-types/env-http-proxy-agent.d.ts",
    "../../../node_modules/undici-types/retry-handler.d.ts",
    "../../../node_modules/undici-types/retry-agent.d.ts",
    "../../../node_modules/undici-types/api.d.ts",
    "../../../node_modules/undici-types/interceptors.d.ts",
    "../../../node_modules/undici-types/util.d.ts",
    "../../../node_modules/undici-types/cookies.d.ts",
    "../../../node_modules/undici-types/patch.d.ts",
    "../../../node_modules/undici-types/websocket.d.ts",
    "../../../node_modules/undici-types/eventsource.d.ts",
    "../../../node_modules/undici-types/filereader.d.ts",
    "../../../node_modules/undici-types/diagnostics-channel.d.ts",
    "../../../node_modules/undici-types/content-type.d.ts",
    "../../../node_modules/undici-types/cache.d.ts",
    "../../../node_modules/undici-types/index.d.ts",
    "../node_modules/@types/node/globals.d.ts",
    "../node_modules/@types/node/assert.d.ts",
    "../node_modules/@types/node/assert/strict.d.ts",
    "../node_modules/@types/node/async_hooks.d.ts",
    "../node_modules/@types/node/buffer.d.ts",
    "../node_modules/@types/node/child_process.d.ts",
    "../node_modules/@types/node/cluster.d.ts",
    "../node_modules/@types/node/console.d.ts",
    "../node_modules/@types/node/constants.d.ts",
    "../node_modules/@types/node/crypto.d.ts",
    "../node_modules/@types/node/dgram.d.ts",
    "../node_modules/@types/node/diagnostics_channel.d.ts",
    "../node_modules/@types/node/dns.d.ts",
    "../node_modules/@types/node/dns/promises.d.ts",
    "../node_modules/@types/node/domain.d.ts",
    "../node_modules/@types/node/dom-events.d.ts",
    "../node_modules/@types/node/events.d.ts",
    "../node_modules/@types/node/fs.d.ts",
    "../node_modules/@types/node/fs/promises.d.ts",
    "../node_modules/@types/node/http.d.ts",
    "../node_modules/@types/node/http2.d.ts",
    "../node_modules/@types/node/https.d.ts",
    "../node_modules/@types/node/inspector.d.ts",
    "../node_modules/@types/node/module.d.ts",
    "../node_modules/@types/node/net.d.ts",
    "../node_modules/@types/node/os.d.ts",
    "../node_modules/@types/node/path.d.ts",
    "../node_modules/@types/node/perf_hooks.d.ts",
    "../node_modules/@types/node/process.d.ts",
    "../node_modules/@types/node/punycode.d.ts",
    "../node_modules/@types/node/querystring.d.ts",
    "../node_modules/@types/node/readline.d.ts",
    "../node_modules/@types/node/readline/promises.d.ts",
    "../node_modules/@types/node/repl.d.ts",
    "../node_modules/@types/node/sea.d.ts",
    "../node_modules/@types/node/sqlite.d.ts",
    "../node_modules/@types/node/stream.d.ts",
    "../node_modules/@types/node/stream/promises.d.ts",
    "../node_modules/@types/node/stream/consumers.d.ts",
    "../node_modules/@types/node/stream/web.d.ts",
    "../node_modules/@types/node/string_decoder.d.ts",
    "../node_modules/@types/node/test.d.ts",
    "../node_modules/@types/node/timers.d.ts",
    "../node_modules/@types/node/timers/promises.d.ts",
    "../node_modules/@types/node/tls.d.ts",
    "../node_modules/@types/node/trace_events.d.ts",
    "../node_modules/@types/node/tty.d.ts",
    "../node_modules/@types/node/url.d.ts",
    "../node_modules/@types/node/util.d.ts",
    "../node_modules/@types/node/v8.d.ts",
    "../node_modules/@types/node/vm.d.ts",
    "../node_modules/@types/node/wasi.d.ts",
    "../node_modules/@types/node/worker_threads.d.ts",
    "../node_modules/@types/node/zlib.d.ts",
    "../node_modules/@types/node/index.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/file.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/fetch.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/formdata.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/connector.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/client.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/errors.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/dispatcher.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/global-dispatcher.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/global-origin.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/pool-stats.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/pool.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/handlers.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/balanced-pool.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/agent.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/mock-interceptor.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/mock-agent.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/mock-client.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/mock-pool.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/mock-errors.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/proxy-agent.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/retry-handler.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/api.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/cookies.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/patch.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/filereader.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/diagnostics-channel.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/websocket.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/content-type.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/cache.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/interceptors.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/types/index.d.ts",
    "../../../node_modules/@vercel/blob/node_modules/undici/index.d.ts",
    "../../../node_modules/@vercel/blob/dist/create-folder-c02efepe.d.ts",
    "../../../node_modules/@vercel/blob/dist/index.d.ts",
    "../src/providers/vercel-blob.ts",
    "../../../node_modules/gaxios/build/src/common.d.ts",
    "../../../node_modules/gaxios/build/src/interceptor.d.ts",
    "../../../node_modules/gaxios/build/src/gaxios.d.ts",
    "../../../node_modules/gaxios/build/src/index.d.ts",
    "../../../node_modules/google-auth-library/build/src/transporters.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/credentials.d.ts",
    "../../../node_modules/google-auth-library/build/src/crypto/crypto.d.ts",
    "../../../node_modules/google-auth-library/build/src/util.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/authclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/loginticket.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/oauth2client.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/idtokenclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/envdetect.d.ts",
    "../../../node_modules/gtoken/build/src/index.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/jwtclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/refreshclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/impersonated.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/baseexternalclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/identitypoolclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/awsrequestsigner.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/awsclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/pluggable-auth-client.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/externalclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/externalaccountauthorizeduserclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/googleauth.d.ts",
    "../../../node_modules/gcp-metadata/build/src/gcp-residency.d.ts",
    "../../../node_modules/gcp-metadata/build/src/index.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/computeclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/iam.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/jwtaccess.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/downscopedclient.d.ts",
    "../../../node_modules/google-auth-library/build/src/auth/passthrough.d.ts",
    "../../../node_modules/google-auth-library/build/src/index.d.ts",
    "../../../node_modules/teeny-request/build/src/teenystatistics.d.ts",
    "../../../node_modules/teeny-request/build/src/index.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/nodejs-common/util.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/nodejs-common/service-object.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/nodejs-common/service.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/nodejs-common/index.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/acl.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/channel.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/resumable-upload.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/signer.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/crc32c.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/file.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/iam.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/notification.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/bucket.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/hmackey.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/storage.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/hash-stream-validator.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/transfer-manager.d.ts",
    "../../../node_modules/@google-cloud/storage/build/esm/src/index.d.ts",
    "../src/providers/gcs.ts",
    "../src/manager.ts",
    "../node_modules/sharp/lib/index.d.ts",
    "../src/utils/file-processor.ts",
    "../index.ts",
    "../../../node_modules/@t3-oss/env-core/dist/index.d.ts",
    "../../../node_modules/zod/dist/esm/v3/helpers/typealiases.d.ts",
    "../../../node_modules/zod/dist/esm/v3/helpers/util.d.ts",
    "../../../node_modules/zod/dist/esm/v3/zoderror.d.ts",
    "../../../node_modules/zod/dist/esm/v3/locales/en.d.ts",
    "../../../node_modules/zod/dist/esm/v3/errors.d.ts",
    "../../../node_modules/zod/dist/esm/v3/helpers/parseutil.d.ts",
    "../../../node_modules/zod/dist/esm/v3/helpers/enumutil.d.ts",
    "../../../node_modules/zod/dist/esm/v3/helpers/errorutil.d.ts",
    "../../../node_modules/zod/dist/esm/v3/helpers/partialutil.d.ts",
    "../../../node_modules/zod/dist/esm/v3/standard-schema.d.ts",
    "../../../node_modules/zod/dist/esm/v3/types.d.ts",
    "../../../node_modules/zod/dist/esm/v3/external.d.ts",
    "../../../node_modules/zod/dist/esm/v3/index.d.ts",
    "../../../node_modules/zod/dist/esm/index.d.ts",
    "../src/env.ts",
    "../../../node_modules/@vitest/pretty-format/dist/index.d.ts",
    "../../../node_modules/@vitest/utils/dist/types.d.ts",
    "../../../node_modules/@vitest/utils/dist/helpers.d.ts",
    "../../../node_modules/tinyrainbow/dist/index-8b61d5bc.d.ts",
    "../../../node_modules/tinyrainbow/dist/node.d.ts",
    "../../../node_modules/@vitest/utils/dist/index.d.ts",
    "../../../node_modules/@vitest/runner/dist/tasks.d-hsdzc98-.d.ts",
    "../../../node_modules/@vitest/utils/dist/types.d-bcelap-c.d.ts",
    "../../../node_modules/@vitest/utils/dist/diff.d.ts",
    "../../../node_modules/@vitest/runner/dist/types.d.ts",
    "../../../node_modules/@vitest/utils/dist/error.d.ts",
    "../../../node_modules/@vitest/runner/dist/index.d.ts",
    "../../../node_modules/vitest/optional-types.d.ts",
    "../../../node_modules/vitest/dist/chunks/environment.d.dmw5ulng.d.ts",
    "../../../node_modules/@types/estree/index.d.ts",
    "../../../node_modules/rollup/dist/rollup.d.ts",
    "../../../node_modules/rollup/dist/parseast.d.ts",
    "../../../node_modules/vite/types/hmrpayload.d.ts",
    "../../../node_modules/vite/types/customevent.d.ts",
    "../../../node_modules/vite/types/hot.d.ts",
    "../../../node_modules/vite/dist/node/modulerunnertransport.d-dj_me5sf.d.ts",
    "../../../node_modules/vite/dist/node/module-runner.d.ts",
    "../../../node_modules/vite/node_modules/esbuild/lib/main.d.ts",
    "../../../node_modules/source-map-js/source-map.d.ts",
    "../../../node_modules/postcss/lib/previous-map.d.ts",
    "../../../node_modules/postcss/lib/input.d.ts",
    "../../../node_modules/postcss/lib/css-syntax-error.d.ts",
    "../../../node_modules/postcss/lib/declaration.d.ts",
    "../../../node_modules/postcss/lib/root.d.ts",
    "../../../node_modules/postcss/lib/warning.d.ts",
    "../../../node_modules/postcss/lib/lazy-result.d.ts",
    "../../../node_modules/postcss/lib/no-work-result.d.ts",
    "../../../node_modules/postcss/lib/processor.d.ts",
    "../../../node_modules/postcss/lib/result.d.ts",
    "../../../node_modules/postcss/lib/document.d.ts",
    "../../../node_modules/postcss/lib/rule.d.ts",
    "../../../node_modules/postcss/lib/node.d.ts",
    "../../../node_modules/postcss/lib/comment.d.ts",
    "../../../node_modules/postcss/lib/container.d.ts",
    "../../../node_modules/postcss/lib/at-rule.d.ts",
    "../../../node_modules/postcss/lib/list.d.ts",
    "../../../node_modules/postcss/lib/postcss.d.ts",
    "../../../node_modules/postcss/lib/postcss.d.mts",
    "../../../node_modules/lightningcss/node/ast.d.ts",
    "../../../node_modules/lightningcss/node/targets.d.ts",
    "../../../node_modules/lightningcss/node/index.d.ts",
    "../../../node_modules/vite/types/internal/lightningcssoptions.d.ts",
    "../../../node_modules/vite/types/internal/csspreprocessoroptions.d.ts",
    "../../../node_modules/vite/types/importglob.d.ts",
    "../../../node_modules/vite/types/metadata.d.ts",
    "../../../node_modules/vite/dist/node/index.d.ts",
    "../../../node_modules/@vitest/mocker/dist/registry.d-d765pazg.d.ts",
    "../../../node_modules/@vitest/mocker/dist/types.d-d_arzrdy.d.ts",
    "../../../node_modules/@vitest/mocker/dist/index.d.ts",
    "../../../node_modules/@vitest/utils/dist/source-map.d.ts",
    "../../../node_modules/vite-node/dist/trace-mapping.d-dlvdeqop.d.ts",
    "../../../node_modules/vite-node/dist/index.d-cwzbpocv.d.ts",
    "../../../node_modules/vite-node/dist/index.d.ts",
    "../../../node_modules/@vitest/snapshot/dist/environment.d-dhdq1csl.d.ts",
    "../../../node_modules/@vitest/snapshot/dist/rawsnapshot.d-lfsmjfud.d.ts",
    "../../../node_modules/@vitest/snapshot/dist/index.d.ts",
    "../../../node_modules/@vitest/snapshot/dist/environment.d.ts",
    "../../../node_modules/vitest/dist/chunks/config.d.uqe-kr0o.d.ts",
    "../../../node_modules/vitest/dist/chunks/worker.d.chgsog0s.d.ts",
    "../../../node_modules/@vitest/runner/dist/utils.d.ts",
    "../../../node_modules/tinybench/dist/index.d.ts",
    "../../../node_modules/vitest/dist/chunks/benchmark.d.bwvbvtda.d.ts",
    "../../../node_modules/vite-node/dist/client.d.ts",
    "../../../node_modules/vitest/dist/chunks/coverage.d.s9rmnxie.d.ts",
    "../../../node_modules/@vitest/snapshot/dist/manager.d.ts",
    "../../../node_modules/vitest/dist/chunks/reporters.d.c-cu31et.d.ts",
    "../../../node_modules/vitest/dist/chunks/worker.d.c-kn07ls.d.ts",
    "../../../node_modules/@vitest/expect/dist/chai.d.cts",
    "../../../node_modules/@vitest/spy/dist/index.d.ts",
    "../../../node_modules/@vitest/expect/dist/index.d.ts",
    "../../../node_modules/@vitest/expect/index.d.ts",
    "../../../node_modules/vitest/dist/chunks/global.d.cxraxnwc.d.ts",
    "../../../node_modules/vitest/dist/chunks/vite.d.ixcevtfp.d.ts",
    "../../../node_modules/vitest/dist/chunks/mocker.d.be_2ls6u.d.ts",
    "../../../node_modules/vitest/dist/chunks/suite.d.fvehnv49.d.ts",
    "../../../node_modules/expect-type/dist/utils.d.ts",
    "../../../node_modules/expect-type/dist/overloads.d.ts",
    "../../../node_modules/expect-type/dist/branding.d.ts",
    "../../../node_modules/expect-type/dist/messages.d.ts",
    "../../../node_modules/expect-type/dist/index.d.ts",
    "../../../node_modules/vitest/dist/index.d.ts",
    "../../../node_modules/dotenv/lib/main.d.ts",
    "../src/__tests__/gcs.test.ts",
    "../../../node_modules/@types/aws-lambda/common/api-gateway.d.ts",
    "../../../node_modules/@types/aws-lambda/common/cloudfront.d.ts",
    "../../../node_modules/@types/aws-lambda/handler.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/alb.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/api-gateway-proxy.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/api-gateway-authorizer.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/appsync-resolver.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/autoscaling.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cloudformation-custom-resource.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cdk-custom-resource.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cloudfront-request.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cloudfront-response.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cloudwatch-alarm.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/eventbridge.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cloudwatch-events.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cloudwatch-logs.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codebuild-cloudwatch-state.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codecommit.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codepipeline.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codepipeline-cloudwatch-action.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codepipeline-cloudwatch-pipeline.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codepipeline-cloudwatch-stage.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/codepipeline-cloudwatch.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/_common.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/create-auth-challenge.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/custom-email-sender.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/custom-message.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/custom-sms-sender.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/define-auth-challenge.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/post-authentication.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/post-confirmation.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/pre-authentication.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/pre-signup.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/pre-token-generation.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/pre-token-generation-v2.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/user-migration.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/verify-auth-challenge-response.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/cognito-user-pool-trigger/index.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/connect-contact-flow.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/dynamodb-stream.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/guard-duty-event-notification.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/iot.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/iot-authorizer.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/kinesis-firehose-transformation.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/kinesis-stream.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/lambda-function-url.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/lex.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/lex-v2.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/amplify-resolver.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/msk.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/s3.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/s3-batch.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/s3-event-notification.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/secretsmanager.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/self-managed-kafka.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/ses.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/sns.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/sqs.d.ts",
    "../../../node_modules/@types/aws-lambda/trigger/transfer-family-authorizer.d.ts",
    "../../../node_modules/@types/aws-lambda/index.d.ts",
    "../../../node_modules/@babel/types/lib/index.d.ts",
    "../../../node_modules/@types/babel__generator/index.d.ts",
    "../../../node_modules/@babel/parser/typings/babel-parser.d.ts",
    "../../../node_modules/@types/babel__template/index.d.ts",
    "../../../node_modules/@types/babel__traverse/index.d.ts",
    "../../../node_modules/@types/babel__core/index.d.ts",
    "../../../node_modules/@types/bunyan/index.d.ts",
    "../../../node_modules/@types/caseless/index.d.ts",
    "../../../node_modules/@types/connect/index.d.ts",
    "../../../node_modules/@types/cookie/index.d.ts",
    "../../../node_modules/@types/cors/index.d.ts",
    "../../../node_modules/@types/d3-array/index.d.ts",
    "../../../node_modules/@types/d3-color/index.d.ts",
    "../../../node_modules/@types/d3-ease/index.d.ts",
    "../../../node_modules/@types/d3-interpolate/index.d.ts",
    "../../../node_modules/@types/d3-path/index.d.ts",
    "../../../node_modules/@types/d3-time/index.d.ts",
    "../../../node_modules/@types/d3-scale/index.d.ts",
    "../../../node_modules/@types/d3-shape/index.d.ts",
    "../../../node_modules/@types/d3-timer/index.d.ts",
    "../../../node_modules/@types/ms/index.d.ts",
    "../../../node_modules/@types/debug/index.d.ts",
    "../../../node_modules/@types/diff-match-patch/index.d.ts",
    "../../../node_modules/@types/trusted-types/lib/index.d.ts",
    "../../../node_modules/dompurify/dist/purify.es.d.mts",
    "../../../node_modules/minimatch/dist/commonjs/ast.d.ts",
    "../../../node_modules/minimatch/dist/commonjs/escape.d.ts",
    "../../../node_modules/minimatch/dist/commonjs/unescape.d.ts",
    "../../../node_modules/minimatch/dist/commonjs/index.d.ts",
    "../../../node_modules/@types/glob/index.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/subscription.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/types.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/subscriber.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/operator.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/iif.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/throwerror.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/subject.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/connectableobservable.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/operators/groupby.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/symbol/observable.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/behaviorsubject.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/replaysubject.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/asyncsubject.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/action.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/asyncscheduler.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/asyncaction.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/asapscheduler.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/asap.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/async.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/queuescheduler.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/queue.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/animationframescheduler.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/animationframe.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduler/virtualtimescheduler.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/notification.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/pipe.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/noop.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/identity.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/isobservable.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/argumentoutofrangeerror.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/emptyerror.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/objectunsubscribederror.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/unsubscriptionerror.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/util/timeouterror.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/bindcallback.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/bindnodecallback.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/innersubscriber.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/outersubscriber.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/combinelatest.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/concat.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/defer.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/empty.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/forkjoin.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/from.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/fromevent.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/fromeventpattern.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/generate.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/interval.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/merge.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/never.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/of.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/onerrorresumenext.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/pairs.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/partition.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/race.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/range.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/timer.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/using.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/observable/zip.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/scheduled/scheduled.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/internal/config.d.ts",
    "../../../node_modules/@types/inquirer/node_modules/rxjs/index.d.ts",
    "../../../node_modules/@types/through/index.d.ts",
    "../../../node_modules/@types/inquirer/lib/objects/choice.d.ts",
    "../../../node_modules/@types/inquirer/lib/objects/separator.d.ts",
    "../../../node_modules/@types/inquirer/lib/objects/choices.d.ts",
    "../../../node_modules/@types/inquirer/lib/utils/screen-manager.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/base.d.ts",
    "../../../node_modules/@types/inquirer/lib/utils/paginator.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/checkbox.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/confirm.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/editor.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/expand.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/input.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/list.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/number.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/password.d.ts",
    "../../../node_modules/@types/inquirer/lib/prompts/rawlist.d.ts",
    "../../../node_modules/@types/inquirer/lib/ui/baseui.d.ts",
    "../../../node_modules/@types/inquirer/lib/ui/bottom-bar.d.ts",
    "../../../node_modules/@types/inquirer/lib/ui/prompt.d.ts",
    "../../../node_modules/@types/inquirer/lib/utils/events.d.ts",
    "../../../node_modules/@types/inquirer/lib/utils/readline.d.ts",
    "../../../node_modules/@types/inquirer/lib/utils/utils.d.ts",
    "../../../node_modules/@types/inquirer/index.d.ts",
    "../../../node_modules/@types/json-schema/index.d.ts",
    "../../../node_modules/@types/linkify-it/build/index.cjs.d.ts",
    "../../../node_modules/@types/linkify-it/index.d.ts",
    "../../../node_modules/@types/lodash/common/common.d.ts",
    "../../../node_modules/@types/lodash/common/array.d.ts",
    "../../../node_modules/@types/lodash/common/collection.d.ts",
    "../../../node_modules/@types/lodash/common/date.d.ts",
    "../../../node_modules/@types/lodash/common/function.d.ts",
    "../../../node_modules/@types/lodash/common/lang.d.ts",
    "../../../node_modules/@types/lodash/common/math.d.ts",
    "../../../node_modules/@types/lodash/common/number.d.ts",
    "../../../node_modules/@types/lodash/common/object.d.ts",
    "../../../node_modules/@types/lodash/common/seq.d.ts",
    "../../../node_modules/@types/lodash/common/string.d.ts",
    "../../../node_modules/@types/lodash/common/util.d.ts",
    "../../../node_modules/@types/lodash/index.d.ts",
    "../../../node_modules/@types/mdurl/build/index.cjs.d.ts",
    "../../../node_modules/@types/markdown-it/dist/index.cjs.d.ts",
    "../../../node_modules/@types/markdown-it/index.d.ts",
    "../../../node_modules/@types/mdurl/index.d.ts",
    "../../../node_modules/@types/memcached/index.d.ts",
    "../../../node_modules/@types/minimatch/index.d.ts",
    "../../../node_modules/@types/mysql/index.d.ts",
    "../../../node_modules/form-data/index.d.ts",
    "../../../node_modules/@types/node-fetch/externals.d.ts",
    "../../../node_modules/@types/node-fetch/index.d.ts",
    "../../../node_modules/@types/oracledb/index.d.ts",
    "../../../node_modules/pg-types/index.d.ts",
    "../../../node_modules/pg-protocol/dist/messages.d.ts",
    "../../../node_modules/pg-protocol/dist/serializer.d.ts",
    "../../../node_modules/pg-protocol/dist/parser.d.ts",
    "../../../node_modules/pg-protocol/dist/index.d.ts",
    "../../../node_modules/@types/pg/lib/type-overrides.d.ts",
    "../../../node_modules/@types/pg/index.d.ts",
    "../../../node_modules/@types/pg/index.d.mts",
    "../../../node_modules/@types/pg-pool/index.d.ts",
    "../../../node_modules/@types/phoenix/index.d.ts",
    "../../../node_modules/@types/react/global.d.ts",
    "../../../node_modules/csstype/index.d.ts",
    "../../../node_modules/@types/react/index.d.ts",
    "../../../node_modules/@types/react-dom/node_modules/@types/react/global.d.ts",
    "../../../node_modules/@types/react-dom/node_modules/@types/react/index.d.ts",
    "../../../node_modules/@types/react-dom/index.d.ts",
    "../../../node_modules/@types/request/node_modules/form-data/index.d.ts",
    "../../../node_modules/@types/tough-cookie/index.d.ts",
    "../../../node_modules/@types/request/index.d.ts",
    "../../../node_modules/@types/shimmer/index.d.ts",
    "../../../node_modules/@types/tedious/index.d.ts",
    "../../../node_modules/@types/tinycolor2/index.d.ts",
    "../../../node_modules/@types/trusted-types/index.d.ts",
    "../../../node_modules/@types/use-sync-external-store/index.d.ts",
    "../../../node_modules/@types/uuid/index.d.ts",
    "../../../node_modules/@types/ws/index.d.ts"
  ],
  "fileIdsList": [
    [127, 217, 387, 533, 575],
    [127, 217, 385, 386, 493, 533, 575],
    [127, 217, 261, 349, 389, 493, 533, 575],
    [
      390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404,
      405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419,
      420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434,
      435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449,
      450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 462, 463, 464, 465,
      466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480,
      481, 482, 483, 484, 485, 486, 487, 488, 489, 533, 575
    ],
    [127, 217, 261, 349, 461, 493, 533, 575],
    [127, 217, 533, 575],
    [127, 197, 217, 227, 490, 533, 575],
    [386, 388, 491, 492, 493, 494, 495, 501, 509, 510, 533, 575],
    [389, 461, 533, 575],
    [127, 217, 349, 388, 533, 575],
    [127, 217, 349, 388, 389, 533, 575],
    [349, 533, 575],
    [496, 497, 498, 499, 500, 533, 575],
    [127, 217, 493, 533, 575],
    [127, 217, 451, 496, 533, 575],
    [127, 217, 452, 496, 533, 575],
    [127, 217, 455, 496, 533, 575],
    [127, 217, 457, 496, 533, 575],
    [491, 533, 575],
    [
      127, 217, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402,
      403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417,
      418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432,
      433, 434, 435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447,
      448, 449, 450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 462, 463,
      464, 465, 466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478,
      479, 480, 481, 482, 483, 484, 485, 486, 487, 488, 489, 493, 533, 575
    ],
    [
      127, 152, 153, 197, 217, 227, 233, 236, 251, 253, 261, 278, 349, 386, 387,
      390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404,
      405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419,
      420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434,
      435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449,
      450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 462, 463, 464, 465,
      466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480,
      481, 482, 483, 484, 485, 486, 487, 488, 489, 492, 533, 575, 607
    ],
    [505, 506, 507, 508, 533, 575],
    [445, 493, 504, 533, 575],
    [446, 493, 504, 533, 575],
    [353, 361, 384, 533, 575],
    [533, 575],
    [350, 351, 352, 533, 575],
    [197, 533, 575],
    [127, 217, 355, 533, 575],
    [127, 217, 354, 533, 575],
    [354, 355, 356, 357, 358, 533, 575],
    [141, 533, 575],
    [127, 141, 217, 533, 575],
    [127, 197, 214, 217, 533, 575],
    [359, 360, 533, 575],
    [
      362, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 379, 380,
      382, 383, 533, 575
    ],
    [368, 533, 575],
    [127, 217, 318, 367, 533, 575],
    [127, 217, 364, 365, 366, 533, 575],
    [127, 217, 364, 367, 533, 575],
    [379, 533, 575],
    [71, 127, 217, 318, 376, 378, 533, 575],
    [127, 217, 364, 377, 533, 575],
    [127, 217, 307, 318, 375, 533, 575],
    [127, 217, 364, 374, 376, 533, 575],
    [127, 217, 364, 375, 533, 575],
    [234, 235, 533, 575],
    [127, 197, 217, 234, 533, 575],
    [292, 293, 309, 310, 311, 312, 313, 314, 315, 316, 317, 533, 575],
    [294, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 533, 575],
    [127, 217, 269, 271, 533, 575],
    [271, 272, 273, 274, 275, 276, 277, 533, 575],
    [127, 217, 273, 533, 575],
    [127, 217, 270, 533, 575],
    [127, 217, 262, 533, 575],
    [127, 217, 264, 533, 575],
    [262, 533, 575],
    [262, 263, 264, 265, 266, 267, 268, 533, 575],
    [502, 533, 575],
    [502, 503, 533, 575],
    [518, 519, 533, 575],
    [127, 217, 511, 533, 575],
    [511, 518, 533, 575, 587],
    [127, 142, 217, 533, 575],
    [127, 146, 217, 533, 575],
    [127, 146, 147, 148, 149, 217, 533, 575],
    [142, 143, 144, 145, 147, 150, 151, 533, 575],
    [141, 142, 533, 575],
    [154, 155, 156, 157, 229, 230, 231, 232, 533, 575],
    [127, 155, 217, 533, 575],
    [199, 533, 575],
    [198, 533, 575],
    [197, 198, 200, 201, 533, 575],
    [127, 217, 227, 533, 575],
    [127, 197, 198, 201, 217, 533, 575],
    [198, 199, 200, 201, 202, 215, 216, 217, 228, 533, 575],
    [197, 198, 533, 575],
    [127, 217, 229, 533, 575],
    [127, 217, 230, 533, 575],
    [127, 217, 349, 533, 575],
    [512, 516, 533, 575],
    [127, 217, 515, 533, 575],
    [513, 514, 533, 575],
    [127, 197, 217, 533, 575],
    [127, 214, 217, 533, 575],
    [127, 171, 172, 217, 533, 575],
    [165, 533, 575],
    [127, 167, 217, 533, 575],
    [165, 166, 168, 169, 170, 533, 575],
    [
      158, 159, 160, 161, 162, 163, 164, 167, 171, 172, 173, 174, 175, 176, 177,
      178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192,
      193, 194, 195, 196, 533, 575
    ],
    [171, 172, 533, 575],
    [533, 575, 883],
    [533, 575, 699],
    [533, 575, 590, 607, 618, 697, 699, 700, 701, 703, 704, 705, 706, 707, 710],
    [533, 575, 699, 710],
    [533, 575, 588],
    [533, 575, 590, 607, 618, 695, 696, 697, 699, 700, 702, 703, 704, 708, 710],
    [533, 575, 607, 704],
    [533, 575, 697, 699, 710],
    [533, 575, 708],
    [533, 575, 699, 700, 701, 703, 704, 705, 706, 707, 708, 709, 710, 711, 712],
    [533, 575, 693, 696, 697, 698],
    [533, 575, 587, 695, 696],
    [533, 575, 693, 695, 696, 697],
    [533, 575, 607, 693, 695, 697],
    [533, 575, 696, 699, 708],
    [533, 575, 607, 664, 693, 696, 705, 710],
    [533, 575, 590, 693, 710],
    [533, 575, 607, 699, 701, 704, 705, 708, 709],
    [533, 575, 664, 705, 708],
    [237, 238, 239, 240, 533, 575],
    [127, 217, 239, 533, 575],
    [241, 244, 250, 533, 575],
    [242, 243, 533, 575],
    [245, 533, 575],
    [127, 217, 247, 248, 533, 575],
    [247, 248, 249, 533, 575],
    [246, 533, 575],
    [252, 533, 575],
    [127, 217, 254, 255, 533, 575],
    [256, 257, 533, 575],
    [254, 255, 258, 259, 260, 533, 575],
    [127, 128, 138, 139, 217, 533, 575],
    [127, 137, 217, 533, 575],
    [128, 138, 139, 140, 533, 575],
    [220, 533, 575],
    [221, 533, 575],
    [127, 217, 223, 533, 575],
    [127, 217, 218, 219, 533, 575],
    [218, 219, 220, 222, 223, 224, 225, 226, 533, 575],
    [129, 130, 131, 132, 133, 134, 135, 136, 533, 575],
    [127, 133, 217, 533, 575],
    [203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 533, 575],
    [127, 203, 217, 533, 575],
    [318, 533, 575],
    [127, 217, 261, 533, 575],
    [279, 533, 575],
    [127, 217, 328, 329, 533, 575],
    [330, 533, 575],
    [
      127, 217, 279, 319, 320, 321, 322, 323, 324, 325, 326, 327, 331, 332, 333,
      334, 335, 336, 337, 338, 339, 348, 533, 575
    ],
    [127, 217, 291, 533, 575],
    [127, 217, 227, 307, 308, 533, 575],
    [127, 217, 308, 533, 575],
    [127, 217, 307, 533, 575],
    [127, 217, 315, 533, 575],
    [127, 217, 295, 533, 575],
    [127, 217, 301, 533, 575],
    [127, 217, 297, 533, 575],
    [127, 217, 302, 533, 575],
    [340, 341, 342, 343, 344, 345, 346, 347, 533, 575],
    [61, 533, 575],
    [60, 533, 575],
    [64, 73, 74, 75, 533, 575],
    [73, 76, 533, 575],
    [64, 71, 533, 575],
    [64, 76, 533, 575],
    [62, 63, 74, 75, 76, 77, 533, 575],
    [80, 533, 575, 607],
    [82, 533, 575],
    [65, 66, 72, 73, 533, 575],
    [65, 73, 533, 575],
    [85, 87, 88, 533, 575],
    [85, 86, 533, 575],
    [90, 533, 575],
    [62, 533, 575],
    [67, 92, 533, 575],
    [92, 533, 575],
    [92, 93, 94, 95, 96, 533, 575],
    [95, 533, 575],
    [69, 533, 575],
    [92, 93, 94, 533, 575],
    [65, 71, 73, 533, 575],
    [82, 83, 533, 575],
    [98, 533, 575],
    [98, 102, 533, 575],
    [98, 99, 102, 103, 533, 575],
    [72, 101, 533, 575],
    [79, 533, 575],
    [61, 70, 533, 575],
    [69, 71, 533, 575, 590, 592],
    [64, 533, 575],
    [64, 106, 107, 108, 533, 575],
    [
      61, 65, 66, 67, 68, 69, 70, 71, 72, 73, 78, 81, 82, 83, 84, 86, 89, 90,
      91, 97, 100, 101, 104, 105, 109, 110, 111, 112, 113, 115, 116, 117, 118,
      119, 120, 121, 123, 124, 125, 126, 533, 575
    ],
    [62, 66, 67, 68, 69, 72, 76, 533, 575],
    [66, 84, 533, 575],
    [100, 533, 575],
    [65, 67, 73, 112, 113, 114, 533, 575],
    [71, 72, 86, 115, 533, 575],
    [65, 71, 533, 575],
    [71, 90, 533, 575],
    [72, 82, 83, 533, 575],
    [80, 112, 533, 575, 590, 607],
    [65, 66, 120, 121, 533, 575],
    [66, 71, 84, 112, 119, 120, 121, 122, 533, 575, 590, 591],
    [66, 84, 100, 533, 575],
    [71, 533, 575],
    [127, 217, 533, 575, 607],
    [282, 533, 575],
    [281, 283, 533, 575, 607],
    [533, 575, 607],
    [280, 281, 284, 285, 286, 287, 288, 289, 290, 533, 575],
    [
      533, 575, 823, 824, 825, 826, 827, 828, 829, 830, 831, 832, 833, 834, 835,
      836, 837, 838, 839, 840, 841, 842, 843, 844, 845, 860, 861, 862, 863, 864,
      865, 866, 867, 868, 869, 870, 871, 872, 873, 874, 875, 876, 877, 878, 879,
      880, 881
    ],
    [533, 575, 825],
    [533, 575, 825, 829],
    [533, 575, 823, 825, 827],
    [533, 575, 823, 825],
    [533, 575, 825, 831],
    [533, 575, 824, 825],
    [533, 575, 836],
    [533, 575, 825, 842, 843, 844],
    [533, 575, 825, 846],
    [
      533, 575, 825, 847, 848, 849, 850, 851, 852, 853, 854, 855, 856, 857, 858,
      859
    ],
    [533, 575, 825, 828],
    [533, 575, 825, 827],
    [533, 575, 825, 836],
    [533, 575, 883, 884, 885, 886, 887],
    [533, 575, 883, 885],
    [533, 575, 587, 625],
    [533, 575, 590, 625],
    [533, 575, 895],
    [533, 575, 899],
    [533, 575, 898],
    [533, 575, 903],
    [533, 575, 587, 588, 625, 911],
    [
      533, 575, 602, 976, 977, 978, 979, 980, 981, 982, 983, 984, 985, 986, 987,
      988, 989, 990, 991, 992, 994, 995, 996, 997, 998
    ],
    [533, 575, 999],
    [533, 575, 978, 979, 999],
    [533, 575, 602, 976, 981, 999],
    [533, 575, 602, 982, 983, 999],
    [533, 575, 602, 982, 999],
    [533, 575, 602, 976, 982, 999],
    [533, 575, 602, 988, 999],
    [533, 575, 602, 999],
    [533, 575, 977, 993, 999],
    [533, 575, 976, 993, 999],
    [533, 575, 602, 976],
    [533, 575, 981],
    [533, 575, 602],
    [533, 575, 976, 999],
    [
      533, 575, 913, 914, 915, 916, 917, 918, 919, 920, 921, 922, 923, 924, 925,
      926, 927, 932, 933, 935, 937, 938, 939, 940, 941, 942, 943, 944, 945, 946,
      947, 948, 949, 950, 953, 954, 955, 956, 957, 958, 959, 960, 961, 962, 963,
      964, 965, 966, 967, 968, 969, 970, 971, 972, 973, 974, 975
    ],
    [533, 575, 913, 915, 920],
    [533, 575, 915, 952],
    [533, 575, 914, 919],
    [533, 575, 913, 914, 915, 916, 917, 918],
    [533, 575, 914, 915, 916, 919, 952],
    [533, 575, 913, 915, 919, 920],
    [533, 575, 919],
    [533, 575, 919, 959],
    [533, 575, 913, 914, 915, 919],
    [533, 575, 914, 915, 916, 919],
    [533, 575, 914, 915],
    [533, 575, 913, 914, 915, 919, 920],
    [533, 575, 915, 951],
    [533, 575, 913, 914, 915, 920],
    [533, 575, 976],
    [533, 575, 913, 914, 928],
    [533, 575, 913, 914, 927],
    [533, 575, 936],
    [533, 575, 929, 930],
    [533, 575, 931],
    [533, 575, 929],
    [533, 575, 913, 914, 928, 929],
    [533, 575, 913, 914, 927, 928, 930],
    [533, 575, 934],
    [533, 575, 913, 914, 929, 930],
    [533, 575, 913, 914, 915, 916, 919],
    [533, 575, 913, 914],
    [533, 575, 914],
    [533, 575, 913, 919],
    [533, 575, 1001],
    [
      533, 575, 1003, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1007, 1008, 1009, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1008, 1009, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1009, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1010, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1011, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1012, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1013,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012,
      1014, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012,
      1013, 1015
    ],
    [
      533, 575, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012,
      1013, 1014
    ],
    [533, 575, 1001, 1016],
    [533, 575, 1017],
    [533, 575, 1016],
    [533, 575, 587, 607, 615, 625],
    [533, 575, 590, 618, 625, 1023, 1024],
    [533, 575, 607, 625],
    [533, 575, 1034],
    [533, 575, 1033],
    [533, 575, 587, 607, 615, 625, 1027, 1028, 1031, 1032, 1033],
    [533, 575, 1041],
    [533, 575, 1038, 1040],
    [533, 575, 1037, 1038],
    [533, 575, 588, 590, 592, 595, 607, 618, 625, 890, 1043, 1044],
    [533, 575, 590, 607, 625],
    [533, 575, 587, 615, 625],
    [533, 575, 906],
    [533, 575, 587, 590, 592, 595, 607, 615, 618, 624, 625],
    [533, 575, 607, 657],
    [533, 575, 607, 657, 658],
    [533, 575, 656],
    [533, 575, 618, 632, 636],
    [533, 575, 607, 618, 632],
    [533, 575, 627],
    [533, 575, 615, 618, 629, 632],
    [533, 575, 595, 615],
    [533, 575, 625],
    [533, 575, 625, 627],
    [533, 575, 595, 618, 629, 632],
    [526, 527, 533, 575, 587, 607, 618, 628, 631],
    [526, 533, 575, 630],
    [533, 575, 610, 618, 625, 628, 632],
    [533, 575, 625, 649],
    [533, 575, 625, 626, 627],
    [533, 575, 632],
    [
      533, 575, 626, 627, 628, 629, 630, 631, 632, 633, 634, 636, 637, 638, 639,
      640, 641, 642, 643, 644, 645, 646, 647, 648, 650, 651, 652, 653, 654, 655
    ],
    [533, 575, 632, 639, 640],
    [533, 575, 630, 632, 640, 641],
    [533, 575, 631],
    [526, 533, 575, 627, 632],
    [533, 575, 632, 636, 640, 641],
    [533, 575, 636],
    [533, 575, 618, 630, 632, 635],
    [526, 533, 575, 629, 630, 632, 636, 639],
    [533, 575, 623, 625, 627, 632, 649],
    [533, 575, 739, 740, 743, 808],
    [533, 575, 809],
    [533, 575, 786, 787],
    [533, 575, 740, 741, 743, 744, 745],
    [533, 575, 740],
    [533, 575, 740, 741, 743],
    [533, 575, 740, 741],
    [533, 575, 793],
    [533, 575, 735, 793, 794],
    [533, 575, 735, 793],
    [533, 575, 735, 742],
    [533, 575, 736],
    [533, 575, 735, 736, 737, 739],
    [533, 575, 735],
    [533, 575, 618, 625],
    [533, 575, 815, 816],
    [533, 575, 815, 816, 817, 818],
    [533, 575, 815, 817],
    [533, 575, 815],
    [533, 575, 590, 607, 618],
    [533, 575, 590, 618, 661, 662],
    [533, 575, 661, 662, 663],
    [533, 575, 661],
    [533, 575, 590, 686],
    [533, 575, 587, 664, 665, 666, 668, 671],
    [533, 575, 668, 669, 678, 680],
    [533, 575, 664],
    [533, 575, 664, 665, 666, 668, 669, 671],
    [533, 575, 664, 671],
    [533, 575, 664, 665, 666, 669, 671],
    [533, 575, 664, 665, 666, 669, 671, 678],
    [533, 575, 669, 678, 679, 681, 682],
    [
      533, 575, 607, 664, 665, 666, 669, 671, 672, 673, 675, 676, 677, 678, 683,
      684, 693
    ],
    [533, 575, 668, 669, 678],
    [533, 575, 671],
    [533, 575, 669, 671, 672, 685],
    [533, 575, 607, 666, 671],
    [533, 575, 607, 666, 671, 672, 674],
    [533, 575, 601, 664, 665, 666, 667, 669, 670],
    [533, 575, 664, 669, 671],
    [533, 575, 669, 678],
    [
      533, 575, 664, 665, 666, 669, 670, 671, 672, 673, 675, 676, 677, 678, 679,
      680, 681, 682, 683, 685, 687, 688, 689, 690, 691, 692, 693
    ],
    [533, 575, 778, 779],
    [533, 575, 911],
    [533, 575, 908, 909, 910],
    [533, 575, 625, 1028, 1029, 1030],
    [533, 575, 607, 625, 1028],
    [533, 575, 773],
    [533, 575, 771, 773],
    [533, 575, 762, 770, 771, 772, 774],
    [533, 575, 760],
    [533, 575, 763, 768, 773, 776],
    [533, 575, 759, 776],
    [533, 575, 763, 764, 767, 768, 769, 776],
    [533, 575, 763, 764, 765, 767, 768, 776],
    [533, 575, 760, 761, 762, 763, 764, 768, 769, 770, 772, 773, 774, 776],
    [533, 575, 776],
    [
      533, 575, 758, 760, 761, 762, 763, 764, 765, 767, 768, 769, 770, 771, 772,
      773, 774, 775
    ],
    [533, 575, 758, 776],
    [533, 575, 763, 765, 766, 768, 769, 776],
    [533, 575, 767, 776],
    [533, 575, 768, 769, 773, 776],
    [533, 575, 761, 771],
    [533, 575, 750, 784, 785],
    [533, 575, 749, 750],
    [533, 575, 590, 592, 607, 625, 694],
    [533, 575, 738],
    [533, 542, 546, 575, 618],
    [533, 542, 575, 607, 618],
    [533, 537, 575],
    [533, 539, 542, 575, 615, 618],
    [533, 537, 575, 625],
    [533, 539, 542, 575, 595, 618],
    [533, 534, 535, 538, 541, 575, 587, 607, 618],
    [533, 542, 549, 575],
    [533, 534, 540, 575],
    [533, 542, 563, 564, 575],
    [533, 538, 542, 575, 610, 618, 625],
    [533, 563, 575, 625],
    [533, 536, 537, 575, 625],
    [533, 542, 575],
    [
      533, 536, 537, 538, 539, 540, 541, 542, 543, 544, 546, 547, 548, 549, 550,
      551, 552, 553, 554, 555, 556, 557, 558, 559, 560, 561, 562, 564, 565, 566,
      567, 568, 569, 575
    ],
    [533, 542, 557, 575],
    [533, 542, 549, 550, 575],
    [533, 540, 542, 550, 551, 575],
    [533, 541, 575],
    [533, 534, 537, 542, 575],
    [533, 542, 546, 550, 551, 575],
    [533, 546, 575],
    [533, 540, 542, 545, 575, 618],
    [533, 534, 539, 542, 549, 575],
    [533, 537, 542, 563, 575, 623, 625],
    [533, 575, 790, 791],
    [533, 575, 790],
    [
      533, 575, 587, 588, 590, 591, 592, 595, 607, 615, 618, 624, 625, 750, 751,
      752, 753, 755, 756, 757, 777, 781, 782, 783, 784, 785
    ],
    [533, 575, 752, 753, 754, 755],
    [533, 575, 752],
    [533, 575, 753],
    [533, 575, 780],
    [533, 575, 750, 785],
    [533, 575, 746, 799, 800, 811],
    [533, 575, 735, 743, 746, 795, 796, 811],
    [533, 575, 802],
    [533, 575, 747],
    [533, 575, 735, 746, 748, 795, 801, 810, 811],
    [533, 575, 788],
    [
      533, 575, 578, 588, 607, 735, 740, 743, 746, 748, 785, 788, 789, 792, 795,
      797, 798, 801, 803, 804, 807, 811, 812
    ],
    [533, 575, 746, 799, 800, 801, 811],
    [533, 575, 785, 805, 812],
    [533, 575, 623, 798],
    [533, 575, 746, 748, 792, 795, 797, 811],
    [
      533, 575, 578, 588, 607, 623, 735, 740, 743, 746, 747, 748, 785, 788, 789,
      792, 795, 796, 797, 798, 799, 800, 801, 802, 803, 804, 805, 806, 807, 808,
      810, 811, 812, 813, 814, 819
    ],
    [533, 575, 732],
    [533, 575, 722, 723],
    [533, 575, 720, 721, 722, 724, 725, 730],
    [533, 575, 721, 722],
    [533, 575, 730],
    [533, 575, 731],
    [533, 575, 722],
    [533, 575, 720, 721, 722, 725, 726, 727, 728, 729],
    [533, 575, 720, 721, 732],
    [521, 523, 524, 533, 575, 660, 714, 715, 717],
    [533, 572, 575],
    [533, 574, 575],
    [575],
    [533, 575, 580, 610],
    [533, 575, 576, 581, 587, 588, 595, 607, 618],
    [533, 575, 576, 577, 587, 595],
    [528, 529, 530, 533, 575],
    [533, 575, 578, 619],
    [533, 575, 579, 580, 588, 596],
    [533, 575, 580, 607, 615],
    [533, 575, 581, 583, 587, 595],
    [533, 574, 575, 582],
    [533, 575, 583, 584],
    [533, 575, 587],
    [533, 575, 585, 587],
    [533, 574, 575, 587],
    [533, 575, 587, 588, 589, 607, 618],
    [533, 575, 587, 588, 589, 602, 607, 610],
    [533, 570, 575, 623],
    [533, 570, 575, 583, 587, 590, 595, 607, 618],
    [533, 575, 587, 588, 590, 591, 595, 607, 615, 618],
    [533, 575, 590, 592, 607, 615, 618],
    [
      531, 532, 533, 571, 572, 573, 574, 575, 576, 577, 578, 579, 580, 581, 582,
      583, 584, 585, 586, 587, 588, 589, 590, 591, 592, 593, 594, 595, 596, 597,
      598, 599, 600, 601, 602, 603, 604, 605, 606, 607, 608, 609, 610, 611, 612,
      613, 614, 615, 616, 617, 618, 619, 620, 621, 622, 623, 624
    ],
    [533, 575, 587, 593],
    [533, 575, 594, 618],
    [533, 575, 583, 587, 595, 607],
    [533, 575, 596],
    [533, 575, 597],
    [533, 574, 575, 598],
    [
      533, 572, 573, 574, 575, 576, 577, 578, 579, 580, 581, 582, 583, 584, 585,
      587, 588, 589, 590, 591, 592, 593, 594, 595, 596, 597, 598, 599, 600, 601,
      602, 603, 604, 605, 606, 607, 608, 609, 610, 611, 612, 613, 614, 615, 616,
      617, 618, 619, 620, 621, 622, 623, 624
    ],
    [533, 575, 600],
    [533, 575, 601],
    [533, 575, 587, 602, 603],
    [533, 575, 602, 604, 619, 621],
    [533, 575, 587, 607, 608, 610],
    [533, 575, 609, 610],
    [533, 575, 607, 608],
    [533, 575, 610],
    [533, 575, 611],
    [533, 572, 575, 607],
    [533, 575, 587, 613, 614],
    [533, 575, 613, 614],
    [533, 575, 580, 595, 607, 615],
    [533, 575, 616],
    [533, 575, 595, 617],
    [533, 575, 590, 601, 618],
    [533, 575, 580, 619],
    [533, 575, 607, 620],
    [533, 575, 594, 621],
    [533, 575, 622],
    [533, 575, 580, 587, 589, 598, 607, 618, 621, 623],
    [533, 575, 607, 624],
    [533, 575, 597, 714, 820, 821],
    [533, 575, 719, 733],
    [521, 522, 523, 524, 533, 575, 660, 714],
    [521, 522, 533, 575, 607, 713],
    [523, 533, 575],
    [511, 517, 520, 521, 522, 533, 575],
    [521, 533, 575, 659],
    [522, 533, 575, 716]
  ],
  "fileInfos": [
    {
      "version": "69684132aeb9b5642cbcd9e22dff7818ff0ee1aa831728af0ecf97d3364d5546",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "45b7ab580deca34ae9729e97c13cfd999df04416a79116c3bfb483804f85ded4",
      "impliedFormat": 1
    },
    {
      "version": "3facaf05f0c5fc569c5649dd359892c98a85557e3e0c847964caeb67076f4d75",
      "impliedFormat": 1
    },
    {
      "version": "e44bb8bbac7f10ecc786703fe0a6a4b952189f908707980ba8f3c8975a760962",
      "impliedFormat": 1
    },
    {
      "version": "5e1c4c362065a6b95ff952c0eab010f04dcd2c3494e813b493ecfd4fcb9fc0d8",
      "impliedFormat": 1
    },
    {
      "version": "68d73b4a11549f9c0b7d352d10e91e5dca8faa3322bfb77b661839c42b1ddec7",
      "impliedFormat": 1
    },
    {
      "version": "5efce4fc3c29ea84e8928f97adec086e3dc876365e0982cc8479a07954a3efd4",
      "impliedFormat": 1
    },
    {
      "version": "feecb1be483ed332fad555aff858affd90a48ab19ba7272ee084704eb7167569",
      "impliedFormat": 1
    },
    {
      "version": "ee7bad0c15b58988daa84371e0b89d313b762ab83cb5b31b8a2d1162e8eb41c2",
      "impliedFormat": 1
    },
    {
      "version": "092c2bfe125ce69dbb1223c85d68d4d2397d7d8411867b5cc03cec902c233763",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "07f073f19d67f74d732b1adea08e1dc66b1b58d77cb5b43931dee3d798a2fd53",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "c57796738e7f83dbc4b8e65132f11a377649c00dd3eee333f672b8f0a6bea671",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "dc2df20b1bcdc8c2d34af4926e2c3ab15ffe1160a63e58b7e09833f616efff44",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "515d0b7b9bea2e31ea4ec968e9edd2c39d3eebf4a2d5cbd04e88639819ae3b71",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "0559b1f683ac7505ae451f9a96ce4c3c92bdc71411651ca6ddb0e88baaaad6a3",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "0dc1e7ceda9b8b9b455c3a2d67b0412feab00bd2f66656cd8850e8831b08b537",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "ce691fb9e5c64efb9547083e4a34091bcbe5bdb41027e310ebba8f7d96a98671",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "8d697a2a929a5fcb38b7a65594020fcef05ec1630804a33748829c5ff53640d0",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "4ff2a353abf8a80ee399af572debb8faab2d33ad38c4b4474cff7f26e7653b8d",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "936e80ad36a2ee83fc3caf008e7c4c5afe45b3cf3d5c24408f039c1d47bdc1df",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "d15bea3d62cbbdb9797079416b8ac375ae99162a7fba5de2c6c505446486ac0a",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "68d18b664c9d32a7336a70235958b8997ebc1c3b8505f4f1ae2b7e7753b87618",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "eb3d66c8327153d8fa7dd03f9c58d351107fe824c79e9b56b462935176cdf12a",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "38f0219c9e23c915ef9790ab1d680440d95419ad264816fa15009a8851e79119",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "69ab18c3b76cd9b1be3d188eaf8bba06112ebbe2f47f6c322b5105a6fbc45a2e",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "fef8cfad2e2dc5f5b3d97a6f4f2e92848eb1b88e897bb7318cef0e2820bceaab",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "2f11ff796926e0832f9ae148008138ad583bd181899ab7dd768a2666700b1893",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "4de680d5bb41c17f7f68e0419412ca23c98d5749dcaaea1896172f06435891fc",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "954296b30da6d508a104a3a0b5d96b76495c709785c1d11610908e63481ee667",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "ac9538681b19688c8eae65811b329d3744af679e0bdfa5d842d0e32524c73e1c",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "0a969edff4bd52585473d24995c5ef223f6652d6ef46193309b3921d65dd4376",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "9e9fbd7030c440b33d021da145d3232984c8bb7916f277e8ffd3dc2e3eae2bdb",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "811ec78f7fefcabbda4bfa93b3eb67d9ae166ef95f9bff989d964061cbf81a0c",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "717937616a17072082152a2ef351cb51f98802fb4b2fdabd32399843875974ca",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "d7e7d9b7b50e5f22c915b525acc5a49a7a6584cf8f62d0569e557c5cfc4b2ac2",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "71c37f4c9543f31dfced6c7840e068c5a5aacb7b89111a4364b1d5276b852557",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "576711e016cf4f1804676043e6a0a5414252560eb57de9faceee34d79798c850",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "89c1b1281ba7b8a96efc676b11b264de7a8374c5ea1e6617f11880a13fc56dc6",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "74f7fa2d027d5b33eb0471c8e82a6c87216223181ec31247c357a3e8e2fddc5b",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "d6d7ae4d1f1f3772e2a3cde568ed08991a8ae34a080ff1151af28b7f798e22ca",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "063600664504610fe3e99b717a1223f8b1900087fab0b4cad1496a114744f8df",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "934019d7e3c81950f9a8426d093458b65d5aff2c7c1511233c0fd5b941e608ab",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "52ada8e0b6e0482b728070b7639ee42e83a9b1c22d205992756fe020fd9f4a47",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "3bdefe1bfd4d6dee0e26f928f93ccc128f1b64d5d501ff4a8cf3c6371200e5e6",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "59fb2c069260b4ba00b5643b907ef5d5341b167e7d1dbf58dfd895658bda2867",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "639e512c0dfc3fad96a84caad71b8834d66329a1f28dc95e3946c9b58176c73a",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "368af93f74c9c932edd84c58883e736c9e3d53cec1fe24c0b0ff451f529ceab1",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "af3dd424cf267428f30ccfc376f47a2c0114546b55c44d8c0f1d57d841e28d74",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "995c005ab91a498455ea8dfb63aa9f83fa2ea793c3d8aa344be4a1678d06d399",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "959d36cddf5e7d572a65045b876f2956c973a586da58e5d26cde519184fd9b8a",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "965f36eae237dd74e6cca203a43e9ca801ce38824ead814728a2807b1910117d",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "3925a6c820dcb1a06506c90b1577db1fdbf7705d65b62b99dce4be75c637e26b",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "0a3d63ef2b853447ec4f749d3f368ce642264246e02911fcb1590d8c161b8005",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "b5ce7a470bc3628408429040c4e3a53a27755022a32fd05e2cb694e7015386c7",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "8444af78980e3b20b49324f4a16ba35024fef3ee069a0eb67616ea6ca821c47a",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "3287d9d085fbd618c3971944b65b4be57859f5415f495b33a6adc994edd2f004",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "b4b67b1a91182421f5df999988c690f14d813b9850b40acd06ed44691f6727ad",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "8e7f8264d0fb4c5339605a15daadb037bf238c10b654bb3eee14208f860a32ea",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "782dec38049b92d4e85c1585fbea5474a219c6984a35b004963b00beb1aab538",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "b40885a4e39fb67eb251fb009bf990f3571ccf7279dccad26c2261b4e5c8ebcd",
      "impliedFormat": 1
    },
    {
      "version": "2d0e63718a9ab15554cca1ef458a269ff938aea2ad379990a018a49e27aadf40",
      "impliedFormat": 1
    },
    {
      "version": "530e5c7e4f74267b7800f1702cf0c576282296a960acbdb2960389b2b1d0875b",
      "impliedFormat": 1
    },
    {
      "version": "1c483cc60a58a0d4c9a068bdaa8d95933263e6017fbea33c9f99790cf870f0a8",
      "impliedFormat": 1
    },
    {
      "version": "07863eea4f350458f803714350e43947f7f73d1d67a9ddf747017065d36b073a",
      "impliedFormat": 1
    },
    {
      "version": "396c2c14fa408707235d761a965bd84ce3d4fc3117c3b9f1404d6987d98a30d6",
      "impliedFormat": 1
    },
    {
      "version": "4c264e26675ecf0b370d88d8013f0eb7ade6466c6445df1254b08cd441c014a3",
      "impliedFormat": 1
    },
    {
      "version": "5d3e656baf210f702e4006949a640730d6aef8d6afc3de264877e0ff76335f39",
      "impliedFormat": 1
    },
    {
      "version": "a42db31dacd0fa00d7b13608396ca4c9a5494ae794ad142e9fb4aa6597e5ca54",
      "impliedFormat": 1
    },
    {
      "version": "4d2b263907b8c03c5b2df90e6c1f166e9da85bd87bf439683f150afc91fce7e7",
      "impliedFormat": 1
    },
    {
      "version": "c70e38e0f30b7c0542af9aa7e0324a23dd2b0c1a64e078296653d1d3b36fa248",
      "impliedFormat": 1
    },
    {
      "version": "b7521b70b7fbcf0c3d83d6b48404b78b29a1baead19eb6650219e80fd8dcb6e1",
      "impliedFormat": 1
    },
    {
      "version": "b7b881ced4ed4dee13d6e0ccdb2296f66663ba6b1419767271090b3ff3478bb9",
      "impliedFormat": 1
    },
    {
      "version": "b70bd59e0e52447f0c0afe7935145ef53de813368f9dd02832fa01bb872c1846",
      "impliedFormat": 1
    },
    {
      "version": "63c36aa73242aa745fae813c40585111ead225394b0a0ba985c2683baa6b0ef9",
      "impliedFormat": 1
    },
    {
      "version": "3e7ffc7dd797e5d44d387d0892bc288480493e73dcab9832812907d1389e4a98",
      "impliedFormat": 1
    },
    {
      "version": "db011ec9589fd51995cbd0765673838e38e6485a6559163cc53dcf508b480909",
      "impliedFormat": 1
    },
    {
      "version": "e1a4253f0cca15c14516f52a2ad36c3520b140b5dfb3b3880a368cd75d45d6d9",
      "impliedFormat": 1
    },
    {
      "version": "159af954f2633a12fdee68605009e7e5b150dbeb6d70c46672fd41059c154d53",
      "impliedFormat": 1
    },
    {
      "version": "a1b36a1f91a54daf2e89e12b834fa41fb7338bc044d1f08a80817efc93c99ee5",
      "impliedFormat": 1
    },
    {
      "version": "8bb4a5b632dd5a868f3271750895cb61b0e20cff82032d87e89288faee8dd6e2",
      "impliedFormat": 1
    },
    {
      "version": "039ab44466a5ea4d2629f0d728f80dda8593f26b34357096c1ab06f2fb84c956",
      "impliedFormat": 1
    },
    {
      "version": "017de6fdabea79015d493bf71e56cbbff092525253c1d76003b3d58280cd82a0",
      "impliedFormat": 1
    },
    {
      "version": "ab9ea2596cb7800bd79d1526930c785606ec4f439c275adbca5adc1ddf87747d",
      "impliedFormat": 1
    },
    {
      "version": "6b7fcccc9beebd2efadc51e969bf390629edce4d0a7504ee5f71c7655c0127b7",
      "impliedFormat": 1
    },
    {
      "version": "6745b52ab638aaf33756400375208300271d69a4db9d811007016e60a084830f",
      "impliedFormat": 1
    },
    {
      "version": "90ee466f5028251945ee737787ee5e920ee447122792ad3c68243f15efa08414",
      "impliedFormat": 1
    },
    {
      "version": "02ea681702194cfc62558d647243dbd209f19ee1775fb56f704fe30e2db58e08",
      "impliedFormat": 1
    },
    {
      "version": "1d567a058fe33c75604d2f973f5f10010131ab2b46cf5dddd2f7f5ee64928f07",
      "impliedFormat": 1
    },
    {
      "version": "5af5ebe8c9b84f667cd047cfcf1942d53e3b369dbd63fbea2a189bbf381146c6",
      "impliedFormat": 1
    },
    {
      "version": "a64e1daa4fc263dff88023c9e78bf725d7aba7def44a89a341c74c647afe80cc",
      "impliedFormat": 1
    },
    {
      "version": "f444cfd9eb5bcbc86fba3d7ca76d517e7d494458b4f04486090c6ccd40978ce7",
      "impliedFormat": 1
    },
    {
      "version": "5099990c9e11635f284bde098176e2e27e5afc562d98f9e4258b57b2930c5ea6",
      "impliedFormat": 1
    },
    {
      "version": "cf7dc8abfb13444c1756bbac06b2dd9f03b5bc90c0ebc1118796dae1981c12e6",
      "impliedFormat": 1
    },
    {
      "version": "3cc594d4e993618dc6a84d210b96ac1bd589a5a4b772fd2309e963132cb73cca",
      "impliedFormat": 1
    },
    {
      "version": "f189f28612dfeac956380eccea5be2f44dcac3d9a06cf55d41d23b7e99959387",
      "impliedFormat": 1
    },
    {
      "version": "b3f82681e61a3e1f4592c1554361a858087cd04ee3112ce73186fc79deeeabde",
      "impliedFormat": 1
    },
    {
      "version": "e647d13de80e1b6b4e1d94363ea6f5f8f77dfb95d562748b488a7248af25aabf",
      "impliedFormat": 1
    },
    {
      "version": "1567dbd347b2917ba5a386f713e45c346a15b0e1e408d4a83f496d6a3481768b",
      "impliedFormat": 1
    },
    {
      "version": "219a25474e58a8161b242776856ec5f6960839b63e74809445e51cadbfc18096",
      "impliedFormat": 1
    },
    {
      "version": "2f77672836c646d02dd1fb6c8d24e9cd8c63131c5e9c37e72f30856b1d740e62",
      "impliedFormat": 1
    },
    {
      "version": "6309a45fc3c03d3c4d56228e995d51974f53009a842374695b34f3607877e5a3",
      "impliedFormat": 1
    },
    {
      "version": "bef94eba81ae2c09059c0d9abdb1ae1b7090314f70550f3c8cd5d7ead4a4f212",
      "impliedFormat": 1
    },
    {
      "version": "48b787ad458be9b524fa5fdfef34f68798074132d4b8cfe6a6fe9c2bf334c532",
      "impliedFormat": 1
    },
    {
      "version": "37280465f8f9b2ea21d490979952b18b7f4d1f0d8fab2d627618fb2cfa1828e3",
      "impliedFormat": 1
    },
    {
      "version": "77d2e5fe68865c678ec562561aad45cfd86ef2f62281ce9bafd471b4f76b8d86",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "3f3f85dc43cb93c5a797f1ff0fa948d0e17843a443ae11a20cc032ccdf1b9997",
      "impliedFormat": 1
    },
    {
      "version": "581843e855d92557cbe9dfe242de4e53badae5e9096ca593b50788f7c89c37f2",
      "impliedFormat": 1
    },
    {
      "version": "869010bc679df668137cb3b78a3cb8196e97acf285208a57f6156ceac894a2f7",
      "impliedFormat": 1
    },
    {
      "version": "bcae62618c23047e36d373f0feac5b13f09689e4cd08e788af13271dbe73a139",
      "impliedFormat": 1
    },
    {
      "version": "2c49c6d7da43f6d21e2ca035721c31b642ebf12a1e5e64cbf25f9e2d54723c36",
      "impliedFormat": 1
    },
    {
      "version": "5ae003688265a1547bbcb344bf0e26cb994149ac2c032756718e9039302dfac8",
      "impliedFormat": 1
    },
    {
      "version": "ff1d5585a223a2ff2586567e2b3f372421b363739d4812ae6555eb38e2d0f293",
      "impliedFormat": 1
    },
    {
      "version": "ba8a615335e3dfdf0773558357f15edfff0461db9aa0aef99c6b60ebd7c40344",
      "impliedFormat": 1
    },
    {
      "version": "dd21167f276d648aa8a6d0aacd796e205d822406a51420b7d7f5aa18a6d9d6d9",
      "impliedFormat": 1
    },
    {
      "version": "3a00da80b5e7a6864fb8113721d8f7df70e09f878d214fb90bb46833709f07b9",
      "impliedFormat": 1
    },
    {
      "version": "a86053981218db1594bd4839bde0fb998e342ecf04967622495434a8f52a4041",
      "impliedFormat": 1
    },
    {
      "version": "5c317403752871838140f70879b09509e37422e92e7364b4363c7b179310ee44",
      "impliedFormat": 1
    },
    {
      "version": "8b15e8af2fc862870418d0a082a9da2c2511b962844874cf3c2bad6b2763ca10",
      "impliedFormat": 1
    },
    {
      "version": "3d399835c3b3626e8e00fefc37868efe23dbb660cce8742486347ad29d334edd",
      "impliedFormat": 1
    },
    {
      "version": "b262699ba3cc0cae81dae0d9ff1262accf9832b2b7ee6548c626d74076bff8fe",
      "impliedFormat": 1
    },
    {
      "version": "057cac07c7bc5abdcfba44325fcea4906dff7919a3d7d82d4ec40f8b4c90cf2f",
      "impliedFormat": 1
    },
    {
      "version": "d94034601782f828aa556791279c86c37f09f7034a2ab873eefe136f77a6046b",
      "impliedFormat": 1
    },
    {
      "version": "fd25b101370ee175be080544387c4f29c137d4e23cad4de6c40c044bed6ecf99",
      "impliedFormat": 1
    },
    {
      "version": "8175f51ec284200f7bd403cb353d578e49a719e80416c18e9a12ebf2c4021b2b",
      "impliedFormat": 1
    },
    {
      "version": "e3acb4eb63b7fc659d7c2ac476140f7c85842a516b98d0e8698ba81650a1abd4",
      "impliedFormat": 1
    },
    {
      "version": "4ee905052d0879e667444234d1462540107789cb1c80bd26e328574e4f3e4724",
      "impliedFormat": 1
    },
    {
      "version": "a7088b8d6472f674000b9185deab1e2c2a77df6537e126f226591044ae2d128a",
      "impliedFormat": 1
    },
    {
      "version": "445fe49dc52d5d654a97d142b143fa2fb1dc16a86906545619b521b1561df501",
      "impliedFormat": 1
    },
    {
      "version": "c0c0b22cefd1896b92d805556fcabda18720d24981b8cb74e08ffea1f73f96c2",
      "impliedFormat": 1
    },
    {
      "version": "ceec94a0cd2b3a121166b6bfe968a069f33974b48d9c3b45f6158e342396e6b2",
      "impliedFormat": 1
    },
    {
      "version": "49e35a90f8bd2aa4533286d7013d9c9ff4f1d9f2547188752c4a88c040e42885",
      "impliedFormat": 1
    },
    {
      "version": "09043c4926b04870c1fdfdea3f5fcf40a1c9912304a757326e505bebe04a6d5c",
      "impliedFormat": 1
    },
    {
      "version": "cc5dfb7ddc9ab17cf793506f342fffdcb2b6d1d7a9c0e7c8339772fee42b7f91",
      "impliedFormat": 1
    },
    {
      "version": "88c34f554b5926f4988d9ff26f84c4f18a4d010f261dac2ed52055eefb9e3c65",
      "impliedFormat": 1
    },
    {
      "version": "a7aec47aa991ef5080126c3e2732a8488c13fd846099f89b0d24dc35c0f790d3",
      "impliedFormat": 1
    },
    {
      "version": "35085777eb17b745911d00a75be17096fe28a8766081cbd644ef15b4ba756aa2",
      "impliedFormat": 1
    },
    {
      "version": "cb498c53a9d35ac1cf9a3515f3835d48b4626a612cf7540c5bfb99542c9ab1a5",
      "impliedFormat": 1
    },
    {
      "version": "0ace3010fe4a0e820155e3ccb0172375a01162e528ffc22eec2fa33d697bff24",
      "impliedFormat": 1
    },
    {
      "version": "a1b64f86e1279835a2edc6125121dff74b04ef116d0230c20995b013ba37150e",
      "impliedFormat": 1
    },
    {
      "version": "39121347a4fa76cf47e67e1259fb0136325528a22bd54b1af6dbec353edf4b01",
      "impliedFormat": 1
    },
    {
      "version": "f3c3f17825c6a78681186da04c2f3a0f1c60cfa95f3d4b82bbbd6ebd57214a6a",
      "impliedFormat": 1
    },
    {
      "version": "eb45a1782ef50423c1ffac4d2a89c60004f4e2d25ed8e7dcb9e24e6cf984ccdb",
      "impliedFormat": 1
    },
    {
      "version": "07c333db8a26594bf2b80cf7b0ef0a83c42c28cb31cc727040f20061558df819",
      "impliedFormat": 1
    },
    {
      "version": "e5151e18c3e8d5d2f83ac60a4f4117f9bee54f643b64335858ceaa818e35d364",
      "impliedFormat": 1
    },
    {
      "version": "b52b0da52d2fee96d855936e9f3de93ea57e893677e776a46fc6eca96373d3be",
      "impliedFormat": 1
    },
    {
      "version": "03b7428a52323f9d455380f00da4f4b0798acb4f5f1c77525b48cb97ad9bc83c",
      "impliedFormat": 1
    },
    {
      "version": "6c3cf6de27512969bf59a541bd8e845ba1233e101e14c844e87d81e921fffa53",
      "impliedFormat": 1
    },
    {
      "version": "19207ec935fb6b0c022cdfd038ceffef1c948510394f249bde982170d4e57067",
      "impliedFormat": 1
    },
    {
      "version": "5276cc934ad4e253f53cf2331268451a66ebf711a027e71f4535af8642055bf8",
      "impliedFormat": 1
    },
    {
      "version": "185c55e63eec9da8263b4b1cf447d2ebe2fd7b892e5a0a5571e7e97b3c767bbb",
      "impliedFormat": 1
    },
    {
      "version": "f842cd4c63a3b077cf04f7d37ca163ab716f70f60ca5c5eed5c16b09a4c50c3a",
      "impliedFormat": 1
    },
    {
      "version": "00abe3d3cd26fcaf76ffeb6fde4ff7d6c8ad8154ac6c5ba41e05b4572fcd152b",
      "impliedFormat": 1
    },
    {
      "version": "49b3c93485a6c4cbc837b1959b07725541da298ef24d0e9e261f634a3fd34935",
      "impliedFormat": 1
    },
    {
      "version": "abf39cc833e3f8dfa67b4c8b906ac8d8305cf1050caed6c68b69b4b88f3f6321",
      "impliedFormat": 1
    },
    {
      "version": "dbbe2af77238c9c899b5369eca17bc950e4b010fa00bc2d340b21fa1714b8d54",
      "impliedFormat": 1
    },
    {
      "version": "c73d2f60d717b051a01b24cb97736e717d76863e7891eca4951e9f7f3bf6a0e6",
      "impliedFormat": 1
    },
    {
      "version": "2b79620ef917502a3035062a2fd0e247d21a22fef2b2677a2398b1546c93fb64",
      "impliedFormat": 1
    },
    {
      "version": "a54f60678f44415d01a810ca27244e04b4dde3d9b6d9492874262f1a95e56c7d",
      "impliedFormat": 1
    },
    {
      "version": "84058607d19ac1fdef225a04832d7480478808c094cbaedbceda150fa87c7e25",
      "impliedFormat": 1
    },
    {
      "version": "415d60633cf542e700dc0d6d5d320b31052efbdc519fcd8b6b30a1f992ef6d5c",
      "impliedFormat": 1
    },
    {
      "version": "901c640dced9243875645e850705362cb0a9a7f2eea1a82bb95ed53d162f38dd",
      "impliedFormat": 1
    },
    {
      "version": "ebb0d92294fe20f62a07925ce590a93012d6323a6c77ddce92b7743fa1e9dd20",
      "impliedFormat": 1
    },
    {
      "version": "b499f398b4405b9f073b99ad853e47a6394ae6e1b7397c5d2f19c23a4081f213",
      "impliedFormat": 1
    },
    {
      "version": "ef2cbb05dee40c0167de4e459b9da523844707ab4b3b32e40090c649ad5616e9",
      "impliedFormat": 1
    },
    {
      "version": "068a22b89ecc0bed7182e79724a3d4d3d05daacfe3b6e6d3fd2fa3d063d94f44",
      "impliedFormat": 1
    },
    {
      "version": "3f2009badf85a479d3659a735e40607d9f00f23606a0626ae28db3da90b8bf52",
      "impliedFormat": 1
    },
    {
      "version": "2c70425bd71c6c25c9765bc997b1cc7472bdc3cb4db281acda4b7001aec6f86f",
      "impliedFormat": 1
    },
    {
      "version": "8ed892f4b45c587ed34be88d4fc24cb9c72d1ed8675e4b710f7291fcba35d22a",
      "impliedFormat": 1
    },
    {
      "version": "d32b5a3d39b581f0330bd05a5ef577173bd1d51166a7fff43b633f0cc8020071",
      "impliedFormat": 1
    },
    {
      "version": "3f6af667357384c1f582ef006906ba36668dd87abe832f4497fffb315c160be9",
      "impliedFormat": 1
    },
    {
      "version": "363dd28f6a218239fbd45bbcc37202ad6a9a40b533b3e208e030137fa8037b03",
      "impliedFormat": 1
    },
    {
      "version": "c6986e90cf95cf639f7f55d8ca49c7aaf0d561d47e6d70ab6879e40f73518c8d",
      "impliedFormat": 1
    },
    {
      "version": "bb9918dbd22a2aa56203ed38b7e48d171262b09ce690ff39bae8123711b8e84a",
      "impliedFormat": 1
    },
    {
      "version": "1518707348d7bd6154e30d49487ba92d47b6bd9a32d320cd8e602b59700b5317",
      "impliedFormat": 1
    },
    {
      "version": "ede55f9bac348427d5b32a45ad7a24cc6297354289076d50c68f1692add61bce",
      "impliedFormat": 1
    },
    {
      "version": "d53a7e00791305f0bd04ea6e4d7ea9850ccc3538877f070f55308b3222f0a793",
      "impliedFormat": 1
    },
    {
      "version": "4ea5b45c6693288bb66b2007041a950a9d2fe765e376738377ba445950e927f6",
      "impliedFormat": 1
    },
    {
      "version": "7f25e826bfabe77a159a5fec52af069c13378d0a09d2712c6373ff904ba55d4b",
      "impliedFormat": 1
    },
    {
      "version": "ea2de1a0ec4c9b8828154a971bfe38c47df2f5e9ec511f1a66adce665b9f04b0",
      "impliedFormat": 1
    },
    {
      "version": "63c0926fcd1c3d6d9456f73ab17a6affcdfc41f7a0fa5971428a57e9ea5cf9e0",
      "impliedFormat": 1
    },
    {
      "version": "c30b346ad7f4df2f7659f5b3aff4c5c490a1f4654e31c44c839292c930199649",
      "impliedFormat": 1
    },
    {
      "version": "4ef0a17c5bcae3d68227136b562a4d54a4db18cfa058354e52a9ac167d275bbb",
      "impliedFormat": 1
    },
    {
      "version": "042b80988f014a04dd5808a4545b8a13ca226c9650cb470dc2bf6041fc20aca2",
      "impliedFormat": 1
    },
    {
      "version": "64269ed536e2647e12239481e8287509f9ee029cbb11169793796519cc37ecd4",
      "impliedFormat": 1
    },
    {
      "version": "c06fd8688dd064796b41170733bba3dcacfaf7e711045859364f4f778263fc7b",
      "impliedFormat": 1
    },
    {
      "version": "b0a8bf71fea54a788588c181c0bffbdd2c49904075a7c9cb8c98a3106ad6aa6d",
      "impliedFormat": 1
    },
    {
      "version": "434c5a40f2d5defeede46ae03fb07ed8b8c1d65e10412abd700291b24953c578",
      "impliedFormat": 1
    },
    {
      "version": "c5a6184688526f9cf53e3c9f216beb2123165bfa1ffcbfc7b1c3a925d031abf7",
      "impliedFormat": 1
    },
    {
      "version": "cd548f9fcd3cebe99b5ba91ae0ec61c3eae50bed9bc3cfd29d42dcfc201b68b5",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "14a8ec10f9faf6e0baff58391578250a51e19d2e14abcc6fc239edb0fb4df7c5",
      "impliedFormat": 1
    },
    {
      "version": "81b0cf8cd66ae6736fd5496c5bbb9e19759713e29c9ed414b00350bd13d89d70",
      "impliedFormat": 1
    },
    {
      "version": "4992afbc8b2cb81e0053d989514a87d1e6c68cc7dedfe71f4b6e1ba35e29b77a",
      "impliedFormat": 1
    },
    {
      "version": "f15480150f26caaccf7680a61c410a07bd4c765eedc6cbdca71f7bca1c241c32",
      "impliedFormat": 1
    },
    {
      "version": "1c390420d6e444195fd814cb9dc2d9ca65e86eb2df9c1e14ff328098e1dc48ae",
      "impliedFormat": 1
    },
    {
      "version": "ec8b45e83323be47c740f3b573760a6f444964d19bbe20d34e3bca4b0304b3ad",
      "impliedFormat": 1
    },
    {
      "version": "ab8b86168ceb965a16e6fc39989b601c0857e1fd3fd63ff8289230163b114171",
      "impliedFormat": 1
    },
    {
      "version": "62d2f0134c9b53d00823c0731128d446defe4f2434fb84557f4697de70a62789",
      "impliedFormat": 1
    },
    {
      "version": "02c7b5e50ac8fb827c9cdcd22e3e57e8ebd513f0670d065349bef3b417f706f8",
      "impliedFormat": 1
    },
    {
      "version": "9a197c04325f5ffb91b81d0dca917a656d29542b7c54c6a8092362bad4181397",
      "impliedFormat": 1
    },
    {
      "version": "e6c3141ae9d177716b7dd4eee5571eb76d926144b4a7349d74808f7ff7a3dee0",
      "impliedFormat": 1
    },
    {
      "version": "d8d48515af22cb861a2ac9474879b9302b618f2ed0f90645f0e007328f2dbb90",
      "impliedFormat": 1
    },
    {
      "version": "e9ad7a5fecd647e72338a98b348540ea20639dee4ea27846cbe57c744f78ec2d",
      "impliedFormat": 1
    },
    {
      "version": "2c531043b1d58842c58e0a185c7bd5ce31e9a708667398373d6b113938629f90",
      "impliedFormat": 1
    },
    {
      "version": "5304a80e169ba8fe8d9c77806e393db1f708333afc1f95dede329fdbd84e29c7",
      "impliedFormat": 1
    },
    {
      "version": "7f0f90d0ffdd54875c464b940afaa0f711396f65392f20e9ffafc0af12ccbf14",
      "impliedFormat": 1
    },
    {
      "version": "2e93bb867fefffaecf9a54a91dbf271787e007ec2fe301d3dce080944c5518e5",
      "impliedFormat": 1
    },
    {
      "version": "3ab58250eb2968101cb0f3698aab0faa603660bc2d41d30ae13eaa22d75900d1",
      "impliedFormat": 1
    },
    {
      "version": "1f18ceea8d29b75099cc85f357622e87d6a2e0793486f89ab6da32cf9e434feb",
      "impliedFormat": 1
    },
    {
      "version": "c280ec77789efcf60ea1f6fd7159774422f588104dae9dfa438c9c921f5ab168",
      "impliedFormat": 1
    },
    {
      "version": "2826b3526af4f0e2c8f303e7a9a9a6bb8632e4a96fece2c787f2df286a696cea",
      "impliedFormat": 1
    },
    {
      "version": "3ec6d90ec9586e6e96120ff558429cac6ca656d81eb644ce703f736a316a0cd6",
      "impliedFormat": 1
    },
    {
      "version": "453b07099526a6d20fd30f357059d413677f919df8abf7346fab7c9abfec43fa",
      "impliedFormat": 1
    },
    {
      "version": "485f7d76af9e2b5af78aac874b0ac5563c2ae8c0a7833f62b24d837df8561fb9",
      "impliedFormat": 1
    },
    {
      "version": "8bdf41d41ff195838a5f9e92e5cb3dfcdc4665bcca9882b8d2f82a370a52384e",
      "impliedFormat": 1
    },
    {
      "version": "0a3351a5b3c74e9b822ade0e87a866bc7c010c1618bcde4243641817883fb8df",
      "impliedFormat": 1
    },
    {
      "version": "fe8a3e5492c807cc5cfc8dda4e6464aff0f991dc54db09be5d620fb4968ba101",
      "impliedFormat": 1
    },
    {
      "version": "03742d13572a69af40e24e742f3c40e58dc817aa51776477cf2757ee106c6c89",
      "impliedFormat": 1
    },
    {
      "version": "414f9c021dde847ee2382c4086f7bd3a49a354be865f8db898ee89214b2d2ced",
      "impliedFormat": 1
    },
    {
      "version": "bbbc43627abe35080c1ab89865ec63645977025d0161bc5cc2121dfd8bc8bc2e",
      "impliedFormat": 1
    },
    {
      "version": "0be66c79867b62eabb489870ba9661c60c32a5b7295cce269e07e88e7bee5bf3",
      "impliedFormat": 1
    },
    {
      "version": "f245714370dd2fdb586b6f216e39dc73fb81d9a49fcb76542a8ad16873b92044",
      "impliedFormat": 1
    },
    {
      "version": "3a19286bcc9303c9352c03d68bb4b63cecbf5c9b7848465847bb6c9ceafa1484",
      "impliedFormat": 1
    },
    {
      "version": "c573fef34c2e5cc5269fd9c95fe73a1eb9db17142f5d8f36ffe4a686378b8660",
      "impliedFormat": 1
    },
    {
      "version": "d97e30dd93590392fed422f2b27325d10ab007d034faaaf61e28e9ddc9d3825b",
      "impliedFormat": 1
    },
    {
      "version": "d1f8a829c5e90734bb47a1d1941b8819aeee6e81a2a772c3c0f70b30e3693fa9",
      "impliedFormat": 1
    },
    {
      "version": "be1dfacee25a14d79724ba21f1fde67f966b46e2128c68fed2e48c6e1e9822c5",
      "impliedFormat": 1
    },
    {
      "version": "19b3d0c212d241c237f79009b4cd0051e54971747fd89dc70a74f874d1192534",
      "impliedFormat": 1
    },
    {
      "version": "d6a0db08bed9312f7c4245ee3db068a96c4893ea7df69863eb9dd9c0af5b28f7",
      "impliedFormat": 1
    },
    {
      "version": "f17963b9935dd2142c08b006da53afeeaca2c9a600485f6eb9c018b96687275b",
      "impliedFormat": 1
    },
    {
      "version": "6671e036f299eda709114347015eb9cf2da8f9ea158871da9c21e9056f7e26ac",
      "impliedFormat": 1
    },
    {
      "version": "8375cf1206fa01c23097e5293405d442c83fd03109e938d1bf3d9784f84c2dbc",
      "impliedFormat": 1
    },
    {
      "version": "585516c0e8cfe3f12497eb1fd57c56c79f22bb7d729a2c0a32c458c93af68b03",
      "impliedFormat": 1
    },
    {
      "version": "a797a41988e5ba36b6707939953b0c0395ed92b91c1189359d384ca66e8fa0ab",
      "impliedFormat": 1
    },
    {
      "version": "2b1945f9ee3ccab0ecfed15c3d03ef5a196d62d0760cffab9ec69e5147f4b5aa",
      "impliedFormat": 1
    },
    {
      "version": "96f215cefc7628ac012e55c7c3e4e5ce342d66e83826777a28e7ed75f7935e10",
      "impliedFormat": 1
    },
    {
      "version": "82b4045609dc0918319f835de4f6cb6a931fd729602292921c443a732a6bb811",
      "impliedFormat": 1
    },
    {
      "version": "0fd70ca1eaef1e2dd6f48f16886df4838664821d992fd8076d07fc15e83c8498",
      "impliedFormat": 1
    },
    {
      "version": "ba30e6d2f1d20c707566cf485167331a10c539802a79040ced055b62a7aae53e",
      "impliedFormat": 1
    },
    {
      "version": "a07a62ef26968e6f49f8a3b438bd9eb6f4eddce472f1f86a2eb38d303b6916f6",
      "impliedFormat": 1
    },
    {
      "version": "414726e007c03d228dcb309a9182a773109c7190a8701b10f579632adb2b5003",
      "impliedFormat": 1
    },
    {
      "version": "537a2b61594512c5e75fad7e29d25c23922e27e5a1506eb4fce74fe858472a6e",
      "impliedFormat": 1
    },
    {
      "version": "311ca94091f3db783c0874128808d0f93ab5d7be82abc20ceb74afe275315d4a",
      "impliedFormat": 1
    },
    {
      "version": "7c07838da165fd43759a54d2d490461315e977f9f37c046e0e357623c657fc42",
      "impliedFormat": 1
    },
    {
      "version": "b311d973a0028d6bc19dfbaae891ad3f7c5057684eb105cfbeec992ab71fbc13",
      "impliedFormat": 1
    },
    {
      "version": "8a49e533b98d5c18a8d515cd3ae3bab9d02b6d4a9ac916e1dba9092ca0ebff15",
      "impliedFormat": 1
    },
    {
      "version": "a4c6a9f2ffe4ddcd6a7f25b913f7bc0238c41e4807e9c5b939a53f2e223cdea1",
      "impliedFormat": 1
    },
    {
      "version": "ce6c6b9cb612f81cc9c96831a4359124f75a9a343b6601ace601e615a37633fc",
      "impliedFormat": 1
    },
    {
      "version": "6d136510215aa809f7b2d0629d15065d1ffb6e0a76f25b34556f334156831730",
      "impliedFormat": 1
    },
    {
      "version": "a36185e1a88f282ea24652c90f8fd6e6738a9b01aca90929664152966df4574f",
      "impliedFormat": 1
    },
    {
      "version": "6621af294bd4af8f3f9dd9bd99bd83ed8d2facd16faa6690a5b02d305abd98ab",
      "impliedFormat": 1
    },
    {
      "version": "5eada4495ab95470990b51f467c78d47aecfccc42365df4b1e7e88a2952af1a3",
      "impliedFormat": 1
    },
    {
      "version": "ba87016094bafb7adef4665c2ae4bea1d93da4c02e439b26ea147f5e16c56107",
      "impliedFormat": 1
    },
    {
      "version": "40e9c2028b34c6c1e3281818d062f7008705254ee992d9857d051c603391e0f4",
      "impliedFormat": 1
    },
    {
      "version": "44810c4c590f5c4517dfa39d74161cfa3a838437f92683cb2eed28ff83fb6a97",
      "impliedFormat": 1
    },
    {
      "version": "4a34de405e3017bf9e153850386aacdf6d26bbcd623073d13ab3c42c2ae7314c",
      "impliedFormat": 1
    },
    {
      "version": "fe2d1251f167d801a27f0dfb4e2c14f4f08bf2214d9784a1b8c310fdfdcdaaea",
      "impliedFormat": 1
    },
    {
      "version": "2a1182578228dc1faad14627859042d59ea5ab7e3ac69cb2a3453329aaaa3b83",
      "impliedFormat": 1
    },
    {
      "version": "dfa99386b9a1c1803eb20df3f6d3adc9e44effc84fa7c2ab6537ed1cb5cc8cfb",
      "impliedFormat": 1
    },
    {
      "version": "79b0d5635af72fb87a2a4b62334b0ab996ff7a1a14cfdb895702e74051917718",
      "impliedFormat": 1
    },
    {
      "version": "5f00b052713bfe8e9405df03a1bbe406006b30ec6b0c2ce57d207e70b48cf4e9",
      "impliedFormat": 1
    },
    {
      "version": "7abcae770f21794b5ffbc3186483c3dbcf8b0c8e37d3ef3ed6277ece5c5dd4be",
      "impliedFormat": 1
    },
    {
      "version": "4720efe0341867600b139bca9a8fa7858b56b3a13a4a665bd98c77052ca64ea4",
      "impliedFormat": 1
    },
    {
      "version": "566fc645642572ec1ae3981e3c0a7dc976636976bd7a1d09740c23e8521496e5",
      "impliedFormat": 1
    },
    {
      "version": "66182e2432a30468eb5e2225063c391262b6a6732928bbc8ee794642b041dd87",
      "impliedFormat": 1
    },
    {
      "version": "11792ab82e35e82f93690040fd634689cad71e98ab56e0e31c3758662fc85736",
      "impliedFormat": 1
    },
    {
      "version": "0b2095c299151bc492b6c202432cb456fda8d70741b4fd58e86220b2b86e0c30",
      "impliedFormat": 1
    },
    {
      "version": "6c53c05df974ece61aca769df915345dc6d5b7649a01dc715b7da1809ce00a77",
      "impliedFormat": 1
    },
    {
      "version": "18c505381728b8cc6ea6986728403c1969f0d81216ed04163a867780af89f839",
      "impliedFormat": 1
    },
    {
      "version": "d121a48de03095d7dd5cd09d39e1a1c4892b520dad4c1d9c339c5d5008cfb536",
      "impliedFormat": 1
    },
    {
      "version": "3592c16d8a782be215356cb78cc3f6fad6132e802d157a874c1942d163151dcc",
      "impliedFormat": 1
    },
    {
      "version": "480ea50ea1ee14d243ea72e09d947488300ac6d82e98d6948219f47219511b8b",
      "impliedFormat": 1
    },
    {
      "version": "d575bcf7ebd470d7accf5787a0cf0f3c88c33ca7c111f277c03ebbe6d0e8b0b5",
      "impliedFormat": 1
    },
    {
      "version": "72141538e52e99ca6e7a02d80186ba8c877ff47a606fea613be1b7a3439c2b90",
      "impliedFormat": 1
    },
    {
      "version": "b43a0693d7162abf3a5b3b9e78acfafd0d4713af4d54d1778900e30c11bc4f83",
      "impliedFormat": 1
    },
    {
      "version": "115b155584649eaf75d50bdc8aaa9a0f528b60fade90f0cf78137c875ff7de7c",
      "impliedFormat": 1
    },
    {
      "version": "98d88eefab45da6b844d2bee8f6efa8d20c879f6dc870c17b90608a4ac0ad527",
      "impliedFormat": 1
    },
    {
      "version": "4eb2ca099a3febd21e98c36e29b3a9472458a1e76e888bf6499614c895ba6be7",
      "impliedFormat": 1
    },
    {
      "version": "f4dc28fbbba727722cb1fd82f51a7b9540fbe410ed04ddf35cab191d6aa2ba10",
      "impliedFormat": 1
    },
    {
      "version": "b8101e982968b04cfaabfc9613dc8f8244e0a8607007bba3537c1f7cbb2a9242",
      "impliedFormat": 1
    },
    {
      "version": "ed3e176bc769725ebc1d93f1d6890fc3d977b9155ae5d03be96ec2d49b303370",
      "impliedFormat": 1
    },
    {
      "version": "df032c6c1bad723c3f030dd36289fa04cd5375a999aa6a327d7319b2b29368a5",
      "impliedFormat": 1
    },
    {
      "version": "fc5221aedb3b5c52b4fbdf7b940c2115bde632f6cba52e05599363d5cd31019e",
      "impliedFormat": 1
    },
    {
      "version": "0289a27db91cb5a004dcf1e6192a09a1f9e8ff8ce606ff8fd691d42de5752123",
      "impliedFormat": 1
    },
    {
      "version": "dbb3a46b5070ee274b2cebef3562610d0be4ac5d4e2661695cc9bbe427a631f0",
      "impliedFormat": 1
    },
    {
      "version": "20252c8ca030a50addd53074531d3928c474081ac61c174b861c3ab4af366982",
      "impliedFormat": 1
    },
    {
      "version": "493534cea0a672ef2cfe5ecee1404e9e9729a88e07f892c045ff27e685ef8854",
      "impliedFormat": 1
    },
    {
      "version": "4a48a731413b6fae34620c2e458d0adf2f74083073544a72b1b3a96c32775b2f",
      "impliedFormat": 1
    },
    {
      "version": "d405963c5f69955e95c30ef121c7a3309f214f21ef09dceb5d7ac69557cbe0fa",
      "impliedFormat": 1
    },
    {
      "version": "b403746aa9e44b5b10a6c1d2ebcf35be1a714e570c7d801cefbf4a066f47ab30",
      "impliedFormat": 1
    },
    {
      "version": "c3dc147af5ef951e14797da29b2dcaf1fdddabb0175d538e1bedf64a34690b9e",
      "impliedFormat": 1
    },
    {
      "version": "77e6933a0f1e4e5d355175c6d5c517398002a3eb74f2218b7670a29814259e3a",
      "impliedFormat": 1
    },
    {
      "version": "90051a939d662322dbc062f856f82ccc13fbb6b3f3bbb5d863b4c5031d4e9a85",
      "impliedFormat": 1
    },
    {
      "version": "68969a0efd9030866f60c027aedbd600f66ea09e1c9290853cc24c2dcc92000f",
      "impliedFormat": 1
    },
    {
      "version": "4dbfad496657abd078dc75749cd7853cdc0d58f5be6dfb39f3e28be4fe7e7af5",
      "impliedFormat": 1
    },
    {
      "version": "348d2fe7d7b187f09ea6488ead5eae9bfbdb86742a2bad53b03dff593a7d40d1",
      "impliedFormat": 1
    },
    {
      "version": "169eab9240f03e85bffc6e67f8b0921671122f7200da6a6a5175859cdd4f48d8",
      "impliedFormat": 1
    },
    {
      "version": "04399fe6ea95f1973a82281981af80b49db8b876df63b3d55a1e1b42e9c121a9",
      "impliedFormat": 1
    },
    {
      "version": "bda7e157a93405d95f5f9de03f94d8b4c1eff55b8e7eed0072454ee5f607933a",
      "impliedFormat": 1
    },
    {
      "version": "d5e62cfc4e6fee29bbac26819d70e2d786347d65a17efc0c85ab49d7023f9b51",
      "impliedFormat": 1
    },
    {
      "version": "06842d406f05eadefc747f4a908d0bf03fcf9dd8733017fa8e94768e3562167e",
      "impliedFormat": 1
    },
    {
      "version": "659fcc119255a5a8fcb8674235921443f5bd8fbe50de9b3c7434de0e8593d2b3",
      "impliedFormat": 1
    },
    {
      "version": "f9637e97b89b26b1bcedd8557b3b76de5173d0eea0e1bf4f0a57553ba28b22f9",
      "impliedFormat": 1
    },
    {
      "version": "c41b5d8d7f1a2ca4f7c6e9268370057a088d1bc1652b553681a16ce9f9411222",
      "impliedFormat": 1
    },
    {
      "version": "1e11773ff1c9daa2cc4a4178f7cb09aa1ef3c368fa63e63a50411d05016de1db",
      "impliedFormat": 1
    },
    {
      "version": "6156d924b38105dfdfde6d8a0945d910b9506d27e25e551c72cc616496952a5a",
      "impliedFormat": 1
    },
    {
      "version": "db06627a8bc9ff9c94a3dfbba031dd19893f0ecf09bc83735d088d1e9b8c0a10",
      "impliedFormat": 1
    },
    {
      "version": "9b94d6b8c6ebfec5f8507900f04af6aa3a1f673b76334f02ef8bf0da6b23e255",
      "impliedFormat": 1
    },
    {
      "version": "119eb483b72e7f9b1b58c07bf7195470194060f6c51fdc5b5922961734b696be",
      "impliedFormat": 1
    },
    {
      "version": "f02edee06c6a79173d26d0f1a284e73e863a1a948cd688151d8f781a8f67c931",
      "impliedFormat": 1
    },
    {
      "version": "c8b3b55d5a2dff0cbc47bb0d4e38fc73f9f68f1b9e1f62c34edb09a43b95c2dd",
      "impliedFormat": 1
    },
    {
      "version": "757f7967151a9b1f043aba090f09c1bdb0abe54f229efd3b7a656eb6da616bf4",
      "impliedFormat": 1
    },
    {
      "version": "786691c952fe3feac79aca8f0e7e580d95c19afc8a4c6f8765e99fb756d8d9d7",
      "impliedFormat": 1
    },
    {
      "version": "3dfd48c19c6c245e74df4b2c04b6d0f1db0cfdac3536e64998d60c26aaf71294",
      "impliedFormat": 1
    },
    {
      "version": "ca9c62b4a4ef031e540fdb29202df397778053cc3d1d69a247cfb48740696f1d",
      "impliedFormat": 1
    },
    {
      "version": "40ab53ad78a76cb291d1fa82d8e9280aaaece3ae8510e59429c43e720b719e60",
      "impliedFormat": 1
    },
    {
      "version": "42534f3ebe5fb14f5face2c556631cfebf0ad77e3d351529848e84c4cb1091f8",
      "impliedFormat": 1
    },
    {
      "version": "179c27348124b09f18ef768012f87b2b7f1cdc57f15395af881a762b0d4ba270",
      "impliedFormat": 1
    },
    {
      "version": "651fe75dc9169834ef495a27540cff1969b63ccdac1356c9de888aaca991bfbf",
      "impliedFormat": 1
    },
    {
      "version": "ab0926fedbd1f97ec02ed906cf4b1cf74093ab7458a835c3617dba60f1950ba3",
      "impliedFormat": 1
    },
    {
      "version": "ce9abc5ff833d7c27a30e28b046e8d96b79d4236be87910e1ef278230e1a0d58",
      "impliedFormat": 1
    },
    {
      "version": "7f5a6eac3d3d334e2f2eba41f659e9618c06361958762869055e22219f341554",
      "impliedFormat": 1
    },
    {
      "version": "e6773ee69d14a45b44efa16a473a6366d07f61cd4f131b9fea7cd2e5b36a265c",
      "impliedFormat": 1
    },
    {
      "version": "4093c47f69ea7acf0931095d5e01bfe1a0fa78586dbf13f4ae1142f190d82cc4",
      "impliedFormat": 1
    },
    {
      "version": "4fc9939c86a7d80ab6a361264e5666336d37e080a00d831d9358ad83575267da",
      "impliedFormat": 1
    },
    {
      "version": "f4ba385eedea4d7be1feeeac05aaa05d6741d931251a85ab48e0610271d001ce",
      "impliedFormat": 1
    },
    {
      "version": "52ae1d7a4eb815c20512a1662ca83931919ac3bb96da04c94253064291b9d583",
      "impliedFormat": 1
    },
    {
      "version": "6fa6ceb04be38c932343d6435eb6a4054c3170829993934b013b110273fe40af",
      "impliedFormat": 1
    },
    {
      "version": "0e8536310d6ed981aa0d07c5e2ca0060355f1394b19e98654fdd5c4672431b70",
      "impliedFormat": 1
    },
    {
      "version": "e71d84f5c649e283b31835f174df2afe6a01f4ef2cb1aafca5726b7d2b73a2e4",
      "impliedFormat": 1
    },
    {
      "version": "6d26bc11d906309e5c3b12285f94d9ef8edd8529ddee60042aba8470280b8b55",
      "impliedFormat": 1
    },
    {
      "version": "8f2644578a3273f43fd700803b89b842d2cd09c1fba2421db45737357e50f5b1",
      "impliedFormat": 1
    },
    {
      "version": "639f94fe145a72ce520d3d7b9b3b6c9049624d90cbf85cff46fb47fb28d1d8fe",
      "impliedFormat": 1
    },
    {
      "version": "8327a51d574987a2b0f61ea40df4adddf959f67bc48c303d4b33d47ba3be114a",
      "impliedFormat": 1
    },
    {
      "version": "00e1da5fce4ae9975f7b3ca994dcb188cf4c21aee48643e1d6d4b44e72df21ee",
      "impliedFormat": 1
    },
    {
      "version": "4d250e905299144850c6f8e74dad1ee892d847643bacf637e89adcce013f0700",
      "impliedFormat": 1
    },
    {
      "version": "51b4ab145645785c8ced29238192f870dbb98f1968a7c7ef2580cd40663b2940",
      "impliedFormat": 1
    },
    {
      "version": "100802c3378b835a3ce31f5d108de149bd152b45b555f22f50c2cafb3a962ead",
      "impliedFormat": 1
    },
    {
      "version": "fd4fef81d1930b60c464872e311f4f2da3586a2a398a1bdf346ffc7b8863150f",
      "impliedFormat": 1
    },
    {
      "version": "354f47aa8d895d523ebc47aea561b5fedb44590ac2f0eae94b56839a0f08056a",
      "impliedFormat": 1
    },
    {
      "version": "dfa1362047315432a0f8bf3ba835ff278a8e72d42e9c89f62d18258a06b20663",
      "impliedFormat": 1
    },
    {
      "version": "67f2cd6e208e68fdfa366967d1949575df6ccf90c104fc9747b3f1bdb69ad55a",
      "impliedFormat": 1
    },
    {
      "version": "976d20bb5533077a2135f456a2b48b7adb7149e78832b182066930bad94f053a",
      "impliedFormat": 1
    },
    {
      "version": "589713fefe7282fd008a2672c5fbacc4a94f31138bae6a03db2c7b5453dc8788",
      "impliedFormat": 1
    },
    {
      "version": "26f7f55345682291a8280c99bb672e386722961063c890c77120aaca462ac2f9",
      "impliedFormat": 1
    },
    {
      "version": "62b753ed351fba7e0f6b57103529ce90f2e11b949b8fc69c39464fe958535c25",
      "impliedFormat": 1
    },
    {
      "version": "514321f6616d04f0c879ac9f06374ed9cb8eac63e57147ac954e8c0e7440ce00",
      "impliedFormat": 1
    },
    {
      "version": "b5081df0712b95c9e7b78970ecd59f2666a1f9663074c190f84901e97f71b251",
      "impliedFormat": 1
    },
    {
      "version": "50db7acb8fb7723242ec13c33bb5223537d22e732ea48105de0e2797bdeb7706",
      "impliedFormat": 1
    },
    {
      "version": "151aa7caace0a8e58772bff6e3505d06191508692d8638cd93e7ca5ecfa8cd1b",
      "impliedFormat": 1
    },
    {
      "version": "3d59b606bca764ce06d7dd69130c48322d4a93a3acb26bb2968d4e79e1461c3c",
      "impliedFormat": 1
    },
    {
      "version": "0231f8c8413370642c1c061e66b5a03f075084edebf22af88e30f5ce8dbf69f4",
      "impliedFormat": 1
    },
    {
      "version": "474d9ca594140dffc0585ce4d4acdcfba9d691f30ae2cafacc86c97981101f5c",
      "impliedFormat": 1
    },
    {
      "version": "e9ae721d2f9df91bc707ea47ddd590b04328654cfea11e79a57e5aef832709ff",
      "impliedFormat": 1
    },
    {
      "version": "0e2a6b2eeadafbc7a27909527af46705d47e93c652d656f09cc3ef460774291b",
      "impliedFormat": 1
    },
    {
      "version": "ed56810efb2b1e988af16923b08b056508755245a2f8947e6ad491c5133664ed",
      "impliedFormat": 1
    },
    {
      "version": "ed012a19811c4010cb7d8920378f6dd50f22e1cf2842ecb44a157030667b165e",
      "impliedFormat": 1
    },
    {
      "version": "26a19453ef691cc08d257fbcbcc16edb1a2e78c9b116d5ee48ed69e473c8ff76",
      "impliedFormat": 1
    },
    {
      "version": "90f08678b00c7b7aaaad0c84fb6525a11b5c35dad624b59dcadd3d279a4366c4",
      "impliedFormat": 1
    },
    {
      "version": "97ba9ccb439e5269a46562c6201063fbf6310922012fd58172304670958c21f6",
      "impliedFormat": 1
    },
    {
      "version": "50edac457bdc21b0c2f56e539b62b768f81b36c6199a87fbb63a89865b2348f0",
      "impliedFormat": 1
    },
    {
      "version": "d090654a3a57a76b5988f15b7bb7edc2cdc9c056a00985c7edd1c47a13881680",
      "impliedFormat": 1
    },
    {
      "version": "25091d25f74760301f1e094456e2e6af52ceb6ef1ece48910463528e499992d8",
      "impliedFormat": 1
    },
    {
      "version": "651fe75dc9169834ef495a27540cff1969b63ccdac1356c9de888aaca991bfbf",
      "impliedFormat": 1
    },
    {
      "version": "37c8a5c668434709a1107bcc0deb4eaee2bc2aaa4921ac3bd4324b7c2a14d7fb",
      "impliedFormat": 1
    },
    {
      "version": "e4d6f03a31978e95ee753ec8fec65a50dc4fa91bf5630109b5f8676100ec1c7a",
      "impliedFormat": 1
    },
    {
      "version": "fb9b98cf20eafb7ec5d507cf0f144a695056b96598c8f6078c9b36058055a47c",
      "impliedFormat": 1
    },
    {
      "version": "b69f00ee38cbb51c6b11205368400e10b6e761973125c6e5e4288ba1499a6750",
      "impliedFormat": 1
    },
    {
      "version": "f0f698a6dd919322ef2dbf356a35cacebebf915f69a5fda430026c3d900eb8c0",
      "impliedFormat": 1
    },
    {
      "version": "cc38246d0ac48b8f77e86a8b25ec479b7894f3b0bc396a240d531a05ad56a28a",
      "impliedFormat": 1
    },
    {
      "version": "047eada664e4ad967f12c577e85c3054751338b34fc62baedfd48d590f2480de",
      "impliedFormat": 1
    },
    {
      "version": "1a273232fbaa1389aa1e06b6799df397bbc4012a51ce4c6ea496ddc96c9f763e",
      "impliedFormat": 1
    },
    {
      "version": "853d02f4f46ca9700fefd0d45062f5b82c9335ba2224ca4d7bd34d6ae4fc4a7f",
      "impliedFormat": 1
    },
    {
      "version": "5f9ab7ba179f92fa3c5dddafec778a621fe9f64e2ba8c264ddf76fe5cf9eaf93",
      "impliedFormat": 1
    },
    {
      "version": "f3a5d6af934c0368c411773ae2797e35de76f1442f7ba7f70dc34e7b6414d44f",
      "impliedFormat": 1
    },
    {
      "version": "cfdb6424be9f96784958b8db382966517ea8d942f88820c217ac381650c83248",
      "impliedFormat": 1
    },
    {
      "version": "ad650dc0b183dca971e1f39ceebc7f8c69670e8ef608de62e9412fc45591c937",
      "impliedFormat": 1
    },
    {
      "version": "887b69ee7a553db2adcdf2ce326de30bc58d8167b5f7e0b032f967f8662afb36",
      "impliedFormat": 1
    },
    {
      "version": "0d91e0aac110b6a18bbabcb319da477d88812f2098fd628bf66184f04fd4a732",
      "impliedFormat": 1
    },
    {
      "version": "9e6b4a7b4510e81b39f3650a171a51ed9238e6cd040119ac989c9be8c4c80dbd",
      "impliedFormat": 1
    },
    {
      "version": "b2415721ef2ce2d99d0edb92eb520b30fe1eb302be075a47f115d2e70f3ad2d8",
      "impliedFormat": 1
    },
    {
      "version": "9b94d6b8c6ebfec5f8507900f04af6aa3a1f673b76334f02ef8bf0da6b23e255",
      "impliedFormat": 1
    },
    {
      "version": "fa3b257e37ce8b9f5575dd10c673770df88be410b74ffa8d575603cf261ad2e0",
      "impliedFormat": 1
    },
    {
      "version": "b3cc1bb7311f35569b531e781d4a42d2b91f8dfd8bc194cc310c8b61011d6e43",
      "impliedFormat": 1
    },
    {
      "version": "54c171f00a5219a2019296b92550daa0a6cf420fc7a4f72787be40eac1112c67",
      "impliedFormat": 1
    },
    {
      "version": "8ca2d01f5f3d4d4067aadea230570afa4c91e24e485fbe2e9d53ead3b33f80d0",
      "impliedFormat": 1
    },
    {
      "version": "14c264f4102aec813be79efb1209aa5f5245f15d96a5d581cb1bae87943f2ef5",
      "impliedFormat": 1
    },
    {
      "version": "c7ddf2aa89f4541979c8337682b6bc278e5535be0f1fac98c778e222ef357703",
      "impliedFormat": 1
    },
    {
      "version": "dcf067993ca6e8af8050ebb538f3db1d9ab49fc1d8392ab2a9e2db50919e7337",
      "impliedFormat": 1
    },
    {
      "version": "ed44c307e1ce3beb007b2618e24f31893e2eab601361d46a1d3ab7ea3a428c0e",
      "impliedFormat": 1
    },
    {
      "version": "401b83ed6f8a1a084c92f79feadeb76540a8a1945d7d000ffea91610430fd3e4",
      "impliedFormat": 1
    },
    {
      "version": "c00c2491442a7b9b888f403d160186c942da151bd671dcf37977d10de1d32498",
      "impliedFormat": 1
    },
    {
      "version": "265518a32a94d1685e1bfa58d2d06f448cf464dbd29a460cdaebeb60a56cbce9",
      "impliedFormat": 1
    },
    {
      "version": "013a48ca8d3a63582470e07f8a29c71becec9fe81f98171ef543210649f09b04",
      "impliedFormat": 1
    },
    {
      "version": "8fca3d2b2a6da9bb079ec8802926f72ce5ba8f12b10e7918590b4f2b877e960e",
      "impliedFormat": 1
    },
    {
      "version": "6b2ba8877a5518a523877073500d7316035a43c1c9758ce24b0c456147d08726",
      "impliedFormat": 1
    },
    {
      "version": "f21e4cdf26ed143e67a8c7310620bd7878978040360c22c891f5dbb01b00b257",
      "impliedFormat": 1
    },
    {
      "version": "a53a62ef9b7ffeafee6861dc047b967c6e0bf42a2a67033fada7b6e52e1bc615",
      "impliedFormat": 1
    },
    {
      "version": "35bc256273c304ef5bf203e0706ed0ed6fa9de40fad8a30eebbeee0b853dcc92",
      "impliedFormat": 1
    },
    {
      "version": "774adcddeb41ed22be4d1ab586c762ddb2948a84a7a3f9867d2cd4af1d837ffd",
      "impliedFormat": 1
    },
    {
      "version": "cfaee3e42970c0fb51fbcd015db5f9ae663b8969d5e54f7d88e3c96246517f69",
      "impliedFormat": 1
    },
    {
      "version": "c402c80b5ae39dd6122f9663d887ff9022e013bcbb7b54fbc0615cc8a2dde3ca",
      "impliedFormat": 1
    },
    {
      "version": "82af9a77dfc85173fa56109f08d66f6fe5485d7011c5c1d174fb1d5f39b0ffef",
      "impliedFormat": 1
    },
    {
      "version": "065e7ba3dc90e6adb698c206897c875c208e86d765480ae5e4c190b5fb4c7a39",
      "impliedFormat": 1
    },
    {
      "version": "940494b72aa9bbd6b99249cb12713c719c7df220c3290fb355dae5f54d2ea5d9",
      "impliedFormat": 1
    },
    {
      "version": "025eb899a885dd305be2fb16f38a1564a95ddd25d9e5e8017829304265999025",
      "impliedFormat": 1
    },
    {
      "version": "f44708ba63ee4af745ce9a3307d4f20e686ec2d075c2bc9188f9101b7fe97288",
      "impliedFormat": 1
    },
    {
      "version": "1dd37c37187e7f71a82262aaa9e2db4ea4ab5a504326324c08724ab7f51e1b63",
      "impliedFormat": 1
    },
    {
      "version": "c822a1e1245f4aebe787b381ec31e7573c859579a93023c8b00be3d9a49b66d6",
      "impliedFormat": 1
    },
    {
      "version": "a25494aaa1b278f80f73ff79bdf00107c051727162e01aa931c90331bb8ebd8f",
      "impliedFormat": 1
    },
    {
      "version": "567cfab6fb2c86ba22b6738188b33f104f23e2a7407c098a3b3970e362b83075",
      "impliedFormat": 1
    },
    {
      "version": "1e73ecd4da907926b4feee7474f7999ba70cd586d0efa981e113eb68ffa0d22d",
      "impliedFormat": 1
    },
    {
      "version": "e937fe62b1339e08caa7e22acec57be49ae83010947443512005c710cb59ec84",
      "impliedFormat": 1
    },
    {
      "version": "848eaa9d6fc56f31a6abaedb61f0825121b0cda122b58262fec156e7c4184fa5",
      "impliedFormat": 1
    },
    {
      "version": "eb2c2ecde33a819fd65ae4d123b02920f52bcc4d48752fbeb9b645334b8905c7",
      "impliedFormat": 1
    },
    {
      "version": "0b9382de2576798f08286e25704785a244279fc86ecec0b900608be9a508e9fd",
      "impliedFormat": 1
    },
    {
      "version": "672b24b32690e7cf9bcf9c1d6622f1e55b318905ec6091cbdb5ba235047075b9",
      "impliedFormat": 1
    },
    {
      "version": "b61c1ceb88b79b0cfa7e8de1595e236b87ce4c6bb8ab0808d721e8fb70004759",
      "impliedFormat": 1
    },
    {
      "version": "d93370427cc358d66a7e014d9a03d36965c73b30a0c6ad52848adf65178243c3",
      "impliedFormat": 1
    },
    {
      "version": "4132bdfdeffebfcf8e2a41ed0d10150bed6599765e545dae09b2776240d14cf7",
      "impliedFormat": 1
    },
    {
      "version": "fb489f2065438683ba5b42fb5d910b5cb714d87781c618ae7a6bd8eac7cdb9cc",
      "impliedFormat": 1
    },
    {
      "version": "2703b5b6d024695ef877be342c8f28dd09e15881df56cb44daa042b381285e96",
      "impliedFormat": 1
    },
    {
      "version": "75cfa7274d43596af9a3adc2c284a3a7c5459c0d911b65ec6fd8d5a63beaff6b",
      "impliedFormat": 1
    },
    {
      "version": "54d7240da9eda456c661e89ca15703a8471d37c355b6eee2f50dd25f86649d8c",
      "impliedFormat": 1
    },
    {
      "version": "11ca2af592299c6eaa4c22f6b1df9a04b200aaffb9ea54b7eefc120fd677c8bb",
      "impliedFormat": 1
    },
    {
      "version": "4c827b71b26b6167b7f002be5367c59234b92e61e195c72389d3f20ef1e681f7",
      "impliedFormat": 1
    },
    {
      "version": "359d1d4984ff40b89626799c824a8e61d473551b910286ed07a60d2f13b66c18",
      "impliedFormat": 1
    },
    {
      "version": "23908bd6e9ea709ab7f44bd7ad40907d819d0ee04c09a94019231156e96d9a67",
      "impliedFormat": 1
    },
    {
      "version": "ef406784c5c335c46179b1917718ce278a1172f8e1e80276be8147136079d988",
      "impliedFormat": 1
    },
    {
      "version": "16db34e3e82865e6b4bef71bbfe7e671cc8345ba5ae67c8ca20e50bcb18d0a6c",
      "impliedFormat": 1
    },
    {
      "version": "80b230becfd8a35955f13f6022e8fd59af9612a3ef83e14159cc918b3be0faea",
      "impliedFormat": 1
    },
    {
      "version": "32eb807d06018bfb2b05fe61eb6a90fe47c97c4ae23ba5af029921963a354d9e",
      "impliedFormat": 1
    },
    {
      "version": "3dcab336869307408255710db852dd809b99bdce8bd95856e5f97ebd8d7bfee2",
      "impliedFormat": 1
    },
    {
      "version": "437cb230543cdc5e9df94a25ca6b863c7f5549a10d017f4bf9691e9577a184db",
      "impliedFormat": 1
    },
    {
      "version": "68c13f0ab6f831d13681c3d483b43cfa4437ed5302e296205117d30a06f3598c",
      "impliedFormat": 1
    },
    {
      "version": "85d5fdfaaa0bf8825bdd6c77814b4f2d8b388e6c9b2ad385f609d3fa5e0c134c",
      "impliedFormat": 1
    },
    {
      "version": "3843e45df93d241bd5741524a814d16912fe47732401002904e6306d7c8f5683",
      "impliedFormat": 1
    },
    {
      "version": "a8ae4998e65a0daecbd75f03940ddb601168e4e7f0b4c6aaaca39c9230bdb21f",
      "impliedFormat": 1
    },
    {
      "version": "fb0af5e73c6abdb54d9429ba72380bd69de0c9cf71f3380500ddca02229a7447",
      "impliedFormat": 1
    },
    {
      "version": "a40b3b560a57ff2597377c8bd977fe34e7e825994962367127e685f2f4911cd8",
      "impliedFormat": 1
    },
    {
      "version": "46cdcbef9616adf45cf9303b6ee16297a7ee0437d39fa6821f33a70cd500c5c9",
      "impliedFormat": 1
    },
    {
      "version": "60434c3d79638cea7bbb79e0edd4baca1e18d2cd828c7d4af7711e4dedee9cb8",
      "impliedFormat": 1
    },
    {
      "version": "24ecf0e691a8cb8b2f352d85fa9e42a067408ecc35d7fa1dc6dec3424870c64c",
      "impliedFormat": 1
    },
    {
      "version": "c5053ebc1c7a583a088706d64d5ba31bad79af910d9850585213a55926362d30",
      "impliedFormat": 1
    },
    {
      "version": "2e2655be5c5db990f66408139609199d1ffdea1434b8296276c3dfee6bfbebcc",
      "impliedFormat": 1
    },
    {
      "version": "32fc14ee35ddb9184f1ef4456ba697e872d757b67dd77841f7b6d8e72652f7ec",
      "impliedFormat": 1
    },
    {
      "version": "539a5fc1215546c5053c0908ec7df1a7d472a2d25a41bf79e82923ff2217b40d",
      "impliedFormat": 1
    },
    {
      "version": "d62dd90cb65049f765bc40783a32eb84b1ffb45348a7dcc8c15fbda3a1dc0ffb",
      "impliedFormat": 1
    },
    {
      "version": "8cf63a573c0a87084f6eff0cd8d7710b7805aba361f0c79c0278bb8624287482",
      "impliedFormat": 1
    },
    {
      "version": "b383818f7fcacf139ae443ce7642226f70a0b709b9c0b504f206b11588bffeed",
      "impliedFormat": 1
    },
    {
      "version": "8bb7d512629dbe653737c3ac8a337e7f609cc0adc9a4a88c45af29073b1cbeb0",
      "impliedFormat": 1
    },
    {
      "version": "fdfb3e6b20cced0d9a760f7014e0057e9904fabd0dc3bbab7782c5d50d6cac39",
      "impliedFormat": 1
    },
    {
      "version": "35ae7e125a111d694986fe5839a3fae42e4db22375ec4021bc03ae4d46e91bd9",
      "impliedFormat": 1
    },
    {
      "version": "b24c8ae923fad445fd6e5f51c91c43d398911c9f31d8c90aeb9df70acad0ae16",
      "impliedFormat": 1
    },
    {
      "version": "0b48d588944455e9a19261cac43b574fd3c6dcd322afa63f636a5a513ca76721",
      "impliedFormat": 1
    },
    {
      "version": "56bee1fe33c0082e81e0f113a423d9a9309410af210f0af103436caa98bb6143",
      "impliedFormat": 1
    },
    {
      "version": "15cb87058e468d58b29b5734fe1e08d025fefbe91f55e90d673e3937eb167a25",
      "impliedFormat": 1
    },
    {
      "version": "d969a9a6a26f54389dad355f4a352850ef8bbe5d4a2fa112a24db5036c1309e9",
      "impliedFormat": 1
    },
    {
      "version": "1605b9b88099e0f3f4a823406753e8560f21e87801f5405514c0eee550621376",
      "impliedFormat": 1
    },
    {
      "version": "54210083643e803ace014ed3a90e954366330d7a616b890307781e0c67f47ff7",
      "impliedFormat": 1
    },
    {
      "version": "5d41ebf1f7941e35fc43fbf125872c898660bdab951b191429c47753c8efbeed",
      "impliedFormat": 1
    },
    {
      "version": "e366cd6f9acfa0c6da2e2034184b4479af3db190aab37ec18c0db6ecd2237f56",
      "impliedFormat": 1
    },
    {
      "version": "7c2342b0b4c053b2d8bc7496d2f9e5f95c1b87331208d48123763fc167bef797",
      "impliedFormat": 1
    },
    {
      "version": "38da2d1117c1c165bbf4557a0a3865022fb7289fe02cf05972e48b5011822346",
      "impliedFormat": 1
    },
    {
      "version": "b3ca3895fe249990537d47f501b596b853aea53b6bd55327aaa07ea056a0eaaf",
      "impliedFormat": 1
    },
    {
      "version": "cc73c691dd51a49ef04f26df601784517a27072738a967a9ab4539f29bf41f5f",
      "impliedFormat": 1
    },
    {
      "version": "06d3411fd086a7728ecca93ecd576d98b2bc6cb5201bb7e696d78c393efa6f24",
      "impliedFormat": 1
    },
    {
      "version": "a2d74bc6ef511a469d21aa5c8244dff63fb048d9cd8f4fea8661e1294db3fddc",
      "impliedFormat": 1
    },
    {
      "version": "01b0a0ca88ac71ee4f00915929f7ff1313edc0f10f4ac73c7717d0eef0aca2e0",
      "impliedFormat": 1
    },
    {
      "version": "42f22bb3d66d119f3c640f102d56f6ee6ea934e2a957d9d3fa9947358d544d3b",
      "impliedFormat": 1
    },
    {
      "version": "5cac27c7645b28561466eedb6e5b4c104e528c5fc4ae98d1f10ccbd9f33a81e4",
      "impliedFormat": 1
    },
    {
      "version": "3f814edf8366775fdb84158146316cd673ecfdc9a59856a125266177192f31c8",
      "impliedFormat": 1
    },
    {
      "version": "99115d05f0b4bff983067f39e78b4fe8fa60b6326d72ad582b339367fa59f583",
      "impliedFormat": 1
    },
    {
      "version": "fbdca9b41a452b8969a698ba0d21991d7e4b127a6a70058f256ff8f718348747",
      "impliedFormat": 1
    },
    {
      "version": "b625fbbf0d991a7b41c078f984899dcddf842cfb663c4e404448c8541b241d0b",
      "impliedFormat": 1
    },
    {
      "version": "7854a975d47bf9025f945a6ea685761dedf9e9cd1dad8c40176b74583c5e3d71",
      "impliedFormat": 1
    },
    {
      "version": "28bbf6b287a5d264377fdf8692e1650039ae8085cb360908ae5351809a8c0f6e",
      "impliedFormat": 1
    },
    {
      "version": "cf5fa2998a0a76182729e806e8205d8f68e90808cdd809c620975d00272a060c",
      "impliedFormat": 1
    },
    {
      "version": "b5b974abc5792976f3528459793a6d11103483e98dbc66e833334591776804d7",
      "impliedFormat": 1
    },
    {
      "version": "a471d6a0eafcdff19e50b0d4597b5cef87a542a6213194ae929cdeffbc0e02c0",
      "impliedFormat": 1
    },
    {
      "version": "5abf64e067319de07b5e25ffcc75fba5d00bcb579cdc69325a1ad3f3b3664284",
      "impliedFormat": 1
    },
    {
      "version": "56536d7f1073fa03399662e97d012bc70d62c31b763d0bea0e0040e6f1609ad6",
      "impliedFormat": 1
    },
    {
      "version": "7b9e8561139aa30959113ef793e059e0933b50335aecaef8cdcf81e03a9984ae",
      "impliedFormat": 1
    },
    {
      "version": "5b1e11bcea7e4e25725574b10a00ad65222d5db7ae354012b3f2df0291e482ca",
      "impliedFormat": 1
    },
    {
      "version": "a25b03586d0bd11b61a88a2705de22dea1c92c65da3d96ab9a1eb5af44e2b678",
      "impliedFormat": 1
    },
    {
      "version": "884f646d3dd1551e36427c1fcfb9205225de21c4eb5a65d6b2c4d372ec36bd63",
      "impliedFormat": 1
    },
    {
      "version": "955819a952aed955630ac562fca9c65f651c4ba7adab784a3b52e111c2888cf4",
      "impliedFormat": 1
    },
    {
      "version": "a7b85d40ed2c654e6fa84f49ff2bc06e0f3d98910039394cd7799dc32db00146",
      "impliedFormat": 1
    },
    {
      "version": "26a810c5da97af4bcd593900738d422de02949dd230e5f255bc3f7ef82950c57",
      "impliedFormat": 1
    },
    {
      "version": "94d33075935c462c52917b3075d604f970c27c799c5092194a664ede114ffb8f",
      "impliedFormat": 1
    },
    {
      "version": "d2ef66c3f5d3401bd95d48492fb7861f3f8e8992a17543c75f5bfb904e07d932",
      "impliedFormat": 1
    },
    {
      "version": "af4ad02f3a1457af2e2331399229a7d70e1cb1198b1aecc0bc18aa3b3b695bbc",
      "impliedFormat": 1
    },
    {
      "version": "52b6c07b8f8b1b46bf85c2129e0c4cf233203c199837d4a17e914459d09e986a",
      "impliedFormat": 1
    },
    {
      "version": "b06c9df7ff5e6f0af9b8efa9c235cfb5d53fd241c3993442fe9b5fed02f6f362",
      "impliedFormat": 1
    },
    {
      "version": "ced3c7f1dad5edeaa027ffb20b1b12bb816b6dc6b36eddf5f6fe681a90205882",
      "impliedFormat": 1
    },
    {
      "version": "0fd8933626dab246a420f9d533161c0ce81618e94c1f262e80dd6564dc3b2531",
      "impliedFormat": 1
    },
    {
      "version": "615ad07ab7542be91ec72aa0656fd8daed4feac15a2459aaa7c36dfc32f4e37d",
      "impliedFormat": 1
    },
    {
      "version": "df12cb709574b860f8e33c022e9561f339ba71794cd5d4b0d22b8be3ea509f52",
      "impliedFormat": 1
    },
    {
      "version": "31ff5aebab2436465c61de78fcf94b7d6d03915951310e0cfb6dc61b1e3ed751",
      "impliedFormat": 1
    },
    {
      "version": "d2745be767c32464627abc322a88f5076df5802a16a260d7ccf13600ad0a615e",
      "impliedFormat": 1
    },
    {
      "version": "aa73259de07ff85e39d2b49fbd233847690ff8ad4875d0023805d2a015f4ea43",
      "impliedFormat": 1
    },
    {
      "version": "74a907fa14655328575b29e4dbdf58440dd07c081d9d245f785c4143d10510c8",
      "impliedFormat": 1
    },
    {
      "version": "fbcdb2ccec93060304b878e7f65246b6b2c992e896774e9eaf7744f58a9cd8a6",
      "impliedFormat": 1
    },
    {
      "version": "935094dc19b20214f20677d5b871aa34e0e3280e6c852dd57b6a118134a15764",
      "impliedFormat": 1
    },
    {
      "version": "ea99aa2e537966df22f8192e99929ee81719c1cf0b9d9d83d0c6fed53325ccc6",
      "impliedFormat": 1
    },
    {
      "version": "c624b65789f71d3fe13d03b599adbaaf8b17644382f519510097537736df461b",
      "impliedFormat": 1
    },
    {
      "version": "3fbeaff576ce5b8035224fbcb98ec13b7cdd16cdbbf8ee7b4052d3d6330683fb",
      "impliedFormat": 1
    },
    {
      "version": "cc8eac1829ee2ec61323b3af1967790ceb9d0815ef8c40c340bc8090c17a9064",
      "impliedFormat": 1
    },
    {
      "version": "5947f213795a08df7324841661f27341937a5603edcd63fa2d2d66fb11864ec9",
      "impliedFormat": 1
    },
    {
      "version": "2d9f4d58554a246616eeaa090a2fb0dddccf412e88617975138389fb15770ca9",
      "impliedFormat": 1
    },
    {
      "version": "9d5e2347ea0d666f938644fdd4ea2bd48abd70b69e68db435b0e9d82c21debe3",
      "impliedFormat": 1
    },
    {
      "version": "74eeab10497f9b660c5faa35a4c798985d501f4c6ac59ec0a4f5bf1e9e22f8d5",
      "impliedFormat": 1
    },
    {
      "version": "3425be72406c5edffa34483e23bd62b506ab5ecb2bac8566cfe2eae857db7f1e",
      "impliedFormat": 1
    },
    {
      "version": "f37d9aa133b603bd21756b7cbe83dba91f8f27a2ca82ca1ca552fcbc3c4d6205",
      "impliedFormat": 1
    },
    {
      "version": "87b266d84f88f6e75394ff6cf0998bd25ad6349fb8816f64c42d33a5c19789c4",
      "impliedFormat": 1
    },
    {
      "version": "3274e8af4780f7e39a70aca92a6788fec71e9e094d0321d127d44bbd27b27865",
      "impliedFormat": 1
    },
    {
      "version": "396dc8899588d40c46e8caeb0cc306e92bc6c2187b44b26cf47e6e72544ef889",
      "impliedFormat": 1
    },
    {
      "version": "8ed8df53be6f8aa62ff077fb2caf0695d29c3e4f1c26c9b12e8eafdf61f49dc9",
      "impliedFormat": 1
    },
    {
      "version": "d446fdfec829e31d378519e8f620c420c4e840e2a7d19a656f5a6344c11407a4",
      "impliedFormat": 1
    },
    {
      "version": "f1ec2d9212dc5cd83f1038f3a741f97067076d025200e09e79408f580aa2f136",
      "impliedFormat": 1
    },
    {
      "version": "f490808f95d865d54db083d788e506f84c9d02f0ecba87997fd7cef70ee08784",
      "impliedFormat": 1
    },
    "1bf3c1ae9699affe24a74cc62d806db00ef41a180f04f5d9d69c47faea7e021e",
    "75f6701366ef1655e6ad219830d7b0a5805af75feeeaa2948e78c4428096c5f0",
    "86598b1724bb06c08106841d71f94896e1d2e91ea9a294c95a93f71135338713",
    "9283d9722431a2cc82eb22861169530459399eeebdb8697a200477afa3c644e1",
    {
      "version": "8e9c23ba78aabc2e0a27033f18737a6df754067731e69dc5f52823957d60a4b6",
      "impliedFormat": 1
    },
    {
      "version": "5929864ce17fba74232584d90cb721a89b7ad277220627cc97054ba15a98ea8f",
      "impliedFormat": 1
    },
    {
      "version": "7180c03fd3cb6e22f911ce9ba0f8a7008b1a6ddbe88ccf16a9c8140ef9ac1686",
      "impliedFormat": 1
    },
    {
      "version": "70521b6ab0dcba37539e5303104f29b721bfb2940b2776da4cc818c07e1fefc1",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "030e350db2525514580ed054f712ffb22d273e6bc7eddc1bb7eda1e0ba5d395e",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "d153a11543fd884b596587ccd97aebbeed950b26933ee000f94009f1ab142848",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "21d819c173c0cf7cc3ce57c3276e77fd9a8a01d35a06ad87158781515c9a438a",
      "impliedFormat": 1
    },
    {
      "version": "a79e62f1e20467e11a904399b8b18b18c0c6eea6b50c1168bf215356d5bebfaf",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "8fa51737611c21ba3a5ac02c4e1535741d58bec67c9bdf94b1837a31c97a2263",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "5929864ce17fba74232584d90cb721a89b7ad277220627cc97054ba15a98ea8f",
      "impliedFormat": 1
    },
    {
      "version": "763fe0f42b3d79b440a9b6e51e9ba3f3f91352469c1e4b3b67bfa4ff6352f3f4",
      "impliedFormat": 1
    },
    {
      "version": "25c8056edf4314820382a5fdb4bb7816999acdcb929c8f75e3f39473b87e85bc",
      "impliedFormat": 1
    },
    {
      "version": "c464d66b20788266e5353b48dc4aa6bc0dc4a707276df1e7152ab0c9ae21fad8",
      "impliedFormat": 1
    },
    {
      "version": "78d0d27c130d35c60b5e5566c9f1e5be77caf39804636bc1a40133919a949f21",
      "impliedFormat": 1
    },
    {
      "version": "c6fd2c5a395f2432786c9cb8deb870b9b0e8ff7e22c029954fabdd692bff6195",
      "impliedFormat": 1
    },
    {
      "version": "1d6e127068ea8e104a912e42fc0a110e2aa5a66a356a917a163e8cf9a65e4a75",
      "impliedFormat": 1
    },
    {
      "version": "5ded6427296cdf3b9542de4471d2aa8d3983671d4cac0f4bf9c637208d1ced43",
      "impliedFormat": 1
    },
    {
      "version": "7f182617db458e98fc18dfb272d40aa2fff3a353c44a89b2c0ccb3937709bfb5",
      "impliedFormat": 1
    },
    {
      "version": "cadc8aced301244057c4e7e73fbcae534b0f5b12a37b150d80e5a45aa4bebcbd",
      "impliedFormat": 1
    },
    {
      "version": "385aab901643aa54e1c36f5ef3107913b10d1b5bb8cbcd933d4263b80a0d7f20",
      "impliedFormat": 1
    },
    {
      "version": "9670d44354bab9d9982eca21945686b5c24a3f893db73c0dae0fd74217a4c219",
      "impliedFormat": 1
    },
    {
      "version": "0b8a9268adaf4da35e7fa830c8981cfa22adbbe5b3f6f5ab91f6658899e657a7",
      "impliedFormat": 1
    },
    {
      "version": "11396ed8a44c02ab9798b7dca436009f866e8dae3c9c25e8c1fbc396880bf1bb",
      "impliedFormat": 1
    },
    {
      "version": "ba7bc87d01492633cb5a0e5da8a4a42a1c86270e7b3d2dea5d156828a84e4882",
      "impliedFormat": 1
    },
    {
      "version": "4893a895ea92c85345017a04ed427cbd6a1710453338df26881a6019432febdd",
      "impliedFormat": 1
    },
    {
      "version": "c21dc52e277bcfc75fac0436ccb75c204f9e1b3fa5e12729670910639f27343e",
      "impliedFormat": 1
    },
    {
      "version": "13f6f39e12b1518c6650bbb220c8985999020fe0f21d818e28f512b7771d00f9",
      "impliedFormat": 1
    },
    {
      "version": "9b5369969f6e7175740bf51223112ff209f94ba43ecd3bb09eefff9fd675624a",
      "impliedFormat": 1
    },
    {
      "version": "4fe9e626e7164748e8769bbf74b538e09607f07ed17c2f20af8d680ee49fc1da",
      "impliedFormat": 1
    },
    {
      "version": "24515859bc0b836719105bb6cc3d68255042a9f02a6022b3187948b204946bd2",
      "impliedFormat": 1
    },
    {
      "version": "ea0148f897b45a76544ae179784c95af1bd6721b8610af9ffa467a518a086a43",
      "impliedFormat": 1
    },
    {
      "version": "24c6a117721e606c9984335f71711877293a9651e44f59f3d21c1ea0856f9cc9",
      "impliedFormat": 1
    },
    {
      "version": "dd3273ead9fbde62a72949c97dbec2247ea08e0c6952e701a483d74ef92d6a17",
      "impliedFormat": 1
    },
    {
      "version": "405822be75ad3e4d162e07439bac80c6bcc6dbae1929e179cf467ec0b9ee4e2e",
      "impliedFormat": 1
    },
    {
      "version": "0db18c6e78ea846316c012478888f33c11ffadab9efd1cc8bcc12daded7a60b6",
      "impliedFormat": 1
    },
    {
      "version": "e61be3f894b41b7baa1fbd6a66893f2579bfad01d208b4ff61daef21493ef0a8",
      "impliedFormat": 1
    },
    {
      "version": "bd0532fd6556073727d28da0edfd1736417a3f9f394877b6d5ef6ad88fba1d1a",
      "impliedFormat": 1
    },
    {
      "version": "89167d696a849fce5ca508032aabfe901c0868f833a8625d5a9c6e861ef935d2",
      "impliedFormat": 1
    },
    {
      "version": "615ba88d0128ed16bf83ef8ccbb6aff05c3ee2db1cc0f89ab50a4939bfc1943f",
      "impliedFormat": 1
    },
    {
      "version": "a4d551dbf8746780194d550c88f26cf937caf8d56f102969a110cfaed4b06656",
      "impliedFormat": 1
    },
    {
      "version": "8bd86b8e8f6a6aa6c49b71e14c4ffe1211a0e97c80f08d2c8cc98838006e4b88",
      "impliedFormat": 1
    },
    {
      "version": "317e63deeb21ac07f3992f5b50cdca8338f10acd4fbb7257ebf56735bf52ab00",
      "impliedFormat": 1
    },
    {
      "version": "4732aec92b20fb28c5fe9ad99521fb59974289ed1e45aecb282616202184064f",
      "impliedFormat": 1
    },
    {
      "version": "2e85db9e6fd73cfa3d7f28e0ab6b55417ea18931423bd47b409a96e4a169e8e6",
      "impliedFormat": 1
    },
    {
      "version": "c46e079fe54c76f95c67fb89081b3e399da2c7d109e7dca8e4b58d83e332e605",
      "impliedFormat": 1
    },
    {
      "version": "bf67d53d168abc1298888693338cb82854bdb2e69ef83f8a0092093c2d562107",
      "impliedFormat": 1
    },
    {
      "version": "d2bc987ae352271d0d615a420dcf98cc886aa16b87fb2b569358c1fe0ca0773d",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "4f0539c58717cbc8b73acb29f9e992ab5ff20adba5f9b57130691c7f9b186a4d",
      "impliedFormat": 1
    },
    {
      "version": "7394959e5a741b185456e1ef5d64599c36c60a323207450991e7a42e08911419",
      "impliedFormat": 1
    },
    {
      "version": "76103716ba397bbb61f9fa9c9090dca59f39f9047cb1352b2179c5d8e7f4e8d0",
      "impliedFormat": 1
    },
    {
      "version": "f9677e434b7a3b14f0a9367f9dfa1227dfe3ee661792d0085523c3191ae6a1a4",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "4314c7a11517e221f7296b46547dbc4df047115b182f544d072bdccffa57fc72",
      "impliedFormat": 1
    },
    {
      "version": "115971d64632ea4742b5b115fb64ed04bcaae2c3c342f13d9ba7e3f9ee39c4e7",
      "impliedFormat": 1
    },
    {
      "version": "c2510f124c0293ab80b1777c44d80f812b75612f297b9857406468c0f4dafe29",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "5524481e56c48ff486f42926778c0a3cce1cc85dc46683b92b1271865bcf015a",
      "impliedFormat": 1
    },
    {
      "version": "9057f224b79846e3a95baf6dad2c8103278de2b0c5eebda23fc8188171ad2398",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "19d5f8d3930e9f99aa2c36258bf95abbe5adf7e889e6181872d1cdba7c9a7dd5",
      "impliedFormat": 1
    },
    {
      "version": "e6f5a38687bebe43a4cef426b69d34373ef68be9a6b1538ec0a371e69f309354",
      "impliedFormat": 1
    },
    {
      "version": "a6bf63d17324010ca1fbf0389cab83f93389bb0b9a01dc8a346d092f65b3605f",
      "impliedFormat": 1
    },
    {
      "version": "e009777bef4b023a999b2e5b9a136ff2cde37dc3f77c744a02840f05b18be8ff",
      "impliedFormat": 1
    },
    {
      "version": "1e0d1f8b0adfa0b0330e028c7941b5a98c08b600efe7f14d2d2a00854fb2f393",
      "impliedFormat": 1
    },
    {
      "version": "ee1ee365d88c4c6c0c0a5a5701d66ebc27ccd0bcfcfaa482c6e2e7fe7b98edf7",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "88bc59b32d0d5b4e5d9632ac38edea23454057e643684c3c0b94511296f2998c",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "e0476e6b51a47a8eaf5ee6ecab0d686f066f3081de9a572f1dde3b2a8a7fb055",
      "impliedFormat": 1
    },
    {
      "version": "1e289f30a48126935a5d408a91129a13a59c9b0f8c007a816f9f16ef821e144e",
      "impliedFormat": 1
    },
    {
      "version": "f96a023e442f02cf551b4cfe435805ccb0a7e13c81619d4da61ec835d03fe512",
      "impliedFormat": 1
    },
    {
      "version": "5135bdd72cc05a8192bd2e92f0914d7fc43ee077d1293dc622a049b7035a0afb",
      "impliedFormat": 1
    },
    {
      "version": "528b62e4272e3ddfb50e8eed9e359dedea0a4d171c3eb8f337f4892aac37b24b",
      "impliedFormat": 1
    },
    {
      "version": "6d386bc0d7f3afa1d401afc3e00ed6b09205a354a9795196caed937494a713e6",
      "impliedFormat": 1
    },
    {
      "version": "5b2e73adcb25865d31c21accdc8f82de1eaded23c6f73230e474df156942380e",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "23459c1915878a7c1e86e8bdb9c187cddd3aea105b8b1dfce512f093c969bc7e",
      "impliedFormat": 1
    },
    {
      "version": "b1b6ee0d012aeebe11d776a155d8979730440082797695fc8e2a5c326285678f",
      "impliedFormat": 1
    },
    {
      "version": "45875bcae57270aeb3ebc73a5e3fb4c7b9d91d6b045f107c1d8513c28ece71c0",
      "impliedFormat": 1
    },
    {
      "version": "1dc73f8854e5c4506131c4d95b3a6c24d0c80336d3758e95110f4c7b5cb16397",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "64ede330464b9fd5d35327c32dd2770e7474127ed09769655ebce70992af5f44",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "3f16a7e4deafa527ed9995a772bb380eb7d3c2c0fd4ae178c5263ed18394db2c",
      "impliedFormat": 1
    },
    {
      "version": "c6b4e0a02545304935ecbf7de7a8e056a31bb50939b5b321c9d50a405b5a0bba",
      "impliedFormat": 1
    },
    {
      "version": "fab29e6d649aa074a6b91e3bdf2bff484934a46067f6ee97a30fcd9762ae2213",
      "impliedFormat": 1
    },
    {
      "version": "8145e07aad6da5f23f2fcd8c8e4c5c13fb26ee986a79d03b0829b8fce152d8b2",
      "impliedFormat": 1
    },
    {
      "version": "e1120271ebbc9952fdc7b2dd3e145560e52e06956345e6fdf91d70ca4886464f",
      "impliedFormat": 1
    },
    {
      "version": "814118df420c4e38fe5ae1b9a3bafb6e9c2aa40838e528cde908381867be6466",
      "impliedFormat": 1
    },
    {
      "version": "bcd0418abb8a5c9fe7db36a96ca75fc78455b0efab270ee89b8e49916eac5174",
      "impliedFormat": 1
    },
    {
      "version": "c878f74b6d10b267f6075c51ac1d8becd15b4aa6a58f79c0cfe3b24908357f60",
      "impliedFormat": 1
    },
    {
      "version": "37ba7b45141a45ce6e80e66f2a96c8a5ab1bcef0fc2d0f56bb58df96ec67e972",
      "impliedFormat": 1
    },
    {
      "version": "125d792ec6c0c0f657d758055c494301cc5fdb327d9d9d5960b3f129aff76093",
      "impliedFormat": 1
    },
    {
      "version": "fbf68fc8057932b1c30107ebc37420f8d8dc4bef1253c4c2f9e141886c0df5ab",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "2754d8221d77c7b382096651925eb476f1066b3348da4b73fe71ced7801edada",
      "impliedFormat": 1
    },
    {
      "version": "7d8b16d7f33d5081beac7a657a6d13f11a72cf094cc5e37cda1b9d8c89371951",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "f0be1b8078cd549d91f37c30c222c2a187ac1cf981d994fb476a1adc61387b14",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "0aaed1d72199b01234152f7a60046bc947f1f37d78d182e9ae09c4289e06a592",
      "impliedFormat": 1
    },
    {
      "version": "5360a27d3ebca11b224d7d3e38e3e2c63f8290cb1fcf6c3610401898f8e68bc3",
      "impliedFormat": 1
    },
    {
      "version": "66ba1b2c3e3a3644a1011cd530fb444a96b1b2dfe2f5e837a002d41a1a799e60",
      "impliedFormat": 1
    },
    {
      "version": "7e514f5b852fdbc166b539fdd1f4e9114f29911592a5eb10a94bb3a13ccac3c4",
      "impliedFormat": 1
    },
    {
      "version": "7d6ff413e198d25639f9f01f16673e7df4e4bd2875a42455afd4ecc02ef156da",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "217941ef5c6fd81b77cd0073c94019a98e20777eaac6c4326156bf6b021ed547",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "f689c4237b70ae6be5f0e4180e8833f34ace40529d1acc0676ab8fb8f70457d7",
      "impliedFormat": 1
    },
    {
      "version": "b02784111b3fc9c38590cd4339ff8718f9329a6f4d3fd66e9744a1dcd1d7e191",
      "impliedFormat": 1
    },
    {
      "version": "ac5ed35e649cdd8143131964336ab9076937fa91802ec760b3ea63b59175c10a",
      "impliedFormat": 1
    },
    {
      "version": "63b05afa6121657f25e99e1519596b0826cda026f09372c9100dfe21417f4bd6",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "78dc0513cc4f1642906b74dda42146bcbd9df7401717d6e89ea6d72d12ecb539",
      "impliedFormat": 1
    },
    {
      "version": "ad90122e1cb599b3bc06a11710eb5489101be678f2920f2322b0ac3e195af78d",
      "impliedFormat": 1
    },
    {
      "version": "25c8056edf4314820382a5fdb4bb7816999acdcb929c8f75e3f39473b87e85bc",
      "impliedFormat": 1
    },
    {
      "version": "499a48bb6b59bb20f0c70345f4ccedaa7ae186d0e7e2a7424440be2c6f03a212",
      "impliedFormat": 1
    },
    {
      "version": "3e4825171442666d31c845aeb47fcd34b62e14041bb353ae2b874285d78482aa",
      "impliedFormat": 1
    },
    {
      "version": "c6fd2c5a395f2432786c9cb8deb870b9b0e8ff7e22c029954fabdd692bff6195",
      "impliedFormat": 1
    },
    {
      "version": "8702b271086074c550d51bc0fc0626403e0c27f93a69264532ae3a9d5e65b9ab",
      "impliedFormat": 1
    },
    {
      "version": "e9775e97ac4877aebf963a0289c81abe76d1ec9a2a7778dbe637e5151f25c5f3",
      "impliedFormat": 1
    },
    {
      "version": "c34ee1ea9317f8a782b45c9053a87a637af138a8b49ddba52914d8186ecf36e6",
      "impliedFormat": 1
    },
    {
      "version": "cadc8aced301244057c4e7e73fbcae534b0f5b12a37b150d80e5a45aa4bebcbd",
      "impliedFormat": 1
    },
    {
      "version": "385aab901643aa54e1c36f5ef3107913b10d1b5bb8cbcd933d4263b80a0d7f20",
      "impliedFormat": 1
    },
    {
      "version": "9670d44354bab9d9982eca21945686b5c24a3f893db73c0dae0fd74217a4c219",
      "impliedFormat": 1
    },
    {
      "version": "db3435f3525cd785bf21ec6769bf8da7e8a776be1a99e2e7efb5f244a2ef5fee",
      "impliedFormat": 1
    },
    {
      "version": "c3b170c45fc031db31f782e612adf7314b167e60439d304b49e704010e7bafe5",
      "impliedFormat": 1
    },
    {
      "version": "40383ebef22b943d503c6ce2cb2e060282936b952a01bea5f9f493d5fb487cc7",
      "impliedFormat": 1
    },
    {
      "version": "4893a895ea92c85345017a04ed427cbd6a1710453338df26881a6019432febdd",
      "impliedFormat": 1
    },
    {
      "version": "3a84b7cb891141824bd00ef8a50b6a44596aded4075da937f180c90e362fe5f6",
      "impliedFormat": 1
    },
    {
      "version": "13f6f39e12b1518c6650bbb220c8985999020fe0f21d818e28f512b7771d00f9",
      "impliedFormat": 1
    },
    {
      "version": "9b5369969f6e7175740bf51223112ff209f94ba43ecd3bb09eefff9fd675624a",
      "impliedFormat": 1
    },
    {
      "version": "4fe9e626e7164748e8769bbf74b538e09607f07ed17c2f20af8d680ee49fc1da",
      "impliedFormat": 1
    },
    {
      "version": "24515859bc0b836719105bb6cc3d68255042a9f02a6022b3187948b204946bd2",
      "impliedFormat": 1
    },
    {
      "version": "33203609eba548914dc83ddf6cadbc0bcb6e8ef89f6d648ca0908ae887f9fcc5",
      "impliedFormat": 1
    },
    {
      "version": "1d150b70510edc11a33ecee95fdbc7609c5af88a40d29c3d0265f704d3cdb2e6",
      "impliedFormat": 1
    },
    {
      "version": "0db18c6e78ea846316c012478888f33c11ffadab9efd1cc8bcc12daded7a60b6",
      "impliedFormat": 1
    },
    {
      "version": "89167d696a849fce5ca508032aabfe901c0868f833a8625d5a9c6e861ef935d2",
      "impliedFormat": 1
    },
    {
      "version": "e53a3c2a9f624d90f24bf4588aacd223e7bec1b9d0d479b68d2f4a9e6011147f",
      "impliedFormat": 1
    },
    {
      "version": "339dc5265ee5ed92e536a93a04c4ebbc2128f45eeec6ed29f379e0085283542c",
      "impliedFormat": 1
    },
    {
      "version": "9f0a92164925aa37d4a5d9dd3e0134cff8177208dba55fd2310cd74beea40ee2",
      "impliedFormat": 1
    },
    {
      "version": "8bfdb79bf1a9d435ec48d9372dc93291161f152c0865b81fc0b2694aedb4578d",
      "impliedFormat": 1
    },
    {
      "version": "2e85db9e6fd73cfa3d7f28e0ab6b55417ea18931423bd47b409a96e4a169e8e6",
      "impliedFormat": 1
    },
    {
      "version": "c46e079fe54c76f95c67fb89081b3e399da2c7d109e7dca8e4b58d83e332e605",
      "impliedFormat": 1
    },
    {
      "version": "d32275be3546f252e3ad33976caf8c5e842c09cb87d468cb40d5f4cf092d1acc",
      "impliedFormat": 1
    },
    {
      "version": "5f69925a3ca4f275d26da3398a7c24ac669f099f840f89ccc64e5dc8026993dd",
      "impliedFormat": 1
    },
    {
      "version": "299fd0c281633d8dbfbe5f44c5f2850fe37392da6fd3b9cca3cb4e10cda16432",
      "impliedFormat": 1
    },
    {
      "version": "2557768a8f555c42b1a5fd5f3c60d8e87ca24baa9205642b5c6cff61c6effeac",
      "impliedFormat": 99
    },
    {
      "version": "265c7b89180c83cee0d4b26725479781eaa8ece4709dc60359666c25da86953d",
      "impliedFormat": 99
    },
    "3e83036f3a859435afa1c5c8075b0b116e4d94d205574d6528a856f187e7291a",
    {
      "version": "005f10cafe0939ae8d6a98e19c4ddf8b59faf3f9ae38dfa5907b82b9a6cb4de9",
      "impliedFormat": 1
    },
    {
      "version": "089c056ad8ecb34ee72cb831491ab72c214d8fb7ecf94b96a1b4736ab54397a1",
      "impliedFormat": 1
    },
    {
      "version": "e643ef3093cba63af26396ae8dc58dc542c241027749dcdf715f3d3209f79a03",
      "impliedFormat": 1
    },
    {
      "version": "f40e6338b8137033a5b4efbe01de45a4399f2c304648eace01d852cd05eb861e",
      "impliedFormat": 1
    },
    {
      "version": "89d879fae02696e226dbcb7444d6153158fa264bb646071988f19a2e422b314f",
      "impliedFormat": 1
    },
    {
      "version": "57de3f0b1730cf8439c8aa4686f78f38b170a9b55e7a8393ae6f8a524bb3ba5a",
      "impliedFormat": 1
    },
    {
      "version": "e933bd300ea4f6c724d222bf2d93a0ae2b1e748baa1db09cb71d67d563794b2d",
      "impliedFormat": 1
    },
    {
      "version": "c43d0df83d8bb68ab9e2795cf1ec896ff1b5fab2023c977f3777819bc6b5c880",
      "impliedFormat": 1
    },
    {
      "version": "bf810d50332562d1b223a7ce607e5f8dc42714d8a3fa7bf39afe33830e107bf7",
      "impliedFormat": 1
    },
    {
      "version": "f025aff69699033567ebb4925578dedb18f63b4aa185f85005451cfd5fc53343",
      "impliedFormat": 1
    },
    {
      "version": "3d36c36df6ce6c4c3651a5f804ab07fe1c9bb8ce7d40ef4134038c364b429cb3",
      "impliedFormat": 1
    },
    {
      "version": "e9243dd3c92d2c56a2edf96cbce8faf357caf9397b95acaa65e960ad36cb7235",
      "impliedFormat": 1
    },
    {
      "version": "a24a9c59b7baecbb85c0ace2c07c9c5b7c2330bb5a2ae5d766f6bbf68f75e727",
      "impliedFormat": 1
    },
    {
      "version": "3c264d6a0f6be4f8684cb9e025f32c9b131cca7199c658eea28f0dae1f439124",
      "impliedFormat": 1
    },
    {
      "version": "d3cd789b0eebd5cebde1404383fd32c610bec782c74a415aa05ab3593abc35c8",
      "impliedFormat": 1
    },
    {
      "version": "8c1babb42f52952a6593b678f4cfb4afea5dc91e5cfaf3ca922cdd2d23b1277a",
      "impliedFormat": 1
    },
    {
      "version": "04ebb965333800caba800cabd1e18b02e0e69ab6a6f8948f2d53211df00a193c",
      "impliedFormat": 1
    },
    {
      "version": "f8e2be107b3e756e0a1c4f5e195e69dce69d38d0ff5c0b0509933e970c6d915b",
      "impliedFormat": 1
    },
    {
      "version": "309e580094520f9675a85c406ab5d1de4735f74a38f36690d569dbc5341f36a8",
      "impliedFormat": 1
    },
    {
      "version": "c2fa79fd37e4b0e4040de9d8db1b79accb1f8f63b3458cd0e5dac9d4f9e6f3f1",
      "impliedFormat": 1
    },
    {
      "version": "4f0d1a7e2a5a8b85d69f60a7be2a6223827f5fec473ba2142279841a54e8a845",
      "impliedFormat": 1
    },
    {
      "version": "ae2fb62b3647083fe8299e95dbfab2063c8301e9a626f42be0f360a57e434797",
      "impliedFormat": 1
    },
    {
      "version": "f53d803d9c9c8acdbb82ef5c6b8f224d42be50e9ab8bc09c8a9a942717214f9a",
      "impliedFormat": 1
    },
    {
      "version": "d2d70166533a2233aa35977eecea4b08c2f0f2e6e7b56c12a1c613c5ebf2c384",
      "impliedFormat": 1
    },
    {
      "version": "1097820fae2d12eb60006de0b5d057105e60d165cf8a6e6125f9876e6335cde7",
      "impliedFormat": 1
    },
    {
      "version": "8f62905f50830a638fd1a5ff68d9c8f2c1347ff046908eeb9119d257e8e8ae4a",
      "impliedFormat": 1
    },
    {
      "version": "8b4d34279952175f972f1aa62e136248311889148eb40a3e4782b244cece09f3",
      "impliedFormat": 1
    },
    {
      "version": "d3c3cc0840704fe524dbe8a812290bfd303e43d3bd43dcaac83ee682d2e15be0",
      "impliedFormat": 1
    },
    {
      "version": "71725ba9235f9d2aa02839162b1df2df59fd9dd91c110a54ea02112243d7a4d9",
      "impliedFormat": 1
    },
    {
      "version": "80af0c272dcb64518f7768428cdf91d21966a7f24ed0dfc69fad964d4c2ed8c1",
      "impliedFormat": 1
    },
    {
      "version": "1dc9702aa16e3ada78c84aa96868a7e5502001c402918b6d85ed25acbe80fd51",
      "impliedFormat": 1
    },
    {
      "version": "35f891c1bc36c97469df06316c65a718956515c8b3bdbeb146b468c02493ef13",
      "impliedFormat": 1
    },
    {
      "version": "2e9b05d7db853315f44d824e13840e6fdf17d615d13170b5f5cf830442018dcd",
      "impliedFormat": 1
    },
    {
      "version": "16b8baf3f4a4e914100aed5bfbf225ab02e45c6d77ff9da60ea815a728936804",
      "impliedFormat": 1
    },
    {
      "version": "f2a028f5cdb362438568881270e83cd287a027e7a4ff7a6567aa30d229f37598",
      "impliedFormat": 1
    },
    {
      "version": "e2ea93f536cebb5fc7e1e68642815bdf57b53723f1a9c04d357cc8963359f825",
      "impliedFormat": 99
    },
    {
      "version": "00aa770e9320faf1629c2df8313d4b5745e43932c4c742aa763c204a0e54795d",
      "impliedFormat": 99
    },
    {
      "version": "5636b8f27a51da12c325dadd3cc80dd9f2f9c011981e792337f285a90a5a37f4",
      "impliedFormat": 99
    },
    {
      "version": "9ead7b1e87b28934d0d668c8a9c51f4fddb8f448e7dc342bbf7ba851ded87f9b",
      "impliedFormat": 99
    },
    {
      "version": "c32606942e56e11f60ec66cc945f356a71bf4f9c01d73b31e398737aaf0381fb",
      "impliedFormat": 99
    },
    {
      "version": "abde97a37b6c54e1216cd69f55f1e6f9ebcb95ade99c7ecfdf2ac834d560cfcc",
      "impliedFormat": 99
    },
    {
      "version": "697ee46ab45f89b2b1eae5b07fec63bdf7d2d3fa42c02b097545b63c45405b5a",
      "impliedFormat": 99
    },
    {
      "version": "d663bfa2fb594871918ea134c8262e5dc6280e955dd79c63ab334fcff230faf0",
      "impliedFormat": 99
    },
    {
      "version": "d408695255bc7a6163fcc55aaf879db33e4a58970dc02e787b8f05daad0a7df9",
      "impliedFormat": 99
    },
    {
      "version": "a24f74bf188ed8e155dfe8798605912ce4a281076a0f9d8e2e6278dcb4dd3d7e",
      "impliedFormat": 99
    },
    {
      "version": "bacca0509509262f2f7bbc8a6b71ded21c14c7357f03e66bae5013e9246fb19b",
      "impliedFormat": 99
    },
    {
      "version": "2e39ab84c8ee1a18482953de55f8733e69cb7147c2485de702753b7130d678e7",
      "impliedFormat": 99
    },
    {
      "version": "ec71c2265d5b470c26510ffc7d5df10e1c8a510ff7e986a7899f53d11e987228",
      "impliedFormat": 99
    },
    {
      "version": "6db07bf0d35841647c95253646ffad5c6b091f1e32455767a5bf38f6d14cf01b",
      "impliedFormat": 99
    },
    {
      "version": "3800d2f44700b48b0457640e9edca0c78618bad162d60b2b12f13b790da45419",
      "impliedFormat": 99
    },
    {
      "version": "ae2637856a94d83677eac7a04cef9c2f503ea352a22cc91934eced9920ce24d2",
      "impliedFormat": 99
    },
    {
      "version": "47a15fcb728e81cd80dcdc2983d1a7a1d89e1bb89f772b477616d09fb80efb74",
      "impliedFormat": 99
    },
    {
      "version": "3e9eecbda7b09cc343db409923d0c8764718507ef5c9aedc93d41493e3ca4443",
      "impliedFormat": 99
    },
    {
      "version": "e77d6ac8995adb49be4b8e43b97438ad442352469fa2ba1d8c35fe54256dbe7e",
      "signature": "97992409349ffe049ae2744c2a6f4bdd3065427584abec67a371f04e1603c9d3"
    },
    "f580fc3547b5b724c40dcc046a7687218468f6536a16a216fe41dae399711396",
    {
      "version": "e749bbd37dadf82c9833278780527c717226e1e2c9bc7b2576c8ec1c40ec5647",
      "impliedFormat": 1
    },
    "027c780afec98e5c029e5b3e3a8780d7360aa34b2529d8d1a76da71557d320fc",
    {
      "version": "5bb553db47a18c3a469014cd84156dff3110efa4ab553e0bc3e276e721015fb6",
      "signature": "4f3ac35634780c00fc3e6437ebc27e9293da16d4442a041e6399ac1fe77a3d59"
    },
    {
      "version": "3d9ffe5532661757c488c902d069c0ad44fa08e95e5ee350e725247052163088",
      "impliedFormat": 99
    },
    {
      "version": "d3cfde44f8089768ebb08098c96d01ca260b88bccf238d55eee93f1c620ff5a5",
      "impliedFormat": 99
    },
    {
      "version": "293eadad9dead44c6fd1db6de552663c33f215c55a1bfa2802a1bceed88ff0ec",
      "impliedFormat": 99
    },
    {
      "version": "54f6ec6ea75acea6eb23635617252d249145edbc7bcd9d53f2d70280d2aef953",
      "impliedFormat": 99
    },
    {
      "version": "c25ce98cca43a3bfa885862044be0d59557be4ecd06989b2001a83dcf69620fd",
      "impliedFormat": 99
    },
    {
      "version": "8e71e53b02c152a38af6aec45e288cc65bede077b92b9b43b3cb54a37978bb33",
      "impliedFormat": 99
    },
    {
      "version": "754a9396b14ca3a4241591afb4edc644b293ccc8a3397f49be4dfd520c08acb3",
      "impliedFormat": 99
    },
    {
      "version": "f672c876c1a04a223cf2023b3d91e8a52bb1544c576b81bf64a8fec82be9969c",
      "impliedFormat": 99
    },
    {
      "version": "e4b03ddcf8563b1c0aee782a185286ed85a255ce8a30df8453aade2188bbc904",
      "impliedFormat": 99
    },
    {
      "version": "de2316e90fc6d379d83002f04ad9698bc1e5285b4d52779778f454dd12ce9f44",
      "impliedFormat": 99
    },
    {
      "version": "25b3f581e12ede11e5739f57a86e8668fbc0124f6649506def306cad2c59d262",
      "impliedFormat": 99
    },
    {
      "version": "6be35ec0126bed0ddb8b7ca4faae4488f78173516c0739809b1ed345ac02b75a",
      "impliedFormat": 99
    },
    {
      "version": "5d26d2e47e2352def36f89a3e8bf8581da22b7f857e07ef3114cd52cf4813445",
      "impliedFormat": 99
    },
    {
      "version": "3db2efd285e7328d8014b54a7fce3f4861ebcdc655df40517092ed0050983617",
      "impliedFormat": 99
    },
    {
      "version": "d5d39a24c759df40480a4bfc0daffd364489702fdbcbdfc1711cde34f8739995",
      "impliedFormat": 99
    },
    "f6d2e59756dc75ae605e2aa23ec5422231ecfa23dde6dfaf4493630d48629453",
    {
      "version": "5c54a34e3d91727f7ae840bfe4d5d1c9a2f93c54cb7b6063d06ee4a6c3322656",
      "impliedFormat": 99
    },
    {
      "version": "07c0547e91d0c35c3d1bff1d2b7ffac3334b315e9eb5744a8440940e819ab13a",
      "impliedFormat": 99
    },
    {
      "version": "a6f223e9ef29edb1dc1ffa1a8507b9247589077081be99883ec5ac84d74e61d6",
      "impliedFormat": 99
    },
    {
      "version": "f9b028d3c3891dd817e24d53102132b8f696269309605e6ed4f0db2c113bbd82",
      "impliedFormat": 99
    },
    {
      "version": "fb7c8d90e52e2884509166f96f3d591020c7b7977ab473b746954b0c8d100960",
      "impliedFormat": 99
    },
    {
      "version": "373e16d44e57937558478c586396210e4eeac6c895787863381a6588185528e4",
      "impliedFormat": 99
    },
    {
      "version": "7c45fbd736e81fd9899cf4d75b242326ccda37eafdd9555e5b64a0ed59e8f6e9",
      "impliedFormat": 99
    },
    {
      "version": "ef13c73d6157a32933c612d476c1524dd674cf5b9a88571d7d6a0d147544d529",
      "impliedFormat": 99
    },
    {
      "version": "daf54402364627db51d8ccdcf98620ca7bd88dbd0036053bff51b87714a299b4",
      "impliedFormat": 99
    },
    {
      "version": "9c2fe4e4ddf257e9b40d4d9fca28f86a8653a98492239a5ba27790019570cb71",
      "impliedFormat": 99
    },
    {
      "version": "f8433f2a07ccab79429b2fd66d12731a13f18061d4e7f8dc8559796086b22bc4",
      "impliedFormat": 99
    },
    {
      "version": "e64b03ee2d4d53929ea13a1e2b52aaba0685c86185b0f6f3346fc548b75a2245",
      "impliedFormat": 99
    },
    {
      "version": "8124828a11be7db984fcdab052fd4ff756b18edcfa8d71118b55388176210923",
      "impliedFormat": 99
    },
    {
      "version": "d06f9f2ba52c62a1d6cc63f4a015bc7ccd155f3bac2c07fbb979aec6013d966f",
      "impliedFormat": 99
    },
    {
      "version": "e2b48abff5a8adc6bb1cd13a702b9ef05e6045a98e7cfa95a8779b53b6d0e69d",
      "impliedFormat": 1
    },
    {
      "version": "a02d26c056491b1ddfa53a671ad60ce852969b369f0e71993dbac8ddcf0d038b",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "a660aa95476042d3fdcc1343cf6bb8fdf24772d31712b1db321c5a4dcc325434",
      "impliedFormat": 1
    },
    {
      "version": "a7ca8df4f2931bef2aa4118078584d84a0b16539598eaadf7dce9104dfaa381c",
      "impliedFormat": 1
    },
    {
      "version": "11443a1dcfaaa404c68d53368b5b818712b95dd19f188cab1669c39bee8b84b3",
      "impliedFormat": 1
    },
    {
      "version": "36977c14a7f7bfc8c0426ae4343875689949fb699f3f84ecbe5b300ebf9a2c55",
      "impliedFormat": 1
    },
    {
      "version": "035d0934d304483f07148427a5bd5b98ac265dae914a6b49749fe23fbd893ec7",
      "impliedFormat": 99
    },
    {
      "version": "e2ed5b81cbed3a511b21a18ab2539e79ac1f4bc1d1d28f8d35d8104caa3b429f",
      "impliedFormat": 99
    },
    {
      "version": "dd7ca4f0ef3661dac7043fb2cdf1b99e008d2b6bc5cd998dd1fa5a2968034984",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "402e5c534fb2b85fa771170595db3ac0dd532112c8fa44fc23f233bc6967488b",
      "impliedFormat": 1
    },
    {
      "version": "8885cf05f3e2abf117590bbb951dcf6359e3e5ac462af1c901cfd24c6a6472e2",
      "impliedFormat": 1
    },
    {
      "version": "33f3718dababfc26dfd9832c150149ea4e934f255130f8c118a59ae69e5ed441",
      "impliedFormat": 1
    },
    {
      "version": "e61df3640a38d535fd4bc9f4a53aef17c296b58dc4b6394fd576b808dd2fe5e6",
      "impliedFormat": 1
    },
    {
      "version": "459920181700cec8cbdf2a5faca127f3f17fd8dd9d9e577ed3f5f3af5d12a2e4",
      "impliedFormat": 1
    },
    {
      "version": "4719c209b9c00b579553859407a7e5dcfaa1c472994bd62aa5dd3cc0757eb077",
      "impliedFormat": 1
    },
    {
      "version": "7ec359bbc29b69d4063fe7dad0baaf35f1856f914db16b3f4f6e3e1bca4099fa",
      "impliedFormat": 1
    },
    {
      "version": "70790a7f0040993ca66ab8a07a059a0f8256e7bb57d968ae945f696cbff4ac7a",
      "impliedFormat": 1
    },
    {
      "version": "d1b9a81e99a0050ca7f2d98d7eedc6cda768f0eb9fa90b602e7107433e64c04c",
      "impliedFormat": 1
    },
    {
      "version": "a022503e75d6953d0e82c2c564508a5c7f8556fad5d7f971372d2d40479e4034",
      "impliedFormat": 1
    },
    {
      "version": "b215c4f0096f108020f666ffcc1f072c81e9f2f95464e894a5d5f34c5ea2a8b1",
      "impliedFormat": 1
    },
    {
      "version": "644491cde678bd462bb922c1d0cfab8f17d626b195ccb7f008612dc31f445d2d",
      "impliedFormat": 1
    },
    {
      "version": "dfe54dab1fa4961a6bcfba68c4ca955f8b5bbeb5f2ab3c915aa7adaa2eabc03a",
      "impliedFormat": 1
    },
    {
      "version": "1bb61aa2f08ab4506d41dbe16c5f3f5010f014bbf46fa3d715c0cbe3b00f4e1c",
      "impliedFormat": 1
    },
    {
      "version": "47865c5e695a382a916b1eedda1b6523145426e48a2eae4647e96b3b5e52024f",
      "impliedFormat": 1
    },
    {
      "version": "e42820cd611b15910c204cd133f692dcd602532b39317d4f2a19389b27e6f03d",
      "impliedFormat": 1
    },
    {
      "version": "331b8f71bfae1df25d564f5ea9ee65a0d847c4a94baa45925b6f38c55c7039bf",
      "impliedFormat": 1
    },
    {
      "version": "2a771d907aebf9391ac1f50e4ad37952943515eeea0dcc7e78aa08f508294668",
      "impliedFormat": 1
    },
    {
      "version": "0146fd6262c3fd3da51cb0254bb6b9a4e42931eb2f56329edd4c199cb9aaf804",
      "impliedFormat": 1
    },
    {
      "version": "183f480885db5caa5a8acb833c2be04f98056bdcc5fb29e969ff86e07efe57ab",
      "impliedFormat": 99
    },
    {
      "version": "f7eebe1b25040d805aefe8971310b805cd49b8602ec206d25b38dc48c542f165",
      "impliedFormat": 1
    },
    {
      "version": "a18642ddf216f162052a16cba0944892c4c4c977d3306a87cb673d46abbb0cbf",
      "impliedFormat": 1
    },
    {
      "version": "509f8efdfc5f9f6b52284170e8d7413552f02d79518d1db691ee15acc0088676",
      "impliedFormat": 1
    },
    {
      "version": "4ec16d7a4e366c06a4573d299e15fe6207fc080f41beac5da06f4af33ea9761e",
      "impliedFormat": 1
    },
    {
      "version": "7870becb94cbc11d2d01b77c4422589adcba4d8e59f726246d40cd0d129784d8",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "7f698624bbbb060ece7c0e51b7236520ebada74b747d7523c7df376453ed6fea",
      "impliedFormat": 1
    },
    {
      "version": "f70b8328a15ca1d10b1436b691e134a49bc30dcf3183a69bfaa7ba77e1b78ecd",
      "impliedFormat": 1
    },
    {
      "version": "ff3660e2664e6096196280deb4e176633b1bb1e58a7dcc9b021ec0e913a6f96f",
      "impliedFormat": 99
    },
    {
      "version": "b34b5f6b506abb206b1ea73c6a332b9ee9c8c98be0f6d17cdbda9430ecc1efab",
      "impliedFormat": 99
    },
    {
      "version": "75d4c746c3d16af0df61e7b0afe9606475a23335d9f34fcc525d388c21e9058b",
      "impliedFormat": 99
    },
    {
      "version": "fa959bf357232201c32566f45d97e70538c75a093c940af594865d12f31d4912",
      "impliedFormat": 99
    },
    {
      "version": "7d0eecfbb8fd85a40b3f1218d7b53f193d4194543a4053d0b007fcc869bd2594",
      "impliedFormat": 99
    },
    {
      "version": "e6233e1c976265e85aa8ad76c3881febe6264cb06ae3136f0257e1eab4a6cc5a",
      "impliedFormat": 99
    },
    {
      "version": "cc99b45397f724c65ab5b16dd2b9add8e2f49513621ccba4e3a564b939bfe706",
      "impliedFormat": 99
    },
    {
      "version": "4734f2650122fed32bf168723cbc2e7b64f0c281fec9fc7c37a23d68ee4d4033",
      "impliedFormat": 99
    },
    {
      "version": "324ac98294dab54fbd580c7d0e707d94506d7b2c3d5efe981a8495f02cf9ad96",
      "impliedFormat": 99
    },
    {
      "version": "9ec72eb493ff209b470467e24264116b6a8616484bca438091433a545dfba17e",
      "impliedFormat": 99
    },
    {
      "version": "dd1e40affaae1edc4beefe3d9832e86a683dcfc66fdf8c93c851a47298b04276",
      "impliedFormat": 99
    },
    {
      "version": "49747416f08b3ba50500a215e7a55d75268b84e31e896a40313c8053e8dec908",
      "impliedFormat": 99
    },
    {
      "version": "bb14e4b17394d59bd9f08459ce36d460dca08bd885c1347cf4fa7166c5af80a3",
      "impliedFormat": 99
    },
    {
      "version": "b07c8a8ea750da9dea2d813f9d4f65d14c0090bb00c6dde9372ec1d38b74992e",
      "impliedFormat": 99
    },
    {
      "version": "77217723774e80cf137592086cb40cd7607e106155a4c4071773574057863635",
      "impliedFormat": 99
    },
    {
      "version": "69bf2422313487956e4dacf049f30cb91b34968912058d244cb19e4baa24da97",
      "impliedFormat": 99
    },
    {
      "version": "971a2c327ff166c770c5fb35699575ba2d13bba1f6d2757309c9be4b30036c8e",
      "impliedFormat": 99
    },
    {
      "version": "3dc60aac181aa635ad323906cdb76d723376299f0f7a4264f2f3e2ae9b8ecc1b",
      "impliedFormat": 99
    },
    {
      "version": "7bd51996fb7717941cbe094b05adc0d80b9503b350a77b789bbb0fc786f28053",
      "impliedFormat": 99
    },
    {
      "version": "b62006bbc815fe8190c7aee262aad6bff993e3f9ade70d7057dfceab6de79d2f",
      "impliedFormat": 99
    },
    {
      "version": "33c8acef655f35aa0f44e13a1573488662755a99884292702262b97df6b9b473",
      "impliedFormat": 99
    },
    {
      "version": "cb0ec5ea8c0bb861262b62e0fbb899a85d86796de4caaadb53d747706fda82e3",
      "impliedFormat": 99
    },
    {
      "version": "3c1291fa957007538097ce38f7f0d65bf4c6ba6c2fad80ab806b71264fd296f4",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "3b8d3c5051687a7454c8f54746ba62b86b91c1e77bce27fea8f86ffc2d0a1325",
      "impliedFormat": 99
    },
    {
      "version": "171c0308da0fc6251ea4184989d62c33dff3f277695ab1d556c421c0af59ddd3",
      "affectsGlobalScope": true,
      "impliedFormat": 99
    },
    {
      "version": "fe2d63fcfdde197391b6b70daf7be8c02a60afa90754a5f4a04bdc367f62793d",
      "impliedFormat": 99
    },
    {
      "version": "8f86cb232f12a7261a16b4afcd8222327255daac1620b00a734119baf2862fa5",
      "affectsGlobalScope": true,
      "impliedFormat": 99
    },
    {
      "version": "1cc7fab9dcb518f2081a84caf4802c99db543fddad7227bceb3c3c97ea04688b",
      "impliedFormat": 99
    },
    {
      "version": "5a88655bf852c8cc007d6bc874ab61d1d63fba97063020458177173c454e9b4a",
      "impliedFormat": 99
    },
    {
      "version": "7e4dfae2da12ec71ffd9f55f4641a6e05610ce0d6784838659490e259e4eb13c",
      "impliedFormat": 99
    },
    {
      "version": "c30a41267fc04c6518b17e55dcb2b810f267af4314b0b6d7df1c33a76ce1b330",
      "impliedFormat": 1
    },
    {
      "version": "72422d0bac4076912385d0c10911b82e4694fc106e2d70added091f88f0824ba",
      "impliedFormat": 1
    },
    {
      "version": "da251b82c25bee1d93f9fd80c5a61d945da4f708ca21285541d7aff83ecb8200",
      "impliedFormat": 1
    },
    {
      "version": "4c8ca51077f382498f47074cf304d654aba5d362416d4f809dfdd5d4f6b3aaca",
      "impliedFormat": 1
    },
    {
      "version": "c6bddf16578495abc8b5546850b047f30c4b5a2a2b7fecefc0e11a44a6e91399",
      "impliedFormat": 1
    },
    {
      "version": "58c3c65b66f856365ceaf4f7a8f311f298ea8e1c20080ee852e91be53c98ab1d",
      "impliedFormat": 99
    },
    {
      "version": "0c5f112b6d3377b9e8214d8920e1a69d8098b881d941f2ab3ca45234d13d68de",
      "impliedFormat": 1
    },
    "708abc946c04ead5ee1faf423dd4c59b75d31507bf14a3b9662137becba56ba4",
    {
      "version": "78ef0198c323d0f7b16f993ada3459f0e7e20567e7f56fe0c5ee78f31cb0840c",
      "impliedFormat": 1
    },
    {
      "version": "01dea450d742aa55ce9b8ab8877bbda8eb73bf88609e440cc34f6f59f35080db",
      "impliedFormat": 1
    },
    {
      "version": "5ec614ed82e045de15417a47e2568be5310d43d4764ee43d295ea38caafbfd17",
      "impliedFormat": 1
    },
    {
      "version": "b788ef070e70003842cbd03c3e04f87d46b67a47b71e9e7d8713fd8c58c5f5ec",
      "impliedFormat": 1
    },
    {
      "version": "583d365dc19f813f1e2767771e844c7c4ea9ab1a01e85e0119f2e083488379c2",
      "impliedFormat": 1
    },
    {
      "version": "b82fc3869c625b828dd3feac4b5ebf335ed007d586dc16176602db73bc4e7c65",
      "impliedFormat": 1
    },
    {
      "version": "05e30605274c26f405c411eebed776fa2102418c05beec885e5c9bd0fa716f32",
      "impliedFormat": 1
    },
    {
      "version": "58c7f7820dc027a539b0437be7e1f8bdf663f91fbc9e861d80bb9368a38d4a94",
      "impliedFormat": 1
    },
    {
      "version": "d67d6b779d0dece9450d7a4170d3ee58ea7fcae0af2ab5e1d0ad711474b4f7f5",
      "impliedFormat": 1
    },
    {
      "version": "1066c11177d085898185548e1b38ed15fcea50061508f7c313ab8bec35d46b95",
      "impliedFormat": 1
    },
    {
      "version": "bbc49fd9dc6ee162ba3d270c834398e0c1d44e657ac4edfa55ac837902b7e0da",
      "impliedFormat": 1
    },
    {
      "version": "6993f360de4984b6743764fad3b88246d5dc6cfa45567783fc23833ad4e50c13",
      "impliedFormat": 1
    },
    {
      "version": "f11eb1fb4e569b293a7cae9e7cdae57e13efc12b0e4510e927868c93ec055e82",
      "impliedFormat": 1
    },
    {
      "version": "715682cddbefe50e27e5e7896acf4af0ffc48f9e18f64b0a0c2f8041e3ea869b",
      "impliedFormat": 1
    },
    {
      "version": "6d2f5a67bfe2034aa77b38f10977a57e762fd64e53c14372bcc5f1d3175ca322",
      "impliedFormat": 1
    },
    {
      "version": "4ff4add7b8cf26df217f2c883292778205847aefb0fd2aee64f5a229d0ffd399",
      "impliedFormat": 1
    },
    {
      "version": "33859aa36b264dd91bef77c279a5a0d259c6b63684d0c6ad538e515c69a489ec",
      "impliedFormat": 1
    },
    {
      "version": "33fa69f400b34c83e541dd5f4474f1c6fb2788614a1790c6c7b346b5c7eaa7dd",
      "impliedFormat": 1
    },
    {
      "version": "be213d7cbc3e5982b22df412cf223c2ac9d841c75014eae4c263761cd9d5e4c0",
      "impliedFormat": 1
    },
    {
      "version": "66451f9540fdf68a5fd93898257ccd7428cf7e49029f2e71b8ce70c8d927b87a",
      "impliedFormat": 1
    },
    {
      "version": "8a051690018330af516fd9ea42b460d603f0839f44d3946ebb4b551fe3bc7703",
      "impliedFormat": 1
    },
    {
      "version": "301fb04ef91ae1340bec1ebc3acdd223861c887a4a1127303d8eef7638b2d893",
      "impliedFormat": 1
    },
    {
      "version": "06236dfec90a14b0c3db8249831069ea3f90b004d73d496a559a4466e5a344a4",
      "impliedFormat": 1
    },
    {
      "version": "fc26991e51514bfc82e0f20c25132268b1d41e8928552dbaed7cc6f3d08fc3ac",
      "impliedFormat": 1
    },
    {
      "version": "5d82bb58dec5014c02aaeb3da465d34f4b7d5c724afea07559e3dfca6d8da5bc",
      "impliedFormat": 1
    },
    {
      "version": "44448f58f4d731dc28a02b5987ab6f20b9f77ad407dcf57b68c853fe52195cd7",
      "impliedFormat": 1
    },
    {
      "version": "b2818e8d05d6e6ad0f1899abf90a70309240a15153ea4b8d5e0c151e117b7338",
      "impliedFormat": 1
    },
    {
      "version": "1c708c15bb96473ce8ec2a946bd024ecded341169a0b84846931f979172244ba",
      "impliedFormat": 1
    },
    {
      "version": "ed0f5e1f45dc7c3f40356e0a855e8594aa57c125a5d8dfeef118e0a3024f98ff",
      "impliedFormat": 1
    },
    {
      "version": "dc187f457333356ddc1ab8ec7833cd836f85e0bbcade61290dc55116244867cb",
      "impliedFormat": 1
    },
    {
      "version": "25525e173de74143042e824eaa786fa18c6b19e9dafb64da71a5faacc5bd2a5c",
      "impliedFormat": 1
    },
    {
      "version": "7a3d649f2de01db4b316cf4a0ce5d96832ee83641f1dc84d3e9981accf29c3a1",
      "impliedFormat": 1
    },
    {
      "version": "26e4260ee185d4af23484d8c11ef422807fb8f51d33aa68d83fab72eb568f228",
      "impliedFormat": 1
    },
    {
      "version": "c4d52d78e3fb4f66735d81663e351cf56037270ed7d00a9b787e35c1fc7183ce",
      "impliedFormat": 1
    },
    {
      "version": "864a5505d0e9db2e1837dce8d8aae8b7eeaa5450754d8a1967bf2843124cc262",
      "impliedFormat": 1
    },
    {
      "version": "2d045f00292ac7a14ead30d1f83269f1f0ad3e75d1f8e5a245ab87159523cf98",
      "impliedFormat": 1
    },
    {
      "version": "54bcb32ab0c7c72b61becd622499a0ae1c309af381801a30878667e21cba85bb",
      "impliedFormat": 1
    },
    {
      "version": "20666518864143f162a9a43249db66ca1d142e445e2d363d5650a524a399b992",
      "impliedFormat": 1
    },
    {
      "version": "28439c9ebd31185ae3353dd8524115eaf595375cd94ca157eefcf1280920436a",
      "impliedFormat": 1
    },
    {
      "version": "84344d56f84577d4ac1d0d59749bb2fde14c0fb460d0bfb04e57c023748c48a6",
      "impliedFormat": 1
    },
    {
      "version": "7700b2fe36a1f602829b7d6fa21be7aa8ef58b4e765ba26510c098de83f0835b",
      "impliedFormat": 1
    },
    {
      "version": "66738976a7aa2d5fb2770a1b689f8bc643af958f836b7bc08e412d4092de3ab9",
      "impliedFormat": 1
    },
    {
      "version": "35a0eac48984d20f6da39947cf81cd71e0818feefc03dcb28b4ac7b87a636cfd",
      "impliedFormat": 1
    },
    {
      "version": "f6c226d8222108b3485eb0745e8b0ee48b0b901952660db20e983741e8852654",
      "impliedFormat": 1
    },
    {
      "version": "93c3b758c4dc64ea499c9416b1ed0e69725133644b299b86c5435e375d823c75",
      "impliedFormat": 1
    },
    {
      "version": "4e85f443714cff4858fdaffed31052492fdd03ff7883b22ed938fc0e34b48093",
      "impliedFormat": 1
    },
    {
      "version": "0146912d3cad82e53f779a0b7663f181824bba60e32715adb0e9bd02c560b8c6",
      "impliedFormat": 1
    },
    {
      "version": "70754650d1eba1fc96a4ed9bbbc8458b341b41063fe79f8fa828db7059696712",
      "impliedFormat": 1
    },
    {
      "version": "220783c7ca903c6ce296b210fae5d7e5c5cc1942c5a469b23d537f0fbd37eb18",
      "impliedFormat": 1
    },
    {
      "version": "0974c67cf3e2d539d0046c84a5e816e235b81c8516b242ece2ed1bdbb5dbd3d6",
      "impliedFormat": 1
    },
    {
      "version": "b4186237e7787a397b6c5ae64e155e70ac2a43fdd13ff24dfb6c1e3d2f930570",
      "impliedFormat": 1
    },
    {
      "version": "2647784fffa95a08af418c179b7b75cf1d20c3d32ed71418f0a13259bf505c54",
      "impliedFormat": 1
    },
    {
      "version": "0480102d1a385b96c05316b10de45c3958512bb9e834dbecbbde9cc9c0b22db3",
      "impliedFormat": 1
    },
    {
      "version": "eea44cfed69c9b38cc6366bd149a5cfa186776ca2a9fb87a3746e33b7e4f5e74",
      "impliedFormat": 1
    },
    {
      "version": "7f375e5ef1deb2c2357cba319b51a8872063d093cab750675ac2eb1cef77bee9",
      "impliedFormat": 1
    },
    {
      "version": "b7f06aec971823244f909996a30ef2bbeae69a31c40b0b208d0dfd86a8c16d4f",
      "impliedFormat": 1
    },
    {
      "version": "0421510c9570dfae34b3911e1691f606811818df00354df7abd028cee454979f",
      "impliedFormat": 1
    },
    {
      "version": "1517236728263863a79500653cc15ceb286f048907b3dba3141a482ca6946bd7",
      "impliedFormat": 1
    },
    {
      "version": "7c7b418e467a88a714b4c6dac321923b933f82875f063f48abf952021a2c2df1",
      "impliedFormat": 1
    },
    {
      "version": "33120063a7e106818ce109be9238569edca74d4e8530f853bd30d298d1375fd8",
      "impliedFormat": 1
    },
    {
      "version": "24c7a9a510502af1de311e9a5a7253b60a560ae6306631198c5fe8469df1369e",
      "impliedFormat": 1
    },
    {
      "version": "b6d03c9cfe2cf0ba4c673c209fcd7c46c815b2619fd2aad59fc4229aaef2ed43",
      "impliedFormat": 1
    },
    {
      "version": "3a9313fe5ace558b8b18e85f931da10b259e738775f411c061e5f15787b138eb",
      "impliedFormat": 1
    },
    {
      "version": "670a76db379b27c8ff42f1ba927828a22862e2ab0b0908e38b671f0e912cc5ed",
      "impliedFormat": 1
    },
    {
      "version": "81df92841a7a12d551fcbc7e4e83dbb7d54e0c73f33a82162d13e9ae89700079",
      "impliedFormat": 1
    },
    {
      "version": "069bebfee29864e3955378107e243508b163e77ab10de6a5ee03ae06939f0bb9",
      "impliedFormat": 1
    },
    {
      "version": "5fb46bf84a85cf5e924e30465b7f919c777a1a03af44ae8c273d2ca229dcfd44",
      "impliedFormat": 1
    },
    {
      "version": "2174e20517788d2a1379fc0aaacd87899a70f9e0197b4295edabfe75c4db03d8",
      "impliedFormat": 1
    },
    {
      "version": "104c67f0da1bdf0d94865419247e20eded83ce7f9911a1aa75fc675c077ca66e",
      "impliedFormat": 1
    },
    {
      "version": "117ffeecf6c55e25b6446f449ad079029b5e7317399b0a693858faaaea5ca73e",
      "impliedFormat": 1
    },
    {
      "version": "3937b50a4de68f6d21614461e9d47af0d8421ca80fc2a72b667ca2151f492120",
      "impliedFormat": 1
    },
    {
      "version": "e0c868a08451c879984ccf4d4e3c1240b3be15af8988d230214977a3a3dad4ce",
      "impliedFormat": 1
    },
    {
      "version": "6fc1a4f64372593767a9b7b774e9b3b92bf04e8785c3f9ea98973aa9f4bbe490",
      "impliedFormat": 1
    },
    {
      "version": "ff09b6fbdcf74d8af4e131b8866925c5e18d225540b9b19ce9485ca93e574d84",
      "impliedFormat": 1
    },
    {
      "version": "d5895252efa27a50f134a9b580aa61f7def5ab73d0a8071f9b5bf9a317c01c2d",
      "impliedFormat": 1
    },
    {
      "version": "2c378d9368abcd2eba8c29b294d40909845f68557bc0b38117e4f04fc56e5f9c",
      "impliedFormat": 1
    },
    {
      "version": "56208c500dcb5f42be7e18e8cb578f257a1a89b94b3280c506818fed06391805",
      "impliedFormat": 1
    },
    {
      "version": "0c94c2e497e1b9bcfda66aea239d5d36cd980d12a6d9d59e66f4be1fa3da5d5a",
      "impliedFormat": 1
    },
    {
      "version": "bb220eaac1677e2ad82ac4e7fd3e609a0c7b6f2d6d9c673a35068c97f9fcd5cd",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "1f366bde16e0513fa7b64f87f86689c4d36efd85afce7eb24753e9c99b91c319",
      "impliedFormat": 1
    },
    {
      "version": "fb893a0dfc3c9fb0f9ca93d0648694dd95f33cbad2c0f2c629f842981dfd4e2e",
      "impliedFormat": 1
    },
    {
      "version": "3eb11dbf3489064a47a2e1cf9d261b1f100ef0b3b50ffca6c44dd99d6dd81ac1",
      "impliedFormat": 1
    },
    {
      "version": "460627dd2a599c2664d6f9e81ed4765ef520dc2786551d9dcab276df57b98c02",
      "impliedFormat": 1
    },
    {
      "version": "15fe687c59d62741b4494d5e623d497d55eb38966ecf5bea7f36e48fc3fbe15e",
      "impliedFormat": 1
    },
    {
      "version": "42979633ab57d6cc7837b15be8c44c2087a264d5f2ca976afed684bee0925468",
      "impliedFormat": 99
    },
    {
      "version": "7212c2d58855b8df35275180e97903a4b6093d4fbaefea863d8d028da63938c6",
      "impliedFormat": 1
    },
    {
      "version": "de0199a112f75809a7f80ec071495159dcf3e434bc021347e0175627398264c3",
      "impliedFormat": 1
    },
    {
      "version": "1a2bed55cfa62b4649485df27c0e560b04d4da4911e3a9f0475468721495563f",
      "impliedFormat": 1
    },
    {
      "version": "854045924626ba585f454b53531c42aed4365f02301aa8eca596423f4675b71f",
      "impliedFormat": 1
    },
    {
      "version": "fd326577c62145816fe1acc306c734c2396487f76719d3785d4e825b34540b33",
      "impliedFormat": 1
    },
    {
      "version": "6cb35d83d21a7e72bd00398c93302749bcd38349d0cc5e76ff3a90c6d1498a4d",
      "impliedFormat": 1
    },
    {
      "version": "369dd7668d0e6c91550bce0c325f37ce6402e5dd40ecfca66fbb5283e23e559d",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "2632057d8b983ee33295566088c080384d7d69a492bc60b008d6a6dfd3508d6b",
      "impliedFormat": 1
    },
    {
      "version": "4bf71cf2a94492fc71e97800bdf2bcb0a9a0fa5fce921c8fe42c67060780cbfa",
      "impliedFormat": 1
    },
    {
      "version": "0996ff06f64cb05b6dac158a6ada2e16f8c2ccd20f9ff6f3c3e871f1ba5fb6d9",
      "impliedFormat": 1
    },
    {
      "version": "5c492d01a19fea5ebfff9d27e786bc533e5078909521ca17ae41236f16f9686a",
      "impliedFormat": 1
    },
    {
      "version": "a6ee930b81c65ec79aca49025b797817dde6f2d2e9b0e0106f0844e18e2cc819",
      "impliedFormat": 1
    },
    {
      "version": "84fce15473e993e6b656db9dd3c9196b80f545647458e6621675e840fd700d29",
      "impliedFormat": 1
    },
    {
      "version": "7d5336ee766aa72dffb1cc2a515f61d18a4fb61b7a2757cbccfb7b286b783dfb",
      "impliedFormat": 1
    },
    {
      "version": "63e96248ab63f6e7a86e31aa3e654ed6de1c3f99e3b668e04800df05874e8b77",
      "impliedFormat": 1
    },
    {
      "version": "80da0f61195385d22b666408f6cccbc261c066d401611a286f07dfddf7764017",
      "impliedFormat": 1
    },
    {
      "version": "06a20cc7d937074863861ea1159ac783ff97b13952b4b5d1811c7d8ab5c94776",
      "impliedFormat": 1
    },
    {
      "version": "ab6de4af0e293eae73b67dad251af097d7bcc0b8b62de84e3674e831514cb056",
      "impliedFormat": 1
    },
    {
      "version": "18cbd79079af97af66c9c07c61b481fce14a4e7282eca078c474b40c970ba1d0",
      "impliedFormat": 1
    },
    {
      "version": "e7b45405689d87e745a217b648d3646fb47a6aaba9c8d775204de90c7ea9ff35",
      "impliedFormat": 1
    },
    {
      "version": "669b754ec246dd7471e19b655b73bda6c2ca5bb7ccb1a4dff44a9ae45b6a716a",
      "impliedFormat": 1
    },
    {
      "version": "bcfaca4a8ff50f57fd36df91fba5d34056883f213baff7192cbfc4d3805d2084",
      "impliedFormat": 1
    },
    {
      "version": "76a564b360b267502219a89514953058494713ee0923a63b2024e542c18b40e5",
      "impliedFormat": 1
    },
    {
      "version": "8f62cbd3afbd6a07bb8c934294b6bfbe437021b89e53a4da7de2648ecfc7af25",
      "impliedFormat": 1
    },
    {
      "version": "a20629551ed7923f35f7556c4c15d0c8b2ebe7afaa68ceaab079a1707ba64be2",
      "impliedFormat": 1
    },
    {
      "version": "d6de66600c97cd499526ddecea6e12166ab1c0e8d9bf36fb2339fd39c8b3372a",
      "impliedFormat": 1
    },
    {
      "version": "8e7a5b8f867b99cc8763c0b024068fb58e09f7da2c4810c12833e1ca6eb11c4f",
      "impliedFormat": 1
    },
    {
      "version": "a8932876de2e3138a5a27f9426b225a4d27f0ba0a1e2764ba20930b4c3faf4b9",
      "impliedFormat": 1
    },
    {
      "version": "df877050b04c29b9f8409aa10278d586825f511f0841d1ec41b6554f8362092b",
      "impliedFormat": 1
    },
    {
      "version": "027d600e00c5f5e1816c207854285d736f2f5fa28276e2829db746d5d6811ba1",
      "impliedFormat": 1
    },
    {
      "version": "5443113a16ef378446e08d6500bb48b35de582426459abdb5c9704f5c7d327d9",
      "impliedFormat": 1
    },
    {
      "version": "0fb581ecb53304a3c95bb930160b4fa610537470cce850371cbaad5a458ca0d9",
      "impliedFormat": 1
    },
    {
      "version": "7da4e290c009d7967343a7f8c3f145a3d2c157c62483362183ba9f637a536489",
      "impliedFormat": 1
    },
    {
      "version": "eb21ddc3a8136a12e69176531197def71dc28ffaf357b74d4bf83407bd845991",
      "impliedFormat": 1
    },
    {
      "version": "914560d0c4c6aa947cfe7489fe970c94ba25383c414bbe0168b44fd20dbf0df4",
      "impliedFormat": 1
    },
    {
      "version": "4fb3405055b54566dea2135845c3a776339e7e170d692401d97fd41ad9a20e5d",
      "impliedFormat": 1
    },
    {
      "version": "8d607832a6ef0eac30657173441367dd76c96bf7800d77193428b922e060c3af",
      "impliedFormat": 1
    },
    {
      "version": "20ff7207f0bb5cdde5fee8e83315ade7e5b8100cfa2087d20d39069a3d7d06f4",
      "impliedFormat": 1
    },
    {
      "version": "7ca4c534eab7cff43d81327e369a23464bc37ef38ce5337ceff24a42c6c84eb2",
      "impliedFormat": 1
    },
    {
      "version": "5252dec18a34078398be4e321dee884dc7f47930e5225262543a799b591b36d2",
      "impliedFormat": 1
    },
    {
      "version": "23caed4dff98bd28157d2b798b43f1dfefe727f18641648c01ce4e0e929a1630",
      "impliedFormat": 1
    },
    {
      "version": "f67e013d5374826596d7c23dbae1cdb14375a27cd72e16c5fb46a4b445059329",
      "impliedFormat": 1
    },
    {
      "version": "ea3401b70e2302683bbf4c18b69ef2292b60f4d8f8e6d920413b81fb7bde0f65",
      "impliedFormat": 1
    },
    {
      "version": "71afe26642c0fb86b9f8b1af4af5deb5181b43b6542a3ff2314871b53d04c749",
      "impliedFormat": 1
    },
    {
      "version": "0d7f01634e6234d84cf0106508efdb8ae00e5ed126eff9606d37b031ac1de654",
      "impliedFormat": 1
    },
    {
      "version": "f8d209086bad78af6bd7fef063c1ed449c815e6f8d36058115f222d9f788b848",
      "impliedFormat": 1
    },
    {
      "version": "3ad003278d569d1953779e2f838f7798f02e793f6a1eceac8e0065f1a202669b",
      "impliedFormat": 1
    },
    {
      "version": "fb2c5eceffcd918dbb86332afa0199f5e7b6cf6ee42809e930a827b28ef25afe",
      "impliedFormat": 1
    },
    {
      "version": "f664aaff6a981eeca68f1ff2d9fd21b6664f47bf45f3ae19874df5a6683a8d8a",
      "impliedFormat": 1
    },
    {
      "version": "ce066f85d73e09e9adbd0049bcf6471c7eefbfc2ec4b5692b5bcef1e36babd2a",
      "impliedFormat": 1
    },
    {
      "version": "09d302513cacfbcc54b67088739bd8ac1c3c57917f83f510b2d1adcb99fd7d2a",
      "impliedFormat": 1
    },
    {
      "version": "3faa54e978b92a6f726440c13fe3ab35993dc74d697c7709681dc1764a25219f",
      "impliedFormat": 1
    },
    {
      "version": "2bd0489e968925eb0c4c0fb12ef090be5165c86bd088e1e803102c38d4a717d8",
      "impliedFormat": 1
    },
    {
      "version": "88924207132b9ba339c1adb1ed3ea07e47b3149ff8a2e21a3ea1f91cee68589d",
      "impliedFormat": 1
    },
    {
      "version": "b8800b93d8ab532f8915be73f8195b9d4ef06376d8a82e8cdc17c400553172d6",
      "impliedFormat": 1
    },
    {
      "version": "d7d469703b78beba76d511957f8c8b534c3bbb02bea7ab4705c65ef573532fb8",
      "impliedFormat": 1
    },
    {
      "version": "74c8c3057669c03264263d911d0f82e876cef50b05be21c54fef23c900de0420",
      "impliedFormat": 1
    },
    {
      "version": "b303eda2ff2d582a9c3c5ecb708fb57355cdc25e8c8197a9f66d4d1bf09fda19",
      "impliedFormat": 1
    },
    {
      "version": "4e5dc89fa22ff43da3dee1db97d5add0591ebaff9e4adef6c8b6f0b41f0f60f0",
      "impliedFormat": 1
    },
    {
      "version": "ec4e82cb42a902fe83dc13153c7a260bee95684541f8d7ef26cb0629a2f4ca31",
      "impliedFormat": 1
    },
    {
      "version": "5f36e24cd92b0ff3e2a243685a8a780c9413941c36739f04b428cc4e15de629d",
      "impliedFormat": 1
    },
    {
      "version": "40a26494e6ab10a91851791169582ab77fed4fbd799518968177e7eefe08c7a9",
      "impliedFormat": 1
    },
    {
      "version": "208e125b45bc561765a74f6f1019d88e44e94678769824cf93726e1bac457961",
      "impliedFormat": 1
    },
    {
      "version": "b3985971de086ef3aa698ef19009a53527b72e65851b782dc188ac341a1e1390",
      "impliedFormat": 1
    },
    {
      "version": "c81d421aabb6113cd98b9d4f11e9a03273b363b841f294b457f37c15d513151d",
      "impliedFormat": 1
    },
    {
      "version": "30063e3a184ff31254bbafa782c78a2d6636943dfe59e1a34f451827fd7a68dc",
      "impliedFormat": 1
    },
    {
      "version": "c05d4cae0bceed02c9d013360d3e65658297acb1b7a90252fe366f2bf4f9ccc9",
      "impliedFormat": 1
    },
    {
      "version": "6f14b92848889abba03a474e0750f7350cc91fc190c107408ca48679a03975ae",
      "impliedFormat": 1
    },
    {
      "version": "a588d0765b1d18bf00a498b75a83e095aef75a9300b6c1e91cbf39e408f2fe2f",
      "impliedFormat": 1
    },
    {
      "version": "08323a8971cb5b2632b532cba1636ad4ca0d76f9f7d0b8d1a0c706fdf5c77b45",
      "impliedFormat": 1
    },
    {
      "version": "5d2651c679f59706bf484e7d423f0ec2d9c79897e2e68c91a3f582f21328d193",
      "impliedFormat": 1
    },
    {
      "version": "30d49e69cb62f350ff0bc5dda1c557429c425014955c19c557f101c0de9272e7",
      "impliedFormat": 1
    },
    {
      "version": "d3747dbed45540212e9a906c2fb8b5beb691f2cd0861af58a66dc01871004f38",
      "impliedFormat": 1
    },
    {
      "version": "05a21cbb7cbe1ec502e7baca1f4846a4e860d96bad112f3e316b995ba99715b7",
      "impliedFormat": 1
    },
    {
      "version": "1eaee2b52f1c0e1848845a79050c1d06ae554d8050c35e3bf479f13d6ee19dd5",
      "impliedFormat": 1
    },
    {
      "version": "fd219904eea67c470dfebbaf44129b0db858207c3c3b55514bdc84de547b1687",
      "impliedFormat": 1
    },
    {
      "version": "4de232968f584b960b4101b4cdae593456aff149c5d0c70c2389248e9eb9fbac",
      "impliedFormat": 1
    },
    {
      "version": "933c42f6ed2768265dfb42faa817ce8d902710c57a21a1859a9c3fe5e985080e",
      "impliedFormat": 1
    },
    {
      "version": "c5430542eeebb207d651e8b00a08e4bb680c47ecb73dd388d8fa597a1fc5de5b",
      "impliedFormat": 1
    },
    {
      "version": "a6c5c9906262cf10549989c0061e5a44afdc1f61da77d5e09418a9ecea0018fe",
      "impliedFormat": 1
    },
    {
      "version": "bc6e433cb982bf63eaa523dbbbd30fe12960a09861b352d77baf77ad6dd8886d",
      "impliedFormat": 1
    },
    {
      "version": "9af64ab00918f552388252977c1569fe31890686ca1fdb8e20f58d3401c9a50c",
      "impliedFormat": 1
    },
    {
      "version": "3d3cc03b5c6e056c24aac76789f4bc67caee98a4f0774ab82bc8ba34d16be916",
      "impliedFormat": 1
    },
    {
      "version": "747ce36fa27a750a05096f3610e59c9b5a55e13defec545c01a75fd13d67b620",
      "impliedFormat": 1
    },
    {
      "version": "1a8f503c64bdb36308f245960d9e4acac4cf65d8b6bd0534f88230ebf0be7883",
      "impliedFormat": 1
    },
    {
      "version": "a2c1f4012459547d62116d724e7ec820bb2e6848da40ea0747bf160ffd99b283",
      "impliedFormat": 1
    },
    {
      "version": "0dc197e52512a7cbea4823cc33c23b0337af97bd59b38bf83be047f37cd8c9a8",
      "impliedFormat": 1
    },
    {
      "version": "492c93ade227fe4545fabb3035b9dd5d57d8b4fde322e5217fdaef20aa1b80a8",
      "impliedFormat": 1
    },
    {
      "version": "83c54a3b3e836d1773b8c23ff76ce6e0aae1a2209fc772b75e9de173fec9eac0",
      "impliedFormat": 1
    },
    {
      "version": "475e411f48f74c14b1f6e50cc244387a5cc8ce52340dddfae897c96e03f86527",
      "impliedFormat": 1
    },
    {
      "version": "5573ce7aa683a81c9a727294ffdb47d82d7715a148bfe9f4ddcf2f6cdfef1f0a",
      "impliedFormat": 1
    },
    {
      "version": "2cd9edbb4a6411a9f5258237dd73323db978d7aa9ebf1d1b0ac79771ac233e24",
      "impliedFormat": 1
    },
    {
      "version": "f3d8c757e148ad968f0d98697987db363070abada5f503da3c06aefd9d4248c1",
      "impliedFormat": 1
    },
    {
      "version": "742f21debb3937c3839a63245648238555bdab1ea095d43fd10c88a64029bf76",
      "impliedFormat": 1
    },
    {
      "version": "7cfdf3b9a5ba934a058bfc9390c074104dc7223b7e3c16fd5335206d789bc3d3",
      "impliedFormat": 1
    },
    {
      "version": "380b919bfa0516118edaf25b99e45f855e7bc3fd75ce4163a1cfe4a666388804",
      "impliedFormat": 1
    },
    {
      "version": "0b24a72109c8dd1b41f94abfe1bb296ba01b3734b8ac632db2c48ffc5dccaf01",
      "impliedFormat": 1
    },
    {
      "version": "fcf79300e5257a23ed3bacaa6861d7c645139c6f7ece134d15e6669447e5e6db",
      "impliedFormat": 1
    },
    {
      "version": "187119ff4f9553676a884e296089e131e8cc01691c546273b1d0089c3533ce42",
      "impliedFormat": 1
    },
    {
      "version": "aa2c18a1b5a086bbcaae10a4efba409cc95ba7287d8cf8f2591b53704fea3dea",
      "impliedFormat": 1
    },
    {
      "version": "b88749bdb18fc1398370e33aa72bc4f88274118f4960e61ce26605f9b33c5ba2",
      "impliedFormat": 1
    },
    {
      "version": "0aaef8cded245bf5036a7a40b65622dd6c4da71f7a35343112edbe112b348a1e",
      "impliedFormat": 1
    },
    {
      "version": "00baffbe8a2f2e4875367479489b5d43b5fc1429ecb4a4cc98cfc3009095f52a",
      "impliedFormat": 1
    },
    {
      "version": "a873c50d3e47c21aa09fbe1e2023d9a44efb07cc0cb8c72f418bf301b0771fd3",
      "impliedFormat": 1
    },
    {
      "version": "7c14ccd2eaa82619fffc1bfa877eb68a012e9fb723d07ee98db451fadb618906",
      "impliedFormat": 1
    },
    {
      "version": "49c36529ee09ea9ce19525af5bb84985ea8e782cb7ee8c493d9e36d027a3d019",
      "impliedFormat": 1
    },
    {
      "version": "df996e25faa505f85aeb294d15ebe61b399cf1d1e49959cdfaf2cc0815c203f9",
      "impliedFormat": 1
    },
    {
      "version": "4f6a12044ee6f458db11964153830abbc499e73d065c51c329ec97407f4b13dd",
      "impliedFormat": 1
    },
    {
      "version": "0944f27ebff4b20646b71e7e3faaaae50a6debd40bc63e225de1320dd15c5795",
      "impliedFormat": 1
    },
    {
      "version": "8a7219b41d3c1c93f3f3b779146f313efade2404eeece88dcd366df7e2364977",
      "impliedFormat": 1
    },
    {
      "version": "a109c4289d59d9019cfe1eeab506fe57817ee549499b02a83a7e9d3bdf662d63",
      "impliedFormat": 1
    },
    {
      "version": "5d30565583300c9256072a013ac0318cc603ff769b4c5cafc222394ea93963e1",
      "impliedFormat": 1
    },
    {
      "version": "8ea84a2aeaa6e3f0ee7536f290f21aa0516b1beeb8afd9a345746c202d4fecd5",
      "impliedFormat": 1
    },
    {
      "version": "963d59066dd6742da1918a6213a209bcc205b8ee53b1876ee2b4e6d80f97c85e",
      "impliedFormat": 1
    },
    {
      "version": "6eb639ffa89a206d4eb9e68270ba781caede9fe44aa5dc8f73600a2f6b166715",
      "impliedFormat": 1
    },
    {
      "version": "736097ddbb2903bef918bb3b5811ef1c9c5656f2a73bd39b22a91b9cc2525e50",
      "impliedFormat": 1
    },
    {
      "version": "4340936f4e937c452ae783514e7c7bbb7fc06d0c97993ff4865370d0962bb9cf",
      "impliedFormat": 1
    },
    {
      "version": "b70c7ea83a7d0de17a791d9b5283f664033a96362c42cc4d2b2e0bdaa65ef7d1",
      "impliedFormat": 1
    },
    {
      "version": "8a6df667b6a77f8e38e7cc3c0cdf405d9cea819fac48c2a453fdd3a07e8a13a9",
      "impliedFormat": 1
    },
    {
      "version": "a589f9f052276a3fc00b75e62f73b93ea568fce3e935b86ed7052945f99d9dc2",
      "impliedFormat": 1
    },
    {
      "version": "17230b34bb564a3a2e36f9d3985372ccab4ad1722df2c43f7c5c2b553f68e5db",
      "impliedFormat": 1
    },
    {
      "version": "6e5c9272f6b3783be7bdddaf207cccdb8e033be3d14c5beacc03ae9d27d50929",
      "impliedFormat": 1
    },
    {
      "version": "9b4f7ff9681448c72abe38ea8eefd7ffe0c3aefe495137f02012a08801373f71",
      "impliedFormat": 1
    },
    {
      "version": "0dfe35191a04e8f9dc7caeb9f52f2ee07402736563d12cbccd15fb5f31ac877f",
      "impliedFormat": 1
    },
    {
      "version": "53e8c672c4a6af14dd4c08082e6e30d3c3b78ec0d3f9cd34f4177be4696070da",
      "impliedFormat": 1
    },
    {
      "version": "4416b35cac42a23ea7cc4c6bff46822bf3b663281d35df9753db96e0f955e797",
      "impliedFormat": 1
    },
    {
      "version": "f1e7b4d34de987c6912c0dd5710b6995abb587873edfb71ff9e549ca01972c5a",
      "impliedFormat": 99
    },
    {
      "version": "b3a24e1c22dd4fde2ce413fb8244e5fa8773ffca88e8173c780845c9856aef73",
      "impliedFormat": 1
    },
    {
      "version": "f4ae5546352701fd6932fdd86419438bb51253e4627a44808489742035bac644",
      "impliedFormat": 1
    },
    {
      "version": "170d4db14678c68178ee8a3d5a990d5afb759ecb6ec44dbd885c50f6da6204f6",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "8a8eb4ebffd85e589a1cc7c178e291626c359543403d58c9cd22b81fab5b1fb9",
      "impliedFormat": 1
    },
    {
      "version": "d4d7d3f832882a4b2d611a7eaaa80c780c3342b5732090130fa9af4a40bd051e",
      "impliedFormat": 1
    },
    {
      "version": "36a2e4c9a67439aca5f91bb304611d5ae6e20d420503e96c230cf8fcdc948d94",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "da172a28c35d5f298bf5f0361725cc80f45e89e803a353c56e1aa347e10f572d",
      "impliedFormat": 1
    },
    {
      "version": "115b2ad73fa7d175cd71a5873d984c21593b2a022f1a2036cc39d9f53629e5dc",
      "impliedFormat": 1
    },
    {
      "version": "e91ad231af87f864b3f07cd0e39b1cf6c133988156f087c1c3ccb0a5491c9115",
      "impliedFormat": 1
    },
    {
      "version": "03c258e060b7da220973f84b89615e4e9850e9b5d30b3a8e4840b3e3268ae8eb",
      "impliedFormat": 1
    },
    {
      "version": "319c37263037e8d9481a3dc7eadf6afa6a5f5c002189ebe28776ac1a62a38e15",
      "impliedFormat": 1
    },
    {
      "version": "837f5c12e3e94ee97aca37aa2a50ede521e5887fb7fa89330f5625b70597e116",
      "impliedFormat": 1
    },
    {
      "version": "c130f9616a960edc892aa0eb7a8a59f33e662c561474ed092c43a955cdb91dab",
      "impliedFormat": 1
    },
    {
      "version": "10281654231a4dfa1a41af0415afbd6d0998417959aed30c9f0054644ce10f5c",
      "impliedFormat": 1
    },
    {
      "version": "2c3b8be03577c98530ef9cb1a76e2c812636a871f367e9edf4c5f3ce702b77f8",
      "affectsGlobalScope": true,
      "impliedFormat": 1
    },
    {
      "version": "7fa8d75d229eeaee235a801758d9c694e94405013fe77d5d1dd8e3201fc414f1",
      "impliedFormat": 1
    },
    {
      "version": "f874ea4d0091b0a44362a5f74d26caab2e66dec306c2bf7e8965f5106e784c3b",
      "impliedFormat": 1
    },
    {
      "version": "1ba59c8bbeed2cb75b239bb12041582fa3e8ef32f8d0bd0ec802e38442d3f317",
      "impliedFormat": 1
    }
  ],
  "root": [521, 523, 524, 660, 714, 715, 717, 718, 734, 822],
  "options": {
    "allowJs": true,
    "composite": true,
    "emitDeclarationOnly": false,
    "esModuleInterop": true,
    "module": 99,
    "skipLibCheck": true,
    "strict": true,
    "strictNullChecks": true,
    "target": 9,
    "tsBuildInfoFile": "./tsbuildinfo.json"
  },
  "referencedMap": [
    [490, 1],
    [387, 2],
    [390, 3],
    [391, 3],
    [392, 3],
    [393, 3],
    [394, 3],
    [395, 3],
    [396, 3],
    [397, 3],
    [398, 3],
    [399, 3],
    [400, 3],
    [401, 3],
    [402, 3],
    [403, 3],
    [404, 3],
    [405, 3],
    [406, 3],
    [407, 3],
    [408, 3],
    [409, 3],
    [410, 3],
    [411, 3],
    [412, 3],
    [413, 3],
    [414, 3],
    [415, 3],
    [416, 3],
    [417, 3],
    [418, 3],
    [419, 3],
    [420, 3],
    [421, 3],
    [422, 3],
    [423, 3],
    [424, 3],
    [425, 3],
    [426, 3],
    [427, 3],
    [428, 3],
    [429, 3],
    [430, 3],
    [431, 3],
    [432, 3],
    [433, 3],
    [434, 3],
    [435, 3],
    [436, 3],
    [437, 3],
    [438, 3],
    [439, 3],
    [440, 3],
    [441, 3],
    [442, 3],
    [443, 3],
    [444, 3],
    [445, 3],
    [446, 3],
    [495, 4],
    [447, 3],
    [448, 3],
    [449, 3],
    [450, 3],
    [451, 3],
    [452, 3],
    [453, 3],
    [454, 3],
    [455, 3],
    [456, 3],
    [457, 3],
    [458, 3],
    [459, 3],
    [460, 3],
    [462, 5],
    [463, 5],
    [464, 5],
    [465, 5],
    [466, 5],
    [467, 5],
    [468, 5],
    [469, 5],
    [470, 5],
    [471, 5],
    [472, 5],
    [473, 5],
    [474, 5],
    [475, 5],
    [476, 5],
    [477, 5],
    [478, 5],
    [479, 5],
    [480, 5],
    [481, 5],
    [482, 5],
    [483, 5],
    [484, 5],
    [485, 5],
    [486, 5],
    [487, 5],
    [488, 5],
    [489, 5],
    [386, 6],
    [491, 7],
    [511, 8],
    [510, 9],
    [389, 10],
    [461, 11],
    [388, 12],
    [501, 13],
    [496, 14],
    [497, 15],
    [498, 16],
    [499, 17],
    [500, 18],
    [492, 19],
    [494, 20],
    [493, 21],
    [509, 22],
    [505, 23],
    [506, 23],
    [507, 24],
    [508, 24],
    [385, 25],
    [350, 26],
    [353, 27],
    [351, 28],
    [352, 28],
    [356, 29],
    [355, 30],
    [359, 31],
    [357, 32],
    [354, 33],
    [358, 34],
    [361, 35],
    [360, 26],
    [362, 26],
    [364, 6],
    [384, 36],
    [372, 26],
    [369, 37],
    [370, 37],
    [368, 38],
    [371, 38],
    [367, 39],
    [365, 40],
    [366, 40],
    [373, 6],
    [380, 41],
    [379, 42],
    [377, 6],
    [378, 43],
    [382, 44],
    [383, 6],
    [375, 45],
    [376, 46],
    [374, 46],
    [153, 6],
    [234, 6],
    [236, 47],
    [235, 48],
    [363, 49],
    [381, 50],
    [272, 51],
    [273, 33],
    [274, 26],
    [278, 52],
    [275, 6],
    [276, 6],
    [277, 53],
    [271, 54],
    [270, 6],
    [263, 55],
    [267, 26],
    [265, 56],
    [268, 26],
    [266, 57],
    [269, 58],
    [264, 6],
    [262, 26],
    [503, 59],
    [504, 60],
    [502, 6],
    [520, 61],
    [518, 62],
    [519, 63],
    [146, 64],
    [142, 26],
    [145, 6],
    [148, 65],
    [147, 65],
    [149, 65],
    [150, 66],
    [152, 67],
    [143, 68],
    [144, 68],
    [151, 64],
    [154, 6],
    [233, 69],
    [156, 70],
    [155, 6],
    [157, 6],
    [200, 71],
    [199, 72],
    [202, 73],
    [215, 34],
    [216, 32],
    [228, 74],
    [217, 75],
    [229, 76],
    [198, 28],
    [201, 77],
    [230, 78],
    [231, 6],
    [232, 79],
    [512, 80],
    [517, 81],
    [516, 82],
    [515, 83],
    [514, 84],
    [513, 85],
    [158, 6],
    [159, 6],
    [160, 6],
    [161, 6],
    [162, 6],
    [163, 6],
    [164, 6],
    [173, 86],
    [174, 6],
    [175, 26],
    [176, 6],
    [177, 6],
    [178, 6],
    [179, 6],
    [167, 26],
    [180, 26],
    [181, 6],
    [166, 87],
    [168, 88],
    [165, 6],
    [171, 89],
    [169, 87],
    [170, 6],
    [197, 90],
    [182, 6],
    [183, 88],
    [184, 6],
    [185, 6],
    [186, 26],
    [187, 6],
    [188, 6],
    [189, 6],
    [190, 6],
    [191, 6],
    [192, 6],
    [193, 91],
    [194, 6],
    [195, 6],
    [172, 6],
    [196, 6],
    [885, 92],
    [883, 26],
    [700, 93],
    [708, 94],
    [701, 95],
    [704, 96],
    [705, 97],
    [711, 98],
    [709, 99],
    [706, 100],
    [713, 101],
    [699, 102],
    [697, 103],
    [698, 104],
    [696, 105],
    [707, 106],
    [702, 107],
    [703, 108],
    [710, 109],
    [712, 110],
    [241, 111],
    [237, 32],
    [238, 32],
    [240, 112],
    [239, 6],
    [251, 113],
    [242, 32],
    [244, 114],
    [243, 6],
    [246, 115],
    [245, 26],
    [249, 116],
    [250, 117],
    [247, 118],
    [248, 118],
    [252, 6],
    [253, 119],
    [256, 120],
    [258, 121],
    [257, 6],
    [259, 120],
    [260, 120],
    [261, 122],
    [254, 6],
    [255, 26],
    [140, 123],
    [128, 6],
    [138, 124],
    [139, 6],
    [141, 125],
    [221, 126],
    [222, 127],
    [223, 6],
    [224, 128],
    [220, 129],
    [218, 6],
    [219, 6],
    [227, 130],
    [225, 26],
    [226, 6],
    [129, 26],
    [130, 26],
    [131, 26],
    [132, 26],
    [137, 131],
    [133, 6],
    [134, 6],
    [135, 132],
    [136, 6],
    [205, 26],
    [211, 6],
    [206, 6],
    [207, 6],
    [208, 6],
    [212, 6],
    [214, 133],
    [209, 6],
    [210, 6],
    [213, 6],
    [204, 134],
    [203, 6],
    [279, 6],
    [319, 135],
    [320, 136],
    [321, 26],
    [322, 137],
    [323, 26],
    [324, 26],
    [325, 26],
    [326, 6],
    [327, 135],
    [328, 6],
    [330, 138],
    [331, 139],
    [329, 6],
    [332, 26],
    [333, 26],
    [349, 140],
    [334, 26],
    [335, 6],
    [336, 26],
    [337, 135],
    [338, 26],
    [339, 26],
    [292, 141],
    [293, 26],
    [309, 142],
    [308, 6],
    [318, 49],
    [311, 74],
    [312, 26],
    [310, 143],
    [317, 144],
    [313, 6],
    [314, 6],
    [316, 145],
    [315, 6],
    [294, 6],
    [307, 50],
    [296, 146],
    [295, 6],
    [302, 147],
    [298, 148],
    [299, 148],
    [303, 6],
    [300, 148],
    [297, 6],
    [305, 6],
    [304, 148],
    [301, 148],
    [306, 149],
    [340, 6],
    [341, 26],
    [348, 150],
    [342, 26],
    [343, 26],
    [344, 26],
    [345, 26],
    [346, 26],
    [347, 26],
    [60, 151],
    [61, 152],
    [62, 26],
    [63, 26],
    [76, 153],
    [77, 154],
    [74, 155],
    [75, 156],
    [78, 157],
    [81, 158],
    [83, 159],
    [84, 160],
    [66, 161],
    [85, 26],
    [89, 162],
    [87, 163],
    [88, 26],
    [82, 26],
    [91, 164],
    [67, 165],
    [93, 166],
    [94, 167],
    [97, 168],
    [96, 169],
    [92, 170],
    [95, 171],
    [90, 172],
    [98, 173],
    [99, 174],
    [103, 175],
    [104, 176],
    [102, 177],
    [80, 178],
    [68, 26],
    [71, 179],
    [105, 180],
    [106, 181],
    [107, 181],
    [64, 26],
    [109, 182],
    [108, 181],
    [127, 183],
    [69, 26],
    [73, 184],
    [110, 185],
    [111, 26],
    [65, 26],
    [101, 186],
    [115, 187],
    [113, 26],
    [114, 26],
    [112, 188],
    [100, 189],
    [116, 190],
    [117, 191],
    [118, 158],
    [119, 158],
    [120, 192],
    [86, 26],
    [122, 193],
    [123, 194],
    [79, 26],
    [124, 26],
    [125, 195],
    [121, 26],
    [70, 196],
    [72, 172],
    [126, 151],
    [280, 26],
    [282, 6],
    [281, 197],
    [283, 198],
    [284, 199],
    [285, 197],
    [286, 197],
    [287, 200],
    [291, 201],
    [288, 197],
    [289, 200],
    [290, 26],
    [719, 26],
    [823, 26],
    [824, 26],
    [825, 26],
    [882, 202],
    [826, 203],
    [871, 204],
    [828, 205],
    [827, 206],
    [829, 203],
    [830, 203],
    [832, 207],
    [831, 203],
    [833, 208],
    [834, 208],
    [835, 203],
    [837, 209],
    [838, 203],
    [839, 209],
    [840, 203],
    [842, 203],
    [843, 203],
    [844, 203],
    [845, 210],
    [841, 203],
    [846, 26],
    [847, 211],
    [848, 211],
    [849, 211],
    [850, 211],
    [851, 211],
    [860, 212],
    [852, 211],
    [853, 211],
    [854, 211],
    [855, 211],
    [857, 211],
    [856, 211],
    [858, 211],
    [859, 211],
    [861, 203],
    [862, 203],
    [836, 203],
    [863, 209],
    [865, 213],
    [864, 203],
    [866, 203],
    [867, 203],
    [868, 214],
    [870, 203],
    [869, 203],
    [872, 203],
    [874, 203],
    [875, 215],
    [873, 203],
    [876, 203],
    [877, 203],
    [878, 203],
    [879, 203],
    [880, 203],
    [881, 203],
    [888, 216],
    [884, 92],
    [886, 217],
    [887, 92],
    [889, 218],
    [890, 26],
    [891, 219],
    [892, 26],
    [893, 219],
    [894, 26],
    [895, 26],
    [896, 26],
    [897, 220],
    [898, 26],
    [900, 221],
    [901, 222],
    [899, 26],
    [902, 26],
    [904, 223],
    [905, 26],
    [749, 26],
    [912, 224],
    [999, 225],
    [978, 226],
    [980, 227],
    [979, 226],
    [982, 228],
    [984, 229],
    [985, 230],
    [986, 231],
    [987, 229],
    [988, 230],
    [989, 229],
    [990, 232],
    [991, 230],
    [992, 229],
    [993, 233],
    [994, 234],
    [995, 235],
    [996, 236],
    [983, 237],
    [997, 238],
    [981, 238],
    [998, 239],
    [976, 240],
    [926, 241],
    [924, 241],
    [975, 26],
    [951, 242],
    [939, 243],
    [919, 244],
    [949, 243],
    [950, 243],
    [953, 245],
    [954, 243],
    [921, 246],
    [955, 243],
    [956, 243],
    [957, 243],
    [958, 243],
    [959, 247],
    [960, 248],
    [961, 243],
    [917, 243],
    [962, 243],
    [963, 243],
    [964, 247],
    [965, 243],
    [966, 243],
    [967, 249],
    [968, 243],
    [969, 245],
    [970, 243],
    [918, 243],
    [971, 243],
    [972, 243],
    [973, 250],
    [916, 251],
    [922, 252],
    [952, 253],
    [925, 254],
    [974, 255],
    [927, 256],
    [928, 257],
    [937, 258],
    [936, 259],
    [932, 260],
    [931, 259],
    [933, 261],
    [930, 262],
    [929, 263],
    [935, 264],
    [934, 261],
    [938, 265],
    [920, 266],
    [915, 267],
    [913, 268],
    [923, 26],
    [914, 269],
    [944, 26],
    [945, 26],
    [942, 26],
    [943, 247],
    [941, 26],
    [946, 26],
    [940, 268],
    [948, 26],
    [947, 26],
    [1000, 26],
    [1001, 26],
    [1002, 270],
    [1004, 271],
    [1005, 272],
    [1003, 273],
    [1006, 274],
    [1007, 275],
    [1008, 276],
    [1009, 277],
    [1010, 278],
    [1011, 279],
    [1012, 280],
    [1013, 281],
    [1014, 282],
    [1015, 283],
    [1017, 284],
    [1018, 285],
    [1016, 26],
    [1019, 286],
    [1020, 218],
    [1021, 26],
    [903, 26],
    [1022, 287],
    [1024, 26],
    [1025, 288],
    [1026, 289],
    [1035, 290],
    [1034, 291],
    [1033, 292],
    [1032, 291],
    [1036, 26],
    [1042, 293],
    [1040, 26],
    [1041, 294],
    [1037, 26],
    [1039, 295],
    [1045, 296],
    [1043, 297],
    [1046, 26],
    [1047, 298],
    [977, 289],
    [1048, 26],
    [1044, 26],
    [1049, 299],
    [906, 26],
    [1050, 26],
    [1051, 26],
    [1052, 300],
    [658, 301],
    [659, 302],
    [657, 303],
    [639, 304],
    [647, 305],
    [638, 304],
    [654, 306],
    [630, 307],
    [629, 308],
    [653, 309],
    [648, 310],
    [651, 311],
    [632, 312],
    [631, 313],
    [627, 314],
    [626, 309],
    [650, 315],
    [628, 316],
    [633, 317],
    [634, 26],
    [637, 317],
    [526, 26],
    [656, 318],
    [655, 317],
    [641, 319],
    [642, 320],
    [644, 321],
    [640, 322],
    [643, 323],
    [649, 309],
    [635, 324],
    [636, 325],
    [645, 326],
    [527, 200],
    [646, 317],
    [652, 327],
    [807, 26],
    [809, 328],
    [810, 329],
    [788, 330],
    [786, 26],
    [787, 26],
    [735, 26],
    [746, 331],
    [741, 332],
    [744, 333],
    [799, 334],
    [793, 26],
    [796, 335],
    [795, 336],
    [804, 336],
    [794, 337],
    [808, 26],
    [743, 338],
    [745, 338],
    [737, 339],
    [740, 340],
    [789, 339],
    [742, 341],
    [736, 26],
    [525, 26],
    [1038, 26],
    [907, 299],
    [821, 342],
    [817, 343],
    [819, 344],
    [818, 345],
    [816, 346],
    [815, 26],
    [1023, 297],
    [661, 347],
    [663, 348],
    [664, 349],
    [662, 350],
    [686, 26],
    [687, 351],
    [669, 352],
    [681, 353],
    [680, 354],
    [678, 355],
    [688, 356],
    [666, 26],
    [691, 357],
    [673, 26],
    [684, 358],
    [683, 359],
    [685, 360],
    [689, 26],
    [679, 361],
    [672, 362],
    [677, 363],
    [690, 364],
    [675, 365],
    [670, 26],
    [671, 366],
    [692, 367],
    [682, 368],
    [676, 364],
    [667, 26],
    [693, 369],
    [665, 354],
    [668, 26],
    [674, 354],
    [778, 26],
    [780, 370],
    [779, 26],
    [908, 371],
    [909, 371],
    [911, 372],
    [910, 371],
    [1031, 373],
    [1028, 309],
    [1030, 374],
    [1029, 26],
    [1027, 26],
    [774, 375],
    [772, 376],
    [773, 377],
    [761, 378],
    [762, 376],
    [769, 379],
    [760, 380],
    [765, 381],
    [775, 26],
    [766, 382],
    [771, 383],
    [777, 384],
    [776, 385],
    [759, 386],
    [767, 387],
    [768, 388],
    [763, 389],
    [770, 375],
    [764, 390],
    [751, 391],
    [750, 392],
    [758, 26],
    [695, 393],
    [694, 26],
    [800, 26],
    [738, 26],
    [739, 394],
    [549, 395],
    [559, 396],
    [548, 395],
    [569, 397],
    [540, 398],
    [539, 308],
    [568, 309],
    [562, 399],
    [567, 400],
    [542, 401],
    [556, 402],
    [541, 403],
    [565, 404],
    [537, 405],
    [536, 309],
    [566, 406],
    [538, 407],
    [543, 408],
    [544, 26],
    [547, 408],
    [534, 26],
    [570, 409],
    [560, 410],
    [551, 411],
    [552, 412],
    [554, 413],
    [550, 414],
    [553, 415],
    [563, 309],
    [545, 416],
    [546, 417],
    [555, 418],
    [535, 200],
    [558, 410],
    [557, 408],
    [561, 26],
    [564, 419],
    [802, 420],
    [791, 421],
    [792, 420],
    [790, 26],
    [785, 422],
    [756, 423],
    [755, 424],
    [757, 26],
    [753, 424],
    [752, 26],
    [754, 425],
    [783, 26],
    [782, 26],
    [781, 426],
    [784, 427],
    [801, 428],
    [797, 429],
    [803, 430],
    [748, 431],
    [811, 432],
    [813, 433],
    [805, 434],
    [814, 435],
    [812, 436],
    [806, 437],
    [798, 438],
    [820, 439],
    [747, 26],
    [733, 440],
    [724, 441],
    [731, 442],
    [726, 26],
    [727, 26],
    [725, 443],
    [728, 444],
    [720, 26],
    [721, 26],
    [732, 445],
    [723, 446],
    [729, 26],
    [730, 447],
    [722, 448],
    [522, 26],
    [718, 449],
    [572, 450],
    [573, 450],
    [574, 451],
    [533, 452],
    [575, 453],
    [576, 454],
    [577, 455],
    [528, 26],
    [531, 456],
    [529, 26],
    [530, 26],
    [578, 457],
    [579, 458],
    [580, 459],
    [581, 460],
    [582, 461],
    [583, 462],
    [584, 462],
    [586, 463],
    [585, 464],
    [587, 465],
    [588, 466],
    [589, 467],
    [571, 468],
    [532, 26],
    [590, 469],
    [591, 470],
    [592, 471],
    [625, 472],
    [593, 473],
    [594, 474],
    [595, 475],
    [596, 476],
    [597, 477],
    [598, 478],
    [599, 479],
    [600, 480],
    [601, 481],
    [602, 482],
    [603, 482],
    [604, 483],
    [605, 26],
    [606, 26],
    [607, 484],
    [609, 485],
    [608, 486],
    [610, 487],
    [611, 488],
    [612, 489],
    [613, 490],
    [614, 491],
    [615, 492],
    [616, 493],
    [617, 494],
    [618, 495],
    [619, 496],
    [620, 497],
    [621, 498],
    [622, 499],
    [623, 500],
    [624, 501],
    [716, 289],
    [58, 26],
    [59, 26],
    [10, 26],
    [11, 26],
    [13, 26],
    [12, 26],
    [2, 26],
    [14, 26],
    [15, 26],
    [16, 26],
    [17, 26],
    [18, 26],
    [19, 26],
    [20, 26],
    [21, 26],
    [3, 26],
    [22, 26],
    [23, 26],
    [4, 26],
    [24, 26],
    [28, 26],
    [25, 26],
    [26, 26],
    [27, 26],
    [29, 26],
    [30, 26],
    [31, 26],
    [5, 26],
    [32, 26],
    [33, 26],
    [34, 26],
    [35, 26],
    [6, 26],
    [39, 26],
    [36, 26],
    [37, 26],
    [38, 26],
    [40, 26],
    [7, 26],
    [41, 26],
    [46, 26],
    [47, 26],
    [42, 26],
    [43, 26],
    [44, 26],
    [45, 26],
    [8, 26],
    [51, 26],
    [48, 26],
    [49, 26],
    [50, 26],
    [52, 26],
    [9, 26],
    [53, 26],
    [54, 26],
    [55, 26],
    [57, 26],
    [56, 26],
    [1, 26],
    [822, 502],
    [734, 503],
    [715, 504],
    [714, 505],
    [524, 506],
    [523, 507],
    [660, 508],
    [521, 26],
    [717, 509]
  ],
  "affectedFilesPendingEmit": [
    [718, 17],
    [822, 17],
    [734, 17],
    [715, 17],
    [714, 17],
    [524, 17],
    [523, 17],
    [660, 17],
    [521, 17],
    [717, 17]
  ],
  "emitSignatures": [521, 523, 524, 660, 714, 715, 717, 718, 734, 822],
  "version": "5.8.3"
}
````

## File: packages/storage/examples/gcs-usage.ts
````typescript
import { storage } from '@repo/storage';

// Example 1: Upload a file
async function uploadExample() {
  const file = Buffer.from('Hello from Google Cloud Storage!');

  const result = await storage.uploadFile('uploads/test', file, {
    metadata: {
      userId: '123',
      uploadedAt: new Date().toISOString(),
    },
    onProgress: (_progress) => {},
  });
  return result;
}

// Example 2: Get a presigned upload URL for client-side uploads
async function getPresignedUrlExample() {
  const { url, key } = await storage.getPresignedUploadUrl(
    'user-uploads',
    'image/jpeg'
  );

  // Client can now upload directly to this URL
  return { url, key };
}

// Example 3: Delete a file
async function deleteExample(key: string) {
  await storage.deleteFile(key);
}

// Example 4: Direct provider usage (advanced)
import { GCSStorageProvider } from '@repo/storage';

async function directProviderExample() {
  const provider = new GCSStorageProvider({
    projectId: process.env.GCP_PROJECT_ID,
    keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,
    bucket: process.env.GCS_BUCKET!,
    publicUrl: process.env.GCS_PUBLIC_URL,
  });

  // List all files with a prefix
  const _files = await provider.list('uploads/');

  // Get file metadata
  const file = await provider.get('uploads/test.jpg');
  if (file) {
  }

  // Create a presigned URL for temporary access
  const _presignedUrl = await provider.createPresignedUrl(
    'private/document.pdf',
    'get',
    3600 // 1 hour
  );
}
````

## File: packages/storage/src/__tests__/gcs.test.ts
````typescript
import { resolve } from 'node:path';
import { config } from 'dotenv';
import { beforeAll, describe, expect, it } from 'vitest';
import { GCSStorageProvider } from '../providers/gcs';

// Load environment variables
config({ path: resolve(__dirname, '../../../../apps/app/.env.local') });

describe('GCS Storage Provider', () => {
  let provider: GCSStorageProvider;

  beforeAll(() => {
    // Skip tests if GCS is not configured
    if (
      !process.env.GCS_BUCKET ||
      !process.env.GOOGLE_APPLICATION_CREDENTIALS
    ) {
      return;
    }

    provider = new GCSStorageProvider({
      projectId: process.env.GCP_PROJECT_ID,
      keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,
      bucket: process.env.GCS_BUCKET!,
      publicUrl: process.env.GCS_PUBLIC_URL,
    });
  });

  it('should upload a file', async () => {
    if (!provider) {
      return;
    }

    const testBuffer = Buffer.from('Hello from GCS test');
    const key = `test/gcs-test-${Date.now()}.txt`;

    const result = await provider.upload(key, testBuffer, {
      contentType: 'text/plain',
      metadata: { test: 'true' },
    });

    expect(result.key).toBe(key);
    expect(result.size).toBe(testBuffer.length);
    expect(result.contentType).toBe('text/plain');
    expect(result.url).toContain(key);
  });

  it('should get a file', async () => {
    if (!provider) {
      return;
    }

    const testBuffer = Buffer.from('Test file for get operation');
    const key = `test/gcs-get-test-${Date.now()}.txt`;

    // First upload
    await provider.upload(key, testBuffer);

    // Then get
    const file = await provider.get(key);

    expect(file).not.toBeNull();
    expect(file?.key).toBe(key);
    expect(file?.size).toBe(testBuffer.length);
  });

  it('should list files', async () => {
    if (!provider) {
      return;
    }

    const prefix = `test/list-${Date.now()}/`;
    const keys = [`${prefix}file1.txt`, `${prefix}file2.txt`];

    // Upload test files
    for (const key of keys) {
      await provider.upload(key, Buffer.from(`Content of ${key}`));
    }

    // List files
    const files = await provider.list(prefix);

    expect(files.length).toBeGreaterThanOrEqual(2);
    expect(files.map((f) => f.key)).toEqual(expect.arrayContaining(keys));
  });

  it('should create presigned URLs', async () => {
    if (!provider) {
      return;
    }

    const key = `test/presigned-${Date.now()}.txt`;

    // Get presigned URL for upload
    const uploadUrl = await provider.createPresignedUrl(key, 'put', 3600);
    expect(uploadUrl).toContain('X-Goog-Signature');
    expect(uploadUrl).toContain(key);

    // Upload a file first
    await provider.upload(key, Buffer.from('Test presigned URL'));

    // Get presigned URL for download
    const downloadUrl = await provider.createPresignedUrl(key, 'get', 3600);
    expect(downloadUrl).toContain('X-Goog-Signature');
    expect(downloadUrl).toContain(key);
  });

  it('should delete a file', async () => {
    if (!provider) {
      return;
    }

    const key = `test/delete-test-${Date.now()}.txt`;

    // Upload a file
    await provider.upload(key, Buffer.from('File to be deleted'));

    // Verify it exists
    const beforeDelete = await provider.get(key);
    expect(beforeDelete).not.toBeNull();

    // Delete it
    await provider.delete(key);

    // Verify it's gone
    const afterDelete = await provider.get(key);
    expect(afterDelete).toBeNull();
  });
});
````

## File: packages/storage/src/providers/gcs.ts
````typescript
import { Readable } from 'node:stream';
import { type File, Storage } from '@google-cloud/storage';
import { logger } from '@repo/logger';
import type { StorageFile, StorageProvider, UploadOptions } from '../types';

export class GCSStorageProvider implements StorageProvider {
  private storage: Storage;
  private bucket: string;
  private publicUrl?: string;

  constructor(config: {
    projectId?: string;
    keyFilename?: string; // Path to service account JSON
    bucket: string;
    publicUrl?: string;
  }) {
    this.storage = new Storage({
      projectId: config.projectId,
      keyFilename: config.keyFilename,
    });

    this.bucket = config.bucket;
    this.publicUrl = config.publicUrl;
  }

  async upload(
    key: string,
    file: Buffer | Blob | ReadableStream,
    options?: UploadOptions
  ): Promise<StorageFile> {
    try {
      // Check file size if maxSize is specified
      if (
        options?.maxSize &&
        file instanceof Buffer &&
        file.length > options.maxSize
      ) {
        throw new Error(
          `File size exceeds maximum allowed size of ${options.maxSize} bytes`
        );
      }

      const bucketInstance = this.storage.bucket(this.bucket);
      const fileInstance = bucketInstance.file(key);

      // Convert Blob or ReadableStream to Buffer or Stream
      let uploadData: Buffer | Readable;
      let fileSize = 0;

      if (file instanceof Buffer) {
        uploadData = file;
        fileSize = file.length;
      } else if (file instanceof Blob) {
        const arrayBuffer = await file.arrayBuffer();
        uploadData = Buffer.from(arrayBuffer);
        fileSize = uploadData.length;
      } else if (file instanceof ReadableStream) {
        // Convert ReadableStream to Node.js Readable stream
        const reader = file.getReader();
        uploadData = new Readable({
          async read() {
            try {
              const { done, value } = await reader.read();
              if (done) {
                this.push(null);
              } else {
                this.push(Buffer.from(value));
              }
            } catch (error) {
              this.destroy(error as Error);
            }
          },
        });
      } else {
        throw new Error('Unsupported file type');
      }

      // Create write stream with metadata
      const writeStream = fileInstance.createWriteStream({
        metadata: {
          contentType: options?.contentType || 'application/octet-stream',
          metadata: options?.metadata,
        },
        resumable: fileSize > 5 * 1024 * 1024, // Use resumable uploads for files > 5MB
      });

      // Track upload progress if callback provided
      if (options?.onProgress && uploadData instanceof Buffer) {
        const totalSize = uploadData.length;
        let uploadedSize = 0;

        writeStream.on('progress', (event: any) => {
          uploadedSize = event.bytesWritten || 0;
          options.onProgress?.({
            loaded: uploadedSize,
            total: totalSize,
            percentage: Math.round((uploadedSize / totalSize) * 100),
          });
        });
      }

      // Handle upload
      return new Promise((resolve, reject) => {
        writeStream
          .on('error', (error) => {
            logger.error('GCS upload failed', { key, error });
            reject(error);
          })
          .on('finish', async () => {
            // Make file public if bucket is public
            try {
              await fileInstance.makePublic();
            } catch (error) {
              // Ignore error if bucket doesn't allow public access
              logger.debug('Failed to make file public', { key, error });
            }

            resolve({
              key,
              url: this.getUrl(key),
              size: fileSize,
              contentType: options?.contentType || 'application/octet-stream',
              metadata: options?.metadata,
            });
          });

        if (uploadData instanceof Buffer) {
          writeStream.end(uploadData);
        } else if (uploadData instanceof Readable) {
          uploadData.pipe(writeStream);
        } else {
          throw new Error('Invalid upload data type');
        }
      });
    } catch (error) {
      logger.error('GCS upload failed', { key, error });
      throw error;
    }
  }

  async delete(key: string): Promise<void> {
    const file = this.storage.bucket(this.bucket).file(key);
    await file.delete();
  }

  async get(key: string): Promise<StorageFile | null> {
    try {
      const file = this.storage.bucket(this.bucket).file(key);
      const [exists] = await file.exists();

      if (!exists) {
        return null;
      }

      const [metadata] = await file.getMetadata();

      return {
        key,
        url: this.getUrl(key),
        size:
          typeof metadata.size === 'string'
            ? Number.parseInt(metadata.size, 10)
            : metadata.size || 0,
        contentType: metadata.contentType || 'application/octet-stream',
        metadata: metadata.metadata as Record<string, string>,
        lastModified: metadata.updated ? new Date(metadata.updated) : undefined,
      };
    } catch (error: any) {
      if (error.code === 404) {
        return null;
      }
      throw error;
    }
  }

  getUrl(key: string): string {
    if (this.publicUrl) {
      return `${this.publicUrl}/${key}`;
    }
    return `https://storage.googleapis.com/${this.bucket}/${key}`;
  }

  async list(prefix?: string): Promise<StorageFile[]> {
    const [files] = await this.storage.bucket(this.bucket).getFiles({
      prefix,
      maxResults: 1000,
    });

    return files.map((file: File) => ({
      key: file.name,
      url: this.getUrl(file.name),
      size:
        typeof file.metadata.size === 'string'
          ? Number.parseInt(file.metadata.size, 10)
          : file.metadata.size || 0,
      contentType: file.metadata.contentType || 'application/octet-stream',
      lastModified: file.metadata.updated
        ? new Date(file.metadata.updated)
        : undefined,
    }));
  }

  async createPresignedUrl(
    key: string,
    operation: 'get' | 'put',
    expiresIn = 3600
  ): Promise<string> {
    const file = this.storage.bucket(this.bucket).file(key);
    const expirationDate = new Date();
    expirationDate.setSeconds(expirationDate.getSeconds() + expiresIn);

    const [url] = await file.getSignedUrl({
      version: 'v4',
      action: operation === 'get' ? 'read' : 'write',
      expires: expirationDate,
    });

    return url;
  }
}
````

## File: packages/storage/src/providers/r2.ts
````typescript
import { S3StorageProvider } from './s3';

export class R2StorageProvider extends S3StorageProvider {
  constructor(config: {
    accountId: string;
    accessKeyId: string;
    secretAccessKey: string;
    bucket: string;
    publicUrl?: string;
  }) {
    super({
      region: 'auto',
      accessKeyId: config.accessKeyId,
      secretAccessKey: config.secretAccessKey,
      bucket: config.bucket,
      endpoint: `https://${config.accountId}.r2.cloudflarestorage.com`,
      publicUrl: config.publicUrl,
    });
  }

  // R2-specific optimizations can be added here
  getUrl(key: string): string {
    // R2 supports custom domains
    if (this.publicUrl) {
      return `${this.publicUrl}/${key}`;
    }
    return super.getUrl(key);
  }
}
````

## File: packages/storage/src/providers/s3.ts
````typescript
import {
  DeleteObjectCommand,
  GetObjectCommand,
  ListObjectsV2Command,
  PutObjectCommand,
  S3Client,
} from '@aws-sdk/client-s3';
import { Upload } from '@aws-sdk/lib-storage';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import { logger } from '@repo/logger';
import type { StorageFile, StorageProvider, UploadOptions } from '../types';

export class S3StorageProvider implements StorageProvider {
  protected client: S3Client;
  protected bucket: string;
  protected publicUrl?: string;

  constructor(config: {
    region: string;
    accessKeyId: string;
    secretAccessKey: string;
    bucket: string;
    endpoint?: string; // For S3-compatible services
    publicUrl?: string;
  }) {
    this.client = new S3Client({
      region: config.region,
      credentials: {
        accessKeyId: config.accessKeyId,
        secretAccessKey: config.secretAccessKey,
      },
      endpoint: config.endpoint,
    });

    this.bucket = config.bucket;
    this.publicUrl = config.publicUrl;
  }

  async upload(
    key: string,
    file: Buffer | Blob | ReadableStream,
    options?: UploadOptions
  ): Promise<StorageFile> {
    try {
      // Check file size if maxSize is specified
      if (
        options?.maxSize &&
        file instanceof Buffer &&
        file.length > options.maxSize
      ) {
        throw new Error(
          `File size exceeds maximum allowed size of ${options.maxSize} bytes`
        );
      }

      // Use multipart upload for large files
      const isLargeFile =
        file instanceof Buffer && file.length > 5 * 1024 * 1024; // 5MB

      if (isLargeFile || file instanceof ReadableStream) {
        return this.multipartUpload(key, file, options);
      }

      // Simple upload for small files
      const command = new PutObjectCommand({
        Bucket: this.bucket,
        Key: key,
        Body: file,
        ContentType: options?.contentType,
        Metadata: options?.metadata,
      });

      await this.client.send(command);

      return {
        key,
        url: this.getUrl(key),
        size: file instanceof Buffer ? file.length : (file as Blob).size,
        contentType: options?.contentType || 'application/octet-stream',
        metadata: options?.metadata,
      };
    } catch (error) {
      logger.error('S3 upload failed', { key, error });
      throw error;
    }
  }

  private async multipartUpload(
    key: string,
    file: Buffer | Blob | ReadableStream,
    options?: UploadOptions
  ): Promise<StorageFile> {
    const parallelUploads3 = new Upload({
      client: this.client,
      params: {
        Bucket: this.bucket,
        Key: key,
        Body: file,
        ContentType: options?.contentType,
        Metadata: options?.metadata,
      },
      queueSize: 4,
      partSize: 5 * 1024 * 1024, // 5MB parts
      leavePartsOnError: false,
    });

    parallelUploads3.on('httpUploadProgress', (progress) => {
      if (options?.onProgress && progress.loaded && progress.total) {
        options.onProgress({
          loaded: progress.loaded,
          total: progress.total,
          percentage: Math.round((progress.loaded / progress.total) * 100),
        });
      }
    });

    await parallelUploads3.done();

    return {
      key,
      url: this.getUrl(key),
      size: file instanceof Buffer ? file.length : 0,
      contentType: options?.contentType || 'application/octet-stream',
      metadata: options?.metadata,
    };
  }

  async delete(key: string): Promise<void> {
    const command = new DeleteObjectCommand({
      Bucket: this.bucket,
      Key: key,
    });

    await this.client.send(command);
  }

  async get(key: string): Promise<StorageFile | null> {
    try {
      const command = new GetObjectCommand({
        Bucket: this.bucket,
        Key: key,
      });

      const response = await this.client.send(command);

      return {
        key,
        url: this.getUrl(key),
        size: response.ContentLength || 0,
        contentType: response.ContentType || 'application/octet-stream',
        metadata: response.Metadata,
        lastModified: response.LastModified,
      };
    } catch (error: any) {
      if (error.name === 'NoSuchKey') {
        return null;
      }
      throw error;
    }
  }

  getUrl(key: string): string {
    if (this.publicUrl) {
      return `${this.publicUrl}/${key}`;
    }
    return `https://${this.bucket}.s3.amazonaws.com/${key}`;
  }

  async list(prefix?: string): Promise<StorageFile[]> {
    const command = new ListObjectsV2Command({
      Bucket: this.bucket,
      Prefix: prefix,
      MaxKeys: 1000,
    });

    const response = await this.client.send(command);

    return (response.Contents || []).map((object) => ({
      key: object.Key!,
      url: this.getUrl(object.Key!),
      size: object.Size || 0,
      contentType: 'application/octet-stream',
      lastModified: object.LastModified,
    }));
  }

  async createPresignedUrl(
    key: string,
    operation: 'get' | 'put',
    expiresIn = 3600
  ): Promise<string> {
    const command =
      operation === 'get'
        ? new GetObjectCommand({ Bucket: this.bucket, Key: key })
        : new PutObjectCommand({ Bucket: this.bucket, Key: key });

    return getSignedUrl(this.client, command, { expiresIn });
  }
}
````

## File: packages/storage/src/providers/vercel-blob.ts
````typescript
import { del, head, list, put } from '@vercel/blob';
import type { StorageFile, StorageProvider, UploadOptions } from '../types';

export class VercelBlobProvider implements StorageProvider {
  private token: string;

  constructor(config: { token: string }) {
    this.token = config.token;
  }

  async upload(
    key: string,
    file: Buffer | Blob | ReadableStream,
    options?: UploadOptions
  ): Promise<StorageFile> {
    // Vercel Blob handles progress internally
    const blob = await put(key, file, {
      access: 'public',
      token: this.token,
      contentType: options?.contentType,
      addRandomSuffix: false,
    });

    // Calculate size based on the input file
    let size = 0;
    if (file instanceof Buffer) {
      size = file.length;
    } else if (file instanceof Blob) {
      size = file.size;
    }

    return {
      key,
      url: blob.url,
      size,
      contentType: options?.contentType || 'application/octet-stream',
      metadata: options?.metadata,
    };
  }

  async delete(key: string): Promise<void> {
    await del(key, { token: this.token });
  }

  async get(key: string): Promise<StorageFile | null> {
    try {
      const blob = await head(key, { token: this.token });

      return {
        key,
        url: blob.url,
        size: blob.size,
        contentType: blob.contentType || 'application/octet-stream',
        lastModified: new Date(blob.uploadedAt),
      };
    } catch (error: any) {
      if (error.message?.includes('not found')) {
        return null;
      }
      throw error;
    }
  }

  getUrl(key: string): string {
    // Vercel Blob URLs are generated dynamically
    return `https://blob.vercel-storage.com/${key}`;
  }

  async list(prefix?: string): Promise<StorageFile[]> {
    const response = await list({
      token: this.token,
      prefix,
      limit: 1000,
    });

    return response.blobs.map((blob) => ({
      key: blob.pathname,
      url: blob.url,
      size: blob.size,
      contentType: 'application/octet-stream', // Vercel Blob doesn't expose contentType in list
      lastModified: new Date(blob.uploadedAt),
    }));
  }

  async createPresignedUrl(
    key: string,
    operation: 'get' | 'put',
    _expiresIn?: number
  ): Promise<string> {
    // Vercel Blob URLs are always public
    if (operation === 'get') {
      return this.getUrl(key);
    }

    // For uploads, return a special URL that the client can use
    throw new Error('Presigned uploads not supported with Vercel Blob');
  }
}
````

## File: packages/storage/src/utils/file-processor.ts
````typescript
import { logger } from '@repo/logger';

// Dynamic import for sharp to avoid client-side issues
let sharp: any = null;
if (typeof window === 'undefined') {
  try {
    sharp = require('sharp');
  } catch (e) {
    // Sharp not available
  }
}

export interface FileMetadata {
  size: number;
  mimeType: string;
  width?: number;
  height?: number;
  duration?: number;
  format?: string;
}

export class FileProcessor {
  async extractMetadata(file: Buffer, mimeType: string): Promise<FileMetadata> {
    const metadata: FileMetadata = {
      size: file.length,
      mimeType,
    };

    if (mimeType.startsWith('image/')) {
      const imageMetadata = await this.extractImageMetadata(file);
      Object.assign(metadata, imageMetadata);
    } else if (mimeType.startsWith('video/')) {
      // Video metadata extraction would use ffmpeg
      // Placeholder for now
      metadata.format = 'video';
    } else if (mimeType.startsWith('audio/')) {
      // Audio metadata extraction would use audio libraries
      metadata.format = 'audio';
    }

    return metadata;
  }

  private async extractImageMetadata(
    buffer: Buffer
  ): Promise<Partial<FileMetadata>> {
    if (!sharp) {
      return {};
    }
    try {
      const metadata = await sharp(buffer).metadata();

      return {
        width: metadata.width,
        height: metadata.height,
        format: metadata.format,
      };
    } catch (error) {
      logger.error('Failed to extract image metadata', { error });
      return {};
    }
  }

  async generateThumbnail(
    buffer: Buffer,
    options: {
      width?: number;
      height?: number;
      format?: 'jpeg' | 'png' | 'webp';
    } = {}
  ): Promise<Buffer> {
    if (!sharp) {
      return buffer; // Return original if sharp not available
    }
    const { width = 400, height = 400, format = 'jpeg' } = options;

    return sharp(buffer)
      .resize(width, height, {
        fit: 'inside',
        withoutEnlargement: true,
      })
      .toFormat(format, {
        quality: 80,
      })
      .toBuffer();
  }

  async optimizeImage(buffer: Buffer, mimeType: string): Promise<Buffer> {
    if (!sharp) {
      return buffer; // Return original if sharp not available
    }
    const format = mimeType.split('/')[1] as any;

    return sharp(buffer)
      .toFormat(format, {
        quality: 85,
        progressive: true,
      })
      .toBuffer();
  }
}

export const fileProcessor = new FileProcessor();
````

## File: packages/storage/src/env.ts
````typescript
import { createEnv } from '@t3-oss/env-core';
import { z } from 'zod';

export const storage = () =>
  createEnv({
    server: {
      STORAGE_PROVIDER: z.enum(['vercel-blob', 's3', 'r2', 'gcs']),
      // S3/R2 config
      AWS_REGION: z.string().optional(),
      AWS_ACCESS_KEY_ID: z.string().optional(),
      AWS_SECRET_ACCESS_KEY: z.string().optional(),
      AWS_BUCKET: z.string().optional(),
      AWS_PUBLIC_URL: z.string().optional(),
      // R2 specific
      R2_ACCOUNT_ID: z.string().optional(),
      R2_ACCESS_KEY_ID: z.string().optional(),
      R2_SECRET_ACCESS_KEY: z.string().optional(),
      R2_BUCKET: z.string().optional(),
      R2_PUBLIC_URL: z.string().optional(),
      // Vercel Blob
      BLOB_READ_WRITE_TOKEN: z.string().optional(),
      // Google Cloud Storage
      GCP_PROJECT_ID: z.string().optional(),
      GOOGLE_APPLICATION_CREDENTIALS: z.string().optional(),
      GCS_BUCKET: z.string().optional(),
      GCS_PUBLIC_URL: z.string().optional(),
    },
    runtimeEnv: process.env,
  });
````

## File: packages/storage/src/index.ts
````typescript
// Export the main storage manager
export { StorageManager, storage } from './manager';

// Export types
export type {
  StorageProvider,
  StorageFile,
  UploadProgress,
  UploadOptions,
  MultipartUpload,
  MultipartUploadPart,
} from './types';

// Export providers
export { S3StorageProvider } from './providers/s3';
export { R2StorageProvider } from './providers/r2';
export { VercelBlobProvider } from './providers/vercel-blob';
export { GCSStorageProvider } from './providers/gcs';

// Export environment validation
export { storage as storageEnv } from './env';
````

## File: packages/storage/src/manager.ts
````typescript
import { logger } from '@repo/logger';
import { GCSStorageProvider } from './providers/gcs';
import { R2StorageProvider } from './providers/r2';
import { S3StorageProvider } from './providers/s3';
import { VercelBlobProvider } from './providers/vercel-blob';
import type { StorageFile, StorageProvider, UploadProgress } from './types';

export class StorageManager {
  private provider: StorageProvider | null = null;

  constructor() {
    // Delay provider creation until first use
  }

  private getProvider(): StorageProvider {
    if (!this.provider) {
      this.provider = this.createProvider();
    }
    return this.provider;
  }

  private createProvider(): StorageProvider {
    const provider = process.env.STORAGE_PROVIDER;

    switch (provider) {
      case 's3':
        return new S3StorageProvider({
          region: process.env.AWS_REGION!,
          accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
          secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
          bucket: process.env.AWS_BUCKET!,
          publicUrl: process.env.AWS_PUBLIC_URL,
        });

      case 'r2':
        return new R2StorageProvider({
          accountId: process.env.R2_ACCOUNT_ID!,
          accessKeyId: process.env.R2_ACCESS_KEY_ID!,
          secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
          bucket: process.env.R2_BUCKET!,
          publicUrl: process.env.R2_PUBLIC_URL,
        });

      case 'vercel-blob':
        return new VercelBlobProvider({
          token: process.env.BLOB_READ_WRITE_TOKEN!,
        });

      case 'gcs':
        return new GCSStorageProvider({
          projectId: process.env.GCP_PROJECT_ID,
          keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,
          bucket: process.env.GCS_BUCKET!,
          publicUrl: process.env.GCS_PUBLIC_URL,
        });

      default:
        // Return a no-op provider if no storage provider is configured
        logger.warn('No storage provider configured, using no-op provider');
        return {
          async upload() {
            throw new Error('Storage provider not configured');
          },
          async get() {
            return null;
          },
          async delete() {
            // No-op
          },
          getUrl() {
            return '';
          },
          async list() {
            return [];
          },
          async createPresignedUrl() {
            throw new Error('Storage provider not configured');
          },
        } as StorageProvider;
    }
  }

  async uploadFile(
    path: string,
    file: Buffer | Blob | File,
    options?: {
      onProgress?: (progress: UploadProgress) => void;
      metadata?: Record<string, string>;
    }
  ): Promise<StorageFile> {
    // Generate unique key
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(7);
    const extension = this.getFileExtension(file);
    const key = `${path}/${timestamp}-${random}${extension}`;

    // Determine content type
    const contentType = this.getContentType(file);

    logger.info('Uploading file', { key, contentType });

    return this.getProvider().upload(key, file, {
      ...options,
      contentType,
    });
  }

  async get(key: string): Promise<StorageFile | null> {
    return this.getProvider().get(key);
  }

  async deleteFile(key: string): Promise<void> {
    return this.getProvider().delete(key);
  }

  async getFileUrl(key: string): Promise<string> {
    return this.getProvider().getUrl(key);
  }

  async getPresignedUploadUrl(
    path: string,
    contentType: string
  ): Promise<{ url: string; key: string }> {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(7);
    const extension = this.getExtensionFromMimeType(contentType);
    const key = `${path}/${timestamp}-${random}${extension}`;

    const url = await this.getProvider().createPresignedUrl(key, 'put', 3600);

    return { url, key };
  }

  private getFileExtension(file: Buffer | Blob | File): string {
    if (file instanceof File) {
      const parts = file.name.split('.');
      return parts.length > 1 ? `.${parts.pop()}` : '';
    }
    return '';
  }

  private getContentType(file: Buffer | Blob | File): string {
    if (file instanceof File || file instanceof Blob) {
      return file.type || 'application/octet-stream';
    }
    return 'application/octet-stream';
  }

  private getExtensionFromMimeType(mimeType: string): string {
    const mimeToExt: Record<string, string> = {
      'image/jpeg': '.jpg',
      'image/png': '.png',
      'image/gif': '.gif',
      'image/webp': '.webp',
      'video/mp4': '.mp4',
      'video/webm': '.webm',
      'audio/mpeg': '.mp3',
      'audio/wav': '.wav',
      'audio/ogg': '.ogg',
    };

    return mimeToExt[mimeType] || '';
  }
}

export const storage = new StorageManager();
````

## File: packages/storage/src/types.ts
````typescript
export interface StorageFile {
  key: string;
  url: string;
  size: number;
  contentType: string;
  metadata?: Record<string, string>;
  lastModified?: Date;
}

export interface UploadProgress {
  loaded: number;
  total: number;
  percentage: number;
}

export interface UploadOptions {
  onProgress?: (progress: UploadProgress) => void;
  metadata?: Record<string, string>;
  contentType?: string;
  maxSize?: number;
}

export interface StorageProvider {
  upload(
    key: string,
    file: Buffer | Blob | ReadableStream,
    options?: UploadOptions
  ): Promise<StorageFile>;

  delete(key: string): Promise<void>;

  get(key: string): Promise<StorageFile | null>;

  getUrl(key: string): string;

  list(prefix?: string): Promise<StorageFile[]>;

  createPresignedUrl(
    key: string,
    operation: 'get' | 'put',
    expiresIn?: number
  ): Promise<string>;
}

export interface MultipartUploadPart {
  partNumber: number;
  etag: string;
}

export interface MultipartUpload {
  uploadId: string;
  key: string;

  uploadPart(
    partNumber: number,
    data: Buffer | Blob,
    options?: UploadOptions
  ): Promise<MultipartUploadPart>;

  complete(parts: MultipartUploadPart[]): Promise<StorageFile>;

  abort(): Promise<void>;
}
````

## File: packages/storage/.env
````
# Storage provider configuration
STORAGE_PROVIDER=gcs

# Google Cloud Storage
GCP_PROJECT_ID=squish-dev-441207
GOOGLE_APPLICATION_CREDENTIALS=./credentials/squish-dev-sa.json
GCS_BUCKET=squish-assets
GCS_PUBLIC_URL=https://storage.googleapis.com/squish-assets
````

## File: packages/storage/.env.example
````
# Storage provider configuration
# Options: s3, r2, vercel-blob, gcs
STORAGE_PROVIDER=gcs

# Google Cloud Storage
GCP_PROJECT_ID=squish-dev-441207
GOOGLE_APPLICATION_CREDENTIALS=../../../apps/ai/credentials/squish-dev-sa.json
GCS_BUCKET=squish-assets
GCS_PUBLIC_URL=https://storage.googleapis.com/squish-assets

# AWS S3 (if using S3)
# AWS_REGION=us-east-1
# AWS_ACCESS_KEY_ID=your-access-key
# AWS_SECRET_ACCESS_KEY=your-secret-key
# AWS_BUCKET=your-bucket
# AWS_PUBLIC_URL=https://your-bucket.s3.amazonaws.com

# Cloudflare R2 (if using R2)
# R2_ACCOUNT_ID=your-account-id
# R2_ACCESS_KEY_ID=your-access-key
# R2_SECRET_ACCESS_KEY=your-secret-key
# R2_BUCKET=your-bucket
# R2_PUBLIC_URL=https://your-public-url.r2.dev

# Vercel Blob (if using Vercel Blob)
# BLOB_READ_WRITE_TOKEN=vercel_blob_token
````

## File: packages/storage/CLAUDE.md
````markdown
# @repo/storage Package Context

## Development Standards

### Package Context
This package provides file storage utilities for the Squish ecosystem. It offers a unified API for multiple storage providers including Google Cloud Storage, Cloudflare R2, and Amazon S3.

### Technology Stack
- **@google-cloud/storage**: GCS client
- **@aws-sdk/client-s3**: S3 client
- **Cloudflare R2**: R2 client
- **TypeScript**: 5.7+ strict configuration

### Key Dependencies
```json
{
  "dependencies": {
    "@google-cloud/storage": "^7.14.0",
    "@aws-sdk/client-s3": "^3.700.0",
    "@cloudflare/r2": "^1.0.0"
  }
}
```

## Package Structure
```
src/
‚îú‚îÄ‚îÄ index.ts            # Main exports
‚îú‚îÄ‚îÄ providers/          # Storage providers
‚îÇ   ‚îú‚îÄ‚îÄ gcs.ts          # Google Cloud Storage
‚îÇ   ‚îú‚îÄ‚îÄ r2.ts           # Cloudflare R2
‚îÇ   ‚îî‚îÄ‚îÄ s3.ts           # Amazon S3
‚îú‚îÄ‚îÄ types/              # Storage types
‚îú‚îÄ‚îÄ utils/              # Storage utilities
‚îî‚îÄ‚îÄ client/             # Unified storage client
```

## Storage Patterns
- Provider abstraction
- Upload/download flows
- URL generation
- File metadata
- Error handling

## Files to Know
- `src/index.ts` - Unified storage API
- `src/client/index.ts` - Storage client facade

## Quality Checklist
- [ ] Security headers set
- [ ] File size limits
- [ ] Error handling
- [ ] Performance optimized

---
EOF < /dev/null
````

## File: packages/storage/index.ts
````typescript
// Main exports
export { storage } from './src/manager';
export { fileProcessor } from './src/utils/file-processor';

// Type exports
export * from './src/types';

// Provider exports (for advanced usage)
export { S3StorageProvider } from './src/providers/s3';
export { R2StorageProvider } from './src/providers/r2';
export { VercelBlobProvider } from './src/providers/vercel-blob';
export { GCSStorageProvider } from './src/providers/gcs';

// Utility exports
export type { FileMetadata } from './src/utils/file-processor';
````

## File: packages/storage/package.json
````json
{
  "name": "@repo/storage",
  "version": "0.0.0",
  "private": true,
  "main": "./index.ts",
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.699.0",
    "@aws-sdk/lib-storage": "^3.699.0",
    "@aws-sdk/s3-request-presigner": "^3.699.0",
    "@google-cloud/storage": "^7.16.0",
    "@repo/logger": "workspace:*",
    "@t3-oss/env-core": "^0.12.0",
    "@vercel/blob": "^1.1.1",
    "optional": "^0.1.4",
    "sharp": "^0.34.3",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@types/node": "22.14.1",
    "typescript": "^5.8.3",
    "vitest": "^3.1.1"
  }
}
````

## File: packages/storage/setup-gcs.md
````markdown
# Setting up Google Cloud Storage

## Prerequisites

1. A Google Cloud Project with Cloud Storage API enabled
2. A service account with Storage Admin permissions
3. A Cloud Storage bucket

## Setup Instructions

### 1. Service Account Credentials

Place your service account JSON file in the AI service credentials directory:

```bash
cp /path/to/your-service-account.json ../../apps/ai/credentials/squish-dev-sa.json
```

### 2. Environment Variables

Add the following to your `.env.local` file:

```bash
# Storage Provider - Change from 'vercel-blob' to 'gcs'
STORAGE_PROVIDER=gcs

# Google Cloud Storage Configuration
GCP_PROJECT_ID=your-project-id
GOOGLE_APPLICATION_CREDENTIALS=../../apps/ai/credentials/squish-dev-sa.json
GCS_BUCKET=your-bucket-name
GCS_PUBLIC_URL=https://storage.googleapis.com/your-bucket-name  # Optional: Custom domain

# Remove or comment out Vercel Blob token if switching from Vercel
# BLOB_READ_WRITE_TOKEN=
```

### 3. Bucket Configuration

Ensure your GCS bucket has the appropriate settings:

#### For Public Access (if needed):
```bash
# Make bucket publicly readable
gsutil iam ch allUsers:objectViewer gs://your-bucket-name

# Or use uniform bucket-level access
gsutil uniformbucketlevelaccess set on gs://your-bucket-name
```

#### For Private Access:
- Keep default settings
- Use presigned URLs for temporary access

### 4. CORS Configuration (for browser uploads)

Create a `cors.json` file:

```json
[
  {
    "origin": ["http://localhost:9999", "https://your-domain.com"],
    "method": ["GET", "POST", "PUT", "DELETE"],
    "responseHeader": ["Content-Type", "Access-Control-Allow-Origin"],
    "maxAgeSeconds": 3600
  }
]
```

Apply it to your bucket:
```bash
gsutil cors set cors.json gs://your-bucket-name
```

## Testing

Run the storage tests to verify your configuration:

```bash
bun run test packages/storage/src/__tests__/gcs.test.ts
```

## Features Supported

- ‚úÖ File upload (with progress tracking for Buffer uploads)
- ‚úÖ File deletion
- ‚úÖ File retrieval
- ‚úÖ File listing with prefix
- ‚úÖ Presigned URLs for temporary access
- ‚úÖ Metadata support
- ‚úÖ Large file uploads with resumable uploads
- ‚úÖ Stream support for large files

## Migration from Other Providers

To migrate from another storage provider:

1. Change `STORAGE_PROVIDER` in your `.env.local`
2. Add the required GCS environment variables
3. Restart your application

The storage manager will automatically use the new provider.

## Production Considerations

1. **Authentication**: In production, consider using Workload Identity Federation instead of service account keys
2. **Bucket Location**: Choose a region close to your users
3. **Lifecycle Policies**: Set up lifecycle rules to manage old files
4. **Monitoring**: Enable Cloud Storage metrics and logging
5. **Costs**: Monitor storage and bandwidth costs

## Troubleshooting

### Common Issues

1. **Authentication Error**: Ensure the service account JSON file path is correct and the file exists
2. **Permission Denied**: Verify the service account has Storage Admin or appropriate permissions
3. **Bucket Not Found**: Check the bucket name and ensure it exists in your project
4. **CORS Issues**: Apply the CORS configuration if uploading from browsers
````

## File: packages/storage/tsconfig.json
````json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "tsBuildInfoFile": ".cache/tsbuildinfo.json"
  },
  "include": ["."],
  "exclude": ["node_modules"]
}
````

## File: packages/typescript-config/base.json
````json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Default",
  "compilerOptions": {
    "composite": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "target": "ES2022",
    "allowJs": true,
    "resolveJsonModule": true,
    "moduleDetection": "force",
    "isolatedModules": true,
    "strict": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["es2022", "DOM", "DOM.Iterable"],
    "baseUrl": ".",
    "paths": {
      "@squish-xyz/*": ["../*/src"],
      "@/*": ["./src/*"]
    },
    "incremental": true
  }
}
````

## File: packages/typescript-config/CLAUDE.md
````markdown
# @repo/typescript-config Package Context

## Development Standards

### Package Context
This package provides shared TypeScript configurations for the Squish ecosystem. It includes base configs, Next.js configs, React configs, and custom type checking rules.

### Package Structure
```
base.json              # Base TypeScript config
nextjs.json            # Next.js specific config
react.json             # React specific config
node.json              # Node.js specific config
```

## Configuration Patterns
- Strict type checking
- Path mapping
- Module resolution
- Declaration generation
- Composite project support

## Files to Know
- `base.json` - Base configuration
- `nextjs.json` - Next.js overrides

## Quality Checklist
- [ ] Strict mode enabled
- [ ] No implicit any
- [ ] Path aliases correct
- [ ] Module resolution ok

---
EOF < /dev/null
````

## File: packages/typescript-config/nextjs.json
````json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "extends": "./base.json",
  "compilerOptions": {
    "plugins": [{ "name": "next" }],
    "allowJs": true,
    "jsx": "preserve",
    "noEmit": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "paths": {
      "@/*": ["./*"]
    }
  }
}
````

## File: packages/typescript-config/package.json
````json
{
  "name": "@repo/typescript-config",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "clean": "git clean -xdf .cache .turbo dist node_modules",
    "typecheck": "tsc --noEmit --emitDeclarationOnly false"
  }
}
````

## File: packages/typescript-config/react-library.json
````json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "React Library",
  "extends": "./base.json",
  "compilerOptions": {
    "jsx": "react-jsx"
  }
}
````

## File: .gitignore
````
# Dependencies
node_modules
.pnp
.pnp.js
.pnp.cjs

# Yarn
.yarn/install-state.gz
.yarn/cache
.yarn/cache/*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/sdks
!.yarn/versions

# Testing
coverage

# Next.js
.next/
out/

# Production
build
dist

# Build artifacts
**/*.d.ts
**/*.d.ts.map
**/*.js.map
**/*.tsbuildinfo
**/dist/
**/.turbo/

# Keep source TypeScript files
!src/**/*.ts
!src/**/*.tsx

# Keep configuration files
!*.config.js
!next.config.js
!postcss.config.js
!tailwind.config.js
!.eslintrc.js
!jest.config.js
!babel.config.js
!**/*.stories.js

# Misc
.DS_Store
*.pem

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Local env files
.env*.local

# Credentials
credentials/*.json
!credentials/README.md

# Turbo
.turbo

# Vercel
.vercel

# IDEs and editors
.idea
.vscode
*.swp
*.swo

# Build artifacts
.wrangler/
.mastra/

# Environment files
.env.development
.env.production
````

## File: biome.json
````json
{
  "$schema": "https://biomejs.dev/schemas/1.9.4/schema.json",
  "extends": ["ultracite"],
  "files": {
    "ignore": [
      "packages/design/components/ui/**",
      "packages/design/lib/**",
      "packages/design/hooks/**",
      "apps/email/.react-email/**"
    ]
  }
}
````

## File: CLAUDE.md
````markdown
# Squish-XYZ Project Context

## Development Standards

### Primary References
1. **STANDARDS.md** - Located at `~/Developer/STANDARDS.md`
   - Overall architectural guidelines
   - Technology stack specifications
   - Development workflow standards
   - Quality requirements

2. **Rules Directory** - Located at `~/.claude/rules/`
   - Detailed implementation rules
   - Platform-specific requirements
   - Architectural patterns
   - Tool configurations

### Quick Access to Rules
- **General**: product_layout, documentation_and_ai_guidance
- **Turborepo**: tooling, monorepo_structure, state_management, api_and_data_flow
- **AI Service**: ai_service_architecture, ai_agent_instructions
- **Apple**: project_structure, architecture_patterns, ui_ux_patterns, networking_layer

## Project Overview

### Ecosystem Structure
This is a **Turborepo monorepo** using Bun workspaces containing:

**Applications (4 apps):**
- `apps/app` - Next.js 15 web application (main UI)
- `apps/api` - Cloudflare Workers API service (Hono framework)
- `apps/ai` - Mastra AI service (Vertex AI integration)
- `apps/email` - React Email service (email templates)

**Shared Packages (15 packages):**
- `@repo/ai` - AI SDK v5 integration utilities
- `@repo/analytics` - Analytics tracking (PostHog, Vercel)
- `@repo/auth` - Authentication (Clerk integration)
- `@repo/collaboration` - Real-time collaboration features
- `@repo/database` - Database layer (Drizzle ORM, PostgreSQL)
- `@repo/design` - UI components and design system
- `@repo/email` - Email templates and utilities
- `@repo/logger` - Logging utilities
- `@repo/next-config` - Next.js shared configuration
- `@repo/notifications` - Notification system
- `@repo/orpc` - RPC client/server utilities
- `@repo/seo` - SEO utilities
- `@repo/services` - Business logic services
- `@repo/storage` - File storage abstraction (GCS, R2, S3)
- `@repo/typescript-config` - TypeScript configurations

### Technology Stack Matrix

| Layer | Technology | Version | Purpose |
|-------|------------|---------|---------|
| **Frontend** | Next.js | 15.3.4 | React framework with App Router |
| | React | 19.1.0 | UI library with latest features |
| | TypeScript | 5.7.3 | Type safety |
| | Tailwind CSS | 4.1.11 | Utility-first CSS |
| | Clerk | 6.18.4 | Authentication |
| **State** | Jotai | 2.6.0 | Client-side state management |
| | SWR | 2.2.5 | Server state caching |
| **Backend** | Hono | 4.6.15 | API framework |
| | Cloudflare Workers | - | Serverless runtime |
| | Mastra | latest | AI service framework |
| **Database** | PostgreSQL | latest | Primary database |
| | Drizzle ORM | 0.38.2 | Type-safe database access |
| **AI/ML** | Vertex AI | - | Google's AI platform |
| | AI SDK | v5 | AI integration framework |
| **Analytics** | PostHog | 1.205.0 | Product analytics |
| **Deployment** | Vercel | - | Web application hosting |
| | Cloudflare Workers | - | API service hosting |
| | Mastra Cloud | - | AI service hosting |

## Development Patterns

### Architecture Patterns
1. **Monorepo Structure**: Turborepo with clear separation of concerns
2. **Microservices**: Each app serves a specific purpose
3. **Shared Packages**: Common functionality extracted into reusable packages
4. **Feature-based Organization**: Components organized by feature domain

### Code Organization
```
apps/
  app/          # Next.js web app
    src/
      app/      # App Router pages
      components/
        modules/     # Feature-specific components
        common/      # Reusable UI components
        ui/          # Base UI Kit components
      hooks/         # Custom React hooks
      atoms/         # Jotai state atoms
  api/          # Cloudflare Workers API
    src/
      routes/   # API endpoints
      services/  # Business logic
      schemas/   # Zod validation schemas
  ai/           # Mastra AI service
    src/
      mastra/   # Mastra configuration
      providers/# AI providers
      services/  # AI services
  email/        # Email service
    emails/     # React Email templates

packages/
  ai/           # AI utilities and hooks
  auth/         # Authentication package
  database/     # Database utilities
  design/       # Shared UI components
  # ... other packages
```

### State Management Patterns
- **Client State**: Jotai atoms organized by domain (ui, user, board, search, etc.)
- **Server State**: SWR hooks for data fetching and caching
- **Forms**: React Hook Form with Zod validation
- **Real-time**: WebSocket (LiveBlocks) and Pusher for presence

### API Patterns
- **RESTful Design**: Organized by domain in `/routes/`
- **Type Safety**: Zod schemas for request/response validation
- **Authentication**: Clerk middleware JWT verification
- **Error Handling**: Standardized error responses
- **RPC Layer**: ORPC for type-safe client-server communication

## Agent Instructions

### When Working on Features
1. **Always create/update CLAUDE.md files** for modified packages/apps
2. **Follow the established patterns** don't introduce new patterns without discussion
3. **Use TypeScript strictly** no any types without good reason
4. **Test thoroughly** ensure all functionality works as expected
5. **Update documentation** document new features and API changes

### When Debugging
1. **Check the logs** use the logger package consistently
2. **Verify environment variables** ensure proper configuration
3. **Test in isolation** reproduce issues in minimal setup
4. **Check database state** verify data integrity
5. **Review recent changes** git bisect if necessary

### Code Quality Requirements
- **TypeScript**: Must compile without errors
- **Linting**: Must pass Ultracite (Biome) checks
- **Formatting**: Code must be properly formatted
- **No console.log**: Remove or use proper logging
- **Error Boundaries**: Implement where appropriate
- **Loading States**: All async operations need loading UI
- **Accessibility**: Follow WCAG guidelines
- **Mobile Responsive**: Design mobile-first

### Quality Checklist Before Committing
- [ ] TypeScript compiles without errors
- [ ] Biome formatting applied (`bun run lint:fix`)
- [ ] No console.log statements (use logger instead)
- [ ] Error boundaries implemented where needed
- [ ] Loading states handled
- [ ] Mobile responsive design verified
- [ ] Accessibility checked
- [ ] Documentation updated
- [ ] Tests passing (if applicable)

## Build and Deployment

### Development
```bash
# Install dependencies
bun install

# Start all apps in development
bun run dev

# Build everything
bun run build

# Run tests
bun run test
```

### Deployment Targets
- **Web App (apps/app)**: Vercel - Automatic deployment on merge to main
- **API Service (apps/api)**: Cloudflare Workers - Deploy with `wrangler deploy`
- **AI Service (apps/ai)**: Mastra Cloud - Deploy with `mastra deploy`
- **Email Service (apps/email)**: Vercel/Serverless - Part of web app deployment

### Environment Variables
See `.env.example` for required variables. Each app may have additional requirements.

## Key Architectural Decisions

1. **Turborepo + Bun**: Chosen for efficient monorepo management
2. **Next.js App Router**: Latest Next.js features with server components
3. **Jotai over Redux**: Simpler state management for modern React
4. **Cloudflare Workers**: Edge computing for API scalability
5. **Mastra Framework**: Specialized AI service infrastructure
6. **Clerk Authentication**: Comprehensive auth solution
7. **Drizzle ORM**: Type-safe database access with migrations

## Common Tasks

### Adding a New Package
1. Create directory in `packages/`
2. Add to root `package.json` workspaces
3. Create `package.json` with workspace:*
4. Add TypeScript configuration
5. Create `CLAUDE.md` and `README.md`
6. Export from `index.ts`

### Adding a New Feature
1. Create components in `src/components/modules/[feature]/`
2. Add hooks in `src/hooks/` if needed
3. Add atoms in `src/atoms/` for state
4. Update routing in `src/app/`
5. Update API routes in `apps/api/src/routes/`
6. Update documentation

### Database Changes
1. Update schema in `packages/database/src/schema.ts`
2. Generate migrations: `bun run db:generate`
3. Run migrations: `bun run db:migrate`
4. Update types: `bun run db:studio` (if needed)
5. Test with actual database

## Files to Know

- `turbo.json`: Turborepo configuration
- Root `package.json` workspaces: Workspace definitions
- `packages/database/src/schema.ts`: Database schema
- `apps/app/src/atoms/index.ts`: Global state atoms
- `apps/api/src/index.ts`: API entry point
- `apps/ai/src/mastra/index.ts`: Mastra configuration
- `docs/`: Project documentation

## Getting Help

1. **Documentation**: Check `docs/` directory
2. **Examples**: Look at existing features for patterns
3. **Architecture**: Review `docs/architecture/`
4. **Standards**: Refer to `~/Developer/STANDARDS.md`

---

*This context helps Claude Code understand the project structure and development patterns. Update as the project evolves.*
````

## File: package.json
````json
{
  "name": "alden-xyz",
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "analyze": "turbo analyze",
    "build": "turbo build",
    "bump-deps": "bunx npm-check-updates --deep -u -x react-day-picker && bun install",
    "clean": "git clean -xdf node_modules",
    "dev": "turbo dev",
    "dev:app": "turbo dev --filter=@repo/app",
    "dev:docs": "turbo dev --filter=@repo/docs...",
    "dev:internal-docs": "turbo dev --filter=internal-docs",
    "build:docs": "turbo build --filter=docs",
    "build:internal-docs": "turbo build --filter=internal-docs",
    "email": "turbo dev --filter=email",
    "format": "ultracite format",
    "lint": "ultracite lint",
    "test": "turbo test",
    "test:unit": "turbo test:unit",
    "test:integration": "turbo test:integration",
    "test:e2e": "turbo test:e2e",
    "test:coverage": "turbo test:coverage",
    "test:bench": "vitest bench"
  },
  "devDependencies": {
    "@biomejs/biome": "1.9.4",
    "@repo/typescript-config": "workspace:*",
    "@tailwindcss/postcss": "^4.0.0",
    "@tailwindcss/typography": "0.5.0-alpha.3",
    "@turbo/gen": "^2.3.3",
    "patch-package": "^8.0.0",
    "tailwindcss": "^4.0.0",
    "turbo": "^2.5.5",
    "typescript": "^5.7.3",
    "ultracite": "^4.1.15"
  },
  "engines": {
    "node": "20.x"
  },
  "packageManager": "bun@1.1.38",
  "dependencies": {
    "@prisma/client": "^6.11.1",
    "@tiptap/core": "^2.25.0",
    "@tiptap/extension-image": "^2.25.0",
    "@tiptap/extension-link": "^2.25.0",
    "@tiptap/extension-mention": "^2.25.0",
    "@tiptap/extension-placeholder": "^2.25.0",
    "@tiptap/extension-underline": "^2.25.0",
    "@tiptap/react": "^2.25.0",
    "@tiptap/starter-kit": "^2.25.0",
    "class-variance-authority": "^0.7.0",
    "posthog-js": "^1.205.0"
  },
  "overrides": {
    "@types/react": "^19.0.6",
    "@types/react-dom": "^19.0.3"
  }
}
````

## File: security
````
78uijkm,MM unlock-keychain /Users/nit/Library/Keychains/login.keychain-db
78uijkm,MM unlock-keychain /Users/nit/Library/Keychains/login.keychain-db
````

## File: tsconfig.json
````json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Root",
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@repo/*": ["packages/*/src"],
      "@repo/auth": ["packages/auth"]
    }
  },
  "include": ["packages/*/src/**/*.ts", "packages/*/src/**/*.tsx"],
  "exclude": ["node_modules", "dist"]
}
````

## File: turbo.json
````json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "globalEnv": [
    "LIVEBLOCKS_SECRET_KEY",
    "NPM_RC",
    "ENABLE_EXPERIMENTAL_COREPACK",
    "NODE_ENV",
    "EXPO_*",
    "RESEND_*",
    "GOOGLE_CLOUD_PROJECT",
    "GOOGLE_CLOUD_LOCATION",
    "GOOGLE_APPLICATION_CREDENTIALS"
  ],
  "tasks": {
    "analyze": {
      "dependsOn": ["^build"],
      "outputs": [".next/analyze/**", "analyze/**"],
      "cache": true,
      "env": ["ANALYZE", "BUNDLE_ANALYZE"],
      "inputs": [
        "src/**/*.tsx",
        "src/**/*.ts",
        "app/**/*.tsx",
        "app/**/*.ts",
        "components/**/*.tsx",
        "components/**/*.ts"
      ]
    },
    "build": {
      "dependsOn": ["^build"],
      "outputs": [
        ".next/**",
        "!.next/cache/**",
        "dist/**",
        ".expo/**",
        ".react-email/**"
      ],
      "env": ["LIVEBLOCKS_*", "EXPO_*", "RESEND_*"]
    },
    "typecheck": {
      "outputs": [],
      "cache": true
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "outputs": []
    },
    "test": {
      "dependsOn": ["^build"],
      "outputs": ["coverage/**"],
      "inputs": ["src/**/*.tsx", "src/**/*.ts", "test/**/*.ts", "test/**/*.tsx"]
    },
    "export": {
      "outputs": ["out/**"]
    }
  }
}
````
